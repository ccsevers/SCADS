<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>TpcwLoaderTask.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> tpcw

<span class="keyword">import</span> comm._
<span class="keyword">import</span> piql._
<span class="keyword">import</span> perf._
<span class="keyword">import</span> storage._
<span class="keyword">import</span> avro.runtime._
<span class="keyword">import</span> avro.marker._

<span class="keyword">import</span> deploylib._
<span class="keyword">import</span> deploylib.mesos._

case <span class="keyword">class</span> <a href="#61208" title="class TpcwLoaderTask extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.perf.DataLoadingTask with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="47109">TpcwLoaderTask</a><a href="#47109" title="ScalaObject" class="delimiter">(</a><a href="#47109" title="()edu.berkeley.cs.scads.piql.tpcw.TpcwLoaderTask" id="60591" class="keyword">var</a> <a title="Int" id="47095">numServers</a>: <span title="Int">Int</span>,
                          <span class="keyword">var</span> <a title="Int" id="47096">numLoaders</a>: <span title="Int">Int</span>,
                          <span class="keyword">var</span> <a title="Double" id="47097">numEBs</a>: <span title="Double">Double</span>,
                          <span class="keyword">var</span> <a title="Int" id="47098">numItems</a>: <span title="Int">Int</span>,
                          <span class="keyword">var</span> <a title="Int" id="47106">replicationFactor</a>: <span title="Int">Int</span> = <span title="Int(2)" class="int">2</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.scads.perf.DataLoadingTask">DataLoadingTask</span> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="delimiter">{</span>
  <span class="keyword">var</span> <a title="String" id="46032">clusterAddress</a>: <span title="String">String</span> = _
  
  <span class="keyword">def</span> <a title="()Unit" id="46034">run</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="46083">coordination</a> = <a href="#47109" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(rpath: java.lang.String, tries: Int)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrCreate</span><span class="delimiter">(</span><span title="java.lang.String(&quot;coordination/loaders&quot;)" class="string">&quot;coordination/loaders&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" id="46084">cluster</a> = <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">ExperimentalScadsCluster</span><span class="delimiter">(</span><a href="#47109" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a><span class="delimiter">)</span>
    <a href="#46084" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="(clusterSize: Int)Unit">blockUntilReady</span><span class="delimiter">(</span><a href="#47095" title="=&gt; Int">numServers</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.tpcw.TpcwLoader" id="46085">loader</a> = <span title="edu.berkeley.cs.scads.piql.tpcw.TpcwLoader" class="keyword">new</span> <a href="TpcwLoader.scala.html#9650" title="edu.berkeley.cs.scads.piql.tpcw.TpcwLoader">TpcwLoader</a><span class="delimiter">(</span>
      numEBs = <a href="#47097" title="=&gt; Double">numEBs</a>,
      numItems = <a href="#47098" title="=&gt; Int">numItems</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Int" id="46086">clientId</a> = <a href="#46083" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;clientStart&quot;)" class="string">&quot;clientStart&quot;</span>, <a href="#47096" title="=&gt; Int">numLoaders</a>, timeout=<span class="int">60</span>*<span class="int">60</span><span title="Long(3600000L)">*</span><span class="int">1000</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#46086" title="Int">clientId</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#47109" title="(tries: Int)(func: =&gt; Unit)Unit">retry</a><span class="delimiter">(</span><span title="Int(5)" class="int">5</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#47109" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Awaiting scads cluster startup&quot;)" class="string">&quot;Awaiting scads cluster startup&quot;</span><span class="delimiter">)</span>
      <a href="#46084" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="(clusterSize: Int)Unit">blockUntilReady</span><span class="delimiter">(</span><a href="#47095" title="=&gt; Int">numServers</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient" id="46568">client</a> = <span title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient" class="keyword">new</span> <a href="TpcwClient.scala.html#9634" title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient">TpcwClient</a><span class="delimiter">(</span><a href="#46084" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>, <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">ParallelExecutor</span><span class="delimiter">)</span>
      <a href="#46085" title="edu.berkeley.cs.scads.piql.tpcw.TpcwLoader">loader</a>.<a href="TpcwLoader.scala.html#37162" title="(client: edu.berkeley.cs.scads.piql.tpcw.TpcwClient, replicationFactor: Int)Unit">createNamespaces</a><span class="delimiter">(</span><a href="#46568" title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient">client</a>, <a href="#47106" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>
      <span class="keyword">import</span> <a href="#46568" title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient">client</a>._
      <span title="(xs: edu.berkeley.cs.scads.storage.PairNamespace[_ &gt;: edu.berkeley.cs.scads.piql.tpcw.ShoppingCartItem with edu.berkeley.cs.scads.piql.tpcw.Order with edu.berkeley.cs.scads.piql.tpcw.OrderLine with edu.berkeley.cs.scads.piql.tpcw.Item with edu.berkeley.cs.scads.piql.tpcw.Country with edu.berkeley.cs.scads.piql.tpcw.CcXact with edu.berkeley.cs.scads.piql.tpcw.Author with edu.berkeley.cs.scads.piql.tpcw.Address &lt;: edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with org.apache.avro.specific.SpecificRecordBase with Product with Serializable{protected def valueImpl(): org.apache.avro.generic.GenericRecord; protected def keyImpl(): org.apache.avro.generic.GenericRecord}]*)List[edu.berkeley.cs.scads.storage.PairNamespace[_ &gt;: edu.berkeley.cs.scads.piql.tpcw.ShoppingCartItem with edu.berkeley.cs.scads.piql.tpcw.Order with edu.berkeley.cs.scads.piql.tpcw.OrderLine with edu.berkeley.cs.scads.piql.tpcw.Item with edu.berkeley.cs.scads.piql.tpcw.Country with edu.berkeley.cs.scads.piql.tpcw.CcXact with edu.berkeley.cs.scads.piql.tpcw.Author with edu.berkeley.cs.scads.piql.tpcw.Address &lt;: edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with org.apache.avro.specific.SpecificRecordBase with Product with Serializable{protected def valueImpl(): org.apache.avro.generic.GenericRecord; protected def keyImpl(): org.apache.avro.generic.GenericRecord}]]">List</span><span class="delimiter">(</span><a href="TpcwClient.scala.html#12736" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.Address]">addresses</a>,
           <a href="TpcwClient.scala.html#12738" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.Author]">authors</a>,
           <a href="TpcwClient.scala.html#12740" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.CcXact]">xacts</a>,
           <a href="TpcwClient.scala.html#12742" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.Country]">countries</a>,
           <a href="TpcwClient.scala.html#12746" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.Item]">items</a>,
           <a href="TpcwClient.scala.html#12748" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.OrderLine]">orderLines</a>,
           <a href="TpcwClient.scala.html#12750" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.Order]">orders</a>,
           <a href="TpcwClient.scala.html#12752" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.tpcw.ShoppingCartItem]">shoppingCartItems</a><span class="delimiter">)</span> <span title="(f: edu.berkeley.cs.scads.storage.PairNamespace[_ &gt;: edu.berkeley.cs.scads.piql.tpcw.ShoppingCartItem with edu.berkeley.cs.scads.piql.tpcw.Order with edu.berkeley.cs.scads.piql.tpcw.OrderLine with edu.berkeley.cs.scads.piql.tpcw.Item with edu.berkeley.cs.scads.piql.tpcw.Country with edu.berkeley.cs.scads.piql.tpcw.CcXact with edu.berkeley.cs.scads.piql.tpcw.Author with edu.berkeley.cs.scads.piql.tpcw.Address &lt;: edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with org.apache.avro.specific.SpecificRecordBase with Product with Serializable{protected def valueImpl(): org.apache.avro.generic.GenericRecord; protected def keyImpl(): org.apache.avro.generic.GenericRecord}] =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[_ &gt;: edu.berkeley.cs.scads.piql.tpcw.ShoppingCartItem with edu.berkeley.cs.scads.piql.tpcw.Order with edu.berkeley.cs.scads.piql.tpcw.OrderLine with edu.berkeley.cs.scads.piql.tpcw.Item with edu.berkeley.cs.scads.piql.tpcw.Country with edu.berkeley.cs.scads.piql.tpcw.CcXact with edu.berkeley.cs.scads.piql.tpcw.Author with edu.berkeley.cs.scads.piql.tpcw.Address &lt;: edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with org.apache.avro.specific.SpecificRecordBase with Product with Serializable{protected def valueImpl(): org.apache.avro.generic.GenericRecord; protected def keyImpl(): org.apache.avro.generic.GenericRecord}]" id="46910">ns</a> =&gt; <a href="#46910" title="edu.berkeley.cs.scads.storage.PairNamespace[_ &gt;: edu.berkeley.cs.scads.piql.tpcw.ShoppingCartItem with edu.berkeley.cs.scads.piql.tpcw.Order with edu.berkeley.cs.scads.piql.tpcw.OrderLine with edu.berkeley.cs.scads.piql.tpcw.Item with edu.berkeley.cs.scads.piql.tpcw.Country with edu.berkeley.cs.scads.piql.tpcw.CcXact with edu.berkeley.cs.scads.piql.tpcw.Author with edu.berkeley.cs.scads.piql.tpcw.Address &lt;: edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with org.apache.avro.specific.SpecificRecordBase with Product with Serializable{protected def valueImpl(): org.apache.avro.generic.GenericRecord; protected def keyImpl(): org.apache.avro.generic.GenericRecord}]">ns</a>.<span title="(readQuorum: Double, writeQuorum: Double)Unit">setReadWriteQuorum</span><span class="delimiter">(</span><span title="Double(0.33)" class="double">0.33</span>, <span title="Double(0.67)" class="double">0.67</span><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#46083" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;namespacesReady&quot;)" class="string">&quot;namespacesReady&quot;</span>, <a href="#47096" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient" id="46087">tpcwClient</a> = <span title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient" class="keyword">new</span> <a href="TpcwClient.scala.html#9634" title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient">TpcwClient</a><span class="delimiter">(</span><a href="#46084" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>, <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">ParallelExecutor</span><span class="delimiter">)</span>
    <a href="#46083" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;startBulkLoad&quot;)" class="string">&quot;startBulkLoad&quot;</span>, <a href="#47096" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>
    <a href="#47109" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining bulk loading of data&quot;)" class="string">&quot;Begining bulk loading of data&quot;</span><span class="delimiter">)</span>
    <a href="#46085" title="edu.berkeley.cs.scads.piql.tpcw.TpcwLoader">loader</a>.<a href="TpcwLoader.scala.html#37161" title="(client: edu.berkeley.cs.scads.piql.tpcw.TpcwClient)Seq[loader.NamespaceData]">namespaces</a><span class="delimiter">(</span><a href="#46087" title="edu.berkeley.cs.scads.piql.tpcw.TpcwClient">tpcwClient</a><span class="delimiter">)</span>.<span title="(f: loader.NamespaceData =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#46950" title="loader.NamespaceData">_</a>.<a href="TpcwLoader.scala.html#37766" title="(clientId: Int, numLoaders: Int)Unit">load</a><span class="delimiter">(</span><a href="#46086" title="Int">clientId</a>, <a href="#47096" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#47109" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bulk loading complete&quot;)" class="string">&quot;Bulk loading complete&quot;</span><span class="delimiter">)</span>
    <a href="#46083" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;loadingComplete&quot;)" class="string">&quot;loadingComplete&quot;</span>, <a href="#47096" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#46086" title="Int">clientId</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <a href="#47109" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;clusterReady&quot;)" class="string">&quot;clusterReady&quot;</span>, data=<a href="#47109" title="TpcwLoaderTask.this.type" class="keyword">this</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>