<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Iterators.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads
<span class="keyword">package</span> piql

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.apache.avro.util.Utf8
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> comm.<span class="delimiter">{</span>ScadsFuture, StringRec<span class="delimiter">}</span>

<span class="keyword">import</span> java.<span class="delimiter">{</span> util =&gt; ju <span class="delimiter">}</span>
<span class="keyword">import</span> scala.collection.mutable.Queue
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer

case <span class="keyword">class</span> <a title="class Context extends java.lang.Object with ScalaObject with Product with Serializable" id="43631">Context</a><a href="#43631" title="ScalaObject" class="delimiter">(</a><a title="IndexedSeq[Any]" id="29327">parameters</a>: <span title="IndexedSeq[Any]">IndexedSeq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span>, <a title="Option[List[Any]]" id="29328">state</a>: <span title="Option[List[Any]]">Option</span><span class="delimiter">[</span>List<span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class QueryIterator extends java.lang.Object with Iterator[edu.berkeley.cs.scads.piql.package.Tuple] with ScalaObject" id="9522">QueryIterator</a> <a href="#9522" title="ScalaObject" class="keyword">extends</a> <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="=&gt; String" id="28843">name</a>: <span title="String">String</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="28844">open</a>: <span title="Unit">Unit</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="28845">close</a>: <span title="Unit">Unit</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QueryExecutor extends java.lang.Object with ScalaObject" id="9523">QueryExecutor</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="28591">logger</a> = <span title="(name: String)net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span title="java.lang.String(&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;)" class="string">&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan, args: Any*)edu.berkeley.cs.scads.piql.QueryIterator" id="28593">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="28611">plan</a>: <a href="QueryPlan.scala.html#9608" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a>, <a title="Any*" id="28612">args</a>: <span title="Any*">Any</span>*<span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#28594" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><span class="delimiter">(</span><a href="#28611" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#43631" title="(parameters: IndexedSeq[Any], state: Option[List[Any]])edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">(</span><a href="#28612" title="Any*">args</a>.<span title="scala.collection.immutable.IndexedSeq[Any]">toIndexedSeq</span>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="28594">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="28614">plan</a>: <a href="QueryPlan.scala.html#9608" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="28615">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any" id="28595">bindValue</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="29348">value</a>: <a href="QueryPlan.scala.html#9577" title="edu.berkeley.cs.scads.piql.Value">Value</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="29349">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="29350">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Any">Any</span> = <span class="delimiter">{</span>
    <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundValue: %s %s %s&quot;)" class="string">&quot;BoundValue: %s %s %s&quot;</span>, <a href="#29348" title="edu.berkeley.cs.scads.piql.Value">value</a>, <a href="#29349" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a>, <a href="#29350" title="edu.berkeley.cs.scads.piql.Context">ctx</a><span class="delimiter">)</span>
    <a href="#29348" title="edu.berkeley.cs.scads.piql.Value">value</a> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Any">ConstantValue</span><span class="delimiter">(</span><a title="Any" id="29374">v</a><span class="delimiter">)</span> =&gt; <a href="#29374" title="Any">v</a>
      <span class="keyword">case</span> <span title="Any">ParameterValue</span><span class="delimiter">(</span><a title="Int" id="29393">o</a><span class="delimiter">)</span> =&gt; <a href="#29350" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29327" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#29393" title="Int">o</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="java.lang.Object">AttributeValue</span><span class="delimiter">(</span><a title="Int" id="29464">recPos</a>, <a title="Int" id="29465">fieldPos</a><span class="delimiter">)</span> =&gt; <a href="#29349" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">currentTuple</a><span class="delimiter">(</span><a href="#29464" title="Int">recPos</a><span class="delimiter">)</span>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#29465" title="Int">fieldPos</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key" id="28596">bindKey</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="29485">ns</a>: <a href="package.scala.html#25135" title="edu.berkeley.cs.scads.piql.package.Namespace">Namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="29486">key</a>: <span title="edu.berkeley.cs.scads.piql.package.KeyGenerator">KeyGenerator</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="29490">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="29488">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.piql.package.Key">Key</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="29491">boundKey</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#29485" title="edu.berkeley.cs.scads.piql.package.Namespace">ns</a>.<span title="=&gt; org.apache.avro.Schema">keySchema</span><span class="delimiter">)</span>

    <a href="#29486" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>.<span title="(f: edu.berkeley.cs.scads.piql.Value =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.Value],Any,Seq[Any]])Seq[Any]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Any,Seq[Any]]" class="delimiter">(</span><a href="#28595" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#29488" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#29631" title="edu.berkeley.cs.scads.piql.Value">_</a>, <a href="#29490" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],(Any, Int),Seq[(Any, Int)]])Seq[(Any, Int)]">zipWithIndex</span>.<span title="(f: (Any, Int) =&gt; Unit)Unit">foreach</span> <a href="#31640" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="Any" id="31643">value</a>: <span title="Any">Any</span>, <a title="Int" id="31644">idx</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt; <a href="#29491" title="org.apache.avro.generic.GenericData.Record">boundKey</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#31644" title="Int">idx</a>, <a href="#31643" title="Any">value</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bound Key: %s&quot;)" class="string">&quot;Bound Key: %s&quot;</span>, <a href="#29491" title="org.apache.avro.generic.GenericData.Record">boundKey</a><span class="delimiter">)</span>
    <a href="#29491" title="org.apache.avro.generic.GenericData.Record">boundKey</a>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int" id="28597">bindLimit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Limit" id="31654">limit</a>: <a href="QueryPlan.scala.html#9591" title="edu.berkeley.cs.scads.piql.Limit">Limit</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="31655">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#31654" title="edu.berkeley.cs.scads.piql.Limit">limit</a> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int">FixedLimit</span><span class="delimiter">(</span><a title="Int" id="31685">l</a><span class="delimiter">)</span> =&gt; <a href="#31685" title="Int">l</a>
    <span class="keyword">case</span> <span title="Int">ParameterLimit</span><span class="delimiter">(</span><a title="Int" id="31723">lim</a>, <a title="Int" id="31724">max</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="31725">limitValue</a> = <a href="#31655" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29327" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#31723" title="Int">lim</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Int" class="delimiter">[</span><span title="Int">Int</span><span class="delimiter">]</span>
      <span class="comment">//if(limitValue &gt; max)</span>
      <span class="comment">//  throw new RuntimeException(&quot;Limit out of range&quot;)</span>
      <a href="#31725" title="Int">limitValue</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(predicate: edu.berkeley.cs.scads.piql.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Boolean" id="28598">evalPredicate</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Predicate" id="31733">predicate</a>: <a href="QueryPlan.scala.html#9598" title="edu.berkeley.cs.scads.piql.Predicate">Predicate</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31734">tuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="31735">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#31733" title="edu.berkeley.cs.scads.piql.Predicate">predicate</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Boolean">EqualityPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="31774">v1</a>, <a title="edu.berkeley.cs.scads.piql.Value" id="31775">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#28600" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#28595" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31735" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31774" title="edu.berkeley.cs.scads.piql.Value">v1</a>, <a href="#31734" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>, <a href="#28595" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31735" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31775" title="edu.berkeley.cs.scads.piql.Value">v2</a>, <a href="#31734" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">InPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="31821">v1</a>, <a title="edu.berkeley.cs.scads.piql.Value" id="31822">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[Any]" id="31823">valueList</a> = <a href="#28595" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31735" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31822" title="edu.berkeley.cs.scads.piql.Value">v2</a>, <a href="#31734" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="keyword">val</span> <a title="Any" id="31824">boundValue</a> = <a href="#28595" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31735" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31821" title="edu.berkeley.cs.scads.piql.Value">v1</a>, <a href="#31734" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>
      <a href="#31823" title="Seq[Any]">valueList</a>.<span title="(f: Any =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Any" id="31846">v</a> =&gt; <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#28600" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#31846" title="Any">v</a>,<a href="#31824" title="Any">boundValue</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Nothing" class="keyword">return</span> <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int" id="28599">compareTuples</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31853">left</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31854">right</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="31855">attributes</a>: <span title="Seq[edu.berkeley.cs.scads.piql.Value]">Seq</span><span class="delimiter">[</span>Value<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="31856">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <a href="#31855" title="Seq[edu.berkeley.cs.scads.piql.Value]">attributes</a>.<span title="(f: edu.berkeley.cs.scads.piql.Value =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="31874">a</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Any" id="31875">leftValue</a> = <a href="#28595" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31856" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31874" title="edu.berkeley.cs.scads.piql.Value">a</a>, <a href="#31853" title="edu.berkeley.cs.scads.piql.package.Tuple">left</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Any" id="31876">rightValue</a> = <a href="#28595" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31856" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31874" title="edu.berkeley.cs.scads.piql.Value">a</a>, <a href="#31854" title="edu.berkeley.cs.scads.piql.package.Tuple">right</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Int" id="31877">comparison</a> = <a href="#28600" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#31875" title="Any">leftValue</a>, <a href="#31876" title="Any">rightValue</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#31877" title="Int">comparison</a> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span> <a href="#31877" title="Int">comparison</a>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span title="Nothing" class="keyword">return</span> <span title="Int(0)" class="int">0</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: Any, right: Any)Int" id="28600">compareAny</a><span class="delimiter">(</span><a title="Any" id="31776">left</a>: <span title="Any">Any</span>, <a title="Any" id="31777">right</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Any, _2: Any)(Any, Any)" class="delimiter">(</span><a href="#31776" title="Any">left</a>, <a href="#31777" title="Any">right</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="Integer" id="31891">l</a>: <span title="Integer">Integer</span>, <a title="Integer" id="31892">r</a>: <span title="Integer">Integer</span><span class="delimiter">)</span> =&gt; <a href="#31891" title="Integer">l</a>.<span title="()Int">intValue</span> <span title="(x: Int)Int">-</span> <a href="#31892" title="Integer">r</a>.<span title="()Int">intValue</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="31899">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="org.apache.avro.util.Utf8" id="31931">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#31899" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#31931" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="String" id="31963">l</a>: <span title="String">String</span>, <a title="org.apache.avro.util.Utf8" id="31964">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#31963" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">l</a> <span title="(other: String)Int">compare</span> <a href="#31964" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="32057">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="String" id="32058">r</a>: <span title="String">String</span><span class="delimiter">)</span> =&gt; <a href="#32057" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#32058" title="String">r</a>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class SimpleExecutor extends java.lang.Object with edu.berkeley.cs.scads.piql.QueryExecutor with ScalaObject" id="9524">SimpleExecutor</a> <a href="#9524" title="ScalaObject" class="keyword">extends</a> <a href="#9523" title="edu.berkeley.cs.scads.piql.QueryExecutor">QueryExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="32083">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="32085">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="32088">a</a>: <a href="#32085" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#32088" title="A">a</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="32086">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="32094">plan</a>: <a href="QueryPlan.scala.html#9608" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="32095">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#32094" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="32143">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="32144">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#32145" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="32145">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="32934">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookup&quot;)" class="string">&quot;SimpleIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="32936">boundKey</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#32143" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#32144" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="32939">result</a>: <span title="Option[edu.berkeley.cs.scads.piql.package.Record]">Option</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="32941">open</a>: <span title="Unit">Unit</span> =
          <a href="#32939" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#32143" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#32936" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="32942">close</a>: <span title="Unit">Unit</span> =
          <a href="#32939" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="32943">hasNext</a> = <a href="#32939" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Boolean">isDefined</span>
        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="32944">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="32945">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#32939" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#32939" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>
          <a href="#32945" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="33364">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="33365">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="33366">limit</a>, <a title="Boolean" id="33367">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#33368" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="33368">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="33539">name</a> = <span title="java.lang.String(&quot;SimpleIndexScan&quot;)" class="string">&quot;SimpleIndexScan&quot;</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="33541">boundKeyPrefix</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33364" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#33365" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="33544">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="33547">pos</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="33550">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="33553">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="33555">boundLimit</a> = <a href="#28597" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33366" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="33557">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#33541" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <a href="#33544" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#33364" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="33716">boundKeyPrefix</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="33717">boundKeyPrefix</a>, offset=<a href="#32083" title="Option[Int]" id="33718">offset</a>, limit=<a href="#32083" title="Option[Int]" id="33719">boundLimit</a>, ascending=<a href="#33367" title="Boolean" id="33720">ascending</a><span class="delimiter">)</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#33544" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#33550" title="=&gt; Int">offset</a>, <a href="#33555" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#33550" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#33544" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
            <a href="#33547" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#33544" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#33555" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
              <a href="#33553" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="33558">open</a>: <span title="Unit">Unit</span> = <a href="#33557" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="33559">close</a>: <span title="Unit">Unit</span> =
            <a href="#33544" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="33560">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#33547" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#33544" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#33553" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
              <span class="comment">// need to fetch more from KV store to see if we really have more</span>
              <a href="#33557" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#33560" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="33561">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#33560" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="33575">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#33544" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#33547" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#33547" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <a href="#33575" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="33813">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="33814">key</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="33815">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#33816" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="33816">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="33987">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookupJoin&quot;)" class="string">&quot;SimpleIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="33989">childIterator</a> = <a href="#32086" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33815" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="33992">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="33994">open</a> = <span class="delimiter">{</span><a href="#33989" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28844" title="=&gt; Unit">open</a>; <a href="#33998" title="=&gt; Unit">getNext</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="33995">close</a> = <a href="#33989" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="33996">hasNext</a> = <span class="delimiter">(</span><a href="#33992" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="33997">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34010">ret</a> = <a href="#33992" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#33998" title="=&gt; Unit">getNext</a>
          <a href="#34010" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="33998">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#33989" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#34013" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34014">childTuple</a> = <a href="#33989" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="34015">boundKey</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33813" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#33814" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#34014" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="34016">value</a> = <a href="#33813" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#34015" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#34016" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#33992" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#34014" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#34016" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>    <span class="comment">//TODO: Why does it return the boundKey???</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#33992" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="34516">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="34517">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="34518">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="34519">limit</a>, <a title="Boolean" id="34520">ascending</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="34521">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// TODO: Unifty this iterator and ParallelIndexMergeJoin, since a lot of</span>
      <span class="comment">// code is repeated</span>
      <a href="#34522" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="34522">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="34693">name</a> = <span title="java.lang.String(&quot;SimpleIndexMergeJoin&quot;)" class="string">&quot;SimpleIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="34695">childIterator</a> = <a href="#32086" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34521" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="34697">boundLimit</a> = <a href="#28597" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34519" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/** (key, child tup, offset, limit reached?) */</span>
        <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="34700">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="34703">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[Int]" id="34706">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34709">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="34711">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#34695" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28844" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="34737">tupleDatum</a> = <a href="#34695" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34742">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="34743">boundKeyPrefix</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34516" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#34517" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#34742" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="34744">records</a> = <a href="#34516" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="34778">getRange</a><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="34774">boundKeyPrefix</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="34775">boundKeyPrefix</a>, limit=<a href="#32083" title="Option[Int]" id="34776">boundLimit</a>, ascending=<a href="#34520" title="Boolean" id="34777">ascending</a><span class="delimiter">)</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#34743" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#34744" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="34745">recIdxSeq</a> = <a href="#34744" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="34799">r</a> =&gt; <a href="#34742" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#34799" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#34743" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#34742" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#34744" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#34744" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34697" title="=&gt; Int">boundLimit</a>, <a href="#34745" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#34700" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#34737" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="35061">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#35061" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#35061" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#35061" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#35061" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#34703" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#34737" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#35448" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#34706" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#34703" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#34717" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="34712">close</a>: <span title="Unit">Unit</span> = <a href="#34695" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="34713">hasNext</a> = <span class="delimiter">(</span><a href="#34709" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="34714">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#34713" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34723">ret</a> = <a href="#34709" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#34717" title="=&gt; Unit">getNext</a>
          <a href="#34723" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="34715">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="36036">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#36038" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#36037" title="edu.berkeley.cs.scads.piql.package.Record" id="36038">key</a>, <a href="#36037" title="edu.berkeley.cs.scads.piql.package.Tuple" id="36039">tup</a>, <a href="#36037" title="Int" id="36040">offset</a>, <a href="#36037" title="Boolean" id="36041">limitReached</a><span class="delimiter">)</span> = <a href="#34700" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#36036" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#36041" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="36042">records</a> = <a href="#34516" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="36090">key</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="36091">key</a>, offset=<a href="#32083" title="Option[Int]" id="36092">offset</a>, limit=<a href="#32083" title="Option[Int]" id="36093">boundLimit</a>, ascending=<a href="#34520" title="Boolean" id="36094">ascending</a><span class="delimiter">)</span>
          <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#36038" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#36042" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#34703" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#36036" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#36042" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="36158">r</a> =&gt; <a href="#36039" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#36158" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#34700" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#36036" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#36038" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#36039" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#36040" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#36042" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#36042" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34697" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="34716">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="36278">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#34700" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#36278" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="34717">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="36280">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="36281">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#36280" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#36281" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#34703" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#36282" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36281" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#36281" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#34716" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#36281" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#34715" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#36281" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36281" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#36281" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#36280" title="Int">minIdx</a> = <a href="#36281" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#36281" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#36280" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#34709" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="37056">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#36280" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#34703" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#34716" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#34715" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#34520" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28599" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36280" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36280" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34518" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#34520" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28599" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37056" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36280" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36280" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34518" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#36280" title="Int">minIdx</a> = <a href="#37056" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#34709" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#34703" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36280" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34706" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36280" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#34706" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#36280" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">LocalSelection</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Predicate" id="37162">predicate</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="37163">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37164" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="37164">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37335">name</a> = <span title="java.lang.String(&quot;Selection&quot;)" class="string">&quot;Selection&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="37337">childIterator</a> = <a href="#32086" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37163" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37340">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37342">open</a> = <span class="delimiter">{</span><a href="#37337" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28844" title="=&gt; Unit">open</a>; <a href="#37346" title="=&gt; Unit">getNext</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="37343">close</a> = <a href="#37337" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37344">hasNext</a> = <span class="delimiter">(</span><a href="#37340" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37345">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37358">ret</a> = <a href="#37340" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#37346" title="=&gt; Unit">getNext</a>
          <a href="#37358" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="37346">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#37337" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#37361" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37362">childValue</a> = <a href="#37337" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#28598" title="(predicate: edu.berkeley.cs.scads.piql.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Boolean">evalPredicate</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37162" title="edu.berkeley.cs.scads.piql.Predicate">predicate</a>, <a href="#37362" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#37340" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#37362" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#37340" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">LocalStopAfter</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Limit" id="37400">k</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="37401">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37402" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="37402">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37573">name</a> = <span title="java.lang.String(&quot;StopAfter&quot;)" class="string">&quot;StopAfter&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="37575">childIterator</a> = <a href="#32086" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37401" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="37577">limit</a> = <a href="#28597" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#32095" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37400" title="edu.berkeley.cs.scads.piql.Limit">k</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="37580">taken</a> = <span title="Int(0)" class="int">0</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37582">open</a> = <span class="delimiter">{</span><a href="#37580" title="(x$1: Int)Unit">taken</a> = <span title="Int(0)" class="int">0</span>; <a href="#37575" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28844" title="=&gt; Unit">open</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="37583">close</a> = <span class="delimiter">{</span><a href="#37575" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37584">hasNext</a> = <a href="#37575" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#37577" title="=&gt; Int">limit</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#37580" title="=&gt; Int">taken</a><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37585">next</a> = <span class="delimiter">{</span><a href="#37580" title="(x$1: Int)Unit">taken</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>; <a href="#37575" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span><span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">LocalIterator</span><span class="delimiter">(</span><a title="Int" id="37640">ordinal</a>, <a title="Boolean" id="37641">wrap</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37642" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="37642">QueryIterator</a> <span class="delimiter">{</span>
	<span class="keyword">val</span> <a title="java.lang.String" id="37813">name</a> = <span title="java.lang.String(&quot;LocalIterator&quot;)" class="string">&quot;LocalIterator&quot;</span>
	<span class="keyword">private</span> <span class="keyword">var</span> <a title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" id="37816">delegate</a>: <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="37818">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
	  <a href="#37816" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> = 
	    <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" class="keyword">if</span><span class="delimiter">(</span><a href="#37641" title="Boolean">wrap</a><span class="delimiter">)</span> <span class="comment">//This is kinda gross... I'm sorry.</span>
	      <a href="#32095" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29327" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#37640" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="(f: Any =&gt; scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]])Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]]" class="delimiter">(</span><a title="Any" id="37850">i</a> =&gt; <span title="(elems: edu.berkeley.cs.scads.comm.StringRec*)scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]">Vector</span><span class="delimiter">(</span><span title="(f1: String)edu.berkeley.cs.scads.comm.StringRec">StringRec</span><span class="delimiter">(</span><a href="#37850" title="Any">i</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="String" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Iterator[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]">toIterator</span>
	    <span class="keyword">else</span>
	      <a href="#32095" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29327" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#37640" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]" class="delimiter">[</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]">Seq</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">toIterator</span>
	<span class="delimiter">}</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="37819">close</a>: <span title="Unit">Unit</span> = <a href="#37816" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> = <span title="Null(null)" class="keyword">null</span>
	<span class="keyword">def</span> <a title="=&gt; Boolean" id="37820">hasNext</a> = <a href="#37816" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="=&gt; Boolean">hasNext</span>
	<span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37821">next</a> = <a href="#37816" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">Union</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="38674">chil1</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="38675">child2</a>, <a title="edu.berkeley.cs.scads.piql.AttributeValue" id="38676">eqField</a><span class="delimiter">)</span>  =&gt;<span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not yet implemented&quot;)" class="string">&quot;Not yet implemented&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * TODO: Should abstract out the common parts between the query iterators.
 */</span>
<span class="keyword">class</span> <a title="class ParallelExecutor extends edu.berkeley.cs.scads.piql.SimpleExecutor with ScalaObject" id="9525">ParallelExecutor</a> <a href="#9525" title="ScalaObject" class="keyword">extends</a> <a href="#9524" title="edu.berkeley.cs.scads.piql.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="38682">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="38684">plan</a>: <a href="QueryPlan.scala.html#9608" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="38685">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#38684" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="38688">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="38689">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#38690" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="38690">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="38861">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookup&quot;)" class="string">&quot;ParallelIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="38863">boundKey</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#38688" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#38689" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]" id="38866">ftch</a>: <span title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">Option</span><span class="delimiter">[</span>ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="38868">open</a>: <span title="Unit">Unit</span> =
          <a href="#38866" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="(x: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])Some[edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]]">Some</span><span class="delimiter">(</span><a href="#38688" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#38863" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="38869">close</a>: <span title="Unit">Unit</span> =
          <a href="#38866" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="38870">hasNext</a> =
          <a href="#38866" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#38889" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="38871">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39309">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#38866" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#39315" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Empty iterator&quot;)" class="string">&quot;Empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#38866" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>
          <a href="#39309" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="39330">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="39331">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="39332">limit</a>, <a title="Boolean" id="39333">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#39334" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="39334">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="39505">name</a> = <span title="java.lang.String(&quot;ParallelIndexScan&quot;)" class="string">&quot;ParallelIndexScan&quot;</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="39507">boundKeyPrefix</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39330" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#39331" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="39510">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="39513">ftch</a>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span> = _

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="39516">pos</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="39519">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="39522">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="39524">boundLimit</a> = <a href="#28597" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39332" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span> <span class="comment">// should get rid of 2nd getRange</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="39527">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39529">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#39507" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <a href="#39513" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <a href="#39330" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">asyncGetRange</span><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39615">boundKeyPrefix</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39616">boundKeyPrefix</a>, offset=<a href="#32083" title="Option[Int]" id="39617">offset</a>, limit=<a href="#32083" title="Option[Int]" id="39618">boundLimit</a>, ascending=<a href="#39333" title="Boolean" id="39619">ascending</a><span class="delimiter">)</span>
            <a href="#39527" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39530">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#39510" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#39513" title="=&gt; edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#39510" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#39519" title="=&gt; Int">offset</a>, <a href="#39524" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#39519" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#39510" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
            <a href="#39516" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#39510" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#39524" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
              <a href="#39522" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
            <a href="#39527" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="39531">open</a>: <span title="Unit">Unit</span> = <a href="#39529" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="39532">close</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
            <a href="#39510" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>
            <a href="#39513" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="39533">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39527" title="=&gt; Boolean">ftchInvoked</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// have we already blocked on ftch and stored the result in result?</span>
              <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39516" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#39510" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
              <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39522" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
              <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="comment">// need to fetch more from KV store to see if we really have more</span>
                <a href="#39529" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
                <a href="#39533" title="=&gt; Boolean">hasNext</a>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <a href="#39530" title="()Unit">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#39533" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39534">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39533" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39540">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#39510" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#39516" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#39516" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <a href="#39540" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="39636">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="39637">key</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="39638">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#39639" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="39639">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="39810">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookupJoin&quot;)" class="string">&quot;ParallelIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="39812">childIterator</a> = <a href="#38682" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39638" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="39815">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" id="39817">ftchs</a> = <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" class="keyword">new</span> <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">Queue</span><span class="delimiter">[</span><span class="delimiter">(</span>Tuple, Record, ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="39819">windowSize</a> = <span title="Int(10)" class="int">10</span> <span class="comment">// keep 10 outstanding ftchs at a time</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="39821">open</a> = <span class="delimiter">{</span><a href="#39812" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28844" title="=&gt; Unit">open</a>; <a href="#39825" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="39822">close</a> = <a href="#39812" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="39823">hasNext</a> = <span class="delimiter">(</span><a href="#39815" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>
          <span class="keyword">var</span> <a title="Boolean" id="39837">found</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39837" title="Boolean">found</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#39817" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#39838" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a href="#40018" title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#40017" title="edu.berkeley.cs.scads.piql.package.Tuple" id="40018">childTuple</a>, <a href="#40017" title="edu.berkeley.cs.scads.piql.package.Record" id="40019">boundKey</a>, <a href="#40017" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]" id="40020">ftch</a><span class="delimiter">)</span> = <a href="#39817" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="()(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])">dequeue</span><span title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#40020" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Record" id="40039">recVal</a><span class="delimiter">)</span> =&gt;
                <a href="#39815" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40018" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#40039" title="edu.berkeley.cs.scads.piql.package.Record">recVal</a><span class="delimiter">)</span>
                <a href="#39837" title="Boolean">found</a> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">// done</span>
              <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="comment">// keep going</span>
            <span class="delimiter">}</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#39817" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39812" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <span class="comment">// need to get more records</span>
              <a href="#39825" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#39837" title="Boolean">found</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="39824">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39823" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40139">ret</a> = <a href="#39815" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#39815" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#39825" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#40139" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39825">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#39812" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39817" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#39819" title="=&gt; Int">windowSize</a><span class="delimiter">)</span> <a href="#40143" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40153">childTuple</a> = <a href="#39812" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40154">boundKey</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39636" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#39637" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#40153" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]" id="40155">valueFtch</a> = <a href="#39636" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#40154" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>
            <a href="#39817" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a> <span title="(elem: (edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]))this.ftchs.type">+=</span> <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Tuple, _2: edu.berkeley.cs.scads.piql.package.Key, _3: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#40153" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a>, <a href="#40154" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a>, <a href="#40155" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">valueFtch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="40173">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="40174">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="40175">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="40176">limit</a>, <a title="Boolean" id="40177">ascending</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="40178">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#40179" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="40179">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="40350">name</a> = <span title="java.lang.String(&quot;ParallelIndexMergeJoin&quot;)" class="string">&quot;ParallelIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="40352">childIterator</a> = <a href="#38682" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40178" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="40354">boundLimit</a> = <a href="#28597" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40176" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/**
         * (key, child tup, offset, limit reached?, outstanding ftch)
         */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]" id="40357">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Key, Tuple, Int, Boolean, ScadsFuture<span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="40360">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="40363">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40366">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40368">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#40352" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28844" title="=&gt; Unit">open</a>

          <a href="#40357" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])Unit">tupleData</a> = <a href="#40352" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40818">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40819">boundKeyPrefix</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40173" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#40174" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#40818" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]" id="40820">ftch</a> = <a href="#40173" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="40853">asyncGetRange</a><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40849">boundKeyPrefix</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40850">boundKeyPrefix</a>, limit=<a href="#32083" title="Option[Int]" id="40851">boundLimit</a>, ascending=<a href="#40177" title="Boolean" id="40852">ascending</a><span class="delimiter">)</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#40819" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#40818" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <span title="Int(0)" class="int">0</span>, <span title="Boolean(false)" class="keyword">false</span>, <a href="#40820" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">ftch</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">toArray</span>

          <a href="#40360" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple])(implicit evidence$9: scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">fill</span><span class="delimiter">(</span><a href="#40357" title="(xs: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])scala.collection.mutable.ArrayOps[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleData</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="(clazz: java.lang.Class[_], arg1: scala.reflect.OptManifest[_], args: scala.reflect.OptManifest[_]*)scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" class="delimiter">(</span><span title="=&gt; collection.IndexedSeq.type">IndexedSeq</span>.<span title="IndexedSeq[Nothing]">empty</span><span class="delimiter">)</span>
          <a href="#40363" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#40360" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40369">close</a>: <span title="Unit">Unit</span> = <a href="#40352" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="40370">hasNext</a> = <span class="delimiter">(</span><a href="#40366" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="40379">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="40380">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#40380" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#40360" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#40381" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40380" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40380" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40372" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40380" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40371" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40380" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40380" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40380" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40379" title="Int">minIdx</a> = <a href="#40380" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#40380" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="40727">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#40360" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40372" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#40371" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#40177" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28599" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40175" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40177" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28599" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40727" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40175" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#40379" title="Int">minIdx</a> = <a href="#40727" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#40366" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#40363" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>

            <span class="comment">// do another fetch if we reach the end of minIdx's buffer- this</span>
            <span class="comment">// is unlike SimpleIndexMergeJoin which does not do another fetch</span>
            <span class="comment">// here.</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40363" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40360" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40372" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#40371" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40379" title="Int">minIdx</a><span class="delimiter">)</span>

            <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="40371">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="40502">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>

          <span class="keyword">val</span> <a href="#41266" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#41265" title="edu.berkeley.cs.scads.piql.package.Key" id="41266">key</a>, <a href="#41265" title="edu.berkeley.cs.scads.piql.package.Tuple" id="41267">tup</a>, <a href="#41265" title="Int" id="41268">offset</a>, <a href="#41265" title="Boolean" id="41269">limitReached</a>, <a href="#41265" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="41270">ftch</a><span class="delimiter">)</span> = <a href="#40357" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><a href="#40502" title="Int">i</a><span class="delimiter">)</span>

          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41269" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#41266" title="edu.berkeley.cs.scads.piql.package.Key">key</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41267" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41270" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41268" title="Int">offset</a> <span title="(x: Int)Boolean">!=</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="41271">records</a> = <a href="#41270" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
          <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#41266" title="edu.berkeley.cs.scads.piql.package.Key">key</a>, <a href="#41271" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a><span class="delimiter">)</span>

          <span class="comment">// TODO: is it slow to ++= append to an IndexedSeq??</span>
          <a href="#40360" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#40502" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#41271" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Record =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.package.Record],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#41267" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#41367" title="edu.berkeley.cs.scads.piql.package.Record">_</a><span class="delimiter">)</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41271" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40354" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// end of records in KV store</span>
            <a href="#40357" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]))Unit">tupleData</a><span class="delimiter">(</span><a href="#40502" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: Null, _2: Null, _3: Int, _4: Boolean, _5: Null)(Null, Null, Int, Boolean, Null)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span>, -<span title="Int(-1)" class="int">1</span>, <span title="Boolean(true)" class="keyword">true</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">// sentinel values</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="delimiter">{</span> <span class="comment">// still can ask for more records</span>
            <span class="comment">//val newOffset = records.size + offset</span>
            <span class="comment">//val newFtch = namespace.asyncGetRange(key, key, offset=newOffset, limit=boundLimit, ascending=ascending)</span>
            <span class="comment">//tupleData(i) = ((key, tup, newOffset, limitReached, newFtch))</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="40372">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="40500">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#40357" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span class="delimiter">(</span><a href="#40500" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="40373">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40370" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40801">ret</a> = <a href="#40366" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#40366" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#40801" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator">_</span> =&gt; <a href="#9525" title="edu.berkeley.cs.scads.piql.ParallelExecutor" class="keyword">super</a>.<a href="#32086" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#38685" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#38684" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class LazyExecutor extends edu.berkeley.cs.scads.piql.SimpleExecutor with ScalaObject" id="9526">LazyExecutor</a> <a href="#9526" title="ScalaObject" class="keyword">extends</a> <a href="#9524" title="edu.berkeley.cs.scads.piql.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="41476">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="41478">plan</a>: <a href="QueryPlan.scala.html#9608" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="41479">ctx</a>: <a href="#43631" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#41478" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41482">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41483">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#41484" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="41484">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="41655">name</a> = <span title="java.lang.String(&quot;LazyIndexLookup&quot;)" class="string">&quot;LazyIndexLookup&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="41657">boundKey</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41482" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41483" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="41660">accessed</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="41663">result</a> = <a href="#41482" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#41657" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="41664">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="41665">close</a> <span class="delimiter">{</span> <a href="#41660" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span> <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="41666">hasNext</a> = <a href="#41660" title="=&gt; Boolean">accessed</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Boolean" class="keyword">false</span> =&gt; <a href="#41662" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; Boolean">isDefined</span>
          <span class="keyword">case</span> <span title="Boolean(false)" class="keyword">true</span>  =&gt; <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]" id="41667">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41666" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <a href="#41660" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span title="(elems: org.apache.avro.generic.IndexedRecord*)scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]">ArrayBuffer</span><span class="delimiter">(</span><a href="#41662" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41675">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41676">keyPrefix</a>, _, <a title="Boolean" id="41677">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span> <span class="comment">// we don't care about limit here</span>
        <a href="#41678" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="41678">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="41849">name</a> = <span title="java.lang.String(&quot;LazyIndexScan&quot;)" class="string">&quot;LazyIndexScan&quot;</span>

          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="41851">boundKeyPrefix</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41675" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41676" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Record" id="41854">result</a>: <span title="edu.berkeley.cs.scads.piql.package.Record">Record</span> = <span title="Null(null)" class="keyword">null</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="41857">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="41860">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="41862">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#41851" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="41877">res</a> = <a href="#41675" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="41924">boundKeyPrefix</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="41925">boundKeyPrefix</a>, offset=<a href="#32083" title="Option[Int]" id="41926">offset</a>, limit=<a href="#32083" title="Option[Int]" id="41927" class="int">1</a>, ascending=<a href="#41677" title="Boolean" id="41928">ascending</a><span class="delimiter">)</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#41877" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>, <a href="#41857" title="=&gt; Int">offset</a>, <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
            <a href="#41857" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#41877" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Int">size</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41877" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#41860" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
              <a href="#41854" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <a href="#41854" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <a href="#41877" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">head</span>
            <span class="delimiter">}</span>
            <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#41860" title="=&gt; Boolean">limitReached</a> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#41854" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="41863">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="41864">close</a> <span class="delimiter">{</span>
            <a href="#41854" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <a href="#41860" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="41865">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#41854" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41860" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#41862" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#41865" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Boolean(false)" class="keyword">false</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="41866">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41865" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="41867">ret</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#41854" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">)</span>
            <a href="#41854" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <a href="#41867" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ret</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41939">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41940">key</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="41941">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#41942" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="41942">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="42113">name</a> = <span title="java.lang.String(&quot;LazyIndexLookupJoin&quot;)" class="string">&quot;LazyIndexLookupJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="42115">childIterator</a> = <a href="#41476" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41941" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42118">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="42121">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42123">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="42124">close</a> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42121" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <a href="#42121" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <a href="#42115" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="42125">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42121" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#42121" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
            <a href="#42127" title="=&gt; Unit">getNext</a>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#42118" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="42126">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42134">ret</a> = <a href="#42118" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#42127" title="=&gt; Unit">getNext</a>
          <a href="#42134" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="42127">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#42115" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#42143" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42144">childTuple</a> = <a href="#42115" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="42145">boundKey</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41939" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41940" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#42144" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="42146">value</a> = <a href="#41939" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#42145" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#42146" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#42118" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#42144" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#42146" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#42118" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="42245">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="42246">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="42247">sortFields</a>, _, <a title="Boolean" id="42248">ascending</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="42249">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#42250" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="42250">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="42421">name</a> = <span title="java.lang.String(&quot;LazyIndexMergeJoin&quot;)" class="string">&quot;LazyIndexMergeJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="42423">childIterator</a> = <a href="#41476" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42249" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>

        <span class="comment">/** (key, child tup, offset, limit reached?) */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="42426">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="42429">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="42432">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42435">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="42438">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="42440">init</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#42423" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28844" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="42468">tupleDatum</a> = <a href="#42423" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42473">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="42474">boundKeyPrefix</a> = <a href="#28596" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42245" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#42246" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#42473" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="42475">records</a> = <a href="#42245" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="42509">getRange</a><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="42505">boundKeyPrefix</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="42506">boundKeyPrefix</a>, limit=<a href="#32083" title="Option[Int]" id="42507" class="int">1</a>, ascending=<a href="#42248" title="Boolean" id="42508">ascending</a><span class="delimiter">)</span>
            <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#42474" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#42475" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="42476">recIdxSeq</a> = <a href="#42475" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#42473" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#42530" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#42474" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#42473" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#42475" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#42475" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span>, <a href="#42476" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#42426" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#42468" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="42680">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#42680" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#42680" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#42680" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#42680" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#42429" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#42468" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#42779" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#42432" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#42429" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#42447" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42441">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42442">close</a> <span class="delimiter">{</span>
          <a href="#42423" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28845" title="=&gt; Unit">close</a>
          <a href="#42438" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="42443">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42438" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#42440" title="()Unit">init</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#42438" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#42435" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="42444">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42443" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42454">ret</a> = <a href="#42435" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#42447" title="=&gt; Unit">getNext</a>
          <a href="#42454" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="42445">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="42981">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#42983" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#42982" title="edu.berkeley.cs.scads.piql.package.Record" id="42983">key</a>, <a href="#42982" title="edu.berkeley.cs.scads.piql.package.Tuple" id="42984">tup</a>, <a href="#42982" title="Int" id="42985">offset</a>, <a href="#42982" title="Boolean" id="42986">limitReached</a><span class="delimiter">)</span> = <a href="#42426" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#42981" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42986" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="42987">records</a> = <a href="#42245" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="43034">key</a>, <a href="#32083" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="43035">key</a>, offset=<a href="#32083" title="Option[Int]" id="43036">offset</a>, limit=<a href="#32083" title="Option[Int]" id="43037" class="int">1</a>, ascending=<a href="#42248" title="Boolean" id="43038">ascending</a><span class="delimiter">)</span>
          <a href="#28591" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;</span>, <a href="#42983" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#42987" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#42429" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#42981" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#42987" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#42984" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#43087" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#42426" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#42981" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#42983" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#42984" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#42985" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#42987" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#42987" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="42446">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="43207">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#42426" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#43207" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="42447">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="43209">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="43210">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#43209" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#43210" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#42429" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#43211" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43210" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43210" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#42446" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#43210" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#42445" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#43210" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43210" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43210" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#43209" title="Int">minIdx</a> = <a href="#43210" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#43210" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#43209" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#42435" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="43554">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#43209" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#42429" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#42446" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#42445" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#42248" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28599" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43209" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43209" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42247" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42248" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28599" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43554" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43209" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43209" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42247" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#43209" title="Int">minIdx</a> = <a href="#43554" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#42435" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#42429" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43209" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42432" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43209" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#42432" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#43209" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator">_</span> =&gt; <a href="#9526" title="edu.berkeley.cs.scads.piql.LazyExecutor" class="keyword">super</a>.<a href="#32086" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#41479" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41478" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>