<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Iterators.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> exec

<span class="keyword">import</span> plans._

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.apache.avro.util.Utf8
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> comm.ScadsFuture

<span class="keyword">import</span> java.<span class="delimiter">{</span>util =&gt; ju<span class="delimiter">}</span>
<span class="keyword">import</span> scala.collection.mutable.Queue
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer

<span class="comment">/**
 * The contex for a query plan to be executed in.
 * @param parameters - any runtime parameters for the query
 * @param state - the serialized state if resuming the query from a previous execution.
 */</span>
case <span class="keyword">class</span> <a title="class Context extends java.lang.Object with ScalaObject with Product with Serializable" id="42024">Context</a><a href="#42024" title="ScalaObject" class="delimiter">(</a><a title="IndexedSeq[Any]" id="19379">parameters</a>: <span title="IndexedSeq[Any]">IndexedSeq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span>, <a title="Option[List[Any]]" id="19380">state</a>: <span title="Option[List[Any]]">Option</span><span class="delimiter">[</span>List<span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class QueryIterator extends java.lang.Object with Iterator[edu.berkeley.cs.scads.piql.package.Tuple] with ScalaObject" id="9522">QueryIterator</a> <a href="#9522" title="ScalaObject" class="keyword">extends</a> <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="=&gt; String" id="19115">name</a>: <span title="String">String</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="19116">open</a>: <span title="Unit">Unit</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="19117">close</a>: <span title="Unit">Unit</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * A query executor takes a physical query plan and produces and iterator tree that will execute the query with
 * a given strategy.
 */</span>
<span class="keyword">trait</span> <a title="trait QueryExecutor extends java.lang.Object with ScalaObject" id="9523">QueryExecutor</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="19131">logger</a> = <span title="(name: String)net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span title="java.lang.String(&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;)" class="string">&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan, args: Any*)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="19133">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="19339">plan</a>: <a href="QueryPlan.scala.html#9628" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a>, <a title="Any*" id="19340">args</a>: <span title="Any*">Any</span>*<span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#19134" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><span class="delimiter">(</span><a href="#19339" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42024" title="(parameters: IndexedSeq[Any], state: Option[List[Any]])edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">(</span><a href="#19340" title="Any*">args</a>.<span title="scala.collection.immutable.IndexedSeq[Any]">toIndexedSeq</span>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="19134">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="19374">plan</a>: <a href="QueryPlan.scala.html#9628" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="19375">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any" id="19135">bindValue</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="20007">value</a>: <a href="QueryPlan.scala.html#9597" title="edu.berkeley.cs.scads.piql.plans.Value">Value</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="20008">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="20009">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Any">Any</span> = <span class="delimiter">{</span>
    <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundValue: %s %s %s&quot;)" class="string">&quot;BoundValue: %s %s %s&quot;</span>, <a href="#20007" title="edu.berkeley.cs.scads.piql.plans.Value">value</a>, <a href="#20008" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a>, <a href="#20009" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a><span class="delimiter">)</span>
    <a href="#20007" title="edu.berkeley.cs.scads.piql.plans.Value">value</a> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Any">ConstantValue</span><span class="delimiter">(</span><a title="Any" id="20048">v</a><span class="delimiter">)</span> =&gt; <a href="#20048" title="Any">v</a>
      <span class="keyword">case</span> <span title="Any">ParameterValue</span><span class="delimiter">(</span><a title="Int" id="20073">o</a><span class="delimiter">)</span> =&gt; <a href="#20009" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#19379" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#20073" title="Int">o</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="java.lang.Object">AttributeValue</span><span class="delimiter">(</span><a title="Int" id="20141">recPos</a>, <a title="Int" id="20142">fieldPos</a><span class="delimiter">)</span> =&gt; <a href="#20008" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">currentTuple</a><span class="delimiter">(</span><a href="#20141" title="Int">recPos</a><span class="delimiter">)</span>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#20142" title="Int">fieldPos</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key" id="19136">bindKey</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="20167">ns</a>: <a href="package.scala.html#20256" title="edu.berkeley.cs.scads.piql.package.Namespace">Namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="20168">key</a>: <span title="edu.berkeley.cs.scads.piql.package.KeyGenerator">KeyGenerator</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="20172">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="20170">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.piql.package.Key">Key</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="20257">boundKey</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#20167" title="edu.berkeley.cs.scads.piql.package.Namespace">ns</a>.<span title="=&gt; org.apache.avro.Schema">keySchema</span><span class="delimiter">)</span>

    <a href="#20168" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>.<span title="(f: edu.berkeley.cs.scads.piql.plans.Value =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.plans.Value],Any,Seq[Any]])Seq[Any]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Any,Seq[Any]]" class="delimiter">(</span><a href="#19135" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#20170" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#21002" title="edu.berkeley.cs.scads.piql.plans.Value">_</a>, <a href="#20172" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],(Any, Int),Seq[(Any, Int)]])Seq[(Any, Int)]">zipWithIndex</span>.<span title="(f: (Any, Int) =&gt; Unit)Unit">foreach</span> <a href="#28753" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="Any" id="28756">value</a>: <span title="Any">Any</span>, <a title="Int" id="28757">idx</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt; <a href="#20257" title="org.apache.avro.generic.GenericData.Record">boundKey</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#28757" title="Int">idx</a>, <a href="#28756" title="Any">value</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bound Key: %s&quot;)" class="string">&quot;Bound Key: %s&quot;</span>, <a href="#20257" title="org.apache.avro.generic.GenericData.Record">boundKey</a><span class="delimiter">)</span>
    <a href="#20257" title="org.apache.avro.generic.GenericData.Record">boundKey</a>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int" id="19137">bindLimit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Limit" id="28767">limit</a>: <a href="QueryPlan.scala.html#9611" title="edu.berkeley.cs.scads.piql.plans.Limit">Limit</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="28768">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#28767" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int">FixedLimit</span><span class="delimiter">(</span><a title="Int" id="28795">l</a><span class="delimiter">)</span> =&gt; <a href="#28795" title="Int">l</a>
    <span class="keyword">case</span> <span title="Int">ParameterLimit</span><span class="delimiter">(</span><a title="Int" id="28826">lim</a>, <a title="Int" id="28827">max</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="28828">limitValue</a> = <a href="#28768" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#19379" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#28826" title="Int">lim</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Int" class="delimiter">[</span><span title="Int">Int</span><span class="delimiter">]</span>
      <span class="comment">//if(limitValue &gt; max)</span>
      <span class="comment">//  throw new RuntimeException(&quot;Limit out of range&quot;)</span>
      <a href="#28828" title="Int">limitValue</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(predicate: edu.berkeley.cs.scads.piql.plans.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Boolean" id="19138">evalPredicate</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Predicate" id="28836">predicate</a>: <a href="QueryPlan.scala.html#9618" title="edu.berkeley.cs.scads.piql.plans.Predicate">Predicate</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="28837">tuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="28838">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#28836" title="edu.berkeley.cs.scads.piql.plans.Predicate">predicate</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Boolean">EqualityPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="28870">v1</a>, <a title="edu.berkeley.cs.scads.piql.plans.Value" id="28871">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#19140" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#19135" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#28838" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#28870" title="edu.berkeley.cs.scads.piql.plans.Value">v1</a>, <a href="#28837" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>, <a href="#19135" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#28838" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#28871" title="edu.berkeley.cs.scads.piql.plans.Value">v2</a>, <a href="#28837" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">InPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="28910">v1</a>, <a title="edu.berkeley.cs.scads.piql.plans.Value" id="28911">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[Any]" id="28912">valueList</a> = <a href="#19135" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#28838" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#28911" title="edu.berkeley.cs.scads.piql.plans.Value">v2</a>, <a href="#28837" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="keyword">val</span> <a title="Any" id="28913">boundValue</a> = <a href="#19135" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#28838" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#28910" title="edu.berkeley.cs.scads.piql.plans.Value">v1</a>, <a href="#28837" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>
      <a href="#28912" title="Seq[Any]">valueList</a>.<span title="(f: Any =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Any" id="28935">v</a> =&gt; <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#19140" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#28935" title="Any">v</a>, <a href="#28913" title="Any">boundValue</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Nothing" class="keyword">return</span> <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int" id="19139">compareTuples</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="28942">left</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="28943">right</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="28944">attributes</a>: <span title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">Seq</span><span class="delimiter">[</span>Value<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="28945">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <a href="#28944" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">attributes</a>.<span title="(f: edu.berkeley.cs.scads.piql.plans.Value =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="28963">a</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Any" id="28964">leftValue</a> = <a href="#19135" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#28945" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#28963" title="edu.berkeley.cs.scads.piql.plans.Value">a</a>, <a href="#28942" title="edu.berkeley.cs.scads.piql.package.Tuple">left</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Any" id="28965">rightValue</a> = <a href="#19135" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#28945" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#28963" title="edu.berkeley.cs.scads.piql.plans.Value">a</a>, <a href="#28943" title="edu.berkeley.cs.scads.piql.package.Tuple">right</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Int" id="28966">comparison</a> = <a href="#19140" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#28964" title="Any">leftValue</a>, <a href="#28965" title="Any">rightValue</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#28966" title="Int">comparison</a> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span> <a href="#28966" title="Int">comparison</a>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span title="Nothing" class="keyword">return</span> <span title="Int(0)" class="int">0</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: Any, right: Any)Int" id="19140">compareAny</a><span class="delimiter">(</span><a title="Any" id="28872">left</a>: <span title="Any">Any</span>, <a title="Any" id="28873">right</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Any, _2: Any)(Any, Any)" class="delimiter">(</span><a href="#28872" title="Any">left</a>, <a href="#28873" title="Any">right</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="Integer" id="28980">l</a>: <span title="Integer">Integer</span>, <a title="Integer" id="28981">r</a>: <span title="Integer">Integer</span><span class="delimiter">)</span> =&gt; <a href="#28980" title="Integer">l</a>.<span title="()Int">intValue</span> <span title="(x: Int)Int">-</span> <a href="#28981" title="Integer">r</a>.<span title="()Int">intValue</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="29128">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="org.apache.avro.util.Utf8" id="29160">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#29128" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#29160" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="String" id="29192">l</a>: <span title="String">String</span>, <a title="org.apache.avro.util.Utf8" id="29193">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#29192" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">l</a> <span title="(other: String)Int">compare</span> <a href="#29193" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="29504">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="String" id="29505">r</a>: <span title="String">String</span><span class="delimiter">)</span> =&gt; <a href="#29504" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#29505" title="String">r</a>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * The simple executor issues requests to the key/value store serially.
 */</span>
<span class="keyword">class</span> <a title="class SimpleExecutor extends java.lang.Object with edu.berkeley.cs.scads.piql.exec.QueryExecutor with ScalaObject" id="9524">SimpleExecutor</a> <a href="#9524" title="ScalaObject" class="keyword">extends</a> <a href="#9523" title="edu.berkeley.cs.scads.piql.exec.QueryExecutor">QueryExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="29530">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="29532">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="29535">a</a>: <a href="#29532" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#29535" title="A">a</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="29533">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="29541">plan</a>: <a href="QueryPlan.scala.html#9628" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="29542">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#29541" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="29575">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="29576">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#29577" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="29577">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="30375">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookup&quot;)" class="string">&quot;SimpleIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="30377">boundKey</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#29575" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#29576" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="30380">result</a>: <span title="Option[edu.berkeley.cs.scads.piql.package.Record]">Option</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="30382">open</a>: <span title="Unit">Unit</span> =
          <a href="#30380" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#29575" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#30377" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="30383">close</a>: <span title="Unit">Unit</span> =
          <a href="#30380" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="30384">hasNext</a> = <a href="#30380" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Boolean">isDefined</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="30385">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="30386">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#30380" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#30380" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>
          <a href="#30386" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="31204">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="31205">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="31206">limit</a>, <a title="Boolean" id="31207">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#31208" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="31208">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="31379">name</a> = <span title="java.lang.String(&quot;SimpleIndexScan&quot;)" class="string">&quot;SimpleIndexScan&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="31381">boundKeyPrefix</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31204" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#31205" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="31384">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="31387">pos</a> = <span title="Int(0)" class="int">0</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="31390">offset</a> = <span title="Int(0)" class="int">0</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="31393">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="31395">boundLimit</a> = <a href="#19137" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31206" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span>

        @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="31397">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#31381" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
          <a href="#31384" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#31204" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="31558">boundKeyPrefix</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="31559">boundKeyPrefix</a>, offset = <a href="#29530" title="Option[Int]" id="31560">offset</a>, limit = <a href="#29530" title="Option[Int]" id="31561">boundLimit</a>, ascending = <a href="#31207" title="Boolean" id="31562">ascending</a><span class="delimiter">)</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#31384" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#31390" title="=&gt; Int">offset</a>, <a href="#31395" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
          <a href="#31390" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#31384" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
          <a href="#31387" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#31384" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#31395" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#31393" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="31398">open</a>: <span title="Unit">Unit</span> = <a href="#31397" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="31399">close</a>: <span title="Unit">Unit</span> =
          <a href="#31384" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="31400">hasNext</a> =
          <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#31387" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#31384" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
          <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#31393" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="comment">// need to fetch more from KV store to see if we really have more</span>
            <a href="#31397" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#31400" title="=&gt; Boolean">hasNext</a>
          <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="31401">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#31400" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="31415">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#31384" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#31387" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#31387" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <a href="#31415" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="31631">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="31632">key</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="31633">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#31634" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="31634">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="31805">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookupJoin&quot;)" class="string">&quot;SimpleIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="31807">childIterator</a> = <a href="#29533" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31633" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31810">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="31812">open</a> = <span class="delimiter">{</span>
          <a href="#31807" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19116" title="=&gt; Unit">open</a>; <a href="#31816" title="=&gt; Unit">getNext</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="31813">close</a> = <a href="#31807" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="31814">hasNext</a> = <span class="delimiter">(</span><a href="#31810" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="31815">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31828">ret</a> = <a href="#31810" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#31816" title="=&gt; Unit">getNext</a>
          <a href="#31828" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="31816">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#31807" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#31831" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31832">childTuple</a> = <a href="#31807" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="31833">boundKey</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31631" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#31632" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#31832" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="31834">value</a> = <a href="#31631" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#31833" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#31834" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#31810" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#31832" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#31834" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span> <span class="comment">//TODO: Why does it return the boundKey???</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#31810" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="32217">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="32218">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="32219">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="32220">limit</a>, <a title="Boolean" id="32221">ascending</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="32222">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// TODO: Unifty this iterator and ParallelIndexMergeJoin, since a lot of</span>
      <span class="comment">// code is repeated</span>
      <a href="#32223" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="32223">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="32394">name</a> = <span title="java.lang.String(&quot;SimpleIndexMergeJoin&quot;)" class="string">&quot;SimpleIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="32396">childIterator</a> = <a href="#29533" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#32222" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="32398">boundLimit</a> = <a href="#19137" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#32220" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/**(key, child tup, offset, limit reached?) */</span>
        <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="32401">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="32404">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[Int]" id="32407">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="32410">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="32412">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#32396" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19116" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="32509">tupleDatum</a> = <a href="#32396" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="32514">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="32515">boundKeyPrefix</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#32217" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#32218" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#32514" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="32516">records</a> = <a href="#32217" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="32550">getRange</a><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="32546">boundKeyPrefix</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="32547">boundKeyPrefix</a>, limit = <a href="#29530" title="Option[Int]" id="32548">boundLimit</a>, ascending = <a href="#32221" title="Boolean" id="32549">ascending</a><span class="delimiter">)</span>
            <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#32515" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#32516" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="32517">recIdxSeq</a> = <a href="#32516" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="32571">r</a> =&gt; <a href="#32514" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#32571" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#32515" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#32514" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#32516" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#32516" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#32398" title="=&gt; Int">boundLimit</a>, <a href="#32517" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#32401" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#32509" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="32833">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#32833" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#32833" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#32833" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#32833" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#32404" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#32509" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#33240" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#32407" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#32404" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#32418" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="32413">close</a>: <span title="Unit">Unit</span> = <a href="#32396" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="32414">hasNext</a> = <span class="delimiter">(</span><a href="#32410" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="32415">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#32414" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="32424">ret</a> = <a href="#32410" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#32418" title="=&gt; Unit">getNext</a>
          <a href="#32424" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="32416">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="33842">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#33844" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#33843" title="edu.berkeley.cs.scads.piql.package.Record" id="33844">key</a>, <a href="#33843" title="edu.berkeley.cs.scads.piql.package.Tuple" id="33845">tup</a>, <a href="#33843" title="Int" id="33846">offset</a>, <a href="#33843" title="Boolean" id="33847">limitReached</a><span class="delimiter">)</span> = <a href="#32401" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#33842" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#33847" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="33848">records</a> = <a href="#32217" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="33896">key</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="33897">key</a>, offset = <a href="#29530" title="Option[Int]" id="33898">offset</a>, limit = <a href="#29530" title="Option[Int]" id="33899">boundLimit</a>, ascending = <a href="#32221" title="Boolean" id="33900">ascending</a><span class="delimiter">)</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#33844" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#33848" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#32404" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#33842" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#33848" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="33967">r</a> =&gt; <a href="#33845" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#33967" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#32401" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#33842" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#33844" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#33845" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#33846" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#33848" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#33848" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#32398" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="32417">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="34087">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#32401" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#34087" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="32418">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="34089">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="34090">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#34089" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#34090" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#32404" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#34091" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34090" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#34090" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#32417" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#34090" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#32416" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#34090" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34090" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#34090" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#34089" title="Int">minIdx</a> = <a href="#34090" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#34090" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34089" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#32410" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="34865">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#34089" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#32404" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#32417" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#32416" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><a href="#32221" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#19139" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#34089" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34089" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#32219" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#32221" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#19139" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34865" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#34089" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34089" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#32219" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#34089" title="Int">minIdx</a> = <a href="#34865" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#32410" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#32404" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#34089" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#32407" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#34089" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#32407" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#34089" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">LocalSelection</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Predicate" id="34964">predicate</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="34965">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#34966" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="34966">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="35137">name</a> = <span title="java.lang.String(&quot;Selection&quot;)" class="string">&quot;Selection&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="35139">childIterator</a> = <a href="#29533" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#34965" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="35142">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="35144">open</a> = <span class="delimiter">{</span>
          <a href="#35139" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19116" title="=&gt; Unit">open</a>; <a href="#35148" title="=&gt; Unit">getNext</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="35145">close</a> = <a href="#35139" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="35146">hasNext</a> = <span class="delimiter">(</span><a href="#35142" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="35147">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="35160">ret</a> = <a href="#35142" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#35148" title="=&gt; Unit">getNext</a>
          <a href="#35160" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="35148">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#35139" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#35163" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="35164">childValue</a> = <a href="#35139" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#19138" title="(predicate: edu.berkeley.cs.scads.piql.plans.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Boolean">evalPredicate</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#34964" title="edu.berkeley.cs.scads.piql.plans.Predicate">predicate</a>, <a href="#35164" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#35142" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#35164" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#35142" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">LocalStopAfter</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Limit" id="35195">k</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="35196">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#35197" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="35197">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="35368">name</a> = <span title="java.lang.String(&quot;StopAfter&quot;)" class="string">&quot;StopAfter&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="35370">childIterator</a> = <a href="#29533" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#35196" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="35372">limit</a> = <a href="#19137" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#35195" title="edu.berkeley.cs.scads.piql.plans.Limit">k</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="35375">taken</a> = <span title="Int(0)" class="int">0</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="35377">open</a> = <span class="delimiter">{</span>
          <a href="#35375" title="(x$1: Int)Unit">taken</a> = <span title="Int(0)" class="int">0</span>; <a href="#35370" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19116" title="=&gt; Unit">open</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="35378">close</a> = <span class="delimiter">{</span>
          <a href="#35370" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="35379">hasNext</a> = <a href="#35370" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#35372" title="=&gt; Int">limit</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#35375" title="=&gt; Int">taken</a><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="35380">next</a> = <span class="delimiter">{</span>
          <a href="#35375" title="(x$1: Int)Unit">taken</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>; <a href="#35370" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">LocalIterator</span><span class="delimiter">(</span><a title="Int" id="35429">ordinal</a>, <a title="Boolean" id="35430">wrap</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#35431" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="35431">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="35602">name</a> = <span title="java.lang.String(&quot;LocalIterator&quot;)" class="string">&quot;LocalIterator&quot;</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" id="35605">delegate</a>: <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="35607">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#35605" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> =
            <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" class="keyword">if</span> <span class="delimiter">(</span><a href="#35430" title="Boolean">wrap</a><span class="delimiter">)</span> <span class="comment">//This is kinda gross... I'm sorry.</span>
              <a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#19379" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#35429" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="(f: Any =&gt; scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec]]])Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec]]]" class="delimiter">(</span><a title="Any" id="35639">i</a> =&gt; <span title="(elems: edu.berkeley.cs.scads.storage.StringRec*)scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec]">Vector</span><span class="delimiter">(</span>storage.<span title="(f1: String)edu.berkeley.cs.scads.storage.StringRec">StringRec</span><span class="delimiter">(</span><a href="#35639" title="Any">i</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="String" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Iterator[scala.collection.immutable.Vector[edu.berkeley.cs.scads.storage.StringRec]]">toIterator</span>
            <span class="keyword">else</span>
              <a href="#29542" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#19379" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#35429" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]" class="delimiter">[</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]">Seq</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">toIterator</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="35608">close</a>: <span title="Unit">Unit</span> = <a href="#35605" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="35609">hasNext</a> = <a href="#35605" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="=&gt; Boolean">hasNext</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="35610">next</a> = <a href="#35605" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">Union</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="36913">chil1</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="36914">child2</a>, <a title="edu.berkeley.cs.scads.piql.plans.AttributeValue" id="36915">eqField</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not yet implemented&quot;)" class="string">&quot;Not yet implemented&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * The parallel executor issues all requests to the key/value store in parallel.
 * TODO: Should abstract out the common parts between the query iterators.
 */</span>
<span class="keyword">class</span> <a title="class ParallelExecutor extends edu.berkeley.cs.scads.piql.exec.SimpleExecutor with ScalaObject" id="9525">ParallelExecutor</a> <a href="#9525" title="ScalaObject" class="keyword">extends</a> <a href="#9524" title="edu.berkeley.cs.scads.piql.exec.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="36921">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="36923">plan</a>: <a href="QueryPlan.scala.html#9628" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="36924">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#36923" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="36927">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="36928">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#36929" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="36929">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37100">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookup&quot;)" class="string">&quot;ParallelIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="37102">boundKey</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#36927" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#36928" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]" id="37105">ftch</a>: <span title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">Option</span><span class="delimiter">[</span>ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37107">open</a>: <span title="Unit">Unit</span> =
          <a href="#37105" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="(x: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])Some[edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]]">Some</span><span class="delimiter">(</span><a href="#36927" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#37102" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37108">close</a>: <span title="Unit">Unit</span> =
          <a href="#37105" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37109">hasNext</a> =
          <a href="#37105" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#37128" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="37110">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="37548">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#37105" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#37554" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Empty iterator&quot;)" class="string">&quot;Empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#37105" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>
          <a href="#37548" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="37569">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="37570">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="37571">limit</a>, <a title="Boolean" id="37572">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37573" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="37573">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37744">name</a> = <span title="java.lang.String(&quot;ParallelIndexScan&quot;)" class="string">&quot;ParallelIndexScan&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="37746">boundKeyPrefix</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37569" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#37570" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="37749">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="37752">ftch</a>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span> = _

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="37755">pos</a> = <span title="Int(0)" class="int">0</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="37758">offset</a> = <span title="Int(0)" class="int">0</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="37761">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="37763">boundLimit</a> = <a href="#19137" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37571" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span> <span class="comment">// should get rid of 2nd getRange</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="37766">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>

        @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37768">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#37746" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
          <a href="#37752" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <a href="#37569" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">asyncGetRange</span><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="37854">boundKeyPrefix</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="37855">boundKeyPrefix</a>, offset = <a href="#29530" title="Option[Int]" id="37856">offset</a>, limit = <a href="#29530" title="Option[Int]" id="37857">boundLimit</a>, ascending = <a href="#37572" title="Boolean" id="37858">ascending</a><span class="delimiter">)</span>
          <a href="#37766" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37769">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#37749" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#37752" title="=&gt; edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#37749" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#37758" title="=&gt; Int">offset</a>, <a href="#37763" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
          <a href="#37758" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#37749" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
          <a href="#37755" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#37749" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#37763" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#37761" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
          <a href="#37766" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37770">open</a>: <span title="Unit">Unit</span> = <a href="#37768" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37771">close</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#37749" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>
          <a href="#37752" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37772">hasNext</a> =
          <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#37766" title="=&gt; Boolean">ftchInvoked</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// have we already blocked on ftch and stored the result in result?</span>
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#37755" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#37749" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#37761" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
              <span class="comment">// need to fetch more from KV store to see if we really have more</span>
              <a href="#37768" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#37772" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#37769" title="()Unit">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#37772" title="=&gt; Boolean">hasNext</a>
          <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="37773">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#37772" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="37779">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#37749" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#37755" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#37755" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <a href="#37779" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="37875">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="37876">key</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="37877">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37878" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="37878">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="38049">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookupJoin&quot;)" class="string">&quot;ParallelIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="38051">childIterator</a> = <a href="#36921" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37877" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="38054">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" id="38056">ftchs</a> = <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" class="keyword">new</span> <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">Queue</span><span class="delimiter">[</span><span class="delimiter">(</span>Tuple, Record, ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="38058">windowSize</a> = <span title="Int(10)" class="int">10</span> <span class="comment">// keep 10 outstanding ftchs at a time</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="38060">open</a> = <span class="delimiter">{</span>
          <a href="#38051" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19116" title="=&gt; Unit">open</a>; <a href="#38064" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="38061">close</a> = <a href="#38051" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="38062">hasNext</a> = <span class="delimiter">(</span><a href="#38054" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>
          <span class="keyword">var</span> <a title="Boolean" id="38076">found</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#38076" title="Boolean">found</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#38056" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#38077" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a href="#38257" title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#38256" title="edu.berkeley.cs.scads.piql.package.Tuple" id="38257">childTuple</a>, <a href="#38256" title="edu.berkeley.cs.scads.piql.package.Record" id="38258">boundKey</a>, <a href="#38256" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]" id="38259">ftch</a><span class="delimiter">)</span> = <a href="#38056" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="()(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])">dequeue</span><span title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#38259" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Record" id="38294">recVal</a><span class="delimiter">)</span> =&gt;
                <a href="#38054" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#38257" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#38294" title="edu.berkeley.cs.scads.piql.package.Record">recVal</a><span class="delimiter">)</span>
                <a href="#38076" title="Boolean">found</a> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">// done</span>
              <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="comment">// keep going</span>
            <span class="delimiter">}</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#38056" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#38051" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <span class="comment">// need to get more records</span>
              <a href="#38064" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#38076" title="Boolean">found</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="38063">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#38062" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="38394">ret</a> = <a href="#38054" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#38054" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#38064" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#38394" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="38064">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#38051" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#38056" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#38058" title="=&gt; Int">windowSize</a><span class="delimiter">)</span> <a href="#38398" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="38408">childTuple</a> = <a href="#38051" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="38409">boundKey</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37875" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#37876" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#38408" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]" id="38410">valueFtch</a> = <a href="#37875" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#38409" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>
            <a href="#38056" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a> <span title="(elem: (edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]))this.ftchs.type">+=</span> <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Tuple, _2: edu.berkeley.cs.scads.piql.package.Key, _3: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#38408" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a>, <a href="#38409" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a>, <a href="#38410" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">valueFtch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="38428">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="38429">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="38430">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="38431">limit</a>, <a title="Boolean" id="38432">ascending</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="38433">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#38434" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="38434">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="38605">name</a> = <span title="java.lang.String(&quot;ParallelIndexMergeJoin&quot;)" class="string">&quot;ParallelIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="38607">childIterator</a> = <a href="#36921" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#38433" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="38609">boundLimit</a> = <a href="#19137" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#38431" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/**
         * (key, child tup, offset, limit reached?, outstanding ftch)
         */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]" id="38612">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Key, Tuple, Int, Boolean, ScadsFuture<span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="38615">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="38618">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="38621">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="38623">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#38607" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19116" title="=&gt; Unit">open</a>

          <a href="#38612" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])Unit">tupleData</a> = <a href="#38607" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="39073">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="39074">boundKeyPrefix</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#38428" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#38429" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#39073" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]" id="39075">ftch</a> = <a href="#38428" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="39108">asyncGetRange</a><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39104">boundKeyPrefix</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39105">boundKeyPrefix</a>, limit = <a href="#29530" title="Option[Int]" id="39106">boundLimit</a>, ascending = <a href="#38432" title="Boolean" id="39107">ascending</a><span class="delimiter">)</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#39074" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#39073" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <span title="Int(0)" class="int">0</span>, <span title="Boolean(false)" class="keyword">false</span>, <a href="#39075" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">ftch</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">toArray</span>

          <a href="#38615" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple])(implicit evidence$9: scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">fill</span><span class="delimiter">(</span><a href="#38612" title="(xs: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])scala.collection.mutable.ArrayOps[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleData</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="(clazz: java.lang.Class[_], arg1: scala.reflect.OptManifest[_], args: scala.reflect.OptManifest[_]*)scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" class="delimiter">(</span><span title="=&gt; collection.IndexedSeq.type">IndexedSeq</span>.<span title="IndexedSeq[Nothing]">empty</span><span class="delimiter">)</span>
          <a href="#38618" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#38615" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="38624">close</a>: <span title="Unit">Unit</span> = <a href="#38607" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="38625">hasNext</a> = <span class="delimiter">(</span><a href="#38621" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="38634">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="38635">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#38635" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#38615" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#38636" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38635" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#38635" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#38627" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#38635" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#38626" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#38635" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38635" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#38635" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#38634" title="Int">minIdx</a> = <a href="#38635" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#38635" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="38982">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#38615" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#38627" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#38626" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><a href="#38432" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#19139" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#38430" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#38432" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#19139" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38982" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#38430" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#38634" title="Int">minIdx</a> = <a href="#38982" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#38621" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#38618" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>

            <span class="comment">// do another fetch if we reach the end of minIdx's buffer- this</span>
            <span class="comment">// is unlike SimpleIndexMergeJoin which does not do another fetch</span>
            <span class="comment">// here.</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#38618" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#38615" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#38627" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#38626" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#38634" title="Int">minIdx</a><span class="delimiter">)</span>

            <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="38626">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="38757">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>

          <span class="keyword">val</span> <a href="#39659" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#39658" title="edu.berkeley.cs.scads.piql.package.Key" id="39659">key</a>, <a href="#39658" title="edu.berkeley.cs.scads.piql.package.Tuple" id="39660">tup</a>, <a href="#39658" title="Int" id="39661">offset</a>, <a href="#39658" title="Boolean" id="39662">limitReached</a>, <a href="#39658" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="39663">ftch</a><span class="delimiter">)</span> = <a href="#38612" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><a href="#38757" title="Int">i</a><span class="delimiter">)</span>

          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39662" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#39659" title="edu.berkeley.cs.scads.piql.package.Key">key</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39660" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39663" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39661" title="Int">offset</a> <span title="(x: Int)Boolean">!=</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="39664">records</a> = <a href="#39663" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#39659" title="edu.berkeley.cs.scads.piql.package.Key">key</a>, <a href="#39664" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a><span class="delimiter">)</span>

          <span class="comment">// TODO: is it slow to ++= append to an IndexedSeq??</span>
          <a href="#38615" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#38757" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#39664" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Record =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.package.Record],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#39660" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#39760" title="edu.berkeley.cs.scads.piql.package.Record">_</a><span class="delimiter">)</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#39664" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#38609" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// end of records in KV store</span>
            <a href="#38612" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]))Unit">tupleData</a><span class="delimiter">(</span><a href="#38757" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: Null, _2: Null, _3: Int, _4: Boolean, _5: Null)(Null, Null, Int, Boolean, Null)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span>, -<span title="Int(-1)" class="int">1</span>, <span title="Boolean(true)" class="keyword">true</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">// sentinel values</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="delimiter">{</span>
            <span class="comment">// still can ask for more records</span>
            <span class="comment">//val newOffset = records.size + offset</span>
            <span class="comment">//val newFtch = namespace.asyncGetRange(key, key, offset=newOffset, limit=boundLimit, ascending=ascending)</span>
            <span class="comment">//tupleData(i) = ((key, tup, newOffset, limitReached, newFtch))</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="38627">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="38755">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#38612" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span class="delimiter">(</span><a href="#38755" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="38628">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#38625" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="39056">ret</a> = <a href="#38621" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#38621" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#39056" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator">_</span> =&gt; <a href="#9525" title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">super</a>.<a href="#29533" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#36924" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#36923" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * The lazy executor retrieves tuples from the key/value store on demand, one at a time.
 */</span>
<span class="keyword">class</span> <a title="class LazyExecutor extends edu.berkeley.cs.scads.piql.exec.SimpleExecutor with ScalaObject" id="9526">LazyExecutor</a> <a href="#9526" title="ScalaObject" class="keyword">extends</a> <a href="#9524" title="edu.berkeley.cs.scads.piql.exec.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="39869">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="39871">plan</a>: <a href="QueryPlan.scala.html#9628" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="39872">ctx</a>: <a href="#42024" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9522" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#39871" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="39875">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="39876">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#39877" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="39877">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="40048">name</a> = <span title="java.lang.String(&quot;LazyIndexLookup&quot;)" class="string">&quot;LazyIndexLookup&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40050">boundKey</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#39875" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#39876" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="40053">accessed</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="40056">result</a> = <a href="#39875" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#40050" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40057">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40058">close</a> <span class="delimiter">{</span>
          <a href="#40053" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="40059">hasNext</a> = <a href="#40053" title="=&gt; Boolean">accessed</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Boolean" class="keyword">false</span> =&gt; <a href="#40055" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; Boolean">isDefined</span>
          <span class="keyword">case</span> <span title="Boolean(false)" class="keyword">true</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]" id="40060">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40059" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <a href="#40053" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span title="(elems: org.apache.avro.generic.IndexedRecord*)scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]">ArrayBuffer</span><span class="delimiter">(</span><a href="#40055" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="40068">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="40069">keyPrefix</a>, _, <a title="Boolean" id="40070">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// we don't care about limit here</span>
      <a href="#40071" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="40071">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="40242">name</a> = <span title="java.lang.String(&quot;LazyIndexScan&quot;)" class="string">&quot;LazyIndexScan&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40244">boundKeyPrefix</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40068" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#40069" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Record" id="40247">result</a>: <span title="edu.berkeley.cs.scads.piql.package.Record">Record</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="40250">offset</a> = <span title="Int(0)" class="int">0</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="40253">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>

        @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="40255">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#40244" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="40270">res</a> = <a href="#40068" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40317">boundKeyPrefix</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40318">boundKeyPrefix</a>, offset = <a href="#29530" title="Option[Int]" id="40319">offset</a>, limit = <a href="#29530" title="Option[Int]" id="40320" class="int">1</a>, ascending = <a href="#40070" title="Boolean" id="40321">ascending</a><span class="delimiter">)</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#40270" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>, <a href="#40250" title="=&gt; Int">offset</a>, <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
          <a href="#40250" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#40270" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Int">size</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40270" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#40253" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
            <a href="#40247" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#40247" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <a href="#40270" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">head</span>
          <span class="delimiter">}</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#40253" title="=&gt; Boolean">limitReached</a> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#40247" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40256">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40257">close</a> <span class="delimiter">{</span>
          <a href="#40247" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#40253" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="40258">hasNext</a> =
          <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#40247" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
          <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40253" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#40255" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#40258" title="=&gt; Boolean">hasNext</a>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Boolean(false)" class="keyword">false</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="40259">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40258" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="40260">ret</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#40247" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">)</span>
          <a href="#40247" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#40260" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ret</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="40332">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="40333">key</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="40334">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#40335" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="40335">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="40506">name</a> = <span title="java.lang.String(&quot;LazyIndexLookupJoin&quot;)" class="string">&quot;LazyIndexLookupJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="40508">childIterator</a> = <a href="#39869" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40334" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40511">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="40514">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40516">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40517">close</a> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40514" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <a href="#40514" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <a href="#40508" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="40518">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40514" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#40514" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
            <a href="#40520" title="=&gt; Unit">getNext</a>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#40511" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="40519">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40527">ret</a> = <a href="#40511" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#40520" title="=&gt; Unit">getNext</a>
          <a href="#40527" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="40520">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#40508" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#40536" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40537">childTuple</a> = <a href="#40508" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40538">boundKey</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40332" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#40333" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#40537" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="40539">value</a> = <a href="#40332" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#40538" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40539" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40511" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40537" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#40539" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#40511" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="40638">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="40639">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="40640">sortFields</a>, _, <a title="Boolean" id="40641">ascending</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="40642">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#40643" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9522" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="40643">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="40814">name</a> = <span title="java.lang.String(&quot;LazyIndexMergeJoin&quot;)" class="string">&quot;LazyIndexMergeJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="40816">childIterator</a> = <a href="#39869" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40642" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>

        <span class="comment">/**(key, child tup, offset, limit reached?) */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="40819">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="40822">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="40825">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40828">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="40831">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="40833">init</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#40816" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19116" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="40861">tupleDatum</a> = <a href="#40816" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40866">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40867">boundKeyPrefix</a> = <a href="#19136" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40638" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#40639" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#40866" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="40868">records</a> = <a href="#40638" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="40902">getRange</a><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40898">boundKeyPrefix</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40899">boundKeyPrefix</a>, limit = <a href="#29530" title="Option[Int]" id="40900" class="int">1</a>, ascending = <a href="#40641" title="Boolean" id="40901">ascending</a><span class="delimiter">)</span>
            <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#40867" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#40868" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="40869">recIdxSeq</a> = <a href="#40868" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#40866" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#40923" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#40867" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#40866" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#40868" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#40868" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span>, <a href="#40869" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#40819" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#40861" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="41073">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#41073" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#41073" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#41073" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#41073" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#40822" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#40861" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#41172" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#40825" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#40822" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#40840" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40834">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40835">close</a> <span class="delimiter">{</span>
          <a href="#40816" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#19117" title="=&gt; Unit">close</a>
          <a href="#40831" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="40836">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40831" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#40833" title="()Unit">init</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#40831" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#40828" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="40837">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40836" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40847">ret</a> = <a href="#40828" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#40840" title="=&gt; Unit">getNext</a>
          <a href="#40847" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="40838">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="41374">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#41376" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#41375" title="edu.berkeley.cs.scads.piql.package.Record" id="41376">key</a>, <a href="#41375" title="edu.berkeley.cs.scads.piql.package.Tuple" id="41377">tup</a>, <a href="#41375" title="Int" id="41378">offset</a>, <a href="#41375" title="Boolean" id="41379">limitReached</a><span class="delimiter">)</span> = <a href="#40819" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#41374" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41379" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="41380">records</a> = <a href="#40638" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="41427">key</a>, <a href="#29530" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="41428">key</a>, offset = <a href="#29530" title="Option[Int]" id="41429">offset</a>, limit = <a href="#29530" title="Option[Int]" id="41430" class="int">1</a>, ascending = <a href="#40641" title="Boolean" id="41431">ascending</a><span class="delimiter">)</span>
          <a href="#19131" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;</span>, <a href="#41376" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#41380" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#40822" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#41374" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#41380" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#41377" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#41480" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#40819" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#41374" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#41376" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#41377" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#41378" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#41380" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#41380" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="40839">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="41600">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#40819" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#41600" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="40840">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="41602">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="41603">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#41602" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41603" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#40822" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#41604" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41603" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#41603" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40839" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#41603" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40838" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#41603" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41603" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#41603" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#41602" title="Int">minIdx</a> = <a href="#41603" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#41603" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41602" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#40828" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="41947">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#41602" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#40822" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40839" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#40838" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><a href="#40641" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#19139" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#41602" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41602" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40640" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40641" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#19139" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41947" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#41602" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41602" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40640" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#41602" title="Int">minIdx</a> = <a href="#41947" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#40828" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40822" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#41602" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40825" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#41602" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#40825" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#41602" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator">_</span> =&gt; <a href="#9526" title="edu.berkeley.cs.scads.piql.exec.LazyExecutor" class="keyword">super</a>.<a href="#29533" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#39872" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#39871" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>