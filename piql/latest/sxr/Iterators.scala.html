<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Iterators.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads
<span class="keyword">package</span> piql

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.apache.avro.util.Utf8
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> comm.<span class="delimiter">{</span>ScadsFuture, StringRec<span class="delimiter">}</span>

<span class="keyword">import</span> java.<span class="delimiter">{</span> util =&gt; ju <span class="delimiter">}</span>
<span class="keyword">import</span> scala.collection.mutable.Queue
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer

case <span class="keyword">class</span> <a title="class Context extends java.lang.Object with ScalaObject with Product with Serializable" id="43635">Context</a><a href="#43635" title="ScalaObject" class="delimiter">(</a><a title="IndexedSeq[Any]" id="29331">parameters</a>: <span title="IndexedSeq[Any]">IndexedSeq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span>, <a title="Option[List[Any]]" id="29332">state</a>: <span title="Option[List[Any]]">Option</span><span class="delimiter">[</span>List<span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class QueryIterator extends java.lang.Object with Iterator[edu.berkeley.cs.scads.piql.package.Tuple] with ScalaObject" id="9524">QueryIterator</a> <a href="#9524" title="ScalaObject" class="keyword">extends</a> <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="=&gt; String" id="28847">name</a>: <span title="String">String</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="28848">open</a>: <span title="Unit">Unit</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="28849">close</a>: <span title="Unit">Unit</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QueryExecutor extends java.lang.Object with ScalaObject" id="9525">QueryExecutor</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="28595">logger</a> = <span title="(name: String)net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span title="java.lang.String(&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;)" class="string">&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan, args: Any*)edu.berkeley.cs.scads.piql.QueryIterator" id="28597">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="28615">plan</a>: <a href="QueryPlan.scala.html#9610" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a>, <a title="Any*" id="28616">args</a>: <span title="Any*">Any</span>*<span class="delimiter">)</span>: <a href="#9524" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#28598" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><span class="delimiter">(</span><a href="#28615" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#43635" title="(parameters: IndexedSeq[Any], state: Option[List[Any]])edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">(</span><a href="#28616" title="Any*">args</a>.<span title="scala.collection.immutable.IndexedSeq[Any]">toIndexedSeq</span>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="28598">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="28618">plan</a>: <a href="QueryPlan.scala.html#9610" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="28619">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9524" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any" id="28599">bindValue</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="29352">value</a>: <a href="QueryPlan.scala.html#9579" title="edu.berkeley.cs.scads.piql.Value">Value</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="29353">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="29354">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Any">Any</span> = <span class="delimiter">{</span>
    <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundValue: %s %s %s&quot;)" class="string">&quot;BoundValue: %s %s %s&quot;</span>, <a href="#29352" title="edu.berkeley.cs.scads.piql.Value">value</a>, <a href="#29353" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a>, <a href="#29354" title="edu.berkeley.cs.scads.piql.Context">ctx</a><span class="delimiter">)</span>
    <a href="#29352" title="edu.berkeley.cs.scads.piql.Value">value</a> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Any">ConstantValue</span><span class="delimiter">(</span><a title="Any" id="29378">v</a><span class="delimiter">)</span> =&gt; <a href="#29378" title="Any">v</a>
      <span class="keyword">case</span> <span title="Any">ParameterValue</span><span class="delimiter">(</span><a title="Int" id="29397">o</a><span class="delimiter">)</span> =&gt; <a href="#29354" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29331" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#29397" title="Int">o</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="java.lang.Object">AttributeValue</span><span class="delimiter">(</span><a title="Int" id="29468">recPos</a>, <a title="Int" id="29469">fieldPos</a><span class="delimiter">)</span> =&gt; <a href="#29353" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">currentTuple</a><span class="delimiter">(</span><a href="#29468" title="Int">recPos</a><span class="delimiter">)</span>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#29469" title="Int">fieldPos</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key" id="28600">bindKey</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="29489">ns</a>: <a href="package.scala.html#25139" title="edu.berkeley.cs.scads.piql.package.Namespace">Namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="29490">key</a>: <span title="edu.berkeley.cs.scads.piql.package.KeyGenerator">KeyGenerator</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="29494">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="29492">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.piql.package.Key">Key</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="29495">boundKey</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#29489" title="edu.berkeley.cs.scads.piql.package.Namespace">ns</a>.<span title="=&gt; org.apache.avro.Schema">keySchema</span><span class="delimiter">)</span>

    <a href="#29490" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>.<span title="(f: edu.berkeley.cs.scads.piql.Value =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.Value],Any,Seq[Any]])Seq[Any]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Any,Seq[Any]]" class="delimiter">(</span><a href="#28599" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#29492" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#29635" title="edu.berkeley.cs.scads.piql.Value">_</a>, <a href="#29494" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],(Any, Int),Seq[(Any, Int)]])Seq[(Any, Int)]">zipWithIndex</span>.<span title="(f: (Any, Int) =&gt; Unit)Unit">foreach</span> <a href="#31644" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="Any" id="31647">value</a>: <span title="Any">Any</span>, <a title="Int" id="31648">idx</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt; <a href="#29495" title="org.apache.avro.generic.GenericData.Record">boundKey</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#31648" title="Int">idx</a>, <a href="#31647" title="Any">value</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bound Key: %s&quot;)" class="string">&quot;Bound Key: %s&quot;</span>, <a href="#29495" title="org.apache.avro.generic.GenericData.Record">boundKey</a><span class="delimiter">)</span>
    <a href="#29495" title="org.apache.avro.generic.GenericData.Record">boundKey</a>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int" id="28601">bindLimit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Limit" id="31658">limit</a>: <a href="QueryPlan.scala.html#9593" title="edu.berkeley.cs.scads.piql.Limit">Limit</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="31659">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#31658" title="edu.berkeley.cs.scads.piql.Limit">limit</a> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int">FixedLimit</span><span class="delimiter">(</span><a title="Int" id="31689">l</a><span class="delimiter">)</span> =&gt; <a href="#31689" title="Int">l</a>
    <span class="keyword">case</span> <span title="Int">ParameterLimit</span><span class="delimiter">(</span><a title="Int" id="31727">lim</a>, <a title="Int" id="31728">max</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="31729">limitValue</a> = <a href="#31659" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29331" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#31727" title="Int">lim</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Int" class="delimiter">[</span><span title="Int">Int</span><span class="delimiter">]</span>
      <span class="comment">//if(limitValue &gt; max)</span>
      <span class="comment">//  throw new RuntimeException(&quot;Limit out of range&quot;)</span>
      <a href="#31729" title="Int">limitValue</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(predicate: edu.berkeley.cs.scads.piql.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Boolean" id="28602">evalPredicate</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Predicate" id="31737">predicate</a>: <a href="QueryPlan.scala.html#9600" title="edu.berkeley.cs.scads.piql.Predicate">Predicate</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31738">tuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="31739">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#31737" title="edu.berkeley.cs.scads.piql.Predicate">predicate</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Boolean">EqualityPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="31778">v1</a>, <a title="edu.berkeley.cs.scads.piql.Value" id="31779">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#28604" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#28599" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31739" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31778" title="edu.berkeley.cs.scads.piql.Value">v1</a>, <a href="#31738" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>, <a href="#28599" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31739" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31779" title="edu.berkeley.cs.scads.piql.Value">v2</a>, <a href="#31738" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">InPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="31825">v1</a>, <a title="edu.berkeley.cs.scads.piql.Value" id="31826">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[Any]" id="31827">valueList</a> = <a href="#28599" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31739" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31826" title="edu.berkeley.cs.scads.piql.Value">v2</a>, <a href="#31738" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="keyword">val</span> <a title="Any" id="31828">boundValue</a> = <a href="#28599" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31739" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31825" title="edu.berkeley.cs.scads.piql.Value">v1</a>, <a href="#31738" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>
      <a href="#31827" title="Seq[Any]">valueList</a>.<span title="(f: Any =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Any" id="31850">v</a> =&gt; <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#28604" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#31850" title="Any">v</a>,<a href="#31828" title="Any">boundValue</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Nothing" class="keyword">return</span> <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int" id="28603">compareTuples</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31857">left</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31858">right</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="31859">attributes</a>: <span title="Seq[edu.berkeley.cs.scads.piql.Value]">Seq</span><span class="delimiter">[</span>Value<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="31860">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <a href="#31859" title="Seq[edu.berkeley.cs.scads.piql.Value]">attributes</a>.<span title="(f: edu.berkeley.cs.scads.piql.Value =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Value" id="31878">a</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Any" id="31879">leftValue</a> = <a href="#28599" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31860" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31878" title="edu.berkeley.cs.scads.piql.Value">a</a>, <a href="#31857" title="edu.berkeley.cs.scads.piql.package.Tuple">left</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Any" id="31880">rightValue</a> = <a href="#28599" title="(value: edu.berkeley.cs.scads.piql.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Any">bindValue</a><a href="#31860" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#31878" title="edu.berkeley.cs.scads.piql.Value">a</a>, <a href="#31858" title="edu.berkeley.cs.scads.piql.package.Tuple">right</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Int" id="31881">comparison</a> = <a href="#28604" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#31879" title="Any">leftValue</a>, <a href="#31880" title="Any">rightValue</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#31881" title="Int">comparison</a> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span> <a href="#31881" title="Int">comparison</a>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span title="Nothing" class="keyword">return</span> <span title="Int(0)" class="int">0</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: Any, right: Any)Int" id="28604">compareAny</a><span class="delimiter">(</span><a title="Any" id="31780">left</a>: <span title="Any">Any</span>, <a title="Any" id="31781">right</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Any, _2: Any)(Any, Any)" class="delimiter">(</span><a href="#31780" title="Any">left</a>, <a href="#31781" title="Any">right</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="Integer" id="31895">l</a>: <span title="Integer">Integer</span>, <a title="Integer" id="31896">r</a>: <span title="Integer">Integer</span><span class="delimiter">)</span> =&gt; <a href="#31895" title="Integer">l</a>.<span title="()Int">intValue</span> <span title="(x: Int)Int">-</span> <a href="#31896" title="Integer">r</a>.<span title="()Int">intValue</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="31903">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="org.apache.avro.util.Utf8" id="31935">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#31903" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#31935" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="String" id="31967">l</a>: <span title="String">String</span>, <a title="org.apache.avro.util.Utf8" id="31968">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#31967" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">l</a> <span title="(other: String)Int">compare</span> <a href="#31968" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="32061">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="String" id="32062">r</a>: <span title="String">String</span><span class="delimiter">)</span> =&gt; <a href="#32061" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#32062" title="String">r</a>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class SimpleExecutor extends java.lang.Object with edu.berkeley.cs.scads.piql.QueryExecutor with ScalaObject" id="9526">SimpleExecutor</a> <a href="#9526" title="ScalaObject" class="keyword">extends</a> <a href="#9525" title="edu.berkeley.cs.scads.piql.QueryExecutor">QueryExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="32087">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="32089">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="32092">a</a>: <a href="#32089" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#32092" title="A">a</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="32090">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="32098">plan</a>: <a href="QueryPlan.scala.html#9610" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="32099">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9524" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#32098" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="32147">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="32148">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#32149" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="32149">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="32938">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookup&quot;)" class="string">&quot;SimpleIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="32940">boundKey</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#32147" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#32148" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="32943">result</a>: <span title="Option[edu.berkeley.cs.scads.piql.package.Record]">Option</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="32945">open</a>: <span title="Unit">Unit</span> =
          <a href="#32943" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#32147" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#32940" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="32946">close</a>: <span title="Unit">Unit</span> =
          <a href="#32943" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="32947">hasNext</a> = <a href="#32943" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Boolean">isDefined</span>
        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="32948">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="32949">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#32943" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#32943" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>
          <a href="#32949" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="33368">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="33369">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="33370">limit</a>, <a title="Boolean" id="33371">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#33372" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="33372">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="33543">name</a> = <span title="java.lang.String(&quot;SimpleIndexScan&quot;)" class="string">&quot;SimpleIndexScan&quot;</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="33545">boundKeyPrefix</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33368" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#33369" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="33548">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="33551">pos</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="33554">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="33557">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="33559">boundLimit</a> = <a href="#28601" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33370" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="33561">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#33545" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <a href="#33548" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#33368" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="33720">boundKeyPrefix</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="33721">boundKeyPrefix</a>, offset=<a href="#32087" title="Option[Int]" id="33722">offset</a>, limit=<a href="#32087" title="Option[Int]" id="33723">boundLimit</a>, ascending=<a href="#33371" title="Boolean" id="33724">ascending</a><span class="delimiter">)</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#33548" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#33554" title="=&gt; Int">offset</a>, <a href="#33559" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#33554" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#33548" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
            <a href="#33551" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#33548" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#33559" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
              <a href="#33557" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="33562">open</a>: <span title="Unit">Unit</span> = <a href="#33561" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="33563">close</a>: <span title="Unit">Unit</span> =
            <a href="#33548" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="33564">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#33551" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#33548" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#33557" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
              <span class="comment">// need to fetch more from KV store to see if we really have more</span>
              <a href="#33561" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#33564" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="33565">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#33564" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="33579">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#33548" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#33551" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#33551" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <a href="#33579" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="33817">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="33818">key</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="33819">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#33820" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="33820">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="33991">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookupJoin&quot;)" class="string">&quot;SimpleIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="33993">childIterator</a> = <a href="#32090" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33819" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="33996">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="33998">open</a> = <span class="delimiter">{</span><a href="#33993" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28848" title="=&gt; Unit">open</a>; <a href="#34002" title="=&gt; Unit">getNext</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="33999">close</a> = <a href="#33993" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="34000">hasNext</a> = <span class="delimiter">(</span><a href="#33996" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="34001">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34014">ret</a> = <a href="#33996" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#34002" title="=&gt; Unit">getNext</a>
          <a href="#34014" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="34002">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#33993" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#34017" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34018">childTuple</a> = <a href="#33993" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="34019">boundKey</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#33817" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#33818" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#34018" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="34020">value</a> = <a href="#33817" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#34019" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#34020" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#33996" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#34018" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#34020" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>    <span class="comment">//TODO: Why does it return the boundKey???</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#33996" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="34520">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="34521">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="34522">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="34523">limit</a>, <a title="Boolean" id="34524">ascending</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="34525">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// TODO: Unifty this iterator and ParallelIndexMergeJoin, since a lot of</span>
      <span class="comment">// code is repeated</span>
      <a href="#34526" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="34526">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="34697">name</a> = <span title="java.lang.String(&quot;SimpleIndexMergeJoin&quot;)" class="string">&quot;SimpleIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="34699">childIterator</a> = <a href="#32090" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34525" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="34701">boundLimit</a> = <a href="#28601" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34523" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/** (key, child tup, offset, limit reached?) */</span>
        <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="34704">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="34707">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[Int]" id="34710">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34713">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="34715">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#34699" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28848" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="34741">tupleDatum</a> = <a href="#34699" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34746">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="34747">boundKeyPrefix</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34520" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#34521" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#34746" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="34748">records</a> = <a href="#34520" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="34782">getRange</a><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="34778">boundKeyPrefix</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="34779">boundKeyPrefix</a>, limit=<a href="#32087" title="Option[Int]" id="34780">boundLimit</a>, ascending=<a href="#34524" title="Boolean" id="34781">ascending</a><span class="delimiter">)</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#34747" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#34748" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="34749">recIdxSeq</a> = <a href="#34748" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="34803">r</a> =&gt; <a href="#34746" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#34803" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#34747" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#34746" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#34748" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#34748" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34701" title="=&gt; Int">boundLimit</a>, <a href="#34749" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#34704" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#34741" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="35065">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#35065" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#35065" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#35065" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#35065" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#34707" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#34741" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#35452" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#34710" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#34707" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#34721" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="34716">close</a>: <span title="Unit">Unit</span> = <a href="#34699" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="34717">hasNext</a> = <span class="delimiter">(</span><a href="#34713" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="34718">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#34717" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34727">ret</a> = <a href="#34713" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#34721" title="=&gt; Unit">getNext</a>
          <a href="#34727" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="34719">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="36040">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#36042" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#36041" title="edu.berkeley.cs.scads.piql.package.Record" id="36042">key</a>, <a href="#36041" title="edu.berkeley.cs.scads.piql.package.Tuple" id="36043">tup</a>, <a href="#36041" title="Int" id="36044">offset</a>, <a href="#36041" title="Boolean" id="36045">limitReached</a><span class="delimiter">)</span> = <a href="#34704" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#36040" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#36045" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="36046">records</a> = <a href="#34520" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="36094">key</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="36095">key</a>, offset=<a href="#32087" title="Option[Int]" id="36096">offset</a>, limit=<a href="#32087" title="Option[Int]" id="36097">boundLimit</a>, ascending=<a href="#34524" title="Boolean" id="36098">ascending</a><span class="delimiter">)</span>
          <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#36042" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#36046" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#34707" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#36040" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#36046" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="36162">r</a> =&gt; <a href="#36043" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#36162" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#34704" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#36040" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#36042" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#36043" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#36044" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#36046" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#36046" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34701" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="34720">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="36282">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#34704" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#36282" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="34721">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="36284">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="36285">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#36284" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#36285" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#34707" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#36286" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36285" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#36285" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#34720" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#36285" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#34719" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#36285" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36285" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#36285" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#36284" title="Int">minIdx</a> = <a href="#36285" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#36285" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#36284" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#34713" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="37060">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#36284" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#34707" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#34720" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#34719" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#34524" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28603" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36284" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36284" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34522" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#34524" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28603" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37060" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36284" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36284" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34522" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#36284" title="Int">minIdx</a> = <a href="#37060" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#34713" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#34707" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36284" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34710" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36284" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#34710" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#36284" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">LocalSelection</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Predicate" id="37166">predicate</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="37167">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37168" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="37168">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37339">name</a> = <span title="java.lang.String(&quot;Selection&quot;)" class="string">&quot;Selection&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="37341">childIterator</a> = <a href="#32090" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37167" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37344">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37346">open</a> = <span class="delimiter">{</span><a href="#37341" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28848" title="=&gt; Unit">open</a>; <a href="#37350" title="=&gt; Unit">getNext</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="37347">close</a> = <a href="#37341" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37348">hasNext</a> = <span class="delimiter">(</span><a href="#37344" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37349">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37362">ret</a> = <a href="#37344" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#37350" title="=&gt; Unit">getNext</a>
          <a href="#37362" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="37350">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#37341" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#37365" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37366">childValue</a> = <a href="#37341" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#28602" title="(predicate: edu.berkeley.cs.scads.piql.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Boolean">evalPredicate</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37166" title="edu.berkeley.cs.scads.piql.Predicate">predicate</a>, <a href="#37366" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#37344" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#37366" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#37344" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">LocalStopAfter</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.Limit" id="37404">k</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="37405">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37406" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="37406">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37577">name</a> = <span title="java.lang.String(&quot;StopAfter&quot;)" class="string">&quot;StopAfter&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="37579">childIterator</a> = <a href="#32090" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37405" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="37581">limit</a> = <a href="#28601" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#32099" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#37404" title="edu.berkeley.cs.scads.piql.Limit">k</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="37584">taken</a> = <span title="Int(0)" class="int">0</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37586">open</a> = <span class="delimiter">{</span><a href="#37584" title="(x$1: Int)Unit">taken</a> = <span title="Int(0)" class="int">0</span>; <a href="#37579" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28848" title="=&gt; Unit">open</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="37587">close</a> = <span class="delimiter">{</span><a href="#37579" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37588">hasNext</a> = <a href="#37579" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#37581" title="=&gt; Int">limit</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#37584" title="=&gt; Int">taken</a><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37589">next</a> = <span class="delimiter">{</span><a href="#37584" title="(x$1: Int)Unit">taken</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>; <a href="#37579" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span><span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">LocalIterator</span><span class="delimiter">(</span><a title="Int" id="37644">ordinal</a>, <a title="Boolean" id="37645">wrap</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37646" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="37646">QueryIterator</a> <span class="delimiter">{</span>
	<span class="keyword">val</span> <a title="java.lang.String" id="37817">name</a> = <span title="java.lang.String(&quot;LocalIterator&quot;)" class="string">&quot;LocalIterator&quot;</span>
	<span class="keyword">private</span> <span class="keyword">var</span> <a title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" id="37820">delegate</a>: <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="37822">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
	  <a href="#37820" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> = 
	    <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" class="keyword">if</span><span class="delimiter">(</span><a href="#37645" title="Boolean">wrap</a><span class="delimiter">)</span> <span class="comment">//This is kinda gross... I'm sorry.</span>
	      <a href="#32099" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29331" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#37644" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="(f: Any =&gt; scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]])Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]]" class="delimiter">(</span><a title="Any" id="37854">i</a> =&gt; <span title="(elems: edu.berkeley.cs.scads.comm.StringRec*)scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]">Vector</span><span class="delimiter">(</span><span title="(f1: String)edu.berkeley.cs.scads.comm.StringRec">StringRec</span><span class="delimiter">(</span><a href="#37854" title="Any">i</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="String" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Iterator[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]">toIterator</span>
	    <span class="keyword">else</span>
	      <a href="#32099" title="edu.berkeley.cs.scads.piql.Context">ctx</a>.<a href="#29331" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#37644" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]" class="delimiter">[</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]">Seq</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">toIterator</span>
	<span class="delimiter">}</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="37823">close</a>: <span title="Unit">Unit</span> = <a href="#37820" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> = <span title="Null(null)" class="keyword">null</span>
	<span class="keyword">def</span> <a title="=&gt; Boolean" id="37824">hasNext</a> = <a href="#37820" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="=&gt; Boolean">hasNext</span>
	<span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37825">next</a> = <a href="#37820" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">Union</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="38678">chil1</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="38679">child2</a>, <a title="edu.berkeley.cs.scads.piql.AttributeValue" id="38680">eqField</a><span class="delimiter">)</span>  =&gt;<span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not yet implemented&quot;)" class="string">&quot;Not yet implemented&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * TODO: Should abstract out the common parts between the query iterators.
 */</span>
<span class="keyword">class</span> <a title="class ParallelExecutor extends edu.berkeley.cs.scads.piql.SimpleExecutor with ScalaObject" id="9527">ParallelExecutor</a> <a href="#9527" title="ScalaObject" class="keyword">extends</a> <a href="#9526" title="edu.berkeley.cs.scads.piql.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="38686">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="38688">plan</a>: <a href="QueryPlan.scala.html#9610" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="38689">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9524" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#38688" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="38692">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="38693">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#38694" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="38694">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="38865">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookup&quot;)" class="string">&quot;ParallelIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="38867">boundKey</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#38692" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#38693" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]" id="38870">ftch</a>: <span title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">Option</span><span class="delimiter">[</span>ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="38872">open</a>: <span title="Unit">Unit</span> =
          <a href="#38870" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="(x: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])Some[edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]]">Some</span><span class="delimiter">(</span><a href="#38692" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#38867" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="38873">close</a>: <span title="Unit">Unit</span> =
          <a href="#38870" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="38874">hasNext</a> =
          <a href="#38870" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#38893" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="38875">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39313">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#38870" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#39319" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Empty iterator&quot;)" class="string">&quot;Empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#38870" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>
          <a href="#39313" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="39334">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="39335">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="39336">limit</a>, <a title="Boolean" id="39337">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#39338" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="39338">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="39509">name</a> = <span title="java.lang.String(&quot;ParallelIndexScan&quot;)" class="string">&quot;ParallelIndexScan&quot;</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="39511">boundKeyPrefix</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39334" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#39335" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="39514">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="39517">ftch</a>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span> = _

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="39520">pos</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="39523">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="39526">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="39528">boundLimit</a> = <a href="#28601" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39336" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span> <span class="comment">// should get rid of 2nd getRange</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="39531">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39533">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#39511" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <a href="#39517" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <a href="#39334" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">asyncGetRange</span><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39619">boundKeyPrefix</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39620">boundKeyPrefix</a>, offset=<a href="#32087" title="Option[Int]" id="39621">offset</a>, limit=<a href="#32087" title="Option[Int]" id="39622">boundLimit</a>, ascending=<a href="#39337" title="Boolean" id="39623">ascending</a><span class="delimiter">)</span>
            <a href="#39531" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39534">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#39514" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#39517" title="=&gt; edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#39514" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#39523" title="=&gt; Int">offset</a>, <a href="#39528" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#39523" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#39514" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
            <a href="#39520" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#39514" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#39528" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
              <a href="#39526" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
            <a href="#39531" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="39535">open</a>: <span title="Unit">Unit</span> = <a href="#39533" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="39536">close</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
            <a href="#39514" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>
            <a href="#39517" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="39537">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39531" title="=&gt; Boolean">ftchInvoked</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// have we already blocked on ftch and stored the result in result?</span>
              <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39520" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#39514" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
              <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39526" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
              <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="comment">// need to fetch more from KV store to see if we really have more</span>
                <a href="#39533" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
                <a href="#39537" title="=&gt; Boolean">hasNext</a>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <a href="#39534" title="()Unit">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#39537" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39538">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39537" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39544">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#39514" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#39520" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#39520" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <a href="#39544" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="39640">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="39641">key</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="39642">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#39643" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="39643">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="39814">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookupJoin&quot;)" class="string">&quot;ParallelIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="39816">childIterator</a> = <a href="#38686" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39642" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="39819">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" id="39821">ftchs</a> = <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" class="keyword">new</span> <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">Queue</span><span class="delimiter">[</span><span class="delimiter">(</span>Tuple, Record, ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="39823">windowSize</a> = <span title="Int(10)" class="int">10</span> <span class="comment">// keep 10 outstanding ftchs at a time</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="39825">open</a> = <span class="delimiter">{</span><a href="#39816" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28848" title="=&gt; Unit">open</a>; <a href="#39829" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="39826">close</a> = <a href="#39816" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="39827">hasNext</a> = <span class="delimiter">(</span><a href="#39819" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>
          <span class="keyword">var</span> <a title="Boolean" id="39841">found</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39841" title="Boolean">found</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#39821" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#39842" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a href="#40022" title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#40021" title="edu.berkeley.cs.scads.piql.package.Tuple" id="40022">childTuple</a>, <a href="#40021" title="edu.berkeley.cs.scads.piql.package.Record" id="40023">boundKey</a>, <a href="#40021" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]" id="40024">ftch</a><span class="delimiter">)</span> = <a href="#39821" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="()(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])">dequeue</span><span title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#40024" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Record" id="40043">recVal</a><span class="delimiter">)</span> =&gt;
                <a href="#39819" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40022" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#40043" title="edu.berkeley.cs.scads.piql.package.Record">recVal</a><span class="delimiter">)</span>
                <a href="#39841" title="Boolean">found</a> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">// done</span>
              <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="comment">// keep going</span>
            <span class="delimiter">}</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#39821" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39816" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <span class="comment">// need to get more records</span>
              <a href="#39829" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#39841" title="Boolean">found</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="39828">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39827" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40143">ret</a> = <a href="#39819" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#39819" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#39829" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#40143" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39829">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#39816" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39821" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#39823" title="=&gt; Int">windowSize</a><span class="delimiter">)</span> <a href="#40147" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40157">childTuple</a> = <a href="#39816" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40158">boundKey</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#39640" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#39641" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#40157" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]" id="40159">valueFtch</a> = <a href="#39640" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#40158" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>
            <a href="#39821" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a> <span title="(elem: (edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]))this.ftchs.type">+=</span> <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Tuple, _2: edu.berkeley.cs.scads.piql.package.Key, _3: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#40157" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a>, <a href="#40158" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a>, <a href="#40159" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">valueFtch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="40177">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="40178">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="40179">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.Limit" id="40180">limit</a>, <a title="Boolean" id="40181">ascending</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="40182">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#40183" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="40183">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="40354">name</a> = <span title="java.lang.String(&quot;ParallelIndexMergeJoin&quot;)" class="string">&quot;ParallelIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="40356">childIterator</a> = <a href="#38686" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40182" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="40358">boundLimit</a> = <a href="#28601" title="(limit: edu.berkeley.cs.scads.piql.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">bindLimit</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40180" title="edu.berkeley.cs.scads.piql.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/**
         * (key, child tup, offset, limit reached?, outstanding ftch)
         */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]" id="40361">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Key, Tuple, Int, Boolean, ScadsFuture<span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="40364">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="40367">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40370">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40372">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#40356" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28848" title="=&gt; Unit">open</a>

          <a href="#40361" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])Unit">tupleData</a> = <a href="#40356" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40822">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40823">boundKeyPrefix</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40177" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#40178" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#40822" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]" id="40824">ftch</a> = <a href="#40177" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="40857">asyncGetRange</a><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40853">boundKeyPrefix</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40854">boundKeyPrefix</a>, limit=<a href="#32087" title="Option[Int]" id="40855">boundLimit</a>, ascending=<a href="#40181" title="Boolean" id="40856">ascending</a><span class="delimiter">)</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#40823" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#40822" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <span title="Int(0)" class="int">0</span>, <span title="Boolean(false)" class="keyword">false</span>, <a href="#40824" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">ftch</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">toArray</span>

          <a href="#40364" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple])(implicit evidence$9: scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">fill</span><span class="delimiter">(</span><a href="#40361" title="(xs: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])scala.collection.mutable.ArrayOps[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleData</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="(clazz: java.lang.Class[_], arg1: scala.reflect.OptManifest[_], args: scala.reflect.OptManifest[_]*)scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" class="delimiter">(</span><span title="=&gt; collection.IndexedSeq.type">IndexedSeq</span>.<span title="IndexedSeq[Nothing]">empty</span><span class="delimiter">)</span>
          <a href="#40367" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#40364" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40373">close</a>: <span title="Unit">Unit</span> = <a href="#40356" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="40374">hasNext</a> = <span class="delimiter">(</span><a href="#40370" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="40383">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="40384">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#40384" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#40364" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#40385" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40384" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40384" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40376" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40384" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40375" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40384" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40384" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40384" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40383" title="Int">minIdx</a> = <a href="#40384" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#40384" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="40731">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#40364" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40376" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#40375" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#40181" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28603" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40179" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40181" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28603" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40731" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40179" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#40383" title="Int">minIdx</a> = <a href="#40731" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#40370" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#40367" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>

            <span class="comment">// do another fetch if we reach the end of minIdx's buffer- this</span>
            <span class="comment">// is unlike SimpleIndexMergeJoin which does not do another fetch</span>
            <span class="comment">// here.</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40367" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40364" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40376" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#40375" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40383" title="Int">minIdx</a><span class="delimiter">)</span>

            <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="40375">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="40506">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>

          <span class="keyword">val</span> <a href="#41270" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#41269" title="edu.berkeley.cs.scads.piql.package.Key" id="41270">key</a>, <a href="#41269" title="edu.berkeley.cs.scads.piql.package.Tuple" id="41271">tup</a>, <a href="#41269" title="Int" id="41272">offset</a>, <a href="#41269" title="Boolean" id="41273">limitReached</a>, <a href="#41269" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="41274">ftch</a><span class="delimiter">)</span> = <a href="#40361" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><a href="#40506" title="Int">i</a><span class="delimiter">)</span>

          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41273" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#41270" title="edu.berkeley.cs.scads.piql.package.Key">key</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41271" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41274" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41272" title="Int">offset</a> <span title="(x: Int)Boolean">!=</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="41275">records</a> = <a href="#41274" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
          <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#41270" title="edu.berkeley.cs.scads.piql.package.Key">key</a>, <a href="#41275" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a><span class="delimiter">)</span>

          <span class="comment">// TODO: is it slow to ++= append to an IndexedSeq??</span>
          <a href="#40364" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#40506" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#41275" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Record =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.package.Record],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#41271" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#41371" title="edu.berkeley.cs.scads.piql.package.Record">_</a><span class="delimiter">)</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41275" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40358" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// end of records in KV store</span>
            <a href="#40361" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]))Unit">tupleData</a><span class="delimiter">(</span><a href="#40506" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: Null, _2: Null, _3: Int, _4: Boolean, _5: Null)(Null, Null, Int, Boolean, Null)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span>, -<span title="Int(-1)" class="int">1</span>, <span title="Boolean(true)" class="keyword">true</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">// sentinel values</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="delimiter">{</span> <span class="comment">// still can ask for more records</span>
            <span class="comment">//val newOffset = records.size + offset</span>
            <span class="comment">//val newFtch = namespace.asyncGetRange(key, key, offset=newOffset, limit=boundLimit, ascending=ascending)</span>
            <span class="comment">//tupleData(i) = ((key, tup, newOffset, limitReached, newFtch))</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="40376">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="40504">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#40361" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span class="delimiter">(</span><a href="#40504" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="40377">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40374" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40805">ret</a> = <a href="#40370" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#40370" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#40805" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator">_</span> =&gt; <a href="#9527" title="edu.berkeley.cs.scads.piql.ParallelExecutor" class="keyword">super</a>.<a href="#32090" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#38689" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#38688" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class LazyExecutor extends edu.berkeley.cs.scads.piql.SimpleExecutor with ScalaObject" id="9528">LazyExecutor</a> <a href="#9528" title="ScalaObject" class="keyword">extends</a> <a href="#9526" title="edu.berkeley.cs.scads.piql.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator" id="41480">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.QueryPlan" id="41482">plan</a>: <a href="QueryPlan.scala.html#9610" title="edu.berkeley.cs.scads.piql.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.Context" id="41483">ctx</a>: <a href="#43635" title="edu.berkeley.cs.scads.piql.Context">Context</a><span class="delimiter">)</span>: <a href="#9524" title="edu.berkeley.cs.scads.piql.QueryIterator">QueryIterator</a> = <a href="#41482" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41486">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41487">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#41488" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="41488">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="41659">name</a> = <span title="java.lang.String(&quot;LazyIndexLookup&quot;)" class="string">&quot;LazyIndexLookup&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="41661">boundKey</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41486" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41487" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="41664">accessed</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="41667">result</a> = <a href="#41486" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#41661" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="41668">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="41669">close</a> <span class="delimiter">{</span> <a href="#41664" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span> <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="41670">hasNext</a> = <a href="#41664" title="=&gt; Boolean">accessed</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Boolean" class="keyword">false</span> =&gt; <a href="#41666" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; Boolean">isDefined</span>
          <span class="keyword">case</span> <span title="Boolean(false)" class="keyword">true</span>  =&gt; <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]" id="41671">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41670" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <a href="#41664" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span title="(elems: org.apache.avro.generic.IndexedRecord*)scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]">ArrayBuffer</span><span class="delimiter">(</span><a href="#41666" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41679">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41680">keyPrefix</a>, _, <a title="Boolean" id="41681">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span> <span class="comment">// we don't care about limit here</span>
        <a href="#41682" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="41682">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="41853">name</a> = <span title="java.lang.String(&quot;LazyIndexScan&quot;)" class="string">&quot;LazyIndexScan&quot;</span>

          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="41855">boundKeyPrefix</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41679" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41680" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Record" id="41858">result</a>: <span title="edu.berkeley.cs.scads.piql.package.Record">Record</span> = <span title="Null(null)" class="keyword">null</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="41861">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="41864">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="41866">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#41855" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="41881">res</a> = <a href="#41679" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="41928">boundKeyPrefix</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="41929">boundKeyPrefix</a>, offset=<a href="#32087" title="Option[Int]" id="41930">offset</a>, limit=<a href="#32087" title="Option[Int]" id="41931" class="int">1</a>, ascending=<a href="#41681" title="Boolean" id="41932">ascending</a><span class="delimiter">)</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#41881" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>, <a href="#41861" title="=&gt; Int">offset</a>, <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
            <a href="#41861" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#41881" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Int">size</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41881" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#41864" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
              <a href="#41858" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <a href="#41858" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <a href="#41881" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">head</span>
            <span class="delimiter">}</span>
            <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#41864" title="=&gt; Boolean">limitReached</a> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#41858" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="41867">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="41868">close</a> <span class="delimiter">{</span>
            <a href="#41858" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <a href="#41864" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="41869">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#41858" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41864" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#41866" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#41869" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Boolean(false)" class="keyword">false</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="41870">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41869" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="41871">ret</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#41858" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">)</span>
            <a href="#41858" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <a href="#41871" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ret</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41943">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41944">key</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="41945">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#41946" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="41946">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="42117">name</a> = <span title="java.lang.String(&quot;LazyIndexLookupJoin&quot;)" class="string">&quot;LazyIndexLookupJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="42119">childIterator</a> = <a href="#41480" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41945" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42122">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="42125">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42127">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="42128">close</a> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42125" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <a href="#42125" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <a href="#42119" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="42129">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42125" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#42125" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
            <a href="#42131" title="=&gt; Unit">getNext</a>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#42122" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="42130">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42138">ret</a> = <a href="#42122" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#42131" title="=&gt; Unit">getNext</a>
          <a href="#42138" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="42131">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#42119" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#42147" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42148">childTuple</a> = <a href="#42119" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="42149">boundKey</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41943" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41944" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#42148" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="42150">value</a> = <a href="#41943" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#42149" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#42150" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#42122" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#42148" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#42150" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#42122" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="42249">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="42250">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.Value]" id="42251">sortFields</a>, _, <a title="Boolean" id="42252">ascending</a>, <a title="edu.berkeley.cs.scads.piql.QueryPlan" id="42253">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#42254" title="edu.berkeley.cs.scads.piql.QueryIterator{}" class="keyword">new</a> <a href="#9524" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.QueryIterator" id="42254">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="42425">name</a> = <span title="java.lang.String(&quot;LazyIndexMergeJoin&quot;)" class="string">&quot;LazyIndexMergeJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.QueryIterator" id="42427">childIterator</a> = <a href="#41480" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42253" title="edu.berkeley.cs.scads.piql.QueryPlan">child</a><span class="delimiter">)</span>

        <span class="comment">/** (key, child tup, offset, limit reached?) */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="42430">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="42433">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="42436">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42439">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="42442">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="42444">init</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#42427" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28848" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="42472">tupleDatum</a> = <a href="#42427" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42477">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="42478">boundKeyPrefix</a> = <a href="#28600" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42249" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#42250" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#42477" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="42479">records</a> = <a href="#42249" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="42513">getRange</a><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="42509">boundKeyPrefix</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="42510">boundKeyPrefix</a>, limit=<a href="#32087" title="Option[Int]" id="42511" class="int">1</a>, ascending=<a href="#42252" title="Boolean" id="42512">ascending</a><span class="delimiter">)</span>
            <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#42478" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#42479" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="42480">recIdxSeq</a> = <a href="#42479" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#42477" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#42534" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#42478" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#42477" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#42479" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#42479" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span>, <a href="#42480" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#42430" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#42472" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="42684">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#42684" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#42684" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#42684" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#42684" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#42433" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#42472" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#42783" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#42436" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#42433" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#42451" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42445">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42446">close</a> <span class="delimiter">{</span>
          <a href="#42427" title="=&gt; edu.berkeley.cs.scads.piql.QueryIterator">childIterator</a>.<a href="#28849" title="=&gt; Unit">close</a>
          <a href="#42442" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="42447">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42442" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#42444" title="()Unit">init</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#42442" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#42439" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="42448">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42447" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42458">ret</a> = <a href="#42439" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#42451" title="=&gt; Unit">getNext</a>
          <a href="#42458" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="42449">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="42985">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#42987" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#42986" title="edu.berkeley.cs.scads.piql.package.Record" id="42987">key</a>, <a href="#42986" title="edu.berkeley.cs.scads.piql.package.Tuple" id="42988">tup</a>, <a href="#42986" title="Int" id="42989">offset</a>, <a href="#42986" title="Boolean" id="42990">limitReached</a><span class="delimiter">)</span> = <a href="#42430" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#42985" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42990" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="42991">records</a> = <a href="#42249" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="43038">key</a>, <a href="#32087" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="43039">key</a>, offset=<a href="#32087" title="Option[Int]" id="43040">offset</a>, limit=<a href="#32087" title="Option[Int]" id="43041" class="int">1</a>, ascending=<a href="#42252" title="Boolean" id="43042">ascending</a><span class="delimiter">)</span>
          <a href="#28595" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;</span>, <a href="#42987" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#42991" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#42433" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#42985" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#42991" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#42988" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#43091" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#42430" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#42985" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#42987" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#42988" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#42989" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#42991" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#42991" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="42450">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="43211">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#42430" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#43211" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="42451">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="43213">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="43214">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#43213" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#43214" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#42433" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#43215" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43214" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43214" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#42450" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#43214" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#42449" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#43214" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43214" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43214" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#43213" title="Int">minIdx</a> = <a href="#43214" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#43214" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#43213" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#42439" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="43558">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#43213" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#42433" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#42450" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#42449" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#42252" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28603" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43213" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43213" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42251" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42252" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28603" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.Value])(implicit ctx: edu.berkeley.cs.scads.piql.Context)Int">compareTuples</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43558" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43213" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43213" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42251" title="Seq[edu.berkeley.cs.scads.piql.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#43213" title="Int">minIdx</a> = <a href="#43558" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#42439" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#42433" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43213" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42436" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43213" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#42436" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#43213" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.QueryIterator">_</span> =&gt; <a href="#9528" title="edu.berkeley.cs.scads.piql.LazyExecutor" class="keyword">super</a>.<a href="#32090" title="(plan: edu.berkeley.cs.scads.piql.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.Context)edu.berkeley.cs.scads.piql.QueryIterator">apply</a><a href="#41483" title="edu.berkeley.cs.scads.piql.Context" class="delimiter">(</a><a href="#41482" title="edu.berkeley.cs.scads.piql.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>