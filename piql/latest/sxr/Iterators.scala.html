<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Iterators.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> exec

<span class="keyword">import</span> plans._

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.apache.avro.util.Utf8
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> comm.<span class="delimiter">{</span>ScadsFuture, StringRec<span class="delimiter">}</span>

<span class="keyword">import</span> java.<span class="delimiter">{</span> util =&gt; ju <span class="delimiter">}</span>
<span class="keyword">import</span> scala.collection.mutable.Queue
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer

<span class="comment">/**
 * The contex for a query plan to be executed in.
 * @param parameters - any runtime parameters for the query
 * @param state - the serialized state if resuming the query from a previous execution.
 */</span>
case <span class="keyword">class</span> <a title="class Context extends java.lang.Object with ScalaObject with Product with Serializable" id="43638">Context</a><a href="#43638" title="ScalaObject" class="delimiter">(</a><a title="IndexedSeq[Any]" id="29334">parameters</a>: <span title="IndexedSeq[Any]">IndexedSeq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span>, <a title="Option[List[Any]]" id="29335">state</a>: <span title="Option[List[Any]]">Option</span><span class="delimiter">[</span>List<span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class QueryIterator extends java.lang.Object with Iterator[edu.berkeley.cs.scads.piql.package.Tuple] with ScalaObject" id="9531">QueryIterator</a> <a href="#9531" title="ScalaObject" class="keyword">extends</a> <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="=&gt; String" id="28850">name</a>: <span title="String">String</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="28851">open</a>: <span title="Unit">Unit</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="28852">close</a>: <span title="Unit">Unit</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * A query executor takes a physical query plan and produces and iterator tree that will execute the query with
 * a given strategy.
 */</span>
<span class="keyword">trait</span> <a title="trait QueryExecutor extends java.lang.Object with ScalaObject" id="9532">QueryExecutor</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="24944">logger</a> = <span title="(name: String)net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span title="java.lang.String(&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;)" class="string">&quot;edu.berkeley.cs.scads.piql.QueryExecutor&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan, args: Any*)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="24946">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="28618">plan</a>: <a href="QueryPlan.scala.html#9630" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a>, <a title="Any*" id="28619">args</a>: <span title="Any*">Any</span>*<span class="delimiter">)</span>: <a href="#9531" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#24947" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><span class="delimiter">(</span><a href="#28618" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#43638" title="(parameters: IndexedSeq[Any], state: Option[List[Any]])edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">(</span><a href="#28619" title="Any*">args</a>.<span title="scala.collection.immutable.IndexedSeq[Any]">toIndexedSeq</span>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="24947">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="28621">plan</a>: <a href="QueryPlan.scala.html#9630" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="28622">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9531" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any" id="24948">bindValue</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="29355">value</a>: <a href="QueryPlan.scala.html#9599" title="edu.berkeley.cs.scads.piql.plans.Value">Value</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="29356">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="29357">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Any">Any</span> = <span class="delimiter">{</span>
    <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundValue: %s %s %s&quot;)" class="string">&quot;BoundValue: %s %s %s&quot;</span>, <a href="#29355" title="edu.berkeley.cs.scads.piql.plans.Value">value</a>, <a href="#29356" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a>, <a href="#29357" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a><span class="delimiter">)</span>
    <a href="#29355" title="edu.berkeley.cs.scads.piql.plans.Value">value</a> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Any">ConstantValue</span><span class="delimiter">(</span><a title="Any" id="29381">v</a><span class="delimiter">)</span> =&gt; <a href="#29381" title="Any">v</a>
      <span class="keyword">case</span> <span title="Any">ParameterValue</span><span class="delimiter">(</span><a title="Int" id="29400">o</a><span class="delimiter">)</span> =&gt; <a href="#29357" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#29334" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#29400" title="Int">o</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="java.lang.Object">AttributeValue</span><span class="delimiter">(</span><a title="Int" id="29471">recPos</a>, <a title="Int" id="29472">fieldPos</a><span class="delimiter">)</span> =&gt; <a href="#29356" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">currentTuple</a><span class="delimiter">(</span><a href="#29471" title="Int">recPos</a><span class="delimiter">)</span>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#29472" title="Int">fieldPos</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key" id="24949">bindKey</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="29492">ns</a>: <a href="package.scala.html#25169" title="edu.berkeley.cs.scads.piql.package.Namespace">Namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="29493">key</a>: <span title="edu.berkeley.cs.scads.piql.package.KeyGenerator">KeyGenerator</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="29497">currentTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="29495">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.piql.package.Key">Key</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="29498">boundKey</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#29492" title="edu.berkeley.cs.scads.piql.package.Namespace">ns</a>.<span title="=&gt; org.apache.avro.Schema">keySchema</span><span class="delimiter">)</span>

    <a href="#29493" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>.<span title="(f: edu.berkeley.cs.scads.piql.plans.Value =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.plans.Value],Any,Seq[Any]])Seq[Any]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Any,Seq[Any]]" class="delimiter">(</span><a href="#24948" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#29495" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#29638" title="edu.berkeley.cs.scads.piql.plans.Value">_</a>, <a href="#29497" title="edu.berkeley.cs.scads.piql.package.Tuple">currentTuple</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],(Any, Int),Seq[(Any, Int)]])Seq[(Any, Int)]">zipWithIndex</span>.<span title="(f: (Any, Int) =&gt; Unit)Unit">foreach</span> <a href="#31647" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="Any" id="31650">value</a>: <span title="Any">Any</span>, <a title="Int" id="31651">idx</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt; <a href="#29498" title="org.apache.avro.generic.GenericData.Record">boundKey</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#31651" title="Int">idx</a>, <a href="#31650" title="Any">value</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bound Key: %s&quot;)" class="string">&quot;Bound Key: %s&quot;</span>, <a href="#29498" title="org.apache.avro.generic.GenericData.Record">boundKey</a><span class="delimiter">)</span>
    <a href="#29498" title="org.apache.avro.generic.GenericData.Record">boundKey</a>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int" id="24950">bindLimit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Limit" id="31661">limit</a>: <a href="QueryPlan.scala.html#9613" title="edu.berkeley.cs.scads.piql.plans.Limit">Limit</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="31662">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#31661" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int">FixedLimit</span><span class="delimiter">(</span><a title="Int" id="31692">l</a><span class="delimiter">)</span> =&gt; <a href="#31692" title="Int">l</a>
    <span class="keyword">case</span> <span title="Int">ParameterLimit</span><span class="delimiter">(</span><a title="Int" id="31730">lim</a>, <a title="Int" id="31731">max</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="31732">limitValue</a> = <a href="#31662" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#29334" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#31730" title="Int">lim</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Int" class="delimiter">[</span><span title="Int">Int</span><span class="delimiter">]</span>
      <span class="comment">//if(limitValue &gt; max)</span>
      <span class="comment">//  throw new RuntimeException(&quot;Limit out of range&quot;)</span>
      <a href="#31732" title="Int">limitValue</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(predicate: edu.berkeley.cs.scads.piql.plans.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Boolean" id="24951">evalPredicate</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Predicate" id="31740">predicate</a>: <a href="QueryPlan.scala.html#9620" title="edu.berkeley.cs.scads.piql.plans.Predicate">Predicate</a>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31741">tuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="31742">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#31740" title="edu.berkeley.cs.scads.piql.plans.Predicate">predicate</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Boolean">EqualityPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="31781">v1</a>, <a title="edu.berkeley.cs.scads.piql.plans.Value" id="31782">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#24953" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#24948" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#31742" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31781" title="edu.berkeley.cs.scads.piql.plans.Value">v1</a>, <a href="#31741" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>, <a href="#24948" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#31742" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31782" title="edu.berkeley.cs.scads.piql.plans.Value">v2</a>, <a href="#31741" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">InPredicate</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="31828">v1</a>, <a title="edu.berkeley.cs.scads.piql.plans.Value" id="31829">v2</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[Any]" id="31830">valueList</a> = <a href="#24948" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#31742" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31829" title="edu.berkeley.cs.scads.piql.plans.Value">v2</a>, <a href="#31741" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="keyword">val</span> <a title="Any" id="31831">boundValue</a> = <a href="#24948" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#31742" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31828" title="edu.berkeley.cs.scads.piql.plans.Value">v1</a>, <a href="#31741" title="edu.berkeley.cs.scads.piql.package.Tuple">tuple</a><span class="delimiter">)</span>
      <a href="#31830" title="Seq[Any]">valueList</a>.<span title="(f: Any =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Any" id="31853">v</a> =&gt; <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#24953" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#31853" title="Any">v</a>,<a href="#31831" title="Any">boundValue</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Nothing" class="keyword">return</span> <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int" id="24952">compareTuples</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31860">left</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="31861">right</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="31862">attributes</a>: <span title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">Seq</span><span class="delimiter">[</span>Value<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="31863">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <a href="#31862" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">attributes</a>.<span title="(f: edu.berkeley.cs.scads.piql.plans.Value =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Value" id="31881">a</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Any" id="31882">leftValue</a> = <a href="#24948" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#31863" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31881" title="edu.berkeley.cs.scads.piql.plans.Value">a</a>, <a href="#31860" title="edu.berkeley.cs.scads.piql.package.Tuple">left</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Any" id="31883">rightValue</a> = <a href="#24948" title="(value: edu.berkeley.cs.scads.piql.plans.Value, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Any">bindValue</a><a href="#31863" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#31881" title="edu.berkeley.cs.scads.piql.plans.Value">a</a>, <a href="#31861" title="edu.berkeley.cs.scads.piql.package.Tuple">right</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Int" id="31884">comparison</a> = <a href="#24953" title="(left: Any, right: Any)Int">compareAny</a><span class="delimiter">(</span><a href="#31882" title="Any">leftValue</a>, <a href="#31883" title="Any">rightValue</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#31884" title="Int">comparison</a> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span> <a href="#31884" title="Int">comparison</a>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span title="Nothing" class="keyword">return</span> <span title="Int(0)" class="int">0</span>
  <span class="delimiter">}</span>

  <span class="keyword">final</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(left: Any, right: Any)Int" id="24953">compareAny</a><span class="delimiter">(</span><a title="Any" id="31783">left</a>: <span title="Any">Any</span>, <a title="Any" id="31784">right</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Any, _2: Any)(Any, Any)" class="delimiter">(</span><a href="#31783" title="Any">left</a>, <a href="#31784" title="Any">right</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="Integer" id="31898">l</a>: <span title="Integer">Integer</span>, <a title="Integer" id="31899">r</a>: <span title="Integer">Integer</span><span class="delimiter">)</span> =&gt; <a href="#31898" title="Integer">l</a>.<span title="()Int">intValue</span> <span title="(x: Int)Int">-</span> <a href="#31899" title="Integer">r</a>.<span title="()Int">intValue</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="31906">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="org.apache.avro.util.Utf8" id="31938">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#31906" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#31938" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="String" id="31970">l</a>: <span title="String">String</span>, <a title="org.apache.avro.util.Utf8" id="31971">r</a>: <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <a href="#31970" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">l</a> <span title="(other: String)Int">compare</span> <a href="#31971" title="org.apache.avro.util.Utf8">r</a>.<span title="()java.lang.String">toString</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="32064">l</a>: <span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="String" id="32065">r</a>: <span title="String">String</span><span class="delimiter">)</span> =&gt; <a href="#32064" title="org.apache.avro.util.Utf8">l</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span> <span title="(other: String)Int">compare</span> <a href="#32065" title="String">r</a>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * The simple executor issues requests to the key/value store serially.
 */</span>
<span class="keyword">class</span> <a title="class SimpleExecutor extends java.lang.Object with edu.berkeley.cs.scads.piql.exec.QueryExecutor with ScalaObject" id="9533">SimpleExecutor</a> <a href="#9533" title="ScalaObject" class="keyword">extends</a> <a href="#9532" title="edu.berkeley.cs.scads.piql.exec.QueryExecutor">QueryExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="32090">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="32092">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="32095">a</a>: <a href="#32092" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#32095" title="A">a</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="32093">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="32101">plan</a>: <a href="QueryPlan.scala.html#9630" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="32102">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9531" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#32101" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="32150">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="32151">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#32152" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="32152">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="32941">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookup&quot;)" class="string">&quot;SimpleIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="32943">boundKey</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#32150" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#32151" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="32946">result</a>: <span title="Option[edu.berkeley.cs.scads.piql.package.Record]">Option</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="32948">open</a>: <span title="Unit">Unit</span> =
          <a href="#32946" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#32150" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#32943" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="32949">close</a>: <span title="Unit">Unit</span> =
          <a href="#32946" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="32950">hasNext</a> = <a href="#32946" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Boolean">isDefined</span>
        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="32951">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="32952">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#32946" title="=&gt; Option[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#32946" title="(x$1: Option[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object None">None</span>
          <a href="#32952" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="33371">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="33372">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="33373">limit</a>, <a title="Boolean" id="33374">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#33375" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="33375">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="33546">name</a> = <span title="java.lang.String(&quot;SimpleIndexScan&quot;)" class="string">&quot;SimpleIndexScan&quot;</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="33548">boundKeyPrefix</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#33371" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#33372" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="33551">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="33554">pos</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="33557">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="33560">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="33562">boundLimit</a> = <a href="#24950" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#33373" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="33564">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#33548" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <a href="#33551" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#33371" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="33723">boundKeyPrefix</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="33724">boundKeyPrefix</a>, offset=<a href="#32090" title="Option[Int]" id="33725">offset</a>, limit=<a href="#32090" title="Option[Int]" id="33726">boundLimit</a>, ascending=<a href="#33374" title="Boolean" id="33727">ascending</a><span class="delimiter">)</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#33551" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#33557" title="=&gt; Int">offset</a>, <a href="#33562" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#33557" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#33551" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
            <a href="#33554" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#33551" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#33562" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
              <a href="#33560" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="33565">open</a>: <span title="Unit">Unit</span> = <a href="#33564" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="33566">close</a>: <span title="Unit">Unit</span> =
            <a href="#33551" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="33567">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#33554" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#33551" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#33560" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
              <span class="comment">// need to fetch more from KV store to see if we really have more</span>
              <a href="#33564" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#33567" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="33568">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#33567" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="33582">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#33551" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#33554" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#33554" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <a href="#33582" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="33820">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="33821">key</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="33822">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#33823" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="33823">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="33994">name</a> = <span title="java.lang.String(&quot;SimpleIndexLookupJoin&quot;)" class="string">&quot;SimpleIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="33996">childIterator</a> = <a href="#32093" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#33822" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="33999">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="34001">open</a> = <span class="delimiter">{</span><a href="#33996" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28851" title="=&gt; Unit">open</a>; <a href="#34005" title="=&gt; Unit">getNext</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="34002">close</a> = <a href="#33996" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="34003">hasNext</a> = <span class="delimiter">(</span><a href="#33999" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="34004">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34017">ret</a> = <a href="#33999" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#34005" title="=&gt; Unit">getNext</a>
          <a href="#34017" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="34005">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#33996" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#34020" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34021">childTuple</a> = <a href="#33996" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="34022">boundKey</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#33820" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#33821" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#34021" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="34023">value</a> = <a href="#33820" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#34022" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#34023" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#33999" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#34021" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#34023" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>    <span class="comment">//TODO: Why does it return the boundKey???</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#33999" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="34523">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="34524">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="34525">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="34526">limit</a>, <a title="Boolean" id="34527">ascending</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="34528">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// TODO: Unifty this iterator and ParallelIndexMergeJoin, since a lot of</span>
      <span class="comment">// code is repeated</span>
      <a href="#34529" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="34529">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="34700">name</a> = <span title="java.lang.String(&quot;SimpleIndexMergeJoin&quot;)" class="string">&quot;SimpleIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="34702">childIterator</a> = <a href="#32093" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#34528" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="34704">boundLimit</a> = <a href="#24950" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#34526" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/** (key, child tup, offset, limit reached?) */</span>
        <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="34707">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="34710">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="Array[Int]" id="34713">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34716">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="34718">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#34702" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28851" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="34744">tupleDatum</a> = <a href="#34702" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34749">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="34750">boundKeyPrefix</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#34523" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#34524" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#34749" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="34751">records</a> = <a href="#34523" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="34785">getRange</a><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="34781">boundKeyPrefix</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="34782">boundKeyPrefix</a>, limit=<a href="#32090" title="Option[Int]" id="34783">boundLimit</a>, ascending=<a href="#34527" title="Boolean" id="34784">ascending</a><span class="delimiter">)</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#34750" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#34751" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="34752">recIdxSeq</a> = <a href="#34751" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="34806">r</a> =&gt; <a href="#34749" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#34806" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#34750" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#34749" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#34751" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#34751" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34704" title="=&gt; Int">boundLimit</a>, <a href="#34752" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#34707" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#34744" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="35068">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#35068" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#35068" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#35068" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#35068" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#34710" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#34744" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#35455" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#34713" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#34710" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#34724" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="34719">close</a>: <span title="Unit">Unit</span> = <a href="#34702" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="34720">hasNext</a> = <span class="delimiter">(</span><a href="#34716" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="34721">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#34720" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="34730">ret</a> = <a href="#34716" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#34724" title="=&gt; Unit">getNext</a>
          <a href="#34730" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="34722">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="36043">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#36045" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#36044" title="edu.berkeley.cs.scads.piql.package.Record" id="36045">key</a>, <a href="#36044" title="edu.berkeley.cs.scads.piql.package.Tuple" id="36046">tup</a>, <a href="#36044" title="Int" id="36047">offset</a>, <a href="#36044" title="Boolean" id="36048">limitReached</a><span class="delimiter">)</span> = <a href="#34707" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#36043" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#36048" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="36049">records</a> = <a href="#34523" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="36097">key</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="36098">key</a>, offset=<a href="#32090" title="Option[Int]" id="36099">offset</a>, limit=<a href="#32090" title="Option[Int]" id="36100">boundLimit</a>, ascending=<a href="#34527" title="Boolean" id="36101">ascending</a><span class="delimiter">)</span>
          <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#36045" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#36049" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#34710" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#36043" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#36049" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="36165">r</a> =&gt; <a href="#36046" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#36165" title="org.apache.avro.generic.IndexedRecord">r</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#34707" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#36043" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#36045" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#36046" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#36047" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#36049" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#36049" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34704" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="34723">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="36285">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#34707" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#36285" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="34724">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="36287">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="36288">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#36287" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#36288" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#34710" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#36289" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36288" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#36288" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#34723" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#36288" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#34722" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#36288" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36288" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#36288" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#36287" title="Int">minIdx</a> = <a href="#36288" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#36288" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#36287" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#34716" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="37063">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#36287" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#34710" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#34723" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#34722" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#34527" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#24952" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36287" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36287" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34525" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#34527" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#24952" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#37063" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36287" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36287" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#34525" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#36287" title="Int">minIdx</a> = <a href="#37063" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#34716" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#34710" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#36287" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#34713" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#36287" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#34713" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#36287" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">LocalSelection</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Predicate" id="37169">predicate</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="37170">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37171" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="37171">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37342">name</a> = <span title="java.lang.String(&quot;Selection&quot;)" class="string">&quot;Selection&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="37344">childIterator</a> = <a href="#32093" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37170" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37347">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37349">open</a> = <span class="delimiter">{</span><a href="#37344" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28851" title="=&gt; Unit">open</a>; <a href="#37353" title="=&gt; Unit">getNext</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="37350">close</a> = <a href="#37344" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37351">hasNext</a> = <span class="delimiter">(</span><a href="#37347" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37352">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37365">ret</a> = <a href="#37347" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#37353" title="=&gt; Unit">getNext</a>
          <a href="#37365" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="37353">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#37344" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#37368" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="37369">childValue</a> = <a href="#37344" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#24951" title="(predicate: edu.berkeley.cs.scads.piql.plans.Predicate, tuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Boolean">evalPredicate</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37169" title="edu.berkeley.cs.scads.piql.plans.Predicate">predicate</a>, <a href="#37369" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#37347" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#37369" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#37347" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">LocalStopAfter</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.Limit" id="37407">k</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="37408">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37409" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="37409">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="37580">name</a> = <span title="java.lang.String(&quot;StopAfter&quot;)" class="string">&quot;StopAfter&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="37582">childIterator</a> = <a href="#32093" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37408" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="37584">limit</a> = <a href="#24950" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#37407" title="edu.berkeley.cs.scads.piql.plans.Limit">k</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="37587">taken</a> = <span title="Int(0)" class="int">0</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="37589">open</a> = <span class="delimiter">{</span><a href="#37587" title="(x$1: Int)Unit">taken</a> = <span title="Int(0)" class="int">0</span>; <a href="#37582" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28851" title="=&gt; Unit">open</a><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="37590">close</a> = <span class="delimiter">{</span><a href="#37582" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="37591">hasNext</a> = <a href="#37582" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#37584" title="=&gt; Int">limit</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#37587" title="=&gt; Int">taken</a><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37592">next</a> = <span class="delimiter">{</span><a href="#37587" title="(x$1: Int)Unit">taken</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>; <a href="#37582" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span><span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">LocalIterator</span><span class="delimiter">(</span><a title="Int" id="37647">ordinal</a>, <a title="Boolean" id="37648">wrap</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#37649" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="37649">QueryIterator</a> <span class="delimiter">{</span>
	<span class="keyword">val</span> <a title="java.lang.String" id="37820">name</a> = <span title="java.lang.String(&quot;LocalIterator&quot;)" class="string">&quot;LocalIterator&quot;</span>
	<span class="keyword">private</span> <span class="keyword">var</span> <a title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" id="37823">delegate</a>: <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">Iterator</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="37825">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
	  <a href="#37823" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> = 
	    <span title="Iterator[edu.berkeley.cs.scads.piql.package.Tuple]" class="keyword">if</span><span class="delimiter">(</span><a href="#37648" title="Boolean">wrap</a><span class="delimiter">)</span> <span class="comment">//This is kinda gross... I'm sorry.</span>
	      <a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#29334" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#37647" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[Any]" class="delimiter">[</span><span title="Seq[Any]">Seq</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="(f: Any =&gt; scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]])Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec],Seq[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]]" class="delimiter">(</span><a title="Any" id="37857">i</a> =&gt; <span title="(elems: edu.berkeley.cs.scads.comm.StringRec*)scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]">Vector</span><span class="delimiter">(</span><span title="(f1: String)edu.berkeley.cs.scads.comm.StringRec">StringRec</span><span class="delimiter">(</span><a href="#37857" title="Any">i</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="String" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Iterator[scala.collection.immutable.Vector[edu.berkeley.cs.scads.comm.StringRec]]">toIterator</span>
	    <span class="keyword">else</span>
	      <a href="#32102" title="edu.berkeley.cs.scads.piql.exec.Context">ctx</a>.<a href="#29334" title="(idx: Int)Any">parameters</a><span class="delimiter">(</span><a href="#37647" title="Int">ordinal</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]" class="delimiter">[</span><span title="Seq[edu.berkeley.cs.scads.piql.package.Tuple]">Seq</span><span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">toIterator</span>
	<span class="delimiter">}</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="37826">close</a>: <span title="Unit">Unit</span> = <a href="#37823" title="(x$1: Iterator[edu.berkeley.cs.scads.piql.package.Tuple])Unit">delegate</a> = <span title="Null(null)" class="keyword">null</span>
	<span class="keyword">def</span> <a title="=&gt; Boolean" id="37827">hasNext</a> = <a href="#37823" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="=&gt; Boolean">hasNext</span>
	<span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="37828">next</a> = <a href="#37823" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.package.Tuple]">delegate</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="Nothing">Union</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="38681">chil1</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="38682">child2</a>, <a title="edu.berkeley.cs.scads.piql.plans.AttributeValue" id="38683">eqField</a><span class="delimiter">)</span>  =&gt;<span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not yet implemented&quot;)" class="string">&quot;Not yet implemented&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * The parallel executor issues all requests to the key/value store in parallel.
 * TODO: Should abstract out the common parts between the query iterators.
 */</span>
<span class="keyword">class</span> <a title="class ParallelExecutor extends edu.berkeley.cs.scads.piql.exec.SimpleExecutor with ScalaObject" id="9534">ParallelExecutor</a> <a href="#9534" title="ScalaObject" class="keyword">extends</a> <a href="#9533" title="edu.berkeley.cs.scads.piql.exec.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="38689">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="38691">plan</a>: <a href="QueryPlan.scala.html#9630" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="38692">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9531" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#38691" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="38695">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="38696">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#38697" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="38697">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="38868">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookup&quot;)" class="string">&quot;ParallelIndexLookup&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="38870">boundKey</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#38695" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#38696" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]" id="38873">ftch</a>: <span title="Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">Option</span><span class="delimiter">[</span>ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="38875">open</a>: <span title="Unit">Unit</span> =
          <a href="#38873" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="(x: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])Some[edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]]">Some</span><span class="delimiter">(</span><a href="#38695" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#38870" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="38876">close</a>: <span title="Unit">Unit</span> =
          <a href="#38873" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="38877">hasNext</a> =
          <a href="#38873" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#38896" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="38878">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39316">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#38873" title="=&gt; Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]]">ftch</a>.<span title="(f: edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]] =&gt; Option[edu.berkeley.cs.scads.piql.package.Record])Option[edu.berkeley.cs.scads.piql.package.Record]">flatMap</span><span class="delimiter">(</span><a href="#39322" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">_</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.piql.package.Record)edu.berkeley.cs.scads.piql.package.Record">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Empty iterator&quot;)" class="string">&quot;Empty iterator&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#38873" title="(x$1: Option[edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]])Unit">ftch</a> = <span title="object None">None</span>
          <a href="#39316" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="39337">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="39338">keyPrefix</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="39339">limit</a>, <a title="Boolean" id="39340">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#39341" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="39341">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="39512">name</a> = <span title="java.lang.String(&quot;ParallelIndexScan&quot;)" class="string">&quot;ParallelIndexScan&quot;</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="39514">boundKeyPrefix</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#39337" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#39338" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="39517">result</a>: <span title="Seq[edu.berkeley.cs.scads.piql.package.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="39520">ftch</a>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span> = _

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="39523">pos</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="39526">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="39529">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="39531">boundLimit</a> = <a href="#24950" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#39339" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span> <span class="comment">// should get rid of 2nd getRange</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="39534">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39536">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#39514" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <a href="#39520" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <a href="#39337" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">asyncGetRange</span><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39622">boundKeyPrefix</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="39623">boundKeyPrefix</a>, offset=<a href="#32090" title="Option[Int]" id="39624">offset</a>, limit=<a href="#32090" title="Option[Int]" id="39625">boundLimit</a>, ascending=<a href="#39340" title="Boolean" id="39626">ascending</a><span class="delimiter">)</span>
            <a href="#39534" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39537">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#39517" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <a href="#39520" title="=&gt; edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Prefetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#39517" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>, <a href="#39526" title="=&gt; Int">offset</a>, <a href="#39531" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
            <a href="#39526" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#39517" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span>
            <a href="#39523" title="(x$1: Int)Unit">pos</a> = <span title="Int(0)" class="int">0</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#39517" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#39531" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span>
              <a href="#39529" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
            <a href="#39534" title="(x$1: Boolean)Unit">ftchInvoked</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="39538">open</a>: <span title="Unit">Unit</span> = <a href="#39536" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="39539">close</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
            <a href="#39517" title="(x$1: Seq[edu.berkeley.cs.scads.piql.package.Record])Unit">result</a> = <span title="object Nil">Nil</span>
            <a href="#39520" title="(x$1: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])Unit">ftch</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="39540">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39534" title="=&gt; Boolean">ftchInvoked</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// have we already blocked on ftch and stored the result in result?</span>
              <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39523" title="=&gt; Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#39517" title="=&gt; Seq[edu.berkeley.cs.scads.piql.package.Record]">result</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
              <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#39529" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
              <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="comment">// need to fetch more from KV store to see if we really have more</span>
                <a href="#39536" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
                <a href="#39540" title="=&gt; Boolean">hasNext</a>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <a href="#39537" title="()Unit">updateFuture</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#39540" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39541">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39540" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="39547">tuple</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#39517" title="(idx: Int)edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">(</span><a href="#39523" title="=&gt; Int">pos</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#39523" title="(x$1: Int)Unit">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <a href="#39547" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">tuple</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="39643">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="39644">key</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="39645">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#39646" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="39646">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="39817">name</a> = <span title="java.lang.String(&quot;ParallelIndexLookupJoin&quot;)" class="string">&quot;ParallelIndexLookupJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="39819">childIterator</a> = <a href="#38689" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#39645" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="39822">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" id="39824">ftchs</a> = <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]" class="keyword">new</span> <span title="scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">Queue</span><span class="delimiter">[</span><span class="delimiter">(</span>Tuple, Record, ScadsFuture<span class="delimiter">[</span>Option<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="39826">windowSize</a> = <span title="Int(10)" class="int">10</span> <span class="comment">// keep 10 outstanding ftchs at a time</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="39828">open</a> = <span class="delimiter">{</span><a href="#39819" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28851" title="=&gt; Unit">open</a>; <a href="#39832" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="39829">close</a> = <a href="#39819" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="39830">hasNext</a> = <span class="delimiter">(</span><a href="#39822" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>
          <span class="keyword">var</span> <a title="Boolean" id="39844">found</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39844" title="Boolean">found</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#39824" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#39845" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a href="#40025" title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#40024" title="edu.berkeley.cs.scads.piql.package.Tuple" id="40025">childTuple</a>, <a href="#40024" title="edu.berkeley.cs.scads.piql.package.Record" id="40026">boundKey</a>, <a href="#40024" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]" id="40027">ftch</a><span class="delimiter">)</span> = <a href="#39824" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="()(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])">dequeue</span><span title="(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#40027" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Option[edu.berkeley.cs.scads.piql.package.Record]">get</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Record" id="40046">recVal</a><span class="delimiter">)</span> =&gt;
                <a href="#39822" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40025" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#40046" title="edu.berkeley.cs.scads.piql.package.Record">recVal</a><span class="delimiter">)</span>
                <a href="#39844" title="Boolean">found</a> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">// done</span>
              <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="comment">// keep going</span>
            <span class="delimiter">}</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#39824" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39819" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <span class="comment">// need to get more records</span>
              <a href="#39832" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#39844" title="Boolean">found</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="39831">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#39830" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40146">ret</a> = <a href="#39822" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#39822" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#39832" title="()Unit">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#40146" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="39832">fillFutures</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#39819" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#39824" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#39826" title="=&gt; Int">windowSize</a><span class="delimiter">)</span> <a href="#40150" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40160">childTuple</a> = <a href="#39819" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40161">boundKey</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#39643" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#39644" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#40160" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]" id="40162">valueFtch</a> = <a href="#39643" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGetRecord</span><span class="delimiter">(</span><a href="#40161" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>
            <a href="#39824" title="=&gt; scala.collection.mutable.Queue[(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]])]">ftchs</a> <span title="(elem: (edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.comm.ScadsFuture[Option[edu.berkeley.cs.scads.piql.package.Record]]))this.ftchs.type">+=</span> <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Tuple, _2: edu.berkeley.cs.scads.piql.package.Key, _3: edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Tuple, edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#40160" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a>, <a href="#40161" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a>, <a href="#40162" title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">valueFtch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="40180">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="40181">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="40182">sortFields</a>, <a title="edu.berkeley.cs.scads.piql.plans.Limit" id="40183">limit</a>, <a title="Boolean" id="40184">ascending</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="40185">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#40186" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="40186">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="40357">name</a> = <span title="java.lang.String(&quot;ParallelIndexMergeJoin&quot;)" class="string">&quot;ParallelIndexMergeJoin&quot;</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="40359">childIterator</a> = <a href="#38689" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40185" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="40361">boundLimit</a> = <a href="#24950" title="(limit: edu.berkeley.cs.scads.piql.plans.Limit)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">bindLimit</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40183" title="edu.berkeley.cs.scads.piql.plans.Limit">limit</a><span class="delimiter">)</span>

        <span class="comment">/**
         * (key, child tup, offset, limit reached?, outstanding ftch)
         */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]" id="40364">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Key, Tuple, Int, Boolean, ScadsFuture<span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="40367">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="40370">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40373">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40375">open</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <a href="#40359" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28851" title="=&gt; Unit">open</a>

          <a href="#40364" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])Unit">tupleData</a> = <a href="#40359" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40825">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="40826">boundKeyPrefix</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40180" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#40181" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#40825" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]" id="40827">ftch</a> = <a href="#40180" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="40860">asyncGetRange</a><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40856">boundKeyPrefix</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="40857">boundKeyPrefix</a>, limit=<a href="#32090" title="Option[Int]" id="40858">boundLimit</a>, ascending=<a href="#40184" title="Boolean" id="40859">ascending</a><span class="delimiter">)</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])" class="delimiter">(</span><a href="#40826" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#40825" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <span title="Int(0)" class="int">0</span>, <span title="Boolean(false)" class="keyword">false</span>, <a href="#40827" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]]">ftch</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[org.apache.avro.generic.IndexedRecord]])]">toArray</span>

          <a href="#40367" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple])(implicit evidence$9: scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">fill</span><span class="delimiter">(</span><a href="#40364" title="(xs: Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])])scala.collection.mutable.ArrayOps[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleData</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="(clazz: java.lang.Class[_], arg1: scala.reflect.OptManifest[_], args: scala.reflect.OptManifest[_]*)scala.reflect.ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" class="delimiter">(</span><span title="=&gt; collection.IndexedSeq.type">IndexedSeq</span>.<span title="IndexedSeq[Nothing]">empty</span><span class="delimiter">)</span>
          <a href="#40370" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#40367" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="40376">close</a>: <span title="Unit">Unit</span> = <a href="#40359" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="40377">hasNext</a> = <span class="delimiter">(</span><a href="#40373" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="40386">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="40387">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#40387" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#40367" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#40388" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40387" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40387" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40379" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40387" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40378" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40387" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40387" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40387" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#40386" title="Int">minIdx</a> = <a href="#40387" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#40387" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="40734">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#40367" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40379" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#40378" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#40184" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#24952" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40182" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40184" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#24952" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40734" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#40182" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#40386" title="Int">minIdx</a> = <a href="#40734" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#40373" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#40370" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>

            <span class="comment">// do another fetch if we reach the end of minIdx's buffer- this</span>
            <span class="comment">// is unlike SimpleIndexMergeJoin which does not do another fetch</span>
            <span class="comment">// here.</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#40370" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#40367" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#40379" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#40378" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#40386" title="Int">minIdx</a><span class="delimiter">)</span>

            <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="40378">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="40509">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>

          <span class="keyword">val</span> <a href="#41273" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</a><a href="#41272" title="edu.berkeley.cs.scads.piql.package.Key" id="41273">key</a>, <a href="#41272" title="edu.berkeley.cs.scads.piql.package.Tuple" id="41274">tup</a>, <a href="#41272" title="Int" id="41275">offset</a>, <a href="#41272" title="Boolean" id="41276">limitReached</a>, <a href="#41272" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]" id="41277">ftch</a><span class="delimiter">)</span> = <a href="#40364" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]) @unchecked" class="delimiter">(</span><a href="#40509" title="Int">i</a><span class="delimiter">)</span>

          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41276" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#41273" title="edu.berkeley.cs.scads.piql.package.Key">key</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41274" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41277" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#41275" title="Int">offset</a> <span title="(x: Int)Boolean">!=</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.package.Record]" id="41278">records</a> = <a href="#41277" title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]">ftch</a>.<span title="()Seq[edu.berkeley.cs.scads.piql.package.Record]">get</span>
          <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#41273" title="edu.berkeley.cs.scads.piql.package.Key">key</a>, <a href="#41278" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a><span class="delimiter">)</span>

          <span class="comment">// TODO: is it slow to ++= append to an IndexedSeq??</span>
          <a href="#40367" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#40509" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#41278" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Record =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.package.Record],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#41274" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#41374" title="edu.berkeley.cs.scads.piql.package.Record">_</a><span class="delimiter">)</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41278" title="Seq[edu.berkeley.cs.scads.piql.package.Record]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#40361" title="=&gt; Int">boundLimit</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// end of records in KV store</span>
            <a href="#40364" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]]))Unit">tupleData</a><span class="delimiter">(</span><a href="#40509" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: Null, _2: Null, _3: Int, _4: Boolean, _5: Null)(Null, Null, Int, Boolean, Null)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span>, -<span title="Int(-1)" class="int">1</span>, <span title="Boolean(true)" class="keyword">true</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">// sentinel values</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="delimiter">{</span> <span class="comment">// still can ask for more records</span>
            <span class="comment">//val newOffset = records.size + offset</span>
            <span class="comment">//val newFtch = namespace.asyncGetRange(key, key, offset=newOffset, limit=boundLimit, ascending=ascending)</span>
            <span class="comment">//tupleData(i) = ((key, tup, newOffset, limitReached, newFtch))</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="40379">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="40507">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#40364" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, edu.berkeley.cs.scads.comm.ScadsFuture[Seq[edu.berkeley.cs.scads.piql.package.Record]])">tupleData</a><span class="delimiter">(</span><a href="#40507" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="40380">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40377" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="40808">ret</a> = <a href="#40373" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#40373" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <a href="#40808" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator">_</span> =&gt; <a href="#9534" title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">super</a>.<a href="#32093" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#38692" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#38691" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * The lazy executor retrieves tuples from the key/value store on demand, one at a time.
 */</span>
<span class="keyword">class</span> <a title="class LazyExecutor extends edu.berkeley.cs.scads.piql.exec.SimpleExecutor with ScalaObject" id="9535">LazyExecutor</a> <a href="#9535" title="ScalaObject" class="keyword">extends</a> <a href="#9533" title="edu.berkeley.cs.scads.piql.exec.SimpleExecutor">SimpleExecutor</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator" id="41483">apply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="41485">plan</a>: <a href="QueryPlan.scala.html#9630" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">QueryPlan</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.piql.exec.Context" id="41486">ctx</a>: <a href="#43638" title="edu.berkeley.cs.scads.piql.exec.Context">Context</a><span class="delimiter">)</span>: <a href="#9531" title="edu.berkeley.cs.scads.piql.exec.QueryIterator">QueryIterator</a> = <a href="#41485" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookup</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41489">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41490">key</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#41491" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="41491">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="41662">name</a> = <span title="java.lang.String(&quot;LazyIndexLookup&quot;)" class="string">&quot;LazyIndexLookup&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="41664">boundKey</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#41489" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41490" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a><span class="delimiter">)</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="41667">accessed</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="41670">result</a> = <a href="#41489" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#41664" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="41671">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="41672">close</a> <span class="delimiter">{</span> <a href="#41667" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span> <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="41673">hasNext</a> = <a href="#41667" title="=&gt; Boolean">accessed</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Boolean" class="keyword">false</span> =&gt; <a href="#41669" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; Boolean">isDefined</span>
          <span class="keyword">case</span> <span title="Boolean(false)" class="keyword">true</span>  =&gt; <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]" id="41674">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41673" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <a href="#41667" title="(x$1: Boolean)Unit">accessed</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span title="(elems: org.apache.avro.generic.IndexedRecord*)scala.collection.mutable.ArrayBuffer[org.apache.avro.generic.IndexedRecord]">ArrayBuffer</span><span class="delimiter">(</span><a href="#41669" title="=&gt; Option[org.apache.avro.generic.IndexedRecord]">result</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexScan</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41682">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41683">keyPrefix</a>, _, <a title="Boolean" id="41684">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span> <span class="comment">// we don't care about limit here</span>
        <a href="#41685" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="41685">QueryIterator</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.lang.String" id="41856">name</a> = <span title="java.lang.String(&quot;LazyIndexScan&quot;)" class="string">&quot;LazyIndexScan&quot;</span>

          <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="41858">boundKeyPrefix</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#41682" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41683" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a><span class="delimiter">)</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Record" id="41861">result</a>: <span title="edu.berkeley.cs.scads.piql.package.Record">Record</span> = <span title="Null(null)" class="keyword">null</span>

          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="41864">offset</a> = <span title="Int(0)" class="int">0</span>
          <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="41867">limitReached</a> = <span title="Boolean(false)" class="keyword">false</span>

          @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="41869">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BoundKeyPrefix: %s&quot;)" class="string">&quot;BoundKeyPrefix: %s&quot;</span>, <a href="#41858" title="=&gt; edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="41884">res</a> = <a href="#41682" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="41931">boundKeyPrefix</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="41932">boundKeyPrefix</a>, offset=<a href="#32090" title="Option[Int]" id="41933">offset</a>, limit=<a href="#32090" title="Option[Int]" id="41934" class="int">1</a>, ascending=<a href="#41684" title="Boolean" id="41935">ascending</a><span class="delimiter">)</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;)" class="string">&quot;IndexScan Fetch Returned %s, with offset %d, limit %d&quot;</span>, <a href="#41884" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>, <a href="#41864" title="=&gt; Int">offset</a>, <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
            <a href="#41864" title="(x$1: Int)Unit">offset</a> <span title="(x: Int)Int">+=</span> <a href="#41884" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Int">size</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41884" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#41867" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
              <a href="#41861" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <a href="#41861" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <a href="#41884" title="Seq[org.apache.avro.generic.IndexedRecord]">res</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">head</span>
            <span class="delimiter">}</span>
            <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#41867" title="=&gt; Boolean">limitReached</a> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#41861" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="41870">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Unit" id="41871">close</a> <span class="delimiter">{</span>
            <a href="#41861" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <a href="#41867" title="(x$1: Boolean)Unit">limitReached</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          <span class="keyword">def</span> <a title="=&gt; Boolean" id="41872">hasNext</a> =
            <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#41861" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41867" title="=&gt; Boolean">limitReached</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#41869" title="()Unit">doFetch</a><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="#41872" title="=&gt; Boolean">hasNext</a>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Boolean(false)" class="keyword">false</span>

          <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="41873">next</a> = <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41872" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]" id="41874">ret</a> = <span title="(elems: edu.berkeley.cs.scads.piql.package.Record*)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ArrayBuffer</span><span class="delimiter">(</span><a href="#41861" title="=&gt; edu.berkeley.cs.scads.piql.package.Record">result</a><span class="delimiter">)</span>
            <a href="#41861" title="(x$1: edu.berkeley.cs.scads.piql.package.Record)Unit">result</a> = <span title="Null(null)" class="keyword">null</span>
            <a href="#41874" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.piql.package.Record]">ret</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexLookupJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="41946">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="41947">key</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="41948">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#41949" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="41949">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="42120">name</a> = <span title="java.lang.String(&quot;LazyIndexLookupJoin&quot;)" class="string">&quot;LazyIndexLookupJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="42122">childIterator</a> = <a href="#41483" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#41948" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42125">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="42128">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42130">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
        <span class="keyword">def</span> <a title="=&gt; Unit" id="42131">close</a> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42128" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <a href="#42128" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">else</span> <a href="#42122" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="42132">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42128" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#42128" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
            <a href="#42134" title="=&gt; Unit">getNext</a>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#42125" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="42133">next</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42141">ret</a> = <a href="#42125" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#42134" title="=&gt; Unit">getNext</a>
          <a href="#42141" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="42134">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#42122" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="=&gt; Boolean">hasNext</span><span class="delimiter">)</span> <a href="#42150" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42151">childTuple</a> = <a href="#42122" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="()edu.berkeley.cs.scads.piql.package.Tuple">next</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="42152">boundKey</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#41946" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#41947" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">key</a>, <a href="#42151" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="42153">value</a> = <a href="#41946" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">getRecord</span><span class="delimiter">(</span><a href="#42152" title="edu.berkeley.cs.scads.piql.package.Key">boundKey</a><span class="delimiter">)</span>

            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#42153" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#42125" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#42151" title="edu.berkeley.cs.scads.piql.package.Tuple">childTuple</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,edu.berkeley.cs.scads.piql.package.Tuple])edu.berkeley.cs.scads.piql.package.Tuple">++</span> <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassManifest[T])Array[T]">Array</span><span title="(xs: edu.berkeley.cs.scads.piql.package.Record*)(implicit evidence$2: scala.reflect.ClassManifest[edu.berkeley.cs.scads.piql.package.Record])Array[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.package.Record">Record</span><span class="delimiter">]</span><span title="(xs: Array[edu.berkeley.cs.scads.piql.package.Record])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.piql.package.Record]" class="delimiter">(</span><a href="#42153" title="Option[org.apache.avro.generic.IndexedRecord]">value</a>.<span title="=&gt; org.apache.avro.generic.IndexedRecord">get</span><span class="delimiter">)</span>
              <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#42125" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}">IndexMergeJoin</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Namespace" id="42252">namespace</a>, <a title="edu.berkeley.cs.scads.piql.package.KeyGenerator" id="42253">keyPrefix</a>, <a title="Seq[edu.berkeley.cs.scads.piql.plans.Value]" id="42254">sortFields</a>, _, <a title="Boolean" id="42255">ascending</a>, <a title="edu.berkeley.cs.scads.piql.plans.QueryPlan" id="42256">child</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#42257" title="edu.berkeley.cs.scads.piql.exec.QueryIterator{}" class="keyword">new</a> <a href="#9531" title="anonymous class $anon extends edu.berkeley.cs.scads.piql.exec.QueryIterator" id="42257">QueryIterator</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="42428">name</a> = <span title="java.lang.String(&quot;LazyIndexMergeJoin&quot;)" class="string">&quot;LazyIndexMergeJoin&quot;</span>

        <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.QueryIterator" id="42430">childIterator</a> = <a href="#41483" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#42256" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">child</a><span class="delimiter">)</span>

        <span class="comment">/** (key, child tup, offset, limit reached?) */</span>
        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]" id="42433">tupleData</a>: <span title="Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>Record, Tuple, Int, Boolean<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]" id="42436">tupleBuffers</a>: <span title="Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">Array</span><span class="delimiter">[</span>IndexedSeq<span class="delimiter">[</span>Tuple<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Array[Int]" id="42439">bufferPos</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42442">nextTuple</a>: <span title="edu.berkeley.cs.scads.piql.package.Tuple">Tuple</span> = <span title="Null(null)" class="keyword">null</span>

        <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="42445">needsInit</a> = <span title="Boolean(true)" class="keyword">true</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="42447">init</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#42430" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28851" title="=&gt; Unit">open</a>

          <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]" id="42475">tupleDatum</a> = <a href="#42430" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<span title="(f: edu.berkeley.cs.scads.piql.package.Tuple =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]))Iterator[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42480">childValue</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Key" id="42481">boundKeyPrefix</a> = <a href="#24949" title="(ns: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, currentTuple: edu.berkeley.cs.scads.piql.package.Tuple)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.package.Key">bindKey</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#42252" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>, <a href="#42253" title="edu.berkeley.cs.scads.piql.package.KeyGenerator">keyPrefix</a>, <a href="#42480" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="42482">records</a> = <a href="#42252" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<a title="Option[Int]" id="42516">getRange</a><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="42512">boundKeyPrefix</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Key]" id="42513">boundKeyPrefix</a>, limit=<a href="#32090" title="Option[Int]" id="42514" class="int">1</a>, ascending=<a href="#42255" title="Boolean" id="42515">ascending</a><span class="delimiter">)</span>
            <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Prefetch Using Key %s: %s&quot;</span>, <a href="#42481" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#42482" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]" id="42483">recIdxSeq</a> = <a href="#42482" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#42480" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#42537" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
            <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean, _5: scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" class="delimiter">(</span><a href="#42481" title="edu.berkeley.cs.scads.piql.package.Key">boundKeyPrefix</a>, <a href="#42480" title="edu.berkeley.cs.scads.piql.package.Tuple">childValue</a>, <a href="#42482" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#42482" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span>, <a href="#42483" title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">recIdxSeq</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">toSeq</span>

          <a href="#42433" title="(x$1: Array[(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Unit">tupleData</a> = <a href="#42475" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]])Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean),Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])" id="42687">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.piql.package.Key, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#42687" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Key">_1</span>, <a href="#42687" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">_2</span>, <a href="#42687" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Int">_3</span>, <a href="#42687" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">x</a>.<span title="=&gt; Boolean">_4</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)])Array[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)]">toArray</span>

          <a href="#42436" title="(x$1: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Unit">tupleBuffers</a> = <a href="#42475" title="Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])]">tupleDatum</a>.<span title="(f: (edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]) =&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])],scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]])Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]],Seq[scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]]" class="delimiter">(</span><a href="#42786" title="(edu.berkeley.cs.scads.piql.package.Key, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean, scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])">_</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">_5</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: ClassManifest[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">toArray</span>
          <a href="#42439" title="(x$1: Array[Int])Unit">bufferPos</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassManifest[Int])Array[Int]">fill</span><span class="delimiter">(</span><a href="#42436" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.AnyValManifest[Int]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

          <a href="#42454" title="=&gt; Unit">getNext</a> <span class="comment">// load the first result</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42448">open</a> <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Unit" id="42449">close</a> <span class="delimiter">{</span>
          <a href="#42430" title="=&gt; edu.berkeley.cs.scads.piql.exec.QueryIterator">childIterator</a>.<a href="#28852" title="=&gt; Unit">close</a>
          <a href="#42445" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="=&gt; Boolean" id="42450">hasNext</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42445" title="=&gt; Boolean">needsInit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#42447" title="()Unit">init</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#42445" title="(x$1: Boolean)Unit">needsInit</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>
          <span class="delimiter">(</span><a href="#42442" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.piql.package.Tuple" id="42451">next</a> = <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42450" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.util.NoSuchElementException" class="keyword">new</span> ju.<span title="java.util.NoSuchElementException">NoSuchElementException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Next on empty iterator&quot;)" class="string">&quot;Next on empty iterator&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.Tuple" id="42461">ret</a> = <a href="#42442" title="=&gt; edu.berkeley.cs.scads.piql.package.Tuple">nextTuple</a>
          <a href="#42454" title="=&gt; Unit">getNext</a>
          <a href="#42461" title="edu.berkeley.cs.scads.piql.package.Tuple">ret</a>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Unit" id="42452">fillBuffer</a><span class="delimiter">(</span><a title="Int" id="42988">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a href="#42990" title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</a><a href="#42989" title="edu.berkeley.cs.scads.piql.package.Record" id="42990">key</a>, <a href="#42989" title="edu.berkeley.cs.scads.piql.package.Tuple" id="42991">tup</a>, <a href="#42989" title="Int" id="42992">offset</a>, <a href="#42989" title="Boolean" id="42993">limitReached</a><span class="delimiter">)</span> = <a href="#42433" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span title="(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean) @unchecked" class="delimiter">(</span><a href="#42988" title="Int">i</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42993" title="Boolean">limitReached</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="42994">records</a> = <a href="#42252" title="edu.berkeley.cs.scads.piql.package.Namespace">namespace</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[org.apache.avro.generic.IndexedRecord]">getRange</span><span class="delimiter">(</span><a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="43041">key</a>, <a href="#32090" title="Option[edu.berkeley.cs.scads.piql.package.Record]" id="43042">key</a>, offset=<a href="#32090" title="Option[Int]" id="43043">offset</a>, limit=<a href="#32090" title="Option[Int]" id="43044" class="int">1</a>, ascending=<a href="#42255" title="Boolean" id="43045">ascending</a><span class="delimiter">)</span>
          <a href="#24944" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;)" class="string">&quot;IndexMergeJoin Fetch Using Key %s: %s&quot;</span>, <a href="#42990" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#42994" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a><span class="delimiter">)</span>
          <a href="#42436" title="=&gt; Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a><span class="delimiter">(</span><a href="#42988" title="Int">i</a><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.package.Tuple])(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple],edu.berkeley.cs.scads.piql.package.Tuple,IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">++=</span> <a href="#42994" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; IndexedSeq[edu.berkeley.cs.scads.piql.package.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]])Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],Seq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]]" class="delimiter">(</span><a href="#42991" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a> <span title="(elem: edu.berkeley.cs.scads.piql.package.Record)(implicit bf: scala.collection.generic.CanBuildFrom[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record],edu.berkeley.cs.scads.piql.package.Record,IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]])IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]">:+</span> <a href="#43094" title="org.apache.avro.generic.IndexedRecord">_</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[IndexedSeq[edu.berkeley.cs.scads.piql.package.Record]]">toIndexedSeq</span>
          <a href="#42433" title="(i: Int, x: (edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean))Unit">tupleData</a><span class="delimiter">(</span><a href="#42988" title="Int">i</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: edu.berkeley.cs.scads.piql.package.Record, _2: edu.berkeley.cs.scads.piql.package.Tuple, _3: Int, _4: Boolean)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)" class="delimiter">(</span><a href="#42990" title="edu.berkeley.cs.scads.piql.package.Record">key</a>, <a href="#42991" title="edu.berkeley.cs.scads.piql.package.Tuple">tup</a>, <a href="#42992" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#42994" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span>, <a href="#42994" title="Seq[org.apache.avro.generic.IndexedRecord]">records</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="(i: Int)Boolean" id="42453">bufferLimitReached</a><span class="delimiter">(</span><a title="Int" id="43214">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> =
          <a href="#42433" title="(i: Int)(edu.berkeley.cs.scads.piql.package.Record, edu.berkeley.cs.scads.piql.package.Tuple, Int, Boolean)">tupleData</a><span class="delimiter">(</span><a href="#43214" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">_4</span>

        <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="42454">getNext</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

          <span class="comment">// find the first available buffer</span>
          <span class="keyword">var</span> <a title="Int" id="43216">minIdx</a> = -<span title="Int(-1)" class="int">1</span>
          <span class="keyword">var</span> <a title="Int" id="43217">idx</a> = <span title="Int(0)" class="int">0</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#43216" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#43217" title="Int">idx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#42436" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <a href="#43218" title="()Unit" class="delimiter">{</a>

            <span class="comment">// if this buffer has already been scanned over but we can still fetch from KV store</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43217" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43217" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#42453" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#43217" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#42452" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#43217" title="Int">idx</a><span class="delimiter">)</span> <span class="comment">// do the fetch</span>
            <span class="delimiter">}</span>

            <span class="comment">// if there is a buffer with contents, then we've found the start</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43217" title="Int">idx</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43217" title="Int">idx</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#43216" title="Int">minIdx</a> = <a href="#43217" title="Int">idx</a>
            <span class="delimiter">}</span>
            <a href="#43217" title="Int">idx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>

          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#43216" title="Int">minIdx</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <a href="#42442" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <span title="Null(null)" class="keyword">null</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span><span class="delimiter">(</span><a title="Int" id="43561">i</a> &lt;- <span class="delimiter">(</span><span class="delimiter">(</span><a href="#43216" title="Int">minIdx</a> <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#42436" title="(xs: Array[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]])scala.collection.mutable.ArrayOps[IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]]">tupleBuffers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#42453" title="(i: Int)Boolean">bufferLimitReached</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#42452" title="(i: Int)Unit">fillBuffer</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#42255" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#24952" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43216" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43216" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42254" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
                  <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#42255" title="Boolean">ascending</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#24952" title="(left: edu.berkeley.cs.scads.piql.package.Tuple, right: edu.berkeley.cs.scads.piql.package.Tuple, attributes: Seq[edu.berkeley.cs.scads.piql.plans.Value])(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)Int">compareTuples</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43561" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43216" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43216" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#42254" title="Seq[edu.berkeley.cs.scads.piql.plans.Value]">sortFields</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <a href="#43216" title="Int">minIdx</a> = <a href="#43561" title="Int">i</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#42442" title="(x$1: edu.berkeley.cs.scads.piql.package.Tuple)Unit">nextTuple</a> = <a href="#42436" title="(i: Int)IndexedSeq[edu.berkeley.cs.scads.piql.package.Tuple]">tupleBuffers</a><span title="(idx: Int)edu.berkeley.cs.scads.piql.package.Tuple" class="delimiter">(</span><a href="#43216" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#42439" title="(i: Int)Int">bufferPos</a><span class="delimiter">(</span><a href="#43216" title="Int">minIdx</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#42439" title="=&gt; Array[Int]">bufferPos</a><span class="delimiter">(</span><a href="#43216" title="Int">minIdx</a><span class="delimiter">)</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span class="comment">// NO prefetching here if minIdx buffer becomes entirely scanned-</span>
            <span class="comment">// this is unlike ParallelIndexMergeJoin which does a prefetch for</span>
            <span class="comment">// this case</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.piql.exec.QueryIterator">_</span> =&gt; <a href="#9535" title="edu.berkeley.cs.scads.piql.exec.LazyExecutor" class="keyword">super</a>.<a href="#32093" title="(plan: edu.berkeley.cs.scads.piql.plans.QueryPlan)(implicit ctx: edu.berkeley.cs.scads.piql.exec.Context)edu.berkeley.cs.scads.piql.exec.QueryIterator">apply</a><a href="#41486" title="edu.berkeley.cs.scads.piql.exec.Context" class="delimiter">(</a><a href="#41485" title="edu.berkeley.cs.scads.piql.plans.QueryPlan">plan</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>