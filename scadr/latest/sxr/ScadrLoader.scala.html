<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>ScadrLoader.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> perf
<span class="keyword">package</span> scadr

<span class="keyword">import</span> comm._
<span class="keyword">import</span> piql._
<span class="keyword">import</span> piql.scadr._
<span class="keyword">import</span> storage._
<span class="keyword">import</span> avro.runtime._
<span class="keyword">import</span> avro.marker._

<span class="keyword">import</span> deploylib._
<span class="keyword">import</span> deploylib.mesos._
<span class="keyword">import</span> deploylib.ec2._

case <span class="keyword">class</span> <a href="#41110" title="class ScadrLoaderTask extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.perf.DataLoadingTask with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="37329">ScadrLoaderTask</a><a href="#37329" title="ScalaObject" class="delimiter">(</a><a href="#37329" title="()edu.berkeley.cs.scads.perf.scadr.ScadrLoaderTask" id="40338" class="keyword">var</a> <a title="Int" id="37304">numServers</a>: <span title="Int">Int</span>,
                           <span class="keyword">var</span> <a title="Int" id="37305">numLoaders</a>: <span title="Int">Int</span>,
                           <span class="keyword">var</span> <a title="Int" id="37317">followingCardinality</a>: <span title="Int">Int</span> = <span title="Int(10)" class="int">10</span>,
                           <span class="keyword">var</span> <a title="Int" id="37318">replicationFactor</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span>,
                           <span class="keyword">var</span> <a title="Int" id="37319">usersPerServer</a>: <span title="Int">Int</span> = <span title="Int(10000)" class="int">10000</span>,
                           <span class="keyword">var</span> <a title="Int" id="37320">thoughtsPerUser</a>: <span title="Int">Int</span> = <span title="Int(100)" class="int">100</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.scads.perf.DataLoadingTask">DataLoadingTask</span> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="delimiter">{</span>
  <span class="keyword">var</span> <a title="String" id="36036">clusterAddress</a>: <span title="String">String</span> = _

  <span class="keyword">def</span> <a title="()Unit" id="36038">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="36093">clusterRoot</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#36036" title="=&gt; String">clusterAddress</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="36094">coordination</a> = <a href="#36093" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(rpath: java.lang.String, tries: Int)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrCreate</span><span class="delimiter">(</span><span title="java.lang.String(&quot;coordination/loaders&quot;)" class="string">&quot;coordination/loaders&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" id="36095">cluster</a> = <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">ExperimentalScadsCluster</span><span class="delimiter">(</span><a href="#36093" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a><span class="delimiter">)</span>
    <a href="#36095" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="(clusterSize: Int)Unit">blockUntilReady</span><span class="delimiter">(</span><a href="#37304" title="=&gt; Int">numServers</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.ScadrLoader" id="36096">loader</a> = <span title="edu.berkeley.cs.scads.piql.scadr.ScadrLoader" class="keyword">new</span> <a href="ScadrData.scala.html#9606" title="edu.berkeley.cs.scads.piql.scadr.ScadrLoader">ScadrLoader</a><span class="delimiter">(</span>
      replicationFactor = <a href="#37318" title="=&gt; Int">replicationFactor</a>,
      numClients = <a href="#37305" title="=&gt; Int">numLoaders</a>,
      numUsers = <a href="#37304" title="=&gt; Int">numServers</a> <span title="(x: Int)Int">*</span> <a href="#37319" title="=&gt; Int">usersPerServer</a> <span title="(x: Int)Int">/</span> <a href="#37318" title="=&gt; Int">replicationFactor</a>,
      numThoughtsPerUser = <a href="#37320" title="=&gt; Int">thoughtsPerUser</a>,
      numSubscriptionsPerUser = <a href="#37317" title="=&gt; Int">followingCardinality</a>,
      numTagsPerThought = <span title="Int(5)" class="int">5</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Int" id="36097">clientId</a> = <a href="#36094" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;clientStart&quot;)" class="string">&quot;clientStart&quot;</span>, <a href="#37305" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#36097" title="Int">clientId</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#37329" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Awaiting scads cluster startup&quot;)" class="string">&quot;Awaiting scads cluster startup&quot;</span><span class="delimiter">)</span>
      <a href="#36095" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="(clusterSize: Int)Unit">blockUntilReady</span><span class="delimiter">(</span><a href="#37304" title="=&gt; Int">numServers</a><span class="delimiter">)</span>
      <a href="#37329" title="(tries: Int)(func: =&gt; Unit)Unit">retry</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#36096" title="edu.berkeley.cs.scads.piql.scadr.ScadrLoader">loader</a>.<a href="ScadrData.scala.html#19069" title="(cluster: edu.berkeley.cs.scads.storage.ScadsCluster)Unit">createNamespaces</a><span class="delimiter">(</span><a href="#36095" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.ScadrClient" id="36926">scadrClient</a> = <span title="edu.berkeley.cs.scads.piql.scadr.ScadrClient" class="keyword">new</span> <a href="ScadrClient.scala.html#9583" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">ScadrClient</a><span class="delimiter">(</span><a href="#36095" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>, <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">ParallelExecutor</span><span class="delimiter">)</span>
        <a href="#36926" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">scadrClient</a>.<a href="ScadrClient.scala.html#17014" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.User]">users</a>.<span title="(readQuorum: Double, writeQuorum: Double)Unit">setReadWriteQuorum</span><span class="delimiter">(</span><span title="Double(0.33)" class="double">0.33</span>, <span title="Double(0.67)" class="double">0.67</span><span class="delimiter">)</span>
        <a href="#36926" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">scadrClient</a>.<a href="ScadrClient.scala.html#17016" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughts</a>.<span title="(readQuorum: Double, writeQuorum: Double)Unit">setReadWriteQuorum</span><span class="delimiter">(</span><span title="Double(0.33)" class="double">0.33</span>, <span title="Double(0.67)" class="double">0.67</span><span class="delimiter">)</span>
        <a href="#36926" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">scadrClient</a>.<a href="ScadrClient.scala.html#17018" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(readQuorum: Double, writeQuorum: Double)Unit">setReadWriteQuorum</span><span class="delimiter">(</span><span title="Double(0.33)" class="double">0.33</span>, <span title="Double(0.67)" class="double">0.67</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="#36094" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;namespacesReady&quot;)" class="string">&quot;namespacesReady&quot;</span>, <a href="#37305" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.ScadrClient" id="36098">scadrClient</a> = <span title="edu.berkeley.cs.scads.piql.scadr.ScadrClient" class="keyword">new</span> <a href="ScadrClient.scala.html#9583" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">ScadrClient</a><span class="delimiter">(</span><a href="#36095" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>, <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">ParallelExecutor</span><span class="delimiter">)</span>

    <a href="#36094" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;startBulkLoad&quot;)" class="string">&quot;startBulkLoad&quot;</span>, <a href="#37305" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>
    <a href="#37329" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining bulk loading of data&quot;)" class="string">&quot;Begining bulk loading of data&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="loader.ScadrData" id="36099">data</a> = <a href="#36096" title="edu.berkeley.cs.scads.piql.scadr.ScadrLoader">loader</a>.<a href="ScadrData.scala.html#19077" title="(clientId: Int)loader.ScadrData">getData</a><span class="delimiter">(</span><a href="#36097" title="Int">clientId</a><span class="delimiter">)</span>
    <a href="#37329" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading users&quot;)" class="string">&quot;Loading users&quot;</span><span class="delimiter">)</span>
    <a href="#36098" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">scadrClient</a>.<a href="ScadrClient.scala.html#17014" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.User]">users</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.User])Unit">++=</span> <a href="#36099" title="loader.ScadrData">data</a>.<a href="ScadrData.scala.html#30961" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.User]">userData</a>
    <a href="#37329" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading thoughts&quot;)" class="string">&quot;Loading thoughts&quot;</span><span class="delimiter">)</span>
    <a href="#36098" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">scadrClient</a>.<a href="ScadrClient.scala.html#17016" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughts</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Thought])Unit">++=</span> <a href="#36099" title="loader.ScadrData">data</a>.<a href="ScadrData.scala.html#30963" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughtData</a>
    <a href="#37329" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading subscriptions&quot;)" class="string">&quot;Loading subscriptions&quot;</span><span class="delimiter">)</span>
    <a href="#36098" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">scadrClient</a>.<a href="ScadrClient.scala.html#17018" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])Unit">++=</span> <a href="#36099" title="loader.ScadrData">data</a>.<a href="ScadrData.scala.html#30965" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptionData</a>
    <a href="#37329" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bulk loading complete&quot;)" class="string">&quot;Bulk loading complete&quot;</span><span class="delimiter">)</span>
    <a href="#36094" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;loadingComplete&quot;)" class="string">&quot;loadingComplete&quot;</span>, <a href="#37305" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#36097" title="Int">clientId</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#36093" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><span title="java.lang.String(&quot;clusterReady&quot;)" class="string">&quot;clusterReady&quot;</span>, data = <a href="#37329" title="ScadrLoaderTask.this.type" class="keyword">this</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
      <span title="object deploylib.ec2.ExperimentNotification">ExperimentNotification</span>.<span title="object deploylib.ec2.ExperimentNotification.completions">completions</span>.<span title="(subject: String, message: String)Unit">publish</span><span class="delimiter">(</span><span title="java.lang.String(&quot;ScadrLoad Complete&quot;)" class="string">&quot;ScadrLoad Complete&quot;</span>, <a href="#37329" title="(record: edu.berkeley.cs.scads.perf.scadr.ScadrLoaderTask)edu.berkeley.cs.avro.runtime.RichIndexedRecord[edu.berkeley.cs.scads.perf.scadr.ScadrLoaderTask]" class="keyword">this</a>.<span title="=&gt; String">toJson</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
        </pre>
    </body>
</html>