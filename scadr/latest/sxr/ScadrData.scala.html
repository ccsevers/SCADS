<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>ScadrData.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> scadr

<span class="keyword">import</span> comm._
<span class="keyword">import</span> storage._
<span class="keyword">import</span> storage.client.index._
<span class="keyword">import</span> avro.marker._

<span class="keyword">import</span> org.apache.avro.util._

<span class="keyword">import</span> edu.berkeley.cs.scads.piql.<span title="object edu.berkeley.cs.scads.piql.DataGenerator">DataGenerator</span>._

<span class="keyword">import</span> scala.collection.mutable.HashSet

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.apache.avro.generic.GenericRecord

case <span class="keyword">class</span> <a title="class ScadrKeySplits extends java.lang.Object with ScalaObject with Product with Serializable" id="35070">ScadrKeySplits</a><a href="#35070" title="ScalaObject" class="delimiter">(</a>
                           <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="30948">usersKeySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span>,
                           <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="30949">thoughtsKeySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span>,
                           <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="30950">subscriptionsKeySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span>
                           <span class="delimiter">)</span>

<span class="comment">/**
 * Currently the loader assumes all nodes are equal and tries to distribute
 * evenly among the nodes with no preferences for any particular ones.
 */</span>
<span class="keyword">class</span> <a title="class ScadrLoader extends java.lang.Object with ScalaObject" id="9607">ScadrLoader</a><a href="#9607" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Int" id="25016">replicationFactor</a>: <span title="Int">Int</span>,
                  <span class="keyword">val</span> <a title="Int" id="25017">numClients</a>: <span title="Int">Int</span>, <span class="comment">// number of clients to split the loading by</span>
                  <span class="keyword">val</span> <a title="Int" id="25023">numUsers</a>: <span title="Int">Int</span> = <span title="Int(100)" class="int">100</span>,
                  <span class="keyword">val</span> <a title="Int" id="25024">numThoughtsPerUser</a>: <span title="Int">Int</span> = <span title="Int(10)" class="int">10</span>,
                  <span class="keyword">val</span> <a title="Int" id="25025">numSubscriptionsPerUser</a>: <span title="Int">Int</span> = <span title="Int(10)" class="int">10</span>,
                  <span class="keyword">val</span> <a title="Int" id="25026">numTagsPerThought</a>: <span title="Int">Int</span> = <span title="Int(5)" class="int">5</span><span class="delimiter">)</span> <span class="delimiter">{</span>

  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#25016" title="=&gt; Int">replicationFactor</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#25023" title="=&gt; Int">numUsers</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#25024" title="=&gt; Int">numThoughtsPerUser</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#25025" title="=&gt; Int">numSubscriptionsPerUser</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#25026" title="=&gt; Int">numTagsPerThought</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="19066">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">//TODO: Unify this with the (much cleaner) tpcw code</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit" id="19068">createNamespace</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" id="25066">namespace</a>: <span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span>, <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="25067">keySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[List[edu.berkeley.cs.scads.storage.StorageService]]" id="25076">services</a> = <a href="#25066" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">namespace</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</span>.<span title="()List[edu.berkeley.cs.scads.storage.StorageService]">getAvailableServers</span>.<span title="(size: Int)Iterator[List[edu.berkeley.cs.scads.storage.StorageService]]">grouped</span><span class="delimiter">(</span><a href="#25016" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>.<span title="=&gt; Seq[List[edu.berkeley.cs.scads.storage.StorageService]]">toSeq</span>
    <span class="keyword">val</span> <a title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]" id="25077">partitionScheme</a> = <a href="#25067" title="Seq[Option[org.apache.avro.generic.GenericRecord]]">keySplits</a>.<span title="(f: Option[org.apache.avro.generic.GenericRecord] =&gt; Option[Array[Byte]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[org.apache.avro.generic.GenericRecord]],Option[Array[Byte]],Seq[Option[Array[Byte]]]])Seq[Option[Array[Byte]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Option[Array[Byte]],Seq[Option[Array[Byte]]]]" class="delimiter">(</span><a href="#26125" title="Option[org.apache.avro.generic.GenericRecord]">_</a>.<span title="(f: org.apache.avro.generic.GenericRecord =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#25066" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">namespace</a>.<a href="#26131" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(that: scala.collection.GenIterable[List[edu.berkeley.cs.scads.storage.StorageService]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[Array[Byte]]],(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]])Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]]" class="delimiter">(</span><a href="#25076" title="Seq[List[edu.berkeley.cs.scads.storage.StorageService]]">services</a><span class="delimiter">)</span>
    <a href="#25066" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">namespace</a>.<span title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])])Unit">setPartitionScheme</span><span class="delimiter">(</span><a href="#25077" title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]">partitionScheme</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>


  <span class="keyword">def</span> <a title="(cluster: edu.berkeley.cs.scads.storage.ScadsCluster)Unit" id="19069">createNamespaces</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="28918">cluster</a>: <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits" id="28920">splits</a> = <a href="#19072" title="(clusterSize: Int)edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">keySplits</a><span class="delimiter">(</span><a href="#28918" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="()List[edu.berkeley.cs.scads.storage.StorageService]">getAvailableServers</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <a href="#19066" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Creating namespaces with keysplits: %s&quot;)" class="string">&quot;Creating namespaces with keysplits: %s&quot;</span>, <a href="#28920" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a><span class="delimiter">)</span>
    <a href="#19068" title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit">createNamespace</a><span class="delimiter">(</span><a href="#28918" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.User])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.User]" class="delimiter">[</span><a href="ScadrClient.scala.html#27387" title="edu.berkeley.cs.scads.piql.scadr.User">User</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.User]" class="delimiter">(</span><span title="java.lang.String(&quot;users&quot;)" class="string">&quot;users&quot;</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span><span class="delimiter">]</span>, <a href="#28920" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#30948" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">usersKeySplits</a><span class="delimiter">)</span>
    <a href="#19068" title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit">createNamespace</a><span class="delimiter">(</span><a href="#28918" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.Thought])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Thought]" class="delimiter">[</span><a href="ScadrClient.scala.html#27380" title="edu.berkeley.cs.scads.piql.scadr.Thought">Thought</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.Thought]" class="delimiter">(</span><span title="java.lang.String(&quot;thoughts&quot;)" class="string">&quot;thoughts&quot;</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span><span class="delimiter">]</span>, <a href="#28920" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#30949" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">thoughtsKeySplits</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" id="28921">subscriptions</a> = <a href="#28918" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">[</span><a href="ScadrClient.scala.html#27371" title="edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">(</span><span title="java.lang.String(&quot;subscriptions&quot;)" class="string">&quot;subscriptions&quot;</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span><span class="delimiter">]</span>
    <a href="#19068" title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit">createNamespace</a><span class="delimiter">(</span><a href="#28921" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">subscriptions</a>, <a href="#28920" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#30950" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">subscriptionsKeySplits</a><span class="delimiter">)</span>

    <span class="comment">//HACK</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace" id="28922">subIdx</a> = <a href="#28921" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">subscriptions</a>.<span title="(fields: Seq[edu.berkeley.cs.scads.storage.client.index.IndexType])edu.berkeley.cs.scads.storage.client.index.IndexNamespace">getOrCreateIndex</span><span class="delimiter">(</span><span title="(fieldName: String)edu.berkeley.cs.scads.storage.client.index.AttributeIndex">AttributeIndex</span><span class="delimiter">(</span><span title="java.lang.String(&quot;target&quot;)" class="string">&quot;target&quot;</span><span class="delimiter">)</span> <a href="#29164" title="(x: edu.berkeley.cs.scads.storage.client.index.AttributeIndex)List[edu.berkeley.cs.scads.storage.client.index.AttributeIndex]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[List[edu.berkeley.cs.scads.storage.StorageService]]" id="28923">services</a> = <a href="#28922" title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace">subIdx</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</span>.<span title="()List[edu.berkeley.cs.scads.storage.StorageService]">getAvailableServers</span>.<span title="(size: Int)Iterator[List[edu.berkeley.cs.scads.storage.StorageService]]">grouped</span><span class="delimiter">(</span><a href="#25016" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>.<span title="=&gt; Seq[List[edu.berkeley.cs.scads.storage.StorageService]]">toSeq</span>
    <span class="keyword">val</span> <a title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]" id="28924">partitionScheme</a> = <a href="#28920" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#30950" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">subscriptionsKeySplits</a>.<span title="(f: Option[org.apache.avro.generic.GenericRecord] =&gt; Option[Array[Byte]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[org.apache.avro.generic.GenericRecord]],Option[Array[Byte]],Seq[Option[Array[Byte]]]])Seq[Option[Array[Byte]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Option[Array[Byte]],Seq[Option[Array[Byte]]]]" class="delimiter">(</span><a href="#29298" title="Option[org.apache.avro.generic.GenericRecord]">_</a>.<span title="(f: org.apache.avro.generic.GenericRecord =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#28922" title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace">subIdx</a>.<a href="#29304" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(that: scala.collection.GenIterable[List[edu.berkeley.cs.scads.storage.StorageService]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[Array[Byte]]],(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]])Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]]" class="delimiter">(</span><a href="#28923" title="Seq[List[edu.berkeley.cs.scads.storage.StorageService]]">services</a><span class="delimiter">)</span>
    <a href="#28922" title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace">subIdx</a>.<span title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])])Unit">setPartitionScheme</span><span class="delimiter">(</span><a href="#28924" title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.storage.StorageService])]">partitionScheme</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(idx: Int)String" id="19070">toUsername</a><span class="delimiter">(</span><a title="Int" id="29388">idx</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;User%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#29388" title="Int">idx</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; String" id="19071">randomUser</a> = <a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span>scala.util.<span title="object scala.util.Random">Random</span>.<span title="(n: Int)Int">nextInt</span><span class="delimiter">(</span><a href="#25023" title="=&gt; Int">numUsers</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>

  <span class="comment">// must be + 1 since users are indexed starting from 1</span>

  <span class="comment">/**
   * Get the key splits based on the num* parameters and the scads cluster.
   * The number of nodes on the cluster is determined by calling
   * getAvailableServers on the scads cluster.
   *
   * We assume uniform distribution over subscriptions
   */</span>
  <span class="keyword">def</span> <a title="(clusterSize: Int)edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits" id="19072">keySplits</a><span class="delimiter">(</span><a title="Int" id="28925">clusterSize</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="#35070" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">ScadrKeySplits</a> = <span class="delimiter">{</span>
    <span class="comment">// TODO: not sure what to do here - should we just have some nodes</span>
    <span class="comment">// duplicate user key ranges?</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#28925" title="Int">clusterSize</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#25023" title="=&gt; Int">numUsers</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;More clusters than users- don\'t know how to make key split&quot;)" class="string">&quot;More clusters than users- don't know how to make key split&quot;</span><span class="delimiter">)</span>

    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#28925" title="Int">clusterSize</a> <span title="(x: Int)Int">%</span> <a href="#25016" title="=&gt; Int">replicationFactor</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>, <span title="java.lang.String(&quot;numServers must be divisible by by replicationFactor&quot;)" class="string">&quot;numServers must be divisible by by replicationFactor&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Int" id="29686">usersPerNode</a> = <a href="#25023" title="=&gt; Int">numUsers</a> <span title="(x: Int)Int">/</span> <span class="delimiter">(</span><a href="#28925" title="Int">clusterSize</a> <span title="(x: Int)Int">/</span> <a href="#25016" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[Int]]" id="29687">usersIdxs</a> = <span title="object None">None</span> <a href="#29722" title="(elem: Option[Int])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Some[Int]],Option[Int],scala.collection.immutable.IndexedSeq[Option[Int]]])scala.collection.immutable.IndexedSeq[Option[Int]]">+:</a> <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range">until</span> <a href="#28925" title="Int">clusterSize</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Some[Int])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],Some[Int],scala.collection.immutable.IndexedSeq[Some[Int]]])scala.collection.immutable.IndexedSeq[Some[Int]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Some[Int],scala.collection.immutable.IndexedSeq[Some[Int]]]" class="delimiter">(</span><a title="Int" id="30253">i</a> =&gt; <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#30253" title="Int">i</a> <span title="(x: Int)Int">*</span> <a href="#29686" title="Int">usersPerNode</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]" id="29688">usersKeySplits</a> = <a href="#29687" title="scala.collection.immutable.IndexedSeq[Option[Int]]">usersIdxs</a>.<span title="(f: Option[Int] =&gt; Option[edu.berkeley.cs.scads.piql.scadr.User])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[Int]],Option[edu.berkeley.cs.scads.piql.scadr.User],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]]])scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[edu.berkeley.cs.scads.piql.scadr.User],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]]]" class="delimiter">(</span><a href="#30517" title="Option[Int]">_</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.User)Option[edu.berkeley.cs.scads.piql.scadr.User]">map</span><span class="delimiter">(</span><a title="Int" id="30522">idx</a> =&gt; <a href="ScadrClient.scala.html#27387" title="(username: String)edu.berkeley.cs.scads.piql.scadr.User">User</a><span class="delimiter">(</span><a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#30522" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Option[edu.berkeley.cs.scads.piql.scadr.User] =&gt; Option[org.apache.avro.generic.GenericRecord])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]],Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]])scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]]" class="delimiter">(</span><a href="#30596" title="Option[edu.berkeley.cs.scads.piql.scadr.User]">_</a>.<span title="(f: edu.berkeley.cs.scads.piql.scadr.User =&gt; org.apache.avro.generic.GenericRecord)Option[org.apache.avro.generic.GenericRecord]">map</span><span class="delimiter">(</span><a href="#30601" title="edu.berkeley.cs.scads.piql.scadr.User">_</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]" id="29689">thoughtsKeySplits</a> = <a href="#29687" title="scala.collection.immutable.IndexedSeq[Option[Int]]">usersIdxs</a>.<span title="(f: Option[Int] =&gt; Option[edu.berkeley.cs.scads.piql.scadr.Thought])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[Int]],Option[edu.berkeley.cs.scads.piql.scadr.Thought],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]]])scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[edu.berkeley.cs.scads.piql.scadr.Thought],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]]]" class="delimiter">(</span><a href="#30649" title="Option[Int]">_</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Thought)Option[edu.berkeley.cs.scads.piql.scadr.Thought]">map</span><span class="delimiter">(</span><a title="Int" id="30654">idx</a> =&gt; <a href="ScadrClient.scala.html#27380" title="(owner: String, timestamp: Int)edu.berkeley.cs.scads.piql.scadr.Thought">Thought</a><span class="delimiter">(</span><a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#30654" title="Int">idx</a><span class="delimiter">)</span>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Option[edu.berkeley.cs.scads.piql.scadr.Thought] =&gt; Option[org.apache.avro.generic.GenericRecord])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]],Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]])scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]]" class="delimiter">(</span><a href="#30771" title="Option[edu.berkeley.cs.scads.piql.scadr.Thought]">_</a>.<span title="(f: edu.berkeley.cs.scads.piql.scadr.Thought =&gt; org.apache.avro.generic.GenericRecord)Option[org.apache.avro.generic.GenericRecord]">map</span><span class="delimiter">(</span><a href="#30776" title="edu.berkeley.cs.scads.piql.scadr.Thought">_</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]" id="29690">subscriptionsKeySplits</a> = <a href="#29687" title="scala.collection.immutable.IndexedSeq[Option[Int]]">usersIdxs</a>.<span title="(f: Option[Int] =&gt; Option[edu.berkeley.cs.scads.piql.scadr.Subscription])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[Int]],Option[edu.berkeley.cs.scads.piql.scadr.Subscription],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]]])scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[edu.berkeley.cs.scads.piql.scadr.Subscription],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]]]" class="delimiter">(</span><a href="#30820" title="Option[Int]">_</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Subscription)Option[edu.berkeley.cs.scads.piql.scadr.Subscription]">map</span><span class="delimiter">(</span><a title="Int" id="30825">idx</a> =&gt; <a href="ScadrClient.scala.html#27371" title="(owner: String, target: String)edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</a><span class="delimiter">(</span><a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#30825" title="Int">idx</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Option[edu.berkeley.cs.scads.piql.scadr.Subscription] =&gt; Option[org.apache.avro.generic.GenericRecord])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]],Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]])scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]]" class="delimiter">(</span><a href="#30888" title="Option[edu.berkeley.cs.scads.piql.scadr.Subscription]">_</a>.<span title="(f: edu.berkeley.cs.scads.piql.scadr.Subscription =&gt; org.apache.avro.generic.GenericRecord)Option[org.apache.avro.generic.GenericRecord]">map</span><span class="delimiter">(</span><a href="#30893" title="edu.berkeley.cs.scads.piql.scadr.Subscription">_</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// assume uniform distribution of tags over 8 bit ascii - not really</span>
    <span class="comment">// ideal, but we can generate the data such that this is true</span>

    <span class="keyword">var</span> <a title="Int" id="29691">size</a> = <span title="Int(256)" class="int">256</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#29691" title="Int">size</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#28925" title="Int">clusterSize</a><span class="delimiter">)</span>
      <a href="#29691" title="Int">size</a> = <a href="#29691" title="Int">size</a> <span title="(x: Int)Int">*</span> <span title="Int(256)" class="int">256</span>

    <span class="keyword">val</span> <a title="Int" id="29692">numPerNode</a> = <a href="#29691" title="Int">size</a> <span title="(x: Int)Int">/</span> <a href="#28925" title="Int">clusterSize</a>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#29692" title="Int">numPerNode</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>

    <span class="comment">// encodes i as a base 256 string. not super efficient</span>
    <span class="keyword">def</span> <a title="(i: Int)String" id="29693">toKeyString</a><span class="delimiter">(</span><a title="Int" id="30939">i</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="String">String</span> = <a href="#30939" title="Int">i</a> <span title="String" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="java.lang.String(&quot;&quot;)" class="int">0</span> =&gt; <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>
      <span class="keyword">case</span> <span title="java.lang.String">_</span> =&gt; <a href="#29693" title="(i: Int)String">toKeyString</a><span class="delimiter">(</span><a href="#30939" title="Int">i</a> <span title="(x: Int)Int">/</span> <span title="Int(256)" class="int">256</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#30939" title="Int">i</a> <span title="(x: Int)Int">%</span> <span title="Int(256)" class="int">256</span><span class="delimiter">)</span>.<span title="=&gt; Char">toChar</span>
    <span class="delimiter">}</span>

    <a href="#35070" title="(usersKeySplits: Seq[Option[org.apache.avro.generic.GenericRecord]], thoughtsKeySplits: Seq[Option[org.apache.avro.generic.GenericRecord]], subscriptionsKeySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">ScadrKeySplits</a><span class="delimiter">(</span><a href="#29688" title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">usersKeySplits</a>,
      <a href="#29689" title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">thoughtsKeySplits</a>,
      <a href="#29690" title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">subscriptionsKeySplits</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  case <span class="keyword">class</span> <a title="class ScadrData extends java.lang.Object with ScalaObject with Product with Serializable" id="31051">ScadrData</a><a href="#31051" title="ScalaObject" class="delimiter">(</a><a title="Seq[edu.berkeley.cs.scads.piql.scadr.User]" id="35007">userData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.User]">Seq</span><span class="delimiter">[</span>User<span class="delimiter">]</span>,
                       <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]" id="35008">thoughtData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">Seq</span><span class="delimiter">[</span>Thought<span class="delimiter">]</span>,
                       <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]" id="35009">subscriptionData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">Seq</span><span class="delimiter">[</span>Subscription<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(client: edu.berkeley.cs.scads.piql.scadr.ScadrClient)Unit" id="30968">load</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.scadr.ScadrClient" id="30977">client</a>: <a href="ScadrClient.scala.html#9583" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">ScadrClient</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#19066" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading users&quot;)" class="string">&quot;Loading users&quot;</span><span class="delimiter">)</span>
      <a href="#30977" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">client</a>.<a href="ScadrClient.scala.html#17014" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.User]">users</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.User])Unit">++=</span> <a href="#35007" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.User]">userData</a>
      <a href="#19066" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading thoughts&quot;)" class="string">&quot;Loading thoughts&quot;</span><span class="delimiter">)</span>
      <a href="#30977" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">client</a>.<a href="ScadrClient.scala.html#17016" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughts</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Thought])Unit">++=</span> <a href="#35008" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughtData</a>
      <a href="#19066" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading subscriptions&quot;)" class="string">&quot;Loading subscriptions&quot;</span><span class="delimiter">)</span>
      <a href="#30977" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">client</a>.<a href="ScadrClient.scala.html#17018" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])Unit">++=</span> <a href="#35009" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptionData</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Makes a slice of data from [startUser, endUser). Checks to make sure
   * first that start/end are valid for the given loader. Does not allow for
   * empty slices  (so startUser &amp;lt; endUser is required). Note that users
   * are indexed by 1 (so a valid start user goes from 1 to numUsers, and a
   * valid end user goes from 2 to numUsers + 1).
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startUser: Int, endUser: Int)ScadrLoader.this.ScadrData" id="19076">makeScadrData</a><span class="delimiter">(</span><a title="Int" id="31129">startUser</a>: <span title="Int">Int</span>, <a title="Int" id="31130">endUser</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="#31051" title="ScadrLoader.this.ScadrData">ScadrData</a> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span> <span title="(x: Int)Boolean">&lt;=</span> <a href="#31129" title="Int">startUser</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#31129" title="Int">startUser</a> <span title="(x: Int)Boolean">&lt;=</span> <a href="#25023" title="=&gt; Int">numUsers</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span> <span title="(x: Int)Boolean">&lt;=</span> <a href="#31130" title="Int">endUser</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#31130" title="Int">endUser</a> <span title="(x: Int)Boolean">&lt;=</span> <a href="#25023" title="=&gt; Int">numUsers</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#31129" title="Int">startUser</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#31130" title="Int">endUser</a><span class="delimiter">)</span>

    <span class="comment">// create lazy views on the data</span>

    <span class="keyword">def</span> <a title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]" id="31132">newUserIdView</a> =
      <span class="delimiter">(</span><a href="#31129" title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">startUser</a> <span title="(end: Int)scala.collection.immutable.Range">until</span> <a href="#31130" title="Int">endUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>

    <span class="keyword">def</span> <a title="(id: Int)edu.berkeley.cs.scads.piql.scadr.User" id="31133">toUser</a><span class="delimiter">(</span><a title="Int" id="31270">id</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="ScadrClient.scala.html#27387" title="edu.berkeley.cs.scads.piql.scadr.User">User</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.User" id="31271">u</a> = <a href="ScadrClient.scala.html#27387" title="(username: String)edu.berkeley.cs.scads.piql.scadr.User">User</a><span class="delimiter">(</span><a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#31270" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#31271" title="edu.berkeley.cs.scads.piql.scadr.User">u</a>.<a href="ScadrClient.scala.html#12190" title="(x$1: String)Unit">homeTown</a> = <span title="java.lang.String(&quot;hometown&quot;)" class="string">&quot;hometown&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#31270" title="Int">id</a> <span title="(x: Int)Int">%</span> <span title="Int(10)" class="int">10</span><span class="delimiter">)</span>
      <a href="#31271" title="edu.berkeley.cs.scads.piql.scadr.User">u</a>.<a href="ScadrClient.scala.html#12193" title="(x$1: String)Unit">password</a> = <span title="java.lang.String(&quot;secret&quot;)" class="string">&quot;secret&quot;</span>
      <a href="#31271" title="edu.berkeley.cs.scads.piql.scadr.User">u</a>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.scadr.User]" id="31134">userData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.User]">Seq</span><span class="delimiter">[</span>User<span class="delimiter">]</span> =
      <a href="#31132" title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUserIdView</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.User)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.User,Seq[edu.berkeley.cs.scads.piql.scadr.User]])Seq[edu.berkeley.cs.scads.piql.scadr.User]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.User,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.User,Seq[_]]]" class="delimiter">(</span><a href="#31133" title="(id: Int)edu.berkeley.cs.scads.piql.scadr.User">toUser</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]" id="31135">thoughtData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">Seq</span><span class="delimiter">[</span>Thought<span class="delimiter">]</span> =
      <a href="#31132" title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUserIdView</a>.<span title="(f: Int =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.scadr.Thought])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Thought,Seq[edu.berkeley.cs.scads.piql.scadr.Thought]])Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Thought,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]]" class="delimiter">(</span><a title="Int" id="32736">userId</a> =&gt;
        <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#25024" title="=&gt; Int">numThoughtsPerUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Thought)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Thought,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]])scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Thought,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]]" class="delimiter">(</span><a title="Int" id="32872">i</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.Thought" id="32873">t</a> = <a href="ScadrClient.scala.html#27380" title="(owner: String, timestamp: Int)edu.berkeley.cs.scads.piql.scadr.Thought">Thought</a><span class="delimiter">(</span><a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#32736" title="Int">userId</a><span class="delimiter">)</span>, <a href="#32872" title="Int">i</a><span class="delimiter">)</span>
          <a href="#32873" title="edu.berkeley.cs.scads.piql.scadr.Thought">t</a>.<a href="ScadrClient.scala.html#15458" title="(x$1: String)Unit">text</a> = <a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#32736" title="Int">userId</a><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; thinks &quot;)" class="string">&quot; thinks &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#32872" title="Int">i</a>
          <a href="#32873" title="edu.berkeley.cs.scads.piql.scadr.Thought">t</a>
        <span class="delimiter">}</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]" id="31136">subscriptionData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">Seq</span><span class="delimiter">[</span>Subscription<span class="delimiter">]</span> = <a href="#31132" title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUserIdView</a>.<span title="(f: Int =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]])Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]]" class="delimiter">(</span><a title="Int" id="33045">userId</a> =&gt;
      <span title="(seed: Int, maxInt: Int, count: Int)Array[Int]">randomInts</span><span title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]" class="delimiter">(</span><a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#33045" title="Int">userId</a><span class="delimiter">)</span>.<span title="()Int">hashCode</span>, <a href="#25023" title="=&gt; Int">numUsers</a>, <a href="#33045" title="Int">userId</a> <span title="(x: Int)Int">%</span> <a href="#25025" title="=&gt; Int">numSubscriptionsPerUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.mutable.IndexedSeqView[Int,Array[Int]]">view</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Subscription)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.IndexedSeqView[Int,Array[Int]],edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Array[edu.berkeley.cs.scads.piql.scadr.Subscription]]])scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Array[edu.berkeley.cs.scads.piql.scadr.Subscription]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.TraversableView[_, Array[_]],edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Array[edu.berkeley.cs.scads.piql.scadr.Subscription]]]" class="delimiter">(</span><a title="Int" id="34535">u</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.Subscription" id="34536">s</a> = <a href="ScadrClient.scala.html#27371" title="(owner: String, target: String)edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</a><span class="delimiter">(</span><a href="#19070" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#33045" title="Int">userId</a><span class="delimiter">)</span>, <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;User%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#34535" title="Int">u</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#34536" title="edu.berkeley.cs.scads.piql.scadr.Subscription">s</a>.<a href="ScadrClient.scala.html#16903" title="(x$1: Boolean)Unit">approved</a> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#34536" title="edu.berkeley.cs.scads.piql.scadr.Subscription">s</a>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">)</span>

    <a href="#31051" title="(userData: Seq[edu.berkeley.cs.scads.piql.scadr.User], thoughtData: Seq[edu.berkeley.cs.scads.piql.scadr.Thought], subscriptionData: Seq[edu.berkeley.cs.scads.piql.scadr.Subscription])ScadrLoader.this.ScadrData">ScadrData</a><span class="delimiter">(</span><a href="#31134" title="Seq[edu.berkeley.cs.scads.piql.scadr.User]">userData</a>, <a href="#31135" title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughtData</a>, <a href="#31136" title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptionData</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Clients are 0-indexed
   */</span>
  <span class="keyword">def</span> <a title="(clientId: Int)ScadrLoader.this.ScadrData" id="19077">getData</a><span class="delimiter">(</span><a title="Int" id="35017">clientId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="#31051" title="ScadrLoader.this.ScadrData">ScadrData</a> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#35017" title="Int">clientId</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#35017" title="Int">clientId</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#25017" title="=&gt; Int">numClients</a><span class="delimiter">)</span>

    <span class="comment">// TODO: fix this</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#25017" title="=&gt; Int">numClients</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#25023" title="=&gt; Int">numUsers</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;More clients than user keys - don\'t know how to partition load&quot;)" class="string">&quot;More clients than user keys - don't know how to partition load&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Int" id="35019">usersPerClient</a> = <a href="#25023" title="=&gt; Int">numUsers</a> <span title="(x: Int)Int">/</span> <a href="#25017" title="=&gt; Int">numClients</a>
    <span class="keyword">val</span> <a title="Int" id="35020">startIdx</a> = <a href="#35017" title="Int">clientId</a> <span title="(x: Int)Int">*</span> <a href="#35019" title="Int">usersPerClient</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
    <a href="#19076" title="(startUser: Int, endUser: Int)ScadrLoader.this.ScadrData">makeScadrData</a><span class="delimiter">(</span><a href="#35020" title="Int">startIdx</a>, <a href="#35020" title="Int">startIdx</a> <span title="(x: Int)Int">+</span> <a href="#35019" title="Int">usersPerClient</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>