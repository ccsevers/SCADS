<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>ScadrData.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> scadr

<span class="keyword">import</span> comm._
<span class="keyword">import</span> storage._
<span class="keyword">import</span> storage.client.index._
<span class="keyword">import</span> avro.marker._

<span class="keyword">import</span> org.apache.avro.util._

<span class="keyword">import</span> edu.berkeley.cs.scads.piql.<span title="object edu.berkeley.cs.scads.piql.DataGenerator">DataGenerator</span>._

<span class="keyword">import</span> scala.collection.mutable.HashSet

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.apache.avro.generic.GenericRecord

case <span class="keyword">class</span> <a title="class ScadrKeySplits extends java.lang.Object with ScalaObject with Product with Serializable" id="36632">ScadrKeySplits</a><a href="#36632" title="ScalaObject" class="delimiter">(</a>
                           <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="32545">usersKeySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span>,
                           <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="32546">thoughtsKeySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span>,
                           <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="32547">subscriptionsKeySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span>
                           <span class="delimiter">)</span>

<span class="comment">/**
 * Currently the loader assumes all nodes are equal and tries to distribute
 * evenly among the nodes with no preferences for any particular ones.
 */</span>
<span class="keyword">class</span> <a title="class ScadrLoader extends java.lang.Object with ScalaObject" id="9603">ScadrLoader</a><a href="#9603" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Int" id="27976">replicationFactor</a>: <span title="Int">Int</span>,
                  <span class="keyword">val</span> <a title="Int" id="27977">numClients</a>: <span title="Int">Int</span>, <span class="comment">// number of clients to split the loading by</span>
                  <span class="keyword">val</span> <a title="Int" id="27983">numUsers</a>: <span title="Int">Int</span> = <span title="Int(100)" class="int">100</span>,
                  <span class="keyword">val</span> <a title="Int" id="27984">numThoughtsPerUser</a>: <span title="Int">Int</span> = <span title="Int(10)" class="int">10</span>,
                  <span class="keyword">val</span> <a title="Int" id="27985">numSubscriptionsPerUser</a>: <span title="Int">Int</span> = <span title="Int(10)" class="int">10</span>,
                  <span class="keyword">val</span> <a title="Int" id="27986">numTagsPerThought</a>: <span title="Int">Int</span> = <span title="Int(5)" class="int">5</span><span class="delimiter">)</span> <span class="delimiter">{</span>

  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#27976" title="=&gt; Int">replicationFactor</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#27983" title="=&gt; Int">numUsers</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#27984" title="=&gt; Int">numThoughtsPerUser</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#27985" title="=&gt; Int">numSubscriptionsPerUser</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#27986" title="=&gt; Int">numTagsPerThought</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="27679">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">//TODO: Unify this with the (much cleaner) tpcw code</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit" id="27681">createNamespace</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" id="28017">namespace</a>: <span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span>, <a title="Seq[Option[org.apache.avro.generic.GenericRecord]]" id="28018">keySplits</a>: <span title="Seq[Option[org.apache.avro.generic.GenericRecord]]">Seq</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>GenericRecord<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[List[edu.berkeley.cs.scads.comm.StorageService]]" id="28020">services</a> = <a href="#28017" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">namespace</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</span>.<span title="()List[edu.berkeley.cs.scads.comm.StorageService]">getAvailableServers</span>.<span title="(size: Int)Iterator[List[edu.berkeley.cs.scads.comm.StorageService]]">grouped</span><span class="delimiter">(</span><a href="#27976" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>.<span title="=&gt; Seq[List[edu.berkeley.cs.scads.comm.StorageService]]">toSeq</span>
    <span class="keyword">val</span> <a title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]" id="28021">partitionScheme</a> = <a href="#28018" title="Seq[Option[org.apache.avro.generic.GenericRecord]]">keySplits</a>.<span title="(f: Option[org.apache.avro.generic.GenericRecord] =&gt; Option[Array[Byte]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[org.apache.avro.generic.GenericRecord]],Option[Array[Byte]],Seq[Option[Array[Byte]]]])Seq[Option[Array[Byte]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Option[Array[Byte]],Seq[Option[Array[Byte]]]]" class="delimiter">(</span><a href="#28308" title="Option[org.apache.avro.generic.GenericRecord]">_</a>.<span title="(f: org.apache.avro.generic.GenericRecord =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#28017" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">namespace</a>.<a href="#28314" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(that: scala.collection.GenIterable[List[edu.berkeley.cs.scads.comm.StorageService]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[Array[Byte]]],(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]])Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]]" class="delimiter">(</span><a href="#28020" title="Seq[List[edu.berkeley.cs.scads.comm.StorageService]]">services</a><span class="delimiter">)</span>
    <a href="#28017" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">namespace</a>.<span title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])])Unit">setPartitionScheme</span><span class="delimiter">(</span><a href="#28021" title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]">partitionScheme</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>


  <span class="keyword">def</span> <a title="(cluster: edu.berkeley.cs.scads.storage.ScadsCluster)Unit" id="27682">createNamespaces</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="30827">cluster</a>: <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits" id="30829">splits</a> = <a href="#27685" title="(clusterSize: Int)edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">keySplits</a><span class="delimiter">(</span><a href="#30827" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="()List[edu.berkeley.cs.scads.comm.StorageService]">getAvailableServers</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <a href="#27679" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Creating namespaces with keysplits: %s&quot;)" class="string">&quot;Creating namespaces with keysplits: %s&quot;</span>, <a href="#30829" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a><span class="delimiter">)</span>
    <a href="#27681" title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit">createNamespace</a><span class="delimiter">(</span><a href="#30827" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.User])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.User]" class="delimiter">[</span><a href="ScadrClient.scala.html#9575" title="edu.berkeley.cs.scads.piql.scadr.User">User</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.User]" class="delimiter">(</span><span title="java.lang.String(&quot;users&quot;)" class="string">&quot;users&quot;</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span><span class="delimiter">]</span>, <a href="#30829" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#32545" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">usersKeySplits</a><span class="delimiter">)</span>
    <a href="#27681" title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit">createNamespace</a><span class="delimiter">(</span><a href="#30827" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.Thought])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Thought]" class="delimiter">[</span><a href="ScadrClient.scala.html#9578" title="edu.berkeley.cs.scads.piql.scadr.Thought">Thought</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.Thought]" class="delimiter">(</span><span title="java.lang.String(&quot;thoughts&quot;)" class="string">&quot;thoughts&quot;</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span><span class="delimiter">]</span>, <a href="#30829" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#32546" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">thoughtsKeySplits</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" id="30830">subscriptions</a> = <a href="#30827" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">[</span><a href="ScadrClient.scala.html#9581" title="edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">(</span><span title="java.lang.String(&quot;subscriptions&quot;)" class="string">&quot;subscriptions&quot;</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">PairNamespace</span><span class="delimiter">[</span>AvroPair<span class="delimiter">]</span><span class="delimiter">]</span>
    <a href="#27681" title="(namespace: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair], keySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])Unit">createNamespace</a><span class="delimiter">(</span><a href="#30830" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">subscriptions</a>, <a href="#30829" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#32547" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">subscriptionsKeySplits</a><span class="delimiter">)</span>

    <span class="comment">//HACK</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace" id="30831">subIdx</a> = <a href="#30830" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.avro.marker.AvroPair]">subscriptions</a>.<span title="(fields: Seq[edu.berkeley.cs.scads.storage.client.index.IndexType])edu.berkeley.cs.scads.storage.client.index.IndexNamespace">getOrCreateIndex</span><span class="delimiter">(</span><span title="(fieldName: String)edu.berkeley.cs.scads.storage.client.index.AttributeIndex">AttributeIndex</span><span class="delimiter">(</span><span title="java.lang.String(&quot;target&quot;)" class="string">&quot;target&quot;</span><span class="delimiter">)</span> <a href="#30907" title="(x: edu.berkeley.cs.scads.storage.client.index.AttributeIndex)List[edu.berkeley.cs.scads.storage.client.index.AttributeIndex]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[List[edu.berkeley.cs.scads.comm.StorageService]]" id="30832">services</a> = <a href="#30831" title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace">subIdx</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</span>.<span title="()List[edu.berkeley.cs.scads.comm.StorageService]">getAvailableServers</span>.<span title="(size: Int)Iterator[List[edu.berkeley.cs.scads.comm.StorageService]]">grouped</span><span class="delimiter">(</span><a href="#27976" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>.<span title="=&gt; Seq[List[edu.berkeley.cs.scads.comm.StorageService]]">toSeq</span>
    <span class="keyword">val</span> <a title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]" id="30833">partitionScheme</a> = <a href="#30829" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">splits</a>.<a href="#32547" title="=&gt; Seq[Option[org.apache.avro.generic.GenericRecord]]">subscriptionsKeySplits</a>.<span title="(f: Option[org.apache.avro.generic.GenericRecord] =&gt; Option[Array[Byte]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[org.apache.avro.generic.GenericRecord]],Option[Array[Byte]],Seq[Option[Array[Byte]]]])Seq[Option[Array[Byte]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Option[Array[Byte]],Seq[Option[Array[Byte]]]]" class="delimiter">(</span><a href="#31007" title="Option[org.apache.avro.generic.GenericRecord]">_</a>.<span title="(f: org.apache.avro.generic.GenericRecord =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#30831" title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace">subIdx</a>.<a href="#31013" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(that: scala.collection.GenIterable[List[edu.berkeley.cs.scads.comm.StorageService]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Option[Array[Byte]]],(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]])Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService]),Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]]" class="delimiter">(</span><a href="#30832" title="Seq[List[edu.berkeley.cs.scads.comm.StorageService]]">services</a><span class="delimiter">)</span>
    <a href="#30831" title="edu.berkeley.cs.scads.storage.client.index.IndexNamespace">subIdx</a>.<span title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])])Unit">setPartitionScheme</span><span class="delimiter">(</span><a href="#30833" title="Seq[(Option[Array[Byte]], List[edu.berkeley.cs.scads.comm.StorageService])]">partitionScheme</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(idx: Int)String" id="27683">toUsername</a><span class="delimiter">(</span><a title="Int" id="31097">idx</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;User%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#31097" title="Int">idx</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; String" id="27684">randomUser</a> = <a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span>scala.util.<span title="object scala.util.Random">Random</span>.<span title="(n: Int)Int">nextInt</span><span class="delimiter">(</span><a href="#27983" title="=&gt; Int">numUsers</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>

  <span class="comment">// must be + 1 since users are indexed starting from 1</span>

  <span class="comment">/**
   * Get the key splits based on the num* parameters and the scads cluster.
   * The number of nodes on the cluster is determined by calling
   * getAvailableServers on the scads cluster.
   *
   * We assume uniform distribution over subscriptions
   */</span>
  <span class="keyword">def</span> <a title="(clusterSize: Int)edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits" id="27685">keySplits</a><span class="delimiter">(</span><a title="Int" id="30834">clusterSize</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="#36632" title="edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">ScadrKeySplits</a> = <span class="delimiter">{</span>
    <span class="comment">// TODO: not sure what to do here - should we just have some nodes</span>
    <span class="comment">// duplicate user key ranges?</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#30834" title="Int">clusterSize</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#27983" title="=&gt; Int">numUsers</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;More clusters than users- don\'t know how to make key split&quot;)" class="string">&quot;More clusters than users- don't know how to make key split&quot;</span><span class="delimiter">)</span>

    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#30834" title="Int">clusterSize</a> <span title="(x: Int)Int">%</span> <a href="#27976" title="=&gt; Int">replicationFactor</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>, <span title="java.lang.String(&quot;numServers must be divisible by by replicationFactor&quot;)" class="string">&quot;numServers must be divisible by by replicationFactor&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Int" id="31298">usersPerNode</a> = <a href="#27983" title="=&gt; Int">numUsers</a> <span title="(x: Int)Int">/</span> <span class="delimiter">(</span><a href="#30834" title="Int">clusterSize</a> <span title="(x: Int)Int">/</span> <a href="#27976" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[Int]]" id="31299">usersIdxs</a> = <span title="object None">None</span> <a href="#31334" title="(elem: Option[Int])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Some[Int]],Option[Int],scala.collection.immutable.IndexedSeq[Option[Int]]])scala.collection.immutable.IndexedSeq[Option[Int]]">+:</a> <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range">until</span> <a href="#30834" title="Int">clusterSize</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Some[Int])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],Some[Int],scala.collection.immutable.IndexedSeq[Some[Int]]])scala.collection.immutable.IndexedSeq[Some[Int]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Some[Int],scala.collection.immutable.IndexedSeq[Some[Int]]]" class="delimiter">(</span><a title="Int" id="31865">i</a> =&gt; <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#31865" title="Int">i</a> <span title="(x: Int)Int">*</span> <a href="#31298" title="Int">usersPerNode</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]" id="31300">usersKeySplits</a> = <a href="#31299" title="scala.collection.immutable.IndexedSeq[Option[Int]]">usersIdxs</a>.<span title="(f: Option[Int] =&gt; Option[edu.berkeley.cs.scads.piql.scadr.User])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[Int]],Option[edu.berkeley.cs.scads.piql.scadr.User],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]]])scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[edu.berkeley.cs.scads.piql.scadr.User],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]]]" class="delimiter">(</span><a href="#32129" title="Option[Int]">_</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.User)Option[edu.berkeley.cs.scads.piql.scadr.User]">map</span><span class="delimiter">(</span><a title="Int" id="32134">idx</a> =&gt; <a href="ScadrClient.scala.html#14652" title="(username: String)edu.berkeley.cs.scads.piql.scadr.User">User</a><span class="delimiter">(</span><a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#32134" title="Int">idx</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Option[edu.berkeley.cs.scads.piql.scadr.User] =&gt; Option[org.apache.avro.generic.GenericRecord])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.User]],Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]])scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]]" class="delimiter">(</span><a href="#32208" title="Option[edu.berkeley.cs.scads.piql.scadr.User]">_</a>.<span title="(f: edu.berkeley.cs.scads.piql.scadr.User =&gt; org.apache.avro.generic.GenericRecord)Option[org.apache.avro.generic.GenericRecord]">map</span><span class="delimiter">(</span><a href="#32213" title="edu.berkeley.cs.scads.piql.scadr.User">_</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]" id="31301">thoughtsKeySplits</a> = <a href="#31299" title="scala.collection.immutable.IndexedSeq[Option[Int]]">usersIdxs</a>.<span title="(f: Option[Int] =&gt; Option[edu.berkeley.cs.scads.piql.scadr.Thought])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[Int]],Option[edu.berkeley.cs.scads.piql.scadr.Thought],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]]])scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[edu.berkeley.cs.scads.piql.scadr.Thought],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]]]" class="delimiter">(</span><a href="#32261" title="Option[Int]">_</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Thought)Option[edu.berkeley.cs.scads.piql.scadr.Thought]">map</span><span class="delimiter">(</span><a title="Int" id="32266">idx</a> =&gt; <a href="ScadrClient.scala.html#14903" title="(owner: String, timestamp: Int)edu.berkeley.cs.scads.piql.scadr.Thought">Thought</a><span class="delimiter">(</span><a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#32266" title="Int">idx</a><span class="delimiter">)</span>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Option[edu.berkeley.cs.scads.piql.scadr.Thought] =&gt; Option[org.apache.avro.generic.GenericRecord])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Thought]],Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]])scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]]" class="delimiter">(</span><a href="#32368" title="Option[edu.berkeley.cs.scads.piql.scadr.Thought]">_</a>.<span title="(f: edu.berkeley.cs.scads.piql.scadr.Thought =&gt; org.apache.avro.generic.GenericRecord)Option[org.apache.avro.generic.GenericRecord]">map</span><span class="delimiter">(</span><a href="#32373" title="edu.berkeley.cs.scads.piql.scadr.Thought">_</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]" id="31302">subscriptionsKeySplits</a> = <a href="#31299" title="scala.collection.immutable.IndexedSeq[Option[Int]]">usersIdxs</a>.<span title="(f: Option[Int] =&gt; Option[edu.berkeley.cs.scads.piql.scadr.Subscription])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[Int]],Option[edu.berkeley.cs.scads.piql.scadr.Subscription],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]]])scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[edu.berkeley.cs.scads.piql.scadr.Subscription],scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]]]" class="delimiter">(</span><a href="#32417" title="Option[Int]">_</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Subscription)Option[edu.berkeley.cs.scads.piql.scadr.Subscription]">map</span><span class="delimiter">(</span><a title="Int" id="32422">idx</a> =&gt; <a href="ScadrClient.scala.html#16372" title="(owner: String, target: String)edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</a><span class="delimiter">(</span><a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#32422" title="Int">idx</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Option[edu.berkeley.cs.scads.piql.scadr.Subscription] =&gt; Option[org.apache.avro.generic.GenericRecord])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Option[edu.berkeley.cs.scads.piql.scadr.Subscription]],Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]])scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,Option[org.apache.avro.generic.GenericRecord],scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]]" class="delimiter">(</span><a href="#32485" title="Option[edu.berkeley.cs.scads.piql.scadr.Subscription]">_</a>.<span title="(f: edu.berkeley.cs.scads.piql.scadr.Subscription =&gt; org.apache.avro.generic.GenericRecord)Option[org.apache.avro.generic.GenericRecord]">map</span><span class="delimiter">(</span><a href="#32490" title="edu.berkeley.cs.scads.piql.scadr.Subscription">_</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// assume uniform distribution of tags over 8 bit ascii - not really</span>
    <span class="comment">// ideal, but we can generate the data such that this is true</span>

    <span class="keyword">var</span> <a title="Int" id="31303">size</a> = <span title="Int(256)" class="int">256</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#31303" title="Int">size</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#30834" title="Int">clusterSize</a><span class="delimiter">)</span>
      <a href="#31303" title="Int">size</a> = <a href="#31303" title="Int">size</a> <span title="(x: Int)Int">*</span> <span title="Int(256)" class="int">256</span>

    <span class="keyword">val</span> <a title="Int" id="31304">numPerNode</a> = <a href="#31303" title="Int">size</a> <span title="(x: Int)Int">/</span> <a href="#30834" title="Int">clusterSize</a>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#31304" title="Int">numPerNode</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>

    <span class="comment">// encodes i as a base 256 string. not super efficient</span>
    <span class="keyword">def</span> <a title="(i: Int)String" id="31305">toKeyString</a><span class="delimiter">(</span><a title="Int" id="32536">i</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="String">String</span> = <a href="#32536" title="Int">i</a> <span title="String" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="java.lang.String(&quot;&quot;)" class="int">0</span> =&gt; <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>
      <span class="keyword">case</span> <span title="java.lang.String">_</span> =&gt; <a href="#31305" title="(i: Int)String">toKeyString</a><span class="delimiter">(</span><a href="#32536" title="Int">i</a> <span title="(x: Int)Int">/</span> <span title="Int(256)" class="int">256</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#32536" title="Int">i</a> <span title="(x: Int)Int">%</span> <span title="Int(256)" class="int">256</span><span class="delimiter">)</span>.<span title="=&gt; Char">toChar</span>
    <span class="delimiter">}</span>

    <a href="#36632" title="(usersKeySplits: Seq[Option[org.apache.avro.generic.GenericRecord]], thoughtsKeySplits: Seq[Option[org.apache.avro.generic.GenericRecord]], subscriptionsKeySplits: Seq[Option[org.apache.avro.generic.GenericRecord]])edu.berkeley.cs.scads.piql.scadr.ScadrKeySplits">ScadrKeySplits</a><span class="delimiter">(</span><a href="#31300" title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">usersKeySplits</a>,
      <a href="#31301" title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">thoughtsKeySplits</a>,
      <a href="#31302" title="scala.collection.immutable.IndexedSeq[Option[org.apache.avro.generic.GenericRecord]]">subscriptionsKeySplits</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  case <span class="keyword">class</span> <a title="class ScadrData extends java.lang.Object with ScalaObject with Product with Serializable" id="32613">ScadrData</a><a href="#32613" title="ScalaObject" class="delimiter">(</a><a title="Seq[edu.berkeley.cs.scads.piql.scadr.User]" id="36569">userData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.User]">Seq</span><span class="delimiter">[</span>User<span class="delimiter">]</span>,
                       <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]" id="36570">thoughtData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">Seq</span><span class="delimiter">[</span>Thought<span class="delimiter">]</span>,
                       <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]" id="36571">subscriptionData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">Seq</span><span class="delimiter">[</span>Subscription<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(client: edu.berkeley.cs.scads.piql.scadr.ScadrClient)Unit" id="32565">load</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.scadr.ScadrClient" id="32574">client</a>: <a href="ScadrClient.scala.html#9584" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">ScadrClient</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#27679" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading users&quot;)" class="string">&quot;Loading users&quot;</span><span class="delimiter">)</span>
      <a href="#32574" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">client</a>.<a href="ScadrClient.scala.html#16427" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.User]">users</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.User])Unit">++=</span> <a href="#36569" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.User]">userData</a>
      <a href="#27679" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading thoughts&quot;)" class="string">&quot;Loading thoughts&quot;</span><span class="delimiter">)</span>
      <a href="#32574" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">client</a>.<a href="ScadrClient.scala.html#16429" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughts</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Thought])Unit">++=</span> <a href="#36570" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughtData</a>
      <a href="#27679" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading subscriptions&quot;)" class="string">&quot;Loading subscriptions&quot;</span><span class="delimiter">)</span>
      <a href="#32574" title="edu.berkeley.cs.scads.piql.scadr.ScadrClient">client</a>.<a href="ScadrClient.scala.html#16431" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])Unit">++=</span> <a href="#36571" title="=&gt; Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptionData</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Makes a slice of data from [startUser, endUser). Checks to make sure
   * first that start/end are valid for the given loader. Does not allow for
   * empty slices  (so startUser &amp;lt; endUser is required). Note that users
   * are indexed by 1 (so a valid start user goes from 1 to numUsers, and a
   * valid end user goes from 2 to numUsers + 1).
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startUser: Int, endUser: Int)ScadrLoader.this.ScadrData" id="27689">makeScadrData</a><span class="delimiter">(</span><a title="Int" id="32691">startUser</a>: <span title="Int">Int</span>, <a title="Int" id="32692">endUser</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="#32613" title="ScadrLoader.this.ScadrData">ScadrData</a> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span> <span title="(x: Int)Boolean">&lt;=</span> <a href="#32691" title="Int">startUser</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#32691" title="Int">startUser</a> <span title="(x: Int)Boolean">&lt;=</span> <a href="#27983" title="=&gt; Int">numUsers</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span> <span title="(x: Int)Boolean">&lt;=</span> <a href="#32692" title="Int">endUser</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#32692" title="Int">endUser</a> <span title="(x: Int)Boolean">&lt;=</span> <a href="#27983" title="=&gt; Int">numUsers</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#32691" title="Int">startUser</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#32692" title="Int">endUser</a><span class="delimiter">)</span>

    <span class="comment">// create lazy views on the data</span>

    <span class="keyword">def</span> <a title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]" id="32694">newUserIdView</a> =
      <span class="delimiter">(</span><a href="#32691" title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">startUser</a> <span title="(end: Int)scala.collection.immutable.Range">until</span> <a href="#32692" title="Int">endUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>

    <span class="keyword">def</span> <a title="(id: Int)edu.berkeley.cs.scads.piql.scadr.User" id="32695">toUser</a><span class="delimiter">(</span><a title="Int" id="32832">id</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="ScadrClient.scala.html#9575" title="edu.berkeley.cs.scads.piql.scadr.User">User</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.User" id="32833">u</a> = <a href="ScadrClient.scala.html#14652" title="(username: String)edu.berkeley.cs.scads.piql.scadr.User">User</a><span class="delimiter">(</span><a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#32832" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#32833" title="edu.berkeley.cs.scads.piql.scadr.User">u</a>.<a href="ScadrClient.scala.html#11636" title="(x$1: String)Unit">homeTown</a> = <span title="java.lang.String(&quot;hometown&quot;)" class="string">&quot;hometown&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#32832" title="Int">id</a> <span title="(x: Int)Int">%</span> <span title="Int(10)" class="int">10</span><span class="delimiter">)</span>
      <a href="#32833" title="edu.berkeley.cs.scads.piql.scadr.User">u</a>.<a href="ScadrClient.scala.html#11639" title="(x$1: String)Unit">password</a> = <span title="java.lang.String(&quot;secret&quot;)" class="string">&quot;secret&quot;</span>
      <a href="#32833" title="edu.berkeley.cs.scads.piql.scadr.User">u</a>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.scadr.User]" id="32696">userData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.User]">Seq</span><span class="delimiter">[</span>User<span class="delimiter">]</span> =
      <a href="#32694" title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUserIdView</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.User)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.User,Seq[edu.berkeley.cs.scads.piql.scadr.User]])Seq[edu.berkeley.cs.scads.piql.scadr.User]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.User,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.User,Seq[_]]]" class="delimiter">(</span><a href="#32695" title="(id: Int)edu.berkeley.cs.scads.piql.scadr.User">toUser</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]" id="32697">thoughtData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">Seq</span><span class="delimiter">[</span>Thought<span class="delimiter">]</span> =
      <a href="#32694" title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUserIdView</a>.<span title="(f: Int =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.scadr.Thought])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Thought,Seq[edu.berkeley.cs.scads.piql.scadr.Thought]])Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Thought,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]]" class="delimiter">(</span><a title="Int" id="34298">userId</a> =&gt;
        <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#27984" title="=&gt; Int">numThoughtsPerUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Thought)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Thought,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]])scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Thought,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Thought,Seq[_]]]" class="delimiter">(</span><a title="Int" id="34434">i</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.Thought" id="34435">t</a> = <a href="ScadrClient.scala.html#14903" title="(owner: String, timestamp: Int)edu.berkeley.cs.scads.piql.scadr.Thought">Thought</a><span class="delimiter">(</span><a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#34298" title="Int">userId</a><span class="delimiter">)</span>, <a href="#34434" title="Int">i</a><span class="delimiter">)</span>
          <a href="#34435" title="edu.berkeley.cs.scads.piql.scadr.Thought">t</a>.<a href="ScadrClient.scala.html#14871" title="(x$1: String)Unit">text</a> = <a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#34298" title="Int">userId</a><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; thinks &quot;)" class="string">&quot; thinks &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#34434" title="Int">i</a>
          <a href="#34435" title="edu.berkeley.cs.scads.piql.scadr.Thought">t</a>
        <span class="delimiter">}</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]" id="32698">subscriptionData</a>: <span title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">Seq</span><span class="delimiter">[</span>Subscription<span class="delimiter">]</span> = <a href="#32694" title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUserIdView</a>.<span title="(f: Int =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]])Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]]" class="delimiter">(</span><a title="Int" id="34607">userId</a> =&gt;
      <span title="(seed: Int, maxInt: Int, count: Int)Array[Int]">randomInts</span><span title="implicit scala.Predef.intArrayOps : (xs: Array[Int])scala.collection.mutable.ArrayOps[Int]" class="delimiter">(</span><a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#34607" title="Int">userId</a><span class="delimiter">)</span>.<span title="()Int">hashCode</span>, <a href="#27983" title="=&gt; Int">numUsers</a>, <a href="#34607" title="Int">userId</a> <span title="(x: Int)Int">%</span> <a href="#27985" title="=&gt; Int">numSubscriptionsPerUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.mutable.IndexedSeqView[Int,Array[Int]]">view</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Subscription)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.IndexedSeqView[Int,Array[Int]],edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Array[edu.berkeley.cs.scads.piql.scadr.Subscription]]])scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Array[edu.berkeley.cs.scads.piql.scadr.Subscription]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.TraversableView[_, Array[_]],edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Array[edu.berkeley.cs.scads.piql.scadr.Subscription]]]" class="delimiter">(</span><a title="Int" id="36097">u</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.scadr.Subscription" id="36098">s</a> = <a href="ScadrClient.scala.html#16372" title="(owner: String, target: String)edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</a><span class="delimiter">(</span><a href="#27683" title="(idx: Int)String">toUsername</a><span class="delimiter">(</span><a href="#34607" title="Int">userId</a><span class="delimiter">)</span>, <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;User%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#36097" title="Int">u</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#36098" title="edu.berkeley.cs.scads.piql.scadr.Subscription">s</a>.<a href="ScadrClient.scala.html#16316" title="(x$1: Boolean)Unit">approved</a> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#36098" title="edu.berkeley.cs.scads.piql.scadr.Subscription">s</a>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">)</span>

    <a href="#32613" title="(userData: Seq[edu.berkeley.cs.scads.piql.scadr.User], thoughtData: Seq[edu.berkeley.cs.scads.piql.scadr.Thought], subscriptionData: Seq[edu.berkeley.cs.scads.piql.scadr.Subscription])ScadrLoader.this.ScadrData">ScadrData</a><span class="delimiter">(</span><a href="#32696" title="Seq[edu.berkeley.cs.scads.piql.scadr.User]">userData</a>, <a href="#32697" title="Seq[edu.berkeley.cs.scads.piql.scadr.Thought]">thoughtData</a>, <a href="#32698" title="Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptionData</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Clients are 0-indexed
   */</span>
  <span class="keyword">def</span> <a title="(clientId: Int)ScadrLoader.this.ScadrData" id="27690">getData</a><span class="delimiter">(</span><a title="Int" id="36579">clientId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="#32613" title="ScadrLoader.this.ScadrData">ScadrData</a> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#36579" title="Int">clientId</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#36579" title="Int">clientId</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#27977" title="=&gt; Int">numClients</a><span class="delimiter">)</span>

    <span class="comment">// TODO: fix this</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#27977" title="=&gt; Int">numClients</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#27983" title="=&gt; Int">numUsers</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;More clients than user keys - don\'t know how to partition load&quot;)" class="string">&quot;More clients than user keys - don't know how to partition load&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Int" id="36581">usersPerClient</a> = <a href="#27983" title="=&gt; Int">numUsers</a> <span title="(x: Int)Int">/</span> <a href="#27977" title="=&gt; Int">numClients</a>
    <span class="keyword">val</span> <a title="Int" id="36582">startIdx</a> = <a href="#36579" title="Int">clientId</a> <span title="(x: Int)Int">*</span> <a href="#36581" title="Int">usersPerClient</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
    <a href="#27689" title="(startUser: Int, endUser: Int)ScadrLoader.this.ScadrData">makeScadrData</a><span class="delimiter">(</span><a href="#36582" title="Int">startIdx</a>, <a href="#36582" title="Int">startIdx</a> <span title="(x: Int)Int">+</span> <a href="#36581" title="Int">usersPerClient</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>