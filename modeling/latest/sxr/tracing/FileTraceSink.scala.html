<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>tracing/FileTraceSink.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> modeling

<span class="keyword">import</span> avro.runtime._
<span class="keyword">import</span> avro.marker._
<span class="keyword">import</span> comm._

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span>ArrayBlockingQueue, TimeUnit<span class="delimiter">}</span>

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.apache.avro.file.CodecFactory


<span class="keyword">class</span> <a title="class FileTraceSink extends java.lang.Object with ScalaObject" id="10294">FileTraceSink</a><a href="#10294" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="java.io.File" id="39756">traceFile</a>: <span title="java.io.File">File</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="39746">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="org.apache.avro.file.DataFileWriter[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]" id="39748">outputFile</a> = <span title="[RecordType &lt;: org.apache.avro.generic.GenericContainer](file: java.io.File, codec: Option[org.apache.avro.file.CodecFactory])(implicit schema: edu.berkeley.cs.avro.runtime.package.TypedSchema[RecordType])org.apache.avro.file.DataFileWriter[RecordType]">AvroOutFile</span><span title="(file: java.io.File, codec: Option[org.apache.avro.file.CodecFactory])(implicit schema: edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace])org.apache.avro.file.DataFileWriter[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]" class="delimiter">[</span><a href="../schema.scala.html#10262" title="edu.berkeley.cs.scads.piql.modeling.ExecutionTrace">ExecutionTrace</a><span class="delimiter">]</span><span title="(implicit r: Manifest[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace])edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]" class="delimiter">(</span><a href="#39756" title="=&gt; java.io.File">traceFile</a>, <span title="object org.apache.avro.file.CodecFactory">CodecFactory</span>.<span title="(x$1: Int)org.apache.avro.file.CodecFactory">deflateCodec</span><span title="(a: org.apache.avro.file.CodecFactory)Option[org.apache.avro.file.CodecFactory]" class="delimiter">(</span><span title="Int(5)" class="int">5</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/* A list of messages that will be written to disk async by a seperate thread */</span>
  <span class="comment">//protected val pendingTraceMessages = new ArrayBlockingQueue[ExecutionTrace](1024)</span>
	<span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]" id="39750">pendingTraceMessages</a> = <span title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]" class="keyword">new</span> <span title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]">ArrayBlockingQueue</span><span class="delimiter">[</span>ExecutionTrace<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(16384)" class="int">16384</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.lang.Thread" id="39752">ioThread</a> = <a href="#77843" title="java.lang.Thread" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Thread" id="77843">Thread</a><span class="delimiter">(</span><span title="java.lang.String(&quot;QueryTraceWriter&quot;)" class="string">&quot;QueryTraceWriter&quot;</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="77845">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#39748" title="=&gt; org.apache.avro.file.DataFileWriter[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]">outputFile</a>.<span title="(x$1: edu.berkeley.cs.scads.piql.modeling.ExecutionTrace)Unit">append</span><a href="#77853" title="()Unit" class="delimiter">(</a><a href="#39750" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]">pendingTraceMessages</a>.<span title="()edu.berkeley.cs.scads.piql.modeling.ExecutionTrace">take</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <a href="#39752" title="=&gt; java.lang.Thread">ioThread</a>.<span title="()Unit">start</span>

  <span class="keyword">def</span> <a title="(event: edu.berkeley.cs.scads.piql.modeling.TraceEvent)Boolean" id="39754">recordEvent</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.modeling.TraceEvent" id="42011">event</a>: <a href="../schema.scala.html#10265" title="edu.berkeley.cs.scads.piql.modeling.TraceEvent">TraceEvent</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.modeling.ExecutionTrace" id="77860">trace</a> = <a href="../schema.scala.html#76844" title="(timestamp: Long, thread: String, event: edu.berkeley.cs.scads.piql.modeling.TraceEvent)edu.berkeley.cs.scads.piql.modeling.ExecutionTrace">ExecutionTrace</a><span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">nanoTime</span>, <span title="object java.lang.Thread">Thread</span>.<span title="()java.lang.Thread">currentThread</span>.<span title="()java.lang.String">getName</span>, <a href="#42011" title="edu.berkeley.cs.scads.piql.modeling.TraceEvent">event</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Boolean" id="77861">success</a> = <a href="#39750" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]">pendingTraceMessages</a>.<span title="(x$1: edu.berkeley.cs.scads.piql.modeling.ExecutionTrace, x$2: Long, x$3: java.util.concurrent.TimeUnit)Boolean">offer</span><span class="delimiter">(</span><a href="#77860" title="edu.berkeley.cs.scads.piql.modeling.ExecutionTrace">trace</a>, <span title="Long(0L)" class="int">0</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#77861" title="Boolean">success</a><span class="delimiter">)</span>
        <a href="#39746" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Failed to record trace event: %s&quot;)" class="string">&quot;Failed to record trace event: %s&quot;</span>, <a href="#42011" title="edu.berkeley.cs.scads.piql.modeling.TraceEvent">event</a><span class="delimiter">)</span>
    <a href="#77861" title="Boolean">success</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="39755">flush</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#39750" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]">pendingTraceMessages</a>.<span title="()Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#77966" title="()Unit" class="delimiter">{</a>
      <a href="#39746" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Waiting for %d pendingTraceMessages to be written.&quot;)" class="string">&quot;Waiting for %d pendingTraceMessages to be written.&quot;</span>, <a href="#39750" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]">pendingTraceMessages</a>.<span title="()Int">size</span><span class="delimiter">)</span>
      <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><span title="Long(100L)" class="int">100</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#39748" title="=&gt; org.apache.avro.file.DataFileWriter[edu.berkeley.cs.scads.piql.modeling.ExecutionTrace]">outputFile</a>.<span title="()Unit">flush</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>