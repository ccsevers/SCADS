<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>experiments/PlanCompare.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> modeling

<span class="keyword">import</span> deploylib.mesos._
<span class="keyword">import</span> perf._
<span class="keyword">import</span> comm._
<span class="keyword">import</span> piql.plans._
<span class="keyword">import</span> storage._
<span class="keyword">import</span> avro.runtime._
<span class="keyword">import</span> avro.marker._
<span class="keyword">import</span> org.apache.zookeeper.CreateMode

<span class="keyword">import</span> edu.berkeley.cs.scads.piql.scadr.Subscription

case <span class="keyword">class</span> <a title="class PlanCompareResult extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with ScalaObject with Product with Serializable" id="68427">PlanCompareResult</a><a href="#68427" title="ScalaObject" class="delimiter">(</a><a href="#68427" title="()edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="85651" class="keyword">var</a> <a title="String" id="68178">hostname</a>: <span title="String">String</span>,
			     <span class="keyword">var</span> <a title="Long" id="68179">timestamp</a>: <span title="Long">Long</span>,
			     <span class="keyword">var</span> <a title="Int" id="68180">iteration</a>: <span title="Int">Int</span>,
			     <span class="keyword">var</span> <a title="Int" id="68181">point</a>: <span title="Int">Int</span>,
			     <span class="keyword">var</span> <a title="String" id="68182">query</a>: <span title="String">String</span>,
			     <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" id="68183">config</a>: <a href="#68423" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">PlanCompareTask</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroPair">AvroPair</span> <span class="delimiter">{</span>
  <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="64171">responseTimes</a>: <span title="edu.berkeley.cs.scads.perf.Histogram">Histogram</span> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">var</span> <a title="Long" id="64174">messagesSent</a>: <span title="Long">Long</span> = _
<span class="delimiter">}</span>
		  
<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.piql.modeling.PlanCompare" id="9727">PlanCompare</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> <a href="Experiments.scala.html#9710" title="object edu.berkeley.cs.scads.piql.modeling.Experiments">Experiments</a>._

  <span class="keyword">def</span> <a title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster" id="64358">newScadsCluster</a><span class="delimiter">(</span><a title="Int" id="64398">size</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="64400">clusterRoot</a> = <a href="Experiments.scala.html#50234" title="=&gt; deploylib.mesos.Cluster">cluster</a>.<a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="64402">zooKeeperRoot</a>.<a href="#64402" title="Int" id="64404">getOrCreate</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="64410" class="delimiter">(</a><a title="java.lang.String(&quot;scads&quot;)" id="64403" class="string">&quot;scads&quot;</a><span class="delimiter">)</span>.<a href="#64410" title="Array[Byte]" id="64413">createChild</a><span class="delimiter">(</span><a title="java.lang.String(&quot;experimentCluster&quot;)" id="64411" class="string">&quot;experimentCluster&quot;</a>, mode = CreateMode.<a title="org.apache.zookeeper.CreateMode(value PERSISTENT_SEQUENTIAL)" id="64412">PERSISTENT_SEQUENTIAL</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.comm.JvmMainTask]" id="64401">serverProcs</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; edu.berkeley.cs.scads.comm.JvmMainTask)(implicit evidence$9: scala.reflect.ClassManifest[edu.berkeley.cs.scads.comm.JvmMainTask])Array[edu.berkeley.cs.scads.comm.JvmMainTask]">fill</span><span class="delimiter">(</span><a href="#64398" title="Int">size</a><span class="delimiter">)</span><span title="(clazz: java.lang.Class[_])scala.reflect.ClassManifest[edu.berkeley.cs.scads.comm.JvmMainTask]" class="delimiter">(</span><span title="(clusterAddress: String, dbDir: Option[String], cachePercentage: Option[Int], name: Option[String])edu.berkeley.cs.scads.storage.ScalaEngineTask">ScalaEngineTask</span><span class="delimiter">(</span>clusterAddress=<a href="#64400" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="=&gt; java.lang.String">canonicalAddress</span><span class="delimiter">)</span>.<a href="Experiments.scala.html#50239" title="(implicit classSource: Seq[edu.berkeley.cs.scads.comm.ClassSource])edu.berkeley.cs.scads.comm.JvmMainTask">toJvmTask</a><span class="delimiter">)</span>

    <a href="Experiments.scala.html#50234" title="=&gt; deploylib.mesos.Cluster">cluster</a>.<span title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</span>.<span title="(processes: Seq[edu.berkeley.cs.scads.comm.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#64401" title="(xs: Array[edu.berkeley.cs.scads.comm.JvmMainTask])scala.collection.mutable.WrappedArray[edu.berkeley.cs.scads.comm.JvmMainTask]">serverProcs</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.ScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">(</span><a href="#64400" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64359">run</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="64616">scadsCluster</a> = <a href="#64358" title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster">newScadsCluster</a><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.JvmMainTask" id="64617">compareTask</a> = <a href="#68423" title="(clusterAddress: String, resultClusterAddress: String, replicationFactor: Int, iterations: Int, points: Int, stepSize: Int, numExecutions: Int, numFollowers: Int, fetchSize: Int, warmupTimeMin: Int)edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#64616" title="edu.berkeley.cs.scads.storage.ScadsCluster">scadsCluster</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<span title="=&gt; java.lang.String">canonicalAddress</span>,
      resultClusterAddress = <a href="Experiments.scala.html#50231" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">resultClusterAddress</a>.<span title="=&gt; java.lang.String">canonicalAddress</span>
    <span class="delimiter">)</span>.<a href="Experiments.scala.html#50239" title="(implicit classSource: Seq[edu.berkeley.cs.scads.comm.ClassSource])edu.berkeley.cs.scads.comm.JvmMainTask">toJvmTask</a>
    <a href="Experiments.scala.html#50240" title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</a>.<span title="(processes: Seq[edu.berkeley.cs.scads.comm.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#64617" title="edu.berkeley.cs.scads.comm.JvmMainTask">compareTask</a> <a href="#64726" title="(x: edu.berkeley.cs.scads.comm.JvmMainTask)List[edu.berkeley.cs.scads.comm.JvmMainTask]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64360">testLocal</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="64735">testCluster</a> = <span title="object edu.berkeley.cs.scads.storage.TestScalaEngine">TestScalaEngine</span>.<span title="(numNodes: Int)edu.berkeley.cs.scads.storage.ManagedScadsCluster">newScadsCluster</span><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<span title="=&gt; java.lang.String">canonicalAddress</span>
    <a href="#64663" title="Int" id="64753">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#64735" title="java.lang.String" id="64744">testCluster</a>,
      resultClusterAddress = <a href="#64735" title="java.lang.String" id="64745">testCluster</a>,
      warmupTimeMin = <a title="Int(0)" id="64746" class="int">0</a>
    <span class="delimiter">)</span>.<a href="#64230" title="()Unit">run</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64361">results</a> = <a href="Experiments.scala.html#50237" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">resultsCluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">[</span><a href="#68427" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompareResults&quot;)" class="string">&quot;planCompareResults&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64363">allResults</a> = <a href="#64361" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">results</a>.<span title="(startKey: Option[org.apache.avro.generic.IndexedRecord], endKey: Option[org.apache.avro.generic.IndexedRecord])Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">iterateOverRange</span><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64364">goodResults</a> = <a href="#64363" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">allResults</a>

  <span class="keyword">def</span> <a title="(quantile: Double, maxItems: Int)Seq[(String, Int, Int, Long, Long, Int)]" id="64365">graphPoints</a><span class="delimiter">(</span><a title="Double" id="64766">quantile</a>: <span title="Double">Double</span> = <span title="Double(0.99)" class="double">0.99</span>, <a title="Int" id="64767">maxItems</a>: <span title="Int">Int</span> = <span title="Int(200)" class="int">200</span><span class="delimiter">)</span> = <a href="#64364" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">goodResults</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">toSeq</span>
    .<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; (String, Int))scala.collection.immutable.Map[(String, Int),Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]">groupBy</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="64783">r</a> =&gt; <span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#64783" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#68182" title="=&gt; String">query</a>, <a href="#64783" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#68181" title="=&gt; Int">point</a> <span title="(x: Int)Int">*</span> <a href="#64783" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#68183" title="=&gt; edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">config</a>.<a href="#64666" title="=&gt; Int">stepSize</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])]">toSeq</span>
    .<span title="(f: ((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]) =&gt; (String, Int, Int, Long, Long, Int))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])],(String, Int, Int, Long, Long, Int),Seq[(String, Int, Int, Long, Long, Int)]])Seq[(String, Int, Int, Long, Long, Int)]">map</span> <a href="#64835" title="(String, Int, Int, Long, Long, Int)" class="delimiter">{</a> 
      <span class="keyword">case</span> <span title="(String, Int, Int, Long, Long, Int)" class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="64840">query</a>, <a title="Int" id="64841">size</a><span class="delimiter">)</span>, <a title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64842">data</a><span class="delimiter">)</span> =&gt;
	<span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64843">truncData</a> = <a href="#64842" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">data</a>.<span title="(n: Int)Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">take</span><span class="delimiter">(</span><span title="Int(200)" class="int">200</span><span class="delimiter">)</span>
	<span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="64844">aggHist</a> = <a href="#64843" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; edu.berkeley.cs.scads.perf.Histogram)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],edu.berkeley.cs.scads.perf.Histogram,Seq[edu.berkeley.cs.scads.perf.Histogram]])Seq[edu.berkeley.cs.scads.perf.Histogram]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.perf.Histogram,Seq[edu.berkeley.cs.scads.perf.Histogram]]" class="delimiter">(</span><a href="#64861" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#64171" title="=&gt; edu.berkeley.cs.scads.perf.Histogram">responseTimes</a><span class="delimiter">)</span>.<span title="(op: (edu.berkeley.cs.scads.perf.Histogram, edu.berkeley.cs.scads.perf.Histogram) =&gt; edu.berkeley.cs.scads.perf.Histogram)edu.berkeley.cs.scads.perf.Histogram">reduceLeft</span><span class="delimiter">(</span><a href="#64886" title="edu.berkeley.cs.scads.perf.Histogram">_</a> <span title="(left: edu.berkeley.cs.scads.perf.Histogram)edu.berkeley.cs.scads.perf.Histogram">+</span> <a href="#64887" title="edu.berkeley.cs.scads.perf.Histogram">_</a><span class="delimiter">)</span>
	<span title="(_1: String, _2: Int, _3: Int, _4: Long, _5: Long, _6: Int)(String, Int, Int, Long, Long, Int)" class="delimiter">(</span><a href="#64840" title="String">query</a>, <a href="#64841" title="Int">size</a>, <a href="#64844" title="edu.berkeley.cs.scads.perf.Histogram">aggHist</a>.<span title="(fraction: Double)Int">quantile</span><span class="delimiter">(</span><a href="#64766" title="Double">quantile</a><span class="delimiter">)</span>, <a href="#64844" title="edu.berkeley.cs.scads.perf.Histogram">aggHist</a>.<span title="=&gt; Long">totalRequests</span>, <a href="#64843" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],Long,Seq[Long]])Seq[Long]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Long,Seq[Long]]" class="delimiter">(</span><a href="#64910" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#64174" title="=&gt; Long">messagesSent</a><span class="delimiter">)</span>.<span title="(implicit num: Numeric[Long])Long">sum</span>, <a href="#64843" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> 
    <span class="delimiter">}</span>
    .<span title="(f: (String, Int, Int, Long, Long, Int) =&gt; (String, Int))(implicit ord: scala.math.Ordering[(String, Int)])Seq[(String, Int, Int, Long, Long, Int)]">sortBy</span><span title="(implicit ord1: scala.math.Ordering[String], implicit ord2: scala.math.Ordering[Int])scala.math.Ordering[(String, Int)]" class="delimiter">(</span><a title="(String, Int, Int, Long, Long, Int)" id="64979">r</a> =&gt; <span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#64979" title="(String, Int, Int, Long, Long, Int)">r</a>.<span title="=&gt; String">_1</span>, <a href="#64979" title="(String, Int, Int, Long, Long, Int)">r</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64366">backupData</a> = <a href="Experiments.scala.html#50259" title="avroIterWriter extends java.lang.Object" id="65275">allResults</a>.<a href="Experiments.scala.html#65274" title="Option[org.apache.avro.file.CodecFactory]" id="65277">toAvroFile</a><span title="(implicit r: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompare&quot;)" class="string">&quot;planCompare&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <a title="java.io.File" id="65276">+</a> <span title="java.lang.String(&quot;.avro&quot;)" class="string">&quot;.avro&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Seq[(Int, String, Long)]" id="64367">queryCounts</a> = <a href="#64363" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">allResults</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">toSeq</span>
    .<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; (Int, String))scala.collection.immutable.Map[(Int, String),Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]">groupBy</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="65306">r</a> =&gt; <span title="(_1: Int, _2: String)(Int, String)" class="delimiter">(</span><a href="#65306" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#68181" title="=&gt; Int">point</a>, <a href="#65306" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#68182" title="=&gt; String">query</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])]">toSeq</span>
    .<span title="(f: ((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]) =&gt; (Int, String, Long))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])],(Int, String, Long),Seq[(Int, String, Long)]])Seq[(Int, String, Long)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Int, String, Long),Seq[(Int, String, Long)]]" class="delimiter">(</span><a title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])" id="65354">r</a> =&gt; <span title="(_1: Int, _2: String, _3: Long)(Int, String, Long)" class="delimiter">(</span><a href="#65354" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; (Int, String)">_1</span>.<span title="=&gt; Int">_1</span>, <a href="#65354" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; (Int, String)">_1</span>.<span title="=&gt; String">_2</span> , <a href="#65354" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">_2</span>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],Long,Seq[Long]])Seq[Long]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Long,Seq[Long]]" class="delimiter">(</span><a href="#65377" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#64171" title="=&gt; edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>.<span title="=&gt; Long">totalRequests</span><span class="delimiter">)</span>.<span title="(implicit num: Numeric[Long])Long">sum</span><span class="delimiter">)</span><span class="delimiter">)</span>
    .<span title="(f: (Int, String, Long) =&gt; Int)(implicit ord: scala.math.Ordering[Int])Seq[(Int, String, Long)]">sortBy</span><span title="object scala.math.Ordering.Int" class="delimiter">(</span><a title="(Int, String, Long)" id="65437">r</a> =&gt; <a href="#65437" title="(Int, String, Long)">r</a>.<span title="=&gt; Int">_1</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64368">ladyGaga</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="65496">scadsCluster</a> = <a href="#64358" title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster">newScadsCluster</a><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.JvmMainTask" id="65497">compareTask</a> = <a href="#64663" title="Int" id="65515">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#65496" title="edu.berkeley.cs.scads.storage.ScadsCluster">scadsCluster</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<a title="java.lang.String" id="65506">canonicalAddress</a>,
      resultClusterAddress = <a href="Experiments.scala.html#50231" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">resultClusterAddress</a>.<a title="java.lang.String" id="65507">canonicalAddress</a>,
      iterations=<a title="Int(1)" id="65508" class="int">1</a>,
      points=<a title="Int(1)" id="65509" class="int">1</a>,
      stepSize=<a title="Int(12463286)" id="65510" class="int">12463286</a>, <span class="comment">//# of followers on August 9th, 2011 10:35PM</span>
      numExecutions=<a title="Int(20)" id="65511" class="int">20</a>
    <span class="delimiter">)</span>.<a href="Experiments.scala.html#50239" title="(implicit classSource: Seq[edu.berkeley.cs.scads.comm.ClassSource])edu.berkeley.cs.scads.comm.JvmMainTask">toJvmTask</a>
    <a href="Experiments.scala.html#50240" title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</a>.<span title="(processes: Seq[edu.berkeley.cs.scads.comm.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#65497" title="edu.berkeley.cs.scads.comm.JvmMainTask">compareTask</a> <a href="#65517" title="(x: edu.berkeley.cs.scads.comm.JvmMainTask)List[edu.berkeley.cs.scads.comm.JvmMainTask]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Mesos task to compare the response time of different physical plans for
 * the following SCADr query:
 * 
 * SELECT * FROM Subscriptions
 * WHERE owner = &lt;activeUser&gt; AND target IN [1]
 */</span>
case <span class="keyword">class</span> <a href="#94659" title="class PlanCompareTask extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with deploylib.mesos.AvroTask with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="68423">PlanCompareTask</a><a href="#68423" title="ScalaObject" class="delimiter">(</a><a href="#68423" title="()edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" id="85661" class="keyword">var</a> <a title="String" id="64661">clusterAddress</a>: <span title="String">String</span>,
			   <span class="keyword">var</span> <a title="String" id="64662">resultClusterAddress</a>: <span title="String">String</span>,
			   <span class="keyword">var</span> <a title="Int" id="64663">replicationFactor</a>: <span title="Int">Int</span> = <span title="Int(2)" class="int">2</span>,
			   <span class="keyword">var</span> <a title="Int" id="64664">iterations</a>: <span title="Int">Int</span> = <span title="Int(200)" class="int">200</span>,
			   <span class="keyword">var</span> <a title="Int" id="64665">points</a>: <span title="Int">Int</span> = <span title="Int(20)" class="int">20</span>,
			   <span class="keyword">var</span> <a title="Int" id="64666">stepSize</a>: <span title="Int">Int</span> = <span title="Int(250)" class="int">250</span>,
			   <span class="keyword">var</span> <a title="Int" id="64667">numExecutions</a>: <span title="Int">Int</span> = <span title="Int(1000)" class="int">1000</span>,
			   <span class="keyword">var</span> <a title="Int" id="64668">numFollowers</a>: <span title="Int">Int</span> = <span title="Int(50)" class="int">50</span>,
			   <span class="keyword">var</span> <a title="Int" id="64669">fetchSize</a>: <span title="Int">Int</span> = <span title="Int(1000)" class="int">1000</span>,
			   <span class="keyword">var</span> <a title="Int" id="64670">warmupTimeMin</a>: <span title="Int">Int</span> = <span title="Int(3)" class="int">3</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="deploylib.mesos.AvroTask">AvroTask</span> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="delimiter">{</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#64666" title="=&gt; Int">stepSize</a> <span title="(x: Int)Boolean">&gt;=</span> <a href="#64668" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()Unit" id="64230">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" id="65570">cluster</a> = <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">ExperimentalScadsCluster</span><span class="delimiter">(</span><span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#64661" title="=&gt; String">clusterAddress</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#65570" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="(clusterSize: Int)Unit">blockUntilReady</span><span class="delimiter">(</span><a href="#64663" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="65571">resultCluster</a> = <span title="edu.berkeley.cs.scads.storage.ScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">(</span><span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#64662" title="=&gt; String">resultClusterAddress</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="65572">results</a> = <a href="#65571" title="edu.berkeley.cs.scads.storage.ScadsCluster">resultCluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">[</span><a href="#68427" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompareResults&quot;)" class="string">&quot;planCompareResults&quot;</span><span class="delimiter">)</span>
    
    <span class="comment">/**
     * Create the partition scheme for subscriptions to be a single partition over
     * the specified number of replicas
     */</span>
    <span class="keyword">val</span> <a title="List[(None.type, List[edu.berkeley.cs.scads.comm.StorageService])]" id="65573">partitions</a> = <span title="(_1: None.type, _2: List[edu.berkeley.cs.scads.comm.StorageService])(None.type, List[edu.berkeley.cs.scads.comm.StorageService])" class="delimiter">(</span><span title="object None">None</span>, <a href="#65570" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="()List[edu.berkeley.cs.scads.comm.StorageService]">getAvailableServers</span>.<span title="(n: Int)List[edu.berkeley.cs.scads.comm.StorageService]">take</span><span class="delimiter">(</span><a href="#64663" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#65596" title="(x: (None.type, List[edu.berkeley.cs.scads.comm.StorageService]))List[(None.type, List[edu.berkeley.cs.scads.comm.StorageService])]">::</a> <span title="object Nil">Nil</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" id="65574">subscriptions</a> = <a href="#65570" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</span><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">(</span><span title="java.lang.String(&quot;subscriptions&quot;)" class="string">&quot;subscriptions&quot;</span><span class="delimiter">)</span>
    
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.plans.FixedLimit" id="65575">limit</a> = <span title="(count: Int)edu.berkeley.cs.scads.piql.plans.FixedLimit">FixedLimit</span><span class="delimiter">(</span><a href="#64668" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.plans.FixedLimit" id="65576">fetchLimit</a> = <span title="(count: Int)edu.berkeley.cs.scads.piql.plans.FixedLimit">FixedLimit</span><span class="delimiter">(</span><a href="#64669" title="=&gt; Int">fetchSize</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="65577">activeUser</a> = <a href="#64232" title="(i: Int)String">toUser</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" id="65578">executor</a> = <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">ParallelExecutor</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="65579">naiveQuery</a> =
      <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">OptimizedQuery</span><span class="delimiter">(</span>
	<span title="(a: java.lang.String)Option[java.lang.String]" class="string">&quot;NaiveFollowing&quot;</span>,
	   <span title="(count: edu.berkeley.cs.scads.piql.plans.Limit, child: edu.berkeley.cs.scads.piql.plans.QueryPlan)edu.berkeley.cs.scads.piql.plans.LocalStopAfter">LocalStopAfter</span><span class="delimiter">(</span><a href="#65575" title="edu.berkeley.cs.scads.piql.plans.FixedLimit">limit</a>,
	     <span title="(predicate: edu.berkeley.cs.scads.piql.plans.Predicate, child: edu.berkeley.cs.scads.piql.plans.QueryPlan)edu.berkeley.cs.scads.piql.plans.LocalSelection">LocalSelection</span><span class="delimiter">(</span><span title="(v1: edu.berkeley.cs.scads.piql.plans.Value, v2: edu.berkeley.cs.scads.piql.plans.Value)edu.berkeley.cs.scads.piql.plans.InPredicate">InPredicate</span><span class="delimiter">(</span><span title="(recordPosition: Int, fieldPosition: Int)edu.berkeley.cs.scads.piql.plans.AttributeValue">AttributeValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>,<span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, <span title="(ordinal: Int)edu.berkeley.cs.scads.piql.plans.ParameterValue">ParameterValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span>,
	       <span title="(namespace: edu.berkeley.cs.scads.piql.package.Namespace, keyPrefix: edu.berkeley.cs.scads.piql.package.KeyGenerator, limit: edu.berkeley.cs.scads.piql.plans.Limit, ascending: Boolean)edu.berkeley.cs.scads.piql.plans.IndexScan">IndexScan</span><span class="delimiter">(</span><a href="#65574" title="(ns: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.piql.package#Namespace">subscriptions</a>, <a href="#65577" title="String">activeUser</a> <a href="#65787" title="(x: edu.berkeley.cs.scads.piql.plans.ConstantValue)List[edu.berkeley.cs.scads.piql.plans.ConstantValue]">::</a> <span title="object Nil">Nil</span>, <span title="(count: Int)edu.berkeley.cs.scads.piql.plans.FixedLimit">FixedLimit</span><span class="delimiter">(</span><span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>,
        <a href="#65578" title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">executor</a><span class="delimiter">)</span>
   
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="65580">piqlQuery</a> =
      <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">OptimizedQuery</span><span class="delimiter">(</span>
	<span title="(a: java.lang.String)Option[java.lang.String]" class="string">&quot;PiqlFollowing&quot;</span>,
	<span title="(namespace: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, child: edu.berkeley.cs.scads.piql.plans.QueryPlan)edu.berkeley.cs.scads.piql.plans.IndexLookupJoin">IndexLookupJoin</span><span class="delimiter">(</span><a href="#65574" title="(ns: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.piql.package#Namespace">subscriptions</a>, 
		        <span title="(v: Any)edu.berkeley.cs.scads.piql.plans.ConstantValue">ConstantValue</span><span class="delimiter">(</span><a href="#65577" title="String">activeUser</a><span class="delimiter">)</span> <a href="#65868" title="(x: Product with Serializable with edu.berkeley.cs.scads.piql.plans.Value)List[Product with Serializable with edu.berkeley.cs.scads.piql.plans.Value]">::</a> <span title="(recordPosition: Int, fieldPosition: Int)edu.berkeley.cs.scads.piql.plans.AttributeValue">AttributeValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>,<span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#65871" title="(x: edu.berkeley.cs.scads.piql.plans.AttributeValue)List[edu.berkeley.cs.scads.piql.plans.AttributeValue]">::</a> <span title="object Nil">Nil</span>, 
			<span title="(parameterOrdinal: Int, wrap: Boolean)edu.berkeley.cs.scads.piql.plans.LocalIterator">LocalIterator</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span>,
	<a href="#65578" title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">executor</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]" id="65581">queries</a> = <a href="#65579" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">naiveQuery</a> <a href="#65900" title="(x: edu.berkeley.cs.scads.piql.opt.OptimizedQuery)List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">::</a> <a href="#65580" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">piqlQuery</a> <a href="#65901" title="(x: edu.berkeley.cs.scads.piql.opt.OptimizedQuery)List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">::</a> <span title="object Nil">Nil</span>

    <span class="keyword">val</span> <a title="scala.util.Random" id="65582">rand</a> = <span title="()scala.util.Random" class="keyword">new</span> scala.util.<span title="scala.util.Random">Random</span>
    <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#64664" title="=&gt; Int">iterations</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="66059">iteration</a> =&gt; <span class="delimiter">{</span>
      <a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining iteration %d&quot;)" class="string">&quot;Begining iteration %d&quot;</span>, <a href="#66059" title="Int">iteration</a><span class="delimiter">)</span>
      <span class="comment">/* clear namespaces by reseting partition scheme */</span>
      <a href="#65574" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#65574" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="()Unit">open</span><span class="delimiter">(</span><span class="delimiter">)</span>

      <a href="#65574" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])])Unit">setPartitionScheme</span><span class="delimiter">(</span><a href="#65573" title="List[(None.type, List[edu.berkeley.cs.scads.comm.StorageService])]">partitions</a><span class="delimiter">)</span>
      <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#65574" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">getRange</span><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, limit=<span title="(a: Int)Option[Int]" class="int">1</span><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#64665" title="=&gt; Int">points</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="66209">point</a> =&gt; <span class="delimiter">{</span>
	<span class="comment">/* bulkload more subscriptions */</span>
	<span class="keyword">val</span> <a title="Int" id="66210">minUser</a> = <span class="delimiter">(</span><a href="#66209" title="Int">point</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(x: Int)Int">*</span> <a href="#64666" title="=&gt; Int">stepSize</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
	<span class="keyword">val</span> <a title="Int" id="66211">maxUser</a> = <a href="#66209" title="Int">point</a> <span title="(x: Int)Int">*</span> <a href="#64666" title="=&gt; Int">stepSize</a>
	<a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Measuring with %d subscriptions&quot;)" class="string">&quot;Measuring with %d subscriptions&quot;</span>, <a href="#66211" title="Int">maxUser</a><span class="delimiter">)</span>

	<a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading data for subscriptions %d to %d&quot;)" class="string">&quot;Loading data for subscriptions %d to %d&quot;</span>, <a href="#66210" title="Int">minUser</a>, <a href="#66211" title="Int">maxUser</a><span class="delimiter">)</span>
	<span class="keyword">val</span> <a title="view extends java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]" id="66212">newUsers</a> = <span class="delimiter">(</span><a href="#66210" title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">minUser</a> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#66211" title="Int">maxUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>
	<span class="keyword">val</span> <a title="scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]" id="66213">data</a> = <a href="#66212" title="view extends java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUsers</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Subscription)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]])scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]]" class="delimiter">(</span><a title="Int" id="67275">u</a> =&gt; <span title="(owner: String, target: String)edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</span><span class="delimiter">(</span><a href="#65577" title="String">activeUser</a>, <a href="#64232" title="(i: Int)String">toUser</a><span class="delimiter">(</span><a href="#67275" title="Int">u</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
	<a href="#65574" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])Unit">++=</span> <a href="#66213" title="scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]">data</a>
	<a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Data size: %d&quot;)" class="string">&quot;Data size: %d&quot;</span>, <a href="#65574" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(startKey: Option[org.apache.avro.generic.IndexedRecord], endKey: Option[org.apache.avro.generic.IndexedRecord])Iterator[edu.berkeley.cs.scads.piql.scadr.Subscription]">iterateOverRange</span><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>

	<span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#66059" title="Int">iteration</a> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#66209" title="Int">point</a> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	  <a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining warmup&quot;)" class="string">&quot;Begining warmup&quot;</span><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="Long" id="67868">startTime</a> = <a href="#64231" title="=&gt; Long">currentTime</a>
	  <span class="keyword">val</span> <a title="Seq[String]" id="67869">users</a> = <a href="#64233" title="(maxUser: Int, size: Int)Seq[String]">randomUserList</a><span class="delimiter">(</span><span title="Int(10)" class="int">10</span>,<span title="Int(10)" class="int">10</span><span class="delimiter">)</span>
	  <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#64231" title="=&gt; Long">currentTime</a> <span title="(x: Long)Long">-</span> <a href="#67868" title="Long">startTime</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#64670" title="=&gt; Int">warmupTimeMin</a> <span title="(x: Int)Int">*</span> <span title="Int(60)" class="int">60</span> <span title="(x: Int)Int">*</span> <span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    <a href="#65581" title="List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">queries</a>.<span title="(f: edu.berkeley.cs.scads.piql.opt.OptimizedQuery =&gt; edu.berkeley.cs.scads.piql.package.QueryResult)Unit">foreach</span><a href="#67952" title="()Unit" class="delimiter">(</a><a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="67999">q</a> =&gt; <a href="#67999" title="(args: Any*)edu.berkeley.cs.scads.piql.package.QueryResult">q</a><span class="delimiter">(</span><a href="#67869" title="Seq[String]">users</a><span class="delimiter">)</span><span class="delimiter">)</span>
	  <span class="delimiter">}</span>
	<span class="delimiter">}</span>

	<span class="comment">/* measure response time for each query given the current state of the db */</span>
	<a href="#65572" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">results</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])Unit">++=</span>  <a href="#65581" title="List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">queries</a>.<span title="(f: edu.berkeley.cs.scads.piql.opt.OptimizedQuery =&gt; edu.berkeley.cs.scads.piql.modeling.PlanCompareResult)(implicit bf: scala.collection.generic.CanBuildFrom[List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery],edu.berkeley.cs.scads.piql.modeling.PlanCompareResult,TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]])TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.piql.modeling.PlanCompareResult,List[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="68020">query</a> =&gt; <span class="delimiter">{</span>
	  <a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Running %s %d times&quot;)" class="string">&quot;Running %s %d times&quot;</span>, <a href="#68020" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">query</a>.<span title="=&gt; Option[String]">name</span>, <a href="#64667" title="=&gt; Int">numExecutions</a><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="68021">responseTimes</a> = <span title="(bucketSize: Int, bucketCount: Int)edu.berkeley.cs.scads.perf.Histogram">Histogram</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span>,<span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>

	  <span class="keyword">val</span> <a title="Long" id="68022">startMessages</a> = <span title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</span>.<span title="=&gt; Long">futureCount</span>
	  <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#64667" title="=&gt; Int">numExecutions</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.perf.Histogram)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="68149">i</a> =&gt; <span class="delimiter">{</span>
	    <span class="keyword">val</span> <a title="Seq[String]" id="68150">users</a> = <a href="#64233" title="(maxUser: Int, size: Int)Seq[String]">randomUserList</a><span class="delimiter">(</span><a href="#66211" title="Int">maxUser</a>, <a href="#64668" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>

	    <span class="keyword">val</span> <a title="Long" id="68151">startTime</a> = <a href="#64231" title="=&gt; Long">currentTime</a>
	    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.QueryResult" id="68152">answer</a> = <a href="#68020" title="(args: Any*)edu.berkeley.cs.scads.piql.package.QueryResult">query</a><span class="delimiter">(</span><a href="#68150" title="Seq[String]">users</a><span class="delimiter">)</span>
	    <a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Query Result: %s&quot;)" class="string">&quot;Query Result: %s&quot;</span>, <a href="#68152" title="edu.berkeley.cs.scads.piql.package.QueryResult">answer</a><span class="delimiter">)</span>
	    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#68152" title="edu.berkeley.cs.scads.piql.package.QueryResult">answer</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#64668" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>
	    <span class="keyword">var</span> <a title="Long" id="68153">endTime</a> = <a href="#64231" title="=&gt; Long">currentTime</a>

	    <a href="#68021" title="edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>.<span title="(value: Long)edu.berkeley.cs.scads.perf.Histogram">add</span><span class="delimiter">(</span><a href="#68153" title="Long">endTime</a> <span title="(x: Long)Long">-</span> <a href="#68151" title="Long">startTime</a><span class="delimiter">)</span>
	  <span class="delimiter">}</span><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="Long" id="68023">endMessages</a> = <span title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</span>.<span title="=&gt; Long">futureCount</span>
	  <a href="#68423" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Messages sent: %d&quot;)" class="string">&quot;Messages sent: %d&quot;</span>, <a href="#68023" title="Long">endMessages</a> <span title="(x: Long)Long">-</span> <a href="#68022" title="Long">startMessages</a><span class="delimiter">)</span>

	  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="68024">result</a> = <a href="#68427" title="(hostname: String, timestamp: Long, iteration: Int, point: Int, query: String, config: edu.berkeley.cs.scads.piql.modeling.PlanCompareTask)edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">(</span>
	    java.net.<span title="object java.net.InetAddress">InetAddress</span>.<span title="()java.net.InetAddress">getLocalHost</span>.<span title="()java.lang.String">getHostName</span>,
	    <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>,
	    <a href="#66059" title="Int">iteration</a>,
	    <a href="#66209" title="Int">point</a>,
	    <a href="#68020" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">query</a>.<span title="=&gt; Option[String]">name</span>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="java.lang.String(&quot;unnamed&quot;)" class="string">&quot;unnamed&quot;</span><span class="delimiter">)</span>,
	    <a href="#68423" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" class="keyword">this</a><span class="delimiter">)</span>
	  <a href="#68024" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>.<a href="#64171" title="(x$1: edu.berkeley.cs.scads.perf.Histogram)Unit">responseTimes</a> = <a href="#68021" title="edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>
	  <a href="#68024" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>.<a href="#64174" title="(x$1: Long)Unit">messagesSent</a> = <a href="#68023" title="Long">endMessages</a> <span title="(x: Long)Long">-</span> <a href="#68022" title="Long">startMessages</a>
	  <a href="#68024" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>
	<span class="delimiter">}</span><span class="delimiter">)</span>	
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>	
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="=&gt; Long" id="64231">currentTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">nanoTime</span> <span title="(x: Int)Long">/</span> <span title="Int(1000000)" class="int">1000000</span>
  <span class="keyword">def</span> <a title="(i: Int)String" id="64232">toUser</a><span class="delimiter">(</span><a title="Int" id="65626">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;User%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#65626" title="Int">i</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(maxUser: Int, size: Int)Seq[String]" id="64233">randomUserList</a><span class="delimiter">(</span><a title="Int" id="67879">maxUser</a>: <span title="Int">Int</span>, <a title="Int" id="67880">size</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[Int]" id="67883">nums</a> = <span title="()scala.collection.mutable.HashSet[Int]" class="keyword">new</span> collection.mutable.<span title="scala.collection.mutable.HashSet[Int]">HashSet</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="67884">pos</a> = <span title="Int(0)" class="int">0</span>

    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#67884" title="Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#67880" title="Int">size</a><span class="delimiter">)</span> <a href="#67885" title="()Unit" class="delimiter">{</a>
      <span class="keyword">val</span> <a title="Int" id="67891">randNum</a> = scala.util.<span title="object scala.util.Random">Random</span>.<span title="(n: Int)Int">nextInt</span><span class="delimiter">(</span><a href="#67879" title="Int">maxUser</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><span class="delimiter">(</span><a href="#67883" title="scala.collection.mutable.HashSet[Int]">nums</a> <span title="(elem: Int)Boolean">contains</span> <a href="#67891" title="Int">randNum</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// TODO: use a set here</span>
        <a href="#67883" title="(elem: Int, included: Boolean)Unit">nums</a><span class="delimiter">(</span><a href="#67891" title="Int">randNum</a><span class="delimiter">)</span> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#67884" title="Int">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#67883" title="scala.collection.mutable.HashSet[Int]">nums</a>.<span title="=&gt; Seq[Int]">toSeq</span>.<span title="(f: Int =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Int],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="#64232" title="(i: Int)String">toUser</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>