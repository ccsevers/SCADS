<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>experiments/PlanCompare.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> modeling

<span class="keyword">import</span> deploylib.mesos._
<span class="keyword">import</span> perf._
<span class="keyword">import</span> comm._
<span class="keyword">import</span> piql.plans._
<span class="keyword">import</span> storage._
<span class="keyword">import</span> avro.runtime._
<span class="keyword">import</span> avro.marker._
<span class="keyword">import</span> org.apache.zookeeper.CreateMode

<span class="keyword">import</span> edu.berkeley.cs.scads.piql.scadr.Subscription

case <span class="keyword">class</span> <a title="class PlanCompareResult extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with ScalaObject with Product with Serializable" id="52132">PlanCompareResult</a><a href="#52132" title="ScalaObject" class="delimiter">(</a><a href="#52132" title="()edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="52923" class="keyword">var</a> <a title="String" id="51635">hostname</a>: <span title="String">String</span>,
			     <span class="keyword">var</span> <a title="Long" id="51636">timestamp</a>: <span title="Long">Long</span>,
			     <span class="keyword">var</span> <a title="Int" id="51637">iteration</a>: <span title="Int">Int</span>,
			     <span class="keyword">var</span> <a title="Int" id="51638">point</a>: <span title="Int">Int</span>,
			     <span class="keyword">var</span> <a title="String" id="51639">query</a>: <span title="String">String</span>,
			     <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" id="51640">config</a>: <a href="#52128" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">PlanCompareTask</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroPair">AvroPair</span> <span class="delimiter">{</span>
  <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="45725">responseTimes</a>: <span title="edu.berkeley.cs.scads.perf.Histogram">Histogram</span> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">var</span> <a title="Long" id="45728">messagesSent</a>: <span title="Long">Long</span> = _
<span class="delimiter">}</span>
		  
<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.piql.modeling.PlanCompare" id="10355">PlanCompare</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> <a href="Experiments.scala.html#10338" title="object edu.berkeley.cs.scads.piql.modeling.Experiments">Experiments</a>._

  <span class="keyword">def</span> <a title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster" id="46084">newScadsCluster</a><span class="delimiter">(</span><a title="Int" id="46132">size</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="46134">clusterRoot</a> = <a href="Experiments.scala.html#14683" title="=&gt; deploylib.mesos.Cluster">cluster</a>.<a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="46136">zooKeeperRoot</a>.<a href="#46136" title="Int" id="46138">getOrCreate</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="46157" class="delimiter">(</a><a title="java.lang.String(&quot;scads&quot;)" id="46137" class="string">&quot;scads&quot;</a><span class="delimiter">)</span>.<a href="#46157" title="Array[Byte]" id="46160">createChild</a><span class="delimiter">(</span><a title="java.lang.String(&quot;experimentCluster&quot;)" id="46158" class="string">&quot;experimentCluster&quot;</a>, mode = CreateMode.<a title="org.apache.zookeeper.CreateMode(value PERSISTENT_SEQUENTIAL)" id="46159">PERSISTENT_SEQUENTIAL</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Array[deploylib.mesos.JvmMainTask]" id="46135">serverProcs</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; deploylib.mesos.JvmMainTask)(implicit evidence$9: scala.reflect.ClassManifest[deploylib.mesos.JvmMainTask])Array[deploylib.mesos.JvmMainTask]">fill</span><span class="delimiter">(</span><a href="#46132" title="Int">size</a><span class="delimiter">)</span><span title="(clazz: java.lang.Class[_])scala.reflect.ClassManifest[deploylib.mesos.JvmMainTask]" class="delimiter">(</span><span title="(clusterAddress: String, dbDir: Option[String], cachePercentage: Option[Int], name: Option[String])edu.berkeley.cs.scads.storage.ScalaEngineTask">ScalaEngineTask</span><span class="delimiter">(</span>clusterAddress=<a href="#46134" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="=&gt; java.lang.String">canonicalAddress</span><span class="delimiter">)</span>.<a href="Experiments.scala.html#14688" title="(implicit classSource: Seq[deploylib.mesos.ClassSource])deploylib.mesos.JvmMainTask">toJvmTask</a><span class="delimiter">)</span>

    <a href="Experiments.scala.html#14683" title="=&gt; deploylib.mesos.Cluster">cluster</a>.<span title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</span>.<span title="(processes: Seq[deploylib.mesos.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#46135" title="(xs: Array[deploylib.mesos.JvmMainTask])scala.collection.mutable.WrappedArray[deploylib.mesos.JvmMainTask]">serverProcs</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.ScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">(</span><a href="#46134" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="46085">run</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="46885">scadsCluster</a> = <a href="#46084" title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster">newScadsCluster</a><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="deploylib.mesos.JvmMainTask" id="46886">compareTask</a> = <a href="#52128" title="(clusterAddress: String, resultClusterAddress: String, replicationFactor: Int, iterations: Int, points: Int, stepSize: Int, numExecutions: Int, numFollowers: Int, fetchSize: Int, warmupTimeMin: Int)edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#46885" title="edu.berkeley.cs.scads.storage.ScadsCluster">scadsCluster</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<span title="=&gt; java.lang.String">canonicalAddress</span>,
      resultClusterAddress = <a href="Experiments.scala.html#14680" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">resultClusterAddress</a>.<span title="=&gt; java.lang.String">canonicalAddress</span>
    <span class="delimiter">)</span>.<a href="Experiments.scala.html#14688" title="(implicit classSource: Seq[deploylib.mesos.ClassSource])deploylib.mesos.JvmMainTask">toJvmTask</a>
    <a href="Experiments.scala.html#14689" title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</a>.<span title="(processes: Seq[deploylib.mesos.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#46886" title="deploylib.mesos.JvmMainTask">compareTask</a> <a href="#46995" title="(x: deploylib.mesos.JvmMainTask)List[deploylib.mesos.JvmMainTask]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="46086">testLocal</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="47004">testCluster</a> = <span title="object edu.berkeley.cs.scads.storage.TestScalaEngine">TestScalaEngine</span>.<span title="(numNodes: Int)edu.berkeley.cs.scads.storage.ManagedScadsCluster">newScadsCluster</span><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<span title="=&gt; java.lang.String">canonicalAddress</span>
    <a href="#46932" title="Int" id="47022">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#47004" title="java.lang.String" id="47013">testCluster</a>,
      resultClusterAddress = <a href="#47004" title="java.lang.String" id="47014">testCluster</a>,
      warmupTimeMin = <a title="Int(0)" id="47015" class="int">0</a>
    <span class="delimiter">)</span>.<a href="#45784" title="()Unit">run</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="46087">results</a> = <a href="Experiments.scala.html#14686" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">resultsCluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">[</span><a href="#52132" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompareResults&quot;)" class="string">&quot;planCompareResults&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="46089">allResults</a> = <a href="#46087" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">results</a>.<span title="(startKey: Option[org.apache.avro.generic.IndexedRecord], endKey: Option[org.apache.avro.generic.IndexedRecord])Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">iterateOverRange</span><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="46090">goodResults</a> = <a href="#46089" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">allResults</a>

  <span class="keyword">def</span> <a title="(quantile: Double, maxItems: Int)Seq[(String, Int, Int, Long, Long, Int)]" id="46091">graphPoints</a><span class="delimiter">(</span><a title="Double" id="47035">quantile</a>: <span title="Double">Double</span> = <span title="Double(0.99)" class="double">0.99</span>, <a title="Int" id="47036">maxItems</a>: <span title="Int">Int</span> = <span title="Int(200)" class="int">200</span><span class="delimiter">)</span> = <a href="#46090" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">goodResults</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">toSeq</span>
    .<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; (String, Int))scala.collection.immutable.Map[(String, Int),Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]">groupBy</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="47052">r</a> =&gt; <span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#47052" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#51639" title="=&gt; String">query</a>, <a href="#47052" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#51638" title="=&gt; Int">point</a> <span title="(x: Int)Int">*</span> <a href="#47052" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#51640" title="=&gt; edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">config</a>.<a href="#46935" title="=&gt; Int">stepSize</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])]">toSeq</span>
    .<span title="(f: ((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]) =&gt; (String, Int, Int, Long, Long, Int))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])],(String, Int, Int, Long, Long, Int),Seq[(String, Int, Int, Long, Long, Int)]])Seq[(String, Int, Int, Long, Long, Int)]">map</span> <a href="#47104" title="(String, Int, Int, Long, Long, Int)" class="delimiter">{</a> 
      <span class="keyword">case</span> <span title="(String, Int, Int, Long, Long, Int)" class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="47109">query</a>, <a title="Int" id="47110">size</a><span class="delimiter">)</span>, <a title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="47111">data</a><span class="delimiter">)</span> =&gt;
	<span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="47112">truncData</a> = <a href="#47111" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">data</a>.<span title="(n: Int)Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">take</span><span class="delimiter">(</span><span title="Int(200)" class="int">200</span><span class="delimiter">)</span>
	<span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="47113">aggHist</a> = <a href="#47112" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; edu.berkeley.cs.scads.perf.Histogram)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],edu.berkeley.cs.scads.perf.Histogram,Seq[edu.berkeley.cs.scads.perf.Histogram]])Seq[edu.berkeley.cs.scads.perf.Histogram]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.perf.Histogram,Seq[edu.berkeley.cs.scads.perf.Histogram]]" class="delimiter">(</span><a href="#47130" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#45725" title="=&gt; edu.berkeley.cs.scads.perf.Histogram">responseTimes</a><span class="delimiter">)</span>.<span title="(op: (edu.berkeley.cs.scads.perf.Histogram, edu.berkeley.cs.scads.perf.Histogram) =&gt; edu.berkeley.cs.scads.perf.Histogram)edu.berkeley.cs.scads.perf.Histogram">reduceLeft</span><span class="delimiter">(</span><a href="#47155" title="edu.berkeley.cs.scads.perf.Histogram">_</a> <span title="(left: edu.berkeley.cs.scads.perf.Histogram)edu.berkeley.cs.scads.perf.Histogram">+</span> <a href="#47156" title="edu.berkeley.cs.scads.perf.Histogram">_</a><span class="delimiter">)</span>
	<span title="(_1: String, _2: Int, _3: Int, _4: Long, _5: Long, _6: Int)(String, Int, Int, Long, Long, Int)" class="delimiter">(</span><a href="#47109" title="String">query</a>, <a href="#47110" title="Int">size</a>, <a href="#47113" title="edu.berkeley.cs.scads.perf.Histogram">aggHist</a>.<span title="(fraction: Double)Int">quantile</span><span class="delimiter">(</span><a href="#47035" title="Double">quantile</a><span class="delimiter">)</span>, <a href="#47113" title="edu.berkeley.cs.scads.perf.Histogram">aggHist</a>.<span title="=&gt; Long">totalRequests</span>, <a href="#47112" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],Long,Seq[Long]])Seq[Long]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Long,Seq[Long]]" class="delimiter">(</span><a href="#47179" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#45728" title="=&gt; Long">messagesSent</a><span class="delimiter">)</span>.<span title="(implicit num: Numeric[Long])Long">sum</span>, <a href="#47112" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> 
    <span class="delimiter">}</span>
    .<span title="(f: (String, Int, Int, Long, Long, Int) =&gt; (String, Int))(implicit ord: scala.math.Ordering[(String, Int)])Seq[(String, Int, Int, Long, Long, Int)]">sortBy</span><span title="(implicit ord1: scala.math.Ordering[String], implicit ord2: scala.math.Ordering[Int])scala.math.Ordering[(String, Int)]" class="delimiter">(</span><a title="(String, Int, Int, Long, Long, Int)" id="47248">r</a> =&gt; <span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#47248" title="(String, Int, Int, Long, Long, Int)">r</a>.<span title="=&gt; String">_1</span>, <a href="#47248" title="(String, Int, Int, Long, Long, Int)">r</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="46092">backupData</a> = <a href="Experiments.scala.html#14708" title="avroIterWriter extends java.lang.Object" id="47632">allResults</a>.<a href="Experiments.scala.html#47631" title="Option[org.apache.avro.file.CodecFactory]" id="47634">toAvroFile</a><span title="(implicit r: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompare&quot;)" class="string">&quot;planCompare&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <a title="java.io.File" id="47633">+</a> <span title="java.lang.String(&quot;.avro&quot;)" class="string">&quot;.avro&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Seq[(Int, String, Long)]" id="46093">queryCounts</a> = <a href="#46089" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">allResults</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">toSeq</span>
    .<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; (Int, String))scala.collection.immutable.Map[(Int, String),Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]">groupBy</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="47663">r</a> =&gt; <span title="(_1: Int, _2: String)(Int, String)" class="delimiter">(</span><a href="#47663" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#51638" title="=&gt; Int">point</a>, <a href="#47663" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#51639" title="=&gt; String">query</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])]">toSeq</span>
    .<span title="(f: ((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]) =&gt; (Int, String, Long))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])],(Int, String, Long),Seq[(Int, String, Long)]])Seq[(Int, String, Long)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Int, String, Long),Seq[(Int, String, Long)]]" class="delimiter">(</span><a title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])" id="47711">r</a> =&gt; <span title="(_1: Int, _2: String, _3: Long)(Int, String, Long)" class="delimiter">(</span><a href="#47711" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; (Int, String)">_1</span>.<span title="=&gt; Int">_1</span>, <a href="#47711" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; (Int, String)">_1</span>.<span title="=&gt; String">_2</span> , <a href="#47711" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">_2</span>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],Long,Seq[Long]])Seq[Long]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Long,Seq[Long]]" class="delimiter">(</span><a href="#47734" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#45725" title="=&gt; edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>.<span title="=&gt; Long">totalRequests</span><span class="delimiter">)</span>.<span title="(implicit num: Numeric[Long])Long">sum</span><span class="delimiter">)</span><span class="delimiter">)</span>
    .<span title="(f: (Int, String, Long) =&gt; Int)(implicit ord: scala.math.Ordering[Int])Seq[(Int, String, Long)]">sortBy</span><span title="object scala.math.Ordering.Int" class="delimiter">(</span><a title="(Int, String, Long)" id="47794">r</a> =&gt; <a href="#47794" title="(Int, String, Long)">r</a>.<span title="=&gt; Int">_1</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="46094">ladyGaga</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="47853">scadsCluster</a> = <a href="#46084" title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster">newScadsCluster</a><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="deploylib.mesos.JvmMainTask" id="47854">compareTask</a> = <a href="#46932" title="Int" id="47872">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#47853" title="edu.berkeley.cs.scads.storage.ScadsCluster">scadsCluster</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<a title="java.lang.String" id="47863">canonicalAddress</a>,
      resultClusterAddress = <a href="Experiments.scala.html#14680" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">resultClusterAddress</a>.<a title="java.lang.String" id="47864">canonicalAddress</a>,
      iterations=<a title="Int(1)" id="47865" class="int">1</a>,
      points=<a title="Int(1)" id="47866" class="int">1</a>,
      stepSize=<a title="Int(12463286)" id="47867" class="int">12463286</a>, <span class="comment">//# of followers on August 9th, 2011 10:35PM</span>
      numExecutions=<a title="Int(20)" id="47868" class="int">20</a>
    <span class="delimiter">)</span>.<a href="Experiments.scala.html#14688" title="(implicit classSource: Seq[deploylib.mesos.ClassSource])deploylib.mesos.JvmMainTask">toJvmTask</a>
    <a href="Experiments.scala.html#14689" title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</a>.<span title="(processes: Seq[deploylib.mesos.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#47854" title="deploylib.mesos.JvmMainTask">compareTask</a> <a href="#47874" title="(x: deploylib.mesos.JvmMainTask)List[deploylib.mesos.JvmMainTask]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Mesos task to compare the response time of different physical plans for
 * the following SCADr query:
 * 
 * SELECT * FROM Subscriptions
 * WHERE owner = &lt;activeUser&gt; AND target IN [1]
 */</span>
case <span class="keyword">class</span> <a href="#57455" title="class PlanCompareTask extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with deploylib.mesos.AvroTask with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="52128">PlanCompareTask</a><a href="#52128" title="ScalaObject" class="delimiter">(</a><a href="#52128" title="()edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" id="52933" class="keyword">var</a> <a title="String" id="46930">clusterAddress</a>: <span title="String">String</span>,
			   <span class="keyword">var</span> <a title="String" id="46931">resultClusterAddress</a>: <span title="String">String</span>,
			   <span class="keyword">var</span> <a title="Int" id="46932">replicationFactor</a>: <span title="Int">Int</span> = <span title="Int(2)" class="int">2</span>,
			   <span class="keyword">var</span> <a title="Int" id="46933">iterations</a>: <span title="Int">Int</span> = <span title="Int(200)" class="int">200</span>,
			   <span class="keyword">var</span> <a title="Int" id="46934">points</a>: <span title="Int">Int</span> = <span title="Int(20)" class="int">20</span>,
			   <span class="keyword">var</span> <a title="Int" id="46935">stepSize</a>: <span title="Int">Int</span> = <span title="Int(250)" class="int">250</span>,
			   <span class="keyword">var</span> <a title="Int" id="46936">numExecutions</a>: <span title="Int">Int</span> = <span title="Int(1000)" class="int">1000</span>,
			   <span class="keyword">var</span> <a title="Int" id="46937">numFollowers</a>: <span title="Int">Int</span> = <span title="Int(50)" class="int">50</span>,
			   <span class="keyword">var</span> <a title="Int" id="46938">fetchSize</a>: <span title="Int">Int</span> = <span title="Int(1000)" class="int">1000</span>,
			   <span class="keyword">var</span> <a title="Int" id="46939">warmupTimeMin</a>: <span title="Int">Int</span> = <span title="Int(3)" class="int">3</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="deploylib.mesos.AvroTask">AvroTask</span> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="delimiter">{</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#46935" title="=&gt; Int">stepSize</a> <span title="(x: Int)Boolean">&gt;=</span> <a href="#46937" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()Unit" id="45784">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" id="47927">cluster</a> = <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">ExperimentalScadsCluster</span><span class="delimiter">(</span><span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#46930" title="=&gt; String">clusterAddress</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#47927" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="(clusterSize: Int)Unit">blockUntilReady</span><span class="delimiter">(</span><a href="#46932" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="47928">resultCluster</a> = <span title="edu.berkeley.cs.scads.storage.ScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">(</span><span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#46931" title="=&gt; String">resultClusterAddress</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="47929">results</a> = <a href="#47928" title="edu.berkeley.cs.scads.storage.ScadsCluster">resultCluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">[</span><a href="#52132" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompareResults&quot;)" class="string">&quot;planCompareResults&quot;</span><span class="delimiter">)</span>
    
    <span class="comment">/**
     * Create the partition scheme for subscriptions to be a single partition over
     * the specified number of replicas
     */</span>
    <span class="keyword">val</span> <a title="List[(None.type, List[edu.berkeley.cs.scads.storage.StorageService])]" id="47930">partitions</a> = <span title="(_1: None.type, _2: List[edu.berkeley.cs.scads.storage.StorageService])(None.type, List[edu.berkeley.cs.scads.storage.StorageService])" class="delimiter">(</span><span title="object None">None</span>, <a href="#47927" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="()List[edu.berkeley.cs.scads.storage.StorageService]">getAvailableServers</span>.<span title="(n: Int)List[edu.berkeley.cs.scads.storage.StorageService]">take</span><span class="delimiter">(</span><a href="#46932" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#47958" title="(x: (None.type, List[edu.berkeley.cs.scads.storage.StorageService]))List[(None.type, List[edu.berkeley.cs.scads.storage.StorageService])]">::</a> <span title="object Nil">Nil</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" id="47931">subscriptions</a> = <a href="#47927" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</span><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">(</span><span title="java.lang.String(&quot;subscriptions&quot;)" class="string">&quot;subscriptions&quot;</span><span class="delimiter">)</span>
    
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.plans.FixedLimit" id="47932">limit</a> = <span title="(count: Int)edu.berkeley.cs.scads.piql.plans.FixedLimit">FixedLimit</span><span class="delimiter">(</span><a href="#46937" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.plans.FixedLimit" id="47933">fetchLimit</a> = <span title="(count: Int)edu.berkeley.cs.scads.piql.plans.FixedLimit">FixedLimit</span><span class="delimiter">(</span><a href="#46938" title="=&gt; Int">fetchSize</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="47934">activeUser</a> = <a href="#45786" title="(i: Int)String">toUser</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" id="47935">executor</a> = <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">ParallelExecutor</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="47936">naiveQuery</a> =
      <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">OptimizedQuery</span><span class="delimiter">(</span>
	<span title="(a: java.lang.String)Option[java.lang.String]" class="string">&quot;NaiveFollowing&quot;</span>,
	   <span title="(count: edu.berkeley.cs.scads.piql.plans.Limit, child: edu.berkeley.cs.scads.piql.plans.QueryPlan)edu.berkeley.cs.scads.piql.plans.LocalStopAfter">LocalStopAfter</span><span class="delimiter">(</span><a href="#47932" title="edu.berkeley.cs.scads.piql.plans.FixedLimit">limit</a>,
	     <span title="(predicate: edu.berkeley.cs.scads.piql.plans.Predicate, child: edu.berkeley.cs.scads.piql.plans.QueryPlan)edu.berkeley.cs.scads.piql.plans.LocalSelection">LocalSelection</span><span class="delimiter">(</span><span title="(v1: edu.berkeley.cs.scads.piql.plans.Value, v2: edu.berkeley.cs.scads.piql.plans.Value)edu.berkeley.cs.scads.piql.plans.InPredicate">InPredicate</span><span class="delimiter">(</span><span title="(recordPosition: Int, fieldPosition: Int)edu.berkeley.cs.scads.piql.plans.AttributeValue">AttributeValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>,<span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, <span title="(ordinal: Int)edu.berkeley.cs.scads.piql.plans.ParameterValue">ParameterValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span>,
	       <span title="(namespace: edu.berkeley.cs.scads.piql.package.Namespace, keyPrefix: edu.berkeley.cs.scads.piql.package.KeyGenerator, limit: edu.berkeley.cs.scads.piql.plans.Limit, ascending: Boolean)edu.berkeley.cs.scads.piql.plans.IndexScan">IndexScan</span><span class="delimiter">(</span><a href="#47931" title="(ns: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.piql.package#Namespace">subscriptions</a>, <a href="#47934" title="String">activeUser</a> <a href="#48396" title="(x: edu.berkeley.cs.scads.piql.plans.ConstantValue)List[edu.berkeley.cs.scads.piql.plans.ConstantValue]">::</a> <span title="object Nil">Nil</span>, <span title="(count: Int)edu.berkeley.cs.scads.piql.plans.FixedLimit">FixedLimit</span><span class="delimiter">(</span><span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>,
        <a href="#47935" title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">executor</a><span class="delimiter">)</span>
   
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="47937">piqlQuery</a> =
      <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">OptimizedQuery</span><span class="delimiter">(</span>
	<span title="(a: java.lang.String)Option[java.lang.String]" class="string">&quot;PiqlFollowing&quot;</span>,
	<span title="(namespace: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, child: edu.berkeley.cs.scads.piql.plans.QueryPlan)edu.berkeley.cs.scads.piql.plans.IndexLookupJoin">IndexLookupJoin</span><span class="delimiter">(</span><a href="#47931" title="(ns: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.piql.package#Namespace">subscriptions</a>, 
		        <span title="(v: Any)edu.berkeley.cs.scads.piql.plans.ConstantValue">ConstantValue</span><span class="delimiter">(</span><a href="#47934" title="String">activeUser</a><span class="delimiter">)</span> <a href="#48516" title="(x: Product with Serializable with edu.berkeley.cs.scads.piql.plans.Value)List[Product with Serializable with edu.berkeley.cs.scads.piql.plans.Value]">::</a> <span title="(recordPosition: Int, fieldPosition: Int)edu.berkeley.cs.scads.piql.plans.AttributeValue">AttributeValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>,<span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#48519" title="(x: edu.berkeley.cs.scads.piql.plans.AttributeValue)List[edu.berkeley.cs.scads.piql.plans.AttributeValue]">::</a> <span title="object Nil">Nil</span>, 
			<span title="(parameterOrdinal: Int, wrap: Boolean)edu.berkeley.cs.scads.piql.plans.LocalIterator">LocalIterator</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span>,
	<a href="#47935" title="edu.berkeley.cs.scads.piql.exec.ParallelExecutor">executor</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]" id="47938">queries</a> = <a href="#47936" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">naiveQuery</a> <a href="#48580" title="(x: edu.berkeley.cs.scads.piql.opt.OptimizedQuery)List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">::</a> <a href="#47937" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">piqlQuery</a> <a href="#48581" title="(x: edu.berkeley.cs.scads.piql.opt.OptimizedQuery)List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">::</a> <span title="object Nil">Nil</span>

    <span class="keyword">val</span> <a title="scala.util.Random" id="47939">rand</a> = <span title="()scala.util.Random" class="keyword">new</span> scala.util.<span title="scala.util.Random">Random</span>
    <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#46933" title="=&gt; Int">iterations</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="48886">iteration</a> =&gt; <span class="delimiter">{</span>
      <a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining iteration %d&quot;)" class="string">&quot;Begining iteration %d&quot;</span>, <a href="#48886" title="Int">iteration</a><span class="delimiter">)</span>
      <span class="comment">/* clear namespaces by reseting partition scheme */</span>
      <a href="#47931" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#47931" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="()Unit">open</span><span class="delimiter">(</span><span class="delimiter">)</span>

      <a href="#47931" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])])Unit">setPartitionScheme</span><span class="delimiter">(</span><a href="#47930" title="List[(None.type, List[edu.berkeley.cs.scads.storage.StorageService])]">partitions</a><span class="delimiter">)</span>
      <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#47931" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">getRange</span><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, limit=<span title="(a: Int)Option[Int]" class="int">1</span><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#46934" title="=&gt; Int">points</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="49023">point</a> =&gt; <span class="delimiter">{</span>
	<span class="comment">/* bulkload more subscriptions */</span>
	<span class="keyword">val</span> <a title="Int" id="49024">minUser</a> = <span class="delimiter">(</span><a href="#49023" title="Int">point</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(x: Int)Int">*</span> <a href="#46935" title="=&gt; Int">stepSize</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
	<span class="keyword">val</span> <a title="Int" id="49025">maxUser</a> = <a href="#49023" title="Int">point</a> <span title="(x: Int)Int">*</span> <a href="#46935" title="=&gt; Int">stepSize</a>
	<a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Measuring with %d subscriptions&quot;)" class="string">&quot;Measuring with %d subscriptions&quot;</span>, <a href="#49025" title="Int">maxUser</a><span class="delimiter">)</span>

	<a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading data for subscriptions %d to %d&quot;)" class="string">&quot;Loading data for subscriptions %d to %d&quot;</span>, <a href="#49024" title="Int">minUser</a>, <a href="#49025" title="Int">maxUser</a><span class="delimiter">)</span>
	<span class="keyword">val</span> <a title="view extends java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]" id="49026">newUsers</a> = <span class="delimiter">(</span><a href="#49024" title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">minUser</a> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#49025" title="Int">maxUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>
	<span class="keyword">val</span> <a title="scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]" id="49027">data</a> = <a href="#49026" title="view extends java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUsers</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Subscription)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]])scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]]" class="delimiter">(</span><a title="Int" id="50091">u</a> =&gt; <span title="(owner: String, target: String)edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</span><span class="delimiter">(</span><a href="#47934" title="String">activeUser</a>, <a href="#45786" title="(i: Int)String">toUser</a><span class="delimiter">(</span><a href="#50091" title="Int">u</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
	<a href="#47931" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])Unit">++=</span> <a href="#49027" title="scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]">data</a>
	<a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Data size: %d&quot;)" class="string">&quot;Data size: %d&quot;</span>, <a href="#47931" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(startKey: Option[org.apache.avro.generic.IndexedRecord], endKey: Option[org.apache.avro.generic.IndexedRecord])Iterator[edu.berkeley.cs.scads.piql.scadr.Subscription]">iterateOverRange</span><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>

	<span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#48886" title="Int">iteration</a> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#49023" title="Int">point</a> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	  <a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining warmup&quot;)" class="string">&quot;Begining warmup&quot;</span><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="Long" id="50684">startTime</a> = <a href="#45785" title="=&gt; Long">currentTime</a>
	  <span class="keyword">val</span> <a title="Seq[String]" id="50685">users</a> = <a href="#45787" title="(maxUser: Int, size: Int)Seq[String]">randomUserList</a><span class="delimiter">(</span><span title="Int(10)" class="int">10</span>,<span title="Int(10)" class="int">10</span><span class="delimiter">)</span>
	  <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#45785" title="=&gt; Long">currentTime</a> <span title="(x: Long)Long">-</span> <a href="#50684" title="Long">startTime</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#46939" title="=&gt; Int">warmupTimeMin</a> <span title="(x: Int)Int">*</span> <span title="Int(60)" class="int">60</span> <span title="(x: Int)Int">*</span> <span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    <a href="#47938" title="List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">queries</a>.<span title="(f: edu.berkeley.cs.scads.piql.opt.OptimizedQuery =&gt; edu.berkeley.cs.scads.piql.package.QueryResult)Unit">foreach</span><a href="#51276" title="()Unit" class="delimiter">(</a><a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="51323">q</a> =&gt; <a href="#51323" title="(args: Any*)edu.berkeley.cs.scads.piql.package.QueryResult">q</a><span class="delimiter">(</span><a href="#50685" title="Seq[String]">users</a><span class="delimiter">)</span><span class="delimiter">)</span>
	  <span class="delimiter">}</span>
	<span class="delimiter">}</span>

	<span class="comment">/* measure response time for each query given the current state of the db */</span>
	<a href="#47929" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">results</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])Unit">++=</span>  <a href="#47938" title="List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery]">queries</a>.<span title="(f: edu.berkeley.cs.scads.piql.opt.OptimizedQuery =&gt; edu.berkeley.cs.scads.piql.modeling.PlanCompareResult)(implicit bf: scala.collection.generic.CanBuildFrom[List[edu.berkeley.cs.scads.piql.opt.OptimizedQuery],edu.berkeley.cs.scads.piql.modeling.PlanCompareResult,TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]])TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.piql.modeling.PlanCompareResult,List[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery" id="51344">query</a> =&gt; <span class="delimiter">{</span>
	  <a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Running %s %d times&quot;)" class="string">&quot;Running %s %d times&quot;</span>, <a href="#51344" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">query</a>.<span title="=&gt; Option[String]">name</span>, <a href="#46936" title="=&gt; Int">numExecutions</a><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="51345">responseTimes</a> = <span title="(bucketSize: Int, bucketCount: Int)edu.berkeley.cs.scads.perf.Histogram">Histogram</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span>,<span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>

	  <span class="keyword">val</span> <a title="Long" id="51346">startMessages</a> = <span title="object edu.berkeley.cs.scads.storage.package.StorageRegistry">StorageRegistry</span>.<span title="=&gt; Long">futureCount</span>
	  <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#46936" title="=&gt; Int">numExecutions</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.perf.Histogram)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="51606">i</a> =&gt; <span class="delimiter">{</span>
	    <span class="keyword">val</span> <a title="Seq[String]" id="51607">users</a> = <a href="#45787" title="(maxUser: Int, size: Int)Seq[String]">randomUserList</a><span class="delimiter">(</span><a href="#49025" title="Int">maxUser</a>, <a href="#46937" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>

	    <span class="keyword">val</span> <a title="Long" id="51608">startTime</a> = <a href="#45785" title="=&gt; Long">currentTime</a>
	    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.QueryResult" id="51609">answer</a> = <a href="#51344" title="(args: Any*)edu.berkeley.cs.scads.piql.package.QueryResult">query</a><span class="delimiter">(</span><a href="#51607" title="Seq[String]">users</a><span class="delimiter">)</span>
	    <a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Query Result: %s&quot;)" class="string">&quot;Query Result: %s&quot;</span>, <a href="#51609" title="edu.berkeley.cs.scads.piql.package.QueryResult">answer</a><span class="delimiter">)</span>
	    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#51609" title="edu.berkeley.cs.scads.piql.package.QueryResult">answer</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#46937" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>
	    <span class="keyword">var</span> <a title="Long" id="51610">endTime</a> = <a href="#45785" title="=&gt; Long">currentTime</a>

	    <a href="#51345" title="edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>.<span title="(value: Long)edu.berkeley.cs.scads.perf.Histogram">add</span><span class="delimiter">(</span><a href="#51610" title="Long">endTime</a> <span title="(x: Long)Long">-</span> <a href="#51608" title="Long">startTime</a><span class="delimiter">)</span>
	  <span class="delimiter">}</span><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="Long" id="51347">endMessages</a> = <span title="object edu.berkeley.cs.scads.storage.package.StorageRegistry">StorageRegistry</span>.<span title="=&gt; Long">futureCount</span>
	  <a href="#52128" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Messages sent: %d&quot;)" class="string">&quot;Messages sent: %d&quot;</span>, <a href="#51347" title="Long">endMessages</a> <span title="(x: Long)Long">-</span> <a href="#51346" title="Long">startMessages</a><span class="delimiter">)</span>

	  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="51348">result</a> = <a href="#52132" title="(hostname: String, timestamp: Long, iteration: Int, point: Int, query: String, config: edu.berkeley.cs.scads.piql.modeling.PlanCompareTask)edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">(</span>
	    java.net.<span title="object java.net.InetAddress">InetAddress</span>.<span title="()java.net.InetAddress">getLocalHost</span>.<span title="()java.lang.String">getHostName</span>,
	    <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>,
	    <a href="#48886" title="Int">iteration</a>,
	    <a href="#49023" title="Int">point</a>,
	    <a href="#51344" title="edu.berkeley.cs.scads.piql.opt.OptimizedQuery">query</a>.<span title="=&gt; Option[String]">name</span>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="java.lang.String(&quot;unnamed&quot;)" class="string">&quot;unnamed&quot;</span><span class="delimiter">)</span>,
	    <a href="#52128" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" class="keyword">this</a><span class="delimiter">)</span>
	  <a href="#51348" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>.<a href="#45725" title="(x$1: edu.berkeley.cs.scads.perf.Histogram)Unit">responseTimes</a> = <a href="#51345" title="edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>
	  <a href="#51348" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>.<a href="#45728" title="(x$1: Long)Unit">messagesSent</a> = <a href="#51347" title="Long">endMessages</a> <span title="(x: Long)Long">-</span> <a href="#51346" title="Long">startMessages</a>
	  <a href="#51348" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>
	<span class="delimiter">}</span><span class="delimiter">)</span>	
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>	
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="=&gt; Long" id="45785">currentTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">nanoTime</span> <span title="(x: Int)Long">/</span> <span title="Int(1000000)" class="int">1000000</span>
  <span class="keyword">def</span> <a title="(i: Int)String" id="45786">toUser</a><span class="delimiter">(</span><a title="Int" id="48065">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;User%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#48065" title="Int">i</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(maxUser: Int, size: Int)Seq[String]" id="45787">randomUserList</a><span class="delimiter">(</span><a title="Int" id="50695">maxUser</a>: <span title="Int">Int</span>, <a title="Int" id="50696">size</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[Int]" id="50699">nums</a> = <span title="()scala.collection.mutable.HashSet[Int]" class="keyword">new</span> collection.mutable.<span title="scala.collection.mutable.HashSet[Int]">HashSet</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="50700">pos</a> = <span title="Int(0)" class="int">0</span>

    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#50700" title="Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#50696" title="Int">size</a><span class="delimiter">)</span> <a href="#50701" title="()Unit" class="delimiter">{</a>
      <span class="keyword">val</span> <a title="Int" id="51211">randNum</a> = scala.util.<span title="object scala.util.Random">Random</span>.<span title="(n: Int)Int">nextInt</span><span class="delimiter">(</span><a href="#50695" title="Int">maxUser</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><span class="delimiter">(</span><a href="#50699" title="scala.collection.mutable.HashSet[Int]">nums</a> <span title="(elem: Int)Boolean">contains</span> <a href="#51211" title="Int">randNum</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// TODO: use a set here</span>
        <a href="#50699" title="(elem: Int, included: Boolean)Unit">nums</a><span class="delimiter">(</span><a href="#51211" title="Int">randNum</a><span class="delimiter">)</span> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#50700" title="Int">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#50699" title="scala.collection.mutable.HashSet[Int]">nums</a>.<span title="=&gt; Seq[Int]">toSeq</span>.<span title="(f: Int =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Int],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="#45786" title="(i: Int)String">toUser</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>