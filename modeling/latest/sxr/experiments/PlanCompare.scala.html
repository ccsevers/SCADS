<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>experiments/PlanCompare.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads
<span class="keyword">package</span> piql
<span class="keyword">package</span> modeling

<span class="keyword">import</span> deploylib.mesos._
<span class="keyword">import</span> perf._
<span class="keyword">import</span> comm._
<span class="keyword">import</span> storage._
<span class="keyword">import</span> avro.runtime._
<span class="keyword">import</span> avro.marker._
<span class="keyword">import</span> org.apache.zookeeper.CreateMode

<span class="keyword">import</span> edu.berkeley.cs.scads.piql.scadr.Subscription

case <span class="keyword">class</span> <a title="class PlanCompareResult extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroPair with ScalaObject with Product with Serializable" id="68192">PlanCompareResult</a><a href="#68192" title="ScalaObject" class="delimiter">(</a><a href="#68192" title="()edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="85416" class="keyword">var</a> <a title="String" id="67943">hostname</a>: <span title="String">String</span>,
			     <span class="keyword">var</span> <a title="Long" id="67944">timestamp</a>: <span title="Long">Long</span>,
			     <span class="keyword">var</span> <a title="Int" id="67945">iteration</a>: <span title="Int">Int</span>,
			     <span class="keyword">var</span> <a title="Int" id="67946">point</a>: <span title="Int">Int</span>,
			     <span class="keyword">var</span> <a title="String" id="67947">query</a>: <span title="String">String</span>,
			     <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" id="67948">config</a>: <a href="#68188" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">PlanCompareTask</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroPair">AvroPair</span> <span class="delimiter">{</span>
  <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="63966">responseTimes</a>: <span title="edu.berkeley.cs.scads.perf.Histogram">Histogram</span> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">var</span> <a title="Long" id="63969">messagesSent</a>: <span title="Long">Long</span> = _
<span class="delimiter">}</span>
		  
<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.piql.modeling.PlanCompare" id="10229">PlanCompare</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> <a href="Experiments.scala.html#10213" title="object edu.berkeley.cs.scads.piql.modeling.Experiments">Experiments</a>._

  <span class="keyword">def</span> <a title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster" id="64153">newScadsCluster</a><span class="delimiter">(</span><a title="Int" id="64193">size</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="64195">clusterRoot</a> = <a href="Experiments.scala.html#50030" title="=&gt; deploylib.mesos.Cluster">cluster</a>.<a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="64197">zooKeeperRoot</a>.<a href="#64197" title="Int" id="64199">getOrCreate</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="64205" class="delimiter">(</a><a title="java.lang.String(&quot;scads&quot;)" id="64198" class="string">&quot;scads&quot;</a><span class="delimiter">)</span>.<a href="#64205" title="Array[Byte]" id="64208">createChild</a><span class="delimiter">(</span><a title="java.lang.String(&quot;experimentCluster&quot;)" id="64206" class="string">&quot;experimentCluster&quot;</a>, mode = CreateMode.<a title="org.apache.zookeeper.CreateMode(value PERSISTENT_SEQUENTIAL)" id="64207">PERSISTENT_SEQUENTIAL</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.comm.JvmMainTask]" id="64196">serverProcs</a> = <span title="object Array">Array</span>.<span title="(n: Int)(elem: =&gt; edu.berkeley.cs.scads.comm.JvmMainTask)(implicit evidence$9: scala.reflect.ClassManifest[edu.berkeley.cs.scads.comm.JvmMainTask])Array[edu.berkeley.cs.scads.comm.JvmMainTask]">fill</span><span class="delimiter">(</span><a href="#64193" title="Int">size</a><span class="delimiter">)</span><span title="(clazz: java.lang.Class[_])scala.reflect.ClassManifest[edu.berkeley.cs.scads.comm.JvmMainTask]" class="delimiter">(</span><span title="(clusterAddress: String, dbDir: Option[String], cachePercentage: Option[Int], name: Option[String])edu.berkeley.cs.scads.storage.ScalaEngineTask">ScalaEngineTask</span><span class="delimiter">(</span>clusterAddress=<a href="#64195" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="=&gt; java.lang.String">canonicalAddress</span><span class="delimiter">)</span>.<a href="Experiments.scala.html#50035" title="(implicit classSource: Seq[edu.berkeley.cs.scads.comm.ClassSource])edu.berkeley.cs.scads.comm.JvmMainTask">toJvmTask</a><span class="delimiter">)</span>

    <a href="Experiments.scala.html#50030" title="=&gt; deploylib.mesos.Cluster">cluster</a>.<span title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</span>.<span title="(processes: Seq[edu.berkeley.cs.scads.comm.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#64196" title="(xs: Array[edu.berkeley.cs.scads.comm.JvmMainTask])scala.collection.mutable.WrappedArray[edu.berkeley.cs.scads.comm.JvmMainTask]">serverProcs</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.ScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">(</span><a href="#64195" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64154">run</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="64411">scadsCluster</a> = <a href="#64153" title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster">newScadsCluster</a><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.JvmMainTask" id="64412">compareTask</a> = <a href="#68188" title="(clusterAddress: String, resultClusterAddress: String, replicationFactor: Int, iterations: Int, points: Int, stepSize: Int, numExecutions: Int, numFollowers: Int, fetchSize: Int, warmupTimeMin: Int)edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#64411" title="edu.berkeley.cs.scads.storage.ScadsCluster">scadsCluster</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<span title="=&gt; java.lang.String">canonicalAddress</span>,
      resultClusterAddress = <a href="Experiments.scala.html#50027" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">resultClusterAddress</a>.<span title="=&gt; java.lang.String">canonicalAddress</span>
    <span class="delimiter">)</span>.<a href="Experiments.scala.html#50035" title="(implicit classSource: Seq[edu.berkeley.cs.scads.comm.ClassSource])edu.berkeley.cs.scads.comm.JvmMainTask">toJvmTask</a>
    <a href="Experiments.scala.html#50036" title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</a>.<span title="(processes: Seq[edu.berkeley.cs.scads.comm.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#64412" title="edu.berkeley.cs.scads.comm.JvmMainTask">compareTask</a> <a href="#64521" title="(x: edu.berkeley.cs.scads.comm.JvmMainTask)List[edu.berkeley.cs.scads.comm.JvmMainTask]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64155">testLocal</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="64530">testCluster</a> = <span title="object edu.berkeley.cs.scads.storage.TestScalaEngine">TestScalaEngine</span>.<span title="(numNodes: Int)edu.berkeley.cs.scads.storage.ManagedScadsCluster">newScadsCluster</span><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<span title="=&gt; java.lang.String">canonicalAddress</span>
    <a href="#64458" title="Int" id="64548">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#64530" title="java.lang.String" id="64539">testCluster</a>,
      resultClusterAddress = <a href="#64530" title="java.lang.String" id="64540">testCluster</a>,
      warmupTimeMin = <a title="Int(0)" id="64541" class="int">0</a>
    <span class="delimiter">)</span>.<a href="#64025" title="()Unit">run</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64156">results</a> = <a href="Experiments.scala.html#50033" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">resultsCluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">[</span><a href="#68192" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompareResults&quot;)" class="string">&quot;planCompareResults&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64158">allResults</a> = <a href="#64156" title="=&gt; edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">results</a>.<span title="(startKey: Option[org.apache.avro.generic.IndexedRecord], endKey: Option[org.apache.avro.generic.IndexedRecord])Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">iterateOverRange</span><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64159">goodResults</a> = <a href="#64158" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">allResults</a>

  <span class="keyword">def</span> <a title="(quantile: Double, maxItems: Int)Seq[(String, Int, Int, Long, Long, Int)]" id="64160">graphPoints</a><span class="delimiter">(</span><a title="Double" id="64561">quantile</a>: <span title="Double">Double</span> = <span title="Double(0.99)" class="double">0.99</span>, <a title="Int" id="64562">maxItems</a>: <span title="Int">Int</span> = <span title="Int(200)" class="int">200</span><span class="delimiter">)</span> = <a href="#64159" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">goodResults</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">toSeq</span>
    .<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; (String, Int))scala.collection.immutable.Map[(String, Int),Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]">groupBy</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="64578">r</a> =&gt; <span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#64578" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#67947" title="=&gt; String">query</a>, <a href="#64578" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#67946" title="=&gt; Int">point</a> <span title="(x: Int)Int">*</span> <a href="#64578" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#67948" title="=&gt; edu.berkeley.cs.scads.piql.modeling.PlanCompareTask">config</a>.<a href="#64461" title="=&gt; Int">stepSize</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])]">toSeq</span>
    .<span title="(f: ((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]) =&gt; (String, Int, Int, Long, Long, Int))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[((String, Int), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])],(String, Int, Int, Long, Long, Int),Seq[(String, Int, Int, Long, Long, Int)]])Seq[(String, Int, Int, Long, Long, Int)]">map</span> <a href="#64630" title="(String, Int, Int, Long, Long, Int)" class="delimiter">{</a> 
      <span class="keyword">case</span> <span title="(String, Int, Int, Long, Long, Int)" class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="64635">query</a>, <a title="Int" id="64636">size</a><span class="delimiter">)</span>, <a title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64637">data</a><span class="delimiter">)</span> =&gt;
	<span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="64638">truncData</a> = <a href="#64637" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">data</a>.<span title="(n: Int)Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">take</span><span class="delimiter">(</span><span title="Int(200)" class="int">200</span><span class="delimiter">)</span>
	<span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="64639">aggHist</a> = <a href="#64638" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; edu.berkeley.cs.scads.perf.Histogram)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],edu.berkeley.cs.scads.perf.Histogram,Seq[edu.berkeley.cs.scads.perf.Histogram]])Seq[edu.berkeley.cs.scads.perf.Histogram]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.perf.Histogram,Seq[edu.berkeley.cs.scads.perf.Histogram]]" class="delimiter">(</span><a href="#64656" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#63966" title="=&gt; edu.berkeley.cs.scads.perf.Histogram">responseTimes</a><span class="delimiter">)</span>.<span title="(op: (edu.berkeley.cs.scads.perf.Histogram, edu.berkeley.cs.scads.perf.Histogram) =&gt; edu.berkeley.cs.scads.perf.Histogram)edu.berkeley.cs.scads.perf.Histogram">reduceLeft</span><span class="delimiter">(</span><a href="#64681" title="edu.berkeley.cs.scads.perf.Histogram">_</a> <span title="(left: edu.berkeley.cs.scads.perf.Histogram)edu.berkeley.cs.scads.perf.Histogram">+</span> <a href="#64682" title="edu.berkeley.cs.scads.perf.Histogram">_</a><span class="delimiter">)</span>
	<span title="(_1: String, _2: Int, _3: Int, _4: Long, _5: Long, _6: Int)(String, Int, Int, Long, Long, Int)" class="delimiter">(</span><a href="#64635" title="String">query</a>, <a href="#64636" title="Int">size</a>, <a href="#64639" title="edu.berkeley.cs.scads.perf.Histogram">aggHist</a>.<span title="(fraction: Double)Int">quantile</span><span class="delimiter">(</span><a href="#64561" title="Double">quantile</a><span class="delimiter">)</span>, <a href="#64639" title="edu.berkeley.cs.scads.perf.Histogram">aggHist</a>.<span title="=&gt; Long">totalRequests</span>, <a href="#64638" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],Long,Seq[Long]])Seq[Long]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Long,Seq[Long]]" class="delimiter">(</span><a href="#64705" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#63969" title="=&gt; Long">messagesSent</a><span class="delimiter">)</span>.<span title="(implicit num: Numeric[Long])Long">sum</span>, <a href="#64638" title="Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">truncData</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> 
    <span class="delimiter">}</span>
    .<span title="(f: (String, Int, Int, Long, Long, Int) =&gt; (String, Int))(implicit ord: scala.math.Ordering[(String, Int)])Seq[(String, Int, Int, Long, Long, Int)]">sortBy</span><span title="(implicit ord1: scala.math.Ordering[String], implicit ord2: scala.math.Ordering[Int])scala.math.Ordering[(String, Int)]" class="delimiter">(</span><a title="(String, Int, Int, Long, Long, Int)" id="64774">r</a> =&gt; <span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#64774" title="(String, Int, Int, Long, Long, Int)">r</a>.<span title="=&gt; String">_1</span>, <a href="#64774" title="(String, Int, Int, Long, Long, Int)">r</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64161">backupData</a> = <a href="Experiments.scala.html#50055" title="avroIterWriter extends java.lang.Object" id="65070">allResults</a>.<a href="Experiments.scala.html#65069" title="Option[org.apache.avro.file.CodecFactory]" id="65072">toAvroFile</a><span title="(implicit r: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompare&quot;)" class="string">&quot;planCompare&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <a title="java.io.File" id="65071">+</a> <span title="java.lang.String(&quot;.avro&quot;)" class="string">&quot;.avro&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Seq[(Int, String, Long)]" id="64162">queryCounts</a> = <a href="#64158" title="=&gt; Iterator[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">allResults</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">toSeq</span>
    .<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; (Int, String))scala.collection.immutable.Map[(Int, String),Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]">groupBy</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="65101">r</a> =&gt; <span title="(_1: Int, _2: String)(Int, String)" class="delimiter">(</span><a href="#65101" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#67946" title="=&gt; Int">point</a>, <a href="#65101" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">r</a>.<a href="#67947" title="=&gt; String">query</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])]">toSeq</span>
    .<span title="(f: ((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]) =&gt; (Int, String, Long))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])],(Int, String, Long),Seq[(Int, String, Long)]])Seq[(Int, String, Long)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Int, String, Long),Seq[(Int, String, Long)]]" class="delimiter">(</span><a title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])" id="65149">r</a> =&gt; <span title="(_1: Int, _2: String, _3: Long)(Int, String, Long)" class="delimiter">(</span><a href="#65149" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; (Int, String)">_1</span>.<span title="=&gt; Int">_1</span>, <a href="#65149" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; (Int, String)">_1</span>.<span title="=&gt; String">_2</span> , <a href="#65149" title="((Int, String), Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])">r</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">_2</span>.<span title="(f: edu.berkeley.cs.scads.piql.modeling.PlanCompareResult =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult],Long,Seq[Long]])Seq[Long]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Long,Seq[Long]]" class="delimiter">(</span><a href="#65172" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">_</a>.<a href="#63966" title="=&gt; edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>.<span title="=&gt; Long">totalRequests</span><span class="delimiter">)</span>.<span title="(implicit num: Numeric[Long])Long">sum</span><span class="delimiter">)</span><span class="delimiter">)</span>
    .<span title="(f: (Int, String, Long) =&gt; Int)(implicit ord: scala.math.Ordering[Int])Seq[(Int, String, Long)]">sortBy</span><span title="object scala.math.Ordering.Int" class="delimiter">(</span><a title="(Int, String, Long)" id="65232">r</a> =&gt; <a href="#65232" title="(Int, String, Long)">r</a>.<span title="=&gt; Int">_1</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="64163">ladyGaga</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="65291">scadsCluster</a> = <a href="#64153" title="(size: Int)edu.berkeley.cs.scads.storage.ScadsCluster">newScadsCluster</a><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.JvmMainTask" id="65292">compareTask</a> = <a href="#64458" title="Int" id="65310">PlanCompareTask</a><span class="delimiter">(</span>
      clusterAddress = <a href="#65291" title="edu.berkeley.cs.scads.storage.ScadsCluster">scadsCluster</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</span>.<a title="java.lang.String" id="65301">canonicalAddress</a>,
      resultClusterAddress = <a href="Experiments.scala.html#50027" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">resultClusterAddress</a>.<a title="java.lang.String" id="65302">canonicalAddress</a>,
      iterations=<a title="Int(1)" id="65303" class="int">1</a>,
      points=<a title="Int(1)" id="65304" class="int">1</a>,
      stepSize=<a title="Int(12463286)" id="65305" class="int">12463286</a>, <span class="comment">//# of followers on August 9th, 2011 10:35PM</span>
      numExecutions=<a title="Int(20)" id="65306" class="int">20</a>
    <span class="delimiter">)</span>.<a href="Experiments.scala.html#50035" title="(implicit classSource: Seq[edu.berkeley.cs.scads.comm.ClassSource])edu.berkeley.cs.scads.comm.JvmMainTask">toJvmTask</a>
    <a href="Experiments.scala.html#50036" title="=&gt; deploylib.mesos.RemoteServiceScheduler">serviceScheduler</a>.<span title="(processes: Seq[edu.berkeley.cs.scads.comm.JvmTask])Unit">scheduleExperiment</span><span class="delimiter">(</span><a href="#65292" title="edu.berkeley.cs.scads.comm.JvmMainTask">compareTask</a> <a href="#65312" title="(x: edu.berkeley.cs.scads.comm.JvmMainTask)List[edu.berkeley.cs.scads.comm.JvmMainTask]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Mesos task to compare the response time of different physical plans for
 * the following SCADr query:
 * 
 * SELECT * FROM Subscriptions
 * WHERE owner = &lt;activeUser&gt; AND target IN [1]
 */</span>
case <span class="keyword">class</span> <a href="#94424" title="class PlanCompareTask extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with deploylib.mesos.AvroTask with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="68188">PlanCompareTask</a><a href="#68188" title="ScalaObject" class="delimiter">(</a><a href="#68188" title="()edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" id="85426" class="keyword">var</a> <a title="String" id="64456">clusterAddress</a>: <span title="String">String</span>,
			   <span class="keyword">var</span> <a title="String" id="64457">resultClusterAddress</a>: <span title="String">String</span>,
			   <span class="keyword">var</span> <a title="Int" id="64458">replicationFactor</a>: <span title="Int">Int</span> = <span title="Int(2)" class="int">2</span>,
			   <span class="keyword">var</span> <a title="Int" id="64459">iterations</a>: <span title="Int">Int</span> = <span title="Int(200)" class="int">200</span>,
			   <span class="keyword">var</span> <a title="Int" id="64460">points</a>: <span title="Int">Int</span> = <span title="Int(20)" class="int">20</span>,
			   <span class="keyword">var</span> <a title="Int" id="64461">stepSize</a>: <span title="Int">Int</span> = <span title="Int(250)" class="int">250</span>,
			   <span class="keyword">var</span> <a title="Int" id="64462">numExecutions</a>: <span title="Int">Int</span> = <span title="Int(1000)" class="int">1000</span>,
			   <span class="keyword">var</span> <a title="Int" id="64463">numFollowers</a>: <span title="Int">Int</span> = <span title="Int(50)" class="int">50</span>,
			   <span class="keyword">var</span> <a title="Int" id="64464">fetchSize</a>: <span title="Int">Int</span> = <span title="Int(1000)" class="int">1000</span>,
			   <span class="keyword">var</span> <a title="Int" id="64465">warmupTimeMin</a>: <span title="Int">Int</span> = <span title="Int(3)" class="int">3</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="deploylib.mesos.AvroTask">AvroTask</span> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="delimiter">{</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#64461" title="=&gt; Int">stepSize</a> <span title="(x: Int)Boolean">&gt;=</span> <a href="#64463" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()Unit" id="64025">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" id="65365">cluster</a> = <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">ExperimentalScadsCluster</span><span class="delimiter">(</span><span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#64456" title="=&gt; String">clusterAddress</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#65365" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="(clusterSize: Int)Unit">blockUntilReady</span><span class="delimiter">(</span><a href="#64458" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="65366">resultCluster</a> = <span title="edu.berkeley.cs.scads.storage.ScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">(</span><span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#64457" title="=&gt; String">resultClusterAddress</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" id="65367">results</a> = <a href="#65366" title="edu.berkeley.cs.scads.storage.ScadsCluster">resultCluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">[</span><a href="#68192" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]" class="delimiter">(</span><span title="java.lang.String(&quot;planCompareResults&quot;)" class="string">&quot;planCompareResults&quot;</span><span class="delimiter">)</span>
    
    <span class="comment">/**
     * Create the partition scheme for subscriptions to be a single partition over
     * the specified number of replicas
     */</span>
    <span class="keyword">val</span> <a title="List[(None.type, List[edu.berkeley.cs.scads.comm.StorageService])]" id="65368">partitions</a> = <span title="(_1: None.type, _2: List[edu.berkeley.cs.scads.comm.StorageService])(None.type, List[edu.berkeley.cs.scads.comm.StorageService])" class="delimiter">(</span><span title="object None">None</span>, <a href="#65365" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="()List[edu.berkeley.cs.scads.comm.StorageService]">getAvailableServers</span>.<span title="(n: Int)List[edu.berkeley.cs.scads.comm.StorageService]">take</span><span class="delimiter">(</span><a href="#64458" title="=&gt; Int">replicationFactor</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#65391" title="(x: (None.type, List[edu.berkeley.cs.scads.comm.StorageService]))List[(None.type, List[edu.berkeley.cs.scads.comm.StorageService])]">::</a> <span title="object Nil">Nil</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" id="65369">subscriptions</a> = <a href="#65365" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="[PairType &lt;: edu.berkeley.cs.avro.marker.AvroPair](ns: String)(implicit evidence$7: Manifest[PairType])edu.berkeley.cs.scads.storage.PairNamespace[PairType]">getNamespace</span><span title="(ns: String)(implicit evidence$7: Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</span><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.piql.scadr.Subscription]" class="delimiter">(</span><span title="java.lang.String(&quot;subscriptions&quot;)" class="string">&quot;subscriptions&quot;</span><span class="delimiter">)</span>
    
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.FixedLimit" id="65370">limit</a> = <span title="(count: Int)edu.berkeley.cs.scads.piql.FixedLimit">FixedLimit</span><span class="delimiter">(</span><a href="#64463" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.FixedLimit" id="65371">fetchLimit</a> = <span title="(count: Int)edu.berkeley.cs.scads.piql.FixedLimit">FixedLimit</span><span class="delimiter">(</span><a href="#64464" title="=&gt; Int">fetchSize</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="65372">activeUser</a> = <a href="#64027" title="(i: Int)String">toUser</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.ParallelExecutor" id="65373">executor</a> = <span title="edu.berkeley.cs.scads.piql.ParallelExecutor" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.ParallelExecutor">ParallelExecutor</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.OptimizedQuery" id="65374">naiveQuery</a> =
      <span title="edu.berkeley.cs.scads.piql.OptimizedQuery" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.OptimizedQuery">OptimizedQuery</span><span class="delimiter">(</span>
	<span title="(a: java.lang.String)Option[java.lang.String]" class="string">&quot;NaiveFollowing&quot;</span>,
	   <span title="(count: edu.berkeley.cs.scads.piql.Limit, child: edu.berkeley.cs.scads.piql.QueryPlan)edu.berkeley.cs.scads.piql.LocalStopAfter">LocalStopAfter</span><span class="delimiter">(</span><a href="#65370" title="edu.berkeley.cs.scads.piql.FixedLimit">limit</a>,
	     <span title="(predicate: edu.berkeley.cs.scads.piql.Predicate, child: edu.berkeley.cs.scads.piql.QueryPlan)edu.berkeley.cs.scads.piql.LocalSelection">LocalSelection</span><span class="delimiter">(</span><span title="(v1: edu.berkeley.cs.scads.piql.Value, v2: edu.berkeley.cs.scads.piql.Value)edu.berkeley.cs.scads.piql.InPredicate">InPredicate</span><span class="delimiter">(</span><span title="(recordPosition: Int, fieldPosition: Int)edu.berkeley.cs.scads.piql.AttributeValue">AttributeValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>,<span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, <span title="(ordinal: Int)edu.berkeley.cs.scads.piql.ParameterValue">ParameterValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span>,
	       <span title="(namespace: edu.berkeley.cs.scads.piql.package.Namespace, keyPrefix: edu.berkeley.cs.scads.piql.package.KeyGenerator, limit: edu.berkeley.cs.scads.piql.Limit, ascending: Boolean)edu.berkeley.cs.scads.piql.IndexScan">IndexScan</span><span class="delimiter">(</span><a href="#65369" title="(ns: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.piql.package#Namespace">subscriptions</a>, <a href="#65372" title="String">activeUser</a> <a href="#65566" title="(x: edu.berkeley.cs.scads.piql.ConstantValue)List[edu.berkeley.cs.scads.piql.ConstantValue]">::</a> <span title="object Nil">Nil</span>, <span title="(count: Int)edu.berkeley.cs.scads.piql.FixedLimit">FixedLimit</span><span class="delimiter">(</span><span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>,
        <a href="#65373" title="edu.berkeley.cs.scads.piql.ParallelExecutor">executor</a><span class="delimiter">)</span>
   
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.OptimizedQuery" id="65375">piqlQuery</a> =
      <span title="edu.berkeley.cs.scads.piql.OptimizedQuery" class="keyword">new</span> <span title="edu.berkeley.cs.scads.piql.OptimizedQuery">OptimizedQuery</span><span class="delimiter">(</span>
	<span title="(a: java.lang.String)Option[java.lang.String]" class="string">&quot;PiqlFollowing&quot;</span>,
	<span title="(namespace: edu.berkeley.cs.scads.piql.package.Namespace, key: edu.berkeley.cs.scads.piql.package.KeyGenerator, child: edu.berkeley.cs.scads.piql.QueryPlan)edu.berkeley.cs.scads.piql.IndexLookupJoin">IndexLookupJoin</span><span class="delimiter">(</span><a href="#65369" title="(ns: edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription])edu.berkeley.cs.scads.piql.package#Namespace">subscriptions</a>, 
		        <span title="(v: Any)edu.berkeley.cs.scads.piql.ConstantValue">ConstantValue</span><span class="delimiter">(</span><a href="#65372" title="String">activeUser</a><span class="delimiter">)</span> <a href="#65640" title="(x: Product with Serializable with edu.berkeley.cs.scads.piql.Value)List[Product with Serializable with edu.berkeley.cs.scads.piql.Value]">::</a> <span title="(recordPosition: Int, fieldPosition: Int)edu.berkeley.cs.scads.piql.AttributeValue">AttributeValue</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>,<span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#65642" title="(x: edu.berkeley.cs.scads.piql.AttributeValue)List[edu.berkeley.cs.scads.piql.AttributeValue]">::</a> <span title="object Nil">Nil</span>, 
			<span title="(parameterOrdinal: Int, wrap: Boolean)edu.berkeley.cs.scads.piql.LocalIterator">LocalIterator</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span>,
	<a href="#65373" title="edu.berkeley.cs.scads.piql.ParallelExecutor">executor</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="List[edu.berkeley.cs.scads.piql.OptimizedQuery]" id="65376">queries</a> = <a href="#65374" title="edu.berkeley.cs.scads.piql.OptimizedQuery">naiveQuery</a> <a href="#65665" title="(x: edu.berkeley.cs.scads.piql.OptimizedQuery)List[edu.berkeley.cs.scads.piql.OptimizedQuery]">::</a> <a href="#65375" title="edu.berkeley.cs.scads.piql.OptimizedQuery">piqlQuery</a> <a href="#65666" title="(x: edu.berkeley.cs.scads.piql.OptimizedQuery)List[edu.berkeley.cs.scads.piql.OptimizedQuery]">::</a> <span title="object Nil">Nil</span>

    <span class="keyword">val</span> <a title="scala.util.Random" id="65377">rand</a> = <span title="()scala.util.Random" class="keyword">new</span> scala.util.<span title="scala.util.Random">Random</span>
    <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#64459" title="=&gt; Int">iterations</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="65824">iteration</a> =&gt; <span class="delimiter">{</span>
      <a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining iteration %d&quot;)" class="string">&quot;Begining iteration %d&quot;</span>, <a href="#65824" title="Int">iteration</a><span class="delimiter">)</span>
      <span class="comment">/* clear namespaces by reseting partition scheme */</span>
      <a href="#65369" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#65369" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="()Unit">open</span><span class="delimiter">(</span><span class="delimiter">)</span>

      <a href="#65369" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])])Unit">setPartitionScheme</span><span class="delimiter">(</span><a href="#65368" title="List[(None.type, List[edu.berkeley.cs.scads.comm.StorageService])]">partitions</a><span class="delimiter">)</span>
      <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#65369" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[edu.berkeley.cs.scads.piql.scadr.Subscription]">getRange</span><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, limit=<span title="(a: Int)Option[Int]" class="int">1</span><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#64460" title="=&gt; Int">points</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="65974">point</a> =&gt; <span class="delimiter">{</span>
	<span class="comment">/* bulkload more subscriptions */</span>
	<span class="keyword">val</span> <a title="Int" id="65975">minUser</a> = <span class="delimiter">(</span><a href="#65974" title="Int">point</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(x: Int)Int">*</span> <a href="#64461" title="=&gt; Int">stepSize</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
	<span class="keyword">val</span> <a title="Int" id="65976">maxUser</a> = <a href="#65974" title="Int">point</a> <span title="(x: Int)Int">*</span> <a href="#64461" title="=&gt; Int">stepSize</a>
	<a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Measuring with %d subscriptions&quot;)" class="string">&quot;Measuring with %d subscriptions&quot;</span>, <a href="#65976" title="Int">maxUser</a><span class="delimiter">)</span>

	<a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Loading data for subscriptions %d to %d&quot;)" class="string">&quot;Loading data for subscriptions %d to %d&quot;</span>, <a href="#65975" title="Int">minUser</a>, <a href="#65976" title="Int">maxUser</a><span class="delimiter">)</span>
	<span class="keyword">val</span> <a title="view extends java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]" id="65977">newUsers</a> = <span class="delimiter">(</span><a href="#65975" title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">minUser</a> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#65976" title="Int">maxUser</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>
	<span class="keyword">val</span> <a title="scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]" id="65978">data</a> = <a href="#65977" title="view extends java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">newUsers</a>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.piql.scadr.Subscription)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]])scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,edu.berkeley.cs.scads.piql.scadr.Subscription,scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]]" class="delimiter">(</span><a title="Int" id="67040">u</a> =&gt; <span title="(owner: String, target: String)edu.berkeley.cs.scads.piql.scadr.Subscription">Subscription</span><span class="delimiter">(</span><a href="#65372" title="String">activeUser</a>, <a href="#64027" title="(i: Int)String">toUser</a><span class="delimiter">(</span><a href="#67040" title="Int">u</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
	<a href="#65369" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.scadr.Subscription])Unit">++=</span> <a href="#65978" title="scala.collection.SeqView[edu.berkeley.cs.scads.piql.scadr.Subscription,Seq[_]]">data</a>
	<a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Data size: %d&quot;)" class="string">&quot;Data size: %d&quot;</span>, <a href="#65369" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.scadr.Subscription]">subscriptions</a>.<span title="(startKey: Option[org.apache.avro.generic.IndexedRecord], endKey: Option[org.apache.avro.generic.IndexedRecord])Iterator[edu.berkeley.cs.scads.piql.scadr.Subscription]">iterateOverRange</span><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>

	<span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#65824" title="Int">iteration</a> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#65974" title="Int">point</a> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	  <a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining warmup&quot;)" class="string">&quot;Begining warmup&quot;</span><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="Long" id="67633">startTime</a> = <a href="#64026" title="=&gt; Long">currentTime</a>
	  <span class="keyword">val</span> <a title="Seq[String]" id="67634">users</a> = <a href="#64028" title="(maxUser: Int, size: Int)Seq[String]">randomUserList</a><span class="delimiter">(</span><span title="Int(10)" class="int">10</span>,<span title="Int(10)" class="int">10</span><span class="delimiter">)</span>
	  <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#64026" title="=&gt; Long">currentTime</a> <span title="(x: Long)Long">-</span> <a href="#67633" title="Long">startTime</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#64465" title="=&gt; Int">warmupTimeMin</a> <span title="(x: Int)Int">*</span> <span title="Int(60)" class="int">60</span> <span title="(x: Int)Int">*</span> <span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    <a href="#65376" title="List[edu.berkeley.cs.scads.piql.OptimizedQuery]">queries</a>.<span title="(f: edu.berkeley.cs.scads.piql.OptimizedQuery =&gt; edu.berkeley.cs.scads.piql.package.QueryResult)Unit">foreach</span><a href="#67717" title="()Unit" class="delimiter">(</a><a title="edu.berkeley.cs.scads.piql.OptimizedQuery" id="67764">q</a> =&gt; <a href="#67764" title="(args: Any*)edu.berkeley.cs.scads.piql.package.QueryResult">q</a><span class="delimiter">(</span><a href="#67634" title="Seq[String]">users</a><span class="delimiter">)</span><span class="delimiter">)</span>
	  <span class="delimiter">}</span>
	<span class="delimiter">}</span>

	<span class="comment">/* measure response time for each query given the current state of the db */</span>
	<a href="#65367" title="edu.berkeley.cs.scads.storage.PairNamespace[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">results</a> <span title="(that: TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult])Unit">++=</span>  <a href="#65376" title="List[edu.berkeley.cs.scads.piql.OptimizedQuery]">queries</a>.<span title="(f: edu.berkeley.cs.scads.piql.OptimizedQuery =&gt; edu.berkeley.cs.scads.piql.modeling.PlanCompareResult)(implicit bf: scala.collection.generic.CanBuildFrom[List[edu.berkeley.cs.scads.piql.OptimizedQuery],edu.berkeley.cs.scads.piql.modeling.PlanCompareResult,TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]])TraversableOnce[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.piql.modeling.PlanCompareResult,List[edu.berkeley.cs.scads.piql.modeling.PlanCompareResult]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.piql.OptimizedQuery" id="67785">query</a> =&gt; <span class="delimiter">{</span>
	  <a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Running %s %d times&quot;)" class="string">&quot;Running %s %d times&quot;</span>, <a href="#67785" title="edu.berkeley.cs.scads.piql.OptimizedQuery">query</a>.<span title="=&gt; Option[String]">name</span>, <a href="#64462" title="=&gt; Int">numExecutions</a><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.Histogram" id="67786">responseTimes</a> = <span title="(bucketSize: Int, bucketCount: Int)edu.berkeley.cs.scads.perf.Histogram">Histogram</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span>,<span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>

	  <span class="keyword">val</span> <a title="Long" id="67787">startMessages</a> = <span title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</span>.<span title="=&gt; Long">futureCount</span>
	  <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#64462" title="=&gt; Int">numExecutions</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.perf.Histogram)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="67914">i</a> =&gt; <span class="delimiter">{</span>
	    <span class="keyword">val</span> <a title="Seq[String]" id="67915">users</a> = <a href="#64028" title="(maxUser: Int, size: Int)Seq[String]">randomUserList</a><span class="delimiter">(</span><a href="#65976" title="Int">maxUser</a>, <a href="#64463" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>

	    <span class="keyword">val</span> <a title="Long" id="67916">startTime</a> = <a href="#64026" title="=&gt; Long">currentTime</a>
	    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.package.QueryResult" id="67917">answer</a> = <a href="#67785" title="(args: Any*)edu.berkeley.cs.scads.piql.package.QueryResult">query</a><span class="delimiter">(</span><a href="#67915" title="Seq[String]">users</a><span class="delimiter">)</span>
	    <a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Query Result: %s&quot;)" class="string">&quot;Query Result: %s&quot;</span>, <a href="#67917" title="edu.berkeley.cs.scads.piql.package.QueryResult">answer</a><span class="delimiter">)</span>
	    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#67917" title="edu.berkeley.cs.scads.piql.package.QueryResult">answer</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#64463" title="=&gt; Int">numFollowers</a><span class="delimiter">)</span>
	    <span class="keyword">var</span> <a title="Long" id="67918">endTime</a> = <a href="#64026" title="=&gt; Long">currentTime</a>

	    <a href="#67786" title="edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>.<span title="(value: Long)edu.berkeley.cs.scads.perf.Histogram">add</span><span class="delimiter">(</span><a href="#67918" title="Long">endTime</a> <span title="(x: Long)Long">-</span> <a href="#67916" title="Long">startTime</a><span class="delimiter">)</span>
	  <span class="delimiter">}</span><span class="delimiter">)</span>
	  <span class="keyword">val</span> <a title="Long" id="67788">endMessages</a> = <span title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</span>.<span title="=&gt; Long">futureCount</span>
	  <a href="#68188" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Messages sent: %d&quot;)" class="string">&quot;Messages sent: %d&quot;</span>, <a href="#67788" title="Long">endMessages</a> <span title="(x: Long)Long">-</span> <a href="#67787" title="Long">startMessages</a><span class="delimiter">)</span>

	  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult" id="67789">result</a> = <a href="#68192" title="(hostname: String, timestamp: Long, iteration: Int, point: Int, query: String, config: edu.berkeley.cs.scads.piql.modeling.PlanCompareTask)edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">PlanCompareResult</a><span class="delimiter">(</span>
	    java.net.<span title="object java.net.InetAddress">InetAddress</span>.<span title="()java.net.InetAddress">getLocalHost</span>.<span title="()java.lang.String">getHostName</span>,
	    <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>,
	    <a href="#65824" title="Int">iteration</a>,
	    <a href="#65974" title="Int">point</a>,
	    <a href="#67785" title="edu.berkeley.cs.scads.piql.OptimizedQuery">query</a>.<span title="=&gt; Option[String]">name</span>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="java.lang.String(&quot;unnamed&quot;)" class="string">&quot;unnamed&quot;</span><span class="delimiter">)</span>,
	    <a href="#68188" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareTask" class="keyword">this</a><span class="delimiter">)</span>
	  <a href="#67789" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>.<a href="#63966" title="(x$1: edu.berkeley.cs.scads.perf.Histogram)Unit">responseTimes</a> = <a href="#67786" title="edu.berkeley.cs.scads.perf.Histogram">responseTimes</a>
	  <a href="#67789" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>.<a href="#63969" title="(x$1: Long)Unit">messagesSent</a> = <a href="#67788" title="Long">endMessages</a> <span title="(x: Long)Long">-</span> <a href="#67787" title="Long">startMessages</a>
	  <a href="#67789" title="edu.berkeley.cs.scads.piql.modeling.PlanCompareResult">result</a>
	<span class="delimiter">}</span><span class="delimiter">)</span>	
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>	
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="=&gt; Long" id="64026">currentTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">nanoTime</span> <span title="(x: Int)Long">/</span> <span title="Int(1000000)" class="int">1000000</span>
  <span class="keyword">def</span> <a title="(i: Int)String" id="64027">toUser</a><span class="delimiter">(</span><a title="Int" id="65418">i</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;User%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#65418" title="Int">i</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(maxUser: Int, size: Int)Seq[String]" id="64028">randomUserList</a><span class="delimiter">(</span><a title="Int" id="67644">maxUser</a>: <span title="Int">Int</span>, <a title="Int" id="67645">size</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[Int]" id="67648">nums</a> = <span title="()scala.collection.mutable.HashSet[Int]" class="keyword">new</span> collection.mutable.<span title="scala.collection.mutable.HashSet[Int]">HashSet</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="67649">pos</a> = <span title="Int(0)" class="int">0</span>

    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#67649" title="Int">pos</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#67645" title="Int">size</a><span class="delimiter">)</span> <a href="#67650" title="()Unit" class="delimiter">{</a>
      <span class="keyword">val</span> <a title="Int" id="67656">randNum</a> = scala.util.<span title="object scala.util.Random">Random</span>.<span title="(n: Int)Int">nextInt</span><span class="delimiter">(</span><a href="#67644" title="Int">maxUser</a><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><span class="delimiter">(</span><a href="#67648" title="scala.collection.mutable.HashSet[Int]">nums</a> <span title="(elem: Int)Boolean">contains</span> <a href="#67656" title="Int">randNum</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// TODO: use a set here</span>
        <a href="#67648" title="(elem: Int, included: Boolean)Unit">nums</a><span class="delimiter">(</span><a href="#67656" title="Int">randNum</a><span class="delimiter">)</span> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#67649" title="Int">pos</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#67648" title="scala.collection.mutable.HashSet[Int]">nums</a>.<span title="=&gt; Seq[Int]">toSeq</span>.<span title="(f: Int =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Int],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="#64027" title="(i: Int)String">toUser</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>