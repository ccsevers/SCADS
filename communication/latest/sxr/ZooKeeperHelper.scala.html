<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>ZooKeeperHelper.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger

<span class="keyword">import</span> scala.concurrent.SyncVar
<span class="keyword">import</span> edu.berkeley.cs.scads.config._

<span class="keyword">import</span> org.apache.zookeeper.server._
<span class="keyword">import</span> org.apache.zookeeper.CreateMode
<span class="keyword">import</span> persistence._

<span class="keyword">import</span> java.net.InetSocketAddress

<span class="keyword">import</span> net.lag.logging.Logger

<span class="comment">/**
 * Helper object for spinning up a local zookeeper instance.  Used primarily for testing.
 */</span>
<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.ZooKeeperHelper" id="9820">ZooKeeperHelper</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="44959">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicInteger" id="44961">currentPort</a> = <span title="java.util.concurrent.atomic.AtomicInteger" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span><span class="delimiter">(</span><span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>.<span title="(key: String, defaultValue: Int)Int">getInt</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.test.zkport&quot;)" class="string">&quot;scads.test.zkport&quot;</span>, <span title="Int(2000)" class="int">2000</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">// start at port 2000</span>

  <span class="comment">//HACK because zookeper is anoyingly noisy in the logs</span>
  org.apache.log4j.<span title="object org.apache.log4j.Logger">Logger</span>.<span title="()org.apache.log4j.Logger">getRootLogger</span>.<span title="(x$1: org.apache.log4j.Level)Unit">setLevel</span><span class="delimiter">(</span>org.apache.log4j.<span title="object org.apache.log4j.Level">Level</span>.<span title="org.apache.log4j.Level">WARN</span><span class="delimiter">)</span>

  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy" id="44964">testZooKeeper</a> = <a href="#44966" title="()edu.berkeley.cs.scads.comm.ZooKeeperProxy">createTestZooKeeper</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.ZooKeeperHelper.testZooKeeper.ZooKeeperNode" id="44965">getTestZooKeeper</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#44963" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy">testZooKeeper</a>.<a href="ZooKeeperProxy.scala.html#45584" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperHelper.testZooKeeper.ZooKeeperNode">root</a>.<a href="ZooKeeperProxy.scala.html#46970" title="Array[Byte]" id="46989">createChild</a><span class="delimiter">(</span><a title="java.lang.String(&quot;testZooKeeper&quot;)" id="46987" class="string">&quot;testZooKeeper&quot;</a>, mode=CreateMode.<a title="org.apache.zookeeper.CreateMode(value PERSISTENT_SEQUENTIAL)" id="46988">PERSISTENT_SEQUENTIAL</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Create a local zookeeper instance in JVM and return a ZooKeeperProxy for it.  
   * Intended for testing purposes only. Is thread safe. Each separate
   * invocation of getTestZooKeeper creates a NEW zookeeper instance
   */</span>
   <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.ZooKeeperProxy" id="44966">createTestZooKeeper</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="ZooKeeperProxy.scala.html#9837" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">ZooKeeperProxy</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.File" id="46990">workingDir</a> = <span title="object java.io.File">File</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.io.File">createTempFile</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads&quot;)" class="string">&quot;scads&quot;</span>, <span title="java.lang.String(&quot;zookeeper&quot;)" class="string">&quot;zookeeper&quot;</span><span class="delimiter">)</span>
    <a href="#46990" title="java.io.File">workingDir</a>.<span title="()Boolean">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#46990" title="java.io.File">workingDir</a>.<span title="()Boolean">mkdir</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="scala.concurrent.SyncVar[Int]" id="46991">serverPort</a> = <span title="scala.concurrent.SyncVar[Int]" class="keyword">new</span> <span title="scala.concurrent.SyncVar[Int]">SyncVar</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>

    <span class="keyword">val</span> <a title="java.lang.Thread" id="46992">zooThread</a> = <a href="#47090" title="java.lang.Thread" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Thread" id="47090">Thread</a> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="47092">run</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <a href="#47099" title="()Unit" class="delimiter">{</a>
          <span class="keyword">val</span> <a title="Int" id="47100">tryingPort</a> = <a href="#44961" title="=&gt; java.util.concurrent.atomic.AtomicInteger">currentPort</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#44959" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Trying to start zookeeper instance on port %d&quot;)" class="string">&quot;Trying to start zookeeper instance on port %d&quot;</span>, <a href="#47100" title="Int">tryingPort</a><span class="delimiter">)</span>
          <span class="keyword">try</span> <span class="delimiter">{</span>

            <span class="comment">//val config = new ServerConfig</span>
            <span class="comment">//config.parse(Array(tryingPort.toString, workingDir.toString))</span>
            <span class="comment">//val server = new ZooKeeperServerMain</span>
            <span class="comment">//logger.info(&quot;calling runFromConfig with config %s&quot;, config)</span>
            <span class="comment">//server.runFromConfig(config)</span>

            <span class="comment">// server.runFromConfig does not give you the correct semantics to check to see if </span>
            <span class="comment">// the server successfully started up, other than polling- the following code below is</span>
            <span class="comment">// how runFromConfig is implemented, except we get to place some code after the</span>
            <span class="comment">// startup and before the join. </span>
            <span class="comment">// see: http://github.com/apache/zookeeper/blob/release-3.2.1/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java</span>

            <span class="keyword">val</span> <a title="org.apache.zookeeper.server.ZooKeeperServer" id="47105">zkServer</a> = <span title="org.apache.zookeeper.server.ZooKeeperServer" class="keyword">new</span> <span title="org.apache.zookeeper.server.ZooKeeperServer">ZooKeeperServer</span>
            <span class="keyword">val</span> <a title="org.apache.zookeeper.server.persistence.FileTxnSnapLog" id="47106">ftxn</a> = <span title="org.apache.zookeeper.server.persistence.FileTxnSnapLog" class="keyword">new</span> <span title="org.apache.zookeeper.server.persistence.FileTxnSnapLog">FileTxnSnapLog</span><span class="delimiter">(</span><a href="#46990" title="java.io.File">workingDir</a>, <a href="#46990" title="java.io.File">workingDir</a><span class="delimiter">)</span>
            <a href="#47105" title="org.apache.zookeeper.server.ZooKeeperServer">zkServer</a>.<span title="(x$1: org.apache.zookeeper.server.persistence.FileTxnSnapLog)Unit">setTxnLogFactory</span><span class="delimiter">(</span><a href="#47106" title="org.apache.zookeeper.server.persistence.FileTxnSnapLog">ftxn</a><span class="delimiter">)</span>
            <a href="#47105" title="org.apache.zookeeper.server.ZooKeeperServer">zkServer</a>.<span title="(x$1: Int)Unit">setTickTime</span><span class="delimiter">(</span>ZooKeeperServer.<span title="Int(3000)">DEFAULT_TICK_TIME</span><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="org.apache.zookeeper.server.NIOServerCnxn.Factory" id="47107">cnxnFactory</a> = <span title="(x$1: java.net.InetSocketAddress, x$2: Int)org.apache.zookeeper.server.NIOServerCnxn.Factory" class="keyword">new</span> <span title="object org.apache.zookeeper.server.NIOServerCnxn">NIOServerCnxn</span>.<span title="org.apache.zookeeper.server.NIOServerCnxn.Factory">Factory</span><span class="delimiter">(</span><span title="java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#47100" title="Int">tryingPort</a><span class="delimiter">)</span>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">// no max client connections</span>
            <a href="#47107" title="org.apache.zookeeper.server.NIOServerCnxn.Factory">cnxnFactory</a>.<span title="(x$1: org.apache.zookeeper.server.ZooKeeperServer)Unit">startup</span><span class="delimiter">(</span><a href="#47105" title="org.apache.zookeeper.server.ZooKeeperServer">zkServer</a><span class="delimiter">)</span>
            <a href="#46991" title="scala.concurrent.SyncVar[Int]">serverPort</a>.<span title="(x: Int)Unit">set</span><span class="delimiter">(</span><a href="#47100" title="Int">tryingPort</a><span class="delimiter">)</span>
            <a href="#47107" title="org.apache.zookeeper.server.NIOServerCnxn.Factory">cnxnFactory</a>.<span title="()Unit">join</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#47105" title="org.apache.zookeeper.server.ZooKeeperServer">zkServer</a>.<span title="()Boolean">isRunning</span><span class="delimiter">)</span> <a href="#47105" title="org.apache.zookeeper.server.ZooKeeperServer">zkServer</a>.<span title="()Unit">shutdown</span><span class="delimiter">(</span><span class="delimiter">)</span>

          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a title="Unit" id="48334">portInUse</a>: java.net.<span title="java.net.BindException">BindException</span> =&gt; 
              <a href="#44959" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Port %d is already in use, trying next port&quot;)" class="string">&quot;Port %d is already in use, trying next port&quot;</span>, <a href="#47100" title="Int">tryingPort</a><span class="delimiter">)</span>
            <span class="keyword">case</span> <a title="Unit" id="48354">otherError</a> =&gt; 
              <a href="#44959" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">critical</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected error when creating test zookeeper: &quot;)" class="string">&quot;Unexpected error when creating test zookeeper: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#48354" title="java.lang.Throwable">otherError</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;. Attempting again&quot;)" class="string">&quot;. Attempting again&quot;</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#46992" title="java.lang.Thread">zooThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Int" id="46993">successPort</a> = <a href="#46991" title="scala.concurrent.SyncVar[Int]">serverPort</a>.<span title="=&gt; Int">get</span> <span class="comment">// blocks until server is ready</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy" id="46994">proxy</a> = <span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy" class="keyword">new</span> <a href="ZooKeeperProxy.scala.html#9837" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">ZooKeeperProxy</a><span class="delimiter">(</span><span title="java.lang.String(&quot;localhost:&quot;)" class="string">&quot;localhost:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#46993" title="Int">successPort</a>, timeout=<span title="Int(500)" class="int">500</span><span class="delimiter">)</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#46994" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">proxy</a>.<a href="ZooKeeperProxy.scala.html#46787" title="(rpath: String)proxy.ZooKeeperNode">root</a><span class="delimiter">(</span><span title="java.lang.String(&quot;zookeeper&quot;)" class="string">&quot;zookeeper&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#46994" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">proxy</a>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>