<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Actors.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> scala.actors._
<span class="keyword">import</span> scala.actors.<span title="object scala.actors.Actor">Actor</span>._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.avro.marker.AvroRecord
<span class="keyword">import</span> edu.berkeley.cs.avro.marker.AvroUnion
<span class="keyword">import</span> collection.mutable.ArrayBuffer
<span class="keyword">import</span> concurrent.<span class="delimiter">{</span>Lock, SyncVar<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.Actors" id="9483">Actors</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> scala.actors._
  <span class="keyword">import</span> scala.actors.<span title="object scala.actors.Actor">Actor</span>._

  <span class="comment">/* TODO: link to the created actor and unregister on exit */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; Unit)scala.actors.Actor" id="12026">remoteActor</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; Unit" id="14082">body</a>: <span class="delimiter">(</span>RemoteActorProxy<span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span>: <span title="scala.actors.Actor">Actor</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="a extends java.lang.Object with scala.actors.Actor" id="14103">a</a> = <a href="#14104" title="java.lang.Object with scala.actors.Actor" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with scala.actors.Actor" id="14104">Actor</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="()Unit" id="14106">act</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="14301">ra</a> = <a href="MessageHandler.scala.html#9565" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14341" title="(a: scala.actors.Actor)edu.berkeley.cs.scads.comm.RemoteActorProxy">registerActor</a><span class="delimiter">(</span><span title="=&gt; scala.actors.Actor">self</span><span class="delimiter">)</span>
        <a href="#14082" title="(v1: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">body</a><span class="delimiter">(</span><a href="#14301" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">ra</a><span class="delimiter">)</span>
        <a href="MessageHandler.scala.html#9565" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14342" title="(ra: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">unregisterActor</a><span class="delimiter">(</span><a href="#14301" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">ra</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#14103" title="a extends java.lang.Object with scala.actors.Actor">a</a>.<span title="()scala.actors.Actor">start</span>
    <span title="Nothing" class="keyword">return</span> <a href="#14103" title="a extends java.lang.Object with scala.actors.Actor">a</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/* Generic Remote Actor Handle */</span>
case <span class="keyword">class</span> <a href="#66638" title="class RemoteActor extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.comm.RemoteActorProxy with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="27931">RemoteActor</a><a href="#27931" title="ScalaObject" class="delimiter">(</a><a href="#27931" title="()edu.berkeley.cs.scads.comm.RemoteActor" id="65045" class="keyword">var</a> <a title="String" id="27924">host</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="Int" id="27925">port</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ActorId" id="27926">id</a>: <a href="Messages.scala.html#9604" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9499" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>

<span class="comment">/* Specific types for different services. Note: these types are mostly for readability as typesafety isn't enforced when serialized individualy*/</span>
case <span class="keyword">class</span> <a href="#69158" title="class StorageService extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.comm.RemoteActorProxy with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="27920">StorageService</a><a href="#27920" title="ScalaObject" class="delimiter">(</a><a href="#27920" title="()edu.berkeley.cs.scads.comm.StorageService" id="65055" class="keyword">var</a> <a title="String" id="27913">host</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="Int" id="27914">port</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ActorId" id="27915">id</a>: <a href="Messages.scala.html#9604" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9499" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>
case <span class="keyword">class</span> <a href="#69470" title="class PartitionService extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.comm.RemoteActorProxy with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="27909">PartitionService</a><a href="#27909" title="ScalaObject" class="delimiter">(</a><a href="#27909" title="()edu.berkeley.cs.scads.comm.PartitionService" id="65065" class="keyword">var</a> <a title="String" id="27898">host</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="Int" id="27899">port</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ActorId" id="27900">id</a>: <a href="Messages.scala.html#9604" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a>, <span class="keyword">var</span> <a title="String" id="27901">partitionId</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.StorageService" id="27902">storageService</a>:<a href="#27920" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9499" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>

case <span class="keyword">class</span> <a title="class TimeoutException extends java.lang.Exception with ScalaObject with Product with Serializable" id="27894">TimeoutException</a><a href="#27894" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25074">msg</a>: <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Exception">Exception</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.RemoteActorProxy" id="9497">RemoteActorProxy</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="15826">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait RemoteActorProxy extends java.lang.Object with ScalaObject" id="9499">RemoteActorProxy</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">var</span> <a title="=&gt; String" id="14713">host</a>: <span title="String">String</span>
  <span class="keyword">var</span> <a title="=&gt; Int" id="14715">port</a>: <span title="Int">Int</span>
  <span class="keyword">var</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ActorId" id="14717">id</a>: <a href="Messages.scala.html#9604" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a>

  <span class="keyword">import</span> <a href="#9497" title="object edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a>._

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode" id="14719">remoteNode</a> = <a href="AvroChannelManager.scala.html#24018" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#14713" title="=&gt; String">host</a>, <a href="#14715" title="=&gt; Int">port</a><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="14720">toString</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="String">String</span> = <a href="#14717" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd">id</a> <span title="(other: String)java.lang.String">+</span> <span title="java.lang.String(&quot;@&quot;)" class="string">&quot;@&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#14713" title="=&gt; String">host</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:&quot;)" class="string">&quot;:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#14715" title="=&gt; Int">port</a>

  <span class="comment">/**
   * Returns an ouput proxy that forwards any messages to the remote actor with and empty sender.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; java.lang.Object with scala.actors.OutputChannel[Any]" id="14721">outputChannel</a> = <a href="#24056" title="java.lang.Object with scala.actors.OutputChannel[Any]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with scala.actors.OutputChannel[Any]" id="24056">OutputChannel</a><span class="delimiter">[</span>Any<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(msg: Any)Unit" id="24058">!</a><span class="delimiter">(</span><a title="Any" id="24062">msg</a>: <span title="Any">Any</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <a href="#24062" title="Any">msg</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="24077">msgBody</a>: <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a> =&gt; <a href="MessageHandler.scala.html#9565" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14329" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.Message)Unit">sendMessage</a><span class="delimiter">(</span><a href="#14719" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="Messages.scala.html#24095" title="(src: Option[edu.berkeley.cs.scads.comm.ActorId], dest: edu.berkeley.cs.scads.comm.ActorId, id: Option[Long], body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.Message">Message</a><span class="delimiter">(</span><span title="object None">None</span>, <a href="#14717" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a>, <span title="object None">None</span>, <a href="#24077" title="edu.berkeley.cs.scads.comm.MessageBody">msgBody</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Nothing" id="24143">otherMessage</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid remote message type:&quot;)" class="string">&quot;Invalid remote message type:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#24143" title="Any">otherMessage</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; Must extend MessageBody.&quot;)" class="string">&quot; Must extend MessageBody.&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="(msg: Any)Unit" id="24059">forward</a><span class="delimiter">(</span><a title="Any" id="24065">msg</a>: <span title="Any">Any</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(msg: Any, sender: scala.actors.OutputChannel[Any])Unit" id="24060">send</a><span class="delimiter">(</span><a title="Any" id="24068">msg</a>: <span title="Any">Any</span>, <a title="scala.actors.OutputChannel[Any]" id="24069">sender</a>: <span title="scala.actors.OutputChannel[Any]">OutputChannel</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="=&gt; scala.actors.Actor" id="24061">receiver</a>: <span title="scala.actors.Actor">Actor</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Send a message asynchronously.
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit" id="14722">!</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="24188">body</a>: <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="24189">sender</a>: <a href="#9499" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="MessageHandler.scala.html#9565" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14329" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.Message)Unit">sendMessage</a><span class="delimiter">(</span><a href="#14719" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="Messages.scala.html#24095" title="(src: Option[edu.berkeley.cs.scads.comm.ActorId], dest: edu.berkeley.cs.scads.comm.ActorId, id: Option[Long], body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.Message">Message</a><span class="delimiter">(</span><span title="(x: edu.berkeley.cs.scads.comm.ActorId)Some[edu.berkeley.cs.scads.comm.ActorId]">Some</span><span class="delimiter">(</span><a href="#24189" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">sender</a>.<a href="#14717" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a><span class="delimiter">)</span>, <a href="#14717" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a>, <span title="object None">None</span>, <a href="#24188" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Send a message and synchronously wait for a response.
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody, timeout: Int)edu.berkeley.cs.scads.comm.MessageBody" id="14723">!?</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="24194">body</a>: <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a>, <a title="Int" id="24197">timeout</a>: <span title="Int">Int</span> = <span class="int">10</span> <span title="Int(10000)">*</span> <span class="int">1000</span><span class="delimiter">)</span>: <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="24348">future</a> = <span title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">new</span> <a href="Futures.scala.html#9546" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>
      <a href="#9499" title="RemoteActorProxy.this.type" class="keyword">this</a>.<a href="#14722" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a><span class="delimiter">(</span><a href="#24194" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#24348" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24370" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
      <a href="#24348" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24379" title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</a><span class="delimiter">(</span><a href="#24197" title="=&gt; Long">timeout</a><span class="delimiter">)</span> <span title="edu.berkeley.cs.scads.comm.MessageBody" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Nothing">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteException" id="25065">exp</a>: <a href="Messages.scala.html#9617" title="edu.berkeley.cs.scads.comm.RemoteException">RemoteException</a><span class="delimiter">)</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#25065" title="edu.berkeley.cs.scads.comm.RemoteException">exp</a>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.comm.MessageBody">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25071">msg</a>: <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span> =&gt; <a href="#25071" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a>
        <span class="keyword">case</span> <span title="Nothing">None</span> =&gt; <span class="delimiter">{</span>
          <a href="#24348" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24382" title="=&gt; Unit">cancel</a>
          <span title="Nothing" class="keyword">throw</span> <a href="#27894" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.TimeoutException">TimeoutException</a><span class="delimiter">(</span><a href="#24194" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Sends a message and returns a future for the response.
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture" id="14724">!!</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25078">body</a>: <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span>: <a href="Futures.scala.html#9546" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="25080">future</a> = <span title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">new</span> <a href="Futures.scala.html#9546" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>
    <a href="#9499" title="RemoteActorProxy.this.type" class="keyword">this</a>.<a href="#14722" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a><span class="delimiter">(</span><a href="#25078" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#25080" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24370" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
    <a href="#25080" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]" id="14726">msgSet</a> = List<span class="delimiter">[</span><span class="delimiter">(</span>MessageBody, MessageFuture<span class="delimiter">)</span><span class="delimiter">]</span><span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Collects messages for bulk-send
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture" id="14728">!!!</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25081">body</a> : <a href="Messages.scala.html#9603" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span> : <a href="Futures.scala.html#9546" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="25083">future</a> = <span title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">new</span> <a href="Futures.scala.html#9546" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>
    <a href="#9499" title="(x$1: Unit)Unit">synchronized</a><span class="delimiter">{</span>
      <a href="#14726" title="(x$1: List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)])Unit">msgSet</a> <span title="(x: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture))List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">::=</span> <span title="(_1: edu.berkeley.cs.scads.comm.MessageBody, _2: edu.berkeley.cs.scads.comm.MessageFuture)(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">Tuple2</span><span class="delimiter">(</span><a href="#25081" title="edu.berkeley.cs.scads.comm.MessageBody">body</a>, <a href="#25083" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <a href="#25083" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="14729">commit</a><span class="delimiter">(</span><span class="delimiter">)</span> : <span title="Unit">Unit</span> = <a href="#9499" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]" id="27378">currentSet</a> = <a href="#14726" title="=&gt; List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">msgSet</a>
    <a href="#14726" title="(x$1: List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)])Unit">msgSet</a> = <span title="object Nil">Nil</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#15826" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Falling back to normal send for commit size 1&quot;)" class="string">&quot;Falling back to normal send for commit size 1&quot;</span><span class="delimiter">)</span>
      <a href="#9499" title="RemoteActorProxy.this.type" class="keyword">this</a>.<a href="#14722" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a><span class="delimiter">(</span><a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">head</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">_1</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">head</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">_2</span>.<a href="Futures.scala.html#24370" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="27452">batchFuture</a> = <a href="#14724" title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.comm.BatchRequest" class="keyword">new</span> <a href="Messages.scala.html#9664" title="edu.berkeley.cs.scads.comm.BatchRequest">BatchRequest</a><span class="delimiter">(</span><a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; edu.berkeley.cs.scads.comm.MessageBody)(implicit bf: scala.collection.generic.CanBuildFrom[List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)],edu.berkeley.cs.scads.comm.MessageBody,Seq[edu.berkeley.cs.scads.comm.MessageBody]])Seq[edu.berkeley.cs.scads.comm.MessageBody]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.comm.MessageBody,List[edu.berkeley.cs.scads.comm.MessageBody]]" class="delimiter">(</span><a href="#27494" title="(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">_1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#27452" title="edu.berkeley.cs.scads.comm.MessageFuture">batchFuture</a>.<a href="Futures.scala.html#24377" title="(r: edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit)Unit">respond</a> <a href="#27559" title="Unit" class="delimiter">{</a>
        <span class="keyword">case</span> <span title="Unit">BatchResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageBody]" id="27588">ranges</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#15826" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">trace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unpacking %d messages to %d futures&quot;)" class="string">&quot;Unpacking %d messages to %d futures&quot;</span>, <a href="#27588" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="=&gt; Int">length</span>, <a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
          <a href="#27588" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="(that: scala.collection.GenIterable[edu.berkeley.cs.scads.comm.MessageFuture])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.MessageBody],(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture),Seq[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]])Seq[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture),Seq[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]]" class="delimiter">(</span><a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)],edu.berkeley.cs.scads.comm.MessageFuture,List[edu.berkeley.cs.scads.comm.MessageFuture]])List[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.comm.MessageFuture,List[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#27626" title="(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; Unit)Unit">foreach</span> <a href="#27811" title="Unit" class="delimiter">{</a>
            <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="27814">msg</a>, <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="27815">subFuture</a><span class="delimiter">)</span> =&gt; <a href="#27815" title="edu.berkeley.cs.scads.comm.MessageFuture">subFuture</a>.<a href="Futures.scala.html#24384" title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#27452" title="edu.berkeley.cs.scads.comm.MessageFuture">batchFuture</a>.<a href="Futures.scala.html#24373" title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</a>, <a href="#27814" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Unit" id="27847">unexp</a> =&gt; <span class="delimiter">{</span>
          <a href="#15826" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Batch request failed with unexpected message: %s&quot;)" class="string">&quot;Batch request failed with unexpected message: %s&quot;</span>, <a href="#27847" title="edu.berkeley.cs.scads.comm.MessageBody">unexp</a><span class="delimiter">)</span>
          <a href="#27378" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#27871" title="(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">_2</span>.<a href="Futures.scala.html#24384" title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#27452" title="edu.berkeley.cs.scads.comm.MessageFuture">batchFuture</a>.<a href="Futures.scala.html#24373" title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</a>, <a href="#27847" title="edu.berkeley.cs.scads.comm.MessageBody">unexp</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/* Handle type conversion methods.  Note: Not typesafe obviously */</span>
  <span class="keyword">def</span> <a title="(partitionId: String, storageService: edu.berkeley.cs.scads.comm.StorageService)edu.berkeley.cs.scads.comm.PartitionService" id="14730">toPartitionService</a><span class="delimiter">(</span><a title="String" id="27874">partitionId</a> : <span title="String">String</span>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="27875">storageService</a> : <a href="#27920" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a><span class="delimiter">)</span>: <a href="#27909" title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</a> = <span title="edu.berkeley.cs.scads.comm.PartitionService" class="keyword">new</span> <a href="#27909" title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</a><span class="delimiter">(</span><a href="#14713" title="=&gt; String">host</a>, <a href="#14715" title="=&gt; Int">port</a>, <a href="#14717" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a>, <a href="#27874" title="String">partitionId</a>, <a href="#27875" title="edu.berkeley.cs.scads.comm.StorageService">storageService</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.StorageService" id="14731">toStorageService</a>: <a href="#27920" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a> = <span title="edu.berkeley.cs.scads.comm.StorageService" class="keyword">new</span> <a href="#27920" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a><span class="delimiter">(</span><a href="#14713" title="=&gt; String">host</a>, <a href="#14715" title="=&gt; Int">port</a>, <a href="#14717" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a><span class="delimiter">)</span>
<span class="delimiter">}</span>


        </pre>
    </body>
</html>