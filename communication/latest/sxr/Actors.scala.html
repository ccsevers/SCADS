<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Actors.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> scala.actors._
<span class="keyword">import</span> scala.actors.<span title="object scala.actors.Actor">Actor</span>._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.avro.marker.AvroRecord
<span class="keyword">import</span> edu.berkeley.cs.avro.marker.AvroUnion
<span class="keyword">import</span> collection.mutable.ArrayBuffer
<span class="keyword">import</span> concurrent.<span class="delimiter">{</span>Lock, SyncVar<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.Actors" id="9481">Actors</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> scala.actors._
  <span class="keyword">import</span> scala.actors.<span title="object scala.actors.Actor">Actor</span>._

  <span class="comment">/* TODO: link to the created actor and unregister on exit */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; Unit)scala.actors.Actor" id="12028">remoteActor</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; Unit" id="14084">body</a>: <span class="delimiter">(</span>RemoteActorProxy<span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span>: <span title="scala.actors.Actor">Actor</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="a extends java.lang.Object with scala.actors.Actor" id="14105">a</a> = <a href="#14106" title="java.lang.Object with scala.actors.Actor" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with scala.actors.Actor" id="14106">Actor</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="()Unit" id="14108">act</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="14303">ra</a> = <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14343" title="(a: scala.actors.Actor)edu.berkeley.cs.scads.comm.RemoteActorProxy">registerActor</a><span class="delimiter">(</span><span title="=&gt; scala.actors.Actor">self</span><span class="delimiter">)</span>
        <a href="#14084" title="(v1: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">body</a><span class="delimiter">(</span><a href="#14303" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">ra</a><span class="delimiter">)</span>
        <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14344" title="(ra: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">unregisterActor</a><span class="delimiter">(</span><a href="#14303" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">ra</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#14105" title="a extends java.lang.Object with scala.actors.Actor">a</a>.<span title="()scala.actors.Actor">start</span>
    <span title="Nothing" class="keyword">return</span> <a href="#14105" title="a extends java.lang.Object with scala.actors.Actor">a</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/* Generic Remote Actor Handle */</span>
case <span class="keyword">class</span> <a href="#66642" title="class RemoteActor extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.comm.RemoteActorProxy with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="27937">RemoteActor</a><a href="#27937" title="ScalaObject" class="delimiter">(</a><a href="#27937" title="()edu.berkeley.cs.scads.comm.RemoteActor" id="65049" class="keyword">var</a> <a title="String" id="27930">host</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="Int" id="27931">port</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ActorId" id="27932">id</a>: <a href="Messages.scala.html#9602" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9497" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>

<span class="comment">/* Specific types for different services. Note: these types are mostly for readability as typesafety isn't enforced when serialized individualy*/</span>
case <span class="keyword">class</span> <a href="#69162" title="class StorageService extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.comm.RemoteActorProxy with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="27926">StorageService</a><a href="#27926" title="ScalaObject" class="delimiter">(</a><a href="#27926" title="()edu.berkeley.cs.scads.comm.StorageService" id="65059" class="keyword">var</a> <a title="String" id="27919">host</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="Int" id="27920">port</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ActorId" id="27921">id</a>: <a href="Messages.scala.html#9602" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9497" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>
case <span class="keyword">class</span> <a href="#69474" title="class PartitionService extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.comm.RemoteActorProxy with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="27915">PartitionService</a><a href="#27915" title="ScalaObject" class="delimiter">(</a><a href="#27915" title="()edu.berkeley.cs.scads.comm.PartitionService" id="65069" class="keyword">var</a> <a title="String" id="27904">host</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="Int" id="27905">port</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ActorId" id="27906">id</a>: <a href="Messages.scala.html#9602" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a>, <span class="keyword">var</span> <a title="String" id="27907">partitionId</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.StorageService" id="27908">storageService</a>:<a href="#27926" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9497" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>

case <span class="keyword">class</span> <a title="class TimeoutException extends java.lang.Exception with ScalaObject with Product with Serializable" id="27900">TimeoutException</a><a href="#27900" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25080">msg</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Exception">Exception</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.RemoteActorProxy" id="9495">RemoteActorProxy</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="15832">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait RemoteActorProxy extends java.lang.Object with ScalaObject" id="9497">RemoteActorProxy</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">var</span> <a title="=&gt; String" id="14719">host</a>: <span title="String">String</span>
  <span class="keyword">var</span> <a title="=&gt; Int" id="14721">port</a>: <span title="Int">Int</span>
  <span class="keyword">var</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ActorId" id="14723">id</a>: <a href="Messages.scala.html#9602" title="edu.berkeley.cs.scads.comm.ActorId">ActorId</a>

  <span class="keyword">import</span> <a href="#9495" title="object edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a>._

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode" id="14725">remoteNode</a> = <a href="AvroChannelManager.scala.html#24024" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#14719" title="=&gt; String">host</a>, <a href="#14721" title="=&gt; Int">port</a><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="14726">toString</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="String">String</span> = <a href="#14723" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd">id</a> <span title="(other: String)java.lang.String">+</span> <span title="java.lang.String(&quot;@&quot;)" class="string">&quot;@&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#14719" title="=&gt; String">host</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:&quot;)" class="string">&quot;:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#14721" title="=&gt; Int">port</a>

  <span class="comment">/**
   * Returns an ouput proxy that forwards any messages to the remote actor with and empty sender.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; java.lang.Object with scala.actors.OutputChannel[Any]" id="14727">outputChannel</a> = <a href="#24062" title="java.lang.Object with scala.actors.OutputChannel[Any]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with scala.actors.OutputChannel[Any]" id="24062">OutputChannel</a><span class="delimiter">[</span>Any<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(msg: Any)Unit" id="24064">!</a><span class="delimiter">(</span><a title="Any" id="24068">msg</a>: <span title="Any">Any</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <a href="#24068" title="Any">msg</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="24083">msgBody</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a> =&gt; <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14331" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.Message)Unit">sendMessage</a><span class="delimiter">(</span><a href="#14725" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="Messages.scala.html#24101" title="(src: Option[edu.berkeley.cs.scads.comm.ActorId], dest: edu.berkeley.cs.scads.comm.ActorId, id: Option[Long], body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.Message">Message</a><span class="delimiter">(</span><span title="object None">None</span>, <a href="#14723" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a>, <span title="object None">None</span>, <a href="#24083" title="edu.berkeley.cs.scads.comm.MessageBody">msgBody</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Nothing" id="24149">otherMessage</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid remote message type:&quot;)" class="string">&quot;Invalid remote message type:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#24149" title="Any">otherMessage</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; Must extend MessageBody.&quot;)" class="string">&quot; Must extend MessageBody.&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="(msg: Any)Unit" id="24065">forward</a><span class="delimiter">(</span><a title="Any" id="24071">msg</a>: <span title="Any">Any</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(msg: Any, sender: scala.actors.OutputChannel[Any])Unit" id="24066">send</a><span class="delimiter">(</span><a title="Any" id="24074">msg</a>: <span title="Any">Any</span>, <a title="scala.actors.OutputChannel[Any]" id="24075">sender</a>: <span title="scala.actors.OutputChannel[Any]">OutputChannel</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="=&gt; scala.actors.Actor" id="24067">receiver</a>: <span title="scala.actors.Actor">Actor</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Send a message asynchronously.
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit" id="14728">!</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="24194">body</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="24195">sender</a>: <a href="#9497" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14331" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.Message)Unit">sendMessage</a><span class="delimiter">(</span><a href="#14725" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="Messages.scala.html#24101" title="(src: Option[edu.berkeley.cs.scads.comm.ActorId], dest: edu.berkeley.cs.scads.comm.ActorId, id: Option[Long], body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.Message">Message</a><span class="delimiter">(</span><span title="(x: edu.berkeley.cs.scads.comm.ActorId)Some[edu.berkeley.cs.scads.comm.ActorId]">Some</span><span class="delimiter">(</span><a href="#24195" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">sender</a>.<a href="#14723" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a><span class="delimiter">)</span>, <a href="#14723" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a>, <span title="object None">None</span>, <a href="#24194" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Send a message and synchronously wait for a response.
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody, timeout: Int)edu.berkeley.cs.scads.comm.MessageBody" id="14729">!?</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="24200">body</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a>, <a title="Int" id="24203">timeout</a>: <span title="Int">Int</span> = <span class="int">10</span> <span title="Int(10000)">*</span> <span class="int">1000</span><span class="delimiter">)</span>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="24354">future</a> = <span title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">new</span> <a href="Futures.scala.html#9544" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>
      <a href="#9497" title="RemoteActorProxy.this.type" class="keyword">this</a>.<a href="#14728" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a><span class="delimiter">(</span><a href="#24200" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#24354" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24376" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
      <a href="#24354" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24385" title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</a><span class="delimiter">(</span><a href="#24203" title="=&gt; Long">timeout</a><span class="delimiter">)</span> <span title="edu.berkeley.cs.scads.comm.MessageBody" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Nothing">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteException" id="25071">exp</a>: <a href="Messages.scala.html#9615" title="edu.berkeley.cs.scads.comm.RemoteException">RemoteException</a><span class="delimiter">)</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#25071" title="edu.berkeley.cs.scads.comm.RemoteException">exp</a>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.comm.MessageBody">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25077">msg</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span> =&gt; <a href="#25077" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a>
        <span class="keyword">case</span> <span title="Nothing">None</span> =&gt; <span class="delimiter">{</span>
          <a href="#24354" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24388" title="=&gt; Unit">cancel</a>
          <span title="Nothing" class="keyword">throw</span> <a href="#27900" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.TimeoutException">TimeoutException</a><span class="delimiter">(</span><a href="#24200" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Sends a message and returns a future for the response.
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture" id="14730">!!</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25084">body</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span>: <a href="Futures.scala.html#9544" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="25086">future</a> = <span title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">new</span> <a href="Futures.scala.html#9544" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>
    <a href="#9497" title="RemoteActorProxy.this.type" class="keyword">this</a>.<a href="#14728" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a><span class="delimiter">(</span><a href="#25084" title="edu.berkeley.cs.scads.comm.MessageBody">body</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#25086" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="Futures.scala.html#24376" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
    <a href="#25086" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]" id="14732">msgSet</a> = List<span class="delimiter">[</span><span class="delimiter">(</span>MessageBody, MessageFuture<span class="delimiter">)</span><span class="delimiter">]</span><span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Collects messages for bulk-send
   */</span>
  <span class="keyword">def</span> <a title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture" id="14734">!!!</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="25087">body</a> : <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span> : <a href="Futures.scala.html#9544" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="25089">future</a> = <span title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">new</span> <a href="Futures.scala.html#9544" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>
    <a href="#9497" title="(x$1: Unit)Unit">synchronized</a><span class="delimiter">{</span>
      <a href="#14732" title="(x$1: List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)])Unit">msgSet</a> <span title="(x: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture))List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">::=</span> <span title="(_1: edu.berkeley.cs.scads.comm.MessageBody, _2: edu.berkeley.cs.scads.comm.MessageFuture)(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">Tuple2</span><span class="delimiter">(</span><a href="#25087" title="edu.berkeley.cs.scads.comm.MessageBody">body</a>, <a href="#25089" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <a href="#25089" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="14735">commit</a><span class="delimiter">(</span><span class="delimiter">)</span> : <span title="Unit">Unit</span> = <a href="#9497" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]" id="27384">currentSet</a> = <a href="#14732" title="=&gt; List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">msgSet</a>
    <a href="#14732" title="(x$1: List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)])Unit">msgSet</a> = <span title="object Nil">Nil</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#15832" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Falling back to normal send for commit size 1&quot;)" class="string">&quot;Falling back to normal send for commit size 1&quot;</span><span class="delimiter">)</span>
      <a href="#9497" title="RemoteActorProxy.this.type" class="keyword">this</a>.<a href="#14728" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a><span class="delimiter">(</span><a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">head</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">_1</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">head</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">_2</span>.<a href="Futures.scala.html#24376" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="27458">batchFuture</a> = <a href="#14730" title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.comm.BatchRequest" class="keyword">new</span> <a href="Messages.scala.html#9662" title="edu.berkeley.cs.scads.comm.BatchRequest">BatchRequest</a><span class="delimiter">(</span><a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; edu.berkeley.cs.scads.comm.MessageBody)(implicit bf: scala.collection.generic.CanBuildFrom[List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)],edu.berkeley.cs.scads.comm.MessageBody,Seq[edu.berkeley.cs.scads.comm.MessageBody]])Seq[edu.berkeley.cs.scads.comm.MessageBody]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.comm.MessageBody,List[edu.berkeley.cs.scads.comm.MessageBody]]" class="delimiter">(</span><a href="#27500" title="(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">_1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#27458" title="edu.berkeley.cs.scads.comm.MessageFuture">batchFuture</a>.<a href="Futures.scala.html#24383" title="(r: edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit)Unit">respond</a> <a href="#27565" title="Unit" class="delimiter">{</a>
        <span class="keyword">case</span> <span title="Unit">BatchResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageBody]" id="27594">ranges</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#15832" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">trace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unpacking %d messages to %d futures&quot;)" class="string">&quot;Unpacking %d messages to %d futures&quot;</span>, <a href="#27594" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="=&gt; Int">length</span>, <a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
          <a href="#27594" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="(that: scala.collection.GenIterable[edu.berkeley.cs.scads.comm.MessageFuture])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.MessageBody],(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture),Seq[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]])Seq[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture),Seq[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]]" class="delimiter">(</span><a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)],edu.berkeley.cs.scads.comm.MessageFuture,List[edu.berkeley.cs.scads.comm.MessageFuture]])List[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.comm.MessageFuture,List[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#27632" title="(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; Unit)Unit">foreach</span> <a href="#27817" title="Unit" class="delimiter">{</a>
            <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="27820">msg</a>, <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="27821">subFuture</a><span class="delimiter">)</span> =&gt; <a href="#27821" title="edu.berkeley.cs.scads.comm.MessageFuture">subFuture</a>.<a href="Futures.scala.html#24390" title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#27458" title="edu.berkeley.cs.scads.comm.MessageFuture">batchFuture</a>.<a href="Futures.scala.html#24379" title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</a>, <a href="#27820" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Unit" id="27853">unexp</a> =&gt; <span class="delimiter">{</span>
          <a href="#15832" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Batch request failed with unexpected message: %s&quot;)" class="string">&quot;Batch request failed with unexpected message: %s&quot;</span>, <a href="#27853" title="edu.berkeley.cs.scads.comm.MessageBody">unexp</a><span class="delimiter">)</span>
          <a href="#27384" title="List[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)]">currentSet</a>.<span title="(f: (edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#27877" title="(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.MessageFuture)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">_2</span>.<a href="Futures.scala.html#24390" title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#27458" title="edu.berkeley.cs.scads.comm.MessageFuture">batchFuture</a>.<a href="Futures.scala.html#24379" title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</a>, <a href="#27853" title="edu.berkeley.cs.scads.comm.MessageBody">unexp</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/* Handle type conversion methods.  Note: Not typesafe obviously */</span>
  <span class="keyword">def</span> <a title="(partitionId: String, storageService: edu.berkeley.cs.scads.comm.StorageService)edu.berkeley.cs.scads.comm.PartitionService" id="14736">toPartitionService</a><span class="delimiter">(</span><a title="String" id="27880">partitionId</a> : <span title="String">String</span>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="27881">storageService</a> : <a href="#27926" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a><span class="delimiter">)</span>: <a href="#27915" title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</a> = <span title="edu.berkeley.cs.scads.comm.PartitionService" class="keyword">new</span> <a href="#27915" title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</a><span class="delimiter">(</span><a href="#14719" title="=&gt; String">host</a>, <a href="#14721" title="=&gt; Int">port</a>, <a href="#14723" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a>, <a href="#27880" title="String">partitionId</a>, <a href="#27881" title="edu.berkeley.cs.scads.comm.StorageService">storageService</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.StorageService" id="14737">toStorageService</a>: <a href="#27926" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a> = <span title="edu.berkeley.cs.scads.comm.StorageService" class="keyword">new</span> <a href="#27926" title="edu.berkeley.cs.scads.comm.StorageService">StorageService</a><span class="delimiter">(</span><a href="#14719" title="=&gt; String">host</a>, <a href="#14721" title="=&gt; Int">port</a>, <a href="#14723" title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</a><span class="delimiter">)</span>
<span class="delimiter">}</span>


        </pre>
    </body>
</html>