<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>ZooKeeperProxy.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> org.apache.zookeeper.<span class="delimiter">{</span>ZooKeeper, Watcher, WatchedEvent, CreateMode, ZooDefs<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.zookeeper.<span title="object org.apache.zookeeper.Watcher">Watcher</span>.<span title="object org.apache.zookeeper.Watcher.Event">Event</span>.EventType
<span class="keyword">import</span> org.apache.zookeeper.<span title="object org.apache.zookeeper.Watcher">Watcher</span>.<span title="object org.apache.zookeeper.Watcher.Event">Event</span>.KeeperState
<span class="keyword">import</span> org.apache.zookeeper.data.Stat
<span class="keyword">import</span> scala.collection.mutable.HashMap
<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span> ConcurrentHashMap, TimeUnit <span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.RClusterZoo" id="9833">RClusterZoo</a> <a href="#48366" title="ScalaObject" class="keyword">extends</a> <a href="#9838" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">ZooKeeperProxy</a><span class="delimiter">(</span><span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <span title="Int(3)" class="int">3</span><span class="delimiter">)</span>.<span title="(f: Int =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],String,scala.collection.immutable.IndexedSeq[String]])scala.collection.immutable.IndexedSeq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,String,scala.collection.immutable.IndexedSeq[String]]" class="delimiter">(</span><a title="Int" id="48512">i</a> =&gt; <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;zoo%d.millennium.berkeley.edu&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#48512" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.ZooKeeperNode" id="9835">ZooKeeperNode</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="scala.util.matching.Regex" id="48623">uriRegEx</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&quot;&quot;zk://([^/]*)/(.*)&quot;&quot;&quot;</span>.<span title="=&gt; scala.util.matching.Regex">r</span>
  <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.comm.ZooKeeperProxy]" id="48625">clientConnections</a> = <span title="()scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.comm.ZooKeeperProxy]" class="keyword">new</span> scala.collection.mutable.<span title="scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.comm.ZooKeeperProxy]">HashMap</span><span class="delimiter">[</span>String,ZooKeeperProxy<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy" id="48627">getConnection</a><span class="delimiter">(</span><a title="String" id="49217">uri</a>:<span title="String">String</span><span class="delimiter">)</span>:<a href="#9838" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">ZooKeeperProxy</a> = <span class="delimiter">{</span>
    <span title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy)edu.berkeley.cs.scads.comm.ZooKeeperProxy">synchronized</span> <span class="delimiter">{</span>
      <a href="#48625" title="=&gt; scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.comm.ZooKeeperProxy]">clientConnections</a>.<span title="(key: String, op: =&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy)edu.berkeley.cs.scads.comm.ZooKeeperProxy">getOrElseUpdate</span><span class="delimiter">(</span><a href="#49217" title="String">uri</a>,<a href="#48366" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy" class="keyword">new</a> <a href="#9838" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">ZooKeeperProxy</a><span class="delimiter">(</span><a href="#49217" title="String">uri</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="48628">apply</a><span class="delimiter">(</span><a title="String" id="49225">uri</a>: <span title="String">String</span><span class="delimiter">)</span>: ZooKeeperProxy#<a href="#45590" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</a> = <a href="#49225" title="String">uri</a> <span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <a href="#48623" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">uriRegEx</a><span class="delimiter">(</span><a title="String" id="49234">address</a>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span> =&gt; <a href="#48627" title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy">getConnection</a><span class="delimiter">(</span><a href="#49234" title="String">address</a><span class="delimiter">)</span>.<a href="#45584" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>
    <span class="keyword">case</span> <a href="#48623" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">uriRegEx</a><span class="delimiter">(</span><a title="String" id="49238">address</a>, <a title="String" id="49239">path</a><span class="delimiter">)</span> =&gt; <a href="#48627" title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy">getConnection</a><span class="delimiter">(</span><a href="#49238" title="String">address</a><span class="delimiter">)</span>.<a href="#45584" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="49248">root</a>.<a href="#49243" title="Int" id="49252">getOrCreate</a><span class="delimiter">(</span><a href="#49239" title="String" id="49251">path</a><span class="delimiter">)</span>
    <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid ZooKeeper URI: &quot;)" class="string">&quot;Invalid ZooKeeper URI: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#49225" title="String">uri</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Scalafied interface to Zookeeper
 * TODO: Add the ability to execute callbacks on watches (possibly with weak references to callbacks)
 * TODO: Add actor handle serializing and deserializing with linking to the created ephemeral node.
 * TODO: Recreate ephemeral nodes on reconnect.
 *
 * Instances of ZooKeeperProxy and ZooKeeperNode are thread-safe 
 */</span>
<span class="keyword">class</span> <a title="class ZooKeeperProxy extends java.lang.Object with org.apache.zookeeper.Watcher with ScalaObject" id="9838">ZooKeeperProxy</a><a href="#9838" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="String" id="48364">address</a>: <span title="String">String</span>, <span class="keyword">val</span> <a title="Int" id="48366">timeout</a>: <span title="Int">Int</span> = <span title="Int(30000)" class="int">30000</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="org.apache.zookeeper.Watcher">Watcher</span> <span class="delimiter">{</span>
  self =&gt;
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#48364" title="=&gt; String">address</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="45575">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">// must be volatile because it's set from watcher thread</span>
  @volatile <span class="keyword">protected</span> <span class="keyword">var</span> <a title="org.apache.zookeeper.ZooKeeper" id="45578">conn</a> = <a href="#45581" title="()org.apache.zookeeper.ZooKeeper">newConenction</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Seq[String]" id="45580">servers</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <a href="#48364" title="=&gt; String">address</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.WrappedArray[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()org.apache.zookeeper.ZooKeeper" id="45581">newConenction</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="org.apache.zookeeper.ZooKeeper">ZooKeeper</span> = <span class="delimiter">{</span>
    <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Opening Zookeeper Connection to %s with timeout %d&quot;)" class="string">&quot;[%s] Opening Zookeeper Connection to %s with timeout %d&quot;</span>,<span title="object java.lang.Thread">Thread</span>.<span title="()java.lang.Thread">currentThread</span>.<span title="()java.lang.String">getName</span>, <a href="#48364" title="=&gt; String">address</a>, <a href="#48366" title="=&gt; Int">timeout</a><span class="delimiter">)</span>
    <span title="org.apache.zookeeper.ZooKeeper" class="keyword">new</span> <span title="org.apache.zookeeper.ZooKeeper">ZooKeeper</span><span class="delimiter">(</span><a href="#48364" title="=&gt; String">address</a>, <a href="#48366" title="=&gt; Int">timeout</a>, <a href="#9838" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy" class="keyword">this</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** 
   * maintains a canonical mapping of (full) zookeeper path to a zookeeper
   * node. 
   * TODO: remove the canonical map
   */</span>
  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]" id="45582">canonicalMap</a> = <span title="()java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">ConcurrentHashMap</span><span class="delimiter">[</span>String, ZooKeeperNode<span class="delimiter">]</span>

  <span class="keyword">val</span> <a title="ZooKeeperProxy.this.ZooKeeperNode" id="45584">root</a> = <a href="#45588" title="(fullPath: String, newNode: =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">getOrElseUpdateNode</a><span class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span>, <span title="ZooKeeperProxy.this.ZooKeeperNode" class="keyword">new</span> <a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode">ZooKeeperNode</a><span class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()Unit" id="45586">close</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(fullPath: String)Option[ZooKeeperProxy.this.ZooKeeperNode]" id="45587">getNode</a><span class="delimiter">(</span><a title="String" id="49532">fullPath</a>: <span title="String">String</span><span class="delimiter">)</span> =
    <span title="(x: ZooKeeperProxy.this.ZooKeeperNode)Option[ZooKeeperProxy.this.ZooKeeperNode]">Option</span><span class="delimiter">(</span><a href="#45582" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">canonicalMap</a>.<span title="(x$1: Any)ZooKeeperProxy.this.ZooKeeperNode">get</span><span class="delimiter">(</span><a href="#49532" title="String">fullPath</a><span class="delimiter">)</span><span class="delimiter">)</span> 

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(fullPath: String, newNode: =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode" id="45588">getOrElseUpdateNode</a><span class="delimiter">(</span><a title="String" id="45594">fullPath</a>: <span title="String">String</span>, <a title="=&gt; ZooKeeperProxy.this.ZooKeeperNode" id="45595">newNode</a>: =&gt; ZooKeeperNode<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="ZooKeeperProxy.this.ZooKeeperNode" id="45598">test0</a> = <a href="#45582" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">canonicalMap</a>.<span title="(x$1: Any)ZooKeeperProxy.this.ZooKeeperNode">get</span><span class="delimiter">(</span><a href="#45594" title="String">fullPath</a><span class="delimiter">)</span>
    <span title="ZooKeeperProxy.this.ZooKeeperNode" class="keyword">if</span> <span class="delimiter">(</span><a href="#45598" title="ZooKeeperProxy.this.ZooKeeperNode">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45598" title="ZooKeeperProxy.this.ZooKeeperNode">test0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// TODO: don't grab lock, but use futures</span>
      <a href="#9838" title="(x$1: ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">synchronized</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="ZooKeeperProxy.this.ZooKeeperNode" id="46864">test1</a> = <a href="#45582" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">canonicalMap</a>.<span title="(x$1: Any)ZooKeeperProxy.this.ZooKeeperNode">get</span><span class="delimiter">(</span><a href="#45594" title="String">fullPath</a><span class="delimiter">)</span> <span class="comment">// check again</span>
        <span title="ZooKeeperProxy.this.ZooKeeperNode" class="keyword">if</span> <span class="delimiter">(</span><a href="#46864" title="ZooKeeperProxy.this.ZooKeeperNode">test1</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#46864" title="ZooKeeperProxy.this.ZooKeeperNode">test1</a>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="ZooKeeperProxy.this.ZooKeeperNode" id="46865">newNode0</a> = <a href="#45595" title="=&gt; ZooKeeperProxy.this.ZooKeeperNode">newNode</a> <span class="comment">// only can evaluate newNode once</span>
          <span class="keyword">val</span> <a title="ZooKeeperProxy.this.ZooKeeperNode" id="46866">test2</a> = <a href="#45582" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">canonicalMap</a>.<span title="(x$1: String, x$2: ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">put</span><span class="delimiter">(</span><a href="#46865" title="ZooKeeperProxy.this.ZooKeeperNode">newNode0</a>.<a href="#46965" title="=&gt; String">path</a>, <a href="#46865" title="ZooKeeperProxy.this.ZooKeeperNode">newNode0</a><span class="delimiter">)</span>
          <span class="comment">//assert(test2 eq null, &quot;newNode should not produce name collisions: alreadyPresent %s, newNode %s&quot;.format(test2.path, newNode0.path))</span>
          <span class="comment">//logger.info(&quot;newNode was placed into canonicalMap: %s&quot;, newNode0.path)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#46866" title="ZooKeeperProxy.this.ZooKeeperNode">test2</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
            <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;replacing stale entry (most likely an ephemeral node which was deleted from another client): %s&quot;)" class="string">&quot;replacing stale entry (most likely an ephemeral node which was deleted from another client): %s&quot;</span>, <a href="#46865" title="ZooKeeperProxy.this.ZooKeeperNode">newNode0</a>.<a href="#46965" title="=&gt; String">path</a><span class="delimiter">)</span>
          <a href="#46865" title="ZooKeeperProxy.this.ZooKeeperNode">newNode0</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(fullPath: String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)ZooKeeperProxy.this.ZooKeeperNode" id="45589">newNode</a><span class="delimiter">(</span><a title="String" id="49538">fullPath</a>: <span title="String">String</span>, <a title="Array[Byte]" id="49543">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span title="object Array">Array</span>.<span title="(implicit evidence$1: scala.reflect.ClassManifest[Byte])Array[Byte]">empty</span>, <a title="org.apache.zookeeper.CreateMode" id="49544">mode</a>: <span title="org.apache.zookeeper.CreateMode">CreateMode</span> = CreateMode.<span title="org.apache.zookeeper.CreateMode(value PERSISTENT)">PERSISTENT</span><span class="delimiter">)</span> =
    <span title="ZooKeeperProxy.this.ZooKeeperNode" class="keyword">new</span> <a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode">ZooKeeperNode</a><span class="delimiter">(</span><a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: Array[Byte], x$3: java.util.List[org.apache.zookeeper.data.ACL], x$4: org.apache.zookeeper.CreateMode)java.lang.String">create</span><span class="delimiter">(</span><a href="#49538" title="String">fullPath</a>, <a href="#49543" title="Array[Byte]">data</a>, <span title="object org.apache.zookeeper.ZooDefs">ZooDefs</span>.<span title="object org.apache.zookeeper.ZooDefs.Ids">Ids</span>.<span title="java.util.ArrayList[org.apache.zookeeper.data.ACL]">OPEN_ACL_UNSAFE</span>, <a href="#49544" title="org.apache.zookeeper.CreateMode">mode</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">class</span> <a title="class ZooKeeperNode extends java.lang.Object with ScalaObject" id="45590">ZooKeeperNode</a><a href="#45590" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="String" id="46965">path</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;Path must start with a slash (/)&quot;)" class="string">&quot;Path must start with a slash (/)&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Int" id="46777">defaultTimeout</a> = <span class="int">15</span>*<span class="int">60</span><span title="Int(900000)">*</span><span class="int">1000</span>
    <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="String" id="46780">name</a>: <span title="String">String</span> = <a href="#46965" title="=&gt; String">path</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span><span class="delimiter">)</span>.<span title="=&gt; java.lang.String">last</span>
    <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="String" id="46782">prefix</a>: <span title="String">String</span> = <span title="String" class="keyword">if</span> <span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span><span class="delimiter">)</span> <span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span> <span class="keyword">else</span> <a href="#46965" title="=&gt; String">path</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span>

    @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(rpath: String)java.lang.String" id="46783">fullPath</a><span class="delimiter">(</span><a title="String" id="50030">rpath</a>: <span title="String">String</span><span class="delimiter">)</span> =
      <a href="#46781" title="=&gt; String">prefix</a> <span title="(x$1: Any)java.lang.String">+</span> <a href="#50030" title="String">rpath</a>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy" id="46784">proxy</a> = <a href="#9838" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy">self</a>
    <span class="keyword">def</span> <a title="=&gt; java.lang.String" id="46786">canonicalAddress</a> = <span title="java.lang.String(&quot;zk://&quot;)" class="string">&quot;zk://&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#46784" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy">proxy</a>.<a href="#48364" title="=&gt; String">address</a> <span title="(x$1: Any)java.lang.String">+</span> <a href="#46965" title="=&gt; String">path</a>

    <span class="keyword">def</span> <a title="(rpath: String)ZooKeeperProxy.this.ZooKeeperNode" id="46787">apply</a><span class="delimiter">(</span><a title="String" id="48369">rpath</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode">ZooKeeperNode</a> = 
      <a href="#46791" title="(rpath: String, tries: Int)Option[ZooKeeperProxy.this.ZooKeeperNode]">get</a><span class="delimiter">(</span><a href="#48369" title="String">rpath</a><span class="delimiter">)</span>.<span title="(default: =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Zookeeper node doesn\'t exist: &quot;)" class="string">&quot;Zookeeper node doesn't exist: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#48369" title="String">rpath</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="[A](retries: Int)(f: =&gt; A)A" id="46788">retry</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="46790">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="Int" id="50051">retries</a>: <span title="Int">Int</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="=&gt; A" id="50052">f</a>: =&gt; A<span class="delimiter">)</span>: <a href="#46790" title="A">A</a> = <span class="delimiter">{</span>
      @inline <span class="keyword">def</span> <a title="(e: Exception)A" id="50055">tryAgain</a><span class="delimiter">(</span><a title="Exception" id="50056">e</a>: <span title="Exception">Exception</span><span class="delimiter">)</span> =
	<span title="A" class="keyword">if</span><span class="delimiter">(</span><a href="#50051" title="Int">retries</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
	  <span title="Nothing" class="keyword">throw</span> <a href="#50056" title="Exception">e</a>
	<span class="keyword">else</span> <span class="delimiter">{</span>
	  <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Zookeeper connection invalid.  Waiting to try again %s&quot;)" class="string">&quot;Zookeeper connection invalid.  Waiting to try again %s&quot;</span>, <a href="#50056" title="Exception">e</a><span class="delimiter">)</span>
	  <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><span title="Long(1000L)" class="int">1000</span><span class="delimiter">)</span>
	  <a href="#46788" title="(retries: Int)(f: =&gt; A)A">retry</a><span class="delimiter">(</span><a href="#50051" title="Int">retries</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#50052" title="=&gt; A">f</a><span class="delimiter">)</span>
	<span class="delimiter">}</span>

      <span class="keyword">try</span> <a href="#50052" title="=&gt; A">f</a> <span class="keyword">catch</span> <span class="delimiter">{</span>
	<span class="keyword">case</span> <a title="A" id="50077">e</a>: org.apache.zookeeper.KeeperException.<span title="org.apache.zookeeper.KeeperException.ConnectionLossException">ConnectionLossException</span> =&gt; <a href="#50055" title="(e: Exception)A">tryAgain</a><span class="delimiter">(</span><a href="#50077" title="org.apache.zookeeper.KeeperException.ConnectionLossException">e</a><span class="delimiter">)</span>
	<span class="keyword">case</span> <a title="A" id="50079">e</a>: org.apache.zookeeper.KeeperException.<span title="org.apache.zookeeper.KeeperException.SessionExpiredException">SessionExpiredException</span> =&gt; <a href="#50055" title="(e: Exception)A">tryAgain</a><span class="delimiter">(</span><a href="#50079" title="org.apache.zookeeper.KeeperException.SessionExpiredException">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> 

    <span class="keyword">def</span> <a title="(rpath: String, tries: Int)Option[ZooKeeperProxy.this.ZooKeeperNode]" id="46791">get</a><span class="delimiter">(</span><a title="String" id="50036">rpath</a>: <span title="String">String</span>, <a title="Int" id="50039">tries</a>: <span title="Int">Int</span> = <span title="Int(5)" class="int">5</span><span class="delimiter">)</span>: <span title="Option[ZooKeeperProxy.this.ZooKeeperNode]">Option</span><span class="delimiter">[</span>ZooKeeperNode<span class="delimiter">]</span> = <a href="#46788" title="(retries: Int)(f: =&gt; Option[ZooKeeperProxy.this.ZooKeeperNode])Option[ZooKeeperProxy.this.ZooKeeperNode]">retry</a><span class="delimiter">(</span><a href="#50039" title="Int">tries</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#50036" title="String">rpath</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span><span class="delimiter">)</span>.<span title="(z: Option[ZooKeeperProxy.this.ZooKeeperNode])(op: (Option[ZooKeeperProxy.this.ZooKeeperNode], java.lang.String) =&gt; Option[ZooKeeperProxy.this.ZooKeeperNode])Option[ZooKeeperProxy.this.ZooKeeperNode]">foldLeft</span><span class="delimiter">(</span><span title="(x: ZooKeeperProxy.this.ZooKeeperNode)Option[ZooKeeperProxy.this.ZooKeeperNode]">Option</span><span class="delimiter">(</span><a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Option[ZooKeeperProxy.this.ZooKeeperNode]" id="50641">n</a>,<a title="java.lang.String" id="50642">p</a><span class="delimiter">)</span> =&gt; <a href="#50641" title="Option[ZooKeeperProxy.this.ZooKeeperNode]">n</a>.<span title="(f: ZooKeeperProxy.this.ZooKeeperNode =&gt; Option[ZooKeeperProxy.this.ZooKeeperNode])Option[ZooKeeperProxy.this.ZooKeeperNode]">flatMap</span><span class="delimiter">(</span><a href="#50647" title="ZooKeeperProxy.this.ZooKeeperNode">_</a>.<a href="#46795" title="=&gt; Map[String,ZooKeeperProxy.this.ZooKeeperNode]">childrenMap</a>.<span title="(key: String)Option[ZooKeeperProxy.this.ZooKeeperNode]">get</span><span class="delimiter">(</span><a href="#50642" title="java.lang.String">p</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    

    <span class="comment">// TODO: let getOrCreate take creation parameters (data/mode)?</span>
    <span class="keyword">def</span> <a title="(rpath: String, tries: Int)ZooKeeperProxy.this.ZooKeeperNode" id="46792">getOrCreate</a><span class="delimiter">(</span><a title="String" id="49240">rpath</a>: <span title="String">String</span>, <a title="Int" id="49243">tries</a>: <span title="Int">Int</span> = <span title="Int(5)" class="int">5</span><span class="delimiter">)</span>: <a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode">ZooKeeperNode</a> = <a href="#46788" title="(retries: Int)(f: =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">retry</a><span class="delimiter">(</span><a href="#49243" title="Int">tries</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#49240" title="String">rpath</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span><span class="delimiter">)</span>.<span title="(z: ZooKeeperProxy.this.ZooKeeperNode)(op: (ZooKeeperProxy.this.ZooKeeperNode, java.lang.String) =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">foldLeft</span><span class="delimiter">(</span><a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="ZooKeeperProxy.this.ZooKeeperNode" id="51092">n</a>,<a title="java.lang.String" id="51093">p</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="51094">fullPath0</a> = <a href="#51092" title="ZooKeeperProxy.this.ZooKeeperNode">n</a>.<a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#51093" title="java.lang.String">p</a><span class="delimiter">)</span>
        <span class="keyword">try</span> <a href="#51092" title="ZooKeeperProxy.this.ZooKeeperNode">n</a>.<a href="#46795" title="=&gt; Map[String,ZooKeeperProxy.this.ZooKeeperNode]">childrenMap</a>.<span title="(key: String)Option[ZooKeeperProxy.this.ZooKeeperNode]">get</span><span class="delimiter">(</span><a href="#51093" title="java.lang.String">p</a><span class="delimiter">)</span>.<span title="(default: =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">getOrElse</span><span class="delimiter">(</span><a href="#45588" title="(fullPath: String, newNode: =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">getOrElseUpdateNode</a><span class="delimiter">(</span><a href="#51094" title="java.lang.String">fullPath0</a>, <a href="#45589" title="(fullPath: String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)ZooKeeperProxy.this.ZooKeeperNode">newNode</a><span class="delimiter">(</span><a href="#51094" title="java.lang.String">fullPath0</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
	<span class="keyword">catch</span> <span class="delimiter">{</span>
	  <span class="keyword">case</span> <a title="ZooKeeperProxy.this.ZooKeeperNode" id="51106">e</a>: org.apache.zookeeper.KeeperException.<span title="org.apache.zookeeper.KeeperException.NodeExistsException">NodeExistsException</span> =&gt;
	    <a href="#51092" title="ZooKeeperProxy.this.ZooKeeperNode">n</a>.<a href="#46795" title="=&gt; Map[String,ZooKeeperProxy.this.ZooKeeperNode]">childrenMap</a>.<span title="(key: String)Option[ZooKeeperProxy.this.ZooKeeperNode]">get</span><span class="delimiter">(</span><a href="#51093" title="java.lang.String">p</a><span class="delimiter">)</span>.<span title="=&gt; ZooKeeperProxy.this.ZooKeeperNode">get</span>
	<span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="46793">waitUntilPropagated</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#48366" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    @inline <span class="keyword">private</span> <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.comm.ZooKeeperProxy.ZooKeeperNode.funcToWatcher : (f: org.apache.zookeeper.WatchedEvent =&gt; Unit)org.apache.zookeeper.Watcher" id="46794">funcToWatcher</a><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent =&gt; Unit" id="49746">f</a>: WatchedEvent =&gt; Unit<span class="delimiter">)</span>: <span title="org.apache.zookeeper.Watcher">Watcher</span> = <a href="#51119" title="java.lang.Object with org.apache.zookeeper.Watcher" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.apache.zookeeper.Watcher" id="51119">Watcher</a> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(evt: org.apache.zookeeper.WatchedEvent)Unit" id="51123">process</a><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent" id="51124">evt</a>: <span title="org.apache.zookeeper.WatchedEvent">WatchedEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#49746" title="(v1: org.apache.zookeeper.WatchedEvent)Unit">f</a><span class="delimiter">(</span><a href="#51124" title="org.apache.zookeeper.WatchedEvent">evt</a><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Map[String,ZooKeeperProxy.this.ZooKeeperNode]" id="46795">childrenMap</a> =
      <a href="#46796" title="(watcher: Option[org.apache.zookeeper.WatchedEvent =&gt; Unit])Map[String,ZooKeeperProxy.this.ZooKeeperNode]">getChildrenMap</a><span class="delimiter">(</span><span title="object None">None</span><span class="delimiter">)</span> 

    @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(watcher: Option[org.apache.zookeeper.WatchedEvent =&gt; Unit])Map[String,ZooKeeperProxy.this.ZooKeeperNode]" id="46796">getChildrenMap</a><span class="delimiter">(</span><a title="Option[org.apache.zookeeper.WatchedEvent =&gt; Unit]" id="50651">watcher</a>: <span title="Option[org.apache.zookeeper.WatchedEvent =&gt; Unit]">Option</span><span class="delimiter">[</span>WatchedEvent =&gt; Unit<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Map[String,ZooKeeperProxy.this.ZooKeeperNode]">Map</span><span class="delimiter">[</span>String, ZooKeeperNode<span class="delimiter">]</span> =
      <a href="#50651" title="Option[org.apache.zookeeper.WatchedEvent =&gt; Unit]">watcher</a>.<span title="(f: org.apache.zookeeper.WatchedEvent =&gt; Unit =&gt; java.util.List[java.lang.String])Option[java.util.List[java.lang.String]]">map</span><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent =&gt; Unit" id="51133">w</a> =&gt; <a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: org.apache.zookeeper.Watcher)java.util.List[java.lang.String]">getChildren</span><span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a>, <a href="#46794" title="implicit edu.berkeley.cs.scads.comm.ZooKeeperProxy.ZooKeeperNode.funcToWatcher : (f: org.apache.zookeeper.WatchedEvent =&gt; Unit)org.apache.zookeeper.Watcher">w</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; java.util.List[java.lang.String])java.util.List[java.lang.String]">getOrElse</span><span title="(l: java.util.List[java.lang.String])scala.collection.mutable.Buffer[java.lang.String]" class="delimiter">(</span><a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: Boolean)java.util.List[java.lang.String]">getChildren</span><span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; (java.lang.String, ZooKeeperProxy.this.ZooKeeperNode))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[java.lang.String],(java.lang.String, ZooKeeperProxy.this.ZooKeeperNode),scala.collection.mutable.Buffer[(java.lang.String, ZooKeeperProxy.this.ZooKeeperNode)]])scala.collection.mutable.Buffer[(java.lang.String, ZooKeeperProxy.this.ZooKeeperNode)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,(java.lang.String, ZooKeeperProxy.this.ZooKeeperNode),scala.collection.mutable.Buffer[(java.lang.String, ZooKeeperProxy.this.ZooKeeperNode)]]" class="delimiter">(</span><a title="java.lang.String" id="51658">path</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="51659">fullPath0</a> = <a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#51658" title="java.lang.String">path</a><span class="delimiter">)</span>
        <span title="(_1: java.lang.String, _2: ZooKeeperProxy.this.ZooKeeperNode)(java.lang.String, ZooKeeperProxy.this.ZooKeeperNode)" class="delimiter">(</span><a href="#51658" title="java.lang.String">path</a>, <a href="#45588" title="(fullPath: String, newNode: =&gt; ZooKeeperProxy.this.ZooKeeperNode)ZooKeeperProxy.this.ZooKeeperNode">getOrElseUpdateNode</a><span class="delimiter">(</span><a href="#51659" title="java.lang.String">fullPath0</a>, <span title="ZooKeeperProxy.this.ZooKeeperNode" class="keyword">new</span> <a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode">ZooKeeperNode</a><span class="delimiter">(</span><a href="#51659" title="java.lang.String">fullPath0</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(java.lang.String, ZooKeeperProxy.this.ZooKeeperNode),(String, ZooKeeperProxy.this.ZooKeeperNode)])scala.collection.immutable.Map[String,ZooKeeperProxy.this.ZooKeeperNode]">toMap</span>

    <span class="keyword">def</span> <a title="=&gt; List[ZooKeeperProxy.this.ZooKeeperNode]" id="46797">children</a>: <span title="List[ZooKeeperProxy.this.ZooKeeperNode]">List</span><span class="delimiter">[</span>ZooKeeperNode<span class="delimiter">]</span> =
      <a href="#46795" title="=&gt; Map[String,ZooKeeperProxy.this.ZooKeeperNode]">childrenMap</a>.<span title="(f: (String, ZooKeeperProxy.this.ZooKeeperNode) =&gt; ZooKeeperProxy.this.ZooKeeperNode)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[String,ZooKeeperProxy.this.ZooKeeperNode],ZooKeeperProxy.this.ZooKeeperNode,scala.collection.immutable.Iterable[ZooKeeperProxy.this.ZooKeeperNode]])scala.collection.immutable.Iterable[ZooKeeperProxy.this.ZooKeeperNode]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Iterable.Coll,ZooKeeperProxy.this.ZooKeeperNode,scala.collection.immutable.Iterable[ZooKeeperProxy.this.ZooKeeperNode]]" class="delimiter">(</span><a href="#51984" title="(String, ZooKeeperProxy.this.ZooKeeperNode)">_</a>.<span title="=&gt; ZooKeeperProxy.this.ZooKeeperNode">_2</span><span class="delimiter">)</span>.<span title="=&gt; List[ZooKeeperProxy.this.ZooKeeperNode]">toList</span>

    <span class="keyword">def</span> <a title="(d: Array[Byte])Unit" id="46798">data_=</a><span class="delimiter">(</span><a title="Array[Byte]" id="52333">d</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: Array[Byte], x$3: Int)org.apache.zookeeper.data.Stat">setData</span><span title="Unit" class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a>, <a href="#52333" title="Array[Byte]">d</a>, -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="=&gt; Array[Byte]" id="46799">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <a href="#46810" title="(watch: Boolean)Array[Byte]">getData</a><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="(name: String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)ZooKeeperProxy.this.ZooKeeperNode" id="46800">createChild</a><span class="delimiter">(</span><a title="String" id="46966">name</a>: <span title="String">String</span>, <a title="Array[Byte]" id="46970">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span title="object Array">Array</span>.<span title="(implicit evidence$1: scala.reflect.ClassManifest[Byte])Array[Byte]">empty</span>, <a title="org.apache.zookeeper.CreateMode" id="46971">mode</a>: <span title="org.apache.zookeeper.CreateMode">CreateMode</span> = CreateMode.<span title="org.apache.zookeeper.CreateMode(value PERSISTENT)">PERSISTENT</span><span class="delimiter">)</span>: <a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode">ZooKeeperNode</a> =
      <a href="#45589" title="(fullPath: String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)ZooKeeperProxy.this.ZooKeeperNode">newNode</a><span class="delimiter">(</span><a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#46966" title="String">name</a><span class="delimiter">)</span>, <a href="#46970" title="Array[Byte]">data</a>, <a href="#46971" title="org.apache.zookeeper.CreateMode">mode</a><span class="delimiter">)</span>

    @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(path: String)Boolean" id="46801">safeDelete</a><span class="delimiter">(</span><a title="String" id="52357">path</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
      <span class="keyword">try</span> <span class="delimiter">{</span>
        <a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: Int)Unit">delete</span><span class="delimiter">(</span><a href="#52357" title="String">path</a>, -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>
        <span title="Boolean(true)" class="keyword">true</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Boolean(false)">_</span>: org.apache.zookeeper.KeeperException.<span title="org.apache.zookeeper.KeeperException.NoNodeException">NoNodeException</span> =&gt; <span title="Boolean(false)" class="keyword">false</span> 
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(name: String)Unit" id="46802">deleteChild</a><span class="delimiter">(</span><a title="String" id="52368">name</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#46801" title="(path: String)Boolean">safeDelete</a><span class="delimiter">(</span><a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#52368" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> 
        <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deleteChild() - Child node %s was already deleted&quot;)" class="string">&quot;deleteChild() - Child node %s was already deleted&quot;</span>, <a href="#52368" title="String">name</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#45582" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">canonicalMap</a>.<span title="(x$1: Any)ZooKeeperProxy.this.ZooKeeperNode">remove</span><span class="delimiter">(</span><a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#52368" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deleteChild() - No canonical node existed previously for fullPath: %s&quot;)" class="string">&quot;deleteChild() - No canonical node existed previously for fullPath: %s&quot;</span>, <a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#52368" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">else</span>
        <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deleteChild() - successfully deleted child: %s&quot;)" class="string">&quot;deleteChild() - successfully deleted child: %s&quot;</span>, <a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#52368" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="46803">delete</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#46801" title="(path: String)Boolean">safeDelete</a><span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;delete() - Node %s was already deleted&quot;)" class="string">&quot;delete() - Node %s was already deleted&quot;</span>, <a href="#46965" title="=&gt; String">path</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#45582" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">canonicalMap</a>.<span title="(x$1: Any)ZooKeeperProxy.this.ZooKeeperNode">remove</span><span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;delete() - No canonical node existed previously for path: %s&quot;)" class="string">&quot;delete() - No canonical node existed previously for path: %s&quot;</span>, <a href="#46965" title="=&gt; String">path</a><span class="delimiter">)</span>
      <span class="keyword">else</span>
        <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;delete() - successfully deleted path: %s&quot;)" class="string">&quot;delete() - successfully deleted path: %s&quot;</span>, <a href="#46965" title="=&gt; String">path</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="46804">deleteRecursive</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#46797" title="=&gt; List[ZooKeeperProxy.this.ZooKeeperNode]">children</a>.<span title="(f: ZooKeeperProxy.this.ZooKeeperNode =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#52427" title="ZooKeeperProxy.this.ZooKeeperNode">_</a>.<a href="#46804" title="()Unit">deleteRecursive</a><span class="delimiter">)</span>
      <a href="#46803" title="()Unit">delete</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="=&gt; Int" id="46805">sequenceNumber</a>: <span title="Int">Int</span> =
      <a href="#46779" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">name</a>.<span title="(n: Int)String">drop</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="delimiter">(</span><a href="#46779" title="=&gt; String">name</a>.<span title="()Int">length</span> <span title="(x: Int)Int">-</span> <span title="Int(10)" class="int">10</span><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>

    <span class="keyword">def</span> <a title="(name: String, seqNumber: Option[Int], timeout: Long, unit: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="46806">awaitChild</a><span class="delimiter">(</span><a title="String" id="52730">name</a>: <span title="String">String</span>, <a title="Option[Int]" id="52737">seqNumber</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>, <a title="Long" id="52738">timeout</a>: <span title="Long">Long</span> = <a href="#46777" title="=&gt; Long">defaultTimeout</a>, <a title="java.util.concurrent.TimeUnit" id="52739">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span> = TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>: ZooKeeperProxy#<a href="#45590" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="String" id="52744">fullName</a> = <a href="#52737" title="Option[Int]">seqNumber</a>.<span title="(f: Int =&gt; String)Option[String]">map</span><span class="delimiter">(</span><a title="Int" id="52752">s</a> =&gt; <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s%010d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#52730" title="String">name</a>, <a href="#52752" title="Int">s</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><a href="#52730" title="String">name</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.lang.String" id="52745">childPath</a> = <a href="#46783" title="(rpath: String)java.lang.String">fullPath</a><span class="delimiter">(</span><a href="#52744" title="String">fullName</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]" id="52746">blocker</a> = <span title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]" class="keyword">new</span> <a href="Futures.scala.html#9548" title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">BlockingFuture</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span> 
      <span class="keyword">val</span> <a title="watcher extends java.lang.Object with org.apache.zookeeper.Watcher" id="52747">watcher</a> = <a href="#52762" title="java.lang.Object with org.apache.zookeeper.Watcher" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.apache.zookeeper.Watcher" id="52762">Watcher</a> <span class="delimiter">{</span>
        <span class="keyword">def</span> <a title="(evt: org.apache.zookeeper.WatchedEvent)Unit" id="52764">process</a><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent" id="52765">evt</a>: <span title="org.apache.zookeeper.WatchedEvent">WatchedEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#52765" title="org.apache.zookeeper.WatchedEvent">evt</a>.<span title="()org.apache.zookeeper.Watcher.Event.EventType">getType</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeCreated)">NodeCreated</span> =&gt; <a href="#52746" title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">blocker</a>.<a href="Futures.scala.html#31143" title="(e: Unit)Unit">finish</a><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
            <span class="keyword">case</span> <a title="Unit" id="52782">e</a> =&gt; 
              <a href="#52746" title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">blocker</a>.<a href="Futures.scala.html#31144" title="(error: Throwable)Unit">finishWithError</a><span class="delimiter">(</span><span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Expected NodeCreated event for node %s, but got %s event instead&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#52744" title="String">fullName</a>, <a href="#52782" title="org.apache.zookeeper.Watcher.Event.EventType">e</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: org.apache.zookeeper.Watcher)org.apache.zookeeper.data.Stat">exists</span><span class="delimiter">(</span><a href="#52745" title="java.lang.String">childPath</a>, <a href="#52747" title="watcher extends java.lang.Object with org.apache.zookeeper.Watcher">watcher</a><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Waiting up to %dms for %s&quot;)" class="string">&quot;Waiting up to %dms for %s&quot;</span>, <a href="#52738" title="Long">timeout</a>, <a href="#52745" title="java.lang.String">childPath</a><span class="delimiter">)</span>
        <a href="#52746" title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">blocker</a>.<a href="Futures.scala.html#31139" title="(timeout: Long)Unit">await</a><span class="delimiter">(</span><a href="#52739" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#52738" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <a href="#46787" title="(rpath: String)ZooKeeperProxy.this.ZooKeeperNode">apply</a><span class="delimiter">(</span><a href="#52744" title="String">fullName</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(func: () =&gt; Unit)Array[Byte]" id="46807">onDataChange</a><span class="delimiter">(</span><a title="() =&gt; Unit" id="52808">func</a>:<span class="delimiter">(</span><span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="watcher extends java.lang.Object with org.apache.zookeeper.Watcher" id="52810">watcher</a> = <a href="#52811" title="java.lang.Object with org.apache.zookeeper.Watcher" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.apache.zookeeper.Watcher" id="52811">Watcher</a> <span class="delimiter">{</span>
	<span class="keyword">def</span> <a title="(evt: org.apache.zookeeper.WatchedEvent)Unit" id="52813">process</a><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent" id="52814">evt</a>: <span title="org.apache.zookeeper.WatchedEvent">WatchedEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	  <a href="#52814" title="org.apache.zookeeper.WatchedEvent">evt</a>.<span title="()org.apache.zookeeper.Watcher.Event.EventType">getType</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeDataChanged)">NodeDataChanged</span> =&gt; <a href="#52808" title="()Unit">func</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="keyword">case</span> <a title="Unit" id="52818">e</a> =&gt; <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Watch onDataChange is unregistered): %s&quot;)" class="string">&quot;Watch onDataChange is unregistered): %s&quot;</span>,<a href="#52818" title="org.apache.zookeeper.Watcher.Event.EventType">e</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
	<span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: org.apache.zookeeper.Watcher, x$3: org.apache.zookeeper.data.Stat)Array[Byte]">getData</span><span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a>, <a href="#52810" title="watcher extends java.lang.Object with org.apache.zookeeper.Watcher">watcher</a>, <span title="org.apache.zookeeper.data.Stat" class="keyword">new</span> <span title="org.apache.zookeeper.data.Stat">Stat</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/** Set a watcher on the children for this node. Note that, according to
     * ZooKeeper semantics, a watcher is executed AT MOST once */</span>
    <span class="keyword">def</span> <a title="(f: org.apache.zookeeper.WatchedEvent =&gt; Unit)List[ZooKeeperProxy.this.ZooKeeperNode]" id="46808">watchChildren</a><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent =&gt; Unit" id="52843">f</a>: WatchedEvent =&gt; Unit<span class="delimiter">)</span>: <span title="List[ZooKeeperProxy.this.ZooKeeperNode]">List</span><span class="delimiter">[</span>ZooKeeperNode<span class="delimiter">]</span> =
      <a href="#46796" title="(watcher: Option[org.apache.zookeeper.WatchedEvent =&gt; Unit])Map[String,ZooKeeperProxy.this.ZooKeeperNode]">getChildrenMap</a><span class="delimiter">(</span><span title="(x: org.apache.zookeeper.WatchedEvent =&gt; Unit)Some[org.apache.zookeeper.WatchedEvent =&gt; Unit]">Some</span><span class="delimiter">(</span><a href="#52843" title="org.apache.zookeeper.WatchedEvent =&gt; Unit">f</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: (String, ZooKeeperProxy.this.ZooKeeperNode) =&gt; ZooKeeperProxy.this.ZooKeeperNode)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[String,ZooKeeperProxy.this.ZooKeeperNode],ZooKeeperProxy.this.ZooKeeperNode,scala.collection.immutable.Iterable[ZooKeeperProxy.this.ZooKeeperNode]])scala.collection.immutable.Iterable[ZooKeeperProxy.this.ZooKeeperNode]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Iterable.Coll,ZooKeeperProxy.this.ZooKeeperNode,scala.collection.immutable.Iterable[ZooKeeperProxy.this.ZooKeeperNode]]" class="delimiter">(</span><a href="#52867" title="(String, ZooKeeperProxy.this.ZooKeeperNode)">_</a>.<span title="=&gt; ZooKeeperProxy.this.ZooKeeperNode">_2</span><span class="delimiter">)</span>.<span title="=&gt; List[ZooKeeperProxy.this.ZooKeeperNode]">toList</span>

    <span class="keyword">def</span> <a title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int" id="46809">registerAndAwait</a><span class="delimiter">(</span><a title="String" id="52923">barrierName</a>: <span title="String">String</span>, <a title="Int" id="52924">count</a>: <span title="Int">Int</span>, <a title="Long" id="52928">timeout</a>: <span title="Long">Long</span> = <a href="#46777" title="=&gt; Long">defaultTimeout</a>, <a title="java.util.concurrent.TimeUnit" id="52929">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span> = TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="ZooKeeperProxy.this.ZooKeeperNode" id="52930">node</a> = <a href="#46792" title="(rpath: String, tries: Int)ZooKeeperProxy.this.ZooKeeperNode">getOrCreate</a><span class="delimiter">(</span><a href="#52923" title="String">barrierName</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Int" id="52931">seqNum</a> = <a href="#52930" title="ZooKeeperProxy.this.ZooKeeperNode">node</a>.<a href="#46970" title="Array[Byte]" id="52934">createChild</a><span class="delimiter">(</span><a title="java.lang.String(&quot;client&quot;)" id="52932" class="string">&quot;client&quot;</a>, mode = CreateMode.<a title="org.apache.zookeeper.CreateMode(value EPHEMERAL_SEQUENTIAL)" id="52933">EPHEMERAL_SEQUENTIAL</a><span class="delimiter">)</span>.<a href="#46805" title="=&gt; Int">sequenceNumber</a>

      <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#52931" title="Int">seqNum</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#52924" title="Int">count</a><span class="delimiter">)</span>
      <a href="#52930" title="ZooKeeperProxy.this.ZooKeeperNode">node</a>.<a href="#46806" title="(name: String, seqNumber: Option[Int], timeout: Long, unit: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">awaitChild</a><span class="delimiter">(</span><span title="java.lang.String(&quot;client&quot;)" class="string">&quot;client&quot;</span>, <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#52924" title="Int">count</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, timeout=<a href="#52928" title="Long">timeout</a>, unit=<a href="#52929" title="java.util.concurrent.TimeUnit">unit</a><span class="delimiter">)</span>
      <a href="#52931" title="Int">seqNum</a>
    <span class="delimiter">}</span>

    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(watch: Boolean)Array[Byte]" id="46810">getData</a><span class="delimiter">(</span><a title="Boolean" id="52352">watch</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.apache.zookeeper.data.Stat" id="52948">stat</a> = <span title="org.apache.zookeeper.data.Stat" class="keyword">new</span> <span title="org.apache.zookeeper.data.Stat">Stat</span>
      <a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="(x$1: java.lang.String, x$2: Boolean, x$3: org.apache.zookeeper.data.Stat)Array[Byte]">getData</span><span class="delimiter">(</span><a href="#46965" title="=&gt; String">path</a>, <a href="#52352" title="Boolean">watch</a>, <a href="#52948" title="org.apache.zookeeper.data.Stat">stat</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">protected</span><span class="delimiter">[</span>ZooKeeperProxy<span class="delimiter">]</span> <span class="keyword">def</span> <a title="(evt: org.apache.zookeeper.WatchedEvent)Unit" id="46811">watchedEvent</a><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent" id="52955">evt</a>: <span title="org.apache.zookeeper.WatchedEvent">WatchedEvent</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#52955" title="org.apache.zookeeper.WatchedEvent">evt</a>.<span title="()org.apache.zookeeper.Watcher.Event.EventType">getType</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeChildrenChanged)">NodeChildrenChanged</span> =&gt; <span class="comment">/* ignore - let NodeDeleted handle this */</span>
      <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeCreated)">NodeCreated</span> =&gt; <span class="comment">/* ignore */</span>
      <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeDataChanged)">NodeDataChanged</span> =&gt; <span class="comment">/* ignore */</span>
      <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeDeleted)">NodeDeleted</span> =&gt; <a href="#45582" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,ZooKeeperProxy.this.ZooKeeperNode]">canonicalMap</a>.<span title="(x$1: Any)ZooKeeperProxy.this.ZooKeeperNode">remove</span><span title="Unit" class="delimiter">(</span><a href="#52955" title="org.apache.zookeeper.WatchedEvent">evt</a>.<span title="()java.lang.String">getPath</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/** 2 nodes are equal iff their paths are equal */</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(that: Any)Boolean" id="46812">equals</a><span class="delimiter">(</span><a title="Any" id="52959">that</a>: <span title="Any">Any</span><span class="delimiter">)</span> =
      <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#45590" title="ZooKeeperNode.this.type" class="keyword">this</a> <span title="(x$1: AnyRef)Boolean">eq</span> <a href="#52959" title="Any">that</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="AnyRef" class="delimiter">[</span><span title="AnyRef">AnyRef</span><span class="delimiter">]</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
      <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#52959" title="Any">that</a> <span title="(x$1: Any)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span>
      <span class="keyword">else</span> <a href="#52959" title="Any">that</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Boolean" id="52962">that0</a>: <a href="#45590" title="ZooKeeperProxy.this.ZooKeeperNode">ZooKeeperNode</a> =&gt;
          <a href="#45590" title="ZooKeeperNode.this.type" class="keyword">this</a>.<a href="#46965" title="=&gt; String">path</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#52962" title="ZooKeeperProxy.this.ZooKeeperNode">that0</a>.<a href="#46965" title="=&gt; String">path</a>
        <span class="keyword">case</span> <span title="Boolean(false)">_</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
      <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Int" id="46813">hashCode</a> = 
      <a href="#46965" title="=&gt; String">path</a>.<span title="()Int">hashCode</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="46814">toString</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="String">String</span> =
      <span title="java.lang.String(&quot;&lt;znode path:&quot;)" class="string">&quot;&lt;znode path:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#46965" title="=&gt; String">path</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;, data: \'&quot;)" class="string">&quot;, data: '&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#46799" title="=&gt; Array[Byte]">data</a><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;\', children: &quot;)" class="string">&quot;', children: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#46797" title="=&gt; List[ZooKeeperProxy.this.ZooKeeperNode]">children</a>.<span title="(f: ZooKeeperProxy.this.ZooKeeperNode =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[List[ZooKeeperProxy.this.ZooKeeperNode],String,Any])Any">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,String,List[String]]" class="delimiter">(</span><a href="#53657" title="ZooKeeperProxy.this.ZooKeeperNode">_</a>.<a href="#46779" title="=&gt; String">name</a><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;&gt;&quot;)" class="string">&quot;&gt;&quot;</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(event: org.apache.zookeeper.WatchedEvent)Unit" id="45591">process</a><span class="delimiter">(</span><a title="org.apache.zookeeper.WatchedEvent" id="53703">event</a>: <span title="org.apache.zookeeper.WatchedEvent">WatchedEvent</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#53703" title="org.apache.zookeeper.WatchedEvent">event</a>.<span title="()org.apache.zookeeper.Watcher.Event.EventType">getType</span> <span title="(x$1: AnyRef)Boolean">==</span> EventType.<span title="org.apache.zookeeper.Watcher.Event.EventType(value None)">None</span><span class="delimiter">)</span>
      <a href="#53703" title="org.apache.zookeeper.WatchedEvent">event</a>.<span title="()org.apache.zookeeper.Watcher.Event.KeeperState">getState</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">KeeperState</span>.<span title="org.apache.zookeeper.Watcher.Event.KeeperState(value SyncConnected)">SyncConnected</span> =&gt; <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Connected to Zookeeper at %s&quot;)" class="string">&quot;[%s] Connected to Zookeeper at %s&quot;</span>,<span title="object java.lang.Thread">Thread</span>.<span title="()java.lang.Thread">currentThread</span>.<span title="()java.lang.String">getName</span>,<a href="#48364" title="=&gt; String">address</a><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit">KeeperState</span>.<span title="org.apache.zookeeper.Watcher.Event.KeeperState(value Disconnected)">Disconnected</span> =&gt; <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Connection to Zookeeper at %s Disconnected (%s).&quot;)" class="string">&quot;[%s] Connection to Zookeeper at %s Disconnected (%s).&quot;</span>,<span title="object java.lang.Thread">Thread</span>.<span title="()java.lang.Thread">currentThread</span>.<span title="()java.lang.String">getName</span>,<a href="#48364" title="=&gt; String">address</a>, <a href="#53703" title="org.apache.zookeeper.WatchedEvent">event</a>.<span title="()org.apache.zookeeper.Watcher.Event.KeeperState">getState</span>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span> 
        <span class="keyword">case</span> <span title="Unit">KeeperState</span>.<span title="org.apache.zookeeper.Watcher.Event.KeeperState(value Expired)">Expired</span> =&gt; <span class="delimiter">{</span>
          <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Connection to Zookeeper at %s Expired (%s).  Attempting to reconnect&quot;)" class="string">&quot;[%s] Connection to Zookeeper at %s Expired (%s).  Attempting to reconnect&quot;</span>, <span title="object java.lang.Thread">Thread</span>.<span title="()java.lang.Thread">currentThread</span>.<span title="()java.lang.String">getName</span>, <a href="#48364" title="=&gt; String">address</a>, <a href="#53703" title="org.apache.zookeeper.WatchedEvent">event</a>.<span title="()org.apache.zookeeper.Watcher.Event.KeeperState">getState</span>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>
          <span class="keyword">try</span> <span class="delimiter">{</span> <a href="#45578" title="=&gt; org.apache.zookeeper.ZooKeeper">conn</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span><span class="keyword">case</span> <a title="Unit" id="53736">e</a> =&gt; <a href="#45575" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;couldn\'t close zoo connection: %s&quot;)" class="string">&quot;couldn't close zoo connection: %s&quot;</span>,<a href="#53736" title="java.lang.Throwable">e</a><span class="delimiter">)</span><span class="delimiter">}</span>
          <a href="#45578" title="(x$1: org.apache.zookeeper.ZooKeeper)Unit">conn</a> = <a href="#45581" title="()org.apache.zookeeper.ZooKeeper">newConenction</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#46787" title="(rpath: String)ZooKeeperProxy.this.ZooKeeperNode">root</a><span class="delimiter">(</span><a href="#53703" title="org.apache.zookeeper.WatchedEvent">event</a>.<span title="()java.lang.String">getPath</span><span class="delimiter">)</span>.<a href="#46811" title="(evt: org.apache.zookeeper.WatchedEvent)Unit">watchedEvent</a><span class="delimiter">(</span><a href="#53703" title="org.apache.zookeeper.WatchedEvent">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>