<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>ServiceRegistry.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span>ConcurrentHashMap, CopyOnWriteArrayList, Executors, TimeUnit<span class="delimiter">}</span>
<span class="keyword">import</span> scala.actors._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.scads.config._

<span class="keyword">import</span> org.apache.commons.httpclient._
<span class="keyword">import</span> org.apache.commons.httpclient.methods._
<span class="keyword">import</span> org.apache.commons.httpclient.params._
<span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong
<span class="keyword">import</span> org.apache.avro.generic.<span class="delimiter">{</span>GenericData, IndexedRecord<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> edu.berkeley.cs.avro.marker.<span class="delimiter">{</span>AvroRecord, AvroUnion<span class="delimiter">}</span>

<span class="keyword">import</span> remote.RemoteActor
<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> edu.berkeley.cs.avro.runtime._
<span class="keyword">import</span> org.apache.avro.<span title="object org.apache.avro.Schema">Schema</span>.Field
<span class="keyword">import</span> org.apache.avro.specific.SpecificRecord

<span class="comment">/* General message types */</span>
<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait ServiceId extends java.lang.Object with edu.berkeley.cs.avro.marker.AvroUnion" id="61087">ServiceId</a> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroUnion">AvroUnion</span>

case <span class="keyword">class</span> <a href="#61089" title="class ServiceNumber extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.comm.ServiceId with ScalaObject with Product with Serializable" id="41632">ServiceNumber</a><a href="#41632" title="ScalaObject" class="delimiter">(</a><a href="#41632" title="()edu.berkeley.cs.scads.comm.ServiceNumber" id="60565" class="keyword">var</a> <a title="Long" id="41436">num</a>: <span title="Long">Long</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#61087" title="edu.berkeley.cs.scads.comm.ServiceId">ServiceId</a>

case <span class="keyword">class</span> <a href="#61102" title="class ServiceName extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.comm.ServiceId with ScalaObject with Product with Serializable" id="41628">ServiceName</a><a href="#41628" title="ScalaObject" class="delimiter">(</a><a href="#41628" title="()edu.berkeley.cs.scads.comm.ServiceName" id="60575" class="keyword">var</a> <a title="String" id="41450">name</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#61087" title="edu.berkeley.cs.scads.comm.ServiceId">ServiceId</a>

<span class="comment">/**
 * The message handler for avro message passing.  It maintains a list of all active services
 * in a given JVM and multiplexes the underlying network connections.  Services should be
 * careful to unregister themselves to avoid memory leaks.
 */</span>
<span class="keyword">class</span> <a title="class ServiceRegistry[MessageType &lt;: org.apache.avro.generic.IndexedRecord] extends java.lang.Object with ScalaObject" id="9586">ServiceRegistry</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9587">MessageType</a> &lt;: IndexedRecord<span class="delimiter">]</span><a href="#9586" title="ScalaObject" class="delimiter">(</a><span class="keyword">implicit</span> <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[MessageType]" id="41028">schema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[MessageType]">TypedSchema</span><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="net.lag.configgy.Config" id="24013">config</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="24015">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicLong" id="24017">curActorId</a> = <span title="()java.util.concurrent.atomic.AtomicLong" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicLong">AtomicLong</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]" id="24019">serviceRegistry</a> = <span title="()java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]">ConcurrentHashMap</span><span class="delimiter">[</span>ServiceId, MessageReceiver<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="=&gt; Int" id="24021">registrySize</a> = <a href="#24019" title="=&gt; java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]">serviceRegistry</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Long" id="24022">futureCount</a> = <a href="#24017" title="=&gt; java.util.concurrent.atomic.AtomicLong">curActorId</a>.<span title="()Long">get</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.lang.String" id="24023">hostname</a> = 
    <span title="java.lang.String" class="keyword">if</span><span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.comm.externalip&quot;)" class="string">&quot;scads.comm.externalip&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Using ip address from java.net.InetAddress.getLocalHost&quot;)" class="string">&quot;Using ip address from java.net.InetAddress.getLocalHost&quot;</span><span class="delimiter">)</span>
      java.net.<span title="object java.net.InetAddress">InetAddress</span>.<span title="()java.net.InetAddress">getLocalHost</span>.<span title="()java.lang.String">getCanonicalHostName</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.apache.commons.httpclient.HttpClient" id="37779">httpClient</a> = <span title="org.apache.commons.httpclient.HttpClient" class="keyword">new</span> <span title="org.apache.commons.httpclient.HttpClient">HttpClient</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="org.apache.commons.httpclient.methods.GetMethod" id="37780">getMethod</a> = <span title="(x$1: java.lang.String)org.apache.commons.httpclient.methods.GetMethod" class="keyword">new</span> <span title="org.apache.commons.httpclient.methods.GetMethod">GetMethod</span><span class="delimiter">(</span><span title="java.lang.String(&quot;http://instance-data/latest/meta-data/public-hostname&quot;)" class="string">&quot;http://instance-data/latest/meta-data/public-hostname&quot;</span><span class="delimiter">)</span>
      <a href="#37779" title="org.apache.commons.httpclient.HttpClient">httpClient</a>.<span title="(x$1: org.apache.commons.httpclient.HttpMethod)Int">executeMethod</span><span class="delimiter">(</span><a href="#37780" title="org.apache.commons.httpclient.methods.GetMethod">getMethod</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.lang.String" id="37781">externalIP</a> = <a href="#37780" title="org.apache.commons.httpclient.methods.GetMethod">getMethod</a>.<span title="()java.lang.String">getResponseBodyAsString</span>
      <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Using external ip address on EC2: %s&quot;)" class="string">&quot;Using external ip address on EC2: %s&quot;</span>, <a href="#37781" title="java.lang.String">externalIP</a><span class="delimiter">)</span>
      <a href="#37781" title="java.lang.String">externalIP</a>
    <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.CopyOnWriteArrayList[edu.berkeley.cs.scads.comm.MessageHandlerListener]" id="24025">listeners</a> = <span title="java.util.concurrent.CopyOnWriteArrayList[edu.berkeley.cs.scads.comm.MessageHandlerListener]" class="keyword">new</span> <span title="java.util.concurrent.CopyOnWriteArrayList[edu.berkeley.cs.scads.comm.MessageHandlerListener]">CopyOnWriteArrayList</span><span class="delimiter">[</span>MessageHandlerListener<span class="delimiter">]</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.util.concurrent.ScheduledExecutorService" id="24028">delayExecutor</a> = <span title="object java.util.concurrent.Executors">Executors</span>.<span title="(x$1: Int)java.util.concurrent.ScheduledExecutorService">newScheduledThreadPool</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">/* Don't keep any core threads alive */</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="(edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope], edu.berkeley.cs.scads.comm.RemoteNode, edu.berkeley.cs.scads.comm.package.MessageEnvelope) =&gt; Unit" id="24029">recvMsgCallback</a> = <span class="delimiter">(</span>_: <a href="AvroChannelManager.scala.html#9478" title="edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]">AvroChannelManager</a><span class="delimiter">[</span>MessageEnvelope, MessageEnvelope<span class="delimiter">]</span>, src: <a href="AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, msg: <span title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">MessageEnvelope</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
    <a href="#24041" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.package.MessageEnvelope)Unit">doReceiveMessage</a><span class="delimiter">(</span><a href="#38981" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a>, <a href="#38982" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Manually created schema for
   * case class MessageEnvelope[MessageType](var src: Option[ActorId], var dest: ActorId, var id: Option[Long], var body: MessageType) extends AvroRecord
   */</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.package.MessageEnvelope]" id="24031">envelopeSchema</a> = <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.package.MessageEnvelope]" class="keyword">new</span> <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.package.MessageEnvelope]">TypedSchema</span><span class="delimiter">[</span>MessageEnvelope<span class="delimiter">]</span><span class="delimiter">(</span><span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: java.util.List[org.apache.avro.Schema.Field])org.apache.avro.Schema">createRecord</span><span class="delimiter">(</span>
    <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><span title="java.lang.String(&quot;src&quot;)" class="string">&quot;src&quot;</span>, <span title="[C &lt;: org.apache.avro.generic.GenericContainer](implicit s: edu.berkeley.cs.avro.runtime.package.TypedSchema[C])org.apache.avro.Schema">schemaOf</span><span title="(implicit s: edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.ServiceId])org.apache.avro.Schema" class="delimiter">[</span><a href="#61087" title="edu.berkeley.cs.scads.comm.ServiceId">ServiceId</a><span class="delimiter">]</span>, <span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#39058" title="(b: Seq[org.apache.avro.Schema.Field])java.util.List[org.apache.avro.Schema.Field]">::</a>
    <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><span title="java.lang.String(&quot;dest&quot;)" class="string">&quot;dest&quot;</span>, <span title="[C &lt;: org.apache.avro.generic.GenericContainer](implicit s: edu.berkeley.cs.avro.runtime.package.TypedSchema[C])org.apache.avro.Schema">schemaOf</span><span title="(implicit s: edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.ServiceId])org.apache.avro.Schema" class="delimiter">[</span><a href="#61087" title="edu.berkeley.cs.scads.comm.ServiceId">ServiceId</a><span class="delimiter">]</span>, <span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#39345" title="(x: org.apache.avro.Schema.Field)List[org.apache.avro.Schema.Field]">::</a>
    <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><span title="java.lang.String(&quot;msg&quot;)" class="string">&quot;msg&quot;</span>, <a href="#41028" title="(t: edu.berkeley.cs.avro.runtime.package.TypedSchema[MessageType])org.apache.avro.Schema">schema</a>, <span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#39365" title="(x: org.apache.avro.Schema.Field)List[org.apache.avro.Schema.Field]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>,
    <a href="#9586" title="ServiceRegistry.this.type" class="keyword">this</a>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.ClassLoader">getClassLoader</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]" id="24034">impl</a> =
    <span class="keyword">try</span> <a href="#24035" title="=&gt; edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]">getImpl</a>
    <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Nothing" id="40975">e</a>: <span title="Exception">Exception</span> =&gt;
        <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(thrown: Throwable, msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><a href="#40975" title="Exception">e</a>, <span title="java.lang.String(&quot;Could not initialize channel manager implementation&quot;)" class="string">&quot;Could not initialize channel manager implementation&quot;</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <a href="#40975" title="Exception">e</a>
    <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]" id="24035">getImpl</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="40154">clzName</a> = <a href="#24013" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String, defaultValue: String)String">getString</span><span class="delimiter">(</span>
      <span title="java.lang.String(&quot;scads.comm.handlerClass&quot;)" class="string">&quot;scads.comm.handlerClass&quot;</span>,
      classOf<span title="java.lang.Class[edu.berkeley.cs.scads.comm.netty.DefaultNettyChannelManager[_, _]](classOf[edu.berkeley.cs.scads.comm.netty.DefaultNettyChannelManager])" class="delimiter">[</span>netty.DefaultNettyChannelManager<span class="delimiter">[</span>_, _<span class="delimiter">]</span><span class="delimiter">]</span>.<span title="()java.lang.String">getName</span><span class="delimiter">)</span>
    <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Using handler impl class: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#40154" title="String">clzName</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;ServiceRegistry using classloader %s&quot;)" class="string">&quot;ServiceRegistry using classloader %s&quot;</span>, <a href="#41028" title="edu.berkeley.cs.avro.runtime.package.TypedSchema[MessageType]">schema</a>.<span title="=&gt; java.lang.ClassLoader">classLoader</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Class[edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]]" id="40155">clz</a> = <span title="object java.lang.Class">Class</span>.<span title="(x$1: java.lang.String)java.lang.Class[_]">forName</span><span class="delimiter">(</span><a href="#40154" title="String">clzName</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]]" class="delimiter">[</span><span title="Class[edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]]">Class</span><span class="delimiter">[</span>AvroChannelManager<span class="delimiter">[</span>MessageEnvelope, MessageEnvelope<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="java.lang.reflect.Constructor[edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]]" id="40156">ctor</a> = <a href="#40155" title="Class[edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]]">clz</a>.<span title="(x$1: &lt;repeated...&gt;[java.lang.Class[_]])java.lang.reflect.Constructor[edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]]">getConstructor</span><span class="delimiter">(</span>classOf<span title="java.lang.Class[Function3[_, _, _, _]](classOf[scala.Function3])" class="delimiter">[</span>Function3<span class="delimiter">[</span>_, _, _, _<span class="delimiter">]</span><span class="delimiter">]</span>, classOf<span title="java.lang.Class[java.lang.ClassLoader](classOf[java.lang.ClassLoader])" class="delimiter">[</span>ClassLoader<span class="delimiter">]</span>, classOf<span title="java.lang.Class[edu.berkeley.cs.avro.runtime.package.TypedSchema[_]](classOf[edu.berkeley.cs.avro.runtime.package$$TypedSchema])" class="delimiter">[</span>TypedSchema<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">]</span>, classOf<span title="java.lang.Class[edu.berkeley.cs.avro.runtime.package.TypedSchema[_]](classOf[edu.berkeley.cs.avro.runtime.package$$TypedSchema])" class="delimiter">[</span>TypedSchema<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>
    <a href="#40156" title="java.lang.reflect.Constructor[edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]]">ctor</a>.<span title="(x$1: &lt;repeated...&gt;[java.lang.Object])edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]">newInstance</span><span class="delimiter">(</span><a href="#24029" title="=&gt; (edu.berkeley.cs.scads.comm.AvroChannelManager[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope], edu.berkeley.cs.scads.comm.RemoteNode, edu.berkeley.cs.scads.comm.package.MessageEnvelope) =&gt; Unit">recvMsgCallback</a>, <a href="#9586" title="ServiceRegistry.this.type" class="keyword">this</a>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.ClassLoader">getClassLoader</span>, <a href="#24031" title="=&gt; edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.package.MessageEnvelope]">envelopeSchema</a>, <a href="#24031" title="=&gt; edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.package.MessageEnvelope]">envelopeSchema</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Implemented in Java style for efficiency concerns
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(evt: edu.berkeley.cs.scads.comm.MessageHandlerEvent)edu.berkeley.cs.scads.comm.MessageHandlerResponse" id="24036">foldLeftListeners</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageHandlerEvent" id="41035">evt</a>: <a href="#9588" title="edu.berkeley.cs.scads.comm.MessageHandlerEvent">MessageHandlerEvent</a><span class="delimiter">)</span>: <a href="#9592" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">MessageHandlerResponse</a> = <span class="delimiter">{</span>
    <span title="edu.berkeley.cs.scads.comm.MessageHandlerResponse" class="keyword">if</span> <span class="delimiter">(</span><a href="#24025" title="=&gt; java.util.concurrent.CopyOnWriteArrayList[edu.berkeley.cs.scads.comm.MessageHandlerListener]">listeners</a>.<span title="()Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#41610" title="object edu.berkeley.cs.scads.comm.RelayMessage">RelayMessage</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.util.Iterator[edu.berkeley.cs.scads.comm.MessageHandlerListener]" id="41040">iter</a> = <a href="#24025" title="=&gt; java.util.concurrent.CopyOnWriteArrayList[edu.berkeley.cs.scads.comm.MessageHandlerListener]">listeners</a>.<span title="()java.util.Iterator[edu.berkeley.cs.scads.comm.MessageHandlerListener]">iterator</span>
      <span class="keyword">var</span> <a title="Boolean" id="41041">continue</a> = <a href="#41040" title="java.util.Iterator[edu.berkeley.cs.scads.comm.MessageHandlerListener]">iter</a>.<span title="()Boolean">hasNext</span>
      <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.MessageHandlerResponse" id="41042">result</a>: <a href="#9592" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">MessageHandlerResponse</a> = <a href="#41610" title="object edu.berkeley.cs.scads.comm.RelayMessage">RelayMessage</a>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#41041" title="Boolean">continue</a><span class="delimiter">)</span> <a href="#41043" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageHandlerListener" id="41044">listener</a> = <a href="#41040" title="java.util.Iterator[edu.berkeley.cs.scads.comm.MessageHandlerListener]">iter</a>.<span title="()edu.berkeley.cs.scads.comm.MessageHandlerListener">next</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#41042" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">result</a> =
          <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageHandlerResponse" id="41045">res</a> = <a href="#41044" title="edu.berkeley.cs.scads.comm.MessageHandlerListener">listener</a>.<a href="#38617" title="(evt: edu.berkeley.cs.scads.comm.MessageHandlerEvent)edu.berkeley.cs.scads.comm.MessageHandlerResponse">handleEvent</a><span class="delimiter">(</span><a href="#41035" title="edu.berkeley.cs.scads.comm.MessageHandlerEvent">evt</a><span class="delimiter">)</span>
            <span title="edu.berkeley.cs.scads.comm.MessageHandlerResponse" class="keyword">if</span> <span class="delimiter">(</span><a href="#41045" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">res</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;MessageHandlerListener %s returned null, ignoring&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#41044" title="edu.berkeley.cs.scads.comm.MessageHandlerListener">listener</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#41610" title="object edu.berkeley.cs.scads.comm.RelayMessage">RelayMessage</a>
            <span class="delimiter">}</span> <span class="keyword">else</span> <a href="#41045" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">res</a>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a title="edu.berkeley.cs.scads.comm.RelayMessage.type" id="41055">e</a>: <span title="Exception">Exception</span> =&gt;
              <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Caught exception while executing MessageHandlerListener %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#41044" title="edu.berkeley.cs.scads.comm.MessageHandlerListener">listener</a><span class="delimiter">)</span>, <a href="#41055" title="Exception">e</a><span class="delimiter">)</span>
              <a href="#41610" title="object edu.berkeley.cs.scads.comm.RelayMessage">RelayMessage</a>
          <span class="delimiter">}</span>
        <a href="#41042" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">result</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a href="#41610" title="Unit">RelayMessage</a> =&gt; <span class="comment">/* Progress down the chain */</span>
            <a href="#41041" title="Boolean">continue</a> = <a href="#41040" title="java.util.Iterator[edu.berkeley.cs.scads.comm.MessageHandlerListener]">iter</a>.<span title="()Boolean">hasNext</span>
          <span class="keyword">case</span> <a href="#41562" title="Unit">DropMessage</a> | DelayMessage<span class="delimiter">(</span>_, _<span class="delimiter">)</span> =&gt; <span class="comment">/* Stop the chain */</span>
            <a href="#41041" title="Boolean">continue</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#41042" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">result</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable" id="24037">toRunnable</a><span class="delimiter">(</span><a title="=&gt; Unit" id="41101">f</a>: =&gt; Unit<span class="delimiter">)</span> = <a href="#41104" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="41104">Runnable</a> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="()Unit" id="41106">run</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#41101" title="=&gt; Unit">f</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]], dest: edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType], msg: MessageType)Unit" id="24038">sendMessage</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]" id="36796">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">Option</span><span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="36797">dest</a>: <a href="RemoteServiceProxy.scala.html#9558" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">RemoteServiceProxy</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span>, <a title="MessageType" id="36798">msg</a>: <a href="#9587" title="MessageType">MessageType</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">trace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Sending %s to %s&quot;)" class="string">&quot;Sending %s to %s&quot;</span>, <a href="#36798" title="MessageType">msg</a>, <a href="#36797" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">dest</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="41116">packaged</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#24031" title="(t: edu.berkeley.cs.avro.runtime.package.TypedSchema[edu.berkeley.cs.scads.comm.package.MessageEnvelope])org.apache.avro.Schema">envelopeSchema</a><span class="delimiter">)</span>
    <a href="#36796" title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">src</a>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="41255">s</a> =&gt; <a href="#41116" title="org.apache.avro.generic.GenericData.Record">packaged</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <a href="#41255" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">s</a>.<a href="RemoteServiceProxy.scala.html#28460" title="=&gt; edu.berkeley.cs.scads.comm.ServiceId">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#41116" title="org.apache.avro.generic.GenericData.Record">packaged</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span>, <a href="#36797" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">dest</a>.<a href="RemoteServiceProxy.scala.html#28460" title="=&gt; edu.berkeley.cs.scads.comm.ServiceId">id</a><span class="delimiter">)</span>
    <a href="#41116" title="org.apache.avro.generic.GenericData.Record">packaged</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><span title="Int(2)" class="int">2</span>, <a href="#36798" title="MessageType">msg</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessagePending" id="41117">evt</a> = <a href="#41624" title="(remote: Any, msg: Either[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope])edu.berkeley.cs.scads.comm.MessagePending">MessagePending</a><span class="delimiter">(</span><a href="#36797" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">dest</a>, <span title="(a: org.apache.avro.generic.GenericData.Record)Left[org.apache.avro.generic.GenericData.Record,Nothing]">Left</span><span class="delimiter">(</span><a href="#41116" title="org.apache.avro.generic.GenericData.Record">packaged</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#24036" title="(evt: edu.berkeley.cs.scads.comm.MessageHandlerEvent)edu.berkeley.cs.scads.comm.MessageHandlerResponse">foldLeftListeners</a><span class="delimiter">(</span><a href="#41117" title="edu.berkeley.cs.scads.comm.MessagePending">evt</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a href="#41610" title="Unit">RelayMessage</a> =&gt; <a href="#24033" title="=&gt; edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]">impl</a>.<a href="AvroChannelManager.scala.html#21012" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: org.apache.avro.generic.IndexedRecord)Unit">sendMessage</a><span class="delimiter">(</span><a href="#36797" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">dest</a>.<a href="RemoteServiceProxy.scala.html#28466" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#41116" title="org.apache.avro.generic.GenericData.Record">packaged</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <a href="#41562" title="Unit">DropMessage</a> =&gt; <span class="comment">/* Drop the message */</span>
      <span class="keyword">case</span> <span title="Unit">DelayMessage</span><span class="delimiter">(</span><a title="Long" id="41294">delay</a>, <a title="java.util.concurrent.TimeUnit" id="41295">units</a><span class="delimiter">)</span> =&gt;
        <a href="#24027" title="=&gt; java.util.concurrent.ScheduledExecutorService">delayExecutor</a>.<span title="(x$1: java.lang.Runnable, x$2: Long, x$3: java.util.concurrent.TimeUnit)java.util.concurrent.ScheduledFuture[_]">schedule</span><span title="Unit" class="delimiter">(</span><a href="#24037" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">toRunnable</a><span class="delimiter">(</span><a href="#24033" title="=&gt; edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]">impl</a>.<a href="AvroChannelManager.scala.html#21012" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: org.apache.avro.generic.IndexedRecord)Unit">sendMessage</a><span class="delimiter">(</span><a href="#36797" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">dest</a>.<a href="RemoteServiceProxy.scala.html#28466" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#41116" title="org.apache.avro.generic.GenericData.Record">packaged</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#41294" title="Long">delay</a>, <a href="#41295" title="java.util.concurrent.TimeUnit">units</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(port: Int)Unit" id="24039">startListener</a><span class="delimiter">(</span><a title="Int" id="40994">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#24033" title="=&gt; edu.berkeley.cs.scads.comm.AvroChannelManager[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]">impl</a>.<a href="AvroChannelManager.scala.html#21015" title="(port: Int)Unit">startListener</a><span class="delimiter">(</span><a href="#40994" title="Int">port</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @deprecated<span class="delimiter">(</span><span class="string">&quot;shouldn't be called&quot;</span>, <span class="string">&quot;v2.1.2&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: MessageType)Unit" id="24040">receiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="41325">src</a>: <a href="AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="MessageType" id="41326">msg</a>: <a href="#9587" title="MessageType">MessageType</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Nothing" class="keyword">throw</span> <span title="(x$1: Any)java.lang.AssertionError" class="keyword">new</span> <span title="java.lang.AssertionError">AssertionError</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Should not be called- doReceiveMessage should be called instead&quot;)" class="string">&quot;Should not be called- doReceiveMessage should be called instead&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.package.MessageEnvelope)Unit" id="24041">doReceiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="38983">src</a>: <a href="AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="edu.berkeley.cs.scads.comm.package.MessageEnvelope" id="38984">msg</a>: <span title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">MessageEnvelope</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">trace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Received message: %s from %s&quot;)" class="string">&quot;Received message: %s from %s&quot;</span>, <a href="#38984" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a>, <a href="#38983" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessagePending" id="41364">evt</a> = <a href="#41624" title="(remote: Any, msg: Either[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope])edu.berkeley.cs.scads.comm.MessagePending">MessagePending</a><span class="delimiter">(</span><a href="#38983" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a>, <span title="(b: edu.berkeley.cs.scads.comm.package.MessageEnvelope)Right[Nothing,edu.berkeley.cs.scads.comm.package.MessageEnvelope]">Right</span><span class="delimiter">(</span><a href="#38984" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#24036" title="(evt: edu.berkeley.cs.scads.comm.MessageHandlerEvent)edu.berkeley.cs.scads.comm.MessageHandlerResponse">foldLeftListeners</a><span class="delimiter">(</span><a href="#41364" title="edu.berkeley.cs.scads.comm.MessagePending">evt</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a href="#41610" title="Unit">RelayMessage</a> =&gt; <a href="#24044" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.package.MessageEnvelope)Unit">doReceiveMessage0</a><span class="delimiter">(</span><a href="#38983" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a>, <a href="#38984" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <a href="#41562" title="Unit">DropMessage</a> =&gt; <span class="comment">/* Drop the message */</span>
      <span class="keyword">case</span> <span title="Unit">DelayMessage</span><span class="delimiter">(</span><a title="Long" id="41376">delay</a>, <a title="java.util.concurrent.TimeUnit" id="41377">units</a><span class="delimiter">)</span> =&gt;
        <a href="#24027" title="=&gt; java.util.concurrent.ScheduledExecutorService">delayExecutor</a>.<span title="(x$1: java.lang.Runnable, x$2: Long, x$3: java.util.concurrent.TimeUnit)java.util.concurrent.ScheduledFuture[_]">schedule</span><span title="Unit" class="delimiter">(</span><a href="#24037" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">toRunnable</a><span class="delimiter">(</span><a href="#24044" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.package.MessageEnvelope)Unit">doReceiveMessage0</a><span class="delimiter">(</span><a href="#38983" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a>, <a href="#38984" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#41376" title="Long">delay</a>, <a href="#41377" title="java.util.concurrent.TimeUnit">units</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicLong" id="24042">invalidMessageCount</a> = <span title="()java.util.concurrent.atomic.AtomicLong" class="keyword">new</span> java.util.concurrent.atomic.<span title="java.util.concurrent.atomic.AtomicLong">AtomicLong</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: edu.berkeley.cs.scads.comm.package.MessageEnvelope)Unit" id="24044">doReceiveMessage0</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="41373">src</a>: <a href="AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="edu.berkeley.cs.scads.comm.package.MessageEnvelope" id="41374">msg</a>: <span title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">MessageEnvelope</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ServiceId" id="41391">dest</a> = <a href="#41374" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.comm.ServiceId" class="delimiter">[</span><a href="#61087" title="edu.berkeley.cs.scads.comm.ServiceId">ServiceId</a><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]" id="41392">service</a> = <a href="#24019" title="=&gt; java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]">serviceRegistry</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">get</span><span class="delimiter">(</span><a href="#41391" title="edu.berkeley.cs.scads.comm.ServiceId">dest</a><span class="delimiter">)</span>

    <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">trace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Delivering Message: %s from %s&quot;)" class="string">&quot;Delivering Message: %s from %s&quot;</span>, <a href="#41374" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a>, <a href="#41373" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a><span class="delimiter">)</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41392" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">service</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Option[edu.berkeley.cs.scads.comm.RemoteService[MessageType]]" id="41401">srcProxy</a> = <span title="Option[edu.berkeley.cs.scads.comm.RemoteService[MessageType]]" class="keyword">if</span><span class="delimiter">(</span><a href="#41374" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="object None">None</span> <span class="keyword">else</span> <span title="(x: edu.berkeley.cs.scads.comm.RemoteService[MessageType])Some[edu.berkeley.cs.scads.comm.RemoteService[MessageType]]">Some</span><span class="delimiter">(</span><a href="RemoteServiceProxy.scala.html#36558" title="[MessageType &lt;: org.apache.avro.generic.IndexedRecord](host: String, port: Int, id: edu.berkeley.cs.scads.comm.ServiceId)edu.berkeley.cs.scads.comm.RemoteService[MessageType]">RemoteService</a><span title="(host: String, port: Int, id: edu.berkeley.cs.scads.comm.ServiceId)edu.berkeley.cs.scads.comm.RemoteService[MessageType]" class="delimiter">[</span><a href="#9587" title="MessageType">MessageType</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#41373" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a>.<a href="AvroChannelManager.scala.html#10346" title="=&gt; String">hostname</a>, <a href="#41373" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a>.<a href="AvroChannelManager.scala.html#10348" title="=&gt; Int">port</a>, <a href="#41374" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.comm.ServiceId" class="delimiter">[</span><a href="#61087" title="edu.berkeley.cs.scads.comm.ServiceId">ServiceId</a><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#41401" title="Option[edu.berkeley.cs.scads.comm.RemoteService[MessageType]]">srcProxy</a>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteService[MessageType] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#41425" title="edu.berkeley.cs.scads.comm.RemoteService[MessageType]">_</a>.<a href="RemoteServiceProxy.scala.html#28464" title="implicit edu.berkeley.cs.scads.comm.RemoteServiceProxy.registry_= : (x$1: edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType])Unit">registry</a> = <a href="#9586" title="edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]" class="keyword">this</a><span class="delimiter">)</span>
      <a href="#41392" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">service</a>.<a href="MessageReceiver.scala.html#23248" title="(src: Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]], msg: MessageType)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#41401" title="Option[edu.berkeley.cs.scads.comm.RemoteService[MessageType]]">srcProxy</a>, <a href="#41374" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="MessageType" class="delimiter">[</span><a href="#9587" title="MessageType">MessageType</a><span class="delimiter">]</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Got message for an unknown service: %s %s %s&quot;)" class="string">&quot;Got message for an unknown service: %s %s %s&quot;</span>, <a href="#41373" title="edu.berkeley.cs.scads.comm.RemoteNode">src</a>, <a href="#41391" title="edu.berkeley.cs.scads.comm.ServiceId">dest</a>, <a href="#41374" title="edu.berkeley.cs.scads.comm.package.MessageEnvelope">msg</a><span class="delimiter">)</span>
      <a href="#24042" title="=&gt; java.util.concurrent.atomic.AtomicLong">invalidMessageCount</a>.<span title="()Long">incrementAndGet</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**Immediately start listener on instantiation */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="24045">localPort</a> = <a href="#24047" title="()Int">initListener</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**Naively increments port until a valid one is found */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Int" id="24047">initListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="40984">port</a> = <a href="#24013" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String, defaultValue: Int)Int">getInt</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.comm.listen&quot;)" class="string">&quot;scads.comm.listen&quot;</span>, <span title="Int(9000)" class="int">9000</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="40985">numTries</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">var</span> <a title="Boolean" id="40986">found</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#40986" title="Boolean">found</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#40985" title="Int">numTries</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(500)" class="int">500</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#40987" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
        <a href="#24039" title="(port: Int)Unit">startListener</a><span class="delimiter">(</span><a href="#40984" title="Int">port</a><span class="delimiter">)</span>
        <a href="#40986" title="Boolean">found</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="40996">ex</a>: org.jboss.netty.channel.<span title="org.jboss.netty.channel.ChannelException">ChannelException</span> =&gt;
          <a href="#24015" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Could not listen on port %d, trying %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#40984" title="Int">port</a>, <a href="#40984" title="Int">port</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#40984" title="Int">port</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span> <span class="keyword">finally</span> <span class="delimiter">{</span>
        <a href="#40985" title="Int">numTries</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#40986" title="Boolean">found</a><span class="delimiter">)</span>
      <a href="#40984" title="Int">port</a>
    <span class="keyword">else</span> <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not initialize listening port in 50 tries&quot;)" class="string">&quot;Could not initialize listening port in 50 tries&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(service: edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType])edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]" id="24048">unregisterService</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="24055">service</a>: <a href="RemoteServiceProxy.scala.html#9558" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">RemoteServiceProxy</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#24019" title="=&gt; java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]">serviceRegistry</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">remove</span><span class="delimiter">(</span><a href="#24055" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">service</a>.<a href="RemoteServiceProxy.scala.html#28460" title="=&gt; edu.berkeley.cs.scads.comm.ServiceId">id</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(service: edu.berkeley.cs.scads.comm.MessageReceiver[MessageType])edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="24049">registerService</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]" id="28488">service</a>: <a href="MessageReceiver.scala.html#9527" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">MessageReceiver</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="RemoteServiceProxy.scala.html#9558" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">RemoteServiceProxy</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ServiceNumber" id="41434">id</a> = <a href="#41632" title="(num: Long)edu.berkeley.cs.scads.comm.ServiceNumber">ServiceNumber</a><span class="delimiter">(</span><a href="#24017" title="=&gt; java.util.concurrent.atomic.AtomicLong">curActorId</a>.<span title="()Long">getAndIncrement</span><span class="delimiter">)</span>
    <a href="#24019" title="=&gt; java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]">serviceRegistry</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.ServiceId, x$2: edu.berkeley.cs.scads.comm.MessageReceiver[MessageType])edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">put</span><span class="delimiter">(</span><a href="#41434" title="edu.berkeley.cs.scads.comm.ServiceNumber">id</a>, <a href="#28488" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">service</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteService[MessageType]" id="41435">svc</a> = <a href="RemoteServiceProxy.scala.html#36558" title="[MessageType &lt;: org.apache.avro.generic.IndexedRecord](host: String, port: Int, id: edu.berkeley.cs.scads.comm.ServiceId)edu.berkeley.cs.scads.comm.RemoteService[MessageType]">RemoteService</a><span title="(host: String, port: Int, id: edu.berkeley.cs.scads.comm.ServiceId)edu.berkeley.cs.scads.comm.RemoteService[MessageType]" class="delimiter">[</span><a href="#9587" title="MessageType">MessageType</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#24023" title="=&gt; java.lang.String">hostname</a>, <a href="#24045" title="=&gt; Int">localPort</a>, <a href="#41434" title="edu.berkeley.cs.scads.comm.ServiceNumber">id</a><span class="delimiter">)</span>
    <a href="#41435" title="edu.berkeley.cs.scads.comm.RemoteService[MessageType]">svc</a>.<a href="RemoteServiceProxy.scala.html#28464" title="implicit edu.berkeley.cs.scads.comm.RemoteServiceProxy.registry_= : (x$1: edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType])Unit">registry</a> = <a href="#9586" title="edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]" class="keyword">this</a>
    <a href="#41435" title="edu.berkeley.cs.scads.comm.RemoteService[MessageType]">svc</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(id: String, service: edu.berkeley.cs.scads.comm.MessageReceiver[MessageType])edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="24050">registerService</a><span class="delimiter">(</span><a title="String" id="28474">id</a>: <span title="String">String</span>, <a title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]" id="28475">service</a>: <a href="MessageReceiver.scala.html#9527" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">MessageReceiver</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="RemoteServiceProxy.scala.html#9558" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">RemoteServiceProxy</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ServiceName" id="41447">key</a> = <a href="#41628" title="(name: String)edu.berkeley.cs.scads.comm.ServiceName">ServiceName</a><span class="delimiter">(</span><a href="#28474" title="String">id</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]" id="41448">value0</a> = <a href="#24019" title="=&gt; java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]">serviceRegistry</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.ServiceId, x$2: edu.berkeley.cs.scads.comm.MessageReceiver[MessageType])edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">putIfAbsent</span><span class="delimiter">(</span><a href="#41447" title="edu.berkeley.cs.scads.comm.ServiceName">key</a>, <a href="#28475" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">service</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#41448" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">value0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Service with %s already registered: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#28474" title="String">id</a>, <a href="#28475" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">service</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteService[MessageType]" id="41449">svc</a> = <a href="RemoteServiceProxy.scala.html#36558" title="[MessageType &lt;: org.apache.avro.generic.IndexedRecord](host: String, port: Int, id: edu.berkeley.cs.scads.comm.ServiceId)edu.berkeley.cs.scads.comm.RemoteService[MessageType]">RemoteService</a><span title="(host: String, port: Int, id: edu.berkeley.cs.scads.comm.ServiceId)edu.berkeley.cs.scads.comm.RemoteService[MessageType]" class="delimiter">[</span><a href="#9587" title="MessageType">MessageType</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#24023" title="=&gt; java.lang.String">hostname</a>, <a href="#24045" title="=&gt; Int">localPort</a>, <a href="#41447" title="edu.berkeley.cs.scads.comm.ServiceName">key</a><span class="delimiter">)</span>
    <a href="#41449" title="edu.berkeley.cs.scads.comm.RemoteService[MessageType]">svc</a>.<a href="RemoteServiceProxy.scala.html#28464" title="implicit edu.berkeley.cs.scads.comm.RemoteServiceProxy.registry_= : (x$1: edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType])Unit">registry</a> = <a href="#9586" title="edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]" class="keyword">this</a>
    <a href="#41449" title="edu.berkeley.cs.scads.comm.RemoteService[MessageType]">svc</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Register an actor so that it can receive external messages
   */</span>
  <span class="keyword">def</span> <a title="(actor: scala.actors.Actor)edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="24051">registerActor</a><span class="delimiter">(</span><a title="scala.actors.Actor" id="41474">actor</a>: actors.<span title="scala.actors.Actor">Actor</span><span class="delimiter">)</span>: <a href="RemoteServiceProxy.scala.html#9558" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">RemoteServiceProxy</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ActorReceiver[MessageType]" id="41476">receiver</a> = <span title="edu.berkeley.cs.scads.comm.ActorReceiver[MessageType]" class="keyword">new</span> <a href="MessageReceiver.scala.html#9533" title="edu.berkeley.cs.scads.comm.ActorReceiver[MessageType]">ActorReceiver</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">(</span><a href="#41474" title="scala.actors.Actor">actor</a><span class="delimiter">)</span>
    <a href="#24049" title="(service: edu.berkeley.cs.scads.comm.MessageReceiver[MessageType])edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">registerService</a><span class="delimiter">(</span><a href="#41476" title="edu.berkeley.cs.scads.comm.ActorReceiver[MessageType]">receiver</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(id: String)edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]" id="24052">getService</a><span class="delimiter">(</span><a title="String" id="41481">id</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="MessageReceiver.scala.html#9527" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">MessageReceiver</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> =
    <a href="#24019" title="=&gt; java.util.concurrent.ConcurrentHashMap[edu.berkeley.cs.scads.comm.ServiceId,edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]]">serviceRegistry</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">get</span><span class="delimiter">(</span><a href="#41481" title="String">id</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Register a MessageHandlerListener. Listeners are registered in FIFO
   * order. Note that priority is given to the beginning listeners, meaning if
   * listener A comes before B, and A drops/delays a message, B will never receive
   * notification of that message. Only if A relays the message will B get a
   * chance to act on the message
   *
   * Note: This implementation does check if listener is already registered.
   * If so, this is a no-op (priority is also not changed). Also, registering
   * (and unregistering) is a fairly expensive operation, since the backing
   * list is implemented as a COW list, so it is recommended that listeners
   * are added as part of an initialization sequence, and not touched then.
   */</span>
  <span class="keyword">def</span> <a title="(listener: edu.berkeley.cs.scads.comm.MessageHandlerListener)Unit" id="24053">registerListener</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageHandlerListener" id="41483">listener</a>: <a href="#9600" title="edu.berkeley.cs.scads.comm.MessageHandlerListener">MessageHandlerListener</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#24025" title="=&gt; java.util.concurrent.CopyOnWriteArrayList[edu.berkeley.cs.scads.comm.MessageHandlerListener]">listeners</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.MessageHandlerListener)Boolean">addIfAbsent</span><span title="Unit" class="delimiter">(</span><a href="#41483" title="edu.berkeley.cs.scads.comm.MessageHandlerListener">listener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Unregisters a MessageHandlerListener.
   *
   * Note: Is a no-op if listener is not already registered
   */</span>
  <span class="keyword">def</span> <a title="(listener: edu.berkeley.cs.scads.comm.MessageHandlerListener)Unit" id="24054">unregisterListener</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageHandlerListener" id="41486">listener</a>: <a href="#9600" title="edu.berkeley.cs.scads.comm.MessageHandlerListener">MessageHandlerListener</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#24025" title="=&gt; java.util.concurrent.CopyOnWriteArrayList[edu.berkeley.cs.scads.comm.MessageHandlerListener]">listeners</a>.<span title="(x$1: Any)Boolean">remove</span><span title="Unit" class="delimiter">(</span><a href="#41486" title="edu.berkeley.cs.scads.comm.MessageHandlerListener">listener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">sealed</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class MessageHandlerEvent extends java.lang.Object with ScalaObject" id="9588">MessageHandlerEvent</a>

<span class="comment">/**
 * Indicates that either a message is about to be sent, or a message is about
 * to be received. A LeftProjection of message indicates the former, a
 * RightProjection indicates the latter
 */</span>
case <span class="keyword">class</span> <a title="class MessagePending extends edu.berkeley.cs.scads.comm.MessageHandlerEvent with ScalaObject with Product with Serializable" id="41624">MessagePending</a><a href="#41624" title="ScalaObject" class="delimiter">(</a><a title="Any" id="41281">remote</a>: <span title="Any">Any</span>, <a title="Either[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]" id="41282">msg</a>: <span title="Either[edu.berkeley.cs.scads.comm.package.MessageEnvelope,edu.berkeley.cs.scads.comm.package.MessageEnvelope]">Either</span><span class="delimiter">[</span>MessageEnvelope, MessageEnvelope<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="#9588" title="edu.berkeley.cs.scads.comm.MessageHandlerEvent">MessageHandlerEvent</a>

<span class="keyword">sealed</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class MessageHandlerResponse extends java.lang.Object with ScalaObject" id="9592">MessageHandlerResponse</a>

<span class="comment">/**
 * Drop the message corresponding to the MessageHandlerEvent entirely
 */</span>
case <span class="keyword">object</span> <a href="#41557" title="object edu.berkeley.cs.scads.comm.DropMessage" id="41562">DropMessage</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9592" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">MessageHandlerResponse</a>

<span class="comment">/**
 * Delay the message corresponding to the MessageHandlerEvent by delay. If the
 * message is about to be sent, this means don't send it until delay has
 * elasped. If the message is about to be received, this means don't receive
 * the message until the delay has elasped.
 */</span>
case <span class="keyword">class</span> <a title="class DelayMessage extends edu.berkeley.cs.scads.comm.MessageHandlerResponse with ScalaObject with Product with Serializable" id="41620">DelayMessage</a><a href="#41620" title="ScalaObject" class="delimiter">(</a><a title="Long" id="41615">delay</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="41616">units</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="#9592" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">MessageHandlerResponse</a>

<span class="comment">/**
 * Resume the regular course of action for the message
 */</span>
case <span class="keyword">object</span> <a href="#41605" title="object edu.berkeley.cs.scads.comm.RelayMessage" id="41610">RelayMessage</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9592" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">MessageHandlerResponse</a>

<span class="comment">/**
 * Base trait for a MessageHandler event listener
 */</span>
<span class="keyword">trait</span> <a title="trait MessageHandlerListener extends java.lang.Object" id="9600">MessageHandlerListener</a> <span title="java.lang.Object" class="delimiter">{</span>

  <span class="comment">/**
   * Main method for listeners to supply.
   */</span>
  <span class="keyword">def</span> <a title="(evt: edu.berkeley.cs.scads.comm.MessageHandlerEvent)edu.berkeley.cs.scads.comm.MessageHandlerResponse" id="38617">handleEvent</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageHandlerEvent" id="41046">evt</a>: <a href="#9588" title="edu.berkeley.cs.scads.comm.MessageHandlerEvent">MessageHandlerEvent</a><span class="delimiter">)</span>: <a href="#9592" title="edu.berkeley.cs.scads.comm.MessageHandlerResponse">MessageHandlerResponse</a>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>