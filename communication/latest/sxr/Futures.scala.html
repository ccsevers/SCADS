<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Futures.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> scala.actors._
<span class="keyword">import</span> scala.concurrent.SyncVar
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span> LinkedBlockingQueue, TimeUnit <span class="delimiter">}</span>
<span class="keyword">import</span> java.util.<span class="delimiter">{</span>LinkedList, Queue<span class="delimiter">}</span>
<span class="keyword">import</span> java.lang.ref.WeakReference

<span class="comment">/**
 * This is the base trait for any type of future in SCADS.
 */</span>
<span class="keyword">trait</span> <a title="trait ScadsFuture[+T] extends java.lang.Object with ScalaObject" id="9537">ScadsFuture</a><span class="delimiter">[</span>+<a title="&gt;: Nothing &lt;: Any" id="9538">T</a><span class="delimiter">]</span> <span title="ScalaObject" class="delimiter">{</span> self =&gt;

  <span class="comment">/**
   * Cancels the current future
   */</span>
  <span class="keyword">def</span> <a title="()Unit" id="28995">cancel</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>

  <span class="comment">/**
   * Block on the future until T is ready
   */</span>
  <span class="keyword">def</span> <a title="()T" id="28996">get</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9538" title="T">T</a>

  <span class="comment">/**
   * Same as get()
   */</span>
  <span class="keyword">def</span> <a title="()T" id="28997">apply</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9538" title="T">T</a> = <a href="#28996" title="()T">get</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Block for up to timeout.
   */</span>
  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]" id="28998">get</a><span class="delimiter">(</span><a title="Long" id="29012">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="29015">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span> = TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>: <span title="Option[T]">Option</span><span class="delimiter">[</span>T<span class="delimiter">]</span>

  <span class="comment">/**
   * True iff the future has already been set
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Boolean" id="28999">isSet</a>: <span title="Boolean">Boolean</span>

  <span class="comment">/**
   * Return a new future which is backed by this future and maps the
   * result according to the given function
   */</span>
  <span class="keyword">def</span> <a title="[T1](f: T =&gt; T1)edu.berkeley.cs.scads.comm.ScadsFuture[T1]" id="29000">map</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="29002">T1</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="T =&gt; T1" id="29018">f</a>: T =&gt; T1<span class="delimiter">)</span>: <a href="#9537" title="edu.berkeley.cs.scads.comm.ScadsFuture[T1]">ScadsFuture</a><span class="delimiter">[</span>T1<span class="delimiter">]</span> = <a href="#29021" title="java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T1]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T1]" id="29021">ScadsFuture</a><span class="delimiter">[</span>T1<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="()Unit" id="29025">cancel</a> = <a href="#9537" title="ScadsFuture.this.type">self</a>.<a href="#28995" title="()Unit">cancel</a>
    <span class="keyword">def</span> <a title="()T1" id="29026">get</a> = <a href="#29018" title="(v1: T)T1">f</a><span class="delimiter">(</span><a href="#9537" title="ScadsFuture.this.type">self</a>.<a href="#28996" title="()T">get</a><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T1]" id="29027">get</a><span class="delimiter">(</span><a title="Long" id="29043">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="29049">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span> = TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span> =
      <a href="#9537" title="ScadsFuture.this.type">self</a>.<a href="#28998" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]">get</a><span class="delimiter">(</span><a href="#29043" title="Long">timeout</a>, <a href="#29049" title="java.util.concurrent.TimeUnit">unit</a><span class="delimiter">)</span> <span title="(f: T =&gt; T1)Option[T1]">map</span> <a href="#29018" title="T =&gt; T1">f</a> 
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="29028">isSet</a> = <a href="#9537" title="ScadsFuture.this.type">self</a>.<a href="#28999" title="=&gt; Boolean">isSet</a>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.FutureReference" id="9539">FutureReference</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="24567">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="24569">staleMessages</a> = <span title="java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.lang.ref.<span title="java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture]">ReferenceQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.lang.Thread" id="24571">cleanupThread</a> = <a href="#29194" title="java.lang.Thread" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Thread" id="29194">Thread</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Failed Message Cleanup&quot;)" class="string">&quot;Failed Message Cleanup&quot;</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="29569">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <a href="#29637" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="java.lang.ref.Reference[_ &lt;: edu.berkeley.cs.scads.comm.MessageFuture]" id="29638">futureRef</a> = <a href="#24569" title="=&gt; java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture]">staleMessages</a>.<span title="()java.lang.ref.Reference[_ &lt;: edu.berkeley.cs.scads.comm.MessageFuture]">remove</span>
        <a href="#24567" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Removing gced future from message regsistry.&quot;)" class="string">&quot;Removing gced future from message regsistry.&quot;</span><span class="delimiter">)</span>
        <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14344" title="(ra: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">unregisterActor</a><span class="delimiter">(</span><a href="#29638" title="java.lang.ref.Reference[_ &lt;: edu.berkeley.cs.scads.comm.MessageFuture]">futureRef</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.comm.FutureReference" class="delimiter">[</span><a href="#9541" title="edu.berkeley.cs.scads.comm.FutureReference">FutureReference</a><span class="delimiter">]</span>.<a href="#24583" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <a href="#24571" title="=&gt; java.lang.Thread">cleanupThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>


<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class FutureReference extends java.lang.ref.WeakReference[edu.berkeley.cs.scads.comm.MessageFuture] with edu.berkeley.cs.scads.comm.MessageReceiver with ScalaObject" id="9541">FutureReference</a><a href="#9541" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.MessageFuture" id="24587">future</a>: <a href="#9544" title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a><span class="delimiter">)</span> <span class="keyword">extends</span> java.lang.ref.<span title="java.lang.ref.WeakReference[edu.berkeley.cs.scads.comm.MessageFuture]">WeakReference</span><span class="delimiter">(</span><a href="#24587" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>, <a href="#9539" title="object edu.berkeley.cs.scads.comm.FutureReference">FutureReference</a>.<a href="#24569" title="=&gt; java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture]">staleMessages</a><span class="delimiter">)</span> <span class="keyword">with</span> <a href="MessageReceiver.scala.html#9591" title="edu.berkeley.cs.scads.comm.MessageReceiver">MessageReceiver</a> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteActor" id="24583">remoteActor</a> = <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14345" title="(service: edu.berkeley.cs.scads.comm.MessageReceiver)edu.berkeley.cs.scads.comm.RemoteActor">registerService</a><span class="delimiter">(</span><a href="#9541" title="edu.berkeley.cs.scads.comm.FutureReference" class="keyword">this</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.MessageBody)Unit" id="24585">receiveMessage</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="29686">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">Option</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.MessageBody" id="29687">msg</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#9541" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="29693">future</a> = <a href="#9541" title="()edu.berkeley.cs.scads.comm.MessageFuture">get</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#29693" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#29693" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<a href="#24390" title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#29686" title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">src</a>, <a href="#29687" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#9539" title="object edu.berkeley.cs.scads.comm.FutureReference">FutureReference</a>.<a href="#24567" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Message for garbage collected future received: %s&quot;)" class="string">&quot;Message for garbage collected future received: %s&quot;</span>, <a href="#29686" title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">src</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.MessageFuture" id="29705">MessageFuture</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection" id="27308">toFutureCollection</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="27321">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9545" title="edu.berkeley.cs.scads.comm.FutureCollection">FutureCollection</a> = <span title="edu.berkeley.cs.scads.comm.FutureCollection" class="keyword">new</span> <a href="#9545" title="edu.berkeley.cs.scads.comm.FutureCollection">FutureCollection</a><span class="delimiter">(</span><a href="#27321" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class MessageFuture extends scala.actors.Future[edu.berkeley.cs.scads.comm.MessageBody] with ScalaObject" id="9544">MessageFuture</a> <a href="#9544" title="ScalaObject" class="keyword">extends</a> <span title="scala.actors.Future[edu.berkeley.cs.scads.comm.MessageBody]">Future</span><span class="delimiter">[</span>MessageBody<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">protected</span><span class="delimiter">[</span>comm<span class="delimiter">]</span> <span class="keyword">val</span> <a title="scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]]" id="24369">sender</a> = <span title="scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]]" class="keyword">new</span> <span title="scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]]">SyncVar</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]" id="24371">message</a> = <span title="scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]" class="keyword">new</span> <span title="scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">SyncVar</span><span class="delimiter">[</span>MessageBody<span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]]" id="24374">forwardList</a>: <span title="List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]]">List</span><span class="delimiter">[</span>Queue<span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">]</span> = List<span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor" id="24376">remoteActor</a> = <span class="delimiter">(</span><span title="edu.berkeley.cs.scads.comm.FutureReference" class="keyword">new</span> <a href="#9541" title="edu.berkeley.cs.scads.comm.FutureReference">FutureReference</a><span class="delimiter">(</span><a href="#9544" title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="#24583" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a>

  <span class="comment">/* Note: doesn't really implement interface correctly */</span>
  <span class="keyword">def</span> <a title="=&gt; java.lang.Object with scala.actors.InputChannel[edu.berkeley.cs.scads.comm.MessageBody]{def ?(): edu.berkeley.cs.scads.comm.MessageBody}" id="24377">inputChannel</a> = <a href="#29774" title="java.lang.Object with scala.actors.InputChannel[edu.berkeley.cs.scads.comm.MessageBody]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with scala.actors.InputChannel[edu.berkeley.cs.scads.comm.MessageBody]" id="29774">InputChannel</a><span class="delimiter">[</span>MessageBody<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.MessageBody" id="29778">?</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a> = <a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">get</span>
    <span class="keyword">def</span> <a title="(msec: Long)(pf: PartialFunction[Any,Unit])Nothing" id="29779">reactWithin</a><span class="delimiter">(</span><a title="Long" id="29788">msec</a>: <span title="Long">Long</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="PartialFunction[Any,Unit]" id="29789">pf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Nothing">Nothing</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(f: PartialFunction[edu.berkeley.cs.scads.comm.MessageBody,Unit])Nothing" id="29780">react</a><span class="delimiter">(</span><a title="PartialFunction[edu.berkeley.cs.scads.comm.MessageBody,Unit]" id="29791">f</a>: <span title="PartialFunction[edu.berkeley.cs.scads.comm.MessageBody,Unit]">PartialFunction</span><span class="delimiter">[</span>MessageBody, Unit<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Nothing">Nothing</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="[R](f: PartialFunction[edu.berkeley.cs.scads.comm.MessageBody,R])R" id="29781">receive</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="29783">R</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="PartialFunction[edu.berkeley.cs.scads.comm.MessageBody,R]" id="29794">f</a>: <span title="PartialFunction[edu.berkeley.cs.scads.comm.MessageBody,R]">PartialFunction</span><span class="delimiter">[</span>MessageBody, R<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#29783" title="R">R</a> = <a href="#29794" title="(v1: edu.berkeley.cs.scads.comm.MessageBody)R">f</a><span class="delimiter">(</span><a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">get</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="[R](msec: Long)(f: PartialFunction[Any,R])R" id="29784">receiveWithin</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="29786">R</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="Long" id="29801">msec</a>: <span title="Long">Long</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="PartialFunction[Any,R]" id="29802">f</a>: <span title="PartialFunction[Any,R]">PartialFunction</span><span class="delimiter">[</span>Any, R<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#29786" title="R">R</a> = <a href="#29802" title="(v1: Any)R">f</a><span class="delimiter">(</span><a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</span><span class="delimiter">(</span><a href="#29801" title="Long">msec</a><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageBody">getOrElse</span><span class="delimiter">(</span><a href="Messages.scala.html#29842" title="(cause: String, stacktrace: String)edu.berkeley.cs.scads.comm.ProcessingException">ProcessingException</a><span class="delimiter">(</span><span title="java.lang.String(&quot;timeout&quot;)" class="string">&quot;timeout&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.MessageBody" id="24378">apply</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">get</span>


  <span class="comment">//The actual sender of a message</span>
  <span class="keyword">def</span> <a title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="24379">source</a> =  <a href="#24369" title="=&gt; scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]]">sender</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">get</span>

  <span class="keyword">var</span> <a title="List[edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit]" id="24381">respondFunctions</a>: <span title="List[edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit]">List</span><span class="delimiter">[</span>MessageBody =&gt; Unit<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
  <span class="keyword">def</span> <a title="(r: edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit)Unit" id="24383">respond</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit" id="27560">r</a>: MessageBody =&gt; Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#9544" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; Boolean">isSet</span><span class="delimiter">)</span>
      <a href="#27560" title="(v1: edu.berkeley.cs.scads.comm.MessageBody)Unit">r</a><span class="delimiter">(</span><a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">get</span><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#24381" title="(x$1: List[edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit])Unit">respondFunctions</a> <span title="(x: edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit)List[edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit]">::=</span> <a href="#27560" title="edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit">r</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.MessageBody" id="24384">get</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a> = <a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.MessageBody">get</span>

  <span class="keyword">def</span> <a title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]" id="24385">get</a><span class="delimiter">(</span><a title="Long" id="25067">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Option[edu.berkeley.cs.scads.comm.MessageBody]">Option</span><span class="delimiter">[</span>MessageBody<span class="delimiter">]</span> =
    <a href="#24386" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</a><span class="delimiter">(</span><a href="#25067" title="Long">timeout</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[edu.berkeley.cs.scads.comm.MessageBody]" id="24386">get</a><span class="delimiter">(</span><a title="Long" id="24597">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="24598">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <span title="Option[edu.berkeley.cs.scads.comm.MessageBody]">Option</span><span class="delimiter">[</span>MessageBody<span class="delimiter">]</span> = 
    <a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</span><span class="delimiter">(</span><a href="#24598" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#24597" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="24387">isSet</a>: <span title="Boolean">Boolean</span> = <a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; Boolean">isSet</span>

  <span class="comment">/**
   * Cancel this request by unregistering with the message handler.
   * Note no action is taken to cancel processing initiating message server-side.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="24388">cancel</a>: <span title="Unit">Unit</span> = <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14344" title="(ra: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">unregisterActor</a><span class="delimiter">(</span><a href="#24376" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Either forward the result to the following queue, or request that it be forwarded upon arrival.
   */</span>
  <span class="keyword">def</span> <a title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit" id="24389">forward</a><span class="delimiter">(</span><a title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]" id="29934">dest</a>: <span title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]">Queue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#9544" title="(x$1: AnyVal)AnyVal">synchronized</a> <span title="Unit" class="delimiter">{</span>
    <span title="AnyVal" class="keyword">if</span><span class="delimiter">(</span><a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="=&gt; Boolean">isSet</span><span class="delimiter">)</span>
      <a href="#29934" title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]">dest</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.MessageFuture)Boolean">offer</span><span class="delimiter">(</span><a href="#9544" title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">this</a><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#24374" title="(x$1: List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]])Unit">forwardList</a> <span title="(x: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]]">::=</span> <a href="#29934" title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]">dest</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.MessageBody)Unit" id="24390">receiveMessage</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="27822">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">Option</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.MessageBody" id="27823">msg</a>: <a href="Messages.scala.html#9601" title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#9544" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <a href="MessageHandler.scala.html#9563" title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</a>.<a href="MessageHandler.scala.html#14344" title="(ra: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">unregisterActor</a><span class="delimiter">(</span><a href="#24376" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteActor</a><span class="delimiter">)</span>
    <a href="#24371" title="=&gt; scala.concurrent.SyncVar[edu.berkeley.cs.scads.comm.MessageBody]">message</a>.<span title="(x: edu.berkeley.cs.scads.comm.MessageBody)Unit">set</span><span class="delimiter">(</span><a href="#27823" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a><span class="delimiter">)</span>
    <a href="#24369" title="=&gt; scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]]">sender</a>.<span title="(x: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">set</span><span class="delimiter">(</span><a href="#27822" title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">src</a><span class="delimiter">)</span>
    <a href="#24374" title="=&gt; List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]]">forwardList</a>.<span title="(f: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture] =&gt; Boolean)Unit">foreach</span><span class="delimiter">(</span><a href="#29992" title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture]">_</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.MessageFuture)Boolean">offer</span><span class="delimiter">(</span><a href="#9544" title="edu.berkeley.cs.scads.comm.MessageFuture" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#24381" title="=&gt; List[edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit]">respondFunctions</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageBody =&gt; Unit =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#30022" title="(v1: edu.berkeley.cs.scads.comm.MessageBody)Unit">_</a><span class="delimiter">(</span><a href="#27823" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class FutureCollection extends java.lang.Object with ScalaObject" id="9545">FutureCollection</a><a href="#9545" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="29704">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="27327">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>
  <a href="#29704" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#30303" title="edu.berkeley.cs.scads.comm.MessageFuture">_</a>.<a href="#24389" title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit">forward</a><span class="delimiter">(</span><a href="#27327" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="27329">blockFor</a><span class="delimiter">(</span><a title="Int" id="30305">count</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span> = <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#30305" title="Int">count</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a title="Int" id="30857">_</a> =&gt; <a href="#27327" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="()edu.berkeley.cs.scads.comm.MessageFuture">take</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="27330">blockFor</a><span class="delimiter">(</span><a title="Int" id="30967">count</a>: <span title="Int">Int</span>, <a title="Long" id="30968">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="30969">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#30967" title="Int">count</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a title="Int" id="31070">_</a> =&gt; <span title="(x: edu.berkeley.cs.scads.comm.MessageFuture)Option[edu.berkeley.cs.scads.comm.MessageFuture]">Option</span><span class="delimiter">(</span><a href="#27327" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture">poll</span><span class="delimiter">(</span><a href="#30968" title="Long">timeout</a>, <a href="#30969" title="java.util.concurrent.TimeUnit">unit</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.comm.MessageFuture)edu.berkeley.cs.scads.comm.MessageFuture">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;TIMEOUT&quot;)" class="string">&quot;TIMEOUT&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class FutureTimeoutException extends java.lang.RuntimeException with ScalaObject" id="9546">FutureTimeoutException</a> <a href="#9546" title="ScalaObject" class="keyword">extends</a> <span title="java.lang.RuntimeException">RuntimeException</span>
<span class="keyword">class</span> <a title="class FutureException extends java.lang.RuntimeException with ScalaObject" id="9547">FutureException</a><a href="#9547" title="ScalaObject" class="delimiter">(</a><a title="Throwable" id="31121">ex</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#31121" title="Throwable">ex</a><span class="delimiter">)</span>

<span class="comment">/**
 * Default synchronized-based implementation of ScadsFuture
 */</span>
<span class="keyword">class</span> <a title="class BlockingFuture[T] extends java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T] with ScalaObject" id="9548">BlockingFuture</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="9549">T</a><span class="delimiter">]</span> <a href="#9548" title="ScalaObject" class="keyword">extends</a> <a href="#9537" title="edu.berkeley.cs.scads.comm.ScadsFuture[T]">ScadsFuture</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Throwable" id="31129">ex</a>: <span title="Throwable">Throwable</span> = _
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="31132">done</a>          = <span title="Boolean(false)" class="keyword">false</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="T" id="31135">elem</a>: <a href="#9549" title="T">T</a>       = _

  <span class="keyword">def</span> <a title="()Unit" id="31137">cancel</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;UNIMPLEMENTED&quot;)" class="string">&quot;UNIMPLEMENTED&quot;</span><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="31138">isSet</a>: <span title="Boolean">Boolean</span> = <a href="#9548" title="(x$1: Boolean)Boolean">synchronized</a> <span class="delimiter">{</span> <a href="#31132" title="=&gt; Boolean">done</a> <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(timeout: Long)T" id="31139">await</a><span class="delimiter">(</span><a title="Long" id="31268">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <a href="#9549" title="T">T</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[T]" id="31270">opt</a> = <a href="#31142" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]">get</a><span class="delimiter">(</span><a href="#31268" title="Long">timeout</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
    <a href="#31270" title="Option[T]">opt</a>.<span title="(default: =&gt; T)T">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.comm.FutureTimeoutException" class="keyword">new</span> <a href="#9546" title="edu.berkeley.cs.scads.comm.FutureTimeoutException">FutureTimeoutException</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()T" id="31140">await</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9549" title="T">T</a> = <a href="#31139" title="(timeout: Long)T">await</a><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()T" id="31141">get</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9549" title="T">T</a> = <a href="#31139" title="(timeout: Long)T">await</a><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]" id="31142">get</a><span class="delimiter">(</span><a title="Long" id="31273">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="31274">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <span title="Option[T]">Option</span><span class="delimiter">[</span>T<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#9548" title="(x$1: Option[T])Option[T]">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#31132" title="=&gt; Boolean">done</a><span class="delimiter">)</span>
        <a href="#9548" title="(x$1: Long)Unit">wait</a><span class="delimiter">(</span><a href="#31274" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#31273" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Option[T]" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#31132" title="=&gt; Boolean">done</a><span class="delimiter">)</span> <span title="object None">None</span>
      <span class="keyword">else</span> <span title="Option[T]" class="keyword">if</span> <span class="delimiter">(</span><a href="#31129" title="=&gt; Throwable">ex</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.comm.FutureException" class="keyword">new</span> <a href="#9547" title="edu.berkeley.cs.scads.comm.FutureException">FutureException</a><span class="delimiter">(</span><a href="#31129" title="=&gt; Throwable">ex</a><span class="delimiter">)</span>
      <span class="keyword">else</span> <span class="delimiter">{</span>
        <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#31135" title="=&gt; T">elem</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="AnyRef" class="delimiter">[</span><span title="AnyRef">AnyRef</span><span class="delimiter">]</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;Element cannot be null if done&quot;)" class="string">&quot;Element cannot be null if done&quot;</span><span class="delimiter">)</span>
        <span title="(x: T)Some[T]">Some</span><span class="delimiter">(</span><a href="#31135" title="=&gt; T">elem</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(e: T)Unit" id="31143">finish</a><span class="delimiter">(</span><a title="T" id="31307">e</a>: <a href="#9549" title="T">T</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#31307" title="T">e</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="AnyRef" class="delimiter">[</span><span title="AnyRef">AnyRef</span><span class="delimiter">]</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#9548" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#31132" title="=&gt; Boolean">done</a><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Future already done&quot;)" class="string">&quot;Future already done&quot;</span><span class="delimiter">)</span>
      <a href="#31132" title="(x$1: Boolean)Unit">done</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#31135" title="(x$1: T)Unit">elem</a> = <a href="#31307" title="T">e</a>
      <a href="#9548" title="()Unit">notifyAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(error: Throwable)Unit" id="31144">finishWithError</a><span class="delimiter">(</span><a title="Throwable" id="31327">error</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#31327" title="Throwable">error</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#9548" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#31132" title="=&gt; Boolean">done</a><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Future already done&quot;)" class="string">&quot;Future already done&quot;</span><span class="delimiter">)</span>
      <a href="#31132" title="(x$1: Boolean)Unit">done</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#31129" title="(x$1: Throwable)Unit">ex</a>   = <a href="#31327" title="Throwable">error</a>
      <a href="#9548" title="()Unit">notifyAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 *  Default future which wraps a computation in a future. This computation is allowed to fail. 
 *  The semantics are that if the computation fails (by throwing an exception), then calls to get() will also throw an
 *  exception. Otherwise, the value from the computation will be returned.
 *  Note that the computation does NOT start running until the first call to
 *  get() is invoked
 */</span>
<span class="keyword">trait</span> <a title="trait ComputationFuture[T] extends java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T] with ScalaObject" id="9550">ComputationFuture</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="9551">T</a><span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="#9537" title="edu.berkeley.cs.scads.comm.ScadsFuture[T]">ScadsFuture</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">{</span>

  <span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean
  <span class="keyword">import</span> scala.concurrent.SyncVar

  <span class="comment">/**
   * The computation that should run with this future. Is guaranteed to only
   * be called at most once. Timeout hint is a hint for how long the user is
   * willing to wait for this computation to compute
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)T" id="31341">compute</a><span class="delimiter">(</span><a title="Long" id="31601">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="31602">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <a href="#9551" title="T">T</a> 

  <span class="comment">/**
   * Signals a request to cancel the computation. Is guaranteed to only be
   * called at most once.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="31342">cancelComputation</a>: <span title="Unit">Unit</span>

  <span class="comment">/** Guard the computation from only running once */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicBoolean" id="31343">computeGuard</a> = <span title="java.util.concurrent.atomic.AtomicBoolean" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>

  <span class="comment">/** Guard the cancellation request from only being invoked once */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicBoolean" id="31345">cancelGuard</a> = <span title="java.util.concurrent.atomic.AtomicBoolean" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>

  <span class="comment">/** Store the result */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.concurrent.SyncVar[Either[T,Throwable]]" id="31347">syncVar</a> = <span title="scala.concurrent.SyncVar[Either[T,Throwable]]" class="keyword">new</span> <span title="scala.concurrent.SyncVar[Either[T,Throwable]]">SyncVar</span><span class="delimiter">[</span>Either<span class="delimiter">[</span>T, Throwable<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="()Unit" id="31349">cancel</a> = 
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#31345" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">cancelGuard</a>.<span title="(x$1: Boolean, x$2: Boolean)Boolean">compareAndSet</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> 
      <a href="#31342" title="=&gt; Unit">cancelComputation</a>

  <span class="keyword">def</span> <a title="()T" id="31350">get</a> = <a href="#31352" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]">get</a><span class="delimiter">(</span>java.lang.Long.<span title="Long(9223372036854775807L)">MAX_VALUE</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>.<span title="=&gt; T">get</span> 

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(res: Either[T,Throwable])T" id="31351">dispatchResult</a><span class="delimiter">(</span><a title="Either[T,Throwable]" id="31705">res</a>: <span title="Either[T,Throwable]">Either</span><span class="delimiter">[</span>T, Throwable<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9551" title="T">T</a> = <a href="#31705" title="Either[T,Throwable]">res</a> <span title="T" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="T">Left</span><span class="delimiter">(</span><a title="T" id="31724">value</a><span class="delimiter">)</span> =&gt; <a href="#31724" title="T">value</a>
    <span class="keyword">case</span> <span title="Nothing">Right</span><span class="delimiter">(</span><a title="Throwable" id="31726">ex</a><span class="delimiter">)</span>   =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.Throwable)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#31726" title="Throwable">ex</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]" id="31352">get</a><span class="delimiter">(</span><a title="Long" id="31615">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="31616">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = <span class="delimiter">{</span> 
    <span title="Option[T]" class="keyword">if</span> <span class="delimiter">(</span><a href="#31343" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">computeGuard</a>.<span title="(x$1: Boolean, x$2: Boolean)Boolean">compareAndSet</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// this is a bit of a hack now, since the computation blocks the current</span>
      <span class="comment">// thread. will have to move to a separate thread for true get semantics</span>
      <span class="keyword">try</span> <a href="#31347" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="(x: Either[T,Throwable])Unit">set</span><span class="delimiter">(</span><span title="(a: T)Left[T,Nothing]">Left</span><span class="delimiter">(</span><a href="#31341" title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)T">compute</a><span class="delimiter">(</span><a href="#31615" title="Long">timeout</a>, <a href="#31616" title="java.util.concurrent.TimeUnit">unit</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="31662">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="#31347" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="(x: Either[T,Throwable])Unit">set</span><span class="delimiter">(</span><span title="(b: java.lang.Throwable)Right[Nothing,java.lang.Throwable]">Right</span><span class="delimiter">(</span><a href="#31662" title="java.lang.Throwable">e</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span title="(x: T)Some[T]">Some</span><span class="delimiter">(</span><a href="#31351" title="(res: Either[T,Throwable])T">dispatchResult</a><span class="delimiter">(</span><a href="#31347" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="=&gt; Either[T,Throwable]">get</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// other thread beat us out to finishing the get handler- in this</span>
      <span class="comment">// case just wait on the sync var</span>
      <a href="#31347" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="(timeout: Long)Option[Either[T,Throwable]]">get</span><span class="delimiter">(</span><a href="#31616" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#31615" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Either[T,Throwable] =&gt; T)Option[T]">map</span><span class="delimiter">(</span><a href="#31351" title="(res: Either[T,Throwable])T">dispatchResult</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>   
  <span class="delimiter">}</span>   
  <span class="keyword">def</span> <a title="=&gt; Boolean" id="31353">isSet</a> = <a href="#31347" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="=&gt; Boolean">isSet</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>