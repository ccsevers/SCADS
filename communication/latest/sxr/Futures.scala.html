<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>Futures.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> scala.actors._
<span class="keyword">import</span> scala.concurrent.SyncVar
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> org.apache.avro.generic.IndexedRecord
<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span> LinkedBlockingQueue, TimeUnit <span class="delimiter">}</span>
<span class="keyword">import</span> java.util.<span class="delimiter">{</span>LinkedList, Queue<span class="delimiter">}</span>
<span class="keyword">import</span> java.lang.ref.WeakReference
<span class="keyword">import</span> java.lang.RuntimeException

<span class="comment">/**
 * This is the base trait for any type of future in SCADS.
 */</span>
<span class="keyword">trait</span> <a title="trait ScadsFuture[+T] extends java.lang.Object with ScalaObject" id="9500">ScadsFuture</a><span class="delimiter">[</span>+<a title="&gt;: Nothing &lt;: Any" id="9501">T</a><span class="delimiter">]</span> <span title="ScalaObject" class="delimiter">{</span> self =&gt;

  <span class="comment">/**
   * Cancels the current future
   */</span>
  <span class="keyword">def</span> <a title="()Unit" id="22876">cancel</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>

  <span class="comment">/**
   * Block on the future until T is ready
   */</span>
  <span class="keyword">def</span> <a title="()T" id="22877">get</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9501" title="T">T</a>

  <span class="comment">/**
   * Same as get()
   */</span>
  <span class="keyword">def</span> <a title="()T" id="22878">apply</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9501" title="T">T</a> = <a href="#22877" title="()T">get</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Block for up to timeout.
   */</span>
  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]" id="22879">get</a><span class="delimiter">(</span><a title="Long" id="22893">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="22896">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span> = TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>: <span title="Option[T]">Option</span><span class="delimiter">[</span>T<span class="delimiter">]</span>

  <span class="comment">/**
   * True iff the future has already been set
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Boolean" id="22880">isSet</a>: <span title="Boolean">Boolean</span>

  <span class="comment">/**
   * Return a new future which is backed by this future and maps the
   * result according to the given function
   */</span>
  <span class="keyword">def</span> <a title="[T1](f: T =&gt; T1)edu.berkeley.cs.scads.comm.ScadsFuture[T1]" id="22881">map</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="22883">T1</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="T =&gt; T1" id="22954">f</a>: T =&gt; T1<span class="delimiter">)</span>: <a href="#9500" title="edu.berkeley.cs.scads.comm.ScadsFuture[T1]">ScadsFuture</a><span class="delimiter">[</span>T1<span class="delimiter">]</span> = <a href="#22957" title="java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T1]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T1]" id="22957">ScadsFuture</a><span class="delimiter">[</span>T1<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="()Unit" id="22961">cancel</a> = <a href="#9500" title="ScadsFuture.this.type">self</a>.<a href="#22876" title="()Unit">cancel</a>
    <span class="keyword">def</span> <a title="()T1" id="22962">get</a> = <a href="#22954" title="(v1: T)T1">f</a><span class="delimiter">(</span><a href="#9500" title="ScadsFuture.this.type">self</a>.<a href="#22877" title="()T">get</a><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T1]" id="22963">get</a><span class="delimiter">(</span><a title="Long" id="22979">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="22985">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span> = TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span> =
      <a href="#9500" title="ScadsFuture.this.type">self</a>.<a href="#22879" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]">get</a><span class="delimiter">(</span><a href="#22979" title="Long">timeout</a>, <a href="#22985" title="java.util.concurrent.TimeUnit">unit</a><span class="delimiter">)</span> <span title="(f: T =&gt; T1)Option[T1]">map</span> <a href="#22954" title="T =&gt; T1">f</a> 
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="22964">isSet</a> = <a href="#9500" title="ScadsFuture.this.type">self</a>.<a href="#22880" title="=&gt; Boolean">isSet</a>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.FutureReference" id="9502">FutureReference</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="23042">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture[_]]" id="23044">staleMessages</a> = <span title="java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture[_]]" class="keyword">new</span> java.lang.ref.<span title="java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture[_]]">ReferenceQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.lang.Thread" id="23046">cleanupThread</a> = <a href="#23548" title="java.lang.Thread" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Thread" id="23548">Thread</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Failed Message Cleanup&quot;)" class="string">&quot;Failed Message Cleanup&quot;</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="23923">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <a href="#23991" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.FutureReference[_]" id="23992">futureRef</a> = <a href="#23044" title="=&gt; java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture[_]]">staleMessages</a>.<span title="()java.lang.ref.Reference[_ &lt;: edu.berkeley.cs.scads.comm.MessageFuture[_]]">remove</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.comm.FutureReference[_$2]" class="delimiter">[</span><a href="#9504" title="edu.berkeley.cs.scads.comm.FutureReference[_]">FutureReference</a><span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">]</span>
        <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#23992" title="edu.berkeley.cs.scads.comm.FutureReference[_]">futureRef</a>.<a href="#23245" title="=&gt; Boolean">unregister</a><span class="delimiter">)</span>
          <a href="#23042" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Removing unsatisfied gced future from message regsistry: %s %s %s&quot;)" class="string">&quot;Removing unsatisfied gced future from message regsistry: %s %s %s&quot;</span>, <a href="#23992" title="edu.berkeley.cs.scads.comm.FutureReference[_]">futureRef</a>.<a href="#23235" title="(=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[_$2]) forSome { type _$2 }">remoteService</a>, <a href="#23992" title="edu.berkeley.cs.scads.comm.FutureReference[_]">futureRef</a>.<a href="#23239" title="(=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[_$2]) forSome { type _$2 }">dest</a>,<a href="#23992" title="edu.berkeley.cs.scads.comm.FutureReference[_]">futureRef</a>.<a href="#23237" title="=&gt; Any">request</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <a href="#23046" title="=&gt; java.lang.Thread">cleanupThread</a>.<span title="(x$1: Boolean)Unit">setDaemon</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <a href="#23046" title="=&gt; java.lang.Thread">cleanupThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class FutureReference[MessageType &lt;: org.apache.avro.generic.IndexedRecord] extends java.lang.ref.WeakReference[edu.berkeley.cs.scads.comm.MessageFuture[_]] with edu.berkeley.cs.scads.comm.MessageReceiver[MessageType] with ScalaObject" id="9504">FutureReference</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9505">MessageType</a> &lt;: IndexedRecord<span class="delimiter">]</span><a href="#9504" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]" id="23246">future</a>: <a href="#31559" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">MessageFuture</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]" id="23247">handler</a>: <a href="ServiceRegistry.scala.html#9586" title="edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]">ServiceRegistry</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> java.lang.ref.<span title="java.lang.ref.WeakReference[edu.berkeley.cs.scads.comm.MessageFuture[_]]">WeakReference</span><span class="delimiter">(</span><a href="#23246" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">future</a>, <a href="#9502" title="object edu.berkeley.cs.scads.comm.FutureReference">FutureReference</a>.<a href="#23044" title="=&gt; java.lang.ref.ReferenceQueue[edu.berkeley.cs.scads.comm.MessageFuture[_]]">staleMessages</a><span class="delimiter">)</span> <span class="keyword">with</span> <a href="MessageReceiver.scala.html#9527" title="edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">MessageReceiver</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="23235">remoteService</a> = <a href="#23247" title="=&gt; edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]">handler</a>.<a href="ServiceRegistry.scala.html#24049" title="(service: edu.berkeley.cs.scads.comm.MessageReceiver[MessageType])edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">registerService</a><span class="delimiter">(</span><a href="#9504" title="edu.berkeley.cs.scads.comm.FutureReference[MessageType]" class="keyword">this</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="MessageType" id="23237">request</a> = <a href="#23246" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">future</a>.<a href="#31513" title="=&gt; MessageType">request</a>
  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="23239">dest</a> = <a href="#23246" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">future</a>.<a href="#31510" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">dest</a>
  <a href="#28836" title="object edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>.<a href="#28605" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Future registered: %s %s to %s&quot;)" class="string">&quot;Future registered: %s %s to %s&quot;</span>, <a href="#23235" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">remoteService</a>, <a href="#23237" title="=&gt; MessageType">request</a>, <a href="#23239" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">dest</a><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="23242">registered</a> = <span title="Boolean(true)" class="keyword">true</span>

  <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]], msg: MessageType)Unit" id="23244">receiveMessage</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]" id="28751">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">Option</span><span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="MessageType" id="28752">msg</a>: <a href="#9505" title="MessageType">MessageType</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#9504" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <a href="#28836" title="object edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</a>.<a href="#28605" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Attempting delivery to %s&quot;)" class="string">&quot;Attempting delivery to %s&quot;</span>, <a href="#23235" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">remoteService</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]" id="28760">future</a> = <a href="#9504" title="()edu.berkeley.cs.scads.comm.MessageFuture[_]">get</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]" class="delimiter">[</span><a href="#31559" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">MessageFuture</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span>
    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#23245" title="=&gt; Boolean">unregister</a><span class="delimiter">)</span> <a href="#9502" title="object edu.berkeley.cs.scads.comm.FutureReference">FutureReference</a>.<a href="#23042" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;GCed future %s&quot;)" class="string">&quot;GCed future %s&quot;</span>, <a href="#23235" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">remoteService</a><span class="delimiter">)</span>
    <a href="#9504" title="()Unit">clear</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#28760" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">future</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#28760" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">future</a>.<a href="#23180" title="(src: Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]], msg: MessageType)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#28751" title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">src</a>, <a href="#28752" title="MessageType">msg</a><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#9502" title="object edu.berkeley.cs.scads.comm.FutureReference">FutureReference</a>.<a href="#23042" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Message for garbage collected future received: %s %s from %s&quot;)" class="string">&quot;Message for garbage collected future received: %s %s from %s&quot;</span>, <a href="#23235" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">remoteService</a>, <a href="#28752" title="MessageType">msg</a>, <a href="#28751" title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">src</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="23245">unregister</a> = <a href="#9504" title="(x$1: Boolean)Boolean">synchronized</a> <span class="delimiter">{</span>
    <span title="Boolean" class="keyword">if</span><span class="delimiter">(</span><a href="#23242" title="=&gt; Boolean">registered</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#23242" title="(x$1: Boolean)Unit">registered</a> = <span title="Boolean(false)" class="keyword">false</span>
      <a href="#23247" title="=&gt; edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]">handler</a>.<a href="ServiceRegistry.scala.html#24048" title="(service: edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType])edu.berkeley.cs.scads.comm.MessageReceiver[MessageType]">unregisterService</a><span class="delimiter">(</span><a href="#23235" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">remoteService</a><span class="delimiter">)</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Boolean(false)" class="keyword">false</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.MessageFuture" id="28836">MessageFuture</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="28605">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[MessageType &lt;: org.apache.avro.generic.IndexedRecord](futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]])edu.berkeley.cs.scads.comm.FutureCollection[MessageType]" id="28607">toFutureCollection</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="28609">MessageType</a> &lt;: IndexedRecord<span class="delimiter">]</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]" id="28788">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.comm.FutureCollection[MessageType]" class="keyword">new</span> <a href="#9510" title="edu.berkeley.cs.scads.comm.FutureCollection[MessageType]">FutureCollection</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">(</span><a href="#28788" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">futures</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

case <span class="keyword">class</span> <a title="[MessageType &lt;: org.apache.avro.generic.IndexedRecord](x$0: edu.berkeley.cs.scads.comm.MessageFuture[MessageType])Option[(edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType], MessageType)]" id="31559">MessageFuture</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="31512">MessageType</a> &lt;: IndexedRecord<span class="delimiter">]</span><a href="#31559" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="31510">dest</a>: <a href="RemoteServiceProxy.scala.html#9558" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">RemoteServiceProxy</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="MessageType" id="31513">request</a>: <a href="#31512" title="MessageType">MessageType</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]" id="31516">registry</a>: <a href="ServiceRegistry.scala.html#9586" title="edu.berkeley.cs.scads.comm.ServiceRegistry[MessageType]">ServiceRegistry</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="scala.actors.Future[MessageType]">Future</span><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">protected</span><span class="delimiter">[</span>comm<span class="delimiter">]</span> <span class="keyword">val</span> <a title="scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]]" id="23159">sender</a> = <span title="scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]]" class="keyword">new</span> <span title="scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]]">SyncVar</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.concurrent.SyncVar[MessageType]" id="23161">message</a> = <span title="scala.concurrent.SyncVar[MessageType]" class="keyword">new</span> <span title="scala.concurrent.SyncVar[MessageType]">SyncVar</span><span class="delimiter">[</span>MessageType<span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]]" id="23164">forwardList</a>: <span title="List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]]">List</span><span class="delimiter">[</span>Queue<span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = List<span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]" id="23166">remoteService</a> = <span class="delimiter">(</span><a href="#31516" title="edu.berkeley.cs.scads.comm.FutureReference[MessageType]" class="keyword">new</a> <a href="#9504" title="edu.berkeley.cs.scads.comm.FutureReference[MessageType]">FutureReference</a><span class="delimiter">(</span><a href="#31559" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="#23235" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]">remoteService</a>

  <span class="comment">/* Note: doesn't really implement interface correctly */</span>
  <span class="keyword">def</span> <a title="=&gt; java.lang.Object with scala.actors.InputChannel[MessageType]{def ?(): MessageType}" id="23168">inputChannel</a> = <a href="#28918" title="java.lang.Object with scala.actors.InputChannel[MessageType]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with scala.actors.InputChannel[MessageType]" id="28918">InputChannel</a><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="()MessageType" id="28922">?</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#31512" title="MessageType">MessageType</a> = <a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; MessageType">get</span>
    <span class="keyword">def</span> <a title="(msec: Long)(pf: PartialFunction[Any,Unit])Nothing" id="28923">reactWithin</a><span class="delimiter">(</span><a title="Long" id="28932">msec</a>: <span title="Long">Long</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="PartialFunction[Any,Unit]" id="28933">pf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Nothing">Nothing</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(f: PartialFunction[MessageType,Unit])Nothing" id="28924">react</a><span class="delimiter">(</span><a title="PartialFunction[MessageType,Unit]" id="28935">f</a>: <span title="PartialFunction[MessageType,Unit]">PartialFunction</span><span class="delimiter">[</span>MessageType, Unit<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Nothing">Nothing</span> = <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unimplemented&quot;)" class="string">&quot;Unimplemented&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="[R](f: PartialFunction[MessageType,R])R" id="28925">receive</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="28927">R</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="PartialFunction[MessageType,R]" id="28938">f</a>: <span title="PartialFunction[MessageType,R]">PartialFunction</span><span class="delimiter">[</span>MessageType, R<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#28927" title="R">R</a> = <a href="#28938" title="(v1: MessageType)R">f</a><span class="delimiter">(</span><a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; MessageType">get</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="[R](msec: Long)(f: PartialFunction[Any,R])R" id="28928">receiveWithin</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="28930">R</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="Long" id="28945">msec</a>: <span title="Long">Long</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="PartialFunction[Any,R]" id="28946">f</a>: <span title="PartialFunction[Any,R]">PartialFunction</span><span class="delimiter">[</span>Any, R<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#28930" title="R">R</a> = <a href="#28946" title="(v1: Any)R">f</a><span class="delimiter">(</span><a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="(timeout: Long)Option[MessageType]">get</span><span class="delimiter">(</span><a href="#28945" title="Long">msec</a><span class="delimiter">)</span>.<span title="(default: =&gt; MessageType)MessageType">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;timeout&quot;)" class="string">&quot;timeout&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()MessageType" id="23169">apply</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; MessageType">get</span>

  <span class="comment">//The actual sender of a message</span>
  <span class="keyword">def</span> <a title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]" id="23170">source</a> =  <a href="#23159" title="=&gt; scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]]">sender</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">get</span>

  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="List[MessageType =&gt; Unit]" id="23172">respondFunctions</a>: <span title="List[MessageType =&gt; Unit]">List</span><span class="delimiter">[</span>MessageType =&gt; Unit<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
  <span class="keyword">def</span> <a title="(r: MessageType =&gt; Unit)Unit" id="23174">respond</a><span class="delimiter">(</span><a title="MessageType =&gt; Unit" id="29236">r</a>: MessageType =&gt; Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#31559" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; Boolean">isSet</span><span class="delimiter">)</span>
      <a href="#29236" title="(v1: MessageType)Unit">r</a><span class="delimiter">(</span><a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; MessageType">get</span><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#23172" title="(x$1: List[MessageType =&gt; Unit])Unit">respondFunctions</a> <span title="(x: MessageType =&gt; Unit)List[MessageType =&gt; Unit]">::=</span> <a href="#29236" title="MessageType =&gt; Unit">r</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()MessageType" id="23175">get</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#31512" title="MessageType">MessageType</a> = <a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; MessageType">get</span>

  <span class="keyword">def</span> <a title="(timeout: Long)Option[MessageType]" id="23176">get</a><span class="delimiter">(</span><a title="Long" id="31345">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Option[MessageType]">Option</span><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> =
    <a href="#23177" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[MessageType]">get</a><span class="delimiter">(</span><a href="#31345" title="Long">timeout</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[MessageType]" id="23177">get</a><span class="delimiter">(</span><a title="Long" id="31351">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="31352">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <span title="Option[MessageType]">Option</span><span class="delimiter">[</span>MessageType<span class="delimiter">]</span> =
    <a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="(timeout: Long)Option[MessageType]">get</span><span class="delimiter">(</span><a href="#31352" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#31351" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="23178">isSet</a>: <span title="Boolean">Boolean</span> = <a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; Boolean">isSet</span>

  <span class="comment">/**
   * Either forward the result to the following queue, or request that it be forwarded upon arrival.
   */</span>
  <span class="keyword">def</span> <a title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]])Unit" id="23179">forward</a><span class="delimiter">(</span><a title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]" id="31358">dest</a>: <span title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">Queue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#31559" title="(x$1: AnyVal)AnyVal">synchronized</a> <span title="Unit" class="delimiter">{</span>
    <span title="AnyVal" class="keyword">if</span><span class="delimiter">(</span><a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="=&gt; Boolean">isSet</span><span class="delimiter">)</span>
      <a href="#31358" title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">dest</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.MessageFuture[MessageType])Boolean">offer</span><span class="delimiter">(</span><a href="#31559" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]" class="keyword">this</a><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#23164" title="(x$1: List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]])Unit">forwardList</a> <span title="(x: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]])List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]]">::=</span> <a href="#31358" title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">dest</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]], msg: MessageType)Unit" id="23180">receiveMessage</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]" id="28774">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">Option</span><span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="MessageType" id="28775">msg</a>: <a href="#31512" title="MessageType">MessageType</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#31559" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <a href="#23161" title="=&gt; scala.concurrent.SyncVar[MessageType]">message</a>.<span title="(x: MessageType)Unit">set</span><span class="delimiter">(</span><a href="#28775" title="MessageType">msg</a><span class="delimiter">)</span>
    <a href="#23159" title="=&gt; scala.concurrent.SyncVar[Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]]">sender</a>.<span title="(x: Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]])Unit">set</span><span class="delimiter">(</span><a href="#28774" title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[MessageType]]">src</a><span class="delimiter">)</span>
    <a href="#23164" title="=&gt; List[java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]]">forwardList</a>.<span title="(f: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]] =&gt; Boolean)Unit">foreach</span><span class="delimiter">(</span><a href="#31444" title="java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">_</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.MessageFuture[MessageType])Boolean">offer</span><span class="delimiter">(</span><a href="#31559" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#23172" title="=&gt; List[MessageType =&gt; Unit]">respondFunctions</a>.<span title="(f: MessageType =&gt; Unit =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#31502" title="(v1: MessageType)Unit">_</a><span class="delimiter">(</span><a href="#28775" title="MessageType">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class FutureCollection[MessageType &lt;: org.apache.avro.generic.IndexedRecord] extends java.lang.Object with ScalaObject" id="9510">FutureCollection</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9511">MessageType</a> &lt;: IndexedRecord<span class="delimiter">]</span><a href="#9510" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]" id="28799">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]" id="28795">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span>
  <a href="#28799" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture[MessageType] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#31840" title="edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">_</a>.<a href="#23179" title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]])Unit">forward</a><span class="delimiter">(</span><a href="#28795" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]" id="28797">blockFor</a><span class="delimiter">(</span><a title="Int" id="31843">count</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#31843" title="Int">count</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.comm.MessageFuture[MessageType])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],edu.berkeley.cs.scads.comm.MessageFuture[MessageType],Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[MessageType],scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]]" class="delimiter">(</span><a title="Int" id="32534">_</a> =&gt; <a href="#28795" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">responses</a>.<span title="()edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">take</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]" id="28798">blockFor</a><span class="delimiter">(</span><a title="Int" id="32616">count</a>: <span title="Int">Int</span>, <a title="Long" id="32617">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="32618">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>MessageType<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#32616" title="Int">count</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; edu.berkeley.cs.scads.comm.MessageFuture[MessageType])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],edu.berkeley.cs.scads.comm.MessageFuture[MessageType],Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[MessageType],scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]]" class="delimiter">(</span><a title="Int" id="32719">_</a> =&gt; <span title="(x: edu.berkeley.cs.scads.comm.MessageFuture[MessageType])Option[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">Option</span><span class="delimiter">(</span><a href="#28795" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[MessageType]]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">poll</span><span class="delimiter">(</span><a href="#32617" title="Long">timeout</a>, <a href="#32618" title="java.util.concurrent.TimeUnit">unit</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.comm.MessageFuture[MessageType])edu.berkeley.cs.scads.comm.MessageFuture[MessageType]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;TIMEOUT &quot;)" class="string">&quot;TIMEOUT &quot;</span><span title="(x$1: Any)java.lang.String">+</span> <a href="#32617" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class FutureTimeoutException extends java.lang.RuntimeException with ScalaObject" id="9512">FutureTimeoutException</a> <a href="#9512" title="ScalaObject" class="keyword">extends</a> <span title="java.lang.RuntimeException">RuntimeException</span>
<span class="keyword">class</span> <a title="class FutureException extends java.lang.RuntimeException with ScalaObject" id="9513">FutureException</a><a href="#9513" title="ScalaObject" class="delimiter">(</a><a title="Throwable" id="32770">ex</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#32770" title="Throwable">ex</a><span class="delimiter">)</span>

<span class="comment">/**
 * Default synchronized-based implementation of ScadsFuture
 */</span>
<span class="keyword">class</span> <a title="class BlockingFuture[T] extends java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T] with ScalaObject" id="9514">BlockingFuture</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="9515">T</a><span class="delimiter">]</span> <a href="#9514" title="ScalaObject" class="keyword">extends</a> <a href="#9500" title="edu.berkeley.cs.scads.comm.ScadsFuture[T]">ScadsFuture</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Throwable" id="32778">ex</a>: <span title="Throwable">Throwable</span> = _
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="32781">done</a>          = <span title="Boolean(false)" class="keyword">false</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="T" id="32784">elem</a>: <a href="#9515" title="T">T</a>       = _

  <span class="keyword">def</span> <a title="()Unit" id="32786">cancel</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;UNIMPLEMENTED&quot;)" class="string">&quot;UNIMPLEMENTED&quot;</span><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="32787">isSet</a>: <span title="Boolean">Boolean</span> = <a href="#9514" title="(x$1: Boolean)Boolean">synchronized</a> <span class="delimiter">{</span> <a href="#32781" title="=&gt; Boolean">done</a> <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(timeout: Long)T" id="32788">await</a><span class="delimiter">(</span><a title="Long" id="32917">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <a href="#9515" title="T">T</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[T]" id="32919">opt</a> = <a href="#32791" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]">get</a><span class="delimiter">(</span><a href="#32917" title="Long">timeout</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
    <a href="#32919" title="Option[T]">opt</a>.<span title="(default: =&gt; T)T">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.comm.FutureTimeoutException" class="keyword">new</span> <a href="#9512" title="edu.berkeley.cs.scads.comm.FutureTimeoutException">FutureTimeoutException</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()T" id="32789">await</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9515" title="T">T</a> = <a href="#32788" title="(timeout: Long)T">await</a><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()T" id="32790">get</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#9515" title="T">T</a> = <a href="#32788" title="(timeout: Long)T">await</a><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]" id="32791">get</a><span class="delimiter">(</span><a title="Long" id="32922">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="32923">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <span title="Option[T]">Option</span><span class="delimiter">[</span>T<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#9514" title="(x$1: Option[T])Option[T]">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#32781" title="=&gt; Boolean">done</a><span class="delimiter">)</span>
        <a href="#9514" title="(x$1: Long)Unit">wait</a><span class="delimiter">(</span><a href="#32923" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#32922" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Option[T]" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#32781" title="=&gt; Boolean">done</a><span class="delimiter">)</span> <span title="object None">None</span>
      <span class="keyword">else</span> <span title="Option[T]" class="keyword">if</span> <span class="delimiter">(</span><a href="#32778" title="=&gt; Throwable">ex</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.comm.FutureException" class="keyword">new</span> <a href="#9513" title="edu.berkeley.cs.scads.comm.FutureException">FutureException</a><span class="delimiter">(</span><a href="#32778" title="=&gt; Throwable">ex</a><span class="delimiter">)</span>
      <span class="keyword">else</span> <span class="delimiter">{</span>
        <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#32784" title="=&gt; T">elem</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="AnyRef" class="delimiter">[</span><span title="AnyRef">AnyRef</span><span class="delimiter">]</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;Element cannot be null if done&quot;)" class="string">&quot;Element cannot be null if done&quot;</span><span class="delimiter">)</span>
        <span title="(x: T)Some[T]">Some</span><span class="delimiter">(</span><a href="#32784" title="=&gt; T">elem</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(e: T)Unit" id="32792">finish</a><span class="delimiter">(</span><a title="T" id="32956">e</a>: <a href="#9515" title="T">T</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#32956" title="T">e</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="AnyRef" class="delimiter">[</span><span title="AnyRef">AnyRef</span><span class="delimiter">]</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#9514" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#32781" title="=&gt; Boolean">done</a><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Future already done&quot;)" class="string">&quot;Future already done&quot;</span><span class="delimiter">)</span>
      <a href="#32781" title="(x$1: Boolean)Unit">done</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#32784" title="(x$1: T)Unit">elem</a> = <a href="#32956" title="T">e</a>
      <a href="#9514" title="()Unit">notifyAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(error: Throwable)Unit" id="32793">finishWithError</a><span class="delimiter">(</span><a title="Throwable" id="32976">error</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#32976" title="Throwable">error</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#9514" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#32781" title="=&gt; Boolean">done</a><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Future already done&quot;)" class="string">&quot;Future already done&quot;</span><span class="delimiter">)</span>
      <a href="#32781" title="(x$1: Boolean)Unit">done</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#32778" title="(x$1: Throwable)Unit">ex</a>   = <a href="#32976" title="Throwable">error</a>
      <a href="#9514" title="()Unit">notifyAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 *  Default future which wraps a computation in a future. This computation is allowed to fail. 
 *  The semantics are that if the computation fails (by throwing an exception), then calls to get() will also throw an
 *  exception. Otherwise, the value from the computation will be returned.
 *  Note that the computation does NOT start running until the first call to
 *  get() is invoked
 */</span>
<span class="keyword">trait</span> <a title="trait ComputationFuture[T] extends java.lang.Object with edu.berkeley.cs.scads.comm.ScadsFuture[T] with ScalaObject" id="9516">ComputationFuture</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="9517">T</a><span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="#9500" title="edu.berkeley.cs.scads.comm.ScadsFuture[T]">ScadsFuture</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">{</span>

  <span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean
  <span class="keyword">import</span> scala.concurrent.SyncVar

  <span class="comment">/**
   * The computation that should run with this future. Is guaranteed to only
   * be called at most once. Timeout hint is a hint for how long the user is
   * willing to wait for this computation to compute
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)T" id="32990">compute</a><span class="delimiter">(</span><a title="Long" id="33196">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="33197">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span>: <a href="#9517" title="T">T</a> 

  <span class="comment">/**
   * Signals a request to cancel the computation. Is guaranteed to only be
   * called at most once.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="32991">cancelComputation</a>: <span title="Unit">Unit</span>

  <span class="comment">/** Guard the computation from only running once */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicBoolean" id="32992">computeGuard</a> = <span title="java.util.concurrent.atomic.AtomicBoolean" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>

  <span class="comment">/** Guard the cancellation request from only being invoked once */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicBoolean" id="32994">cancelGuard</a> = <span title="java.util.concurrent.atomic.AtomicBoolean" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>

  <span class="comment">/** Store the result */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.concurrent.SyncVar[Either[T,Throwable]]" id="32996">syncVar</a> = <span title="scala.concurrent.SyncVar[Either[T,Throwable]]" class="keyword">new</span> <span title="scala.concurrent.SyncVar[Either[T,Throwable]]">SyncVar</span><span class="delimiter">[</span>Either<span class="delimiter">[</span>T, Throwable<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="()Unit" id="32998">cancel</a> = 
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#32994" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">cancelGuard</a>.<span title="(x$1: Boolean, x$2: Boolean)Boolean">compareAndSet</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> 
      <a href="#32991" title="=&gt; Unit">cancelComputation</a>

  <span class="keyword">def</span> <a title="()T" id="32999">get</a> = <a href="#33001" title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]">get</a><span class="delimiter">(</span>java.lang.Long.<span title="Long(9223372036854775807L)">MAX_VALUE</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>.<span title="=&gt; T">get</span> 

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(res: Either[T,Throwable])T" id="33000">dispatchResult</a><span class="delimiter">(</span><a title="Either[T,Throwable]" id="33300">res</a>: <span title="Either[T,Throwable]">Either</span><span class="delimiter">[</span>T, Throwable<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9517" title="T">T</a> = <a href="#33300" title="Either[T,Throwable]">res</a> <span title="T" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="T">Left</span><span class="delimiter">(</span><a title="T" id="33319">value</a><span class="delimiter">)</span> =&gt; <a href="#33319" title="T">value</a>
    <span class="keyword">case</span> <span title="Nothing">Right</span><span class="delimiter">(</span><a title="Throwable" id="33321">ex</a><span class="delimiter">)</span>   =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.Throwable)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#33321" title="Throwable">ex</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)Option[T]" id="33001">get</a><span class="delimiter">(</span><a title="Long" id="33210">timeout</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="33211">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = <span class="delimiter">{</span> 
    <span title="Option[T]" class="keyword">if</span> <span class="delimiter">(</span><a href="#32992" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">computeGuard</a>.<span title="(x$1: Boolean, x$2: Boolean)Boolean">compareAndSet</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// this is a bit of a hack now, since the computation blocks the current</span>
      <span class="comment">// thread. will have to move to a separate thread for true get semantics</span>
      <span class="keyword">try</span> <a href="#32996" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="(x: Either[T,Throwable])Unit">set</span><span class="delimiter">(</span><span title="(a: T)Left[T,Nothing]">Left</span><span class="delimiter">(</span><a href="#32990" title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)T">compute</a><span class="delimiter">(</span><a href="#33210" title="Long">timeout</a>, <a href="#33211" title="java.util.concurrent.TimeUnit">unit</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="33257">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="#32996" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="(x: Either[T,Throwable])Unit">set</span><span class="delimiter">(</span><span title="(b: java.lang.Throwable)Right[Nothing,java.lang.Throwable]">Right</span><span class="delimiter">(</span><a href="#33257" title="java.lang.Throwable">e</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span title="(x: T)Some[T]">Some</span><span class="delimiter">(</span><a href="#33000" title="(res: Either[T,Throwable])T">dispatchResult</a><span class="delimiter">(</span><a href="#32996" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="=&gt; Either[T,Throwable]">get</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// other thread beat us out to finishing the get handler- in this</span>
      <span class="comment">// case just wait on the sync var</span>
      <a href="#32996" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="(timeout: Long)Option[Either[T,Throwable]]">get</span><span class="delimiter">(</span><a href="#33211" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#33210" title="Long">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: Either[T,Throwable] =&gt; T)Option[T]">map</span><span class="delimiter">(</span><a href="#33000" title="(res: Either[T,Throwable])T">dispatchResult</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>   
  <span class="delimiter">}</span>   
  <span class="keyword">def</span> <a title="=&gt; Boolean" id="33002">isSet</a> = <a href="#32996" title="=&gt; scala.concurrent.SyncVar[Either[T,Throwable]]">syncVar</a>.<span title="=&gt; Boolean">isSet</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>