<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>netty/NettyChannelManager.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm
<span class="keyword">package</span> netty

<span class="keyword">import</span> java.net._
<span class="keyword">import</span> java.util.concurrent._

<span class="keyword">import</span> org.jboss.netty._
<span class="keyword">import</span> bootstrap._
<span class="keyword">import</span> channel._
<span class="keyword">import</span> handler.codec.frame._
<span class="keyword">import</span> socket.nio._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> org.apache.avro.specific.SpecificRecord

<span class="keyword">import</span> scala.reflect.<span title="object scala.reflect.Manifest">Manifest</span>.classType
<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> edu.berkeley.cs.scads.config._

<span class="comment">/**
 * Easier to instantiate via reflection
 */</span>
<span class="keyword">class</span> <a title="class DefaultNettyChannelManager[S &lt;: org.apache.avro.specific.SpecificRecord, R &lt;: org.apache.avro.specific.SpecificRecord] extends edu.berkeley.cs.scads.comm.netty.NettyChannelManager[S,R] with ScalaObject" id="9894">DefaultNettyChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9895">S</a> &lt;: SpecificRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9896">R</a> &lt;: SpecificRecord<span class="delimiter">]</span><a href="#9894" title="ScalaObject" class="delimiter">(</a>
    <a title="(edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], edu.berkeley.cs.scads.comm.RemoteNode, R) =&gt; Unit" id="56002">recvMsg</a>: <span class="delimiter">(</span>AvroChannelManager<span class="delimiter">[</span>S, R<span class="delimiter">]</span>, RemoteNode, R<span class="delimiter">)</span> =&gt; Unit, <a title="Class[S]" id="56003">sendClz</a>: <span title="Class[S]">Class</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="Class[R]" id="56004">recvClz</a>: <span title="Class[R]">Class</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <a href="#9897" title="edu.berkeley.cs.scads.comm.netty.NettyChannelManager[S,R]">NettyChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">(</span><span title="(clazz: Class[_])scala.reflect.Manifest[S]">classType</span><span class="delimiter">(</span><a href="#56003" title="Class[S]">sendClz</a><span class="delimiter">)</span>, <span title="(clazz: Class[_])scala.reflect.Manifest[R]">classType</span><span class="delimiter">(</span><a href="#56004" title="Class[R]">recvClz</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(remoteNode: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit" id="35669">receiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="56037">remoteNode</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="R" id="56038">msg</a>: <a href="#9896" title="R">R</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#56002" title="(v1: edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], v2: edu.berkeley.cs.scads.comm.RemoteNode, v3: R)Unit">recvMsg</a><span class="delimiter">(</span><a href="#9894" title="edu.berkeley.cs.scads.comm.netty.DefaultNettyChannelManager[S,R]" class="keyword">this</a>, <a href="#56037" title="edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#56038" title="R">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class NettyChannelManager[S &lt;: org.apache.avro.specific.SpecificRecord, R &lt;: org.apache.avro.specific.SpecificRecord] extends java.lang.Object with edu.berkeley.cs.scads.comm.AvroChannelManager[S,R] with ScalaObject" id="9897">NettyChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9898">S</a> &lt;: SpecificRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9899">R</a> &lt;: SpecificRecord<span class="delimiter">]</span><a href="#9897" title="ScalaObject" class="delimiter">(</a>
    <span class="keyword">implicit</span> <a title="Manifest[S]" id="56005">sendManifest</a>: <span title="Manifest[S]">Manifest</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="Manifest[R]" id="56006">recvManifest</a>: <span title="Manifest[R]">Manifest</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="../AvroChannelManager.scala.html#9509" title="edu.berkeley.cs.scads.comm.AvroChannelManager[S,R]">AvroChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span> <span class="delimiter">{</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="35637">log</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Boolean" id="35640">useTcpNoDelay</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>.<span title="(key: String, defaultValue: Boolean)Boolean">getBool</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.comm.tcpNoDelay&quot;)" class="string">&quot;scads.comm.tcpNoDelay&quot;</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: org.jboss.netty.channel.ChannelHandler)java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory{def getPipeline(): org.jboss.netty.channel.StaticChannelPipeline}" id="35641">pipelineFactory</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandler" id="56536">handler</a>: <span title="org.jboss.netty.channel.ChannelHandler">ChannelHandler</span><span class="delimiter">)</span> = <a href="#56539" title="java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory" id="56539">ChannelPipelineFactory</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()org.jboss.netty.channel.StaticChannelPipeline" id="56542">getPipeline</a><span class="delimiter">(</span><span class="delimiter">)</span> =
      <span title="org.jboss.netty.channel.StaticChannelPipeline" class="keyword">new</span> <span title="org.jboss.netty.channel.StaticChannelPipeline">StaticChannelPipeline</span><span class="delimiter">(</span>
        <span title="org.jboss.netty.handler.codec.frame.LengthFieldPrepender" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.frame.LengthFieldPrepender">LengthFieldPrepender</span><span class="delimiter">(</span><span title="Int(4)" class="int">4</span><span class="delimiter">)</span>,
        <span title="(x$1: Int, x$2: Int, x$3: Int, x$4: Int, x$5: Int)org.jboss.netty.handler.codec.frame.LengthFieldBasedFrameDecoder" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.frame.LengthFieldBasedFrameDecoder">LengthFieldBasedFrameDecoder</span><span class="delimiter">(</span><span title="Int(268435455)" class="int">0x0fffffff</span>, <span title="Int(0)" class="int">0</span>, <span title="Int(4)" class="int">4</span>, <span title="Int(0)" class="int">0</span>, <span title="Int(4)" class="int">4</span><span class="delimiter">)</span>,
        <a href="#56006" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificDecoder[R]" class="keyword">new</a> <a href="AvroSpecificDecoder.scala.html#9856" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificDecoder[R]">AvroSpecificDecoder</a><span class="delimiter">[</span>R<span class="delimiter">]</span>,
        <a href="#56005" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificEncoder[S]" class="keyword">new</a> <a href="AvroSpecificEncoder.scala.html#9872" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificEncoder[S]">AvroSpecificEncoder</a><span class="delimiter">[</span>S<span class="delimiter">]</span>,
        <a href="#56536" title="org.jboss.netty.channel.ChannelHandler">handler</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** TODO: configure thread pools */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.jboss.netty.bootstrap.ServerBootstrap" id="35642">serverBootstrap</a> = <span title="(x$1: org.jboss.netty.channel.ChannelFactory)org.jboss.netty.bootstrap.ServerBootstrap" class="keyword">new</span> <span title="org.jboss.netty.bootstrap.ServerBootstrap">ServerBootstrap</span><span class="delimiter">(</span>
    <span title="org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory" class="keyword">new</span> <span title="org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory">NioServerSocketChannelFactory</span><span class="delimiter">(</span>
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><span class="delimiter">)</span>,
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <a href="#35642" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: org.jboss.netty.channel.ChannelHandler)Unit">setParentHandler</span><span class="delimiter">(</span><span title="NettyChannelManager.this.NettyServerParentHandler" class="keyword">new</span> <a href="#35648" title="NettyChannelManager.this.NettyServerParentHandler">NettyServerParentHandler</a><span class="delimiter">)</span>
  <a href="#35642" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: org.jboss.netty.channel.ChannelPipelineFactory)Unit">setPipelineFactory</span><span class="delimiter">(</span><a href="#35641" title="(handler: org.jboss.netty.channel.ChannelHandler)java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory{def getPipeline(): org.jboss.netty.channel.StaticChannelPipeline}">pipelineFactory</a><span class="delimiter">(</span><span title="NettyChannelManager.this.NettyServerChildHandler" class="keyword">new</span> <a href="#35649" title="NettyChannelManager.this.NettyServerChildHandler">NettyServerChildHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <a href="#35642" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: java.lang.String, x$2: Any)Unit">setOption</span><span class="delimiter">(</span><span title="java.lang.String(&quot;child.tcpNoDelay&quot;)" class="string">&quot;child.tcpNoDelay&quot;</span>, <a href="#35639" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span> <span class="comment">// disable nagle's algorithm</span>

  <span class="comment">/** TODO: configure thread pools */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.jboss.netty.bootstrap.ClientBootstrap" id="35644">clientBootstrap</a> = <span title="(x$1: org.jboss.netty.channel.ChannelFactory)org.jboss.netty.bootstrap.ClientBootstrap" class="keyword">new</span> <span title="org.jboss.netty.bootstrap.ClientBootstrap">ClientBootstrap</span><span class="delimiter">(</span>
    <span title="org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory" class="keyword">new</span> <span title="org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory">NioClientSocketChannelFactory</span><span class="delimiter">(</span>
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><span class="delimiter">)</span>,
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <a href="#35644" title="=&gt; org.jboss.netty.bootstrap.ClientBootstrap">clientBootstrap</a>.<span title="(x$1: org.jboss.netty.channel.ChannelPipelineFactory)Unit">setPipelineFactory</span><span class="delimiter">(</span><a href="#35641" title="(handler: org.jboss.netty.channel.ChannelHandler)java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory{def getPipeline(): org.jboss.netty.channel.StaticChannelPipeline}">pipelineFactory</a><span class="delimiter">(</span><span title="NettyChannelManager.this.NettyClientHandler" class="keyword">new</span> <a href="#35650" title="NettyChannelManager.this.NettyClientHandler">NettyClientHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <a href="#35644" title="=&gt; org.jboss.netty.bootstrap.ClientBootstrap">clientBootstrap</a>.<span title="(x$1: java.lang.String, x$2: Any)Unit">setOption</span><span class="delimiter">(</span><span title="java.lang.String(&quot;tcpNoDelay&quot;)" class="string">&quot;tcpNoDelay&quot;</span>, <a href="#35639" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span> <span class="comment">// disable nagle's algorithm</span>

  <span class="keyword">class</span> <a title="class NettyBaseHandler extends org.jboss.netty.channel.SimpleChannelHandler with ScalaObject" id="35646">NettyBaseHandler</a> <a href="#35646" title="ScalaObject" class="keyword">extends</a> <span title="org.jboss.netty.channel.SimpleChannelHandler">SimpleChannelHandler</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ExceptionEvent)Unit" id="56942">exceptionCaught</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="56953">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ExceptionEvent" id="56954">e</a>: <span title="org.jboss.netty.channel.ExceptionEvent">ExceptionEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="56957">chan</a> = <a href="#56954" title="org.jboss.netty.channel.ExceptionEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>

      <a href="#56954" title="org.jboss.netty.channel.ExceptionEvent">e</a>.<span title="()java.lang.Throwable">getCause</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
	<span class="keyword">case</span> <a title="Unit" id="56960">exp</a>: java.net.<span title="java.net.BindException">BindException</span> =&gt;
	<span class="keyword">case</span> <a title="Unit" id="56961">exp</a> =&gt; <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(thrown: Throwable, msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><a href="#56961" title="java.lang.Throwable">exp</a>, <span title="java.lang.String(&quot;Exception in channel handler %s: %s&quot;)" class="string">&quot;Exception in channel handler %s: %s&quot;</span>, <a href="#56957" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#56954" title="org.jboss.netty.channel.ExceptionEvent">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#57238" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#56957" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="57274">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Removing channel %s to %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#56957" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#57274" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#57274" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#56957" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#56953" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#56954" title="org.jboss.netty.channel.ExceptionEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyChannelHandler extends NettyChannelManager.this.NettyBaseHandler with ScalaObject" id="35647">NettyChannelHandler</a> <a href="#35647" title="ScalaObject" class="keyword">extends</a> <a href="#35646" title="NettyChannelManager.this.NettyBaseHandler">NettyBaseHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.MessageEvent)Unit" id="56946">messageReceived</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="57313">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.MessageEvent" id="57314">e</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="R" id="57318">msg</a>  = <a href="#57314" title="org.jboss.netty.channel.MessageEvent">e</a>.<span title="()java.lang.Object">getMessage</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="R" class="delimiter">[</span><a href="#9899" title="R">R</a><span class="delimiter">]</span>
      <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="57319">node</a> = <a href="#57314" title="org.jboss.netty.channel.MessageEvent">e</a>.<span title="()java.net.SocketAddress">getRemoteAddress</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.net.InetSocketAddress" class="delimiter">[</span><span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">]</span>
      <a href="../AvroChannelManager.scala.html#14308" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit">receiveMessage</a><span class="delimiter">(</span><a href="../AvroChannelManager.scala.html#24024" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#57319" title="java.net.InetSocketAddress">node</a>.<span title="()java.lang.String">getHostName</span>, <a href="#57319" title="java.net.InetSocketAddress">node</a>.<span title="()Int">getPort</span><span class="delimiter">)</span>, <a href="#57318" title="R">msg</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyServerParentHandler extends NettyChannelManager.this.NettyBaseHandler with ScalaObject" id="35648">NettyServerParentHandler</a> <a href="#35648" title="ScalaObject" class="keyword">extends</a> <a href="#35646" title="NettyChannelManager.this.NettyBaseHandler">NettyBaseHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="56944">channelClosed</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="57325">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="57326">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="57330">chan</a> = <a href="#57326" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#57509" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#57330" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="57545">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Channel closed: %s, removing %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#57330" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#57545" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#57545" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#57325" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#57326" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyServerChildHandler extends NettyChannelManager.this.NettyChannelHandler with ScalaObject" id="35649">NettyServerChildHandler</a> <a href="#35649" title="ScalaObject" class="keyword">extends</a> <a href="#35647" title="NettyChannelManager.this.NettyChannelHandler">NettyChannelHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="56948">channelOpen</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="57555">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="57556">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="57558">chan</a> = <a href="#57556" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Received new connection from %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#57558" title="org.jboss.netty.channel.Channel">chan</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#57558" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.net.SocketAddress">getRemoteAddress</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">put</span><span class="delimiter">(</span><a href="#57558" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.net.SocketAddress">getRemoteAddress</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.net.InetSocketAddress" class="delimiter">[</span><span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">]</span>, <a href="#57558" title="org.jboss.netty.channel.Channel">chan</a><span class="delimiter">)</span>
      <a href="#57555" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#57556" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="56949">channelClosed</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="57578">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="57579">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="57581">chan</a> = <a href="#57579" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#57760" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#57581" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="57796">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Channel closed: %s, removing %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#57581" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#57796" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#57796" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#57578" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#57579" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyClientHandler extends NettyChannelManager.this.NettyChannelHandler with ScalaObject" id="35650">NettyClientHandler</a> <a href="#35650" title="ScalaObject" class="keyword">extends</a> <a href="#35647" title="NettyChannelManager.this.NettyChannelHandler">NettyChannelHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="56951">channelClosed</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="57806">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="57807">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="57809">chan</a> = <a href="#57807" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#57988" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#57809" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="58024">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Channel closed: %s, removing %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#57809" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#58024" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#58024" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#57806" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#57807" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// TODO: refactor commonality between this and OIO handler</span>

  <span class="comment">/** Used to manage open connections */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="35651">nodeToConnections</a> = 
    <span title="()java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">ConcurrentHashMap</span><span class="delimiter">[</span>InetSocketAddress, Channel<span class="delimiter">]</span>

  <span class="comment">/** Used to manage open ports */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]" id="35653">portToListeners</a> =
    <span title="()java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">ConcurrentHashMap</span><span class="delimiter">[</span>Int, Channel<span class="delimiter">]</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="35655">sendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="58033">dest</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="58034">msg</a>: <a href="#9898" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58038">conn</a> = <a href="#35657" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)org.jboss.netty.channel.Channel">getConnectionFor</a><span class="delimiter">(</span><a href="#58033" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <a href="#58038" title="org.jboss.netty.channel.Channel">conn</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span title="Unit" class="delimiter">(</span><a href="#58034" title="S">msg</a><span class="delimiter">)</span> <span class="comment">// encoding done in channel handlers</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="35656">sendMessageBulk</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="58068">dest</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="58069">msg</a>: <a href="#9898" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// TODO: implement me properly</span>
    <a href="#35655" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit">sendMessage</a><span class="delimiter">(</span><a href="#58068" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>, <a href="#58069" title="S">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)org.jboss.netty.channel.Channel" id="35657">getConnectionFor</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="58039">dest</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="58042">addr</a>  = <a href="#58039" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>.<a href="../AvroChannelManager.scala.html#24034" title="=&gt; java.net.InetSocketAddress">getInetSocketAddress</a>
    <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58043">conn0</a> = <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#58042" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
    <span title="org.jboss.netty.channel.Channel" class="keyword">if</span> <span class="delimiter">(</span><a href="#58043" title="org.jboss.netty.channel.Channel">conn0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#58043" title="org.jboss.netty.channel.Channel">conn0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">synchronized</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58046">test0</a> = <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#58042" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
        <span title="org.jboss.netty.channel.Channel" class="keyword">if</span> <span class="delimiter">(</span><a href="#58046" title="org.jboss.netty.channel.Channel">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#58046" title="org.jboss.netty.channel.Channel">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58047">newConn</a> = <a href="#35658" title="(addr: java.net.InetSocketAddress)org.jboss.netty.channel.Channel">connect</a><span class="delimiter">(</span><a href="#58042" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58048">ret</a> = <a href="#35651" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">put</span><span class="delimiter">(</span><a href="#58042" title="java.net.InetSocketAddress">addr</a>, <a href="#58047" title="org.jboss.netty.channel.Channel">newConn</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#58048" title="org.jboss.netty.channel.Channel">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new connection&quot;)" class="string">&quot;should not have overwritten a new connection&quot;</span><span class="delimiter">)</span>
          <a href="#58047" title="org.jboss.netty.channel.Channel">newConn</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(addr: java.net.InetSocketAddress)org.jboss.netty.channel.Channel" id="35658">connect</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="58049">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#58049" title="java.net.InetSocketAddress">addr</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;opening new connection to address: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#58049" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// open the connection in the current thread</span>
    <a href="#35644" title="=&gt; org.jboss.netty.bootstrap.ClientBootstrap">clientBootstrap</a>.<span title="(x$1: java.net.SocketAddress)org.jboss.netty.channel.ChannelFuture">connect</span><span class="delimiter">(</span><a href="#58049" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>.<span title="()org.jboss.netty.channel.ChannelFuture">awaitUninterruptibly</span>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="35659">flush</a> <span title="Unit" class="delimiter">{</span> <span class="comment">/* No-op */</span> <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(port: Int)Unit" id="35660">startListener</a><span class="delimiter">(</span><a title="Int" id="58075">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58075" title="Int">port</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">||</span> <a href="#58075" title="Int">port</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(65535)" class="int">65535</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid port: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#58075" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58077">list0</a> = <a href="#35653" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#58075" title="Int">port</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58077" title="org.jboss.netty.channel.Channel">list0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#58077" title="org.jboss.netty.channel.Channel">list0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#35653" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">synchronized</span> <span title="Unit" class="delimiter">{</span>
        <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58095">test0</a> = <a href="#35653" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#58075" title="Int">port</a><span class="delimiter">)</span>
        <span title="org.jboss.netty.channel.Channel" class="keyword">if</span> <span class="delimiter">(</span><a href="#58095" title="org.jboss.netty.channel.Channel">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#58095" title="org.jboss.netty.channel.Channel">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58096">newListener</a> = <a href="#35661" title="(port: Int)org.jboss.netty.channel.Channel">listen</a><span class="delimiter">(</span><a href="#58075" title="Int">port</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="58097">ret</a> = <a href="#35653" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: Int, x$2: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">put</span><span class="delimiter">(</span><a href="#58075" title="Int">port</a>, <a href="#58096" title="org.jboss.netty.channel.Channel">newListener</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#58097" title="org.jboss.netty.channel.Channel">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new listener&quot;)" class="string">&quot;should not have overwritten a new listener&quot;</span><span class="delimiter">)</span>
          <a href="#58096" title="org.jboss.netty.channel.Channel">newListener</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(port: Int)org.jboss.netty.channel.Channel" id="35661">listen</a><span class="delimiter">(</span><a title="Int" id="58098">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#35637" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;starting listener on port %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#58098" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#35642" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: java.net.SocketAddress)org.jboss.netty.channel.Channel">bind</span><span class="delimiter">(</span><span title="java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#58098" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>