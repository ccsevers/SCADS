<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>netty/NettyChannelManager.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm
<span class="keyword">package</span> netty

<span class="keyword">import</span> java.net._
<span class="keyword">import</span> java.util.concurrent._

<span class="keyword">import</span> org.jboss.netty._
<span class="keyword">import</span> bootstrap._
<span class="keyword">import</span> channel._
<span class="keyword">import</span> handler.codec.frame._
<span class="keyword">import</span> socket.nio._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> edu.berkeley.cs.scads.config._
<span class="keyword">import</span> edu.berkeley.cs.avro.runtime.TypedSchema
<span class="keyword">import</span> org.apache.avro.generic.IndexedRecord

<span class="comment">/**
 * Easier to instantiate via reflection
 */</span>
<span class="keyword">class</span> <a title="class DefaultNettyChannelManager[S &lt;: org.apache.avro.generic.IndexedRecord, R &lt;: org.apache.avro.generic.IndexedRecord] extends edu.berkeley.cs.scads.comm.netty.NettyChannelManager[S,R] with ScalaObject" id="9664">DefaultNettyChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9665">S</a> &lt;: IndexedRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9666">R</a> &lt;: IndexedRecord<span class="delimiter">]</span>
<a href="#9664" title="ScalaObject" class="delimiter">(</a><a title="(edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], edu.berkeley.cs.scads.comm.RemoteNode, R) =&gt; Unit" id="43376">recvMsg</a>: <span class="delimiter">(</span>AvroChannelManager<span class="delimiter">[</span>S, R<span class="delimiter">]</span>, RemoteNode, R<span class="delimiter">)</span> =&gt; Unit, <a title="java.lang.ClassLoader" id="43377">classLoader</a>: <span title="java.lang.ClassLoader">ClassLoader</span><span class="delimiter">)</span>
<span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[S]" id="43378">sendSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[S]">TypedSchema</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[R]" id="43379">receiveSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[R]">TypedSchema</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="#9669" title="edu.berkeley.cs.scads.comm.netty.NettyChannelManager[S,R]">NettyChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span><span class="delimiter">(</span><a href="#43377" title="java.lang.ClassLoader">classLoader</a><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(remoteNode: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit" id="40801">receiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="43387">remoteNode</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="R" id="43388">msg</a>: <a href="#9666" title="R">R</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#43376" title="(v1: edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], v2: edu.berkeley.cs.scads.comm.RemoteNode, v3: R)Unit">recvMsg</a><span class="delimiter">(</span><a href="#9664" title="edu.berkeley.cs.scads.comm.netty.DefaultNettyChannelManager[S,R]" class="keyword">this</a>, <a href="#43387" title="edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#43388" title="R">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.comm.netty.DaemonThreadFactory" id="9667">DaemonThreadFactory</a> <span title="ScalaObject" class="keyword">extends</span> <span title="java.util.concurrent.ThreadFactory">ThreadFactory</span> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(r: java.lang.Runnable)java.lang.Thread" id="43396">newThread</a><span class="delimiter">(</span><a title="java.lang.Runnable" id="43398">r</a>: <span title="java.lang.Runnable">Runnable</span><span class="delimiter">)</span>: <span title="java.lang.Thread">Thread</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.Thread" id="43400">thread</a> = <span title="(x$1: java.lang.Runnable)java.lang.Thread" class="keyword">new</span> <span title="java.lang.Thread">Thread</span><span class="delimiter">(</span><a href="#43398" title="java.lang.Runnable">r</a><span class="delimiter">)</span>
    <a href="#43400" title="java.lang.Thread">thread</a>.<span title="(x$1: Boolean)Unit">setDaemon</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#43400" title="java.lang.Thread">thread</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class NettyChannelManager[S &lt;: org.apache.avro.generic.IndexedRecord, R &lt;: org.apache.avro.generic.IndexedRecord] extends java.lang.Object with edu.berkeley.cs.scads.comm.AvroChannelManager[S,R] with ScalaObject" id="9669">NettyChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9670">S</a> &lt;: IndexedRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9671">R</a> &lt;: IndexedRecord<span class="delimiter">]</span>
<a href="#9669" title="ScalaObject" class="delimiter">(</a><a title="java.lang.ClassLoader" id="43380">classLoader</a>: <span title="java.lang.ClassLoader">ClassLoader</span><span class="delimiter">)</span>
<span class="delimiter">(</span><span class="keyword">implicit</span> <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[S]" id="43381">sendSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[S]">TypedSchema</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[R]" id="43382">receiveSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[R]">TypedSchema</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="../AvroChannelManager.scala.html#9478" title="edu.berkeley.cs.scads.comm.AvroChannelManager[S,R]">AvroChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span> <span class="delimiter">{</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="40767">log</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Boolean" id="40770">useTcpNoDelay</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>.<span title="(key: String, defaultValue: Boolean)Boolean">getBool</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.comm.tcpNoDelay&quot;)" class="string">&quot;scads.comm.tcpNoDelay&quot;</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: org.jboss.netty.channel.ChannelHandler)java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory{def getPipeline(): org.jboss.netty.channel.StaticChannelPipeline}" id="40771">pipelineFactory</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandler" id="43896">handler</a>: <span title="org.jboss.netty.channel.ChannelHandler">ChannelHandler</span><span class="delimiter">)</span> = <a href="#43899" title="java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory" id="43899">ChannelPipelineFactory</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()org.jboss.netty.channel.StaticChannelPipeline" id="43902">getPipeline</a><span class="delimiter">(</span><span class="delimiter">)</span> =
      <span title="org.jboss.netty.channel.StaticChannelPipeline" class="keyword">new</span> <span title="org.jboss.netty.channel.StaticChannelPipeline">StaticChannelPipeline</span><span class="delimiter">(</span>
        <span title="org.jboss.netty.handler.codec.frame.LengthFieldPrepender" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.frame.LengthFieldPrepender">LengthFieldPrepender</span><span class="delimiter">(</span><span title="Int(4)" class="int">4</span><span class="delimiter">)</span>,
        <span title="(x$1: Int, x$2: Int, x$3: Int, x$4: Int, x$5: Int)org.jboss.netty.handler.codec.frame.LengthFieldBasedFrameDecoder" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.frame.LengthFieldBasedFrameDecoder">LengthFieldBasedFrameDecoder</span><span class="delimiter">(</span><span title="Int(268435455)" class="int">0x0fffffff</span>, <span title="Int(0)" class="int">0</span>, <span title="Int(4)" class="int">4</span>, <span title="Int(0)" class="int">0</span>, <span title="Int(4)" class="int">4</span><span class="delimiter">)</span>,
        <a href="#43382" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificDecoder[R]" class="keyword">new</a> <a href="AvroSpecificDecoder.scala.html#9624" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificDecoder[R]">AvroSpecificDecoder</a><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">(</span><a href="#43380" title="java.lang.ClassLoader">classLoader</a><span class="delimiter">)</span>,
        <a href="#43381" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificEncoder[S]" class="keyword">new</a> <a href="AvroSpecificEncoder.scala.html#9642" title="edu.berkeley.cs.scads.comm.netty.AvroSpecificEncoder[S]">AvroSpecificEncoder</a><span class="delimiter">[</span>S<span class="delimiter">]</span>,
        <a href="#43896" title="org.jboss.netty.channel.ChannelHandler">handler</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**TODO: configure thread pools */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.jboss.netty.bootstrap.ServerBootstrap" id="40772">serverBootstrap</a> = <span title="(x$1: org.jboss.netty.channel.ChannelFactory)org.jboss.netty.bootstrap.ServerBootstrap" class="keyword">new</span> <span title="org.jboss.netty.bootstrap.ServerBootstrap">ServerBootstrap</span><span class="delimiter">(</span>
    <span title="org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory" class="keyword">new</span> <span title="org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory">NioServerSocketChannelFactory</span><span class="delimiter">(</span>
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="(x$1: java.util.concurrent.ThreadFactory)java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><a href="#9667" title="object edu.berkeley.cs.scads.comm.netty.DaemonThreadFactory">DaemonThreadFactory</a><span class="delimiter">)</span>,
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="(x$1: java.util.concurrent.ThreadFactory)java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><a href="#9667" title="object edu.berkeley.cs.scads.comm.netty.DaemonThreadFactory">DaemonThreadFactory</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <a href="#40772" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: org.jboss.netty.channel.ChannelHandler)Unit">setParentHandler</span><span class="delimiter">(</span><span title="NettyChannelManager.this.NettyServerParentHandler" class="keyword">new</span> <a href="#40778" title="NettyChannelManager.this.NettyServerParentHandler">NettyServerParentHandler</a><span class="delimiter">)</span>
  <a href="#40772" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: org.jboss.netty.channel.ChannelPipelineFactory)Unit">setPipelineFactory</span><span class="delimiter">(</span><a href="#40771" title="(handler: org.jboss.netty.channel.ChannelHandler)java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory{def getPipeline(): org.jboss.netty.channel.StaticChannelPipeline}">pipelineFactory</a><span class="delimiter">(</span><span title="NettyChannelManager.this.NettyServerChildHandler" class="keyword">new</span> <a href="#40779" title="NettyChannelManager.this.NettyServerChildHandler">NettyServerChildHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <a href="#40772" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: java.lang.String, x$2: Any)Unit">setOption</span><span class="delimiter">(</span><span title="java.lang.String(&quot;child.tcpNoDelay&quot;)" class="string">&quot;child.tcpNoDelay&quot;</span>, <a href="#40769" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span>
  <span class="comment">// disable nagle's algorithm</span>

  <span class="comment">/**TODO: configure thread pools */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.jboss.netty.bootstrap.ClientBootstrap" id="40774">clientBootstrap</a> = <span title="(x$1: org.jboss.netty.channel.ChannelFactory)org.jboss.netty.bootstrap.ClientBootstrap" class="keyword">new</span> <span title="org.jboss.netty.bootstrap.ClientBootstrap">ClientBootstrap</span><span class="delimiter">(</span>
    <span title="org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory" class="keyword">new</span> <span title="org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory">NioClientSocketChannelFactory</span><span class="delimiter">(</span>
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="(x$1: java.util.concurrent.ThreadFactory)java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><a href="#9667" title="object edu.berkeley.cs.scads.comm.netty.DaemonThreadFactory">DaemonThreadFactory</a><span class="delimiter">)</span>,
      <span title="object java.util.concurrent.Executors">Executors</span>.<span title="(x$1: java.util.concurrent.ThreadFactory)java.util.concurrent.ExecutorService">newCachedThreadPool</span><span class="delimiter">(</span><a href="#9667" title="object edu.berkeley.cs.scads.comm.netty.DaemonThreadFactory">DaemonThreadFactory</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <a href="#40774" title="=&gt; org.jboss.netty.bootstrap.ClientBootstrap">clientBootstrap</a>.<span title="(x$1: org.jboss.netty.channel.ChannelPipelineFactory)Unit">setPipelineFactory</span><span class="delimiter">(</span><a href="#40771" title="(handler: org.jboss.netty.channel.ChannelHandler)java.lang.Object with org.jboss.netty.channel.ChannelPipelineFactory{def getPipeline(): org.jboss.netty.channel.StaticChannelPipeline}">pipelineFactory</a><span class="delimiter">(</span><span title="NettyChannelManager.this.NettyClientHandler" class="keyword">new</span> <a href="#40780" title="NettyChannelManager.this.NettyClientHandler">NettyClientHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <a href="#40774" title="=&gt; org.jboss.netty.bootstrap.ClientBootstrap">clientBootstrap</a>.<span title="(x$1: java.lang.String, x$2: Any)Unit">setOption</span><span class="delimiter">(</span><span title="java.lang.String(&quot;tcpNoDelay&quot;)" class="string">&quot;tcpNoDelay&quot;</span>, <a href="#40769" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span>

  <span class="comment">// disable nagle's algorithm</span>

  <span class="keyword">class</span> <a title="class NettyBaseHandler extends org.jboss.netty.channel.SimpleChannelHandler with ScalaObject" id="40776">NettyBaseHandler</a> <a href="#40776" title="ScalaObject" class="keyword">extends</a> <span title="org.jboss.netty.channel.SimpleChannelHandler">SimpleChannelHandler</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ExceptionEvent)Unit" id="44302">exceptionCaught</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="44313">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ExceptionEvent" id="44314">e</a>: <span title="org.jboss.netty.channel.ExceptionEvent">ExceptionEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="44317">chan</a> = <a href="#44314" title="org.jboss.netty.channel.ExceptionEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>

      <a href="#44314" title="org.jboss.netty.channel.ExceptionEvent">e</a>.<span title="()java.lang.Throwable">getCause</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="44320">exp</a>: java.net.<span title="java.net.BindException">BindException</span> =&gt;
        <span class="keyword">case</span> <a title="Unit" id="44336">exp</a> =&gt; <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(thrown: Throwable, msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><a href="#44336" title="java.lang.Throwable">exp</a>, <span title="java.lang.String(&quot;Exception in channel handler %s: %s&quot;)" class="string">&quot;Exception in channel handler %s: %s&quot;</span>, <a href="#44317" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#44314" title="org.jboss.netty.channel.ExceptionEvent">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#44670" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#44317" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="44706">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Removing channel %s to %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#44317" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#44706" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#44706" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#44317" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#44313" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#44314" title="org.jboss.netty.channel.ExceptionEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyChannelHandler extends NettyChannelManager.this.NettyBaseHandler with ScalaObject" id="40777">NettyChannelHandler</a> <a href="#40777" title="ScalaObject" class="keyword">extends</a> <a href="#40776" title="NettyChannelManager.this.NettyBaseHandler">NettyBaseHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.MessageEvent)Unit" id="44306">messageReceived</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="44745">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.MessageEvent" id="44746">e</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="R" id="44750">msg</a> = <a href="#44746" title="org.jboss.netty.channel.MessageEvent">e</a>.<span title="()java.lang.Object">getMessage</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="R" class="delimiter">[</span><a href="#9671" title="R">R</a><span class="delimiter">]</span>
      <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="44751">node</a> = <a href="#44746" title="org.jboss.netty.channel.MessageEvent">e</a>.<span title="()java.net.SocketAddress">getRemoteAddress</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.net.InetSocketAddress" class="delimiter">[</span><span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">]</span>
      <a href="../AvroChannelManager.scala.html#21016" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit">receiveMessage</a><span class="delimiter">(</span><a href="../AvroChannelManager.scala.html#20827" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#44751" title="java.net.InetSocketAddress">node</a>.<span title="()java.lang.String">getHostName</span>, <a href="#44751" title="java.net.InetSocketAddress">node</a>.<span title="()Int">getPort</span><span class="delimiter">)</span>, <a href="#44750" title="R">msg</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyServerParentHandler extends NettyChannelManager.this.NettyBaseHandler with ScalaObject" id="40778">NettyServerParentHandler</a> <a href="#40778" title="ScalaObject" class="keyword">extends</a> <a href="#40776" title="NettyChannelManager.this.NettyBaseHandler">NettyBaseHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="44304">channelClosed</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="44757">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="44758">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="44762">chan</a> = <a href="#44758" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#44941" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#44762" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="44977">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Channel closed: %s, removing %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#44762" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#44977" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#44977" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#44757" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#44758" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyServerChildHandler extends NettyChannelManager.this.NettyChannelHandler with ScalaObject" id="40779">NettyServerChildHandler</a> <a href="#40779" title="ScalaObject" class="keyword">extends</a> <a href="#40777" title="NettyChannelManager.this.NettyChannelHandler">NettyChannelHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="44308">channelOpen</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="44987">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="44988">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="44990">chan</a> = <a href="#44988" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Received new connection from %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#44990" title="org.jboss.netty.channel.Channel">chan</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#44990" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.net.SocketAddress">getRemoteAddress</span> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">put</span><span class="delimiter">(</span><a href="#44990" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.net.SocketAddress">getRemoteAddress</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.net.InetSocketAddress" class="delimiter">[</span><span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">]</span>, <a href="#44990" title="org.jboss.netty.channel.Channel">chan</a><span class="delimiter">)</span>
      <a href="#44987" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#44988" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="44309">channelClosed</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="45010">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="45011">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45013">chan</a> = <a href="#45011" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#45192" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#45013" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="45228">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Channel closed: %s, removing %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#45013" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#45228" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#45228" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#45010" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#45011" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class NettyClientHandler extends NettyChannelManager.this.NettyChannelHandler with ScalaObject" id="40780">NettyClientHandler</a> <a href="#40780" title="ScalaObject" class="keyword">extends</a> <a href="#40777" title="NettyChannelManager.this.NettyChannelHandler">NettyChannelHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, e: org.jboss.netty.channel.ChannelStateEvent)Unit" id="44311">channelClosed</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="45238">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ChannelStateEvent" id="45239">e</a>: <span title="org.jboss.netty.channel.ChannelStateEvent">ChannelStateEvent</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45241">chan</a> = <a href="#45239" title="org.jboss.netty.channel.ChannelStateEvent">e</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
      <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(s: java.util.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]])scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">entrySet</span>.<span title="(p: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; Boolean)scala.collection.mutable.Set[java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]]">filter</span><span class="delimiter">(</span><a href="#45420" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">_</a>.<span title="()org.jboss.netty.channel.Channel">getValue</span>.<span title="()java.lang.Integer">getId</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#45241" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()java.lang.Integer">getId</span><span class="delimiter">)</span>.<span title="(f: java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel] =&gt; org.jboss.netty.channel.Channel)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="45456">addr</a> =&gt; <span class="delimiter">{</span>
        <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Channel closed: %s, removing %s from connection pool&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#45241" title="org.jboss.netty.channel.Channel">chan</a>, <a href="#45456" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">remove</span><span class="delimiter">(</span><a href="#45456" title="java.util.Map.Entry[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">addr</a>.<span title="()java.net.InetSocketAddress">getKey</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="#45238" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendUpstream</span><span class="delimiter">(</span><a href="#45239" title="org.jboss.netty.channel.ChannelStateEvent">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// TODO: refactor commonality between this and OIO handler</span>

  <span class="comment">/**Used to manage open connections */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" id="40781">nodeToConnections</a> =
    <span title="()java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">ConcurrentHashMap</span><span class="delimiter">[</span>InetSocketAddress, Channel<span class="delimiter">]</span>

  <span class="comment">/**Used to manage open ports */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]" id="40783">portToListeners</a> =
    <span title="()java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">ConcurrentHashMap</span><span class="delimiter">[</span>Int, Channel<span class="delimiter">]</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="40785">sendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="45465">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="45466">msg</a>: <a href="#9670" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45470">conn</a> = <a href="#40787" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)org.jboss.netty.channel.Channel">getConnectionFor</a><span class="delimiter">(</span><a href="#45465" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <a href="#45470" title="org.jboss.netty.channel.Channel">conn</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span title="Unit" class="delimiter">(</span><a href="#45466" title="S">msg</a><span class="delimiter">)</span> <span class="comment">// encoding done in channel handlers</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="40786">sendMessageBulk</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="45500">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="45501">msg</a>: <a href="#9670" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// TODO: implement me properly</span>
    <a href="#40785" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit">sendMessage</a><span class="delimiter">(</span><a href="#45500" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>, <a href="#45501" title="S">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)org.jboss.netty.channel.Channel" id="40787">getConnectionFor</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="45471">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="45474">addr</a> = <a href="#45471" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>.<a href="../AvroChannelManager.scala.html#10353" title="=&gt; java.net.InetSocketAddress">getInetSocketAddress</a>
    <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45475">conn0</a> = <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#45474" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
    <span title="org.jboss.netty.channel.Channel" class="keyword">if</span> <span class="delimiter">(</span><a href="#45475" title="org.jboss.netty.channel.Channel">conn0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45475" title="org.jboss.netty.channel.Channel">conn0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">synchronized</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45478">test0</a> = <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#45474" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
        <span title="org.jboss.netty.channel.Channel" class="keyword">if</span> <span class="delimiter">(</span><a href="#45478" title="org.jboss.netty.channel.Channel">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45478" title="org.jboss.netty.channel.Channel">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45479">newConn</a> = <a href="#40788" title="(addr: java.net.InetSocketAddress)org.jboss.netty.channel.Channel">connect</a><span class="delimiter">(</span><a href="#45474" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45480">ret</a> = <a href="#40781" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,org.jboss.netty.channel.Channel]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">put</span><span class="delimiter">(</span><a href="#45474" title="java.net.InetSocketAddress">addr</a>, <a href="#45479" title="org.jboss.netty.channel.Channel">newConn</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#45480" title="org.jboss.netty.channel.Channel">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new connection&quot;)" class="string">&quot;should not have overwritten a new connection&quot;</span><span class="delimiter">)</span>
          <a href="#45479" title="org.jboss.netty.channel.Channel">newConn</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(addr: java.net.InetSocketAddress)org.jboss.netty.channel.Channel" id="40788">connect</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="45481">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#45481" title="java.net.InetSocketAddress">addr</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;opening new connection to address: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#45481" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// open the connection in the current thread</span>
    <a href="#40774" title="=&gt; org.jboss.netty.bootstrap.ClientBootstrap">clientBootstrap</a>.<span title="(x$1: java.net.SocketAddress)org.jboss.netty.channel.ChannelFuture">connect</span><span class="delimiter">(</span><a href="#45481" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>.<span title="()org.jboss.netty.channel.ChannelFuture">awaitUninterruptibly</span>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="40789">flush</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">/* No-op */</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(port: Int)Unit" id="40790">startListener</a><span class="delimiter">(</span><a title="Int" id="45507">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#45507" title="Int">port</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">||</span> <a href="#45507" title="Int">port</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(65535)" class="int">65535</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid port: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#45507" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45509">list0</a> = <a href="#40783" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#45507" title="Int">port</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#45509" title="org.jboss.netty.channel.Channel">list0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45509" title="org.jboss.netty.channel.Channel">list0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#40783" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">synchronized</span> <span title="Unit" class="delimiter">{</span>
        <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45527">test0</a> = <a href="#40783" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: Any)org.jboss.netty.channel.Channel">get</span><span class="delimiter">(</span><a href="#45507" title="Int">port</a><span class="delimiter">)</span>
        <span title="org.jboss.netty.channel.Channel" class="keyword">if</span> <span class="delimiter">(</span><a href="#45527" title="org.jboss.netty.channel.Channel">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45527" title="org.jboss.netty.channel.Channel">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45528">newListener</a> = <a href="#40791" title="(port: Int)org.jboss.netty.channel.Channel">listen</a><span class="delimiter">(</span><a href="#45507" title="Int">port</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="45529">ret</a> = <a href="#40783" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,org.jboss.netty.channel.Channel]">portToListeners</a>.<span title="(x$1: Int, x$2: org.jboss.netty.channel.Channel)org.jboss.netty.channel.Channel">put</span><span class="delimiter">(</span><a href="#45507" title="Int">port</a>, <a href="#45528" title="org.jboss.netty.channel.Channel">newListener</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#45529" title="org.jboss.netty.channel.Channel">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new listener&quot;)" class="string">&quot;should not have overwritten a new listener&quot;</span><span class="delimiter">)</span>
          <a href="#45528" title="org.jboss.netty.channel.Channel">newListener</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(port: Int)org.jboss.netty.channel.Channel" id="40791">listen</a><span class="delimiter">(</span><a title="Int" id="45530">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#40767" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;starting listener on port %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#45530" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#40772" title="=&gt; org.jboss.netty.bootstrap.ServerBootstrap">serverBootstrap</a>.<span title="(x$1: java.net.SocketAddress)org.jboss.netty.channel.Channel">bind</span><span class="delimiter">(</span><span title="java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#45530" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>