<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>nio/avro.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> java.net.<span class="delimiter">{</span>InetSocketAddress, InetAddress<span class="delimiter">}</span>

<span class="keyword">import</span> java.io.ByteArrayOutputStream
<span class="keyword">import</span> java.nio.ByteBuffer
<span class="keyword">import</span> java.nio.channels.<span class="delimiter">{</span>SocketChannel,NotYetConnectedException<span class="delimiter">}</span>

<span class="keyword">import</span> java.util.HashMap
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> java.util.concurrent.Executor

<span class="keyword">import</span> org.apache.avro.io._
<span class="keyword">import</span> org.apache.avro.specific._
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> scala.reflect.<span title="object scala.reflect.Manifest">Manifest</span>.classType

<span class="comment">/**
 * Easier to instantiate via reflection
 */</span>
<span class="keyword">class</span> <a title="class DefaultNioChannelManager[S &lt;: org.apache.avro.specific.SpecificRecord, R &lt;: org.apache.avro.specific.SpecificRecord] extends edu.berkeley.cs.scads.comm.NioAvroChannelManagerBase[S,R] with ScalaObject" id="9940">DefaultNioChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9941">S</a> &lt;: SpecificRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9942">R</a> &lt;: SpecificRecord<span class="delimiter">]</span><a href="#9940" title="ScalaObject" class="delimiter">(</a>
    <a title="(edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], edu.berkeley.cs.scads.comm.RemoteNode, R) =&gt; Unit" id="36572">recvMsg</a>: <span class="delimiter">(</span>AvroChannelManager<span class="delimiter">[</span>S, R<span class="delimiter">]</span>, RemoteNode, R<span class="delimiter">)</span> =&gt; Unit, <a title="Class[S]" id="36573">sendClz</a>: <span title="Class[S]">Class</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="Class[R]" id="36574">recvClz</a>: <span title="Class[R]">Class</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <a href="#9943" title="edu.berkeley.cs.scads.comm.NioAvroChannelManagerBase[S,R]">NioAvroChannelManagerBase</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">(</span><span title="(clazz: Class[_])scala.reflect.Manifest[S]">classType</span><span class="delimiter">(</span><a href="#36573" title="Class[S]">sendClz</a><span class="delimiter">)</span>, <span title="(clazz: Class[_])scala.reflect.Manifest[R]">classType</span><span class="delimiter">(</span><a href="#36574" title="Class[R]">recvClz</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(remoteNode: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit" id="36571">receiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="61202">remoteNode</a>: <a href="../AvroChannelManager.scala.html#9508" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="R" id="61203">msg</a>: <a href="#9942" title="R">R</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#36572" title="(v1: edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], v2: edu.berkeley.cs.scads.comm.RemoteNode, v3: R)Unit">recvMsg</a><span class="delimiter">(</span><a href="#9940" title="edu.berkeley.cs.scads.comm.DefaultNioChannelManager[S,R]" class="keyword">this</a>, <a href="#61202" title="edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#61203" title="R">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class NioAvroChannelManagerBase[SendMsgType &lt;: org.apache.avro.specific.SpecificRecord, RecvMsgType &lt;: org.apache.avro.specific.SpecificRecord] extends java.lang.Object with edu.berkeley.cs.scads.comm.AvroChannelManager[SendMsgType,RecvMsgType] with edu.berkeley.cs.scads.comm.ChannelHandler with ScalaObject" id="9943">NioAvroChannelManagerBase</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9944">SendMsgType</a> &lt;: SpecificRecord,<a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9945">RecvMsgType</a> &lt;: SpecificRecord<span class="delimiter">]</span>
<a href="#9943" title="ScalaObject" class="delimiter">(</a><span class="keyword">implicit</span> <a title="scala.reflect.Manifest[SendMsgType]" id="28366">sendManifest</a>: scala.reflect.<span title="scala.reflect.Manifest[SendMsgType]">Manifest</span><span class="delimiter">[</span>SendMsgType<span class="delimiter">]</span>,
<a title="scala.reflect.Manifest[RecvMsgType]" id="28367">recvManifest</a>: scala.reflect.<span title="scala.reflect.Manifest[RecvMsgType]">Manifest</span><span class="delimiter">[</span>RecvMsgType<span class="delimiter">]</span><span class="delimiter">)</span>
<span class="keyword">extends</span> <a href="../AvroChannelManager.scala.html#9511" title="edu.berkeley.cs.scads.comm.AvroChannelManager[SendMsgType,RecvMsgType]">AvroChannelManager</a><span class="delimiter">[</span>SendMsgType, RecvMsgType<span class="delimiter">]</span> <span class="keyword">with</span> <a href="interfaces.scala.html#9951" title="edu.berkeley.cs.scads.comm.ChannelHandler">ChannelHandler</a> <span class="delimiter">{</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="28211">logger</a>: <span title="net.lag.logging.Logger">Logger</span> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Class[RecvMsgType]" id="28213">msgRecvClass</a> = <a href="#28367" title="scala.reflect.Manifest[RecvMsgType]">recvManifest</a>.<span title="=&gt; java.lang.Class[_]">erasure</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[RecvMsgType]" class="delimiter">[</span><span title="Class[RecvMsgType]">Class</span><span class="delimiter">[</span>RecvMsgType<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Class[SendMsgType]" id="28215">msgSendClass</a> = <a href="#28366" title="scala.reflect.Manifest[SendMsgType]">sendManifest</a>.<span title="=&gt; java.lang.Class[_]">erasure</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[SendMsgType]" class="delimiter">[</span><span title="Class[SendMsgType]">Class</span><span class="delimiter">[</span>SendMsgType<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumReader[RecvMsgType]" id="28217">msgReader</a> = <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumReader[RecvMsgType]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumReader[RecvMsgType]">SpecificDatumReader</span><span class="delimiter">[</span>RecvMsgType<span class="delimiter">]</span><span class="delimiter">(</span><a href="#28213" title="=&gt; Class[RecvMsgType]">msgRecvClass</a>.<span title="()RecvMsgType">newInstance</span>.<span title="()org.apache.avro.Schema">getSchema</span><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumWriter[SendMsgType]" id="28219">msgWriter</a> = <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumWriter[SendMsgType]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumWriter[SendMsgType]">SpecificDatumWriter</span><span class="delimiter">[</span>SendMsgType<span class="delimiter">]</span><span class="delimiter">(</span><a href="#28215" title="=&gt; Class[SendMsgType]">msgSendClass</a>.<span title="()SendMsgType">newInstance</span>.<span title="()org.apache.avro.Schema">getSchema</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.NioEndpoint" id="28221">endpoint</a>: <a href="AbstractNioEndpoint.scala.html#9921" title="edu.berkeley.cs.scads.comm.NioEndpoint">NioEndpoint</a> = <span title="edu.berkeley.cs.scads.comm.NioEndpoint" class="keyword">new</span> <a href="AbstractNioEndpoint.scala.html#9921" title="edu.berkeley.cs.scads.comm.NioEndpoint">NioEndpoint</a><span class="delimiter">(</span><a href="#9943" title="edu.berkeley.cs.scads.comm.NioAvroChannelManagerBase[SendMsgType,RecvMsgType]" class="keyword">this</a><span class="delimiter">)</span>
  <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58147" title="(x$1: edu.berkeley.cs.scads.comm.NioAcceptEventHandler)Unit">acceptEventHandler</a> = <a href="#61421" title="java.lang.Object with edu.berkeley.cs.scads.comm.NioAcceptEventHandler" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.NioAcceptEventHandler" id="61421">NioAcceptEventHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(channel: java.nio.channels.SocketChannel)Unit" id="61425">acceptEvent</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="61426">channel</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#28225" title="(channel: java.nio.channels.SocketChannel)edu.berkeley.cs.scads.comm.RemoteNode">registerReverseMap</a><span title="Unit" class="delimiter">(</span><a href="#61426" title="java.nio.channels.SocketChannel">channel</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58150" title="(x$1: edu.berkeley.cs.scads.comm.NioConnectEventHandler)Unit">connectEventHandler</a> = <a href="#61443" title="java.lang.Object with edu.berkeley.cs.scads.comm.NioConnectEventHandler" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.NioConnectEventHandler" id="61443">NioConnectEventHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(channel: java.nio.channels.SocketChannel)Unit" id="61447">connectEvent</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="61448">channel</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#28225" title="(channel: java.nio.channels.SocketChannel)edu.berkeley.cs.scads.comm.RemoteNode">registerReverseMap</a><span title="Unit" class="delimiter">(</span><a href="#61448" title="java.nio.channels.SocketChannel">channel</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]" id="28223">socketAddrReverseMap</a> = <span title="()java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]">ConcurrentHashMap</span><span class="delimiter">[</span>SocketChannel, RemoteNode<span class="delimiter">]</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(channel: java.nio.channels.SocketChannel)edu.berkeley.cs.scads.comm.RemoteNode" id="28225">registerReverseMap</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="61429">channel</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#28223" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]">socketAddrReverseMap</a>.<span title="(x$1: java.nio.channels.SocketChannel, x$2: edu.berkeley.cs.scads.comm.RemoteNode)edu.berkeley.cs.scads.comm.RemoteNode">put</span><span class="delimiter">(</span>
      <a href="#61429" title="java.nio.channels.SocketChannel">channel</a>,
      <a href="../AvroChannelManager.scala.html#24018" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#61429" title="java.nio.channels.SocketChannel">channel</a>.<span title="()java.net.Socket">socket</span>.<span title="()java.net.InetAddress">getInetAddress</span>.<span title="()java.lang.String">getHostName</span>, <a href="#61429" title="java.nio.channels.SocketChannel">channel</a>.<span title="()java.net.Socket">socket</span>.<span title="()Int">getPort</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)java.nio.channels.SocketChannel" id="28226">getChannel</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="61453">dest</a>: <a href="../AvroChannelManager.scala.html#9508" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">)</span>:<span title="java.nio.channels.SocketChannel">SocketChannel</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="61455">sockAddr</a> = <a href="#61453" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>.<a href="../AvroChannelManager.scala.html#24028" title="=&gt; java.net.InetSocketAddress">getInetSocketAddress</a>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="61456">channel</a> = <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58185" title="(addr: java.net.InetSocketAddress)java.nio.channels.SocketChannel">getChannelForInetSocketAddress</a><span class="delimiter">(</span><a href="#61455" title="java.net.InetSocketAddress">sockAddr</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#61456" title="java.nio.channels.SocketChannel">channel</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="Nothing" class="keyword">return</span> <a href="#61456" title="java.nio.channels.SocketChannel">channel</a>
    <span class="keyword">val</span> <a title="NioAvroChannelManagerBase.this.endpoint.ConnectFuture" id="61457">future</a> = <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58215" title="(hostAddress: java.net.InetSocketAddress)NioAvroChannelManagerBase.this.endpoint.ConnectFuture">connect</a><span class="delimiter">(</span><a href="#61455" title="java.net.InetSocketAddress">sockAddr</a><span class="delimiter">)</span>
    <a href="#61457" title="NioAvroChannelManagerBase.this.endpoint.ConnectFuture">future</a>.<a href="AbstractNioEndpoint.scala.html#59413" title="=&gt; Unit">await</a>
    <a href="#61457" title="NioAvroChannelManagerBase.this.endpoint.ConnectFuture">future</a>.<a href="AbstractNioEndpoint.scala.html#59407" title="=&gt; java.nio.channels.SocketChannel">clientSocket</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: SendMsgType)Unit" id="28227">sendMessageBulk</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="61463">dest</a>: <a href="../AvroChannelManager.scala.html#9508" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="SendMsgType" id="61464">msg</a>: <a href="#9944" title="SendMsgType">SendMsgType</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="61468">channel</a> = <a href="#28226" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)java.nio.channels.SocketChannel">getChannel</a><span class="delimiter">(</span><a href="#61463" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="61469">buffer</a> = <span title="(x$1: Int)java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span><span class="delimiter">(</span><span title="Int(128)" class="int">128</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryEncoder" id="61470">encoder</a> = <span title="object org.apache.avro.io.EncoderFactory">EncoderFactory</span>.<span title="()org.apache.avro.io.EncoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.OutputStream, x$2: org.apache.avro.io.BinaryEncoder)org.apache.avro.io.BinaryEncoder">binaryEncoder</span><span class="delimiter">(</span><a href="#61469" title="java.io.ByteArrayOutputStream">buffer</a>,<span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#28219" title="=&gt; org.apache.avro.specific.SpecificDatumWriter[SendMsgType]">msgWriter</a>.<span title="(x$1: SendMsgType, x$2: org.apache.avro.io.Encoder)Unit">write</span><span class="delimiter">(</span><a href="#61464" title="SendMsgType">msg</a>, <a href="#61470" title="org.apache.avro.io.BinaryEncoder">encoder</a><span class="delimiter">)</span>
    <a href="#61470" title="org.apache.avro.io.BinaryEncoder">encoder</a>.<span title="()Unit">flush</span>
    <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58206" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit">sendBulk</a><span class="delimiter">(</span><a href="#61468" title="java.nio.channels.SocketChannel">channel</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#61469" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: SendMsgType)Unit" id="28228">sendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="28523">dest</a>: <a href="../AvroChannelManager.scala.html#9508" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="SendMsgType" id="28524">msg</a>: <a href="#9944" title="SendMsgType">SendMsgType</a><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="61486">channel</a> = <a href="#28226" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)java.nio.channels.SocketChannel">getChannel</a><span class="delimiter">(</span><a href="#28523" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="61487">buffer</a> = <span title="(x$1: Int)java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span><span class="delimiter">(</span><span title="Int(128)" class="int">128</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryEncoder" id="61488">encoder</a> = <span title="object org.apache.avro.io.EncoderFactory">EncoderFactory</span>.<span title="()org.apache.avro.io.EncoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.OutputStream, x$2: org.apache.avro.io.BinaryEncoder)org.apache.avro.io.BinaryEncoder">binaryEncoder</span><span class="delimiter">(</span><a href="#61487" title="java.io.ByteArrayOutputStream">buffer</a>,<span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#28219" title="=&gt; org.apache.avro.specific.SpecificDatumWriter[SendMsgType]">msgWriter</a>.<span title="(x$1: SendMsgType, x$2: org.apache.avro.io.Encoder)Unit">write</span><span class="delimiter">(</span><a href="#28524" title="SendMsgType">msg</a>, <a href="#61488" title="org.apache.avro.io.BinaryEncoder">encoder</a><span class="delimiter">)</span>
    <a href="#61488" title="org.apache.avro.io.BinaryEncoder">encoder</a>.<span title="()Unit">flush</span>
    <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58201" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, callback: edu.berkeley.cs.scads.comm.WriteCallback, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#61486" title="java.nio.channels.SocketChannel">channel</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#61487" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Null(null)" class="keyword">null</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="28229">flush</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58209" title="=&gt; Unit">flushAllBulk</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="28230">startListener</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="61505">port</a> = <span title="Int(9000)" class="int">9000</span>
    <a href="#9943" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Boolean" id="61508">open</a> = <span title="Boolean(false)" class="keyword">false</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#61508" title="Boolean">open</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#61509" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
          <a href="#28231" title="(port: Int)Unit">startListener</a><span class="delimiter">(</span><a href="#61505" title="Int">port</a><span class="delimiter">)</span>
          <a href="#61508" title="Boolean">open</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="61516">bn</a>: java.net.<span title="java.net.BindException">BindException</span> =&gt; <a href="#61505" title="Int">port</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(port: Int)Unit" id="28231">startListener</a><span class="delimiter">(</span><a title="Int" id="61510">port</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58212" title="(hostAddress: java.net.InetSocketAddress)Unit">serve</a><span class="delimiter">(</span><span title="java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#61510" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#28211" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Listener started on port: %d&quot;)" class="string">&quot;Listener started on port: %d&quot;</span>, <a href="#61510" title="Int">port</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: Array[Byte], count: Int)Unit" id="28232">processData</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="61528">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="Array[Byte]" id="61529">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Int" id="61530">count</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">//TODO: consider using direct binary decoders, since there's no reason to</span>
    <span class="comment">//buffer (saves a copy of the data)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryDecoder" id="61533">inStream</a> = <span title="object org.apache.avro.io.DecoderFactory">DecoderFactory</span>.<span title="()org.apache.avro.io.DecoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: Array[Byte], x$2: org.apache.avro.io.BinaryDecoder)org.apache.avro.io.BinaryDecoder">binaryDecoder</span><span class="delimiter">(</span><a href="#61529" title="Array[Byte]">data</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> 
    <span class="keyword">val</span> <a title="RecvMsgType" id="61534">msg</a> = <a href="#28213" title="=&gt; Class[RecvMsgType]">msgRecvClass</a>.<span title="()RecvMsgType">newInstance</span>
    <a href="#28217" title="=&gt; org.apache.avro.specific.SpecificDatumReader[RecvMsgType]">msgReader</a>.<span title="(x$1: RecvMsgType, x$2: org.apache.avro.io.Decoder)RecvMsgType">read</span><span class="delimiter">(</span><a href="#61534" title="RecvMsgType">msg</a>, <a href="#61533" title="org.apache.avro.io.BinaryDecoder">inStream</a><span class="delimiter">)</span>
    <a href="../AvroChannelManager.scala.html#14306" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: RecvMsgType)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#28223" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]">socketAddrReverseMap</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.comm.RemoteNode">get</span><span class="delimiter">(</span><a href="#61528" title="java.nio.channels.SocketChannel">socket</a><span class="delimiter">)</span>, <a href="#61534" title="RecvMsgType">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(exception: Exception)Unit" id="28233">handleException</a><span class="delimiter">(</span><a title="Exception" id="61548">exception</a>: <span title="Exception">Exception</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">//TODO: do something better</span>
    <a href="#61548" title="Exception">exception</a>.<span title="()Unit">printStackTrace</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; java.net.InetAddress" id="28234">getLocalAddress</a>: <span title="java.net.InetAddress">InetAddress</span> = <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58210" title="()java.net.InetAddress">getListeningAddr</a>
  <span class="keyword">def</span> <a title="=&gt; Int" id="28235">getLocalPort</a>: <span title="Int">Int</span> = <a href="#28221" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#58211" title="()Int">getListeningPort</a>

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode" id="28236">remoteNode</a> = <span class="delimiter">{</span>
    <a href="../AvroChannelManager.scala.html#24018" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#28234" title="=&gt; java.net.InetAddress">getLocalAddress</a>.<span title="()java.lang.String">getCanonicalHostName</span><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#28235" title="=&gt; Int">getLocalPort</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>