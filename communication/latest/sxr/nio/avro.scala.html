<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>nio/avro.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs
<span class="keyword">package</span> scads.comm

<span class="keyword">import</span> java.net.<span class="delimiter">{</span>InetSocketAddress, InetAddress<span class="delimiter">}</span>

<span class="keyword">import</span> java.io.ByteArrayOutputStream
<span class="keyword">import</span> java.nio.ByteBuffer
<span class="keyword">import</span> java.nio.channels.<span class="delimiter">{</span>SocketChannel, NotYetConnectedException<span class="delimiter">}</span>

<span class="keyword">import</span> java.util.HashMap
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> java.util.concurrent.Executor

<span class="keyword">import</span> org.apache.avro.io._
<span class="keyword">import</span> org.apache.avro.generic._
<span class="keyword">import</span> org.apache.avro.specific._
<span class="keyword">import</span> avro.runtime._
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> avro.runtime.TypedSchema

<span class="comment">/**
 * Easier to instantiate via reflection
 */</span>
<span class="keyword">class</span> <a title="class DefaultNioChannelManager[S &lt;: org.apache.avro.generic.IndexedRecord, R &lt;: org.apache.avro.generic.IndexedRecord] extends edu.berkeley.cs.scads.comm.NioAvroChannelManagerBase[S,R] with ScalaObject" id="9714">DefaultNioChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9715">S</a> &lt;: IndexedRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9716">R</a> &lt;: IndexedRecord<span class="delimiter">]</span><a href="#9714" title="ScalaObject" class="delimiter">(</a>
                                                                        <a title="(edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], edu.berkeley.cs.scads.comm.RemoteNode, R) =&gt; Unit" id="48708">recvMsg</a>: <span class="delimiter">(</span>AvroChannelManager<span class="delimiter">[</span>S, R<span class="delimiter">]</span>, RemoteNode, R<span class="delimiter">)</span> =&gt; Unit, <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[S]" id="48709">sendSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[S]">TypedSchema</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[R]" id="48710">recvSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[R]">TypedSchema</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="#9717" title="edu.berkeley.cs.scads.comm.NioAvroChannelManagerBase[S,R]">NioAvroChannelManagerBase</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#48709" title="edu.berkeley.cs.avro.runtime.package.TypedSchema[S]">sendSchema</a>, <a href="#48710" title="edu.berkeley.cs.avro.runtime.package.TypedSchema[R]">recvSchema</a><span class="delimiter">)</span> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(remoteNode: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit" id="48703">receiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="48715">remoteNode</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="R" id="48716">msg</a>: <a href="#9716" title="R">R</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#48708" title="(v1: edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], v2: edu.berkeley.cs.scads.comm.RemoteNode, v3: R)Unit">recvMsg</a><span class="delimiter">(</span><a href="#9714" title="edu.berkeley.cs.scads.comm.DefaultNioChannelManager[S,R]" class="keyword">this</a>, <a href="#48715" title="edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#48716" title="R">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class NioAvroChannelManagerBase[SendMsgType &lt;: org.apache.avro.generic.IndexedRecord, RecvMsgType &lt;: org.apache.avro.generic.IndexedRecord] extends java.lang.Object with edu.berkeley.cs.scads.comm.AvroChannelManager[SendMsgType,RecvMsgType] with edu.berkeley.cs.scads.comm.ChannelHandler with ScalaObject" id="9717">NioAvroChannelManagerBase</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9718">SendMsgType</a> &lt;: IndexedRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.generic.IndexedRecord" id="9719">RecvMsgType</a> &lt;: IndexedRecord<span class="delimiter">]</span>
<a href="#9717" title="ScalaObject" class="delimiter">(</a><span class="keyword">implicit</span> <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[SendMsgType]" id="48711">sendSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[SendMsgType]">TypedSchema</span><span class="delimiter">[</span>SendMsgType<span class="delimiter">]</span>, <a title="edu.berkeley.cs.avro.runtime.package.TypedSchema[RecvMsgType]" id="48712">recvSchema</a>: <span title="edu.berkeley.cs.avro.runtime.package.TypedSchema[RecvMsgType]">TypedSchema</span><span class="delimiter">[</span>RecvMsgType<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="../AvroChannelManager.scala.html#9478" title="edu.berkeley.cs.scads.comm.AvroChannelManager[SendMsgType,RecvMsgType]">AvroChannelManager</a><span class="delimiter">[</span>SendMsgType, RecvMsgType<span class="delimiter">]</span> <span class="keyword">with</span> <a href="interfaces.scala.html#9725" title="edu.berkeley.cs.scads.comm.ChannelHandler">ChannelHandler</a> <span class="delimiter">{</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="48674">logger</a>: <span title="net.lag.logging.Logger">Logger</span> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumReader[RecvMsgType]" id="48676">msgReader</a> = <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumReader[RecvMsgType]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumReader[RecvMsgType]">SpecificDatumReader</span><span class="delimiter">[</span>RecvMsgType<span class="delimiter">]</span><span class="delimiter">(</span><a href="#48712" title="(t: edu.berkeley.cs.avro.runtime.package.TypedSchema[RecvMsgType])org.apache.avro.Schema">recvSchema</a><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumWriter[SendMsgType]" id="48678">msgWriter</a> = <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumWriter[SendMsgType]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumWriter[SendMsgType]">SpecificDatumWriter</span><span class="delimiter">[</span>SendMsgType<span class="delimiter">]</span><span class="delimiter">(</span><a href="#48711" title="(t: edu.berkeley.cs.avro.runtime.package.TypedSchema[SendMsgType])org.apache.avro.Schema">sendSchema</a><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.NioEndpoint" id="48680">endpoint</a>: <a href="AbstractNioEndpoint.scala.html#9693" title="edu.berkeley.cs.scads.comm.NioEndpoint">NioEndpoint</a> = <span title="edu.berkeley.cs.scads.comm.NioEndpoint" class="keyword">new</span> <a href="AbstractNioEndpoint.scala.html#9693" title="edu.berkeley.cs.scads.comm.NioEndpoint">NioEndpoint</a><span class="delimiter">(</span><a href="#9717" title="edu.berkeley.cs.scads.comm.NioAvroChannelManagerBase[SendMsgType,RecvMsgType]" class="keyword">this</a><span class="delimiter">)</span>
  <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45585" title="(x$1: edu.berkeley.cs.scads.comm.NioAcceptEventHandler)Unit">acceptEventHandler</a> = <a href="#48985" title="java.lang.Object with edu.berkeley.cs.scads.comm.NioAcceptEventHandler" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.NioAcceptEventHandler" id="48985">NioAcceptEventHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(channel: java.nio.channels.SocketChannel)Unit" id="48989">acceptEvent</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="48990">channel</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#48684" title="(channel: java.nio.channels.SocketChannel)edu.berkeley.cs.scads.comm.RemoteNode">registerReverseMap</a><span title="Unit" class="delimiter">(</span><a href="#48990" title="java.nio.channels.SocketChannel">channel</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45588" title="(x$1: edu.berkeley.cs.scads.comm.NioConnectEventHandler)Unit">connectEventHandler</a> = <a href="#49007" title="java.lang.Object with edu.berkeley.cs.scads.comm.NioConnectEventHandler" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.NioConnectEventHandler" id="49007">NioConnectEventHandler</a> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(channel: java.nio.channels.SocketChannel)Unit" id="49011">connectEvent</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="49012">channel</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#48684" title="(channel: java.nio.channels.SocketChannel)edu.berkeley.cs.scads.comm.RemoteNode">registerReverseMap</a><span title="Unit" class="delimiter">(</span><a href="#49012" title="java.nio.channels.SocketChannel">channel</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]" id="48682">socketAddrReverseMap</a> = <span title="()java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]">ConcurrentHashMap</span><span class="delimiter">[</span>SocketChannel, RemoteNode<span class="delimiter">]</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(channel: java.nio.channels.SocketChannel)edu.berkeley.cs.scads.comm.RemoteNode" id="48684">registerReverseMap</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="48993">channel</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#48682" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]">socketAddrReverseMap</a>.<span title="(x$1: java.nio.channels.SocketChannel, x$2: edu.berkeley.cs.scads.comm.RemoteNode)edu.berkeley.cs.scads.comm.RemoteNode">put</span><span class="delimiter">(</span>
      <a href="#48993" title="java.nio.channels.SocketChannel">channel</a>,
      <a href="../AvroChannelManager.scala.html#20827" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#48993" title="java.nio.channels.SocketChannel">channel</a>.<span title="()java.net.Socket">socket</span>.<span title="()java.net.InetAddress">getInetAddress</span>.<span title="()java.lang.String">getHostName</span>, <a href="#48993" title="java.nio.channels.SocketChannel">channel</a>.<span title="()java.net.Socket">socket</span>.<span title="()Int">getPort</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)java.nio.channels.SocketChannel" id="48685">getChannel</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49017">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">)</span>: <span title="java.nio.channels.SocketChannel">SocketChannel</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="49019">sockAddr</a> = <a href="#49017" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>.<a href="../AvroChannelManager.scala.html#10353" title="=&gt; java.net.InetSocketAddress">getInetSocketAddress</a>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="49020">channel</a> = <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45623" title="(addr: java.net.InetSocketAddress)java.nio.channels.SocketChannel">getChannelForInetSocketAddress</a><span class="delimiter">(</span><a href="#49019" title="java.net.InetSocketAddress">sockAddr</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#49020" title="java.nio.channels.SocketChannel">channel</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="Nothing" class="keyword">return</span> <a href="#49020" title="java.nio.channels.SocketChannel">channel</a>
    <span class="keyword">val</span> <a title="NioAvroChannelManagerBase.this.endpoint.ConnectFuture" id="49021">future</a> = <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45653" title="(hostAddress: java.net.InetSocketAddress)NioAvroChannelManagerBase.this.endpoint.ConnectFuture">connect</a><span class="delimiter">(</span><a href="#49019" title="java.net.InetSocketAddress">sockAddr</a><span class="delimiter">)</span>
    <a href="#49021" title="NioAvroChannelManagerBase.this.endpoint.ConnectFuture">future</a>.<a href="AbstractNioEndpoint.scala.html#46916" title="=&gt; Unit">await</a>
    <a href="#49021" title="NioAvroChannelManagerBase.this.endpoint.ConnectFuture">future</a>.<a href="AbstractNioEndpoint.scala.html#46910" title="=&gt; java.nio.channels.SocketChannel">clientSocket</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: SendMsgType)Unit" id="48686">sendMessageBulk</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49027">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="SendMsgType" id="49028">msg</a>: <a href="#9718" title="SendMsgType">SendMsgType</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="49032">channel</a> = <a href="#48685" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)java.nio.channels.SocketChannel">getChannel</a><span class="delimiter">(</span><a href="#49027" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="49033">buffer</a> = <span title="(x$1: Int)java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span><span class="delimiter">(</span><span title="Int(128)" class="int">128</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryEncoder" id="49034">encoder</a> = <span title="object org.apache.avro.io.EncoderFactory">EncoderFactory</span>.<span title="()org.apache.avro.io.EncoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.OutputStream, x$2: org.apache.avro.io.BinaryEncoder)org.apache.avro.io.BinaryEncoder">binaryEncoder</span><span class="delimiter">(</span><a href="#49033" title="java.io.ByteArrayOutputStream">buffer</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#48678" title="=&gt; org.apache.avro.specific.SpecificDatumWriter[SendMsgType]">msgWriter</a>.<span title="(x$1: SendMsgType, x$2: org.apache.avro.io.Encoder)Unit">write</span><span class="delimiter">(</span><a href="#49028" title="SendMsgType">msg</a>, <a href="#49034" title="org.apache.avro.io.BinaryEncoder">encoder</a><span class="delimiter">)</span>
    <a href="#49034" title="org.apache.avro.io.BinaryEncoder">encoder</a>.<span title="()Unit">flush</span>
    <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45644" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit">sendBulk</a><span class="delimiter">(</span><a href="#49032" title="java.nio.channels.SocketChannel">channel</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#49033" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: SendMsgType)Unit" id="48687">sendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49050">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="SendMsgType" id="49051">msg</a>: <a href="#9718" title="SendMsgType">SendMsgType</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="49055">channel</a> = <a href="#48685" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)java.nio.channels.SocketChannel">getChannel</a><span class="delimiter">(</span><a href="#49050" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="49056">buffer</a> = <span title="(x$1: Int)java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span><span class="delimiter">(</span><span title="Int(128)" class="int">128</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryEncoder" id="49057">encoder</a> = <span title="object org.apache.avro.io.EncoderFactory">EncoderFactory</span>.<span title="()org.apache.avro.io.EncoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.OutputStream, x$2: org.apache.avro.io.BinaryEncoder)org.apache.avro.io.BinaryEncoder">binaryEncoder</span><span class="delimiter">(</span><a href="#49056" title="java.io.ByteArrayOutputStream">buffer</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#48678" title="=&gt; org.apache.avro.specific.SpecificDatumWriter[SendMsgType]">msgWriter</a>.<span title="(x$1: SendMsgType, x$2: org.apache.avro.io.Encoder)Unit">write</span><span class="delimiter">(</span><a href="#49051" title="SendMsgType">msg</a>, <a href="#49057" title="org.apache.avro.io.BinaryEncoder">encoder</a><span class="delimiter">)</span>
    <a href="#49057" title="org.apache.avro.io.BinaryEncoder">encoder</a>.<span title="()Unit">flush</span>
    <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45639" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, callback: edu.berkeley.cs.scads.comm.WriteCallback, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#49055" title="java.nio.channels.SocketChannel">channel</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#49056" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Null(null)" class="keyword">null</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="48688">flush</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45647" title="=&gt; Unit">flushAllBulk</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="48689">startListener</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="49074">port</a> = <span title="Int(9000)" class="int">9000</span>
    <a href="#9717" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Boolean" id="49077">open</a> = <span title="Boolean(false)" class="keyword">false</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#49077" title="Boolean">open</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#49078" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
          <a href="#48690" title="(port: Int)Unit">startListener</a><span class="delimiter">(</span><a href="#49074" title="Int">port</a><span class="delimiter">)</span>
          <a href="#49077" title="Boolean">open</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="49085">bn</a>: java.net.<span title="java.net.BindException">BindException</span> =&gt; <a href="#49074" title="Int">port</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(port: Int)Unit" id="48690">startListener</a><span class="delimiter">(</span><a title="Int" id="49079">port</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45650" title="(hostAddress: java.net.InetSocketAddress)Unit">serve</a><span class="delimiter">(</span><span title="java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#49079" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#48674" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Listener started on port: %d&quot;)" class="string">&quot;Listener started on port: %d&quot;</span>, <a href="#49079" title="Int">port</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: Array[Byte], count: Int)Unit" id="48691">processData</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="49097">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="Array[Byte]" id="49098">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Int" id="49099">count</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">//TODO: consider using direct binary decoders, since there's no reason to</span>
    <span class="comment">//buffer (saves a copy of the data)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryDecoder" id="49102">inStream</a> = <span title="object org.apache.avro.io.DecoderFactory">DecoderFactory</span>.<span title="()org.apache.avro.io.DecoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: Array[Byte], x$2: org.apache.avro.io.BinaryDecoder)org.apache.avro.io.BinaryDecoder">binaryDecoder</span><span class="delimiter">(</span><a href="#49098" title="Array[Byte]">data</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="RecvMsgType" id="49103">msg</a> = <a href="#48676" title="=&gt; org.apache.avro.specific.SpecificDatumReader[RecvMsgType]">msgReader</a>.<span title="(x$1: RecvMsgType, x$2: org.apache.avro.io.Decoder)RecvMsgType">read</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="RecvMsgType" class="delimiter">[</span><a href="#9719" title="RecvMsgType">RecvMsgType</a><span class="delimiter">]</span>, <a href="#49102" title="org.apache.avro.io.BinaryDecoder">inStream</a><span class="delimiter">)</span>
    <a href="../AvroChannelManager.scala.html#21016" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: RecvMsgType)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#48682" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.nio.channels.SocketChannel,edu.berkeley.cs.scads.comm.RemoteNode]">socketAddrReverseMap</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.comm.RemoteNode">get</span><span class="delimiter">(</span><a href="#49097" title="java.nio.channels.SocketChannel">socket</a><span class="delimiter">)</span>, <a href="#49103" title="RecvMsgType">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(exception: Exception)Unit" id="48692">handleException</a><span class="delimiter">(</span><a title="Exception" id="49117">exception</a>: <span title="Exception">Exception</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">//TODO: do something better</span>
    <a href="#49117" title="Exception">exception</a>.<span title="()Unit">printStackTrace</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; java.net.InetAddress" id="48693">getLocalAddress</a>: <span title="java.net.InetAddress">InetAddress</span> = <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45648" title="()java.net.InetAddress">getListeningAddr</a>

  <span class="keyword">def</span> <a title="=&gt; Int" id="48694">getLocalPort</a>: <span title="Int">Int</span> = <a href="#48680" title="=&gt; edu.berkeley.cs.scads.comm.NioEndpoint">endpoint</a>.<a href="AbstractNioEndpoint.scala.html#45649" title="()Int">getListeningPort</a>

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode" id="48695">remoteNode</a> = <span class="delimiter">{</span>
    <a href="../AvroChannelManager.scala.html#20827" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#48693" title="=&gt; java.net.InetAddress">getLocalAddress</a>.<span title="()java.lang.String">getCanonicalHostName</span><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#48694" title="=&gt; Int">getLocalPort</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>