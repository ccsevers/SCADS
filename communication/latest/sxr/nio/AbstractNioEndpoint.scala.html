<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>nio/AbstractNioEndpoint.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm

<span class="keyword">import</span> java.io.<span class="delimiter">{</span>ByteArrayOutputStream,IOException<span class="delimiter">}</span>
<span class="keyword">import</span> java.net.InetAddress
<span class="keyword">import</span> java.net.InetSocketAddress
<span class="keyword">import</span> java.net.Socket
<span class="keyword">import</span> java.nio.ByteBuffer
<span class="keyword">import</span> java.nio.channels.SelectionKey
<span class="keyword">import</span> java.nio.channels.Selector
<span class="keyword">import</span> java.nio.channels.SelectableChannel
<span class="keyword">import</span> java.nio.channels.ServerSocketChannel
<span class="keyword">import</span> java.nio.channels.SocketChannel
<span class="keyword">import</span> java.nio.channels.spi.SelectorProvider
<span class="keyword">import</span> java.util.<span class="delimiter">{</span>List =&gt; JList, LinkedList, HashMap<span class="delimiter">}</span>
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap

<span class="keyword">import</span> java.util.concurrent.Executor

<span class="keyword">import</span> org.apache.avro.specific.SpecificRecord

<span class="keyword">import</span> scala.collection.mutable.ListBuffer

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.scads.config._

<span class="keyword">class</span> <a title="class NioEndpoint extends java.lang.Object with ScalaObject" id="9921">NioEndpoint</a><a href="#9921" title="ScalaObject" class="delimiter">(</a><span class="keyword">protected</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ChannelHandler" id="59330">channelHandler</a>: <a href="interfaces.scala.html#9951" title="edu.berkeley.cs.scads.comm.ChannelHandler">ChannelHandler</a><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#59330" title="=&gt; edu.berkeley.cs.scads.comm.ChannelHandler">channelHandler</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cannot pass in null values to constructor&quot;)" class="string">&quot;Cannot pass in null values to constructor&quot;</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="58144">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.NioAcceptEventHandler" id="58147">acceptEventHandler</a>: <a href="interfaces.scala.html#9952" title="edu.berkeley.cs.scads.comm.NioAcceptEventHandler">NioAcceptEventHandler</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.NioConnectEventHandler" id="58150">connectEventHandler</a>: <a href="interfaces.scala.html#9953" title="edu.berkeley.cs.scads.comm.NioConnectEventHandler">NioConnectEventHandler</a> = <span title="Null(null)" class="keyword">null</span>

  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="java.nio.channels.ServerSocketChannel" id="58153">serverChannel</a>: <span title="java.nio.channels.ServerSocketChannel">ServerSocketChannel</span> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="Boolean" id="58156">initialized</a> = <span title="Boolean(false)" class="keyword">false</span>
  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="Boolean" id="58159">isListening</a> = <span title="Boolean(false)" class="keyword">false</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.nio.channels.spi.AbstractSelector" id="58161">selector</a> = <span title="object java.nio.channels.spi.SelectorProvider">SelectorProvider</span>.<span title="()java.nio.channels.spi.SelectorProvider">provider</span>.<span title="()java.nio.channels.spi.AbstractSelector">openSelector</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="58163">readBuffer</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Int)java.nio.ByteBuffer">allocate</span><span class="delimiter">(</span><span title="Int(8192)" class="int">8192</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="Int" id="58166">bulkBufferSize</a> = <span class="int">64</span><span title="Int(65536)">*</span><span class="int">1024</span>

  case <span class="keyword">class</span> <a title="class QueueEntry extends java.lang.Object with ScalaObject with Product with Serializable" id="58644">QueueEntry</a><a href="#58644" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="61022">contents</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span>, <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.WriteCallback" id="61023">callback</a>: <a href="interfaces.scala.html#9950" title="edu.berkeley.cs.scads.comm.WriteCallback">WriteCallback</a><span class="delimiter">)</span>
  case <span class="keyword">class</span> <a title="class RegisterEntry extends java.lang.Object with ScalaObject with Product with Serializable" id="59050">RegisterEntry</a><a href="#59050" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="java.nio.channels.SelectableChannel" id="61012">socket</a>: <span title="java.nio.channels.SelectableChannel">SelectableChannel</span>, <span class="keyword">val</span> <a title="NioEndpoint.this.ConnectFuture" id="61013">future</a>: <a href="#58194" title="NioEndpoint.this.ConnectFuture">ConnectFuture</a>, <span class="keyword">val</span> <a title="Int" id="61014">interestOp</a>: <span title="Int">Int</span><span class="delimiter">)</span>

  <span class="comment">//protected val dataQueue: BlockingQueue[QueueEntry] = new LinkedBlockingQueue[QueueEntry]</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]" id="58174">dataMapQueue</a> = <span title="()java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]" class="keyword">new</span> <span title="java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">HashMap</span><span class="delimiter">[</span>SocketChannel,JList<span class="delimiter">[</span>QueueEntry<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]" id="58176">bulkBufferQueue</a> = <span title="()java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]" class="keyword">new</span> <span title="java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">HashMap</span><span class="delimiter">[</span>SocketChannel, ByteArrayOutputStream<span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.LinkedList[NioEndpoint.this.RegisterEntry]" id="58178">registerQueue</a> = <span title="java.util.LinkedList[NioEndpoint.this.RegisterEntry]" class="keyword">new</span> <span title="java.util.LinkedList[NioEndpoint.this.RegisterEntry]">LinkedList</span><span class="delimiter">[</span>RegisterEntry<span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,java.nio.channels.SocketChannel]" id="58180">connectionMap</a> = <span title="()java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,java.nio.channels.SocketChannel]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,java.nio.channels.SocketChannel]">ConcurrentHashMap</span><span class="delimiter">[</span>InetSocketAddress,SocketChannel<span class="delimiter">]</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.HashMap[java.nio.channels.SocketChannel,NioEndpoint.this.ChannelState]" id="58182">channelQueue</a> = <span title="()java.util.HashMap[java.nio.channels.SocketChannel,NioEndpoint.this.ChannelState]" class="keyword">new</span> <span title="java.util.HashMap[java.nio.channels.SocketChannel,NioEndpoint.this.ChannelState]">HashMap</span><span class="delimiter">[</span>SocketChannel, ChannelState<span class="delimiter">]</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(addr: java.net.InetSocketAddress, chan: java.nio.channels.SocketChannel)java.nio.channels.SocketChannel" id="58184">registerInetSocketAddress</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="59487">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span>, <a title="java.nio.channels.SocketChannel" id="59488">chan</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <a href="#58180" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,java.nio.channels.SocketChannel]">connectionMap</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: java.nio.channels.SocketChannel)java.nio.channels.SocketChannel">put</span><span class="delimiter">(</span><a href="#59487" title="java.net.InetSocketAddress">addr</a>, <a href="#59488" title="java.nio.channels.SocketChannel">chan</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(addr: java.net.InetSocketAddress)java.nio.channels.SocketChannel" id="58185">getChannelForInetSocketAddress</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="59497">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span>:<span title="java.nio.channels.SocketChannel">SocketChannel</span> = <a href="#58180" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,java.nio.channels.SocketChannel]">connectionMap</a>.<span title="(x$1: Any)java.nio.channels.SocketChannel">get</span><span class="delimiter">(</span><a href="#59497" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>


  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Boolean" id="58187">useTcpNoDelay</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>.<span title="(key: String, defaultValue: Boolean)Boolean">getBool</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.comm.tcpNoDelay&quot;)" class="string">&quot;scads.comm.tcpNoDelay&quot;</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  case <span class="keyword">class</span> <a title="class ChannelState extends java.lang.Object with ScalaObject with Product with Serializable" id="59265">ChannelState</a><a href="#59265" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.CircularByteBuffer" id="61000">buffer</a>: <a href="CircularByteBuffer.scala.html#9925" title="edu.berkeley.cs.scads.comm.CircularByteBuffer">CircularByteBuffer</a>, <span class="keyword">var</span> <a title="Boolean" id="61001">inMessage</a>: <span title="Boolean">Boolean</span>, <span class="keyword">var</span> <a title="Int" id="61002">messageSize</a>: <span title="Int">Int</span><span class="delimiter">)</span>  <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(buffer: edu.berkeley.cs.scads.comm.CircularByteBuffer)NioEndpoint.this.ChannelState" id="59278" class="keyword">this</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.CircularByteBuffer" id="59533">buffer</a>: <a href="CircularByteBuffer.scala.html#9925" title="edu.berkeley.cs.scads.comm.CircularByteBuffer">CircularByteBuffer</a><span class="delimiter">)</span> = <a href="#59265" title="ChannelState.this.type" class="keyword">this</a><span class="delimiter">(</span><a href="#59533" title="edu.berkeley.cs.scads.comm.CircularByteBuffer">buffer</a>, <span title="Boolean(false)" class="keyword">false</span>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="=&gt; Unit" id="59279">reset</a> = <span class="delimiter">{</span>
      <a href="#61001" title="(x$1: Boolean)Unit">inMessage</a> = <span title="Boolean(false)" class="keyword">false</span>
      <a href="#61002" title="(x$1: Int)Unit">messageSize</a> = <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  case <span class="keyword">class</span> <a title="class InvalidMessageSizeException extends java.lang.RuntimeException with ScalaObject with Product with Serializable" id="59646">InvalidMessageSizeException</a><a href="#59646" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Int" id="60993">size</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid size, must be &gt;= 0: &quot;)" class="string">&quot;Invalid size, must be &gt;= 0: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60993" title="Int">size</a><span class="delimiter">)</span>

  <span class="comment">// TODO: replace with BlockingFuture</span>
  <span class="keyword">class</span> <a title="class ConnectFuture extends java.lang.Object with ScalaObject" id="58194">ConnectFuture</a><a href="#58194" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="59682">clientSocket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="59683">alreadyDone</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; Unit" id="59413">await</a> = <span class="delimiter">{</span>
      <a href="#58194" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#59683" title="=&gt; Boolean">alreadyDone</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#58194" title="()Unit">wait</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="=&gt; Unit" id="59414">finished</a> = <span class="delimiter">{</span>
      <a href="#58194" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
        <a href="#59683" title="(x$1: Boolean)Unit">alreadyDone</a> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#58194" title="()Unit">notifyAll</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="58195">fireWriteAndSelectLoop</a> = <span class="delimiter">{</span>
    <span title="(x$1: java.lang.Runnable)java.lang.Thread" class="keyword">new</span> <span title="java.lang.Thread">Thread</span><span class="delimiter">(</span><a href="#59707" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="59707">Runnable</a> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="59709">run</a> = <a href="#58197" title="=&gt; Unit">writeLoop</a>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="()Unit">start</span>
    <span title="(x$1: java.lang.Runnable)java.lang.Thread" class="keyword">new</span> <span title="java.lang.Thread">Thread</span><span class="delimiter">(</span><a href="#60066" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="60066">Runnable</a> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="60068">run</a> = <a href="#58198" title="=&gt; Unit">selectLoop</a>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="()Unit">start</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(queue: java.util.List[NioEndpoint.this.QueueEntry])Boolean" id="58196">mergeQueue</a><span class="delimiter">(</span><a title="java.util.List[NioEndpoint.this.QueueEntry]" id="59823">queue</a>: <span title="java.util.List[NioEndpoint.this.QueueEntry]">JList</span><span class="delimiter">[</span>QueueEntry<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="59826">size</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">var</span> <a title="java.util.Iterator[NioEndpoint.this.QueueEntry]" id="59827">iter</a> = <a href="#59823" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="()java.util.Iterator[NioEndpoint.this.QueueEntry]">iterator</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59827" title="java.util.Iterator[NioEndpoint.this.QueueEntry]">iter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#59826" title="Int">size</a> <a href="#59831" title="(x: Int)Int">+=</a> <a href="#59827" title="java.util.Iterator[NioEndpoint.this.QueueEntry]">iter</a>.<span title="()NioEndpoint.this.QueueEntry">next</span>.<a href="#61022" title="=&gt; java.nio.ByteBuffer">contents</a>.<span title="()Int">remaining</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="59828">newBuf</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Int)java.nio.ByteBuffer">allocate</span><span class="delimiter">(</span><a href="#59826" title="Int">size</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]" id="59829">callbacks</a> = <span title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]" class="keyword">new</span> <span title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">LinkedList</span><span class="delimiter">[</span>WriteCallback<span class="delimiter">]</span>
    <a href="#59827" title="java.util.Iterator[NioEndpoint.this.QueueEntry]">iter</a> = <a href="#59823" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="()java.util.Iterator[NioEndpoint.this.QueueEntry]">iterator</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59827" title="java.util.Iterator[NioEndpoint.this.QueueEntry]">iter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span> <a href="#59832" title="()Unit" class="delimiter">{</a>
      <span class="keyword">val</span> <a title="NioEndpoint.this.QueueEntry" id="59920">entry</a> = <a href="#59827" title="java.util.Iterator[NioEndpoint.this.QueueEntry]">iter</a>.<span title="()NioEndpoint.this.QueueEntry">next</span>
      <a href="#59828" title="java.nio.ByteBuffer">newBuf</a>.<span title="(x$1: java.nio.ByteBuffer)java.nio.ByteBuffer">put</span><span class="delimiter">(</span><a href="#59920" title="NioEndpoint.this.QueueEntry">entry</a>.<a href="#61022" title="=&gt; java.nio.ByteBuffer">contents</a><span class="delimiter">)</span>
      <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><a href="#59920" title="NioEndpoint.this.QueueEntry">entry</a>.<a href="#61023" title="=&gt; edu.berkeley.cs.scads.comm.WriteCallback">callback</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#59829" title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">callbacks</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.WriteCallback)Boolean">add</span><span class="delimiter">(</span><a href="#59920" title="NioEndpoint.this.QueueEntry">entry</a>.<a href="#61023" title="=&gt; edu.berkeley.cs.scads.comm.WriteCallback">callback</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#59828" title="java.nio.ByteBuffer">newBuf</a>.<span title="()java.nio.Buffer">rewind</span>
    <a href="#59823" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="()Unit">clear</span>
    <span class="keyword">val</span> <a title="newWriteCallback extends java.lang.Object with edu.berkeley.cs.scads.comm.WriteCallback" id="59830">newWriteCallback</a> = <a href="#59829" title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">callbacks</a>.<span title="()Int">size</span> <span title="java.lang.Object with edu.berkeley.cs.scads.comm.WriteCallback" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Null(null)" class="int">0</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="keyword">case</span> <span title="java.lang.Object with edu.berkeley.cs.scads.comm.WriteCallback">_</span> =&gt; <a href="#59960" title="java.lang.Object with edu.berkeley.cs.scads.comm.WriteCallback" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.WriteCallback" id="59960">WriteCallback</a> <span class="delimiter">{</span>
        <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="59962">writeFinished</a> = <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]" id="59966">callbackIter</a> = <a href="#59829" title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">callbacks</a>.<span title="()java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]">iterator</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59966" title="java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]">callbackIter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span> <a href="#59966" title="java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]">callbackIter</a>.<span title="()edu.berkeley.cs.scads.comm.WriteCallback">next</span>.<a href="interfaces.scala.html#59342" title="=&gt; Unit">writeFinished</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#59823" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="(x$1: NioEndpoint.this.QueueEntry)Boolean">add</span><span class="delimiter">(</span><span title="NioEndpoint.this.QueueEntry" class="keyword">new</span> <a href="#58644" title="NioEndpoint.this.QueueEntry">QueueEntry</a><span class="delimiter">(</span><a href="#59828" title="java.nio.ByteBuffer">newBuf</a>, <a href="#59830" title="newWriteCallback extends java.lang.Object with edu.berkeley.cs.scads.comm.WriteCallback">newWriteCallback</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="58197">writeLoop</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]" id="59716">callbacks</a> = <span title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]" class="keyword">new</span> <span title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">LinkedList</span><span class="delimiter">[</span>WriteCallback<span class="delimiter">]</span>
    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#59804" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
        <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.util.Set[java.nio.channels.SocketChannel]" id="59809">channelSet</a> = <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="()java.util.Set[java.nio.channels.SocketChannel]">keySet</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#59809" title="java.util.Set[java.nio.channels.SocketChannel]">channelSet</a>.<span title="()Boolean">isEmpty</span><span class="delimiter">)</span>
            <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="()Unit">wait</span>
          <span class="keyword">val</span> <a title="java.util.Iterator[java.nio.channels.SocketChannel]" id="59810">iterator</a> = <a href="#59809" title="java.util.Set[java.nio.channels.SocketChannel]">channelSet</a>.<span title="()java.util.Iterator[java.nio.channels.SocketChannel]">iterator</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59810" title="java.util.Iterator[java.nio.channels.SocketChannel]">iterator</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span> <a href="#59814" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="59815">channel</a> = <a href="#59810" title="java.util.Iterator[java.nio.channels.SocketChannel]">iterator</a>.<span title="()java.nio.channels.SocketChannel">next</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#59815" title="java.nio.channels.SocketChannel">channel</a>.<span title="()Boolean">isConnected</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#59810" title="java.util.Iterator[java.nio.channels.SocketChannel]">iterator</a>.<span title="()Unit">remove</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="java.util.List[NioEndpoint.this.QueueEntry]" id="59816">queue</a> = <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="(x$1: Any)java.util.List[NioEndpoint.this.QueueEntry]">get</span><span class="delimiter">(</span><a href="#59815" title="java.nio.channels.SocketChannel">channel</a><span class="delimiter">)</span>
              <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="()Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
                <a href="#58196" title="(queue: java.util.List[NioEndpoint.this.QueueEntry])Boolean">mergeQueue</a><span class="delimiter">(</span><a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a><span class="delimiter">)</span>
              <span class="keyword">var</span> <a title="Int" id="59817">attempts</a> = <span title="Int(5)" class="int">5</span>
              <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59817" title="Int">attempts</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#59818" title="()Unit" class="delimiter">{</a>
                <span class="keyword">var</span> <a title="Boolean" id="60000">keepTrying</a> = <span title="=&gt; Boolean">!</span><a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="()Boolean">isEmpty</span>
                <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#60000" title="Boolean">keepTrying</a><span class="delimiter">)</span> <a href="#60001" title="()Unit" class="delimiter">{</a>
                  <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="60002">buffer</a> = <a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="(x$1: Int)NioEndpoint.this.QueueEntry">get</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="#61022" title="=&gt; java.nio.ByteBuffer">contents</a>
                  <a href="#59815" title="java.nio.channels.SocketChannel">channel</a>.<span title="(x$1: java.nio.ByteBuffer)Int">write</span><span class="delimiter">(</span><a href="#60002" title="java.nio.ByteBuffer">buffer</a><span class="delimiter">)</span>
                  <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60002" title="java.nio.ByteBuffer">buffer</a>.<span title="()Int">remaining</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="comment">//logger.debug(&quot;channel: &quot; + channel)</span>
                    <span class="comment">//logger.debug(&quot;buffer could not be written in its entirely&quot;)</span>
                    <a href="#60000" title="Boolean">keepTrying</a> = <span title="Boolean(false)" class="keyword">false</span>
                  <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="comment">//logger.debug(&quot;for channel: &quot; + channel)</span>
                    <span class="comment">//logger.debug(&quot;successfully wrote buffer: &quot; + buffer)</span>
                    <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="(x$1: Int)NioEndpoint.this.QueueEntry">get</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="#61023" title="=&gt; edu.berkeley.cs.scads.comm.WriteCallback">callback</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
                      <a href="#59716" title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">callbacks</a>.<span title="(x$1: edu.berkeley.cs.scads.comm.WriteCallback)Boolean">add</span><span class="delimiter">(</span><a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="(x$1: Int)NioEndpoint.this.QueueEntry">get</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="#61023" title="=&gt; edu.berkeley.cs.scads.comm.WriteCallback">callback</a><span class="delimiter">)</span>
                    <a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="(x$1: Int)NioEndpoint.this.QueueEntry">remove</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
                    <a href="#60000" title="Boolean">keepTrying</a> = <span title="=&gt; Boolean">!</span><a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="()Boolean">isEmpty</span>
                  <span class="delimiter">}</span>
                <span class="delimiter">}</span>
                <a href="#59817" title="Int">attempts</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
              <span class="delimiter">}</span>
              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#59816" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="()Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#59810" title="java.util.Iterator[java.nio.channels.SocketChannel]">iterator</a>.<span title="()Unit">remove</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">val</span> <a title="java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]" id="59805">iter</a> = <a href="#59716" title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">callbacks</a>.<span title="()java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]">iterator</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59805" title="java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]">iter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span>
        <a href="#59805" title="java.util.Iterator[edu.berkeley.cs.scads.comm.WriteCallback]">iter</a>.<span title="()edu.berkeley.cs.scads.comm.WriteCallback">next</span>.<a href="interfaces.scala.html#59342" title="=&gt; Unit">writeFinished</a>
        <a href="#59716" title="java.util.LinkedList[edu.berkeley.cs.scads.comm.WriteCallback]">callbacks</a>.<span title="()Unit">clear</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="60058">e</a>: <span title="Exception">Exception</span> =&gt; <a href="#59330" title="=&gt; edu.berkeley.cs.scads.comm.ChannelHandler">channelHandler</a>.<a href="interfaces.scala.html#28247" title="(exception: Exception)Unit">handleException</a><span class="delimiter">(</span><a href="#60058" title="Exception">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="58198">selectLoop</a> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#60075" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
        <a href="#58178" title="=&gt; java.util.LinkedList[NioEndpoint.this.RegisterEntry]">registerQueue</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.util.Iterator[NioEndpoint.this.RegisterEntry]" id="60079">iter</a> = <a href="#58178" title="=&gt; java.util.LinkedList[NioEndpoint.this.RegisterEntry]">registerQueue</a>.<span title="()java.util.Iterator[NioEndpoint.this.RegisterEntry]">iterator</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#60079" title="java.util.Iterator[NioEndpoint.this.RegisterEntry]">iter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span> <a href="#60080" title="()Unit" class="delimiter">{</a>
            <span class="keyword">val</span> <a title="NioEndpoint.this.RegisterEntry" id="60081">entry</a> = <a href="#60079" title="java.util.Iterator[NioEndpoint.this.RegisterEntry]">iter</a>.<span title="()NioEndpoint.this.RegisterEntry">next</span>
            <span title="java.nio.channels.SelectionKey" class="keyword">if</span> <span class="delimiter">(</span><a href="#60081" title="NioEndpoint.this.RegisterEntry">entry</a>.<a href="#61014" title="=&gt; Int">interestOp</a> <span title="(x: Int)Boolean">==</span> SelectionKey.<span title="Int(8)">OP_CONNECT</span><span class="delimiter">)</span>
              <a href="#60081" title="NioEndpoint.this.RegisterEntry">entry</a>.<a href="#61012" title="=&gt; java.nio.channels.SelectableChannel">socket</a>.<span title="(x$1: java.nio.channels.Selector, x$2: Int, x$3: Any)java.nio.channels.SelectionKey">register</span><span class="delimiter">(</span><a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>, SelectionKey.<span title="Int(8)">OP_CONNECT</span>, <a href="#60081" title="NioEndpoint.this.RegisterEntry">entry</a>.<a href="#61013" title="=&gt; NioEndpoint.this.ConnectFuture">future</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span title="java.nio.channels.SelectionKey" class="keyword">if</span> <span class="delimiter">(</span><a href="#60081" title="NioEndpoint.this.RegisterEntry">entry</a>.<a href="#61014" title="=&gt; Int">interestOp</a> <span title="(x: Int)Boolean">==</span> SelectionKey.<span title="Int(16)">OP_ACCEPT</span><span class="delimiter">)</span>
              <a href="#60081" title="NioEndpoint.this.RegisterEntry">entry</a>.<a href="#61012" title="=&gt; java.nio.channels.SelectableChannel">socket</a>.<span title="(x$1: java.nio.channels.Selector, x$2: Int)java.nio.channels.SelectionKey">register</span><span class="delimiter">(</span><a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>, SelectionKey.<span title="Int(16)">OP_ACCEPT</span><span class="delimiter">)</span>
            <span class="keyword">else</span>
              <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;should not have this interest op&quot;)" class="string">&quot;should not have this interest op&quot;</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#58178" title="=&gt; java.util.LinkedList[NioEndpoint.this.RegisterEntry]">registerQueue</a>.<span title="()Unit">clear</span>
        <span class="delimiter">}</span>
        <a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>.<span title="()Int">select</span>
        <span class="comment">//logger.debug(&quot;selectLoop awaken&quot;)</span>
        <span class="keyword">val</span> <a title="java.util.Iterator[java.nio.channels.SelectionKey]" id="60076">selectedKeys</a> = <a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>.<span title="()java.util.Set[java.nio.channels.SelectionKey]">selectedKeys</span>.<span title="()java.util.Iterator[java.nio.channels.SelectionKey]">iterator</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#60076" title="java.util.Iterator[java.nio.channels.SelectionKey]">selectedKeys</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span> <a href="#60136" title="()Unit" class="delimiter">{</a>
          <span class="keyword">val</span> <a title="java.nio.channels.SelectionKey" id="60137">key</a> = <a href="#60076" title="java.util.Iterator[java.nio.channels.SelectionKey]">selectedKeys</a>.<span title="()java.nio.channels.SelectionKey">next</span>
          <a href="#60076" title="java.util.Iterator[java.nio.channels.SelectionKey]">selectedKeys</a>.<span title="()Unit">remove</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60137" title="java.nio.channels.SelectionKey">key</a>.<span title="()Boolean">isValid</span><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60137" title="java.nio.channels.SelectionKey">key</a>.<span title="()Boolean">isAcceptable</span><span class="delimiter">)</span>
              <a href="#58213" title="(key: java.nio.channels.SelectionKey)Unit">accept</a><span class="delimiter">(</span><a href="#60137" title="java.nio.channels.SelectionKey">key</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60137" title="java.nio.channels.SelectionKey">key</a>.<span title="()Boolean">isConnectable</span><span class="delimiter">)</span>
              <a href="#58214" title="(key: java.nio.channels.SelectionKey)Unit">connect</a><span class="delimiter">(</span><a href="#60137" title="java.nio.channels.SelectionKey">key</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60137" title="java.nio.channels.SelectionKey">key</a>.<span title="()Boolean">isReadable</span><span class="delimiter">)</span>
              <a href="#58216" title="(key: java.nio.channels.SelectionKey)Unit">read</a><span class="delimiter">(</span><a href="#60137" title="java.nio.channels.SelectionKey">key</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="60152">e</a>: <span title="Exception">Exception</span> =&gt; <a href="#59330" title="=&gt; edu.berkeley.cs.scads.comm.ChannelHandler">channelHandler</a>.<a href="interfaces.scala.html#28247" title="(exception: Exception)Unit">handleException</a><span class="delimiter">(</span><a href="#60152" title="Exception">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
  * Blocks until all the data is sent out the channel
  */</span>
  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit" id="58199">sendImmediately</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60155">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="java.nio.ByteBuffer" id="60156">data</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span>, <a title="Boolean" id="60157">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="60160">buffer</a> = <a href="#60157" title="Boolean">encode</a> <span title="java.nio.ByteBuffer" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="java.nio.ByteBuffer" class="keyword">false</span> =&gt; <a href="#60156" title="java.nio.ByteBuffer">data</a>
      <span class="keyword">case</span> <span title="java.nio.ByteBuffer" class="keyword">true</span>  =&gt; <a href="#58200" title="(data: java.nio.ByteBuffer)java.nio.ByteBuffer">encodeByteBuffer</a><span class="delimiter">(</span><a href="#60156" title="java.nio.ByteBuffer">data</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#60160" title="java.nio.ByteBuffer">buffer</a>.<span title="()Int">remaining</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#60155" title="java.nio.channels.SocketChannel">socket</a>.<span title="(x$1: java.nio.ByteBuffer)Int">write</span><a href="#60163" title="()Unit" class="delimiter">(</a><a href="#60160" title="java.nio.ByteBuffer">buffer</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(data: java.nio.ByteBuffer)java.nio.ByteBuffer" id="58200">encodeByteBuffer</a><span class="delimiter">(</span><a title="java.nio.ByteBuffer" id="60161">data</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span><span class="delimiter">)</span>: <span title="java.nio.ByteBuffer">ByteBuffer</span> = <span class="delimiter">{</span>
    <span class="comment">//val newBuffer = ByteBuffer.allocate(4 + data.remaining)</span>
    <span class="comment">//newBuffer.putInt(data.remaining)</span>
    <span class="comment">//newBuffer.put(data)</span>
    <span class="comment">//newBuffer.rewind</span>
    <span class="comment">//newBuffer</span>

    <span class="comment">// this seems to run a little faster</span>
    <span class="keyword">val</span> <a title="Array[Byte]" id="60172">buf</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(4)" class="int">4</span> <span title="(x: Int)Int">+</span> <a href="#60161" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span><span class="delimiter">)</span>
    <a href="#60172" title="(i: Int, x: Byte)Unit">buf</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#60161" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span> <span title="(x: Int)Int">&gt;&gt;</span> <span title="Int(24)" class="int">24</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xFF</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
    <a href="#60172" title="(i: Int, x: Byte)Unit">buf</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#60161" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span> <span title="(x: Int)Int">&gt;&gt;</span> <span title="Int(16)" class="int">16</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xFF</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
    <a href="#60172" title="(i: Int, x: Byte)Unit">buf</a><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#60161" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span> <span title="(x: Int)Int">&gt;&gt;</span> <span title="Int(8)" class="int">8</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xFF</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
    <a href="#60172" title="(i: Int, x: Byte)Unit">buf</a><span class="delimiter">(</span><span title="Int(3)" class="int">3</span><span class="delimiter">)</span> = <span class="delimiter">(</span><a href="#60161" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xFF</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
    <a href="#60161" title="java.nio.ByteBuffer">data</a>.<span title="(x$1: Array[Byte], x$2: Int, x$3: Int)java.nio.ByteBuffer">get</span><span class="delimiter">(</span><a href="#60172" title="Array[Byte]">buf</a>, <span title="Int(4)" class="int">4</span>, <a href="#60161" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span><span class="delimiter">)</span>
    <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#60172" title="Array[Byte]">buf</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
  * Asynchrounously send by just adding to send queue and returning
  */</span>
  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, callback: edu.berkeley.cs.scads.comm.WriteCallback, encode: Boolean)Unit" id="58201">send</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60213">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="java.nio.ByteBuffer" id="60214">data</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span>, <a title="edu.berkeley.cs.scads.comm.WriteCallback" id="60215">callback</a>: <a href="interfaces.scala.html#9950" title="edu.berkeley.cs.scads.comm.WriteCallback">WriteCallback</a>, <a title="Boolean" id="60216">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">//logger.debug(&quot;send() called with data: &quot; + data)</span>
    <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="java.util.List[NioEndpoint.this.QueueEntry]" id="60220">queue</a> = <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="(x$1: Any)java.util.List[NioEndpoint.this.QueueEntry]">get</span><span class="delimiter">(</span><a href="#60213" title="java.nio.channels.SocketChannel">socket</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#60220" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#60220" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a> = <span title="java.util.LinkedList[NioEndpoint.this.QueueEntry]" class="keyword">new</span> <span title="java.util.LinkedList[NioEndpoint.this.QueueEntry]">LinkedList</span><span class="delimiter">[</span>QueueEntry<span class="delimiter">]</span>
        <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="(x$1: java.nio.channels.SocketChannel, x$2: java.util.List[NioEndpoint.this.QueueEntry])java.util.List[NioEndpoint.this.QueueEntry]">put</span><span class="delimiter">(</span><a href="#60213" title="java.nio.channels.SocketChannel">socket</a>, <a href="#60220" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="60221">toWrite</a> = <span title="java.nio.ByteBuffer" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#60216" title="Boolean">encode</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#60214" title="java.nio.ByteBuffer">data</a>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#58200" title="(data: java.nio.ByteBuffer)java.nio.ByteBuffer">encodeByteBuffer</a><span class="delimiter">(</span><a href="#60214" title="java.nio.ByteBuffer">data</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#60220" title="java.util.List[NioEndpoint.this.QueueEntry]">queue</a>.<span title="(x$1: NioEndpoint.this.QueueEntry)Boolean">add</span><span class="delimiter">(</span><span title="NioEndpoint.this.QueueEntry" class="keyword">new</span> <a href="#58644" title="NioEndpoint.this.QueueEntry">QueueEntry</a><span class="delimiter">(</span><a href="#60221" title="java.nio.ByteBuffer">toWrite</a>, <a href="#60215" title="edu.berkeley.cs.scads.comm.WriteCallback">callback</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#58174" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.util.List[NioEndpoint.this.QueueEntry]]">dataMapQueue</a>.<span title="()Unit">notifyAll</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit" id="58202">send</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60337">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="java.nio.ByteBuffer" id="60338">data</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span>, <a title="Boolean" id="60339">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <a href="#58201" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, callback: edu.berkeley.cs.scads.comm.WriteCallback, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#60337" title="java.nio.channels.SocketChannel">socket</a>,<a href="#60338" title="java.nio.ByteBuffer">data</a>,<span title="Null(null)" class="keyword">null</span>,<a href="#60339" title="Boolean">encode</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: Array[Byte], callback: edu.berkeley.cs.scads.comm.WriteCallback, encode: Boolean)Unit" id="58203">send</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60349">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="Array[Byte]" id="60350">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.WriteCallback" id="60351">callback</a>: <a href="interfaces.scala.html#9950" title="edu.berkeley.cs.scads.comm.WriteCallback">WriteCallback</a>, <a title="Boolean" id="60352">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> =
    <a href="#58201" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, callback: edu.berkeley.cs.scads.comm.WriteCallback, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#60349" title="java.nio.channels.SocketChannel">socket</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#60350" title="Array[Byte]">data</a><span class="delimiter">)</span>, <a href="#60351" title="edu.berkeley.cs.scads.comm.WriteCallback">callback</a>, <a href="#60352" title="Boolean">encode</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: Array[Byte], encode: Boolean)Unit" id="58204">send</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60345">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="Array[Byte]" id="60346">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Boolean" id="60347">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <a href="#58203" title="(socket: java.nio.channels.SocketChannel, data: Array[Byte], callback: edu.berkeley.cs.scads.comm.WriteCallback, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#60345" title="java.nio.channels.SocketChannel">socket</a>,<a href="#60346" title="Array[Byte]">data</a>,<span title="Null(null)" class="keyword">null</span>,<a href="#60347" title="Boolean">encode</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(data: java.nio.ByteBuffer, encode: Boolean)Int" id="58205">sizeOfMessage</a><span class="delimiter">(</span><a title="java.nio.ByteBuffer" id="60370">data</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span>, <a title="Boolean" id="60371">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#60371" title="Boolean">encode</a> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int" class="keyword">false</span> =&gt; <a href="#60370" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span>
    <span class="keyword">case</span> <span title="Int" class="keyword">true</span>  =&gt; <a href="#60370" title="java.nio.ByteBuffer">data</a>.<span title="()Int">remaining</span> <span title="(x: Int)Int">+</span> <span title="Int(4)" class="int">4</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
  * Asynchrounously send the data as part of a bulk loading. This means
  * that there is no guarantee when the data will be placed in the
  * send queues. This is meant to be used in a loop where you are trying
  * to send many byte arrays at once. Also there is no callback support
  * here because bulk sends are lumped together into one byte buffer,
  * so the semantics of callbacks don't really make sense
  */</span>
  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit" id="58206">sendBulk</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60377">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="java.nio.ByteBuffer" id="60378">data</a>: <span title="java.nio.ByteBuffer">ByteBuffer</span>, <a title="Boolean" id="60379">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">//TODO: be more robust and actually slice up the data appropriate</span>
    <span class="comment">// instead of just mandating it fit into one buffer. However as a</span>
    <span class="comment">// general rule of thumb this isn't that important, because there's</span>
    <span class="comment">// really no need to buffer like this unless size of data buffer is</span>
    <span class="comment">// much smaller than size of internal buffer</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58205" title="(data: java.nio.ByteBuffer, encode: Boolean)Int">sizeOfMessage</a><span class="delimiter">(</span><a href="#60378" title="java.nio.ByteBuffer">data</a>, <a href="#60379" title="Boolean">encode</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <a href="#58166" title="=&gt; Int">bulkBufferSize</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Need to increase the bulk buffer size&quot;)" class="string">&quot;Need to increase the bulk buffer size&quot;</span><span class="delimiter">)</span>
    <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="java.io.ByteArrayOutputStream" id="60391">buffer</a> = <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: Any)java.io.ByteArrayOutputStream">get</span><span class="delimiter">(</span><a href="#60377" title="java.nio.channels.SocketChannel">socket</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">//logger.debug(&quot;buffer was null, so allocating&quot;)</span>
        <a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a> = <span title="(x$1: Int)java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span><span class="delimiter">(</span><a href="#58166" title="=&gt; Int">bulkBufferSize</a><span class="delimiter">)</span>
        <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: java.nio.channels.SocketChannel, x$2: java.io.ByteArrayOutputStream)java.io.ByteArrayOutputStream">put</span><span class="delimiter">(</span><a href="#60377" title="java.nio.channels.SocketChannel">socket</a>, <a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="comment">//logger.debug(&quot;--&quot;)</span>
      <span class="comment">//logger.debug(&quot;sizeOfMessage: &quot; + sizeOfMessage(data, encode))</span>
      <span class="comment">//logger.debug(&quot;remaining: &quot; + buffer.remaining)</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58205" title="(data: java.nio.ByteBuffer, encode: Boolean)Int">sizeOfMessage</a><span class="delimiter">(</span><a href="#60378" title="java.nio.ByteBuffer">data</a>,<a href="#60379" title="Boolean">encode</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <a href="#58166" title="=&gt; Int">bulkBufferSize</a> <span title="(x: Int)Int">-</span> <a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// buffer is full, flush it and clear</span>
        <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;flushing and realloc buffer&quot;)" class="string">&quot;flushing and realloc buffer&quot;</span><span class="delimiter">)</span>
        <a href="#58202" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#60377" title="java.nio.channels.SocketChannel">socket</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <span class="comment">// no encoding since we already did</span>
        <a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Unit">reset</span>
      <span class="delimiter">}</span>

      <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="60392">toPut</a> = <a href="#60379" title="Boolean">encode</a> <span title="java.nio.ByteBuffer" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="java.nio.ByteBuffer" class="keyword">false</span> =&gt; <a href="#60378" title="java.nio.ByteBuffer">data</a>
        <span class="keyword">case</span> <span title="java.nio.ByteBuffer" class="keyword">true</span>  =&gt; <a href="#58200" title="(data: java.nio.ByteBuffer)java.nio.ByteBuffer">encodeByteBuffer</a><span class="delimiter">(</span><a href="#60378" title="java.nio.ByteBuffer">data</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="comment">//logger.debug(&quot;toPut size: &quot; + toPut.remaining)</span>
      <span class="comment">//logger.debug(&quot;buffer remaining size: &quot; + buffer.remaining)</span>
      <a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="(x$1: Array[Byte])Unit">write</span><span class="delimiter">(</span><a href="#60392" title="java.nio.ByteBuffer">toPut</a>.<span title="()Array[Byte]">array</span><span class="delimiter">)</span>

      <span class="comment">//logger.debug(&quot;after: &quot; + buffer.remaining)</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#58166" title="=&gt; Int">bulkBufferSize</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;flushing and removing buffer&quot;)" class="string">&quot;flushing and removing buffer&quot;</span><span class="delimiter">)</span>
        <a href="#58202" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#60377" title="java.nio.channels.SocketChannel">socket</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
        <a href="#60391" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Unit">reset</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel, data: Array[Byte], encode: Boolean)Unit" id="58207">sendBulk</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60454">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span>, <a title="Array[Byte]" id="60455">data</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Boolean" id="60456">encode</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> =
    <a href="#58206" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit">sendBulk</a><span class="delimiter">(</span><a href="#60454" title="java.nio.channels.SocketChannel">socket</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#60455" title="Array[Byte]">data</a><span class="delimiter">)</span>,<a href="#60456" title="Boolean">encode</a><span class="delimiter">)</span>


  <span class="comment">/**
  * Flush any internal buffering and put whatever is left in the buffer
  * into the send queues. This should be called only after you make a
  * sequeence of calls to sendBulk
  */</span>
  <span class="keyword">def</span> <a title="(socket: java.nio.channels.SocketChannel)Any" id="58208">flushBulk</a><span class="delimiter">(</span><a title="java.nio.channels.SocketChannel" id="60466">socket</a>: <span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: Any)Any">synchronized</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="60471">buffer</a> = <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: Any)java.io.ByteArrayOutputStream">get</span><span class="delimiter">(</span><a href="#60466" title="java.nio.channels.SocketChannel">socket</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#60471" title="java.io.ByteArrayOutputStream">buffer</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#58202" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#60466" title="java.nio.channels.SocketChannel">socket</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#60471" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
        <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: Any)java.io.ByteArrayOutputStream">remove</span><span class="delimiter">(</span><a href="#60466" title="java.nio.channels.SocketChannel">socket</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="58209">flushAllBulk</a> = <span class="delimiter">{</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;flushAllBulk() called&quot;)" class="string">&quot;flushAllBulk() called&quot;</span><span class="delimiter">)</span>
    <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.util.Iterator[java.nio.channels.SocketChannel]" id="60501">iter</a> = <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="()java.util.Set[java.nio.channels.SocketChannel]">keySet</span>.<span title="()java.util.Iterator[java.nio.channels.SocketChannel]">iterator</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#60501" title="java.util.Iterator[java.nio.channels.SocketChannel]">iter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">)</span> <a href="#60502" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="60505">socket</a> = <a href="#60501" title="java.util.Iterator[java.nio.channels.SocketChannel]">iter</a>.<span title="()java.nio.channels.SocketChannel">next</span>
        <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="60506">buffer</a> = <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="(x$1: Any)java.io.ByteArrayOutputStream">get</span><span class="delimiter">(</span><a href="#60505" title="java.nio.channels.SocketChannel">socket</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60506" title="java.io.ByteArrayOutputStream">buffer</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>  <span class="delimiter">{</span>
          <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;socket &quot;)" class="string">&quot;socket &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60505" title="java.nio.channels.SocketChannel">socket</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; has non-empty buffer&quot;)" class="string">&quot; has non-empty buffer&quot;</span><span class="delimiter">)</span>
          <a href="#58202" title="(socket: java.nio.channels.SocketChannel, data: java.nio.ByteBuffer, encode: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#60505" title="java.nio.channels.SocketChannel">socket</a>, <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#60506" title="java.io.ByteArrayOutputStream">buffer</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#58176" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,java.io.ByteArrayOutputStream]">bulkBufferQueue</a>.<span title="()Unit">clear</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()java.net.InetAddress" id="58210">getListeningAddr</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="java.net.InetAddress">InetAddress</span> = <span class="delimiter">{</span>
    <a href="#9921" title="(x$1: java.net.InetAddress)java.net.InetAddress">synchronized</a> <span class="delimiter">{</span>
      <span title="java.net.InetAddress" class="keyword">if</span> <span class="delimiter">(</span><a href="#58159" title="=&gt; Boolean">isListening</a><span class="delimiter">)</span>
        <a href="#58153" title="=&gt; java.nio.channels.ServerSocketChannel">serverChannel</a>.<span title="()java.net.ServerSocket">socket</span>.<span title="()java.net.InetAddress">getInetAddress</span>
      <span class="keyword">else</span>
        <span title="Null(null)" class="keyword">null</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Int" id="58211">getListeningPort</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    <a href="#9921" title="(x$1: Int)Int">synchronized</a> <span class="delimiter">{</span>
      <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#58159" title="=&gt; Boolean">isListening</a><span class="delimiter">)</span>
        <a href="#58153" title="=&gt; java.nio.channels.ServerSocketChannel">serverChannel</a>.<span title="()java.net.ServerSocket">socket</span>.<span title="()Int">getLocalPort</span>
      <span class="keyword">else</span>
        <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(hostAddress: java.net.InetSocketAddress)Unit" id="58212">serve</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="60580">hostAddress</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#9921" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58159" title="=&gt; Boolean">isListening</a><span class="delimiter">)</span> <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Already listening&quot;)" class="string">&quot;Already listening&quot;</span><span class="delimiter">)</span>

      <a href="#58153" title="(x$1: java.nio.channels.ServerSocketChannel)Unit">serverChannel</a> = <span title="object java.nio.channels.ServerSocketChannel">ServerSocketChannel</span>.<span title="()java.nio.channels.ServerSocketChannel">open</span>
      <a href="#58153" title="=&gt; java.nio.channels.ServerSocketChannel">serverChannel</a>.<span title="(x$1: Boolean)java.nio.channels.SelectableChannel">configureBlocking</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
      <a href="#58153" title="=&gt; java.nio.channels.ServerSocketChannel">serverChannel</a>.<span title="()java.net.ServerSocket">socket</span>.<span title="(x$1: java.net.SocketAddress)Unit">bind</span><span class="delimiter">(</span><a href="#60580" title="java.net.InetSocketAddress">hostAddress</a><span class="delimiter">)</span>
      <span class="keyword">var</span> <a title="Boolean" id="60585">shouldInitialize</a> = <span title="Boolean(false)" class="keyword">false</span>
      <a href="#9921" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#58156" title="=&gt; Boolean">initialized</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#60585" title="Boolean">shouldInitialize</a> = <span title="Boolean(true)" class="keyword">true</span>
          <a href="#58156" title="(x$1: Boolean)Unit">initialized</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#60585" title="Boolean">shouldInitialize</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#58153" title="=&gt; java.nio.channels.ServerSocketChannel">serverChannel</a>.<span title="(x$1: java.nio.channels.Selector, x$2: Int)java.nio.channels.SelectionKey">register</span><span class="delimiter">(</span><a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>, SelectionKey.<span title="Int(16)">OP_ACCEPT</span><span class="delimiter">)</span>
        <a href="#58195" title="=&gt; Unit">fireWriteAndSelectLoop</a>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#58178" title="=&gt; java.util.LinkedList[NioEndpoint.this.RegisterEntry]">registerQueue</a>.<span title="(x$1: Boolean)Boolean">synchronized</span> <span class="delimiter">{</span>
          <a href="#58178" title="=&gt; java.util.LinkedList[NioEndpoint.this.RegisterEntry]">registerQueue</a>.<span title="(x$1: NioEndpoint.this.RegisterEntry)Boolean">add</span><span class="delimiter">(</span><span title="NioEndpoint.this.RegisterEntry" class="keyword">new</span> <a href="#59050" title="NioEndpoint.this.RegisterEntry">RegisterEntry</a><span class="delimiter">(</span><a href="#58153" title="=&gt; java.nio.channels.ServerSocketChannel">serverChannel</a>, <span title="Null(null)" class="keyword">null</span>, SelectionKey.<span title="Int(16)">OP_ACCEPT</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>.<span title="()java.nio.channels.Selector">wakeup</span>
      <span class="delimiter">}</span>
      <a href="#58159" title="(x$1: Boolean)Unit">isListening</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Now serving on: &quot;)" class="string">&quot;Now serving on: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60580" title="java.net.InetSocketAddress">hostAddress</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: java.nio.channels.SelectionKey)Unit" id="58213">accept</a><span class="delimiter">(</span><a title="java.nio.channels.SelectionKey" id="60138">key</a>: <span title="java.nio.channels.SelectionKey">SelectionKey</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;accept() called with: &quot;)" class="string">&quot;accept() called with: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60138" title="java.nio.channels.SelectionKey">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.nio.channels.ServerSocketChannel" id="60629">serverSocketChannel</a> = <a href="#60138" title="java.nio.channels.SelectionKey">key</a>.<span title="()java.nio.channels.SelectableChannel">channel</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.nio.channels.ServerSocketChannel" class="delimiter">[</span><span title="java.nio.channels.ServerSocketChannel">ServerSocketChannel</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="60630">socketChannel</a> = <a href="#60629" title="java.nio.channels.ServerSocketChannel">serverSocketChannel</a>.<span title="()java.nio.channels.SocketChannel">accept</span>
    <a href="#60630" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="(x$1: Boolean)java.nio.channels.SelectableChannel">configureBlocking</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <a href="#60630" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="()java.net.Socket">socket</span>.<span title="(x$1: Boolean)Unit">setTcpNoDelay</span><span class="delimiter">(</span><a href="#58186" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span>
    <a href="#60630" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="(x$1: java.nio.channels.Selector, x$2: Int)java.nio.channels.SelectionKey">register</span><span class="delimiter">(</span><a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>, SelectionKey.<span title="Int(1)">OP_READ</span><span class="delimiter">)</span>
    <a href="#58184" title="(addr: java.net.InetSocketAddress, chan: java.nio.channels.SocketChannel)java.nio.channels.SocketChannel">registerInetSocketAddress</a><span class="delimiter">(</span><span title="(x$1: java.net.InetAddress, x$2: Int)java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#60630" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="()java.net.Socket">socket</span>.<span title="()java.net.InetAddress">getInetAddress</span>, <a href="#60630" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="()java.net.Socket">socket</span>.<span title="()Int">getPort</span><span class="delimiter">)</span>, <a href="#60630" title="java.nio.channels.SocketChannel">socketChannel</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58147" title="=&gt; edu.berkeley.cs.scads.comm.NioAcceptEventHandler">acceptEventHandler</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#58147" title="=&gt; edu.berkeley.cs.scads.comm.NioAcceptEventHandler">acceptEventHandler</a>.<a href="interfaces.scala.html#58307" title="(channel: java.nio.channels.SocketChannel)Unit">acceptEvent</a><span class="delimiter">(</span><a href="#60630" title="java.nio.channels.SocketChannel">socketChannel</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: java.nio.channels.SelectionKey)Unit" id="58214">connect</a><span class="delimiter">(</span><a title="java.nio.channels.SelectionKey" id="60146">key</a>: <span title="java.nio.channels.SelectionKey">SelectionKey</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;connect() called with: %s&quot;)" class="string">&quot;connect() called with: %s&quot;</span>, <a href="#60146" title="java.nio.channels.SelectionKey">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="60745">socketChannel</a> = <a href="#60146" title="java.nio.channels.SelectionKey">key</a>.<span title="()java.nio.channels.SelectableChannel">channel</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.nio.channels.SocketChannel" class="delimiter">[</span><span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">]</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <a href="#60745" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="()Boolean">finishConnect</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Nothing" id="60750">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
        <span class="comment">// Cancel the channel's registration with our selector</span>
        <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;failed to connect to %s with error: %s&quot;)" class="string">&quot;failed to connect to %s with error: %s&quot;</span>, <a href="#60146" title="java.nio.channels.SelectionKey">key</a>.<span title="()java.nio.channels.SelectableChannel">channel</span>, <a href="#60750" title="java.io.IOException">e</a>.<span title="()java.lang.String">getMessage</span><span class="delimiter">)</span>
      <a href="#60146" title="java.nio.channels.SelectionKey">key</a>.<span title="()Unit">cancel</span>
      <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;trying to register OP_READ interest&quot;)" class="string">&quot;trying to register OP_READ interest&quot;</span><span class="delimiter">)</span>
    <a href="#60146" title="java.nio.channels.SelectionKey">key</a>.<span title="(x$1: Int)java.nio.channels.SelectionKey">interestOps</span><span class="delimiter">(</span>SelectionKey.<span title="Int(1)">OP_READ</span><span class="delimiter">)</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;registing INET socket address now&quot;)" class="string">&quot;registing INET socket address now&quot;</span><span class="delimiter">)</span>
    <a href="#58184" title="(addr: java.net.InetSocketAddress, chan: java.nio.channels.SocketChannel)java.nio.channels.SocketChannel">registerInetSocketAddress</a><span class="delimiter">(</span>
      <span title="(x$1: java.net.InetAddress, x$2: Int)java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#60745" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="()java.net.Socket">socket</span>.<span title="()java.net.InetAddress">getInetAddress</span>,<a href="#60745" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="()java.net.Socket">socket</span>.<span title="()Int">getPort</span><span class="delimiter">)</span>,
      <a href="#60745" title="java.nio.channels.SocketChannel">socketChannel</a><span class="delimiter">)</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;calling event handler&quot;)" class="string">&quot;calling event handler&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58150" title="=&gt; edu.berkeley.cs.scads.comm.NioConnectEventHandler">connectEventHandler</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#58150" title="=&gt; edu.berkeley.cs.scads.comm.NioConnectEventHandler">connectEventHandler</a>.<a href="interfaces.scala.html#58309" title="(channel: java.nio.channels.SocketChannel)Unit">connectEvent</a><span class="delimiter">(</span><a href="#60745" title="java.nio.channels.SocketChannel">socketChannel</a><span class="delimiter">)</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;calling finished() on future&quot;)" class="string">&quot;calling finished() on future&quot;</span><span class="delimiter">)</span>
    <a href="#60146" title="java.nio.channels.SelectionKey">key</a>.<span title="()java.lang.Object">attachment</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="NioEndpoint.this.ConnectFuture" class="delimiter">[</span><a href="#58194" title="NioEndpoint.this.ConnectFuture">ConnectFuture</a><span class="delimiter">]</span>.<a href="#59414" title="=&gt; Unit">finished</a>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;connect is now finished&quot;)" class="string">&quot;connect is now finished&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
  * Connect is thread safe
  */</span>
  <span class="keyword">def</span> <a title="(hostAddress: java.net.InetSocketAddress)NioEndpoint.this.ConnectFuture" id="58215">connect</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="60144">hostAddress</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span>:<a href="#58194" title="NioEndpoint.this.ConnectFuture">ConnectFuture</a> = <span class="delimiter">{</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Connecting to %s&quot;)" class="string">&quot;Connecting to %s&quot;</span>, <a href="#60144" title="java.net.InetSocketAddress">hostAddress</a><span class="delimiter">)</span>
    <a href="#9921" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#58156" title="=&gt; Boolean">initialized</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#58195" title="=&gt; Unit">fireWriteAndSelectLoop</a>
        <a href="#58156" title="(x$1: Boolean)Unit">initialized</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="60777">clientSocket</a> = <span title="object java.nio.channels.SocketChannel">SocketChannel</span>.<span title="()java.nio.channels.SocketChannel">open</span>
    <a href="#60777" title="java.nio.channels.SocketChannel">clientSocket</a>.<span title="()java.net.Socket">socket</span>.<span title="(x$1: Boolean)Unit">setTcpNoDelay</span><span class="delimiter">(</span><a href="#58186" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span>
    <a href="#60777" title="java.nio.channels.SocketChannel">clientSocket</a>.<span title="(x$1: Boolean)java.nio.channels.SelectableChannel">configureBlocking</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Boolean" id="60778">connected</a> = <a href="#60777" title="java.nio.channels.SocketChannel">clientSocket</a>.<span title="(x$1: java.net.SocketAddress)Boolean">connect</span><span class="delimiter">(</span><a href="#60144" title="java.net.InetSocketAddress">hostAddress</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="NioEndpoint.this.ConnectFuture" id="60779">future</a> = <span title="NioEndpoint.this.ConnectFuture" class="keyword">new</span> <a href="#58194" title="NioEndpoint.this.ConnectFuture">ConnectFuture</a><span class="delimiter">(</span><a href="#60777" title="java.nio.channels.SocketChannel">clientSocket</a>, <a href="#60778" title="Boolean">connected</a><span class="delimiter">)</span>
    <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><a href="#60778" title="Boolean">connected</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Connected!&quot;)" class="string">&quot;Connected!&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not connected, deferring connection&quot;)" class="string">&quot;Not connected, deferring connection&quot;</span><span class="delimiter">)</span>
      <span class="comment">//clientSocket.register(selector, SelectionKey.OP_CONNECT, future)</span>
      <a href="#58178" title="=&gt; java.util.LinkedList[NioEndpoint.this.RegisterEntry]">registerQueue</a>.<span title="(x$1: Boolean)Boolean">synchronized</span> <span class="delimiter">{</span>
        <a href="#58178" title="=&gt; java.util.LinkedList[NioEndpoint.this.RegisterEntry]">registerQueue</a>.<span title="(x$1: NioEndpoint.this.RegisterEntry)Boolean">add</span><span class="delimiter">(</span><span title="NioEndpoint.this.RegisterEntry" class="keyword">new</span> <a href="#59050" title="NioEndpoint.this.RegisterEntry">RegisterEntry</a><span class="delimiter">(</span><a href="#60777" title="java.nio.channels.SocketChannel">clientSocket</a>, <a href="#60779" title="NioEndpoint.this.ConnectFuture">future</a>, SelectionKey.<span title="Int(8)">OP_CONNECT</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#58144" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;waking up selector&quot;)" class="string">&quot;waking up selector&quot;</span><span class="delimiter">)</span>
    <a href="#58161" title="=&gt; java.nio.channels.spi.AbstractSelector">selector</a>.<span title="()java.nio.channels.Selector">wakeup</span>
    <a href="#60779" title="NioEndpoint.this.ConnectFuture">future</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: java.nio.channels.SelectionKey)Unit" id="58216">read</a><span class="delimiter">(</span><a title="java.nio.channels.SelectionKey" id="60150">key</a>: <span title="java.nio.channels.SelectionKey">SelectionKey</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">//logger.debug(&quot;read() called on channel: &quot; + key.channel)</span>
    <span class="keyword">val</span> <a title="java.nio.channels.SocketChannel" id="60812">socketChannel</a> = <a href="#60150" title="java.nio.channels.SelectionKey">key</a>.<span title="()java.nio.channels.SelectableChannel">channel</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.nio.channels.SocketChannel" class="delimiter">[</span><span title="java.nio.channels.SocketChannel">SocketChannel</span><span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="NioEndpoint.this.ChannelState" id="60813">channelState</a> = <a href="#58182" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,NioEndpoint.this.ChannelState]">channelQueue</a>.<span title="(x$1: Any)NioEndpoint.this.ChannelState">get</span><span class="delimiter">(</span><a href="#60812" title="java.nio.channels.SocketChannel">socketChannel</a><span class="delimiter">)</span>
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a> = <a href="#59278" title="(buffer: edu.berkeley.cs.scads.comm.CircularByteBuffer)NioEndpoint.this.ChannelState" class="keyword">new</a> <a href="#59265" title="NioEndpoint.this.ChannelState">ChannelState</a><span class="delimiter">(</span><a href="CircularByteBuffer.scala.html#59518" title="()edu.berkeley.cs.scads.comm.CircularByteBuffer" class="keyword">new</a> <a href="CircularByteBuffer.scala.html#9925" title="edu.berkeley.cs.scads.comm.CircularByteBuffer">CircularByteBuffer</a><span class="delimiter">)</span>
      <a href="#58182" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,NioEndpoint.this.ChannelState]">channelQueue</a>.<span title="(x$1: java.nio.channels.SocketChannel, x$2: NioEndpoint.this.ChannelState)NioEndpoint.this.ChannelState">put</span><span class="delimiter">(</span><a href="#60812" title="java.nio.channels.SocketChannel">socketChannel</a>, <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#58163" title="=&gt; java.nio.ByteBuffer">readBuffer</a>.<span title="()java.nio.Buffer">clear</span>
    <span class="keyword">var</span> <a title="Int" id="60814">numRead</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <a href="#60814" title="Int">numRead</a> = <a href="#60812" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="(x$1: java.nio.ByteBuffer)Int">read</span><span class="delimiter">(</span><a href="#58163" title="=&gt; java.nio.ByteBuffer">readBuffer</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Nothing" id="60843">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
        <span class="comment">// The remote forcibly closed the connection, cancel</span>
        <span class="comment">// the selection key and close the channel.</span>
        <a href="#58182" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,NioEndpoint.this.ChannelState]">channelQueue</a>.<span title="(x$1: Any)NioEndpoint.this.ChannelState">remove</span><span class="delimiter">(</span><a href="#60812" title="java.nio.channels.SocketChannel">socketChannel</a><span class="delimiter">)</span>
      <a href="#60150" title="java.nio.channels.SelectionKey">key</a>.<span title="()Unit">cancel</span>
      <a href="#60812" title="java.nio.channels.SocketChannel">socketChannel</a>.<span title="()Unit">close</span>
      <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60814" title="Int">numRead</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// Remote entity shut the socket down cleanly. Do the</span>
      <span class="comment">// same from our end and cancel the channel.</span>
      <a href="#58182" title="=&gt; java.util.HashMap[java.nio.channels.SocketChannel,NioEndpoint.this.ChannelState]">channelQueue</a>.<span title="(x$1: Any)NioEndpoint.this.ChannelState">remove</span><span class="delimiter">(</span><a href="#60812" title="java.nio.channels.SocketChannel">socketChannel</a><span class="delimiter">)</span>
      <a href="#60150" title="java.nio.channels.SelectionKey">key</a>.<span title="()java.nio.channels.SelectableChannel">channel</span>.<span title="()Unit">close</span>
      <a href="#60150" title="java.nio.channels.SelectionKey">key</a>.<span title="()Unit">cancel</span>
      <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Array[Byte]" id="60815">readByteArray</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><a href="#60814" title="Int">numRead</a><span class="delimiter">)</span>
    <a href="#58163" title="=&gt; java.nio.ByteBuffer">readBuffer</a>.<span title="()java.nio.Buffer">rewind</span>
    <a href="#58163" title="=&gt; java.nio.ByteBuffer">readBuffer</a>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">get</span><span class="delimiter">(</span><a href="#60815" title="Array[Byte]">readByteArray</a><span class="delimiter">)</span>

    <span class="comment">//logger.debug(&quot;read(): &quot;)</span>
    <span class="comment">//(0 until readByteArray.length).foreach( i =&gt; {</span>
    <span class="comment">//    logger.debug(&quot;    pos(&quot;+i+&quot;):&quot; + (0xFF &amp; readByteArray(i).toInt))</span>
    <span class="comment">//})</span>
    <span class="comment">//logger.debug(&quot;--&quot;)</span>

    <span class="comment">// read data into queue</span>
    <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61000" title="=&gt; edu.berkeley.cs.scads.comm.CircularByteBuffer">buffer</a>.<a href="CircularByteBuffer.scala.html#59519" title="(toAppend: Array[Byte])Unit">append</a><span class="delimiter">(</span><a href="#60815" title="Array[Byte]">readByteArray</a><span class="delimiter">)</span>

    <span class="comment">// process as much of the buffer as possible given the data so far</span>
    <span class="keyword">var</span> <a title="Boolean" id="60816">shouldContinue</a> = <span title="=&gt; Boolean">!</span><a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61000" title="=&gt; edu.berkeley.cs.scads.comm.CircularByteBuffer">buffer</a>.<a href="CircularByteBuffer.scala.html#59524" title="=&gt; Boolean">isEmpty</a>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#60816" title="Boolean">shouldContinue</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#60967" title="Unit" class="keyword">if</a> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61001" title="=&gt; Boolean">inMessage</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61000" title="=&gt; edu.berkeley.cs.scads.comm.CircularByteBuffer">buffer</a>.<a href="CircularByteBuffer.scala.html#59523" title="=&gt; Int">size</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Int" id="60972">messageSize</a> = <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61000" title="=&gt; edu.berkeley.cs.scads.comm.CircularByteBuffer">buffer</a>.<a href="CircularByteBuffer.scala.html#59521" title="=&gt; Int">consumeInt</a>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60972" title="Int">messageSize</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">throw</span> <span title="NioEndpoint.this.InvalidMessageSizeException" class="keyword">new</span> <a href="#59646" title="NioEndpoint.this.InvalidMessageSizeException">InvalidMessageSizeException</a><span class="delimiter">(</span><a href="#60972" title="Int">messageSize</a><span class="delimiter">)</span>
        <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61001" title="(x$1: Boolean)Unit">inMessage</a> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61002" title="(x$1: Int)Unit">messageSize</a> = <a href="#60972" title="Int">messageSize</a>
        <span class="comment">//logger.debug(&quot;read(): found messageSize: &quot; + messageSize)</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61001" title="=&gt; Boolean">inMessage</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61000" title="=&gt; edu.berkeley.cs.scads.comm.CircularByteBuffer">buffer</a>.<a href="CircularByteBuffer.scala.html#59523" title="=&gt; Int">size</a> <span title="(x: Int)Boolean">&gt;=</span> <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61002" title="=&gt; Int">messageSize</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="60983">message</a> = <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61000" title="=&gt; edu.berkeley.cs.scads.comm.CircularByteBuffer">buffer</a>.<a href="CircularByteBuffer.scala.html#59520" title="(length: Int)Array[Byte]">consumeBytes</a><span class="delimiter">(</span><a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61002" title="=&gt; Int">messageSize</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Int" id="60984">size</a> = <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#61002" title="=&gt; Int">messageSize</a>
        <a href="#59330" title="=&gt; edu.berkeley.cs.scads.comm.ChannelHandler">channelHandler</a>.<a href="interfaces.scala.html#28246" title="(socket: java.nio.channels.SocketChannel, data: Array[Byte], count: Int)Unit">processData</a><span class="delimiter">(</span><a href="#60812" title="java.nio.channels.SocketChannel">socketChannel</a>, <a href="#60983" title="Array[Byte]">message</a>, <a href="#60984" title="Int">size</a><span class="delimiter">)</span>
        <a href="#60813" title="NioEndpoint.this.ChannelState">channelState</a>.<a href="#59279" title="=&gt; Unit">reset</a>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#60816" title="Boolean">shouldContinue</a> = <span title="Boolean(false)" class="keyword">false</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>