<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>oio/BlockingChannelManager.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm
<span class="keyword">package</span> oio

<span class="keyword">import</span> java.io._
<span class="keyword">import</span> java.net._
<span class="keyword">import</span> java.util.concurrent._
<span class="keyword">import</span> atomic._

<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> io._
<span class="keyword">import</span> specific._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> scala.reflect.<span title="object scala.reflect.Manifest">Manifest</span>.classType
<span class="keyword">import</span> edu.berkeley.cs.scads.config._

<span class="comment">/**
 * Easier to instantiate via reflection
 */</span>
<span class="keyword">class</span> <a title="class DefaultBlockingChannelManager[S &lt;: org.apache.avro.specific.SpecificRecord, R &lt;: org.apache.avro.specific.SpecificRecord] extends edu.berkeley.cs.scads.comm.oio.BlockingChannelManager[S,R] with ScalaObject" id="9969">DefaultBlockingChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9970">S</a> &lt;: SpecificRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9971">R</a> &lt;: SpecificRecord<span class="delimiter">]</span><a href="#9969" title="ScalaObject" class="delimiter">(</a>
    <a title="(edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], edu.berkeley.cs.scads.comm.RemoteNode, R) =&gt; Unit" id="61917">recvMsg</a>: <span class="delimiter">(</span>AvroChannelManager<span class="delimiter">[</span>S, R<span class="delimiter">]</span>, RemoteNode, R<span class="delimiter">)</span> =&gt; Unit, <a title="Class[S]" id="61918">sendClz</a>: <span title="Class[S]">Class</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="Class[R]" id="61919">recvClz</a>: <span title="Class[R]">Class</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <a href="#9972" title="edu.berkeley.cs.scads.comm.oio.BlockingChannelManager[S,R]">BlockingChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">(</span><span title="(clazz: Class[_])scala.reflect.Manifest[S]">classType</span><span class="delimiter">(</span><a href="#61918" title="Class[S]">sendClz</a><span class="delimiter">)</span>, <span title="(clazz: Class[_])scala.reflect.Manifest[R]">classType</span><span class="delimiter">(</span><a href="#61919" title="Class[R]">recvClz</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(remoteNode: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit" id="61912">receiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="61952">remoteNode</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="R" id="61953">msg</a>: <a href="#9971" title="R">R</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#61917" title="(v1: edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], v2: edu.berkeley.cs.scads.comm.RemoteNode, v3: R)Unit">recvMsg</a><span class="delimiter">(</span><a href="#9969" title="edu.berkeley.cs.scads.comm.oio.DefaultBlockingChannelManager[S,R]" class="keyword">this</a>, <a href="#61952" title="edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#61953" title="R">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class BlockingChannelManager[S &lt;: org.apache.avro.specific.SpecificRecord, R &lt;: org.apache.avro.specific.SpecificRecord] extends java.lang.Object with edu.berkeley.cs.scads.comm.AvroChannelManager[S,R] with ScalaObject" id="9972">BlockingChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9973">S</a> &lt;: SpecificRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9974">R</a> &lt;: SpecificRecord<span class="delimiter">]</span><a href="#9972" title="ScalaObject" class="delimiter">(</a>
    <span class="keyword">implicit</span> <a title="Manifest[S]" id="61920">sendManifest</a>: <span title="Manifest[S]">Manifest</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="Manifest[R]" id="61921">recvManifest</a>: <span title="Manifest[R]">Manifest</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="../AvroChannelManager.scala.html#9509" title="edu.berkeley.cs.scads.comm.AvroChannelManager[S,R]">AvroChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span> <span class="delimiter">{</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="61864">log</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Boolean" id="61867">useTcpNoDelay</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>.<span title="(key: String, defaultValue: Boolean)Boolean">getBool</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.comm.tcpNoDelay&quot;)" class="string">&quot;scads.comm.tcpNoDelay&quot;</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  <span class="comment">// Avro serialization</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Class[R]" id="61868">msgRecvClass</a> = <a href="#61921" title="Manifest[R]">recvManifest</a>.<span title="=&gt; java.lang.Class[_]">erasure</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[R]" class="delimiter">[</span><span title="Class[R]">Class</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Class[S]" id="61870">msgSendClass</a> = <a href="#61920" title="Manifest[S]">sendManifest</a>.<span title="=&gt; java.lang.Class[_]">erasure</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[S]" class="delimiter">[</span><span title="Class[S]">Class</span><span class="delimiter">[</span>S<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumReader[R]" id="61872">msgReader</a> = 
    <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumReader[R]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumReader[R]">SpecificDatumReader</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">(</span><a href="#61868" title="=&gt; Class[R]">msgRecvClass</a>.<span title="()R">newInstance</span>.<span title="()org.apache.avro.Schema">getSchema</span><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumWriter[S]" id="61874">msgWriter</a> = 
    <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumWriter[S]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumWriter[S]">SpecificDatumWriter</span><span class="delimiter">[</span>S<span class="delimiter">]</span><span class="delimiter">(</span><a href="#61870" title="=&gt; Class[S]">msgSendClass</a>.<span title="()S">newInstance</span>.<span title="()org.apache.avro.Schema">getSchema</span><span class="delimiter">)</span>

  <span class="comment">// Thread pools</span>

  <span class="comment">/** Thread pool for ServerSockets */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="61876">listenerPool</a> = 
    <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span>

  <span class="comment">/** Thread pool for Sockets */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="61878">connectionPool</a> =
    <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span> <span class="comment">// TODO: configure</span>

  <span class="comment">/** Thread pool for processing send queues */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="61880">sendQueuePool</a> =
    <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span> <span class="comment">// TODO: configure</span>

  <span class="comment">// Connection/Listener management</span>

  <span class="comment">/** Used to manage open connections */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]" id="61882">nodeToConnections</a> = 
    <span title="()java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">ConcurrentHashMap</span><span class="delimiter">[</span>InetSocketAddress, Connection<span class="delimiter">]</span>

  <span class="comment">/** Used to manage open ports */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]" id="61884">portToListeners</a> =
    <span title="()java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">ConcurrentHashMap</span><span class="delimiter">[</span>Int, Listener<span class="delimiter">]</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="61886">sendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="62324">dest</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="62325">msg</a>: <a href="#9973" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#61888" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S, flush: Boolean)Unit">doSendMessage</a><span class="delimiter">(</span><a href="#62324" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>, <a href="#62325" title="S">msg</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="61887">sendMessageBulk</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="62333">dest</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="62334">msg</a>: <a href="#9973" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#61888" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S, flush: Boolean)Unit">doSendMessage</a><span class="delimiter">(</span><a href="#62333" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>, <a href="#62334" title="S">msg</a>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S, flush: Boolean)Unit" id="61888">doSendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="62329">dest</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="62330">msg</a>: <a href="#9973" title="S">S</a>, <a title="Boolean" id="62331">flush</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream" id="62338">os</a>      = <span title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream" class="keyword">new</span> <a href="PreallocByteArrayOutputStream.scala.html#9979" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">PreallocByteArrayOutputStream</a><span class="delimiter">(</span><span title="Int(4)" class="int">4</span>, <span title="Int(512)" class="int">512</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryEncoder" id="62339">encoder</a> = <span title="object org.apache.avro.io.EncoderFactory">EncoderFactory</span>.<span title="()org.apache.avro.io.EncoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.OutputStream, x$2: org.apache.avro.io.BinaryEncoder)org.apache.avro.io.BinaryEncoder">binaryEncoder</span><span class="delimiter">(</span><a href="#62338" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>,<span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#61874" title="=&gt; org.apache.avro.specific.SpecificDatumWriter[S]">msgWriter</a>.<span title="(x$1: S, x$2: org.apache.avro.io.Encoder)Unit">write</span><span class="delimiter">(</span><a href="#62330" title="S">msg</a>, <a href="#62339" title="org.apache.avro.io.BinaryEncoder">encoder</a><span class="delimiter">)</span>
    <a href="#62339" title="org.apache.avro.io.BinaryEncoder">encoder</a>.<span title="()Unit">flush</span>

    <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="62340">conn</a> = <a href="#61889" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)BlockingChannelManager.this.Connection">getConnectionFor</a><span class="delimiter">(</span><a href="#62329" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <a href="#62340" title="BlockingChannelManager.this.Connection">conn</a>.<a href="#62163" title="(bytes: Array[Byte], offset: Int, length: Int, flush: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#62338" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>.<a href="PreallocByteArrayOutputStream.scala.html#62349" title="=&gt; Array[Byte]">underlyingBuffer</a>, <a href="#62338" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>.<a href="PreallocByteArrayOutputStream.scala.html#62347" title="=&gt; Int">numPreAllocBytes</a>, <a href="#62338" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>.<a href="PreallocByteArrayOutputStream.scala.html#62348" title="=&gt; Int">effectiveSize</a>, <a href="#62331" title="Boolean">flush</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)BlockingChannelManager.this.Connection" id="61889">getConnectionFor</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="62365">dest</a>: <a href="../AvroChannelManager.scala.html#9506" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="62368">addr</a>  = <a href="#62365" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>.<a href="../AvroChannelManager.scala.html#24034" title="=&gt; java.net.InetSocketAddress">getInetSocketAddress</a>
    <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="62369">conn0</a> = <a href="#61882" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: Any)BlockingChannelManager.this.Connection">get</span><span class="delimiter">(</span><a href="#62368" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
    <span title="BlockingChannelManager.this.Connection" class="keyword">if</span> <span class="delimiter">(</span><a href="#62369" title="BlockingChannelManager.this.Connection">conn0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#62369" title="BlockingChannelManager.this.Connection">conn0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#61882" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: BlockingChannelManager.this.Connection)BlockingChannelManager.this.Connection">synchronized</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="62372">test0</a> = <a href="#61882" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: Any)BlockingChannelManager.this.Connection">get</span><span class="delimiter">(</span><a href="#62368" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
        <span title="BlockingChannelManager.this.Connection" class="keyword">if</span> <span class="delimiter">(</span><a href="#62372" title="BlockingChannelManager.this.Connection">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#62372" title="BlockingChannelManager.this.Connection">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="62373">newConn</a> = <a href="#61893" title="(addr: java.net.InetSocketAddress)BlockingChannelManager.this.Connection">connect</a><span class="delimiter">(</span><a href="#62368" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="62374">ret</a> = <a href="#61882" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: BlockingChannelManager.this.Connection)BlockingChannelManager.this.Connection">put</span><span class="delimiter">(</span><a href="#62368" title="java.net.InetSocketAddress">addr</a>, <a href="#62373" title="BlockingChannelManager.this.Connection">newConn</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#62374" title="BlockingChannelManager.this.Connection">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new connection&quot;)" class="string">&quot;should not have overwritten a new connection&quot;</span><span class="delimiter">)</span>
          <a href="#62373" title="BlockingChannelManager.this.Connection">newConn</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="61890">flush</a> <span title="Unit" class="delimiter">{</span> <span class="comment">/* No-op */</span> <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(port: Int)Unit" id="61891">startListener</a><span class="delimiter">(</span><a title="Int" id="62435">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62435" title="Int">port</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">||</span> <a href="#62435" title="Int">port</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(65535)" class="int">65535</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid port: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62435" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="62437">list0</a> = <a href="#61884" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Any)BlockingChannelManager.this.Listener">get</span><span class="delimiter">(</span><a href="#62435" title="Int">port</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62437" title="BlockingChannelManager.this.Listener">list0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#62437" title="BlockingChannelManager.this.Listener">list0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#61884" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: BlockingChannelManager.this.Listener)BlockingChannelManager.this.Listener">synchronized</span> <span title="Unit" class="delimiter">{</span>
        <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="62455">test0</a> = <a href="#61884" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Any)BlockingChannelManager.this.Listener">get</span><span class="delimiter">(</span><a href="#62435" title="Int">port</a><span class="delimiter">)</span>
        <span title="BlockingChannelManager.this.Listener" class="keyword">if</span> <span class="delimiter">(</span><a href="#62455" title="BlockingChannelManager.this.Listener">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#62455" title="BlockingChannelManager.this.Listener">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="62456">newListener</a> = <a href="#61892" title="(port: Int)BlockingChannelManager.this.Listener">listen</a><span class="delimiter">(</span><a href="#62435" title="Int">port</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="62457">ret</a> = <a href="#61884" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Int, x$2: BlockingChannelManager.this.Listener)BlockingChannelManager.this.Listener">put</span><span class="delimiter">(</span><a href="#62435" title="Int">port</a>, <a href="#62456" title="BlockingChannelManager.this.Listener">newListener</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#62457" title="BlockingChannelManager.this.Listener">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new listener&quot;)" class="string">&quot;should not have overwritten a new listener&quot;</span><span class="delimiter">)</span>
          <a href="#62456" title="BlockingChannelManager.this.Listener">newListener</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(port: Int)BlockingChannelManager.this.Listener" id="61892">listen</a><span class="delimiter">(</span><a title="Int" id="62458">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;starting listener on port %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62458" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// open the socket in the current thread</span>
    <span class="keyword">val</span> <a title="java.net.ServerSocket" id="62461">serverSocket</a> = <span title="(x$1: Int)java.net.ServerSocket" class="keyword">new</span> <span title="java.net.ServerSocket">ServerSocket</span><span class="delimiter">(</span><a href="#62458" title="Int">port</a><span class="delimiter">)</span>
    <span title="BlockingChannelManager.this.Listener" class="keyword">new</span> <a href="#61900" title="BlockingChannelManager.this.Listener">Listener</a><span class="delimiter">(</span><a href="#62461" title="java.net.ServerSocket">serverSocket</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(addr: java.net.InetSocketAddress)BlockingChannelManager.this.Connection" id="61893">connect</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="62375">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#62375" title="java.net.InetSocketAddress">addr</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;opening new connection to address: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62375" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// open the connection in the current thread</span>
    <span class="keyword">val</span> <a title="java.net.Socket" id="62378">socket</a> = <span title="java.net.Socket" class="keyword">new</span> <span title="java.net.Socket">Socket</span>
    <a href="#62378" title="java.net.Socket">socket</a>.<span title="(x$1: Boolean)Unit">setTcpNoDelay</span><span class="delimiter">(</span><a href="#61866" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span>  <span class="comment">// disable Nagle's algorithm</span>
    <a href="#62378" title="java.net.Socket">socket</a>.<span title="(x$1: java.net.SocketAddress, x$2: Int)Unit">connect</span><span class="delimiter">(</span><a href="#62375" title="java.net.InetSocketAddress">addr</a>, <span title="Int(60000)" class="int">60000</span><span class="delimiter">)</span> <span class="comment">// wait up til 1 min for connect</span>

    <span title="BlockingChannelManager.this.Connection" class="keyword">new</span> <a href="#61897" title="BlockingChannelManager.this.Connection">Connection</a><span class="delimiter">(</span><a href="#62378" title="java.net.Socket">socket</a>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">// start send/read threads immediately</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class SendTask extends java.lang.Object with ScalaObject" id="61894">SendTask</a><a href="#61894" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Array[Byte]" id="62499">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Int" id="62500">offset</a>: <span title="Int">Int</span>, <span class="keyword">val</span> <a title="Int" id="62501">length</a>: <span title="Int">Int</span>, <span class="keyword">val</span> <a title="Boolean" id="62502">flush</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]" id="62492">future</a> = <span title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]" class="keyword">new</span> <a href="../Futures.scala.html#9548" title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">BlockingFuture</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span>
  <span class="delimiter">}</span>

  <span class="keyword">trait</span> <a title="trait RunnableHelper extends java.lang.Object with ScalaObject" id="61895">RunnableHelper</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable" id="62165">makeRunnable</a><span class="delimiter">(</span><a title="=&gt; Unit" id="62505">f</a>: =&gt; Unit<span class="delimiter">)</span> = <a href="#62508" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="62508">Runnable</a> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="62510">run</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#62505" title="=&gt; Unit">f</a> <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">trait</span> <a title="trait Stoppable extends java.lang.Object with ScalaObject" id="61896">Stoppable</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicBoolean" id="62135">continue</a> = <span title="java.util.concurrent.atomic.AtomicBoolean" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="62137">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span>  <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="()Unit" id="62138">stop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> 
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62135" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="(x$1: Boolean, x$2: Boolean)Boolean">compareAndSet</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#62137" title="()Unit">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="62139">isRunning</a> = <a href="#62135" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="62140">isStopped</a> = <span title="=&gt; Boolean">!</span><a href="#62135" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span>
    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="62141">ensureRunning</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62140" title="=&gt; Boolean">isStopped</a><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#61896" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd" class="keyword">this</a> <span title="(other: String)java.lang.String">+</span> <span title="java.lang.String(&quot;: Not running&quot;)" class="string">&quot;: Not running&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Takes a valid socket. 
   * Spawns 2 threads- a listening thread, and a sending thread */</span>
  <span class="keyword">class</span> <a title="class Connection extends java.lang.Object with BlockingChannelManager.this.Stoppable with BlockingChannelManager.this.RunnableHelper with ScalaObject" id="61897">Connection</a><a href="#61897" title="ScalaObject" class="delimiter">(</a><a title="java.net.Socket" id="62404">socket</a>: <span title="java.net.Socket">Socket</span>, <a title="Boolean" id="62405">startThreads</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> 
    <span class="keyword">extends</span> <a href="#61896" title="BlockingChannelManager.this.Stoppable">Stoppable</a> <span class="keyword">with</span> <a href="#61895" title="BlockingChannelManager.this.RunnableHelper">RunnableHelper</a> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#62404" title="java.net.Socket">socket</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="62147">remoteAddress</a> = 
      <a href="#61902" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket">socket</a>.<a href="#62547" title="=&gt; java.net.InetSocketAddress">remoteInetSocketAddress</a>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteNode" id="62149">remoteNode</a> = 
      <a href="#61904" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichInetSocketAddress : (addr: java.net.InetSocketAddress)BlockingChannelManager.this.RichInetSocketAddress">remoteAddress</a>.<a href="#62564" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">toRemoteNode</a> 

    <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="62152">localAddress</a> =
      <a href="#61902" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket">socket</a>.<a href="#62548" title="=&gt; java.net.InetSocketAddress">localInetSocketAddress</a>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]" id="62153">sendQueue</a> = <span title="java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]" class="keyword">new</span> <span title="java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">LinkedBlockingQueue</span><span class="delimiter">[</span>SendTask<span class="delimiter">]</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.io.OutputStream" id="62155">outputStream</a> = <a href="#62404" title="java.net.Socket">socket</a>.<span title="()java.io.OutputStream">getOutputStream</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.io.InputStream" id="62157">inputStream</a>  = <a href="#62404" title="java.net.Socket">socket</a>.<span title="()java.io.InputStream">getInputStream</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="62159">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#61882" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: Any)BlockingChannelManager.this.Connection">remove</span><span class="delimiter">(</span><a href="#62147" title="=&gt; java.net.InetSocketAddress">remoteAddress</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62404" title="java.net.Socket">socket</a>.<span title="()Boolean">isConnected</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// find the last task in queue, and wait on its future for up to 5</span>
        <span class="comment">// seconds</span>
        <span class="keyword">val</span> <a title="Array[BlockingChannelManager.this.SendTask with java.lang.Object]" id="62675">view</a> = <a href="#62153" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="(x$1: Array[BlockingChannelManager.this.SendTask with java.lang.Object])Array[BlockingChannelManager.this.SendTask with java.lang.Object]">toArray</span><span class="delimiter">(</span><span title="Array[BlockingChannelManager.this.SendTask]" class="keyword">new</span> <span title="Array[BlockingChannelManager.this.SendTask]">Array</span><span class="delimiter">[</span>SendTask<span class="delimiter">]</span><span class="delimiter">(</span><a href="#62153" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="()Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62675" title="Array[BlockingChannelManager.this.SendTask with java.lang.Object]">view</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="&lt;none&gt; extends BlockingChannelManager.this.SendTask with java.lang.Object" id="62717">last</a> = <a href="#62675" title="(i: Int)BlockingChannelManager.this.SendTask with java.lang.Object">view</a><span class="delimiter">(</span><a href="#62675" title="Array[BlockingChannelManager.this.SendTask with java.lang.Object]">view</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
          <span class="keyword">try</span> <span class="delimiter">{</span>
            <a href="#62717" title="&lt;none&gt; extends BlockingChannelManager.this.SendTask with java.lang.Object">last</a>.<a href="#62492" title="=&gt; edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">future</a>.<a href="../Futures.scala.html#31139" title="(timeout: Long)Unit">await</a><span class="delimiter">(</span><span title="Long(5000L)" class="int">5000</span><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Unit">_</span>: <a href="../Futures.scala.html#9546" title="edu.berkeley.cs.scads.comm.FutureTimeoutException">FutureTimeoutException</a> =&gt;
              <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not drain send queue: took more than 5 seconds&quot;)" class="string">&quot;Could not drain send queue: took more than 5 seconds&quot;</span><span class="delimiter">)</span>
            <span class="keyword">case</span> <a title="Unit" id="62726">ex</a>: <a href="../Futures.scala.html#9547" title="edu.berkeley.cs.scads.comm.FutureException">FutureException</a> =&gt;
              <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not drain send queue: caught exception&quot;)" class="string">&quot;Could not drain send queue: caught exception&quot;</span>, <a href="#62726" title="edu.berkeley.cs.scads.comm.FutureException">ex</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#62404" title="java.net.Socket">socket</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62405" title="Boolean">startThreads</a><span class="delimiter">)</span>
      <a href="#62160" title="()Unit">initialize</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="()Unit" id="62160">initialize</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#62161" title="object Connection.this.threadStarter">threadStarter</a>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">object</span> <a title="object Connection.this.threadStarter" id="62161">threadStarter</a> <span title="ScalaObject" class="delimiter">{</span>

      <span class="comment">// start sending thread</span>
      <a href="#61880" title="=&gt; java.util.concurrent.ExecutorService">sendQueuePool</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#62165" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">makeRunnable</a> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#62135" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <a href="#62736" title="()Unit" class="delimiter">{</a>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.SendTask" id="62737">task</a> = <a href="#62153" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="()BlockingChannelManager.this.SendTask">take</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="keyword">try</span> <span class="delimiter">{</span>
            <a href="#62155" title="=&gt; java.io.OutputStream">outputStream</a>.<span title="(x$1: Array[Byte], x$2: Int, x$3: Int)Unit">write</span><span class="delimiter">(</span><a href="#62737" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#62499" title="=&gt; Array[Byte]">bytes</a>, <a href="#62737" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#62500" title="=&gt; Int">offset</a>, <a href="#62737" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#62501" title="=&gt; Int">length</a><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62737" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#62502" title="=&gt; Boolean">flush</a><span class="delimiter">)</span>
              <a href="#62155" title="=&gt; java.io.OutputStream">outputStream</a>.<span title="()Unit">flush</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#62737" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#62492" title="=&gt; edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">future</a>.<a href="../Futures.scala.html#31143" title="(e: Unit)Unit">finish</a><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a title="Unit" id="62741">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
              <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not write send task&quot;)" class="string">&quot;Could not write send task&quot;</span>, <a href="#62741" title="java.io.IOException">e</a><span class="delimiter">)</span>
              <a href="#62737" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#62492" title="=&gt; edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">future</a>.<a href="../Futures.scala.html#31144" title="(error: Throwable)Unit">finishWithError</a><span class="delimiter">(</span><a href="#62741" title="java.io.IOException">e</a><span class="delimiter">)</span>
              <a href="#62138" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <span class="comment">// start reading thread</span>
      <a href="#61878" title="=&gt; java.util.concurrent.ExecutorService">connectionPool</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#62165" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">makeRunnable</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.DataInputStream" id="62746">dataInputStream</a> = <span title="java.io.DataInputStream" class="keyword">new</span> <span title="java.io.DataInputStream">DataInputStream</span><span class="delimiter">(</span><a href="#62157" title="=&gt; java.io.InputStream">inputStream</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#62135" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#62795" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="Int" id="62796">len</a> = <a href="#62746" title="java.io.DataInputStream">dataInputStream</a>.<span title="()Int">readInt</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62796" title="Int">len</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Read bad input length: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62796" title="Int">len</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#62138" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="Array[Byte]" id="62806">bytes</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><a href="#62796" title="Int">len</a><span class="delimiter">)</span>
              <a href="#62746" title="java.io.DataInputStream">dataInputStream</a>.<span title="(x$1: Array[Byte])Unit">readFully</span><span class="delimiter">(</span><a href="#62806" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
              <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryDecoder" id="62807">inStream</a> = <span title="object org.apache.avro.io.DecoderFactory">DecoderFactory</span>.<span title="()org.apache.avro.io.DecoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.InputStream, x$2: org.apache.avro.io.BinaryDecoder)org.apache.avro.io.BinaryDecoder">directBinaryDecoder</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> <span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#62806" title="Array[Byte]">bytes</a><span class="delimiter">)</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> 
              <span class="keyword">val</span> <a title="R" id="62808">msg</a> = <a href="#61868" title="=&gt; Class[R]">msgRecvClass</a>.<span title="()R">newInstance</span>
              <a href="#61872" title="=&gt; org.apache.avro.specific.SpecificDatumReader[R]">msgReader</a>.<span title="(x$1: R, x$2: org.apache.avro.io.Decoder)R">read</span><span class="delimiter">(</span><a href="#62808" title="R">msg</a>, <a href="#62807" title="org.apache.avro.io.BinaryDecoder">inStream</a><span class="delimiter">)</span>
              <a href="../AvroChannelManager.scala.html#14308" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#62149" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#62808" title="R">msg</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a title="Unit" id="62847">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
              <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Caught error in reading&quot;)" class="string">&quot;Caught error in reading&quot;</span>, <a href="#62847" title="java.io.IOException">e</a><span class="delimiter">)</span>
              <a href="#62138" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    
    <span class="delimiter">}</span>

    <span class="comment">/** Does the message framing (using 4 bytes) */</span>
    <span class="keyword">def</span> <a title="(bytes: Array[Byte], offset: Int, length: Int, flush: Boolean)Unit" id="62163">send</a><span class="delimiter">(</span><a title="Array[Byte]" id="62415">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Int" id="62416">offset</a>: <span title="Int">Int</span>, <a title="Int" id="62417">length</a>: <span title="Int">Int</span>, <a title="Boolean" id="62418">flush</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#62415" title="Array[Byte]">bytes</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;Bytes cannot be null&quot;)" class="string">&quot;Bytes cannot be null&quot;</span><span class="delimiter">)</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#62416" title="Int">offset</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span>, <span title="java.lang.String(&quot;Offset cannot be negative&quot;)" class="string">&quot;Offset cannot be negative&quot;</span><span class="delimiter">)</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#62417" title="Int">length</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span>, <span title="java.lang.String(&quot;Length cannot be negative&quot;)" class="string">&quot;Length cannot be negative&quot;</span><span class="delimiter">)</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#62416" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#62417" title="Int">length</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <a href="#62415" title="Array[Byte]">bytes</a>.<span title="=&gt; Int">length</span>, <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;offset + length cannot exceed bounds of array: offset %d, length: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62416" title="Int">offset</a>, <a href="#62417" title="Int">length</a><span class="delimiter">)</span><span class="delimiter">)</span>

      <a href="#62141" title="()Unit">ensureRunning</a><span class="delimiter">(</span><span class="delimiter">)</span>

      <span class="keyword">def</span> <a title="(v: Int, b: Array[Byte], startPos: Int)Unit" id="62852">writeInt</a><span class="delimiter">(</span><a title="Int" id="62881">v</a>: <span title="Int">Int</span>, <a title="Array[Byte]" id="62882">b</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Int" id="62883">startPos</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#62882" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#62883" title="Int">startPos</a><span class="delimiter">)</span>     = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#62881" title="Int">v</a> <span title="(x: Int)Int">&gt;&gt;&gt;</span> <span title="Int(24)" class="int">24</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
        <a href="#62882" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#62883" title="Int">startPos</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#62881" title="Int">v</a> <span title="(x: Int)Int">&gt;&gt;&gt;</span> <span title="Int(16)" class="int">16</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
        <a href="#62882" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#62883" title="Int">startPos</a> <span title="(x: Int)Int">+</span> <span title="Int(2)" class="int">2</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#62881" title="Int">v</a> <span title="(x: Int)Int">&gt;&gt;&gt;</span> <span title="Int(8)" class="int">8</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
        <a href="#62882" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#62883" title="Int">startPos</a> <span title="(x: Int)Int">+</span> <span title="Int(3)" class="int">3</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#62881" title="Int">v</a> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
      <span class="delimiter">}</span>

      <span class="keyword">val</span> <a title="BlockingChannelManager.this.SendTask" id="62853">task</a> = 
        <span title="BlockingChannelManager.this.SendTask" class="keyword">if</span> <span class="delimiter">(</span><a href="#62416" title="Int">offset</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#62852" title="(v: Int, b: Array[Byte], startPos: Int)Unit">writeInt</a><span class="delimiter">(</span><a href="#62417" title="Int">length</a>, <a href="#62415" title="Array[Byte]">bytes</a>, <a href="#62416" title="Int">offset</a> <span title="(x: Int)Int">-</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span>
          <span title="BlockingChannelManager.this.SendTask" class="keyword">new</span> <a href="#61894" title="BlockingChannelManager.this.SendTask">SendTask</a><span class="delimiter">(</span><a href="#62415" title="Array[Byte]">bytes</a>, <a href="#62416" title="Int">offset</a> <span title="(x: Int)Int">-</span> <span title="Int(4)" class="int">4</span>, <a href="#62417" title="Int">length</a> <span title="(x: Int)Int">+</span> <span title="Int(4)" class="int">4</span>, <a href="#62418" title="Boolean">flush</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Array[Byte]" id="62942">newArray</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><a href="#62417" title="Int">length</a> <span title="(x: Int)Int">+</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span>
          <a href="#62852" title="(v: Int, b: Array[Byte], startPos: Int)Unit">writeInt</a><span class="delimiter">(</span><a href="#62417" title="Int">length</a>, <a href="#62942" title="Array[Byte]">newArray</a>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> 
          <span title="object java.lang.System">System</span>.<span title="(x$1: Any, x$2: Int, x$3: Any, x$4: Int, x$5: Int)Unit">arraycopy</span><span class="delimiter">(</span><a href="#62415" title="Array[Byte]">bytes</a>, <a href="#62416" title="Int">offset</a>, <a href="#62942" title="Array[Byte]">newArray</a>, <span title="Int(4)" class="int">4</span>, <a href="#62417" title="Int">length</a><span class="delimiter">)</span>
          <span title="BlockingChannelManager.this.SendTask" class="keyword">new</span> <a href="#61894" title="BlockingChannelManager.this.SendTask">SendTask</a><span class="delimiter">(</span><a href="#62942" title="Array[Byte]">newArray</a>, <span title="Int(0)" class="int">0</span>, <a href="#62417" title="Int">length</a> <span title="(x: Int)Int">+</span> <span title="Int(4)" class="int">4</span>, <a href="#62418" title="Boolean">flush</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>

      <a href="#62153" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="(x$1: BlockingChannelManager.this.SendTask)Boolean">offer</span><span title="Unit" class="delimiter">(</span><a href="#62853" title="BlockingChannelManager.this.SendTask">task</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">val</span> <a title="java.lang.Object" id="61898">V</a> = <span title="java.lang.Object" class="keyword">new</span> <span title="java.lang.Object">Object</span>

  <span class="keyword">class</span> <a title="class Listener extends java.lang.Object with BlockingChannelManager.this.Stoppable with BlockingChannelManager.this.RunnableHelper with ScalaObject" id="61900">Listener</a><a href="#61900" title="ScalaObject" class="delimiter">(</a><a title="java.net.ServerSocket" id="62469">serverSocket</a>: <span title="java.net.ServerSocket">ServerSocket</span><span class="delimiter">)</span> 
    <span class="keyword">extends</span> <a href="#61896" title="BlockingChannelManager.this.Stoppable">Stoppable</a> <span class="keyword">with</span> <a href="#61895" title="BlockingChannelManager.this.RunnableHelper">RunnableHelper</a> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#62469" title="java.net.ServerSocket">serverSocket</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="62272">port</a> = <a href="#62469" title="java.net.ServerSocket">serverSocket</a>.<span title="()Int">getLocalPort</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]" id="62274">connectionsSet</a> = 
      <span title="()java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">ConcurrentHashMap</span><span class="delimiter">[</span>EphemeralConnection, Object<span class="delimiter">]</span>

    <span class="keyword">class</span> <a title="class EphemeralConnection extends BlockingChannelManager.this.Connection with ScalaObject" id="62276">EphemeralConnection</a><a href="#62276" title="ScalaObject" class="delimiter">(</a><a title="java.net.Socket" id="63077">socket</a>: <span title="java.net.Socket">Socket</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#61897" title="BlockingChannelManager.this.Connection">Connection</a><span class="delimiter">(</span><a href="#63077" title="java.net.Socket">socket</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="63026">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#62276" title="Listener.this.EphemeralConnection" class="keyword">super</a>.<a href="#62159" title="()Unit">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="java.lang.Object" id="63079">test</a> = <a href="#62274" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="(x$1: Any)java.lang.Object">remove</span><span class="delimiter">(</span><a href="#62276" title="Listener.this.EphemeralConnection" class="keyword">this</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#63079" title="java.lang.Object">test</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> 
          <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;ephemeral connection was not in connection set: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62276" title="Listener.this.EphemeralConnection" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="62277">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
      <a href="#61884" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Any)BlockingChannelManager.this.Listener">remove</span><span class="delimiter">(</span><a href="#62272" title="=&gt; Int">port</a><span class="delimiter">)</span>
      <a href="#62274" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="(s: java.util.Set[Listener.this.EphemeralConnection])scala.collection.mutable.Set[Listener.this.EphemeralConnection]">keySet</span>.<span title="(f: Listener.this.EphemeralConnection =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#63511" title="Listener.this.EphemeralConnection">_</a>.<a href="#62138" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#62274" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#62469" title="java.net.ServerSocket">serverSocket</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#61876" title="=&gt; java.util.concurrent.ExecutorService">listenerPool</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#62165" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">makeRunnable</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#62135" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#63513" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.net.Socket" id="63514">client</a> = <a href="#62469" title="java.net.ServerSocket">serverSocket</a>.<span title="()java.net.Socket">accept</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62135" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#63514" title="java.net.Socket">client</a>.<span title="(x$1: Boolean)Unit">setTcpNoDelay</span><span class="delimiter">(</span><a href="#61866" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span> <span class="comment">// disable Nagle's algorithm</span>

            <span class="keyword">val</span> <a title="Listener.this.EphemeralConnection" id="63515">conn</a> = <span title="Listener.this.EphemeralConnection" class="keyword">new</span> <a href="#62276" title="Listener.this.EphemeralConnection">EphemeralConnection</a><span class="delimiter">(</span><a href="#63514" title="java.net.Socket">client</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="63516">prev</a> = <a href="#61882" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: BlockingChannelManager.this.Connection)BlockingChannelManager.this.Connection">putIfAbsent</span><span class="delimiter">(</span><a href="#61902" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket">client</a>.<a href="#62547" title="=&gt; java.net.InetSocketAddress">remoteInetSocketAddress</a>, <a href="#63515" title="Listener.this.EphemeralConnection">conn</a><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#63516" title="BlockingChannelManager.this.Connection">prev</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unable to enter new remote connection into connection map: refusing connection&quot;)" class="string">&quot;Unable to enter new remote connection into connection map: refusing connection&quot;</span><span class="delimiter">)</span>
              <a href="#63515" title="Listener.this.EphemeralConnection">conn</a>.<a href="#62138" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <a href="#62274" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="(x$1: Listener.this.EphemeralConnection, x$2: java.lang.Object)java.lang.Object">put</span><span class="delimiter">(</span><a href="#63515" title="Listener.this.EphemeralConnection">conn</a>, <a href="#61898" title="=&gt; java.lang.Object">V</a><span class="delimiter">)</span>
            <a href="#63515" title="Listener.this.EphemeralConnection">conn</a>.<a href="#62160" title="()Unit">initialize</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// start send/read threads</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="63531">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
            <a href="#61864" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Caught error in accepting&quot;)" class="string">&quot;Caught error in accepting&quot;</span>, <a href="#63531" title="java.io.IOException">e</a><span class="delimiter">)</span>
            <a href="#62138" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class RichSocket extends java.lang.Object with ScalaObject" id="61901">RichSocket</a><a href="#61901" title="ScalaObject" class="delimiter">(</a><a title="java.net.Socket" id="63538">socket</a>: <span title="java.net.Socket">Socket</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; java.net.InetSocketAddress" id="62547">remoteInetSocketAddress</a> = 
      <span title="(x$1: java.net.InetAddress, x$2: Int)java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#63538" title="java.net.Socket">socket</a>.<span title="()java.net.InetAddress">getInetAddress</span>, <a href="#63538" title="java.net.Socket">socket</a>.<span title="()Int">getPort</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="=&gt; java.net.InetSocketAddress" id="62548">localInetSocketAddress</a> = 
      <span title="(x$1: java.net.InetAddress, x$2: Int)java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#63538" title="java.net.Socket">socket</a>.<span title="()java.net.InetAddress">getLocalAddress</span>, <a href="#63538" title="java.net.Socket">socket</a>.<span title="()Int">getLocalPort</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket" id="61902">toRichSocket</a><span class="delimiter">(</span><a title="java.net.Socket" id="61973">socket</a>: <span title="java.net.Socket">Socket</span><span class="delimiter">)</span>: <a href="#61901" title="BlockingChannelManager.this.RichSocket">RichSocket</a> = 
    <span title="BlockingChannelManager.this.RichSocket" class="keyword">new</span> <a href="#61901" title="BlockingChannelManager.this.RichSocket">RichSocket</a><span class="delimiter">(</span><a href="#61973" title="java.net.Socket">socket</a><span class="delimiter">)</span>

  <span class="keyword">class</span> <a title="class RichInetSocketAddress extends java.lang.Object with ScalaObject" id="61903">RichInetSocketAddress</a><a href="#61903" title="ScalaObject" class="delimiter">(</a><a title="java.net.InetSocketAddress" id="63541">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode" id="62564">toRemoteNode</a> = 
      <a href="../AvroChannelManager.scala.html#24024" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#63541" title="java.net.InetSocketAddress">addr</a>.<span title="()java.lang.String">getHostName</span>, <a href="#63541" title="java.net.InetSocketAddress">addr</a>.<span title="()Int">getPort</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichInetSocketAddress : (addr: java.net.InetSocketAddress)BlockingChannelManager.this.RichInetSocketAddress" id="61904">toRichInetSocketAddress</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="61975">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span>: <a href="#61903" title="BlockingChannelManager.this.RichInetSocketAddress">RichInetSocketAddress</a> =
    <span title="BlockingChannelManager.this.RichInetSocketAddress" class="keyword">new</span> <a href="#61903" title="BlockingChannelManager.this.RichInetSocketAddress">RichInetSocketAddress</a><span class="delimiter">(</span><a href="#61975" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>