<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>oio/BlockingChannelManager.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.comm
<span class="keyword">package</span> oio

<span class="keyword">import</span> java.io._
<span class="keyword">import</span> java.net._
<span class="keyword">import</span> java.util.concurrent._
<span class="keyword">import</span> atomic._

<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> io._
<span class="keyword">import</span> specific._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> scala.reflect.<span title="object scala.reflect.Manifest">Manifest</span>.classType
<span class="keyword">import</span> edu.berkeley.cs.scads.config._

<span class="comment">/**
 * Easier to instantiate via reflection
 */</span>
<span class="keyword">class</span> <a title="class DefaultBlockingChannelManager[S &lt;: org.apache.avro.specific.SpecificRecord, R &lt;: org.apache.avro.specific.SpecificRecord] extends edu.berkeley.cs.scads.comm.oio.BlockingChannelManager[S,R] with ScalaObject" id="9743">DefaultBlockingChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9744">S</a> &lt;: SpecificRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9745">R</a> &lt;: SpecificRecord<span class="delimiter">]</span><a href="#9743" title="ScalaObject" class="delimiter">(</a>
    <a title="(edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], edu.berkeley.cs.scads.comm.RemoteNode, R) =&gt; Unit" id="49488">recvMsg</a>: <span class="delimiter">(</span>AvroChannelManager<span class="delimiter">[</span>S, R<span class="delimiter">]</span>, RemoteNode, R<span class="delimiter">)</span> =&gt; Unit, <a title="Class[S]" id="49489">sendClz</a>: <span title="Class[S]">Class</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="Class[R]" id="49490">recvClz</a>: <span title="Class[R]">Class</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <a href="#9746" title="edu.berkeley.cs.scads.comm.oio.BlockingChannelManager[S,R]">BlockingChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">(</span><span title="(clazz: Class[_])scala.reflect.Manifest[S]">classType</span><span class="delimiter">(</span><a href="#49489" title="Class[S]">sendClz</a><span class="delimiter">)</span>, <span title="(clazz: Class[_])scala.reflect.Manifest[R]">classType</span><span class="delimiter">(</span><a href="#49490" title="Class[R]">recvClz</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(remoteNode: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit" id="49483">receiveMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49523">remoteNode</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="R" id="49524">msg</a>: <a href="#9745" title="R">R</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#49488" title="(v1: edu.berkeley.cs.scads.comm.AvroChannelManager[S,R], v2: edu.berkeley.cs.scads.comm.RemoteNode, v3: R)Unit">recvMsg</a><span class="delimiter">(</span><a href="#9743" title="edu.berkeley.cs.scads.comm.oio.DefaultBlockingChannelManager[S,R]" class="keyword">this</a>, <a href="#49523" title="edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#49524" title="R">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class BlockingChannelManager[S &lt;: org.apache.avro.specific.SpecificRecord, R &lt;: org.apache.avro.specific.SpecificRecord] extends java.lang.Object with edu.berkeley.cs.scads.comm.AvroChannelManager[S,R] with ScalaObject" id="9746">BlockingChannelManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9747">S</a> &lt;: SpecificRecord, <a title="&gt;: Nothing &lt;: org.apache.avro.specific.SpecificRecord" id="9748">R</a> &lt;: SpecificRecord<span class="delimiter">]</span><a href="#9746" title="ScalaObject" class="delimiter">(</a>
    <span class="keyword">implicit</span> <a title="Manifest[S]" id="49491">sendManifest</a>: <span title="Manifest[S]">Manifest</span><span class="delimiter">[</span>S<span class="delimiter">]</span>, <a title="Manifest[R]" id="49492">recvManifest</a>: <span title="Manifest[R]">Manifest</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="../AvroChannelManager.scala.html#9478" title="edu.berkeley.cs.scads.comm.AvroChannelManager[S,R]">AvroChannelManager</a><span class="delimiter">[</span>S, R<span class="delimiter">]</span> <span class="delimiter">{</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="49435">log</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Boolean" id="49438">useTcpNoDelay</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>.<span title="(key: String, defaultValue: Boolean)Boolean">getBool</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.comm.tcpNoDelay&quot;)" class="string">&quot;scads.comm.tcpNoDelay&quot;</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  <span class="comment">// Avro serialization</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Class[R]" id="49439">msgRecvClass</a> = <a href="#49492" title="Manifest[R]">recvManifest</a>.<span title="=&gt; java.lang.Class[_]">erasure</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[R]" class="delimiter">[</span><span title="Class[R]">Class</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Class[S]" id="49441">msgSendClass</a> = <a href="#49491" title="Manifest[S]">sendManifest</a>.<span title="=&gt; java.lang.Class[_]">erasure</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[S]" class="delimiter">[</span><span title="Class[S]">Class</span><span class="delimiter">[</span>S<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumReader[R]" id="49443">msgReader</a> = 
    <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumReader[R]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumReader[R]">SpecificDatumReader</span><span class="delimiter">[</span>R<span class="delimiter">]</span><span class="delimiter">(</span><a href="#49439" title="=&gt; Class[R]">msgRecvClass</a>.<span title="()R">newInstance</span>.<span title="()org.apache.avro.Schema">getSchema</span><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumWriter[S]" id="49445">msgWriter</a> = 
    <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumWriter[S]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumWriter[S]">SpecificDatumWriter</span><span class="delimiter">[</span>S<span class="delimiter">]</span><span class="delimiter">(</span><a href="#49441" title="=&gt; Class[S]">msgSendClass</a>.<span title="()S">newInstance</span>.<span title="()org.apache.avro.Schema">getSchema</span><span class="delimiter">)</span>

  <span class="comment">// Thread pools</span>

  <span class="comment">/** Thread pool for ServerSockets */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="49447">listenerPool</a> = 
    <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span>

  <span class="comment">/** Thread pool for Sockets */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="49449">connectionPool</a> =
    <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span> <span class="comment">// TODO: configure</span>

  <span class="comment">/** Thread pool for processing send queues */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="49451">sendQueuePool</a> =
    <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newCachedThreadPool</span> <span class="comment">// TODO: configure</span>

  <span class="comment">// Connection/Listener management</span>

  <span class="comment">/** Used to manage open connections */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]" id="49453">nodeToConnections</a> = 
    <span title="()java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">ConcurrentHashMap</span><span class="delimiter">[</span>InetSocketAddress, Connection<span class="delimiter">]</span>

  <span class="comment">/** Used to manage open ports */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]" id="49455">portToListeners</a> =
    <span title="()java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">ConcurrentHashMap</span><span class="delimiter">[</span>Int, Listener<span class="delimiter">]</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="49457">sendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49895">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="49896">msg</a>: <a href="#9747" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#49459" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S, flush: Boolean)Unit">doSendMessage</a><span class="delimiter">(</span><a href="#49895" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>, <a href="#49896" title="S">msg</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S)Unit" id="49458">sendMessageBulk</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49904">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="49905">msg</a>: <a href="#9747" title="S">S</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#49459" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S, flush: Boolean)Unit">doSendMessage</a><span class="delimiter">(</span><a href="#49904" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>, <a href="#49905" title="S">msg</a>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode, msg: S, flush: Boolean)Unit" id="49459">doSendMessage</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49900">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a>, <a title="S" id="49901">msg</a>: <a href="#9747" title="S">S</a>, <a title="Boolean" id="49902">flush</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream" id="49909">os</a>      = <span title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream" class="keyword">new</span> <a href="PreallocByteArrayOutputStream.scala.html#9753" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">PreallocByteArrayOutputStream</a><span class="delimiter">(</span><span title="Int(4)" class="int">4</span>, <span title="Int(512)" class="int">512</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryEncoder" id="49910">encoder</a> = <span title="object org.apache.avro.io.EncoderFactory">EncoderFactory</span>.<span title="()org.apache.avro.io.EncoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.OutputStream, x$2: org.apache.avro.io.BinaryEncoder)org.apache.avro.io.BinaryEncoder">binaryEncoder</span><span class="delimiter">(</span><a href="#49909" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>,<span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#49445" title="=&gt; org.apache.avro.specific.SpecificDatumWriter[S]">msgWriter</a>.<span title="(x$1: S, x$2: org.apache.avro.io.Encoder)Unit">write</span><span class="delimiter">(</span><a href="#49901" title="S">msg</a>, <a href="#49910" title="org.apache.avro.io.BinaryEncoder">encoder</a><span class="delimiter">)</span>
    <a href="#49910" title="org.apache.avro.io.BinaryEncoder">encoder</a>.<span title="()Unit">flush</span>

    <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="49911">conn</a> = <a href="#49460" title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)BlockingChannelManager.this.Connection">getConnectionFor</a><span class="delimiter">(</span><a href="#49900" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a><span class="delimiter">)</span>
    <a href="#49911" title="BlockingChannelManager.this.Connection">conn</a>.<a href="#49734" title="(bytes: Array[Byte], offset: Int, length: Int, flush: Boolean)Unit">send</a><span class="delimiter">(</span><a href="#49909" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>.<a href="PreallocByteArrayOutputStream.scala.html#49920" title="=&gt; Array[Byte]">underlyingBuffer</a>, <a href="#49909" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>.<a href="PreallocByteArrayOutputStream.scala.html#49918" title="=&gt; Int">numPreAllocBytes</a>, <a href="#49909" title="edu.berkeley.cs.scads.comm.oio.PreallocByteArrayOutputStream">os</a>.<a href="PreallocByteArrayOutputStream.scala.html#49919" title="=&gt; Int">effectiveSize</a>, <a href="#49902" title="Boolean">flush</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(dest: edu.berkeley.cs.scads.comm.RemoteNode)BlockingChannelManager.this.Connection" id="49460">getConnectionFor</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49936">dest</a>: <a href="../AvroChannelManager.scala.html#9475" title="edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="49939">addr</a>  = <a href="#49936" title="edu.berkeley.cs.scads.comm.RemoteNode">dest</a>.<a href="../AvroChannelManager.scala.html#10353" title="=&gt; java.net.InetSocketAddress">getInetSocketAddress</a>
    <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="49940">conn0</a> = <a href="#49453" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: Any)BlockingChannelManager.this.Connection">get</span><span class="delimiter">(</span><a href="#49939" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
    <span title="BlockingChannelManager.this.Connection" class="keyword">if</span> <span class="delimiter">(</span><a href="#49940" title="BlockingChannelManager.this.Connection">conn0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#49940" title="BlockingChannelManager.this.Connection">conn0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#49453" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: BlockingChannelManager.this.Connection)BlockingChannelManager.this.Connection">synchronized</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="49943">test0</a> = <a href="#49453" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: Any)BlockingChannelManager.this.Connection">get</span><span class="delimiter">(</span><a href="#49939" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
        <span title="BlockingChannelManager.this.Connection" class="keyword">if</span> <span class="delimiter">(</span><a href="#49943" title="BlockingChannelManager.this.Connection">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#49943" title="BlockingChannelManager.this.Connection">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="49944">newConn</a> = <a href="#49464" title="(addr: java.net.InetSocketAddress)BlockingChannelManager.this.Connection">connect</a><span class="delimiter">(</span><a href="#49939" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="49945">ret</a> = <a href="#49453" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: BlockingChannelManager.this.Connection)BlockingChannelManager.this.Connection">put</span><span class="delimiter">(</span><a href="#49939" title="java.net.InetSocketAddress">addr</a>, <a href="#49944" title="BlockingChannelManager.this.Connection">newConn</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#49945" title="BlockingChannelManager.this.Connection">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new connection&quot;)" class="string">&quot;should not have overwritten a new connection&quot;</span><span class="delimiter">)</span>
          <a href="#49944" title="BlockingChannelManager.this.Connection">newConn</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="49461">flush</a> <span title="Unit" class="delimiter">{</span> <span class="comment">/* No-op */</span> <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(port: Int)Unit" id="49462">startListener</a><span class="delimiter">(</span><a title="Int" id="50006">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#50006" title="Int">port</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">||</span> <a href="#50006" title="Int">port</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(65535)" class="int">65535</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid port: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#50006" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="50008">list0</a> = <a href="#49455" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Any)BlockingChannelManager.this.Listener">get</span><span class="delimiter">(</span><a href="#50006" title="Int">port</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#50008" title="BlockingChannelManager.this.Listener">list0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#50008" title="BlockingChannelManager.this.Listener">list0</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#49455" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: BlockingChannelManager.this.Listener)BlockingChannelManager.this.Listener">synchronized</span> <span title="Unit" class="delimiter">{</span>
        <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="50026">test0</a> = <a href="#49455" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Any)BlockingChannelManager.this.Listener">get</span><span class="delimiter">(</span><a href="#50006" title="Int">port</a><span class="delimiter">)</span>
        <span title="BlockingChannelManager.this.Listener" class="keyword">if</span> <span class="delimiter">(</span><a href="#50026" title="BlockingChannelManager.this.Listener">test0</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#50026" title="BlockingChannelManager.this.Listener">test0</a> <span class="comment">// check again</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="50027">newListener</a> = <a href="#49463" title="(port: Int)BlockingChannelManager.this.Listener">listen</a><span class="delimiter">(</span><a href="#50006" title="Int">port</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.Listener" id="50028">ret</a> = <a href="#49455" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Int, x$2: BlockingChannelManager.this.Listener)BlockingChannelManager.this.Listener">put</span><span class="delimiter">(</span><a href="#50006" title="Int">port</a>, <a href="#50027" title="BlockingChannelManager.this.Listener">newListener</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#50028" title="BlockingChannelManager.this.Listener">ret</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;should not have overwritten a new listener&quot;)" class="string">&quot;should not have overwritten a new listener&quot;</span><span class="delimiter">)</span>
          <a href="#50027" title="BlockingChannelManager.this.Listener">newListener</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(port: Int)BlockingChannelManager.this.Listener" id="49463">listen</a><span class="delimiter">(</span><a title="Int" id="50029">port</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;starting listener on port %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#50029" title="Int">port</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// open the socket in the current thread</span>
    <span class="keyword">val</span> <a title="java.net.ServerSocket" id="50032">serverSocket</a> = <span title="(x$1: Int)java.net.ServerSocket" class="keyword">new</span> <span title="java.net.ServerSocket">ServerSocket</span><span class="delimiter">(</span><a href="#50029" title="Int">port</a><span class="delimiter">)</span>
    <span title="BlockingChannelManager.this.Listener" class="keyword">new</span> <a href="#49471" title="BlockingChannelManager.this.Listener">Listener</a><span class="delimiter">(</span><a href="#50032" title="java.net.ServerSocket">serverSocket</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(addr: java.net.InetSocketAddress)BlockingChannelManager.this.Connection" id="49464">connect</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="49946">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#49946" title="java.net.InetSocketAddress">addr</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;opening new connection to address: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#49946" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// open the connection in the current thread</span>
    <span class="keyword">val</span> <a title="java.net.Socket" id="49949">socket</a> = <span title="java.net.Socket" class="keyword">new</span> <span title="java.net.Socket">Socket</span>
    <a href="#49949" title="java.net.Socket">socket</a>.<span title="(x$1: Boolean)Unit">setTcpNoDelay</span><span class="delimiter">(</span><a href="#49437" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span>  <span class="comment">// disable Nagle's algorithm</span>
    <a href="#49949" title="java.net.Socket">socket</a>.<span title="(x$1: java.net.SocketAddress, x$2: Int)Unit">connect</span><span class="delimiter">(</span><a href="#49946" title="java.net.InetSocketAddress">addr</a>, <span title="Int(60000)" class="int">60000</span><span class="delimiter">)</span> <span class="comment">// wait up til 1 min for connect</span>

    <span title="BlockingChannelManager.this.Connection" class="keyword">new</span> <a href="#49468" title="BlockingChannelManager.this.Connection">Connection</a><span class="delimiter">(</span><a href="#49949" title="java.net.Socket">socket</a>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">// start send/read threads immediately</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class SendTask extends java.lang.Object with ScalaObject" id="49465">SendTask</a><a href="#49465" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Array[Byte]" id="50070">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Int" id="50071">offset</a>: <span title="Int">Int</span>, <span class="keyword">val</span> <a title="Int" id="50072">length</a>: <span title="Int">Int</span>, <span class="keyword">val</span> <a title="Boolean" id="50073">flush</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]" id="50063">future</a> = <span title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]" class="keyword">new</span> <a href="../Futures.scala.html#9514" title="edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">BlockingFuture</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span>
  <span class="delimiter">}</span>

  <span class="keyword">trait</span> <a title="trait RunnableHelper extends java.lang.Object with ScalaObject" id="49466">RunnableHelper</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable" id="49736">makeRunnable</a><span class="delimiter">(</span><a title="=&gt; Unit" id="50076">f</a>: =&gt; Unit<span class="delimiter">)</span> = <a href="#50079" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="50079">Runnable</a> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="50081">run</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#50076" title="=&gt; Unit">f</a> <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">trait</span> <a title="trait Stoppable extends java.lang.Object with ScalaObject" id="49467">Stoppable</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicBoolean" id="49706">continue</a> = <span title="java.util.concurrent.atomic.AtomicBoolean" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="49708">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span>  <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="()Unit" id="49709">stop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> 
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#49706" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="(x$1: Boolean, x$2: Boolean)Boolean">compareAndSet</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#49708" title="()Unit">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="49710">isRunning</a> = <a href="#49706" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="49711">isStopped</a> = <span title="=&gt; Boolean">!</span><a href="#49706" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span>
    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="49712">ensureRunning</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#49711" title="=&gt; Boolean">isStopped</a><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><a href="#49467" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd" class="keyword">this</a> <span title="(other: String)java.lang.String">+</span> <span title="java.lang.String(&quot;: Not running&quot;)" class="string">&quot;: Not running&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Takes a valid socket. 
   * Spawns 2 threads- a listening thread, and a sending thread */</span>
  <span class="keyword">class</span> <a title="class Connection extends java.lang.Object with BlockingChannelManager.this.Stoppable with BlockingChannelManager.this.RunnableHelper with ScalaObject" id="49468">Connection</a><a href="#49468" title="ScalaObject" class="delimiter">(</a><a title="java.net.Socket" id="49975">socket</a>: <span title="java.net.Socket">Socket</span>, <a title="Boolean" id="49976">startThreads</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> 
    <span class="keyword">extends</span> <a href="#49467" title="BlockingChannelManager.this.Stoppable">Stoppable</a> <span class="keyword">with</span> <a href="#49466" title="BlockingChannelManager.this.RunnableHelper">RunnableHelper</a> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#49975" title="java.net.Socket">socket</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="49718">remoteAddress</a> = 
      <a href="#49473" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket">socket</a>.<a href="#50118" title="=&gt; java.net.InetSocketAddress">remoteInetSocketAddress</a>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteNode" id="49720">remoteNode</a> = 
      <a href="#49475" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichInetSocketAddress : (addr: java.net.InetSocketAddress)BlockingChannelManager.this.RichInetSocketAddress">remoteAddress</a>.<a href="#50135" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">toRemoteNode</a> 

    <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.net.InetSocketAddress" id="49723">localAddress</a> =
      <a href="#49473" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket">socket</a>.<a href="#50119" title="=&gt; java.net.InetSocketAddress">localInetSocketAddress</a>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]" id="49724">sendQueue</a> = <span title="java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]" class="keyword">new</span> <span title="java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">LinkedBlockingQueue</span><span class="delimiter">[</span>SendTask<span class="delimiter">]</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.io.OutputStream" id="49726">outputStream</a> = <a href="#49975" title="java.net.Socket">socket</a>.<span title="()java.io.OutputStream">getOutputStream</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.io.InputStream" id="49728">inputStream</a>  = <a href="#49975" title="java.net.Socket">socket</a>.<span title="()java.io.InputStream">getInputStream</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="49730">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#49453" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: Any)BlockingChannelManager.this.Connection">remove</span><span class="delimiter">(</span><a href="#49718" title="=&gt; java.net.InetSocketAddress">remoteAddress</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#49975" title="java.net.Socket">socket</a>.<span title="()Boolean">isConnected</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// find the last task in queue, and wait on its future for up to 5</span>
        <span class="comment">// seconds</span>
        <span class="keyword">val</span> <a title="Array[BlockingChannelManager.this.SendTask with java.lang.Object]" id="50246">view</a> = <a href="#49724" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="(x$1: Array[BlockingChannelManager.this.SendTask with java.lang.Object])Array[BlockingChannelManager.this.SendTask with java.lang.Object]">toArray</span><span class="delimiter">(</span><span title="Array[BlockingChannelManager.this.SendTask]" class="keyword">new</span> <span title="Array[BlockingChannelManager.this.SendTask]">Array</span><span class="delimiter">[</span>SendTask<span class="delimiter">]</span><span class="delimiter">(</span><a href="#49724" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="()Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#50246" title="Array[BlockingChannelManager.this.SendTask with java.lang.Object]">view</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="&lt;none&gt; extends BlockingChannelManager.this.SendTask with java.lang.Object" id="50288">last</a> = <a href="#50246" title="(i: Int)BlockingChannelManager.this.SendTask with java.lang.Object">view</a><span class="delimiter">(</span><a href="#50246" title="Array[BlockingChannelManager.this.SendTask with java.lang.Object]">view</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
          <span class="keyword">try</span> <span class="delimiter">{</span>
            <a href="#50288" title="&lt;none&gt; extends BlockingChannelManager.this.SendTask with java.lang.Object">last</a>.<a href="#50063" title="=&gt; edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">future</a>.<a href="../Futures.scala.html#32788" title="(timeout: Long)Unit">await</a><span class="delimiter">(</span><span title="Long(5000L)" class="int">5000</span><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Unit">_</span>: <a href="../Futures.scala.html#9512" title="edu.berkeley.cs.scads.comm.FutureTimeoutException">FutureTimeoutException</a> =&gt;
              <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not drain send queue: took more than 5 seconds&quot;)" class="string">&quot;Could not drain send queue: took more than 5 seconds&quot;</span><span class="delimiter">)</span>
            <span class="keyword">case</span> <a title="Unit" id="50297">ex</a>: <a href="../Futures.scala.html#9513" title="edu.berkeley.cs.scads.comm.FutureException">FutureException</a> =&gt;
              <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not drain send queue: caught exception&quot;)" class="string">&quot;Could not drain send queue: caught exception&quot;</span>, <a href="#50297" title="edu.berkeley.cs.scads.comm.FutureException">ex</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#49975" title="java.net.Socket">socket</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#49976" title="Boolean">startThreads</a><span class="delimiter">)</span>
      <a href="#49731" title="()Unit">initialize</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="()Unit" id="49731">initialize</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#49732" title="object Connection.this.threadStarter">threadStarter</a>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">object</span> <a title="object Connection.this.threadStarter" id="49732">threadStarter</a> <span title="ScalaObject" class="delimiter">{</span>

      <span class="comment">// start sending thread</span>
      <a href="#49451" title="=&gt; java.util.concurrent.ExecutorService">sendQueuePool</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#49736" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">makeRunnable</a> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#49706" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <a href="#50307" title="()Unit" class="delimiter">{</a>
          <span class="keyword">val</span> <a title="BlockingChannelManager.this.SendTask" id="50308">task</a> = <a href="#49724" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="()BlockingChannelManager.this.SendTask">take</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="keyword">try</span> <span class="delimiter">{</span>
            <a href="#49726" title="=&gt; java.io.OutputStream">outputStream</a>.<span title="(x$1: Array[Byte], x$2: Int, x$3: Int)Unit">write</span><span class="delimiter">(</span><a href="#50308" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#50070" title="=&gt; Array[Byte]">bytes</a>, <a href="#50308" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#50071" title="=&gt; Int">offset</a>, <a href="#50308" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#50072" title="=&gt; Int">length</a><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#50308" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#50073" title="=&gt; Boolean">flush</a><span class="delimiter">)</span>
              <a href="#49726" title="=&gt; java.io.OutputStream">outputStream</a>.<span title="()Unit">flush</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#50308" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#50063" title="=&gt; edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">future</a>.<a href="../Futures.scala.html#32792" title="(e: Unit)Unit">finish</a><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a title="Unit" id="50312">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
              <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not write send task&quot;)" class="string">&quot;Could not write send task&quot;</span>, <a href="#50312" title="java.io.IOException">e</a><span class="delimiter">)</span>
              <a href="#50308" title="BlockingChannelManager.this.SendTask">task</a>.<a href="#50063" title="=&gt; edu.berkeley.cs.scads.comm.BlockingFuture[Unit]">future</a>.<a href="../Futures.scala.html#32793" title="(error: Throwable)Unit">finishWithError</a><span class="delimiter">(</span><a href="#50312" title="java.io.IOException">e</a><span class="delimiter">)</span>
              <a href="#49709" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <span class="comment">// start reading thread</span>
      <a href="#49449" title="=&gt; java.util.concurrent.ExecutorService">connectionPool</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#49736" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">makeRunnable</a> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.DataInputStream" id="50317">dataInputStream</a> = <span title="java.io.DataInputStream" class="keyword">new</span> <span title="java.io.DataInputStream">DataInputStream</span><span class="delimiter">(</span><a href="#49728" title="=&gt; java.io.InputStream">inputStream</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#49706" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#50366" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="Int" id="50367">len</a> = <a href="#50317" title="java.io.DataInputStream">dataInputStream</a>.<span title="()Int">readInt</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#50367" title="Int">len</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Read bad input length: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#50367" title="Int">len</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#49709" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="Array[Byte]" id="50377">bytes</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><a href="#50367" title="Int">len</a><span class="delimiter">)</span>
              <a href="#50317" title="java.io.DataInputStream">dataInputStream</a>.<span title="(x$1: Array[Byte])Unit">readFully</span><span class="delimiter">(</span><a href="#50377" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
              <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryDecoder" id="50378">inStream</a> = <span title="object org.apache.avro.io.DecoderFactory">DecoderFactory</span>.<span title="()org.apache.avro.io.DecoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.InputStream, x$2: org.apache.avro.io.BinaryDecoder)org.apache.avro.io.BinaryDecoder">directBinaryDecoder</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> <span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#50377" title="Array[Byte]">bytes</a><span class="delimiter">)</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> 
              <span class="keyword">val</span> <a title="R" id="50379">msg</a> = <a href="#49439" title="=&gt; Class[R]">msgRecvClass</a>.<span title="()R">newInstance</span>
              <a href="#49443" title="=&gt; org.apache.avro.specific.SpecificDatumReader[R]">msgReader</a>.<span title="(x$1: R, x$2: org.apache.avro.io.Decoder)R">read</span><span class="delimiter">(</span><a href="#50379" title="R">msg</a>, <a href="#50378" title="org.apache.avro.io.BinaryDecoder">inStream</a><span class="delimiter">)</span>
              <a href="../AvroChannelManager.scala.html#21016" title="(src: edu.berkeley.cs.scads.comm.RemoteNode, msg: R)Unit">receiveMessage</a><span class="delimiter">(</span><a href="#49720" title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode">remoteNode</a>, <a href="#50379" title="R">msg</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a title="Unit" id="50418">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
              <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Caught error in reading&quot;)" class="string">&quot;Caught error in reading&quot;</span>, <a href="#50418" title="java.io.IOException">e</a><span class="delimiter">)</span>
              <a href="#49709" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    
    <span class="delimiter">}</span>

    <span class="comment">/** Does the message framing (using 4 bytes) */</span>
    <span class="keyword">def</span> <a title="(bytes: Array[Byte], offset: Int, length: Int, flush: Boolean)Unit" id="49734">send</a><span class="delimiter">(</span><a title="Array[Byte]" id="49986">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Int" id="49987">offset</a>: <span title="Int">Int</span>, <a title="Int" id="49988">length</a>: <span title="Int">Int</span>, <a title="Boolean" id="49989">flush</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#49986" title="Array[Byte]">bytes</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;Bytes cannot be null&quot;)" class="string">&quot;Bytes cannot be null&quot;</span><span class="delimiter">)</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#49987" title="Int">offset</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span>, <span title="java.lang.String(&quot;Offset cannot be negative&quot;)" class="string">&quot;Offset cannot be negative&quot;</span><span class="delimiter">)</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#49988" title="Int">length</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span>, <span title="java.lang.String(&quot;Length cannot be negative&quot;)" class="string">&quot;Length cannot be negative&quot;</span><span class="delimiter">)</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#49987" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#49988" title="Int">length</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <a href="#49986" title="Array[Byte]">bytes</a>.<span title="=&gt; Int">length</span>, <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;offset + length cannot exceed bounds of array: offset %d, length: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#49987" title="Int">offset</a>, <a href="#49988" title="Int">length</a><span class="delimiter">)</span><span class="delimiter">)</span>

      <a href="#49712" title="()Unit">ensureRunning</a><span class="delimiter">(</span><span class="delimiter">)</span>

      <span class="keyword">def</span> <a title="(v: Int, b: Array[Byte], startPos: Int)Unit" id="50423">writeInt</a><span class="delimiter">(</span><a title="Int" id="50452">v</a>: <span title="Int">Int</span>, <a title="Array[Byte]" id="50453">b</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Int" id="50454">startPos</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#50453" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#50454" title="Int">startPos</a><span class="delimiter">)</span>     = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#50452" title="Int">v</a> <span title="(x: Int)Int">&gt;&gt;&gt;</span> <span title="Int(24)" class="int">24</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
        <a href="#50453" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#50454" title="Int">startPos</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#50452" title="Int">v</a> <span title="(x: Int)Int">&gt;&gt;&gt;</span> <span title="Int(16)" class="int">16</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
        <a href="#50453" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#50454" title="Int">startPos</a> <span title="(x: Int)Int">+</span> <span title="Int(2)" class="int">2</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#50452" title="Int">v</a> <span title="(x: Int)Int">&gt;&gt;&gt;</span> <span title="Int(8)" class="int">8</span><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
        <a href="#50453" title="(i: Int, x: Byte)Unit">b</a><span class="delimiter">(</span><a href="#50454" title="Int">startPos</a> <span title="(x: Int)Int">+</span> <span title="Int(3)" class="int">3</span><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><a href="#50452" title="Int">v</a> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>
      <span class="delimiter">}</span>

      <span class="keyword">val</span> <a title="BlockingChannelManager.this.SendTask" id="50424">task</a> = 
        <span title="BlockingChannelManager.this.SendTask" class="keyword">if</span> <span class="delimiter">(</span><a href="#49987" title="Int">offset</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#50423" title="(v: Int, b: Array[Byte], startPos: Int)Unit">writeInt</a><span class="delimiter">(</span><a href="#49988" title="Int">length</a>, <a href="#49986" title="Array[Byte]">bytes</a>, <a href="#49987" title="Int">offset</a> <span title="(x: Int)Int">-</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span>
          <span title="BlockingChannelManager.this.SendTask" class="keyword">new</span> <a href="#49465" title="BlockingChannelManager.this.SendTask">SendTask</a><span class="delimiter">(</span><a href="#49986" title="Array[Byte]">bytes</a>, <a href="#49987" title="Int">offset</a> <span title="(x: Int)Int">-</span> <span title="Int(4)" class="int">4</span>, <a href="#49988" title="Int">length</a> <span title="(x: Int)Int">+</span> <span title="Int(4)" class="int">4</span>, <a href="#49989" title="Boolean">flush</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Array[Byte]" id="50513">newArray</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><a href="#49988" title="Int">length</a> <span title="(x: Int)Int">+</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span>
          <a href="#50423" title="(v: Int, b: Array[Byte], startPos: Int)Unit">writeInt</a><span class="delimiter">(</span><a href="#49988" title="Int">length</a>, <a href="#50513" title="Array[Byte]">newArray</a>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> 
          <span title="object java.lang.System">System</span>.<span title="(x$1: Any, x$2: Int, x$3: Any, x$4: Int, x$5: Int)Unit">arraycopy</span><span class="delimiter">(</span><a href="#49986" title="Array[Byte]">bytes</a>, <a href="#49987" title="Int">offset</a>, <a href="#50513" title="Array[Byte]">newArray</a>, <span title="Int(4)" class="int">4</span>, <a href="#49988" title="Int">length</a><span class="delimiter">)</span>
          <span title="BlockingChannelManager.this.SendTask" class="keyword">new</span> <a href="#49465" title="BlockingChannelManager.this.SendTask">SendTask</a><span class="delimiter">(</span><a href="#50513" title="Array[Byte]">newArray</a>, <span title="Int(0)" class="int">0</span>, <a href="#49988" title="Int">length</a> <span title="(x: Int)Int">+</span> <span title="Int(4)" class="int">4</span>, <a href="#49989" title="Boolean">flush</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>

      <a href="#49724" title="=&gt; java.util.concurrent.LinkedBlockingQueue[BlockingChannelManager.this.SendTask]">sendQueue</a>.<span title="(x$1: BlockingChannelManager.this.SendTask)Boolean">offer</span><span title="Unit" class="delimiter">(</span><a href="#50424" title="BlockingChannelManager.this.SendTask">task</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">val</span> <a title="java.lang.Object" id="49469">V</a> = <span title="java.lang.Object" class="keyword">new</span> <span title="java.lang.Object">Object</span>

  <span class="keyword">class</span> <a title="class Listener extends java.lang.Object with BlockingChannelManager.this.Stoppable with BlockingChannelManager.this.RunnableHelper with ScalaObject" id="49471">Listener</a><a href="#49471" title="ScalaObject" class="delimiter">(</a><a title="java.net.ServerSocket" id="50040">serverSocket</a>: <span title="java.net.ServerSocket">ServerSocket</span><span class="delimiter">)</span> 
    <span class="keyword">extends</span> <a href="#49467" title="BlockingChannelManager.this.Stoppable">Stoppable</a> <span class="keyword">with</span> <a href="#49466" title="BlockingChannelManager.this.RunnableHelper">RunnableHelper</a> <span class="delimiter">{</span>
    <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#50040" title="java.net.ServerSocket">serverSocket</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="49843">port</a> = <a href="#50040" title="java.net.ServerSocket">serverSocket</a>.<span title="()Int">getLocalPort</span>

    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]" id="49845">connectionsSet</a> = 
      <span title="()java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">ConcurrentHashMap</span><span class="delimiter">[</span>EphemeralConnection, Object<span class="delimiter">]</span>

    <span class="keyword">class</span> <a title="class EphemeralConnection extends BlockingChannelManager.this.Connection with ScalaObject" id="49847">EphemeralConnection</a><a href="#49847" title="ScalaObject" class="delimiter">(</a><a title="java.net.Socket" id="50648">socket</a>: <span title="java.net.Socket">Socket</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#49468" title="BlockingChannelManager.this.Connection">Connection</a><span class="delimiter">(</span><a href="#50648" title="java.net.Socket">socket</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="50597">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#49847" title="Listener.this.EphemeralConnection" class="keyword">super</a>.<a href="#49730" title="()Unit">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="java.lang.Object" id="50650">test</a> = <a href="#49845" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="(x$1: Any)java.lang.Object">remove</span><span class="delimiter">(</span><a href="#49847" title="Listener.this.EphemeralConnection" class="keyword">this</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#50650" title="java.lang.Object">test</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> 
          <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;ephemeral connection was not in connection set: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#49847" title="Listener.this.EphemeralConnection" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="49848">doAfterStop</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
      <a href="#49455" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BlockingChannelManager.this.Listener]">portToListeners</a>.<span title="(x$1: Any)BlockingChannelManager.this.Listener">remove</span><span class="delimiter">(</span><a href="#49843" title="=&gt; Int">port</a><span class="delimiter">)</span>
      <a href="#49845" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="(s: java.util.Set[Listener.this.EphemeralConnection])scala.collection.mutable.Set[Listener.this.EphemeralConnection]">keySet</span>.<span title="(f: Listener.this.EphemeralConnection =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#51082" title="Listener.this.EphemeralConnection">_</a>.<a href="#49709" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#49845" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#50040" title="java.net.ServerSocket">serverSocket</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#49447" title="=&gt; java.util.concurrent.ExecutorService">listenerPool</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#49736" title="(f: =&gt; Unit)java.lang.Object with java.lang.Runnable">makeRunnable</a> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#49706" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#51084" title="()Unit" class="keyword">try</a> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="java.net.Socket" id="51085">client</a> = <a href="#50040" title="java.net.ServerSocket">serverSocket</a>.<span title="()java.net.Socket">accept</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#49706" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">continue</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#51085" title="java.net.Socket">client</a>.<span title="(x$1: Boolean)Unit">setTcpNoDelay</span><span class="delimiter">(</span><a href="#49437" title="=&gt; Boolean">useTcpNoDelay</a><span class="delimiter">)</span> <span class="comment">// disable Nagle's algorithm</span>

            <span class="keyword">val</span> <a title="Listener.this.EphemeralConnection" id="51086">conn</a> = <span title="Listener.this.EphemeralConnection" class="keyword">new</span> <a href="#49847" title="Listener.this.EphemeralConnection">EphemeralConnection</a><span class="delimiter">(</span><a href="#51085" title="java.net.Socket">client</a><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="BlockingChannelManager.this.Connection" id="51087">prev</a> = <a href="#49453" title="=&gt; java.util.concurrent.ConcurrentHashMap[java.net.InetSocketAddress,BlockingChannelManager.this.Connection]">nodeToConnections</a>.<span title="(x$1: java.net.InetSocketAddress, x$2: BlockingChannelManager.this.Connection)BlockingChannelManager.this.Connection">putIfAbsent</span><span class="delimiter">(</span><a href="#49473" title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket">client</a>.<a href="#50118" title="=&gt; java.net.InetSocketAddress">remoteInetSocketAddress</a>, <a href="#51086" title="Listener.this.EphemeralConnection">conn</a><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#51087" title="BlockingChannelManager.this.Connection">prev</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unable to enter new remote connection into connection map: refusing connection&quot;)" class="string">&quot;Unable to enter new remote connection into connection map: refusing connection&quot;</span><span class="delimiter">)</span>
              <a href="#51086" title="Listener.this.EphemeralConnection">conn</a>.<a href="#49709" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <a href="#49845" title="=&gt; java.util.concurrent.ConcurrentHashMap[Listener.this.EphemeralConnection,java.lang.Object]">connectionsSet</a>.<span title="(x$1: Listener.this.EphemeralConnection, x$2: java.lang.Object)java.lang.Object">put</span><span class="delimiter">(</span><a href="#51086" title="Listener.this.EphemeralConnection">conn</a>, <a href="#49469" title="=&gt; java.lang.Object">V</a><span class="delimiter">)</span>
            <a href="#51086" title="Listener.this.EphemeralConnection">conn</a>.<a href="#49731" title="()Unit">initialize</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// start send/read threads</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="51102">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
            <a href="#49435" title="=&gt; net.lag.logging.Logger">log</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Caught error in accepting&quot;)" class="string">&quot;Caught error in accepting&quot;</span>, <a href="#51102" title="java.io.IOException">e</a><span class="delimiter">)</span>
            <a href="#49709" title="()Unit">stop</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class RichSocket extends java.lang.Object with ScalaObject" id="49472">RichSocket</a><a href="#49472" title="ScalaObject" class="delimiter">(</a><a title="java.net.Socket" id="51109">socket</a>: <span title="java.net.Socket">Socket</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; java.net.InetSocketAddress" id="50118">remoteInetSocketAddress</a> = 
      <span title="(x$1: java.net.InetAddress, x$2: Int)java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#51109" title="java.net.Socket">socket</a>.<span title="()java.net.InetAddress">getInetAddress</span>, <a href="#51109" title="java.net.Socket">socket</a>.<span title="()Int">getPort</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="=&gt; java.net.InetSocketAddress" id="50119">localInetSocketAddress</a> = 
      <span title="(x$1: java.net.InetAddress, x$2: Int)java.net.InetSocketAddress" class="keyword">new</span> <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">(</span><a href="#51109" title="java.net.Socket">socket</a>.<span title="()java.net.InetAddress">getLocalAddress</span>, <a href="#51109" title="java.net.Socket">socket</a>.<span title="()Int">getLocalPort</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichSocket : (socket: java.net.Socket)BlockingChannelManager.this.RichSocket" id="49473">toRichSocket</a><span class="delimiter">(</span><a title="java.net.Socket" id="49544">socket</a>: <span title="java.net.Socket">Socket</span><span class="delimiter">)</span>: <a href="#49472" title="BlockingChannelManager.this.RichSocket">RichSocket</a> = 
    <span title="BlockingChannelManager.this.RichSocket" class="keyword">new</span> <a href="#49472" title="BlockingChannelManager.this.RichSocket">RichSocket</a><span class="delimiter">(</span><a href="#49544" title="java.net.Socket">socket</a><span class="delimiter">)</span>

  <span class="keyword">class</span> <a title="class RichInetSocketAddress extends java.lang.Object with ScalaObject" id="49474">RichInetSocketAddress</a><a href="#49474" title="ScalaObject" class="delimiter">(</a><a title="java.net.InetSocketAddress" id="51112">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.RemoteNode" id="50135">toRemoteNode</a> = 
      <a href="../AvroChannelManager.scala.html#20827" title="(hostname: String, port: Int)edu.berkeley.cs.scads.comm.RemoteNode">RemoteNode</a><span class="delimiter">(</span><a href="#51112" title="java.net.InetSocketAddress">addr</a>.<span title="()java.lang.String">getHostName</span>, <a href="#51112" title="java.net.InetSocketAddress">addr</a>.<span title="()Int">getPort</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.comm.oio.BlockingChannelManager.toRichInetSocketAddress : (addr: java.net.InetSocketAddress)BlockingChannelManager.this.RichInetSocketAddress" id="49475">toRichInetSocketAddress</a><span class="delimiter">(</span><a title="java.net.InetSocketAddress" id="49546">addr</a>: <span title="java.net.InetSocketAddress">InetSocketAddress</span><span class="delimiter">)</span>: <a href="#49474" title="BlockingChannelManager.this.RichInetSocketAddress">RichInetSocketAddress</a> =
    <span title="BlockingChannelManager.this.RichInetSocketAddress" class="keyword">new</span> <a href="#49474" title="BlockingChannelManager.this.RichInetSocketAddress">RichInetSocketAddress</a><span class="delimiter">(</span><a href="#49546" title="java.net.InetSocketAddress">addr</a><span class="delimiter">)</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>