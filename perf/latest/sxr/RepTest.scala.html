<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>RepTest.scala</title>
        <script type="text/javascript" src="jquery-all.js"></script>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.perf
<span class="keyword">package</span> reptest

<span class="keyword">import</span> deploylib._
<span class="keyword">import</span> deploylib.mesos._
<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.scads.config._
<span class="keyword">import</span> edu.berkeley.cs.scads.storage._
<span class="keyword">import</span> edu.berkeley.cs.avro.runtime._
<span class="keyword">import</span> edu.berkeley.cs.avro.marker._

<span class="keyword">import</span> org.apache.zookeeper.CreateMode

<span class="keyword">import</span> java.io.File 

case <span class="keyword">class</span> <a href="#56469" title="class RepResultKey extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="45027">RepResultKey</a><a href="#45027" title="ScalaObject" class="delimiter">(</a><a href="#45027" title="()edu.berkeley.cs.scads.perf.reptest.RepResultKey" id="47679" class="keyword">var</a> <a title="String" id="44912">cluster</a>: <span title="String">String</span>, <span class="keyword">var</span> <a title="Int" id="44913">iteration</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>
case <span class="keyword">class</span> <a href="#56782" title="class RepResultValue extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="45023">RepResultValue</a><a href="#45023" title="ScalaObject" class="delimiter">(</a><a href="#45023" title="()edu.berkeley.cs.scads.perf.reptest.RepResultValue" id="47689" class="keyword">var</a> <a title="Long" id="44921">startTime</a>: <span title="Long">Long</span>, <span class="keyword">var</span> <a title="Long" id="44922">endTime</a>: <span title="Long">Long</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>

<span class="keyword">trait</span> <a title="trait StorageServiceSorter extends java.lang.Object with ScalaObject" id="9577">StorageServiceSorter</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(x: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.StorageService]" id="43109">orderStorageServices</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.StorageService]" id="43112">x</a>: <span title="Seq[edu.berkeley.cs.scads.comm.StorageService]">Seq</span><span class="delimiter">[</span>StorageService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.StorageService]">Seq</span><span class="delimiter">[</span>StorageService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#43112" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">x</a>.<span title="(f: edu.berkeley.cs.scads.comm.StorageService =&gt; (String, Int, java.lang.String))(implicit ord: scala.math.Ordering[(String, Int, java.lang.String)])Seq[edu.berkeley.cs.scads.comm.StorageService]">sortBy</span><span title="(implicit ord1: scala.math.Ordering[String], implicit ord2: scala.math.Ordering[Int], implicit ord3: scala.math.Ordering[java.lang.String])scala.math.Ordering[(String, Int, java.lang.String)]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.StorageService" id="43120">s</a> =&gt; <span title="(_1: String, _2: Int, _3: java.lang.String)(String, Int, java.lang.String)" class="delimiter">(</span><a href="#43120" title="edu.berkeley.cs.scads.comm.StorageService">s</a>.<span title="=&gt; String">host</span>, <a href="#43120" title="edu.berkeley.cs.scads.comm.StorageService">s</a>.<span title="=&gt; Int">port</span>, <a href="#43120" title="edu.berkeley.cs.scads.comm.StorageService">s</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</span> <span title="java.lang.String" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="java.lang.String">ActorNumber</span><span class="delimiter">(</span><a title="Long" id="43164">x</a><span class="delimiter">)</span> =&gt; <a href="#43164" title="Long">x</a>.<span title="()java.lang.String">toString</span>
      <span class="keyword">case</span> <span title="String">ActorName</span><span class="delimiter">(</span><a title="String" id="43201">x</a><span class="delimiter">)</span> =&gt; <a href="#43201" title="String">x</a>
    <span class="delimiter">}</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

case <span class="keyword">class</span> <a href="#56792" title="class DataLoader extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.perf.DataLoadingTask with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.perf.reptest.StorageServiceSorter with ScalaObject with Product with Serializable" id="45019">DataLoader</a><a href="#45019" title="ScalaObject" class="delimiter">(</a><a href="#45019" title="()edu.berkeley.cs.scads.perf.reptest.DataLoader" id="47699" class="keyword">var</a> <a title="Int" id="45009">numLoaders</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="Int" id="45010">recsPerLoader</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="Int" id="45016">numServers</a>: <span title="Int">Int</span> = <span title="Int(2)" class="int">2</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="AvroClient.scala.html#9503" title="edu.berkeley.cs.scads.perf.DataLoadingTask">DataLoadingTask</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#9577" title="edu.berkeley.cs.scads.perf.reptest.StorageServiceSorter">StorageServiceSorter</a> <span class="delimiter">{</span>

  <span class="keyword">var</span> <a title="String" id="43574">clusterAddress</a>: <span title="String">String</span> = _

  <span class="keyword">def</span> <a title="()Unit" id="43576">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#45009" title="=&gt; Int">numLoaders</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;need &gt;= 1 data loader&quot;)" class="string">&quot;need &gt;= 1 data loader&quot;</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#45010" title="=&gt; Int">recsPerLoader</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span>, <span title="java.lang.String(&quot;need &gt; 0 recs per loader&quot;)" class="string">&quot;need &gt; 0 recs per loader&quot;</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#45016" title="=&gt; Int">numServers</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;need &gt;= 1 server&quot;)" class="string">&quot;need &gt;= 1 server&quot;</span><span class="delimiter">)</span>
    
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="43595">clusterRoot</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#43574" title="=&gt; String">clusterAddress</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="43596">coordination</a> = <a href="#43595" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(rpath: java.lang.String, tries: Int)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrCreate</span><span class="delimiter">(</span><span title="java.lang.String(&quot;coordination/loaders&quot;)" class="string">&quot;coordination/loaders&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" id="43597">cluster</a> = <span title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster" class="keyword">new</span> <a href="Experiment.scala.html#9518" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">ExperimentalScadsCluster</a><span class="delimiter">(</span><a href="#43595" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Int" id="43598">clientId</a> = <a href="#43596" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;clientsStart&quot;)" class="string">&quot;clientsStart&quot;</span>, <a href="#45009" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#43598" title="Int">clientId</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#43597" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<a href="Experiment.scala.html#30884" title="(clusterSize: Int)Unit">blockUntilReady</a><span class="delimiter">(</span><a href="#45016" title="=&gt; Int">numServers</a><span class="delimiter">)</span>
      <a href="#43597" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="[KeyType &lt;: org.apache.avro.specific.SpecificRecord, ValueType &lt;: org.apache.avro.specific.SpecificRecord](ns: String, servers: Seq[(Option[KeyType], Seq[edu.berkeley.cs.scads.comm.StorageService])])(implicit evidence$5: Manifest[KeyType], implicit evidence$6: Manifest[ValueType])edu.berkeley.cs.scads.storage.SpecificNamespace[KeyType,ValueType]">createNamespace</span><span title="(ns: String, servers: Seq[(Option[edu.berkeley.cs.scads.comm.IntRec], Seq[edu.berkeley.cs.scads.comm.StorageService])])(implicit evidence$5: Manifest[edu.berkeley.cs.scads.comm.IntRec], implicit evidence$6: Manifest[edu.berkeley.cs.scads.comm.IntRec])edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.comm.IntRec">IntRec</span>, <span title="edu.berkeley.cs.scads.comm.IntRec">IntRec</span><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.comm.IntRec]" class="delimiter">(</span><span title="java.lang.String(&quot;repscaletest&quot;)" class="string">&quot;repscaletest&quot;</span>, <span title="(xs: (None.type, List[edu.berkeley.cs.scads.comm.StorageService])*)List[(None.type, List[edu.berkeley.cs.scads.comm.StorageService])]">List</span><span class="delimiter">(</span><span title="(x: None.type)ArrowAssoc[None.type]">None</span> <span title="(y: List[edu.berkeley.cs.scads.comm.StorageService])(None.type, List[edu.berkeley.cs.scads.comm.StorageService])">-&gt;</span> <span title="(xs: edu.berkeley.cs.scads.comm.StorageService*)List[edu.berkeley.cs.scads.comm.StorageService]">List</span><span class="delimiter">(</span><a href="#43109" title="(x: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.StorageService]">orderStorageServices</a><span class="delimiter">(</span><a href="#43597" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="()List[edu.berkeley.cs.scads.comm.StorageService]">getAvailableServers</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">head</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#43596" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;startWrite&quot;)" class="string">&quot;startWrite&quot;</span>, <a href="#45009" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]" id="43599">ns</a> = <a href="#43597" title="edu.berkeley.cs.scads.perf.ExperimentalScadsCluster">cluster</a>.<span title="[KeyType &lt;: org.apache.avro.specific.SpecificRecord, ValueType &lt;: org.apache.avro.specific.SpecificRecord](ns: String)(implicit evidence$1: Manifest[KeyType], implicit evidence$2: Manifest[ValueType])edu.berkeley.cs.scads.storage.SpecificNamespace[KeyType,ValueType]">getNamespace</span><span title="(ns: String)(implicit evidence$1: Manifest[edu.berkeley.cs.scads.comm.IntRec], implicit evidence$2: Manifest[edu.berkeley.cs.scads.comm.IntRec])edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.comm.IntRec">IntRec</span>, <span title="edu.berkeley.cs.scads.comm.IntRec">IntRec</span><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.comm.IntRec]" class="delimiter">(</span><span title="java.lang.String(&quot;repscaletest&quot;)" class="string">&quot;repscaletest&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Int" id="43600">startKey</a> = <a href="#43598" title="Int">clientId</a> <span title="(x: Int)Int">*</span> <a href="#45010" title="=&gt; Int">recsPerLoader</a>
    <span class="keyword">val</span> <a title="Int" id="43601">endKey</a> = <span class="delimiter">(</span><a href="#43598" title="Int">clientId</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(x: Int)Int">*</span> <a href="#45010" title="=&gt; Int">recsPerLoader</a>

    <a href="#45019" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Starting bulk put&quot;)" class="string">&quot;Starting bulk put&quot;</span><span class="delimiter">)</span>
    <a href="#43599" title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]">ns</a> <span title="(that: TraversableOnce[(edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec)])Unit">++=</span> <span class="delimiter">(</span><a href="#43600" title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt">startKey</a> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#43601" title="Int">endKey</a><span class="delimiter">)</span>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]]">view</span>.<span title="(f: Int =&gt; (edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[Int,scala.collection.immutable.IndexedSeq[Int]],(edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec),TraversableOnce[(edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec)]])TraversableOnce[(edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.SeqView.Coll,(edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec),scala.collection.SeqView[(edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec),Seq[_]]]" class="delimiter">(</span><a title="Int" id="43850">i</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.IntRec, _2: edu.berkeley.cs.scads.comm.IntRec)(edu.berkeley.cs.scads.comm.IntRec, edu.berkeley.cs.scads.comm.IntRec)" class="delimiter">(</span><span title="(f1: Int)edu.berkeley.cs.scads.comm.IntRec">IntRec</span><span class="delimiter">(</span><a href="#43850" title="Int">i</a><span class="delimiter">)</span>, <span title="(f1: Int)edu.berkeley.cs.scads.comm.IntRec">IntRec</span><span class="delimiter">(</span><a href="#43850" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#45019" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bulk put complete&quot;)" class="string">&quot;Bulk put complete&quot;</span><span class="delimiter">)</span>

    <a href="#43596" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">coordination</a>.<span title="(barrierName: String, count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Int">registerAndAwait</span><span class="delimiter">(</span><span title="java.lang.String(&quot;endWrite&quot;)" class="string">&quot;endWrite&quot;</span>, <a href="#45009" title="=&gt; Int">numLoaders</a><span class="delimiter">)</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#43598" title="Int">clientId</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <a href="#43595" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;clusterReady&quot;)" class="string">&quot;clusterReady&quot;</span>, data = <a href="#45019" title="(record: edu.berkeley.cs.scads.perf.reptest.DataLoader)edu.berkeley.cs.avro.runtime.RichIndexedRecord[edu.berkeley.cs.scads.perf.reptest.DataLoader]" class="keyword">this</a>.<span title="=&gt; String">toJson</span>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

case <span class="keyword">class</span> <a href="#57104" title="class RepClient extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.scads.perf.ReplicatedExperimentTask with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.perf.reptest.StorageServiceSorter with ScalaObject with Product with Serializable" id="45003">RepClient</a><a href="#45003" title="ScalaObject" class="delimiter">(</a><a href="#45003" title="()edu.berkeley.cs.scads.perf.reptest.RepClient" id="47709" class="keyword">var</a> <a title="Int" id="44998">numIterations</a>: <span title="Int">Int</span>, <span class="keyword">var</span> <a title="String" id="44999">clusterAddress</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="AvroClient.scala.html#9504" title="edu.berkeley.cs.scads.perf.ReplicatedExperimentTask">ReplicatedExperimentTask</a> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#9577" title="edu.berkeley.cs.scads.perf.reptest.StorageServiceSorter">StorageServiceSorter</a> <span class="delimiter">{</span>

  <span class="comment">/** For now, only a single rep client runs and issues replication calls */</span> 
  <span class="keyword">var</span> <a title="Int" id="44002">numClients</a> = <span title="Int(1)" class="int">1</span>
  <span class="keyword">var</span> <a title="String" id="44005">experimentAddress</a>: <span title="String">String</span> = _
  <span class="keyword">var</span> <a title="String" id="44008">resultClusterAddress</a>: <span title="String">String</span> = _

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Int" id="44011">test</a> = <span title="Int(1)" class="int">1</span>

  <span class="keyword">def</span> <a title="()Unit" id="44012">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="44025">clusterRoot</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#44999" title="=&gt; String">clusterAddress</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="44026">experimentRoot</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#44005" title="=&gt; String">experimentAddress</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.perf.reptest.DataLoader" id="44027">dataLoader</a> = classOf<span title="java.lang.Class[edu.berkeley.cs.scads.perf.reptest.DataLoader](classOf[edu.berkeley.cs.scads.perf.reptest.DataLoader])" class="delimiter">[</span>DataLoader<span class="delimiter">]</span>.<span title="(record: edu.berkeley.cs.scads.perf.reptest.DataLoader)edu.berkeley.cs.avro.runtime.RichIndexedRecord[edu.berkeley.cs.scads.perf.reptest.DataLoader]">newInstance</span>.<span title="(data: String)edu.berkeley.cs.scads.perf.reptest.DataLoader">parse</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#44025" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(name: String, seqNumber: Option[Int], timeout: Long, unit: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">awaitChild</span><span class="delimiter">(</span><span title="java.lang.String(&quot;clusterReady&quot;)" class="string">&quot;clusterReady&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="44028">cluster</a> = <span title="edu.berkeley.cs.scads.storage.ScadsCluster" class="keyword">new</span> <span title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</span><span class="delimiter">(</span><a href="#44025" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]" id="44029">ns</a> = <a href="#44028" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[KeyType &lt;: org.apache.avro.specific.SpecificRecord, ValueType &lt;: org.apache.avro.specific.SpecificRecord](ns: String)(implicit evidence$1: Manifest[KeyType], implicit evidence$2: Manifest[ValueType])edu.berkeley.cs.scads.storage.SpecificNamespace[KeyType,ValueType]">getNamespace</span><span title="(ns: String)(implicit evidence$1: Manifest[edu.berkeley.cs.scads.comm.IntRec], implicit evidence$2: Manifest[edu.berkeley.cs.scads.comm.IntRec])edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.comm.IntRec">IntRec</span>, <span title="edu.berkeley.cs.scads.comm.IntRec">IntRec</span><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.comm.IntRec]" class="delimiter">(</span><span title="java.lang.String(&quot;repscaletest&quot;)" class="string">&quot;repscaletest&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.perf.reptest.RepResultKey,edu.berkeley.cs.scads.perf.reptest.RepResultValue]" id="44030">loadResults</a> = <a href="#44028" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="[KeyType &lt;: org.apache.avro.specific.SpecificRecord, ValueType &lt;: org.apache.avro.specific.SpecificRecord](ns: String)(implicit evidence$1: Manifest[KeyType], implicit evidence$2: Manifest[ValueType])edu.berkeley.cs.scads.storage.SpecificNamespace[KeyType,ValueType]">getNamespace</span><span title="(ns: String)(implicit evidence$1: Manifest[edu.berkeley.cs.scads.perf.reptest.RepResultKey], implicit evidence$2: Manifest[edu.berkeley.cs.scads.perf.reptest.RepResultValue])edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.perf.reptest.RepResultKey,edu.berkeley.cs.scads.perf.reptest.RepResultValue]" class="delimiter">[</span><a href="#45027" title="edu.berkeley.cs.scads.perf.reptest.RepResultKey">RepResultKey</a>, <a href="#45023" title="edu.berkeley.cs.scads.perf.reptest.RepResultValue">RepResultValue</a><span class="delimiter">]</span><span title="(clazz: Class[_])scala.reflect.Manifest[edu.berkeley.cs.scads.perf.reptest.RepResultKey]" class="delimiter">(</span><span title="java.lang.String(&quot;repResults&quot;)" class="string">&quot;repResults&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.StorageService]" id="44031">servers</a> = <a href="#43109" title="(x: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.StorageService]">orderStorageServices</a><span class="delimiter">(</span><a href="#44028" title="edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<span title="()List[edu.berkeley.cs.scads.comm.StorageService]">getAvailableServers</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.StorageService]">toIndexedSeq</span>

    <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="44253">iteration</a> &lt;- <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#44998" title="=&gt; Int">numIterations</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#45003" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begining Iteration %d&quot;)" class="string">&quot;Begining Iteration %d&quot;</span>, <a href="#44253" title="Int">iteration</a><span class="delimiter">)</span>

      <span class="comment">// next storage service to replicate to</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.StorageService" id="44254">storageService</a> = <a href="#44031" title="(idx: Int)edu.berkeley.cs.scads.comm.StorageService">servers</a><span class="delimiter">(</span><a href="#44998" title="=&gt; Int">numIterations</a> <span title="(x: Int)Int">%</span> <a href="#44031" title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.StorageService]">servers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>

      <span class="keyword">val</span> <a title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.PartitionService]" id="44255">oldPartitions</a> = <a href="#44029" title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]">ns</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">routingTable</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</span>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.comm.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]],edu.berkeley.cs.scads.comm.PartitionService,Seq[edu.berkeley.cs.scads.comm.PartitionService]])Seq[edu.berkeley.cs.scads.comm.PartitionService]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.PartitionService,Seq[edu.berkeley.cs.scads.comm.PartitionService]]" class="delimiter">(</span><a href="#44746" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.PartitionService]">toIndexedSeq</span>

      <span class="keyword">val</span> <a title="Long" id="44256">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
      <span class="comment">// replicate all partitions to the next storage service</span>
      <a href="#44029" title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]">ns</a>.<span title="(targets: Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)])Seq[edu.berkeley.cs.scads.comm.PartitionService]">replicatePartitions</span><span class="delimiter">(</span><a href="#44255" title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartitions</a>.<span title="(that: scala.collection.GenIterable[edu.berkeley.cs.scads.comm.StorageService])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)]])Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)]">zip</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService),scala.collection.immutable.IndexedSeq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)]]" class="delimiter">(</span><span title="object List">List</span>.<span title="(n: Int)(elem: =&gt; edu.berkeley.cs.scads.comm.StorageService)List[edu.berkeley.cs.scads.comm.StorageService]">fill</span><span class="delimiter">(</span><a href="#44255" title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartitions</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#44254" title="edu.berkeley.cs.scads.comm.StorageService">storageService</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Long" id="44257">endTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>

      <a href="#44030" title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.perf.reptest.RepResultKey,edu.berkeley.cs.scads.perf.reptest.RepResultValue]">loadResults</a>.<span title="(key: edu.berkeley.cs.scads.perf.reptest.RepResultKey, value: Option[edu.berkeley.cs.scads.perf.reptest.RepResultValue])Unit">put</span><span class="delimiter">(</span><a href="#45027" title="(cluster: String, iteration: Int)edu.berkeley.cs.scads.perf.reptest.RepResultKey">RepResultKey</a><span class="delimiter">(</span><a href="#44025" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="=&gt; java.lang.String">canonicalAddress</span>, <a href="#44253" title="Int">iteration</a><span class="delimiter">)</span>, <span title="(x: edu.berkeley.cs.scads.perf.reptest.RepResultValue)Some[edu.berkeley.cs.scads.perf.reptest.RepResultValue]">Some</span><span class="delimiter">(</span><a href="#45023" title="(startTime: Long, endTime: Long)edu.berkeley.cs.scads.perf.reptest.RepResultValue">RepResultValue</a><span class="delimiter">(</span><a href="#44256" title="Long">startTime</a>, <a href="#44257" title="Long">endTime</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

      <span class="comment">// delete the existing partitions which were just replicated onto</span>
      <span class="comment">// storageService</span>
      <a href="#44029" title="edu.berkeley.cs.scads.storage.SpecificNamespace[edu.berkeley.cs.scads.comm.IntRec,edu.berkeley.cs.scads.comm.IntRec]">ns</a>.<span title="(partitionHandlers: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitions</span><span class="delimiter">(</span><a href="#44255" title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartitions</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#44025" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">clusterRoot</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;expFinished&quot;)" class="string">&quot;expFinished&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>


        </pre>
    </body>
</html>