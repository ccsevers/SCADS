<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/Routable.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.scads._
<span class="keyword">import</span> comm._
<span class="keyword">import</span> util._

<span class="keyword">import</span> java.nio._
<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>

<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> io._

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike" id="9659">DefaultKeyRoutableLike</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="38496">ZOOKEEPER_ROUTING_TABLE</a> = <span title="java.lang.String(&quot;routingtable&quot;)" class="string">&quot;routingtable&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="38498">ZOOKEEPER_PARTITION_ID</a> = <span title="java.lang.String(&quot;partitionid&quot;)" class="string">&quot;partitionid&quot;</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRoutableLike extends java.lang.Object with edu.berkeley.cs.scads.storage.KeyRoutable with edu.berkeley.cs.scads.storage.KeyPartitionable with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.GlobalMetadata with edu.berkeley.cs.scads.storage.RecordMetadata with edu.berkeley.cs.scads.storage.ParFuture with ScalaObject" id="9661">DefaultKeyRoutableLike</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9612" title="edu.berkeley.cs.scads.storage.KeyRoutable">KeyRoutable</a> 
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9617" title="edu.berkeley.cs.scads.storage.KeyPartitionable">KeyPartitionable</a>
  <span class="keyword">with</span> <a href="Namespace.scala.html#9625" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9618" title="edu.berkeley.cs.scads.storage.GlobalMetadata">GlobalMetadata</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9620" title="edu.berkeley.cs.scads.storage.RecordMetadata">RecordMetadata</a>
  <span class="keyword">with</span> <a href="../util/ParFuture.scala.html#9972" title="edu.berkeley.cs.scads.storage.ParFuture">ParFuture</a> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="#9659" title="object edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a>._
  <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike Constructor: %s&quot;)" class="string">&quot;DefaultKeyRoutableLike Constructor: %s&quot;</span>, <a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a><span class="delimiter">)</span>

  @volatile <span class="keyword">protected</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="37968">_routingTable</a>: <a href="../util/RangeTable.scala.html#9978" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeTable</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span> = _

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="37970">routingTable</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a> 

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37971">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#37981" title="(partitionHandlers: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#37985" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, <a href="Namespace.scala.html#13586" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<a href="ScadsCluster.scala.html#38037" title="(nbServer: Int)List[edu.berkeley.cs.scads.comm.StorageService]">getRandomServers</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#37975" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13605" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike create():&quot;)" class="string">&quot;DefaultKeyRoutableLike create():&quot;</span><span class="delimiter">)</span>
    <a href="#37971" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13607" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span> <a title="Boolean" id="55729">isNew</a> =&gt;
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike open():&quot;)" class="string">&quot;DefaultKeyRoutableLike open():&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#55729" title="Boolean">isNew</a><span class="delimiter">)</span> <a href="#37971" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="#37980" title="()Unit">loadRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#55729" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13609" title="(f: =&gt; Unit)Unit">onDelete</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike delete():&quot;)" class="string">&quot;DefaultKeyRoutableLike delete():&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.StorageService]" id="55733">storageHandlers</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38451" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.comm.StorageService])(implicit bf: scala.collection.generic.CanBuildFrom[Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]],edu.berkeley.cs.scads.comm.StorageService,Array[edu.berkeley.cs.scads.comm.StorageService]])Array[edu.berkeley.cs.scads.comm.StorageService]">flatMap</span><span title="(xs: Array[edu.berkeley.cs.scads.comm.StorageService])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.comm.StorageService]" class="delimiter">(</span><a href="#56185" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_</a>.<a href="../util/RangeTable.scala.html#38932" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]])Seq[edu.berkeley.cs.scads.comm.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]]" class="delimiter">(</span><a href="#56202" title="edu.berkeley.cs.scads.comm.PartitionService">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.StorageService]">toSet</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.DeleteNamespaceRequest" id="55734">delReq</a> = <span title="(namespace: String)edu.berkeley.cs.scads.comm.DeleteNamespaceRequest">DeleteNamespaceRequest</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13626" title="=&gt; String">name</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13638" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.StorageService),Unit])Seq[Either[Throwable,Unit]]">waitFor</a><span class="delimiter">(</span><a href="#55733" title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.StorageService]">storageHandlers</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.StorageService]">toSeq</span>.<span title="(f: edu.berkeley.cs.scads.comm.StorageService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.StorageService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.StorageService" id="56693">h</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.StorageService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)" class="delimiter">(</span><a href="#56693" title="edu.berkeley.cs.scads.comm.StorageService">h</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#55734" title="edu.berkeley.cs.scads.comm.DeleteNamespaceRequest">delReq</a>, <a href="#56693" title="edu.berkeley.cs.scads.comm.StorageService">h</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#56733" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>DeleteNamespaceResponse<span class="delimiter">(</span><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="56761">handler</a><span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Successfully deleted namespace %s on StorageHandler %s&quot;)" class="string">&quot;Successfully deleted namespace %s on StorageHandler %s&quot;</span>, <a href="Interfaces.scala.html#13626" title="=&gt; String">name</a>, <a href="#56761" title="edu.berkeley.cs.scads.comm.StorageService">handler</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>InvalidNamespace<span class="delimiter">(</span>_<span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="56804">handler</a><span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Got invalid namespace error for namespace %s on StorageService %s&quot;)" class="string">&quot;Got invalid namespace error for namespace %s on StorageService %s&quot;</span>, <a href="Interfaces.scala.html#13626" title="=&gt; String">name</a>, <a href="#56804" title="edu.berkeley.cs.scads.comm.StorageService">handler</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="56811">e</a>, _<span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected message from DeleteNamespaceRequest: %s&quot;)" class="string">&quot;Unexpected message from DeleteNamespaceRequest: %s&quot;</span>, <a href="#56811" title="edu.berkeley.cs.scads.comm.MessageBody">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#37968" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13608" title="(f: =&gt; Unit)Unit">onClose</a> <span class="delimiter">{</span>
    <span class="comment">// TODO</span>
    <a href="#37968" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="37972">serversForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="56818">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38469" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">valuesForKey</a><span class="delimiter">(</span><a href="Interfaces.scala.html#13619" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">(</span><a href="#56818" title="Array[Byte]">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(newTable: Array[Byte])Unit" id="37973">onRoutingTableChanged</a><span class="delimiter">(</span><a title="Array[Byte]" id="56830">newTable</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;onRoutingTableChanged&quot;)" class="string">&quot;onRoutingTableChanged&quot;</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; (Array[Byte], Array[Byte]) =&gt; Int" id="37974">routingKeyComp</a>: <span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; Int

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37975">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#37977" title="()Boolean">validateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;Holy shit, we are about to store a crappy Routing Table.&quot;)" class="string">&quot;Holy shit, we are about to store a crappy Routing Table.&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.KeyRange]" id="55586">ranges</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38482" title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; edu.berkeley.cs.scads.comm.KeyRange)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]],edu.berkeley.cs.scads.comm.KeyRange,Seq[edu.berkeley.cs.scads.comm.KeyRange]])Seq[edu.berkeley.cs.scads.comm.KeyRange]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.KeyRange,Seq[edu.berkeley.cs.scads.comm.KeyRange]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="55617">a</a> =&gt; <span title="(startKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.comm.KeyRange">KeyRange</span><span class="delimiter">(</span><a href="#55617" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">a</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#55617" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">a</a>.<a href="../util/RangeTable.scala.html#38932" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RoutingTableMessage" id="55587">rangeSeq</a> = <span title="(partitions: Seq[edu.berkeley.cs.scads.comm.KeyRange])edu.berkeley.cs.scads.comm.RoutingTableMessage">RoutingTableMessage</span><span class="delimiter">(</span><a href="#55586" title="Seq[edu.berkeley.cs.scads.comm.KeyRange]">ranges</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13634" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#38496" title="=&gt; java.lang.String">ZOOKEEPER_ROUTING_TABLE</a>, <a href="#55587" title="edu.berkeley.cs.scads.comm.RoutingTableMessage">rangeSeq</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37976">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#37975" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13636" title="()Unit">waitUntilMetadataPropagated</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This function tests if the routing table is in a good state.
   * Thus, all partitions in the routing table must react and all boundaries must be correct
   */</span>
  <span class="keyword">def</span> <a title="()Boolean" id="37977">validateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="56836">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="56856">range</a> &lt;- <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38482" title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; Unit)Unit">reverse</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="56873">partition</a> &lt;- <a href="#56856" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38932" title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; Unit)Unit">values</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="(Option[Array[Byte]], Option[Array[Byte]])" id="56874">keys</a> = <a href="#37979" title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span class="delimiter">(</span><a href="#56873" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#37978" title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean">optArrayEq</a><span class="delimiter">(</span><a href="#56874" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_1</span>, <a href="#56856" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span title="=&gt; Boolean">!</span><a href="#37978" title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean">optArrayEq</a><span class="delimiter">(</span><a href="#56874" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_2</span>, <a href="#56836" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="java.lang.String(&quot;The routing table is corrupted. Partition: &quot;)" class="string">&quot;The routing table is corrupted. Partition: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56873" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; with key [&quot;)" class="string">&quot; with key [&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56874" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_1</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56874" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_2</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;] != [&quot;)" class="string">&quot;] != [&quot;</span> <span title="(x$1: Any)java.lang.String">+</span>  <a href="#56856" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56836" title="Option[Array[Byte]]">endKey</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;] from table:&quot;)" class="string">&quot;] from table:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#56836" title="Option[Array[Byte]]">endKey</a> = <a href="#56856" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <span title="Boolean(true)" class="keyword">true</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean" id="37978">optArrayEq</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="56877">lhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="56878">rhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#56877" title="Option[Array[Byte]]">lhs</a>, <a href="#56878" title="Option[Array[Byte]]">rhs</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="56893">x</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="56895">y</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte], x$2: Array[Byte])Boolean">equals</span><span class="delimiter">(</span><a href="#56893" title="Array[Byte]">x</a>, <a href="#56895" title="Array[Byte]">y</a><span class="delimiter">)</span>
    <span class="keyword">case</span> <span title="Boolean">_</span> =&gt; <a href="#56877" title="Option[Array[Byte]]">lhs</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#56878" title="Option[Array[Byte]]">rhs</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])" id="37979">getStartEndKey</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="56875">partitionHandler</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span><span class="delimiter">)</span>: <span title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// This request could be avoided if we would store the ranges in the partitionHandler.</span>
    <span class="comment">// However replication is not on the critical path and so expensive anyway that it does not matter</span>

    <span class="keyword">val</span> <a title="(Option[Array[Byte]], Option[Array[Byte]])" id="57320">keys</a> = <a href="#56875" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody, timeout: Int)edu.berkeley.cs.scads.comm.MessageBody">!?</span> <span title="()edu.berkeley.cs.scads.comm.GetResponsibilityRequest">GetResponsibilityRequest</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(Option[Array[Byte]], Option[Array[Byte]])" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="(Option[Array[Byte]], Option[Array[Byte]])">GetResponsibilityResponse</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="57390">s</a>, <a title="Option[Array[Byte]]" id="57391">e</a><span class="delimiter">)</span> =&gt; <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#57390" title="Option[Array[Byte]]">s</a>, <a href="#57391" title="Option[Array[Byte]]">e</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message&quot;)" class="string">&quot;Unexpected Message&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <a href="#57320" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37980">loadRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RoutingTableMessage" id="57402">rangeSeq</a> = <span title="()edu.berkeley.cs.scads.comm.RoutingTableMessage" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.RoutingTableMessage">RoutingTableMessage</span>
    <a href="#57402" title="edu.berkeley.cs.scads.comm.RoutingTableMessage">rangeSeq</a>.<span title="(data: Array[Byte])rangeSeq.type">parse</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13632" title="(key: String, func: () =&gt; Unit)Array[Byte]">watchMetadata</a><span class="delimiter">(</span><a href="#38496" title="=&gt; java.lang.String">ZOOKEEPER_ROUTING_TABLE</a>, <a href="#37980" title="()Unit">loadRoutingTable</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="57403">partition</a> = <a href="#57402" title="edu.berkeley.cs.scads.comm.RoutingTableMessage">rangeSeq</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.KeyRange]">partitions</span>.<span title="(f: edu.berkeley.cs.scads.comm.KeyRange =&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.KeyRange],edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService],Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]])Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService],Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.KeyRange" id="57434">a</a> =&gt; <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</span> <a href="../util/RangeTable.scala.html#9981" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeType</a><span class="delimiter">(</span><a href="#57434" title="edu.berkeley.cs.scads.comm.KeyRange">a</a>.<span title="=&gt; Option[Array[Byte]]">startKey</span>, <a href="#57434" title="edu.berkeley.cs.scads.comm.KeyRange">a</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#37984" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#57403" title="Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">partition</a>.<span title="(implicit evidence$1: ClassManifest[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">toArray</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** create a routing table with the assumption that each PartitionService is going to handle
   * (None -&gt; None). note this assumption is NOT validated */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitionHandlers: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit" id="37981">createRoutingTable</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="55256">partitionHandlers</a>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="57502">arr</a> = <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <a href="#57502" title="(i: Int, x: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">arr</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</span> <a href="../util/RangeTable.scala.html#9981" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeType</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span><span title="object None">None</span>, <a href="#55256" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitionHandlers</a><span class="delimiter">)</span>
    <a href="#37984" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#57502" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">arr</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Boolean" id="37982">mergeCond</a> = <span class="delimiter">(</span>a: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, b: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
    <a href="#55215" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">a</a>.<span title="(that: scala.collection.GenSeq[edu.berkeley.cs.scads.comm.PartitionService])(p: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService) =&gt; Boolean)Boolean">corresponds</span><span class="delimiter">(</span><a href="#55216" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">b</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="55234">v1</a>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="55235">v2</a><span class="delimiter">)</span> =&gt; <a href="#55234" title="edu.berkeley.cs.scads.comm.PartitionService">v1</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#55235" title="edu.berkeley.cs.scads.comm.PartitionService">v2</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit" id="37984">createRoutingTable</a><span class="delimiter">(</span><a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="55254">ranges</a>: <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#37968" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="../util/RangeTable.scala.html#38460" title="(rTable: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]], keyComp: (Array[Byte], Array[Byte]) =&gt; Int, mergeCondition: (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Boolean)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</a> <a href="../util/RangeTable.scala.html#9978" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeTable</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span>
      <a href="#55254" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>,
      <a href="#37974" title="=&gt; (Array[Byte], Array[Byte]) =&gt; Int">routingKeyComp</a>, 
      <a href="#37982" title="=&gt; (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Boolean">mergeCond</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="37985">createPartitions</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="55260">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="55261">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Seq[edu.berkeley.cs.scads.comm.StorageService]" id="55262">servers</a>: <span title="Seq[edu.berkeley.cs.scads.comm.StorageService]">Seq</span><span class="delimiter">[</span>StorageService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.CreatePartitionRequest" id="57528">createReq</a> = <span title="(namespace: String, partitionType: String, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.comm.CreatePartitionRequest">CreatePartitionRequest</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13626" title="=&gt; String">name</a>, <a href="Namespace.scala.html#13588" title="=&gt; String">partitionType</a>, <a href="#55260" title="Option[Array[Byte]]">startKey</a>, <a href="#55261" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13643" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.StorageService),edu.berkeley.cs.scads.comm.PartitionService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#55262" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.StorageService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.StorageService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.StorageService" id="57622">server</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.StorageService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)" class="delimiter">(</span><a href="#57622" title="edu.berkeley.cs.scads.comm.StorageService">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#57528" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">createReq</a>, <a href="#57622" title="edu.berkeley.cs.scads.comm.StorageService">server</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#57660" title="edu.berkeley.cs.scads.comm.PartitionService" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.comm.PartitionService" class="delimiter">(</span>CreatePartitionResponse<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="57699">partitionActor</a><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <a href="#57699" title="edu.berkeley.cs.scads.comm.PartitionService">partitionActor</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** simply issues DeletePartitionRequests to the partition handlers, does
   * not modify the routing table. use deletePartitions to properly delete a
   * partition service */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit" id="37986">deletePartitionServices</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57702">partitions</a>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../util/ParFuture.scala.html#13643" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),Unit])Seq[Unit]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#57702" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="57726">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#57726" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(partitionId: String)edu.berkeley.cs.scads.comm.DeletePartitionRequest">DeletePartitionRequest</span><span class="delimiter">(</span><a href="#57726" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>.<span title="=&gt; String">partitionId</span><span class="delimiter">)</span>, <a href="#57726" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#57801" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>DeletePartitionResponse<span class="delimiter">(</span><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Keys are input as regular keys. the method will convert them to routing
   * table keys */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(splitKeys: Seq[Array[Byte]])Unit" id="37987">splitPartition</a><span class="delimiter">(</span><a title="Seq[Array[Byte]]" id="57831">splitKeys</a>: <span title="Seq[Array[Byte]]">Seq</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[Array[Byte]]" id="57833">routingSplitKeys</a> = <a href="#57831" title="Seq[Array[Byte]]">splitKeys</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="Interfaces.scala.html#13619" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[Seq[edu.berkeley.cs.scads.comm.PartitionService]]" id="57834">oldPartitions</a> = <span class="keyword">for</span> <span class="delimiter">(</span><a title="Array[Byte]" id="57890">splitPoint</a> &lt;- <a href="#57833" title="(f: Array[Byte] =&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Seq[edu.berkeley.cs.scads.comm.PartitionService],Seq[Seq[edu.berkeley.cs.scads.comm.PartitionService]]])Seq[Seq[edu.berkeley.cs.scads.comm.PartitionService]]">routingSplitKeys</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38473" title="(key: Array[Byte])Boolean">isSplitKey</a><span class="delimiter">(</span><a href="#57890" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">//Otherwise it is already a split point</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound" id="57891">bound</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38471" title="(key: Array[Byte])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">lowerUpperBound</a><span class="delimiter">(</span><a href="#57890" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57892">oldPartitions</a> = <a href="#57891" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57920" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">center</a>.<a href="../util/RangeTable.scala.html#38932" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.StorageService]" id="57893">storageServers</a> = <a href="#57892" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartitions</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]])Seq[edu.berkeley.cs.scads.comm.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]]" class="delimiter">(</span><a href="#57942" title="edu.berkeley.cs.scads.comm.PartitionService">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57894">leftPart</a> = <a href="#37985" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#57891" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57920" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">center</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#57890" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>, <a href="#57893" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">storageServers</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57895">rightPart</a> = <a href="#37985" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#57890" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>, <a href="#57891" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57922" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">right</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#57893" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">storageServers</a><span class="delimiter">)</span>
      <a href="#37968" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38476" title="(key: Array[Byte], leftValues: Seq[edu.berkeley.cs.scads.comm.PartitionService], rightValues: Seq[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">split</a><span class="delimiter">(</span><a href="#57890" title="Array[Byte]">splitPoint</a>, <a href="#57894" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a>, <a href="#57895" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">rightPart</a><span class="delimiter">)</span>
      <a href="#57892" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartitions</a>
    <span class="delimiter">}</span>

    <a href="#37976" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// TODO: should execute deletions in parallel, with futures</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58025">oldPartition</a> &lt;- <a href="#57834" title="(f: Seq[edu.berkeley.cs.scads.comm.PartitionService] =&gt; Unit)Unit">oldPartitions</a><span class="delimiter">)</span>
      <a href="#37986" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58025" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartition</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(mergeKeys: Seq[Array[Byte]])Unit" id="37988">mergePartition</a><span class="delimiter">(</span><a title="Seq[Array[Byte]]" id="58027">mergeKeys</a>: <span title="Seq[Array[Byte]]">Seq</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[Array[Byte]]" id="58029">routingMergeKeys</a> = <a href="#58027" title="Seq[Array[Byte]]">mergeKeys</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="Interfaces.scala.html#13619" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])]" id="58030">oldPartitions</a> = <span class="keyword">for</span> <span class="delimiter">(</span><a title="Array[Byte]" id="58086">mergeKey</a> &lt;- <a href="#58029" title="(f: Array[Byte] =&gt; (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]),Seq[(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])]])Seq[(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])]">routingMergeKeys</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38479" title="(key: Array[Byte])Boolean">checkMergeCondition</a><span class="delimiter">(</span><a href="#58086" title="Array[Byte]">mergeKey</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;Either the key is not a split key, or the sets are different and can not be merged&quot;)" class="string">&quot;Either the key is not a split key, or the sets are different and can not be merged&quot;</span><span class="delimiter">)</span> <span class="comment">//Otherwise we can not merge the partitions</span>

      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound" id="58087">bound</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38471" title="(key: Array[Byte])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">lowerUpperBound</a><span class="delimiter">(</span><a href="#58086" title="Array[Byte]">mergeKey</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58088">leftPart</a> = <a href="#58087" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57918" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">left</a>.<a href="../util/RangeTable.scala.html#38932" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58089">rightPart</a> = <a href="#58087" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57920" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">center</a>.<a href="../util/RangeTable.scala.html#38932" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a> <span class="comment">//have to use center as this is the partition with the split key</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.StorageService]" id="58090">storageServers</a> = <a href="#58088" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]])Seq[edu.berkeley.cs.scads.comm.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]]" class="delimiter">(</span><a href="#58118" title="edu.berkeley.cs.scads.comm.PartitionService">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58091">mergePartition</a> = <a href="#37985" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#58087" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57918" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">left</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#58087" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57922" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">right</a>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#58090" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">storageServers</a><span class="delimiter">)</span>

      <a href="#37968" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38481" title="(key: Array[Byte], values: Seq[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">merge</a><span class="delimiter">(</span><a href="#58086" title="Array[Byte]">mergeKey</a>, <a href="#58091" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">mergePartition</a><span class="delimiter">)</span>
      <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Seq[edu.berkeley.cs.scads.comm.PartitionService])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])" class="delimiter">(</span><a href="#58088" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a>, <a href="#58089" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">rightPart</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#37976" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// TODO: same as for splitPartition, could do this in parallel </span>
    <span class="keyword">for</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58214">leftPart</a>, <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58215">rightPart</a><span class="delimiter">)</span> &lt;- <a href="#58030" title="(f: (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Unit)Unit">oldPartitions</a><span class="delimiter">)</span><span class="delimiter">{</span>
      <a href="#37986" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58214" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a><span class="delimiter">)</span>
      <a href="#37986" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58215" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">rightPart</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(partitionHandlers: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit" id="37989">deletePartitions</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58217">partitionHandlers</a>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">for</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="58235">partitionHandler</a> &lt;- <a href="#58217" title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; Unit)Unit">partitionHandlers</a><span class="delimiter">)</span><span class="delimiter">{</span>
      <span class="keyword">val</span> <a href="#58237" title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</a><a href="#58236" title="Option[Array[Byte]]" id="58237">startKey</a>, <a href="#58236" title="Option[Array[Byte]]" id="58238">endKey</a><span class="delimiter">)</span> = <a href="#37979" title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span title="(Option[Array[Byte]], Option[Array[Byte]]) @unchecked" class="delimiter">(</span><a href="#58235" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span> <span class="comment">//Not really needed, just an additional check</span>
      <a href="#37968" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38486" title="(key: Option[Array[Byte]], value: edu.berkeley.cs.scads.comm.PartitionService)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">removeValueFromRange</a><span class="delimiter">(</span><a href="#58237" title="Option[Array[Byte]]">startKey</a>, <a href="#58235" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#37976" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#37986" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58217" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitionHandlers</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(targets: Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)])Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="37990">replicatePartitions</a><span class="delimiter">(</span><a title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)]" id="58264">targets</a>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, StorageService<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]" id="58266">result</a> = <span class="keyword">for</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="58301">partitionHandler</a>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="58302">storageHandler</a><span class="delimiter">)</span> &lt;- <a href="#58264" title="(f: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService) =&gt; (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)],(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]">targets</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a href="#58304" title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</a><a href="#58303" title="Option[Array[Byte]]" id="58304">startKey</a>, <a href="#58303" title="Option[Array[Byte]]" id="58305">endKey</a><span class="delimiter">)</span> = <a href="#37979" title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span title="(Option[Array[Byte]], Option[Array[Byte]]) @unchecked" class="delimiter">(</span><a href="#58301" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PartitionService" id="58306">newPartition</a> = <a href="#37985" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#58304" title="Option[Array[Byte]]">startKey</a>, <a href="#58305" title="Option[Array[Byte]]">endKey</a>, <span title="(elems: edu.berkeley.cs.scads.comm.StorageService*)Seq[edu.berkeley.cs.scads.comm.StorageService]">Seq</span><span class="delimiter">(</span><a href="#58302" title="edu.berkeley.cs.scads.comm.StorageService">storageHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">head</span>
      <a href="#37968" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38484" title="(key: Option[Array[Byte]], value: edu.berkeley.cs.scads.comm.PartitionService)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">addValueToRange</a><span class="delimiter">(</span><a href="#58304" title="Option[Array[Byte]]">startKey</a>, <a href="#58306" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a><span class="delimiter">)</span>
      <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#58306" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a>, <a href="#58301" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#37976" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13643" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),Unit])Seq[Unit]">waitForAndThrowException</a><span class="delimiter">(</span>
      <a href="#58266" title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]">result</a>.<span title="(f: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService) =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span> <a href="#58382" title="(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">{</a>
        <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="58385">newPartition</a>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="58386">oldPartition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#58385" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(src: edu.berkeley.cs.scads.comm.PartitionService, overwrite: Boolean)edu.berkeley.cs.scads.comm.CopyDataRequest">CopyDataRequest</span><span class="delimiter">(</span><a href="#58386" title="edu.berkeley.cs.scads.comm.PartitionService">oldPartition</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>, <a href="#58385" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>, <span class="int">3</span>*<span class="int">60</span><span title="Long(180000L)">*</span><span class="int">1000</span><span class="delimiter">)</span> <a href="#58477" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>CopyDataResponse<span class="delimiter">(</span><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> 
    <span class="delimiter">}</span>
    <a href="#58266" title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]">result</a>.<span title="(f: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService) =&gt; edu.berkeley.cs.scads.comm.PartitionService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)],edu.berkeley.cs.scads.comm.PartitionService,Seq[edu.berkeley.cs.scads.comm.PartitionService]])Seq[edu.berkeley.cs.scads.comm.PartitionService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.PartitionService,Seq[edu.berkeley.cs.scads.comm.PartitionService]]" class="delimiter">(</span><a href="#58517" title="(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">_1</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])])Unit" id="37991">setPartitionScheme</a><span class="delimiter">(</span><a title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]" id="58537">scheme</a>: <span title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, Seq<span class="delimiter">[</span>StorageService<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#58537" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Scheme must have at least 1 entry&quot;)" class="string">&quot;Scheme must have at least 1 entry&quot;</span><span class="delimiter">)</span> 
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#58537" title="(idx: Int)(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])">scheme</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">_1</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="object None">None</span>, <span title="java.lang.String(&quot;first entry in scheme must be None&quot;)" class="string">&quot;first entry in scheme must be None&quot;</span><span class="delimiter">)</span>

    <span class="comment">// capture old partition handles so we can delete them later</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58539">oldServices</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38451" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.comm.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]],edu.berkeley.cs.scads.comm.PartitionService,Array[edu.berkeley.cs.scads.comm.PartitionService]])Array[edu.berkeley.cs.scads.comm.PartitionService]">flatMap</span><span title="(xs: Array[edu.berkeley.cs.scads.comm.PartitionService])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.comm.PartitionService]" class="delimiter">(</span><a href="#59014" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_</a>.<a href="../util/RangeTable.scala.html#38932" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.PartitionService]">toSet</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">toSeq</span> <span class="comment">// will the services ever have duplicates?</span>

    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="58540">rTable</a> = <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#58537" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="58541">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="58542">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Int" id="58543">i</a> = <a href="#58537" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])" id="59272">range</a> &lt;- <a href="#58537" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="(f: (Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService]) =&gt; Unit)Unit">reverse</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#58541" title="Option[Array[Byte]]">startKey</a> = <a href="#59272" title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])">range</a>.<span title="=&gt; Option[Array[Byte]]">_1</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="59273">handlers</a> = <a href="#37985" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#58541" title="Option[Array[Byte]]">startKey</a>, <a href="#58542" title="Option[Array[Byte]]">endKey</a>, <a href="#59272" title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])">range</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.StorageService]">_2</span><span class="delimiter">)</span>
      <a href="#58540" title="(i: Int, x: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">rTable</a><span class="delimiter">(</span><a href="#58543" title="Int">i</a><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</span> <a href="../util/RangeTable.scala.html#9981" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeType</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span><a href="#58541" title="Option[Array[Byte]]">startKey</a>, <a href="#59273" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">handlers</a><span class="delimiter">)</span>
      <a href="#58542" title="Option[Array[Byte]]">endKey</a> = <a href="#58541" title="Option[Array[Byte]]">startKey</a>
      <a href="#58543" title="Int">i</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Setting new routing table: %s&quot;)" class="string">&quot;Setting new routing table: %s&quot;</span>, <a href="#58540" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">toSeq</span><span class="delimiter">)</span>
    <a href="#37984" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#58540" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a><span class="delimiter">)</span> <span class="comment">// sets _routingTable</span>
    <a href="#37975" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// propogates via zookeeper</span>

    <span class="comment">// now do cleanup on existing partitions</span>
    <a href="#37986" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58539" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldServices</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike with ScalaObject" id="9662">DefaultKeyRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9661" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a> <span class="delimiter">{</span>
  <span class="comment">/** No op - the key is its own routing key */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="37993">convertToRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="59551">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#59551" title="Array[Byte]">key</a>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="(Array[Byte], Array[Byte]) =&gt; Int" id="37994">routingKeyComp</a> = <a href="Interfaces.scala.html#13620" title="(x: Array[Byte], y: Array[Byte])Int">compareKey</a> _ 
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultHashKeyRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike with ScalaObject" id="9663">DefaultHashKeyRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9661" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="40655">convertToRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="59763">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// here's where we apply the hash function, and return a </span>
    <span class="comment">// routing key which represents the 4 bytes of the hash</span>
    <span class="keyword">val</span> <a title="Int" id="59766">hash</a> = <a href="Interfaces.scala.html#13621" title="(x: Array[Byte])Int">hashKey</a><span class="delimiter">(</span><a href="#59763" title="Array[Byte]">key</a><span class="delimiter">)</span>

    <span class="comment">// TODO: don't be lazy, and just write the hash directly to a byte array,</span>
    <span class="comment">// saving an object allocation</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="59767">b</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Int)java.nio.ByteBuffer">allocate</span><span class="delimiter">(</span><span title="Int(4)" class="int">4</span><span class="delimiter">)</span>
    <a href="#59767" title="java.nio.ByteBuffer">b</a>.<span title="(x$1: Int)java.nio.ByteBuffer">putInt</span><span class="delimiter">(</span><a href="#59766" title="Int">hash</a><span class="delimiter">)</span>
    <a href="#59767" title="java.nio.ByteBuffer">b</a>.<span title="()Array[Byte]">array</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="(Array[Byte], Array[Byte]) =&gt; Int" id="40656">routingKeyComp</a> = <span class="delimiter">(</span>lhs: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, rhs: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#59556" title="Array[Byte]">lhs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(4)" class="int">4</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#59557" title="Array[Byte]">rhs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(4)" class="int">4</span>, <span title="java.lang.String(&quot;bad routing keys passed to comp&quot;)" class="string">&quot;bad routing keys passed to comp&quot;</span><span class="delimiter">)</span>

    <span class="comment">// TODO: don't be lazy, and just pull the bytes right out of the array</span>
    <span class="comment">// instead of having a byte buffer do the work of converting to int</span>
    <span class="comment">// (saves 2 object allocations per comparison)</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="59558">lhs_bb</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#59556" title="Array[Byte]">lhs</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="59559">rhs_bb</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#59557" title="Array[Byte]">rhs</a><span class="delimiter">)</span>

    <span class="comment">// equiv to Integer.compareTo, except minus the auto-boxing</span>
    <span class="keyword">val</span> <a title="Int" id="59560">diff</a> = <a href="#59558" title="java.nio.ByteBuffer">lhs_bb</a>.<span title="()Int">getInt</span> <span title="(x: Int)Int">-</span> <a href="#59559" title="java.nio.ByteBuffer">rhs_bb</a>.<span title="()Int">getInt</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#59560" title="Int">diff</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Int(0)" class="int">0</span> 
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#59560" title="Int">diff</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">else</span> <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRangeRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutable with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9664">DefaultKeyRangeRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9662" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutable">DefaultKeyRoutable</a> <span class="keyword">with</span> <a href="Interfaces.scala.html#9616" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>
  <span class="comment">/** No-op b/c routing key is the same key as a range key */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="37997">convertFromRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="59772">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <a href="#59772" title="Array[Byte]">key</a>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="37998">serversForKeyRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="40236">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="40237">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">Seq</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="59774">ranges</a> = <a href="#37968" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38474" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">valuesForRange</a><span class="delimiter">(</span><a href="#40236" title="Option[Array[Byte]]">startKey</a>, <a href="#40237" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.storage.RangeDesc]" id="59775">result</a> = <span title="Array[edu.berkeley.cs.scads.storage.RangeDesc]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.storage.RangeDesc]">Array</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span><span class="delimiter">(</span><a href="#59774" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="59776">sKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="59777">eKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <a href="#40237" title="Option[Array[Byte]]">endKey</a>

    <span class="keyword">var</span> <a title="Int" id="59778">i</a> = <a href="#59774" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59778" title="Int">i</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#59779" title="()Unit" class="delimiter">{</a>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#59778" title="Int">i</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#59776" title="Option[Array[Byte]]">sKey</a> = <a href="#40236" title="Option[Array[Byte]]">startKey</a>
      <span class="keyword">else</span> <a href="#59776" title="Option[Array[Byte]]">sKey</a> = <a href="#59774" title="(i: Int)edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">ranges</a><span class="delimiter">(</span><a href="#59778" title="Int">i</a><span class="delimiter">)</span>.<a href="../util/RangeTable.scala.html#38930" title="=&gt; Option[Array[Byte]]">startKey</a>
      <a href="#59775" title="(i: Int, x: edu.berkeley.cs.scads.storage.RangeDesc)Unit">result</a><span class="delimiter">(</span><a href="#59778" title="Int">i</a><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.storage.RangeDesc" class="keyword">new</span> <a href="Interfaces.scala.html#9613" title="edu.berkeley.cs.scads.storage.RangeDesc">RangeDesc</a><span class="delimiter">(</span><a href="#59776" title="Option[Array[Byte]]">sKey</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#37997" title="(key: Array[Byte])Array[Byte]">convertFromRoutingKey</a><span class="delimiter">)</span>, <a href="#59777" title="Option[Array[Byte]]">eKey</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#37993" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>, <a href="#59774" title="(i: Int)edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">ranges</a><span class="delimiter">(</span><a href="#59778" title="Int">i</a><span class="delimiter">)</span>.<a href="../util/RangeTable.scala.html#38932" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a><span class="delimiter">)</span>
      <a href="#59777" title="Option[Array[Byte]]">eKey</a> = <a href="#59776" title="Option[Array[Byte]]">sKey</a>
      <a href="#59778" title="Int">i</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="#59775" title="(xs: Array[edu.berkeley.cs.scads.storage.RangeDesc])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.storage.RangeDesc]">result</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">toSeq</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>