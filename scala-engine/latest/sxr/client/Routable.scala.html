<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/Routable.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.scads._
<span class="keyword">import</span> comm._
<span class="keyword">import</span> util._

<span class="keyword">import</span> java.nio._
<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>

<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> io._

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike" id="9657">DefaultKeyRoutableLike</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="38500">ZOOKEEPER_ROUTING_TABLE</a> = <span title="java.lang.String(&quot;routingtable&quot;)" class="string">&quot;routingtable&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="38502">ZOOKEEPER_PARTITION_ID</a> = <span title="java.lang.String(&quot;partitionid&quot;)" class="string">&quot;partitionid&quot;</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRoutableLike extends java.lang.Object with edu.berkeley.cs.scads.storage.KeyRoutable with edu.berkeley.cs.scads.storage.KeyPartitionable with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.GlobalMetadata with edu.berkeley.cs.scads.storage.RecordMetadata with edu.berkeley.cs.scads.storage.ParFuture with ScalaObject" id="9659">DefaultKeyRoutableLike</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9610" title="edu.berkeley.cs.scads.storage.KeyRoutable">KeyRoutable</a> 
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9615" title="edu.berkeley.cs.scads.storage.KeyPartitionable">KeyPartitionable</a>
  <span class="keyword">with</span> <a href="Namespace.scala.html#9623" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9616" title="edu.berkeley.cs.scads.storage.GlobalMetadata">GlobalMetadata</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9618" title="edu.berkeley.cs.scads.storage.RecordMetadata">RecordMetadata</a>
  <span class="keyword">with</span> <a href="../util/ParFuture.scala.html#9974" title="edu.berkeley.cs.scads.storage.ParFuture">ParFuture</a> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="#9657" title="object edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a>._
  <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike Constructor: %s&quot;)" class="string">&quot;DefaultKeyRoutableLike Constructor: %s&quot;</span>, <a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a><span class="delimiter">)</span>

  @volatile <span class="keyword">protected</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="37972">_routingTable</a>: <a href="../util/RangeTable.scala.html#9980" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeTable</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span> = _

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="37974">routingTable</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a> 

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37975">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#37985" title="(partitionHandlers: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#37989" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, <a href="Namespace.scala.html#13590" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<a href="ScadsCluster.scala.html#38041" title="(nbServer: Int)List[edu.berkeley.cs.scads.comm.StorageService]">getRandomServers</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#37979" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13609" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike create():&quot;)" class="string">&quot;DefaultKeyRoutableLike create():&quot;</span><span class="delimiter">)</span>
    <a href="#37975" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13611" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span> <a title="Boolean" id="55733">isNew</a> =&gt;
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike open():&quot;)" class="string">&quot;DefaultKeyRoutableLike open():&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#55733" title="Boolean">isNew</a><span class="delimiter">)</span> <a href="#37975" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="#37984" title="()Unit">loadRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#55733" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13613" title="(f: =&gt; Unit)Unit">onDelete</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike delete():&quot;)" class="string">&quot;DefaultKeyRoutableLike delete():&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.StorageService]" id="55737">storageHandlers</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38455" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.comm.StorageService])(implicit bf: scala.collection.generic.CanBuildFrom[Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]],edu.berkeley.cs.scads.comm.StorageService,Array[edu.berkeley.cs.scads.comm.StorageService]])Array[edu.berkeley.cs.scads.comm.StorageService]">flatMap</span><span title="(xs: Array[edu.berkeley.cs.scads.comm.StorageService])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.comm.StorageService]" class="delimiter">(</span><a href="#56189" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_</a>.<a href="../util/RangeTable.scala.html#38936" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]])Seq[edu.berkeley.cs.scads.comm.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]]" class="delimiter">(</span><a href="#56206" title="edu.berkeley.cs.scads.comm.PartitionService">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.StorageService]">toSet</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.DeleteNamespaceRequest" id="55738">delReq</a> = <span title="(namespace: String)edu.berkeley.cs.scads.comm.DeleteNamespaceRequest">DeleteNamespaceRequest</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13630" title="=&gt; String">name</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13642" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.StorageService),Unit])Seq[Either[Throwable,Unit]]">waitFor</a><span class="delimiter">(</span><a href="#55737" title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.StorageService]">storageHandlers</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.StorageService]">toSeq</span>.<span title="(f: edu.berkeley.cs.scads.comm.StorageService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.StorageService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.StorageService" id="56697">h</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.StorageService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)" class="delimiter">(</span><a href="#56697" title="edu.berkeley.cs.scads.comm.StorageService">h</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#55738" title="edu.berkeley.cs.scads.comm.DeleteNamespaceRequest">delReq</a>, <a href="#56697" title="edu.berkeley.cs.scads.comm.StorageService">h</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#56737" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>DeleteNamespaceResponse<span class="delimiter">(</span><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="56765">handler</a><span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Successfully deleted namespace %s on StorageHandler %s&quot;)" class="string">&quot;Successfully deleted namespace %s on StorageHandler %s&quot;</span>, <a href="Interfaces.scala.html#13630" title="=&gt; String">name</a>, <a href="#56765" title="edu.berkeley.cs.scads.comm.StorageService">handler</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>InvalidNamespace<span class="delimiter">(</span>_<span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="56808">handler</a><span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Got invalid namespace error for namespace %s on StorageService %s&quot;)" class="string">&quot;Got invalid namespace error for namespace %s on StorageService %s&quot;</span>, <a href="Interfaces.scala.html#13630" title="=&gt; String">name</a>, <a href="#56808" title="edu.berkeley.cs.scads.comm.StorageService">handler</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="56815">e</a>, _<span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected message from DeleteNamespaceRequest: %s&quot;)" class="string">&quot;Unexpected message from DeleteNamespaceRequest: %s&quot;</span>, <a href="#56815" title="edu.berkeley.cs.scads.comm.MessageBody">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#37972" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13612" title="(f: =&gt; Unit)Unit">onClose</a> <span class="delimiter">{</span>
    <span class="comment">// TODO</span>
    <a href="#37972" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="37976">serversForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="56822">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38473" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">valuesForKey</a><span class="delimiter">(</span><a href="Interfaces.scala.html#13623" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">(</span><a href="#56822" title="Array[Byte]">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(newTable: Array[Byte])Unit" id="37977">onRoutingTableChanged</a><span class="delimiter">(</span><a title="Array[Byte]" id="56834">newTable</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;onRoutingTableChanged&quot;)" class="string">&quot;onRoutingTableChanged&quot;</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; (Array[Byte], Array[Byte]) =&gt; Int" id="37978">routingKeyComp</a>: <span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; Int

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37979">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#37981" title="()Boolean">validateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;Holy shit, we are about to store a crappy Routing Table.&quot;)" class="string">&quot;Holy shit, we are about to store a crappy Routing Table.&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.KeyRange]" id="55590">ranges</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38486" title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; edu.berkeley.cs.scads.comm.KeyRange)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]],edu.berkeley.cs.scads.comm.KeyRange,Seq[edu.berkeley.cs.scads.comm.KeyRange]])Seq[edu.berkeley.cs.scads.comm.KeyRange]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.KeyRange,Seq[edu.berkeley.cs.scads.comm.KeyRange]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="55621">a</a> =&gt; <span title="(startKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.comm.KeyRange">KeyRange</span><span class="delimiter">(</span><a href="#55621" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">a</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#55621" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">a</a>.<a href="../util/RangeTable.scala.html#38936" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RoutingTableMessage" id="55591">rangeSeq</a> = <span title="(partitions: Seq[edu.berkeley.cs.scads.comm.KeyRange])edu.berkeley.cs.scads.comm.RoutingTableMessage">RoutingTableMessage</span><span class="delimiter">(</span><a href="#55590" title="Seq[edu.berkeley.cs.scads.comm.KeyRange]">ranges</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13638" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#38500" title="=&gt; java.lang.String">ZOOKEEPER_ROUTING_TABLE</a>, <a href="#55591" title="edu.berkeley.cs.scads.comm.RoutingTableMessage">rangeSeq</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37980">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#37979" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13640" title="()Unit">waitUntilMetadataPropagated</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This function tests if the routing table is in a good state.
   * Thus, all partitions in the routing table must react and all boundaries must be correct
   */</span>
  <span class="keyword">def</span> <a title="()Boolean" id="37981">validateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="56840">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" id="56860">range</a> &lt;- <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38486" title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; Unit)Unit">reverse</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="56877">partition</a> &lt;- <a href="#56860" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38936" title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; Unit)Unit">values</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="(Option[Array[Byte]], Option[Array[Byte]])" id="56878">keys</a> = <a href="#37983" title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span class="delimiter">(</span><a href="#56877" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#37982" title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean">optArrayEq</a><span class="delimiter">(</span><a href="#56878" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_1</span>, <a href="#56860" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span title="=&gt; Boolean">!</span><a href="#37982" title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean">optArrayEq</a><span class="delimiter">(</span><a href="#56878" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_2</span>, <a href="#56840" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="java.lang.String(&quot;The routing table is corrupted. Partition: &quot;)" class="string">&quot;The routing table is corrupted. Partition: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56877" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; with key [&quot;)" class="string">&quot; with key [&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56878" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_1</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56878" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_2</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;] != [&quot;)" class="string">&quot;] != [&quot;</span> <span title="(x$1: Any)java.lang.String">+</span>  <a href="#56860" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56840" title="Option[Array[Byte]]">endKey</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;] from table:&quot;)" class="string">&quot;] from table:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#56840" title="Option[Array[Byte]]">endKey</a> = <a href="#56860" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">range</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <span title="Boolean(true)" class="keyword">true</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean" id="37982">optArrayEq</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="56881">lhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="56882">rhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#56881" title="Option[Array[Byte]]">lhs</a>, <a href="#56882" title="Option[Array[Byte]]">rhs</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="56897">x</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="56899">y</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte], x$2: Array[Byte])Boolean">equals</span><span class="delimiter">(</span><a href="#56897" title="Array[Byte]">x</a>, <a href="#56899" title="Array[Byte]">y</a><span class="delimiter">)</span>
    <span class="keyword">case</span> <span title="Boolean">_</span> =&gt; <a href="#56881" title="Option[Array[Byte]]">lhs</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#56882" title="Option[Array[Byte]]">rhs</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])" id="37983">getStartEndKey</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="56879">partitionHandler</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span><span class="delimiter">)</span>: <span title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// This request could be avoided if we would store the ranges in the partitionHandler.</span>
    <span class="comment">// However replication is not on the critical path and so expensive anyway that it does not matter</span>

    <span class="keyword">val</span> <a title="(Option[Array[Byte]], Option[Array[Byte]])" id="57324">keys</a> = <a href="#56879" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody, timeout: Int)edu.berkeley.cs.scads.comm.MessageBody">!?</span> <span title="()edu.berkeley.cs.scads.comm.GetResponsibilityRequest">GetResponsibilityRequest</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(Option[Array[Byte]], Option[Array[Byte]])" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="(Option[Array[Byte]], Option[Array[Byte]])">GetResponsibilityResponse</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="57394">s</a>, <a title="Option[Array[Byte]]" id="57395">e</a><span class="delimiter">)</span> =&gt; <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#57394" title="Option[Array[Byte]]">s</a>, <a href="#57395" title="Option[Array[Byte]]">e</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message&quot;)" class="string">&quot;Unexpected Message&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <a href="#57324" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="37984">loadRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RoutingTableMessage" id="57406">rangeSeq</a> = <span title="()edu.berkeley.cs.scads.comm.RoutingTableMessage" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.RoutingTableMessage">RoutingTableMessage</span>
    <a href="#57406" title="edu.berkeley.cs.scads.comm.RoutingTableMessage">rangeSeq</a>.<span title="(data: Array[Byte])rangeSeq.type">parse</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13636" title="(key: String, func: () =&gt; Unit)Array[Byte]">watchMetadata</a><span class="delimiter">(</span><a href="#38500" title="=&gt; java.lang.String">ZOOKEEPER_ROUTING_TABLE</a>, <a href="#37984" title="()Unit">loadRoutingTable</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="57407">partition</a> = <a href="#57406" title="edu.berkeley.cs.scads.comm.RoutingTableMessage">rangeSeq</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.KeyRange]">partitions</span>.<span title="(f: edu.berkeley.cs.scads.comm.KeyRange =&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.KeyRange],edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService],Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]])Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService],Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.KeyRange" id="57438">a</a> =&gt; <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</span> <a href="../util/RangeTable.scala.html#9983" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeType</a><span class="delimiter">(</span><a href="#57438" title="edu.berkeley.cs.scads.comm.KeyRange">a</a>.<span title="=&gt; Option[Array[Byte]]">startKey</span>, <a href="#57438" title="edu.berkeley.cs.scads.comm.KeyRange">a</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#37988" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#57407" title="Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">partition</a>.<span title="(implicit evidence$1: ClassManifest[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">toArray</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** create a routing table with the assumption that each PartitionService is going to handle
   * (None -&gt; None). note this assumption is NOT validated */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitionHandlers: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit" id="37985">createRoutingTable</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="55260">partitionHandlers</a>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="57506">arr</a> = <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <a href="#57506" title="(i: Int, x: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">arr</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</span> <a href="../util/RangeTable.scala.html#9983" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeType</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span><span title="object None">None</span>, <a href="#55260" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitionHandlers</a><span class="delimiter">)</span>
    <a href="#37988" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#57506" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">arr</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Boolean" id="37986">mergeCond</a> = <span class="delimiter">(</span>a: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, b: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
    <a href="#55219" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">a</a>.<span title="(that: scala.collection.GenSeq[edu.berkeley.cs.scads.comm.PartitionService])(p: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService) =&gt; Boolean)Boolean">corresponds</span><span class="delimiter">(</span><a href="#55220" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">b</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="55238">v1</a>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="55239">v2</a><span class="delimiter">)</span> =&gt; <a href="#55238" title="edu.berkeley.cs.scads.comm.PartitionService">v1</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#55239" title="edu.berkeley.cs.scads.comm.PartitionService">v2</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.ActorId">id</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit" id="37988">createRoutingTable</a><span class="delimiter">(</span><a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="55258">ranges</a>: <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#37972" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="../util/RangeTable.scala.html#38464" title="(rTable: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]], keyComp: (Array[Byte], Array[Byte]) =&gt; Int, mergeCondition: (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Boolean)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</a> <a href="../util/RangeTable.scala.html#9980" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeTable</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span>
      <a href="#55258" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>,
      <a href="#37978" title="=&gt; (Array[Byte], Array[Byte]) =&gt; Int">routingKeyComp</a>, 
      <a href="#37986" title="=&gt; (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Boolean">mergeCond</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="37989">createPartitions</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="55264">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="55265">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Seq[edu.berkeley.cs.scads.comm.StorageService]" id="55266">servers</a>: <span title="Seq[edu.berkeley.cs.scads.comm.StorageService]">Seq</span><span class="delimiter">[</span>StorageService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.CreatePartitionRequest" id="57532">createReq</a> = <span title="(namespace: String, partitionType: String, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.comm.CreatePartitionRequest">CreatePartitionRequest</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13630" title="=&gt; String">name</a>, <a href="Namespace.scala.html#13592" title="=&gt; String">partitionType</a>, <a href="#55264" title="Option[Array[Byte]]">startKey</a>, <a href="#55265" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13647" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.StorageService),edu.berkeley.cs.scads.comm.PartitionService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#55266" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.StorageService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.StorageService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.StorageService" id="57626">server</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.StorageService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.StorageService)" class="delimiter">(</span><a href="#57626" title="edu.berkeley.cs.scads.comm.StorageService">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#57532" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">createReq</a>, <a href="#57626" title="edu.berkeley.cs.scads.comm.StorageService">server</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#57664" title="edu.berkeley.cs.scads.comm.PartitionService" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.comm.PartitionService" class="delimiter">(</span>CreatePartitionResponse<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="57703">partitionActor</a><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <a href="#57703" title="edu.berkeley.cs.scads.comm.PartitionService">partitionActor</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** simply issues DeletePartitionRequests to the partition handlers, does
   * not modify the routing table. use deletePartitions to properly delete a
   * partition service */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit" id="37990">deletePartitionServices</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57706">partitions</a>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../util/ParFuture.scala.html#13647" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),Unit])Seq[Unit]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#57706" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="57730">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#57730" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(partitionId: String)edu.berkeley.cs.scads.comm.DeletePartitionRequest">DeletePartitionRequest</span><span class="delimiter">(</span><a href="#57730" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>.<span title="=&gt; String">partitionId</span><span class="delimiter">)</span>, <a href="#57730" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#57805" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>DeletePartitionResponse<span class="delimiter">(</span><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Keys are input as regular keys. the method will convert them to routing
   * table keys */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(splitKeys: Seq[Array[Byte]])Unit" id="37991">splitPartition</a><span class="delimiter">(</span><a title="Seq[Array[Byte]]" id="57835">splitKeys</a>: <span title="Seq[Array[Byte]]">Seq</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[Array[Byte]]" id="57837">routingSplitKeys</a> = <a href="#57835" title="Seq[Array[Byte]]">splitKeys</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="Interfaces.scala.html#13623" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[Seq[edu.berkeley.cs.scads.comm.PartitionService]]" id="57838">oldPartitions</a> = <span class="keyword">for</span> <span class="delimiter">(</span><a title="Array[Byte]" id="57894">splitPoint</a> &lt;- <a href="#57837" title="(f: Array[Byte] =&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Seq[edu.berkeley.cs.scads.comm.PartitionService],Seq[Seq[edu.berkeley.cs.scads.comm.PartitionService]]])Seq[Seq[edu.berkeley.cs.scads.comm.PartitionService]]">routingSplitKeys</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38477" title="(key: Array[Byte])Boolean">isSplitKey</a><span class="delimiter">(</span><a href="#57894" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">//Otherwise it is already a split point</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound" id="57895">bound</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38475" title="(key: Array[Byte])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">lowerUpperBound</a><span class="delimiter">(</span><a href="#57894" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57896">oldPartitions</a> = <a href="#57895" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57924" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">center</a>.<a href="../util/RangeTable.scala.html#38936" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.StorageService]" id="57897">storageServers</a> = <a href="#57896" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartitions</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]])Seq[edu.berkeley.cs.scads.comm.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]]" class="delimiter">(</span><a href="#57946" title="edu.berkeley.cs.scads.comm.PartitionService">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57898">leftPart</a> = <a href="#37989" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#57895" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57924" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">center</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#57894" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>, <a href="#57897" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">storageServers</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="57899">rightPart</a> = <a href="#37989" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#57894" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>, <a href="#57895" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57926" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">right</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#57897" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">storageServers</a><span class="delimiter">)</span>
      <a href="#37972" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38480" title="(key: Array[Byte], leftValues: Seq[edu.berkeley.cs.scads.comm.PartitionService], rightValues: Seq[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">split</a><span class="delimiter">(</span><a href="#57894" title="Array[Byte]">splitPoint</a>, <a href="#57898" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a>, <a href="#57899" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">rightPart</a><span class="delimiter">)</span>
      <a href="#57896" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartitions</a>
    <span class="delimiter">}</span>

    <a href="#37980" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// TODO: should execute deletions in parallel, with futures</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58029">oldPartition</a> &lt;- <a href="#57838" title="(f: Seq[edu.berkeley.cs.scads.comm.PartitionService] =&gt; Unit)Unit">oldPartitions</a><span class="delimiter">)</span>
      <a href="#37990" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58029" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldPartition</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(mergeKeys: Seq[Array[Byte]])Unit" id="37992">mergePartition</a><span class="delimiter">(</span><a title="Seq[Array[Byte]]" id="58031">mergeKeys</a>: <span title="Seq[Array[Byte]]">Seq</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[Array[Byte]]" id="58033">routingMergeKeys</a> = <a href="#58031" title="Seq[Array[Byte]]">mergeKeys</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="Interfaces.scala.html#13623" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])]" id="58034">oldPartitions</a> = <span class="keyword">for</span> <span class="delimiter">(</span><a title="Array[Byte]" id="58090">mergeKey</a> &lt;- <a href="#58033" title="(f: Array[Byte] =&gt; (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]),Seq[(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])]])Seq[(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])]">routingMergeKeys</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38483" title="(key: Array[Byte])Boolean">checkMergeCondition</a><span class="delimiter">(</span><a href="#58090" title="Array[Byte]">mergeKey</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;Either the key is not a split key, or the sets are different and can not be merged&quot;)" class="string">&quot;Either the key is not a split key, or the sets are different and can not be merged&quot;</span><span class="delimiter">)</span> <span class="comment">//Otherwise we can not merge the partitions</span>

      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound" id="58091">bound</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38475" title="(key: Array[Byte])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">lowerUpperBound</a><span class="delimiter">(</span><a href="#58090" title="Array[Byte]">mergeKey</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58092">leftPart</a> = <a href="#58091" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57922" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">left</a>.<a href="../util/RangeTable.scala.html#38936" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58093">rightPart</a> = <a href="#58091" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57924" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">center</a>.<a href="../util/RangeTable.scala.html#38936" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a> <span class="comment">//have to use center as this is the partition with the split key</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.StorageService]" id="58094">storageServers</a> = <a href="#58092" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]])Seq[edu.berkeley.cs.scads.comm.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.StorageService,Seq[edu.berkeley.cs.scads.comm.StorageService]]" class="delimiter">(</span><a href="#58122" title="edu.berkeley.cs.scads.comm.PartitionService">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">storageService</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58095">mergePartition</a> = <a href="#37989" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#58091" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57922" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">left</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#58091" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]#RangeBound">bound</a>.<a href="../util/RangeTable.scala.html#57926" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">right</a>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#58094" title="Seq[edu.berkeley.cs.scads.comm.StorageService]">storageServers</a><span class="delimiter">)</span>

      <a href="#37972" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38485" title="(key: Array[Byte], values: Seq[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">merge</a><span class="delimiter">(</span><a href="#58090" title="Array[Byte]">mergeKey</a>, <a href="#58095" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">mergePartition</a><span class="delimiter">)</span>
      <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Seq[edu.berkeley.cs.scads.comm.PartitionService])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService])" class="delimiter">(</span><a href="#58092" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a>, <a href="#58093" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">rightPart</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#37980" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// TODO: same as for splitPartition, could do this in parallel </span>
    <span class="keyword">for</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58218">leftPart</a>, <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58219">rightPart</a><span class="delimiter">)</span> &lt;- <a href="#58034" title="(f: (Seq[edu.berkeley.cs.scads.comm.PartitionService], Seq[edu.berkeley.cs.scads.comm.PartitionService]) =&gt; Unit)Unit">oldPartitions</a><span class="delimiter">)</span><span class="delimiter">{</span>
      <a href="#37990" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58218" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">leftPart</a><span class="delimiter">)</span>
      <a href="#37990" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58219" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">rightPart</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(partitionHandlers: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit" id="37993">deletePartitions</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58221">partitionHandlers</a>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">for</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="58239">partitionHandler</a> &lt;- <a href="#58221" title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; Unit)Unit">partitionHandlers</a><span class="delimiter">)</span><span class="delimiter">{</span>
      <span class="keyword">val</span> <a href="#58241" title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</a><a href="#58240" title="Option[Array[Byte]]" id="58241">startKey</a>, <a href="#58240" title="Option[Array[Byte]]" id="58242">endKey</a><span class="delimiter">)</span> = <a href="#37983" title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span title="(Option[Array[Byte]], Option[Array[Byte]]) @unchecked" class="delimiter">(</span><a href="#58239" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span> <span class="comment">//Not really needed, just an additional check</span>
      <a href="#37972" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38490" title="(key: Option[Array[Byte]], value: edu.berkeley.cs.scads.comm.PartitionService)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">removeValueFromRange</a><span class="delimiter">(</span><a href="#58241" title="Option[Array[Byte]]">startKey</a>, <a href="#58239" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#37980" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#37990" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58221" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitionHandlers</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(targets: Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)])Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="37994">replicatePartitions</a><span class="delimiter">(</span><a title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)]" id="58268">targets</a>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, StorageService<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]" id="58270">result</a> = <span class="keyword">for</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="58305">partitionHandler</a>, <a title="edu.berkeley.cs.scads.comm.StorageService" id="58306">storageHandler</a><span class="delimiter">)</span> &lt;- <a href="#58268" title="(f: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService) =&gt; (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.StorageService)],(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]">targets</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a href="#58308" title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</a><a href="#58307" title="Option[Array[Byte]]" id="58308">startKey</a>, <a href="#58307" title="Option[Array[Byte]]" id="58309">endKey</a><span class="delimiter">)</span> = <a href="#37983" title="(partitionHandler: edu.berkeley.cs.scads.comm.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span title="(Option[Array[Byte]], Option[Array[Byte]]) @unchecked" class="delimiter">(</span><a href="#58305" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PartitionService" id="58310">newPartition</a> = <a href="#37989" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#58308" title="Option[Array[Byte]]">startKey</a>, <a href="#58309" title="Option[Array[Byte]]">endKey</a>, <span title="(elems: edu.berkeley.cs.scads.comm.StorageService*)Seq[edu.berkeley.cs.scads.comm.StorageService]">Seq</span><span class="delimiter">(</span><a href="#58306" title="edu.berkeley.cs.scads.comm.StorageService">storageHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">head</span>
      <a href="#37972" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">_routingTable</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38488" title="(key: Option[Array[Byte]], value: edu.berkeley.cs.scads.comm.PartitionService)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">addValueToRange</a><span class="delimiter">(</span><a href="#58308" title="Option[Array[Byte]]">startKey</a>, <a href="#58310" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a><span class="delimiter">)</span>
      <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#58310" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a>, <a href="#58305" title="edu.berkeley.cs.scads.comm.PartitionService">partitionHandler</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#37980" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13647" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),Unit])Seq[Unit]">waitForAndThrowException</a><span class="delimiter">(</span>
      <a href="#58270" title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]">result</a>.<span title="(f: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService) =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span> <a href="#58386" title="(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">{</a>
        <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="58389">newPartition</a>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="58390">oldPartition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#58389" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(src: edu.berkeley.cs.scads.comm.PartitionService, overwrite: Boolean)edu.berkeley.cs.scads.comm.CopyDataRequest">CopyDataRequest</span><span class="delimiter">(</span><a href="#58390" title="edu.berkeley.cs.scads.comm.PartitionService">oldPartition</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>, <a href="#58389" title="edu.berkeley.cs.scads.comm.PartitionService">newPartition</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>, <span class="int">3</span>*<span class="int">60</span><span title="Long(180000L)">*</span><span class="int">1000</span><span class="delimiter">)</span> <a href="#58481" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>CopyDataResponse<span class="delimiter">(</span><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> 
    <span class="delimiter">}</span>
    <a href="#58270" title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)]">result</a>.<span title="(f: (edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService) =&gt; edu.berkeley.cs.scads.comm.PartitionService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)],edu.berkeley.cs.scads.comm.PartitionService,Seq[edu.berkeley.cs.scads.comm.PartitionService]])Seq[edu.berkeley.cs.scads.comm.PartitionService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.PartitionService,Seq[edu.berkeley.cs.scads.comm.PartitionService]]" class="delimiter">(</span><a href="#58521" title="(edu.berkeley.cs.scads.comm.PartitionService, edu.berkeley.cs.scads.comm.PartitionService)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">_1</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])])Unit" id="37995">setPartitionScheme</a><span class="delimiter">(</span><a title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]" id="58541">scheme</a>: <span title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, Seq<span class="delimiter">[</span>StorageService<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#58541" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Scheme must have at least 1 entry&quot;)" class="string">&quot;Scheme must have at least 1 entry&quot;</span><span class="delimiter">)</span> 
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#58541" title="(idx: Int)(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])">scheme</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">_1</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="object None">None</span>, <span title="java.lang.String(&quot;first entry in scheme must be None&quot;)" class="string">&quot;first entry in scheme must be None&quot;</span><span class="delimiter">)</span>

    <span class="comment">// capture old partition handles so we can delete them later</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="58543">oldServices</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38455" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService] =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.comm.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]],edu.berkeley.cs.scads.comm.PartitionService,Array[edu.berkeley.cs.scads.comm.PartitionService]])Array[edu.berkeley.cs.scads.comm.PartitionService]">flatMap</span><span title="(xs: Array[edu.berkeley.cs.scads.comm.PartitionService])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.comm.PartitionService]" class="delimiter">(</span><a href="#59018" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_</a>.<a href="../util/RangeTable.scala.html#38936" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[edu.berkeley.cs.scads.comm.PartitionService]">toSet</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">toSeq</span> <span class="comment">// will the services ever have duplicates?</span>

    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="58544">rTable</a> = <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#58541" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="58545">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="58546">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Int" id="58547">i</a> = <a href="#58541" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])" id="59276">range</a> &lt;- <a href="#58541" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])]">scheme</a>.<span title="(f: (Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService]) =&gt; Unit)Unit">reverse</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#58545" title="Option[Array[Byte]]">startKey</a> = <a href="#59276" title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])">range</a>.<span title="=&gt; Option[Array[Byte]]">_1</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="59277">handlers</a> = <a href="#37989" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.comm.StorageService])Seq[edu.berkeley.cs.scads.comm.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#58545" title="Option[Array[Byte]]">startKey</a>, <a href="#58546" title="Option[Array[Byte]]">endKey</a>, <a href="#59276" title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.comm.StorageService])">range</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.StorageService]">_2</span><span class="delimiter">)</span>
      <a href="#58544" title="(i: Int, x: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService])Unit">rTable</a><span class="delimiter">(</span><a href="#58547" title="Int">i</a><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]" class="keyword">new</span> <a href="../util/RangeTable.scala.html#9983" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">RangeType</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span><a href="#58545" title="Option[Array[Byte]]">startKey</a>, <a href="#59277" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">handlers</a><span class="delimiter">)</span>
      <a href="#58546" title="Option[Array[Byte]]">endKey</a> = <a href="#58545" title="Option[Array[Byte]]">startKey</a>
      <a href="#58547" title="Int">i</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Setting new routing table: %s&quot;)" class="string">&quot;Setting new routing table: %s&quot;</span>, <a href="#58544" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">toSeq</span><span class="delimiter">)</span>
    <a href="#37988" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#58544" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">rTable</a><span class="delimiter">)</span> <span class="comment">// sets _routingTable</span>
    <a href="#37979" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// propogates via zookeeper</span>

    <span class="comment">// now do cleanup on existing partitions</span>
    <a href="#37990" title="(partitions: Seq[edu.berkeley.cs.scads.comm.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#58543" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">oldServices</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike with ScalaObject" id="9660">DefaultKeyRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9659" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a> <span class="delimiter">{</span>
  <span class="comment">/** No op - the key is its own routing key */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="37997">convertToRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="59555">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#59555" title="Array[Byte]">key</a>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="(Array[Byte], Array[Byte]) =&gt; Int" id="37998">routingKeyComp</a> = <a href="Interfaces.scala.html#13624" title="(x: Array[Byte], y: Array[Byte])Int">compareKey</a> _ 
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultHashKeyRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike with ScalaObject" id="9661">DefaultHashKeyRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9659" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="40659">convertToRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="59767">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// here's where we apply the hash function, and return a </span>
    <span class="comment">// routing key which represents the 4 bytes of the hash</span>
    <span class="keyword">val</span> <a title="Int" id="59770">hash</a> = <a href="Interfaces.scala.html#13625" title="(x: Array[Byte])Int">hashKey</a><span class="delimiter">(</span><a href="#59767" title="Array[Byte]">key</a><span class="delimiter">)</span>

    <span class="comment">// TODO: don't be lazy, and just write the hash directly to a byte array,</span>
    <span class="comment">// saving an object allocation</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="59771">b</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Int)java.nio.ByteBuffer">allocate</span><span class="delimiter">(</span><span title="Int(4)" class="int">4</span><span class="delimiter">)</span>
    <a href="#59771" title="java.nio.ByteBuffer">b</a>.<span title="(x$1: Int)java.nio.ByteBuffer">putInt</span><span class="delimiter">(</span><a href="#59770" title="Int">hash</a><span class="delimiter">)</span>
    <a href="#59771" title="java.nio.ByteBuffer">b</a>.<span title="()Array[Byte]">array</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="(Array[Byte], Array[Byte]) =&gt; Int" id="40660">routingKeyComp</a> = <span class="delimiter">(</span>lhs: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, rhs: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#59560" title="Array[Byte]">lhs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(4)" class="int">4</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#59561" title="Array[Byte]">rhs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(4)" class="int">4</span>, <span title="java.lang.String(&quot;bad routing keys passed to comp&quot;)" class="string">&quot;bad routing keys passed to comp&quot;</span><span class="delimiter">)</span>

    <span class="comment">// TODO: don't be lazy, and just pull the bytes right out of the array</span>
    <span class="comment">// instead of having a byte buffer do the work of converting to int</span>
    <span class="comment">// (saves 2 object allocations per comparison)</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="59562">lhs_bb</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#59560" title="Array[Byte]">lhs</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="59563">rhs_bb</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#59561" title="Array[Byte]">rhs</a><span class="delimiter">)</span>

    <span class="comment">// equiv to Integer.compareTo, except minus the auto-boxing</span>
    <span class="keyword">val</span> <a title="Int" id="59564">diff</a> = <a href="#59562" title="java.nio.ByteBuffer">lhs_bb</a>.<span title="()Int">getInt</span> <span title="(x: Int)Int">-</span> <a href="#59563" title="java.nio.ByteBuffer">rhs_bb</a>.<span title="()Int">getInt</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#59564" title="Int">diff</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Int(0)" class="int">0</span> 
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#59564" title="Int">diff</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">else</span> <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRangeRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutable with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9662">DefaultKeyRangeRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9660" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutable">DefaultKeyRoutable</a> <span class="keyword">with</span> <a href="Interfaces.scala.html#9614" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>
  <span class="comment">/** No-op b/c routing key is the same key as a range key */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="38001">convertFromRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="59776">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <a href="#59776" title="Array[Byte]">key</a>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="38002">serversForKeyRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="40240">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="40241">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">Seq</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]" id="59778">ranges</a> = <a href="#37972" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">_routingTable</a>.<a href="../util/RangeTable.scala.html#38478" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">valuesForRange</a><span class="delimiter">(</span><a href="#40240" title="Option[Array[Byte]]">startKey</a>, <a href="#40241" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.storage.RangeDesc]" id="59779">result</a> = <span title="Array[edu.berkeley.cs.scads.storage.RangeDesc]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.storage.RangeDesc]">Array</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span><span class="delimiter">(</span><a href="#59778" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="59780">sKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="59781">eKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <a href="#40241" title="Option[Array[Byte]]">endKey</a>

    <span class="keyword">var</span> <a title="Int" id="59782">i</a> = <a href="#59778" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]]">ranges</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#59782" title="Int">i</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#59783" title="()Unit" class="delimiter">{</a>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#59782" title="Int">i</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#59780" title="Option[Array[Byte]]">sKey</a> = <a href="#40240" title="Option[Array[Byte]]">startKey</a>
      <span class="keyword">else</span> <a href="#59780" title="Option[Array[Byte]]">sKey</a> = <a href="#59778" title="(i: Int)edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">ranges</a><span class="delimiter">(</span><a href="#59782" title="Int">i</a><span class="delimiter">)</span>.<a href="../util/RangeTable.scala.html#38934" title="=&gt; Option[Array[Byte]]">startKey</a>
      <a href="#59779" title="(i: Int, x: edu.berkeley.cs.scads.storage.RangeDesc)Unit">result</a><span class="delimiter">(</span><a href="#59782" title="Int">i</a><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.storage.RangeDesc" class="keyword">new</span> <a href="Interfaces.scala.html#9611" title="edu.berkeley.cs.scads.storage.RangeDesc">RangeDesc</a><span class="delimiter">(</span><a href="#59780" title="Option[Array[Byte]]">sKey</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#38001" title="(key: Array[Byte])Array[Byte]">convertFromRoutingKey</a><span class="delimiter">)</span>, <a href="#59781" title="Option[Array[Byte]]">eKey</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#37997" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>, <a href="#59778" title="(i: Int)edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.comm.PartitionService]">ranges</a><span class="delimiter">(</span><a href="#59782" title="Int">i</a><span class="delimiter">)</span>.<a href="../util/RangeTable.scala.html#38936" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">values</a><span class="delimiter">)</span>
      <a href="#59781" title="Option[Array[Byte]]">eKey</a> = <a href="#59780" title="Option[Array[Byte]]">sKey</a>
      <a href="#59782" title="Int">i</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="#59779" title="(xs: Array[edu.berkeley.cs.scads.storage.RangeDesc])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.storage.RangeDesc]">result</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">toSeq</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>