<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/Routable.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.scads._
<span class="keyword">import</span> comm._
<span class="keyword">import</span> util._

<span class="keyword">import</span> java.nio._
<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>

<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> io._

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike" id="9908">DefaultKeyRoutableLike</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="42314">ZOOKEEPER_ROUTING_TABLE</a> = <span title="java.lang.String(&quot;routingtable&quot;)" class="string">&quot;routingtable&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="42316">ZOOKEEPER_PARTITION_ID</a> = <span title="java.lang.String(&quot;partitionid&quot;)" class="string">&quot;partitionid&quot;</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRoutableLike extends java.lang.Object with edu.berkeley.cs.scads.storage.KeyRoutable with edu.berkeley.cs.scads.storage.KeyPartitionable with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.GlobalMetadata with edu.berkeley.cs.scads.storage.RecordMetadata with edu.berkeley.cs.scads.storage.ParFuture with ScalaObject" id="9910">DefaultKeyRoutableLike</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9860" title="edu.berkeley.cs.scads.storage.KeyRoutable">KeyRoutable</a> 
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9865" title="edu.berkeley.cs.scads.storage.KeyPartitionable">KeyPartitionable</a>
  <span class="keyword">with</span> <a href="Namespace.scala.html#9873" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9866" title="edu.berkeley.cs.scads.storage.GlobalMetadata">GlobalMetadata</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9868" title="edu.berkeley.cs.scads.storage.RecordMetadata">RecordMetadata</a>
  <span class="keyword">with</span> <a href="../util/ParFuture.scala.html#10128" title="edu.berkeley.cs.scads.storage.ParFuture">ParFuture</a> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="#9908" title="object edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a>._
  <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike Constructor: %s&quot;)" class="string">&quot;DefaultKeyRoutableLike Constructor: %s&quot;</span>, <a href="Namespace.scala.html#27900" title="=&gt; String">namespace</a><span class="delimiter">)</span>

  @volatile <span class="keyword">protected</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" id="41709">_routingTable</a>: <a href="util/RangeTable.scala.html#10593" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">RangeTable</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span> = _

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" id="41711">routingTable</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a> 

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="41712">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#41722" title="(partitionHandlers: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#41726" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.StorageService])Seq[edu.berkeley.cs.scads.storage.PartitionService]">createPartitions</a><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, <a href="Namespace.scala.html#27899" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>.<a href="ScadsCluster.scala.html#41775" title="(nbServer: Int)List[edu.berkeley.cs.scads.storage.StorageService]">getRandomServers</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#41716" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27918" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike create():&quot;)" class="string">&quot;DefaultKeyRoutableLike create():&quot;</span><span class="delimiter">)</span>
    <a href="#41712" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27920" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span> <a title="Boolean" id="59330">isNew</a> =&gt;
    <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike open():&quot;)" class="string">&quot;DefaultKeyRoutableLike open():&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#59330" title="Boolean">isNew</a><span class="delimiter">)</span> <a href="#41712" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="#41721" title="()Unit">loadRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#59330" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27922" title="(f: =&gt; Unit)Unit">onDelete</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DefaultKeyRoutableLike delete():&quot;)" class="string">&quot;DefaultKeyRoutableLike delete():&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[edu.berkeley.cs.scads.storage.StorageService]" id="59334">storageHandlers</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#46932" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">rTable</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService] =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.storage.StorageService])(implicit bf: scala.collection.generic.CanBuildFrom[Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]],edu.berkeley.cs.scads.storage.StorageService,Array[edu.berkeley.cs.scads.storage.StorageService]])Array[edu.berkeley.cs.scads.storage.StorageService]">flatMap</span><span title="(xs: Array[edu.berkeley.cs.scads.storage.StorageService])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.storage.StorageService]" class="delimiter">(</span><a href="#59786" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_</a>.<a href="util/RangeTable.scala.html#115757" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">values</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.storage.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.storage.StorageService,Seq[edu.berkeley.cs.scads.storage.StorageService]])Seq[edu.berkeley.cs.scads.storage.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.StorageService,Seq[edu.berkeley.cs.scads.storage.StorageService]]" class="delimiter">(</span><a href="#59803" title="edu.berkeley.cs.scads.storage.PartitionService">_</a>.<a href="../Messages.scala.html#21953" title="=&gt; edu.berkeley.cs.scads.storage.StorageService">storageService</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[edu.berkeley.cs.scads.storage.StorageService]">toSet</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.DeleteNamespaceRequest" id="59335">delReq</a> = <a href="../Messages.scala.html#25024" title="(namespace: String)edu.berkeley.cs.scads.storage.DeleteNamespaceRequest">DeleteNamespaceRequest</a><span class="delimiter">(</span><a href="Interfaces.scala.html#27939" title="=&gt; String">name</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#27951" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.storage.StorageMessage, edu.berkeley.cs.scads.storage.StorageService),Unit])Seq[Either[Throwable,Unit]]">waitFor</a><span class="delimiter">(</span><a href="#59334" title="scala.collection.immutable.Set[edu.berkeley.cs.scads.storage.StorageService]">storageHandlers</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.StorageService]">toSeq</span>.<span title="(f: edu.berkeley.cs.scads.storage.StorageService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.StorageService],(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.StorageService" id="60258">h</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], _2: edu.berkeley.cs.scads.storage.StorageService)(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)" class="delimiter">(</span><a href="#60258" title="edu.berkeley.cs.scads.storage.StorageService">h</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#59335" title="edu.berkeley.cs.scads.storage.DeleteNamespaceRequest">delReq</a>, <a href="#60258" title="edu.berkeley.cs.scads.storage.StorageService">h</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#60303" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>DeleteNamespaceResponse<span class="delimiter">(</span><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.storage.StorageService" id="60306">handler</a><span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Successfully deleted namespace %s on StorageHandler %s&quot;)" class="string">&quot;Successfully deleted namespace %s on StorageHandler %s&quot;</span>, <a href="Interfaces.scala.html#27939" title="=&gt; String">name</a>, <a href="#60306" title="edu.berkeley.cs.scads.storage.StorageService">handler</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>InvalidNamespace<span class="delimiter">(</span>_<span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.storage.StorageService" id="60313">handler</a><span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Got invalid namespace error for namespace %s on StorageService %s&quot;)" class="string">&quot;Got invalid namespace error for namespace %s on StorageService %s&quot;</span>, <a href="Interfaces.scala.html#27939" title="=&gt; String">name</a>, <a href="#60313" title="edu.berkeley.cs.scads.storage.StorageService">handler</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.StorageMessage" id="60320">e</a>, _<span class="delimiter">)</span> =&gt;
        <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected message from DeleteNamespaceRequest: %s&quot;)" class="string">&quot;Unexpected message from DeleteNamespaceRequest: %s&quot;</span>, <a href="#60320" title="edu.berkeley.cs.scads.storage.StorageMessage">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#41709" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">_routingTable</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27921" title="(f: =&gt; Unit)Unit">onClose</a> <span class="delimiter">{</span>
    <span class="comment">// TODO</span>
    <a href="#41709" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">_routingTable</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="41713">serversForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="60327">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45386" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.storage.PartitionService]">valuesForKey</a><span class="delimiter">(</span><a href="Interfaces.scala.html#27932" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">(</span><a href="#60327" title="Array[Byte]">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(newTable: Array[Byte])Unit" id="41714">onRoutingTableChanged</a><span class="delimiter">(</span><a title="Array[Byte]" id="60335">newTable</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;onRoutingTableChanged&quot;)" class="string">&quot;onRoutingTableChanged&quot;</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; (Array[Byte], Array[Byte]) =&gt; Int" id="41715">routingKeyComp</a>: <span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; Int

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="41716">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#41718" title="()Boolean">validateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;Holy shit, we are about to store a crappy Routing Table.&quot;)" class="string">&quot;Holy shit, we are about to store a crappy Routing Table.&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.KeyRange]" id="59270">ranges</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45399" title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService] =&gt; edu.berkeley.cs.scads.storage.KeyRange)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]],edu.berkeley.cs.scads.storage.KeyRange,Seq[edu.berkeley.cs.scads.storage.KeyRange]])Seq[edu.berkeley.cs.scads.storage.KeyRange]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.KeyRange,Seq[edu.berkeley.cs.scads.storage.KeyRange]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" id="59299">a</a> =&gt; <a href="../Messages.scala.html#26008" title="(startKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.PartitionService])edu.berkeley.cs.scads.storage.KeyRange">KeyRange</a><span class="delimiter">(</span><a href="#59299" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">a</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#59299" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">a</a>.<a href="util/RangeTable.scala.html#115757" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">values</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RoutingTableMessage" id="59271">rangeSeq</a> = <a href="../Messages.scala.html#26082" title="(partitions: Seq[edu.berkeley.cs.scads.storage.KeyRange])edu.berkeley.cs.scads.storage.RoutingTableMessage">RoutingTableMessage</a><span class="delimiter">(</span><a href="#59270" title="Seq[edu.berkeley.cs.scads.storage.KeyRange]">ranges</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#27947" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#42314" title="=&gt; java.lang.String">ZOOKEEPER_ROUTING_TABLE</a>, <a href="#59271" title="edu.berkeley.cs.scads.storage.RoutingTableMessage">rangeSeq</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="41717">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#41716" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#27949" title="()Unit">waitUntilMetadataPropagated</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This function tests if the routing table is in a good state.
   * Thus, all partitions in the routing table must react and all boundaries must be correct
   */</span>
  <span class="keyword">def</span> <a title="()Boolean" id="41718">validateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="60341">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" id="60361">range</a> &lt;- <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45399" title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService] =&gt; Unit)Unit">reverse</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="60378">partition</a> &lt;- <a href="#60361" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">range</a>.<a href="util/RangeTable.scala.html#115757" title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; Unit)Unit">values</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="(Option[Array[Byte]], Option[Array[Byte]])" id="60379">keys</a> = <a href="#41720" title="(partitionHandler: edu.berkeley.cs.scads.storage.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span class="delimiter">(</span><a href="#60378" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41719" title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean">optArrayEq</a><span class="delimiter">(</span><a href="#60379" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_1</span>, <a href="#60361" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">range</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span title="=&gt; Boolean">!</span><a href="#41719" title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean">optArrayEq</a><span class="delimiter">(</span><a href="#60379" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_2</span>, <a href="#60341" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, <span title="java.lang.String(&quot;The routing table is corrupted. Partition: &quot;)" class="string">&quot;The routing table is corrupted. Partition: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60378" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; with key [&quot;)" class="string">&quot; with key [&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60379" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_1</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60379" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>.<span title="=&gt; Option[Array[Byte]]">_2</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;] != [&quot;)" class="string">&quot;] != [&quot;</span> <span title="(x$1: Any)java.lang.String">+</span>  <a href="#60361" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">range</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#60341" title="Option[Array[Byte]]">endKey</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;] from table:&quot;)" class="string">&quot;] from table:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#60341" title="Option[Array[Byte]]">endKey</a> = <a href="#60361" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">range</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <span title="Boolean(true)" class="keyword">true</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(lhs: Option[Array[Byte]], rhs: Option[Array[Byte]])Boolean" id="41719">optArrayEq</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="60382">lhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="60383">rhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#60382" title="Option[Array[Byte]]">lhs</a>, <a href="#60383" title="Option[Array[Byte]]">rhs</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="60398">x</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="60400">y</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte], x$2: Array[Byte])Boolean">equals</span><span class="delimiter">(</span><a href="#60398" title="Array[Byte]">x</a>, <a href="#60400" title="Array[Byte]">y</a><span class="delimiter">)</span>
    <span class="keyword">case</span> <span title="Boolean">_</span> =&gt; <a href="#60382" title="Option[Array[Byte]]">lhs</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#60383" title="Option[Array[Byte]]">rhs</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitionHandler: edu.berkeley.cs.scads.storage.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])" id="41720">getStartEndKey</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="60380">partitionHandler</a>: <a href="../Messages.scala.html#9559" title="edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a><span class="delimiter">)</span>: <span title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// This request could be avoided if we would store the ranges in the partitionHandler.</span>
    <span class="comment">// However replication is not on the critical path and so expensive anyway that it does not matter</span>

    <span class="keyword">val</span> <a title="(Option[Array[Byte]], Option[Array[Byte]])" id="60825">keys</a> = <a href="#60380" title="edu.berkeley.cs.scads.storage.PartitionService">partitionHandler</a> <span title="(msg: edu.berkeley.cs.scads.storage.StorageMessage, timeout: Int)edu.berkeley.cs.scads.storage.StorageMessage">!?</span> <a href="../Messages.scala.html#25205" title="()edu.berkeley.cs.scads.storage.GetResponsibilityRequest">GetResponsibilityRequest</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(Option[Array[Byte]], Option[Array[Byte]])" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="(Option[Array[Byte]], Option[Array[Byte]])">GetResponsibilityResponse</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="60828">s</a>, <a title="Option[Array[Byte]]" id="60829">e</a><span class="delimiter">)</span> =&gt; <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#60828" title="Option[Array[Byte]]">s</a>, <a href="#60829" title="Option[Array[Byte]]">e</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message&quot;)" class="string">&quot;Unexpected Message&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Nothing" class="keyword">return</span> <a href="#60825" title="(Option[Array[Byte]], Option[Array[Byte]])">keys</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="41721">loadRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RoutingTableMessage" id="60840">rangeSeq</a> = classOf<span title="java.lang.Class[edu.berkeley.cs.scads.storage.RoutingTableMessage](classOf[edu.berkeley.cs.scads.storage.RoutingTableMessage])" class="delimiter">[</span>RoutingTableMessage<span class="delimiter">]</span>.<span title="()edu.berkeley.cs.scads.storage.RoutingTableMessage">newInstance</span>
    <a href="#60840" title="edu.berkeley.cs.scads.storage.RoutingTableMessage">rangeSeq</a>.<span title="(data: Array[Byte])rangeSeq.type">parse</span><span class="delimiter">(</span><a href="Interfaces.scala.html#27945" title="(key: String, func: () =&gt; Unit)Array[Byte]">watchMetadata</a><span class="delimiter">(</span><a href="#42314" title="=&gt; java.lang.String">ZOOKEEPER_ROUTING_TABLE</a>, <a href="#41721" title="()Unit">loadRoutingTable</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]" id="60841">partition</a> = <a href="#60840" title="edu.berkeley.cs.scads.storage.RoutingTableMessage">rangeSeq</a>.<a href="../Messages.scala.html#26061" title="=&gt; Seq[edu.berkeley.cs.scads.storage.KeyRange]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.KeyRange =&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.KeyRange],edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService],Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]])Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService],Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.KeyRange" id="60870">a</a> =&gt; <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" class="keyword">new</span> <a href="util/RangeTable.scala.html#115763" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">RangeType</a><span class="delimiter">(</span><a href="#60870" title="edu.berkeley.cs.scads.storage.KeyRange">a</a>.<a href="../Messages.scala.html#25976" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#60870" title="edu.berkeley.cs.scads.storage.KeyRange">a</a>.<a href="../Messages.scala.html#25979" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#41725" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#60841" title="Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">partition</a>.<span title="(implicit evidence$1: ClassManifest[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">toArray</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** create a routing table with the assumption that each PartitionService is going to handle
   * (None -&gt; None). note this assumption is NOT validated */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitionHandlers: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit" id="41722">createRoutingTable</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="58940">partitionHandlers</a>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]" id="60942">arr</a> = <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <a href="#60942" title="(i: Int, x: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">arr</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" class="keyword">new</span> <a href="util/RangeTable.scala.html#115763" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">RangeType</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span><span title="object None">None</span>, <a href="#58940" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">partitionHandlers</a><span class="delimiter">)</span>
    <a href="#41725" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#60942" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">arr</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService]) =&gt; Boolean" id="41723">mergeCond</a> = <span class="delimiter">(</span>a: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, b: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
    <a href="#58900" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">a</a>.<span title="(that: scala.collection.GenSeq[edu.berkeley.cs.scads.storage.PartitionService])(p: (edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService) =&gt; Boolean)Boolean">corresponds</span><span class="delimiter">(</span><a href="#58901" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">b</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="58919">v1</a>, <a title="edu.berkeley.cs.scads.storage.PartitionService" id="58920">v2</a><span class="delimiter">)</span> =&gt; <a href="#58919" title="edu.berkeley.cs.scads.storage.PartitionService">v1</a>.<a href="../Messages.scala.html#21953" title="=&gt; edu.berkeley.cs.scads.storage.StorageService">storageService</a>.<a href="../Messages.scala.html#11388" title="=&gt; edu.berkeley.cs.scads.comm.ServiceId">id</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#58920" title="edu.berkeley.cs.scads.storage.PartitionService">v2</a>.<a href="../Messages.scala.html#21953" title="=&gt; edu.berkeley.cs.scads.storage.StorageService">storageService</a>.<a href="../Messages.scala.html#11388" title="=&gt; edu.berkeley.cs.scads.comm.ServiceId">id</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])Unit" id="41725">createRoutingTable</a><span class="delimiter">(</span><a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]" id="58938">ranges</a>: <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#41709" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">_routingTable</a> = <a href="util/RangeTable.scala.html#45377" title="(rTable: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]], keyComp: (Array[Byte], Array[Byte]) =&gt; Int, mergeCondition: (Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService]) =&gt; Boolean)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" class="keyword">new</a> <a href="util/RangeTable.scala.html#10593" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">RangeTable</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span>
      <a href="#58938" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">ranges</a>,
      <a href="#41715" title="=&gt; (Array[Byte], Array[Byte]) =&gt; Int">routingKeyComp</a>, 
      <a href="#41723" title="=&gt; (Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService]) =&gt; Boolean">mergeCond</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.StorageService])Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="41726">createPartitions</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="58944">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="58945">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Seq[edu.berkeley.cs.scads.storage.StorageService]" id="58946">servers</a>: <span title="Seq[edu.berkeley.cs.scads.storage.StorageService]">Seq</span><span class="delimiter">[</span>StorageService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.CreatePartitionRequest" id="60968">createReq</a> = <a href="../Messages.scala.html#24519" title="(namespace: String, partitionType: String, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.CreatePartitionRequest">CreatePartitionRequest</a><span class="delimiter">(</span><a href="Interfaces.scala.html#27939" title="=&gt; String">name</a>, <a href="Namespace.scala.html#27901" title="=&gt; String">partitionType</a>, <a href="#58944" title="Option[Array[Byte]]">startKey</a>, <a href="#58945" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#27956" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.storage.StorageMessage, edu.berkeley.cs.scads.storage.StorageService),edu.berkeley.cs.scads.storage.PartitionService])Seq[edu.berkeley.cs.scads.storage.PartitionService]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#58946" title="Seq[edu.berkeley.cs.scads.storage.StorageService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.StorageService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.StorageService],(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.StorageService" id="60995">server</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], _2: edu.berkeley.cs.scads.storage.StorageService)(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.StorageService)" class="delimiter">(</span><a href="#60995" title="edu.berkeley.cs.scads.storage.StorageService">server</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#60968" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">createReq</a>, <a href="#60995" title="edu.berkeley.cs.scads.storage.StorageService">server</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#61038" title="edu.berkeley.cs.scads.storage.PartitionService" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.PartitionService" class="delimiter">(</span>CreatePartitionResponse<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="61041">partitionActor</a><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <a href="#61041" title="edu.berkeley.cs.scads.storage.PartitionService">partitionActor</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** simply issues DeletePartitionRequests to the partition handlers, does
   * not modify the routing table. use deletePartitions to properly delete a
   * partition service */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitions: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit" id="41727">deletePartitionServices</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61044">partitions</a>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../util/ParFuture.scala.html#27956" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.storage.StorageMessage, edu.berkeley.cs.scads.storage.PartitionService),Unit])Seq[Unit]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#61044" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="61068">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], _2: edu.berkeley.cs.scads.storage.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)" class="delimiter">(</span><a href="#61068" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a>.<a href="../Messages.scala.html#21953" title="=&gt; edu.berkeley.cs.scads.storage.StorageService">storageService</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="../Messages.scala.html#24681" title="(partitionId: String)edu.berkeley.cs.scads.storage.DeletePartitionRequest">DeletePartitionRequest</a><span class="delimiter">(</span><a href="#61068" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a>.<a href="../Messages.scala.html#21950" title="=&gt; String">partitionId</a><span class="delimiter">)</span>, <a href="#61068" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#61112" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>DeletePartitionResponse<span class="delimiter">(</span><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Keys are input as regular keys. the method will convert them to routing
   * table keys */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(splitKeys: Seq[Array[Byte]])Unit" id="41728">splitPartition</a><span class="delimiter">(</span><a title="Seq[Array[Byte]]" id="61117">splitKeys</a>: <span title="Seq[Array[Byte]]">Seq</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[Array[Byte]]" id="61119">routingSplitKeys</a> = <a href="#61117" title="Seq[Array[Byte]]">splitKeys</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="Interfaces.scala.html#27932" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[Seq[edu.berkeley.cs.scads.storage.PartitionService]]" id="61120">oldPartitions</a> = <span class="keyword">for</span> <span class="delimiter">(</span><a title="Array[Byte]" id="61176">splitPoint</a> &lt;- <a href="#61119" title="(f: Array[Byte] =&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Seq[edu.berkeley.cs.scads.storage.PartitionService],Seq[Seq[edu.berkeley.cs.scads.storage.PartitionService]]])Seq[Seq[edu.berkeley.cs.scads.storage.PartitionService]]">routingSplitKeys</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45390" title="(key: Array[Byte])Boolean">isSplitKey</a><span class="delimiter">(</span><a href="#61176" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">//Otherwise it is already a split point</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound" id="61177">bound</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45388" title="(key: Array[Byte])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">lowerUpperBound</a><span class="delimiter">(</span><a href="#61176" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61178">oldPartitions</a> = <a href="#61177" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">bound</a>.<a href="util/RangeTable.scala.html#113609" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">center</a>.<a href="util/RangeTable.scala.html#115757" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">values</a>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.StorageService]" id="61179">storageServers</a> = <a href="#61178" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">oldPartitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.storage.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.storage.StorageService,Seq[edu.berkeley.cs.scads.storage.StorageService]])Seq[edu.berkeley.cs.scads.storage.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.StorageService,Seq[edu.berkeley.cs.scads.storage.StorageService]]" class="delimiter">(</span><a href="#61211" title="edu.berkeley.cs.scads.storage.PartitionService">_</a>.<a href="../Messages.scala.html#21953" title="=&gt; edu.berkeley.cs.scads.storage.StorageService">storageService</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61180">leftPart</a> = <a href="#41726" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.StorageService])Seq[edu.berkeley.cs.scads.storage.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#61177" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">bound</a>.<a href="util/RangeTable.scala.html#113609" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">center</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#61176" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>, <a href="#61179" title="Seq[edu.berkeley.cs.scads.storage.StorageService]">storageServers</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61181">rightPart</a> = <a href="#41726" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.StorageService])Seq[edu.berkeley.cs.scads.storage.PartitionService]">createPartitions</a><span class="delimiter">(</span><span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#61176" title="Array[Byte]">splitPoint</a><span class="delimiter">)</span>, <a href="#61177" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">bound</a>.<a href="util/RangeTable.scala.html#113610" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">right</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#61179" title="Seq[edu.berkeley.cs.scads.storage.StorageService]">storageServers</a><span class="delimiter">)</span>
      <a href="#41709" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">_routingTable</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45393" title="(key: Array[Byte], leftValues: Seq[edu.berkeley.cs.scads.storage.PartitionService], rightValues: Seq[edu.berkeley.cs.scads.storage.PartitionService])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">split</a><span class="delimiter">(</span><a href="#61176" title="Array[Byte]">splitPoint</a>, <a href="#61180" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">leftPart</a>, <a href="#61181" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">rightPart</a><span class="delimiter">)</span>
      <a href="#61178" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">oldPartitions</a>
    <span class="delimiter">}</span>

    <a href="#41717" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// TODO: should execute deletions in parallel, with futures</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61285">oldPartition</a> &lt;- <a href="#61120" title="(f: Seq[edu.berkeley.cs.scads.storage.PartitionService] =&gt; Unit)Unit">oldPartitions</a><span class="delimiter">)</span>
      <a href="#41727" title="(partitions: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#61285" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">oldPartition</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(mergeKeys: Seq[Array[Byte]])Unit" id="41729">mergePartition</a><span class="delimiter">(</span><a title="Seq[Array[Byte]]" id="61287">mergeKeys</a>: <span title="Seq[Array[Byte]]">Seq</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[Array[Byte]]" id="61289">routingMergeKeys</a> = <a href="#61287" title="Seq[Array[Byte]]">mergeKeys</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="Interfaces.scala.html#27932" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[(Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService])]" id="61290">oldPartitions</a> = <span class="keyword">for</span> <span class="delimiter">(</span><a title="Array[Byte]" id="61346">mergeKey</a> &lt;- <a href="#61289" title="(f: Array[Byte] =&gt; (Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Array[Byte]],(Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService]),Seq[(Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService])]])Seq[(Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService])]">routingMergeKeys</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45396" title="(key: Array[Byte])Boolean">checkMergeCondition</a><span class="delimiter">(</span><a href="#61346" title="Array[Byte]">mergeKey</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;Either the key is not a split key, or the sets are different and can not be merged&quot;)" class="string">&quot;Either the key is not a split key, or the sets are different and can not be merged&quot;</span><span class="delimiter">)</span> <span class="comment">//Otherwise we can not merge the partitions</span>

      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound" id="61347">bound</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45388" title="(key: Array[Byte])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">lowerUpperBound</a><span class="delimiter">(</span><a href="#61346" title="Array[Byte]">mergeKey</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61348">leftPart</a> = <a href="#61347" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">bound</a>.<a href="util/RangeTable.scala.html#113608" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">left</a>.<a href="util/RangeTable.scala.html#115757" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">values</a>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61349">rightPart</a> = <a href="#61347" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">bound</a>.<a href="util/RangeTable.scala.html#113609" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">center</a>.<a href="util/RangeTable.scala.html#115757" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">values</a> <span class="comment">//have to use center as this is the partition with the split key</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.StorageService]" id="61350">storageServers</a> = <a href="#61348" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">leftPart</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.storage.StorageService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.storage.StorageService,Seq[edu.berkeley.cs.scads.storage.StorageService]])Seq[edu.berkeley.cs.scads.storage.StorageService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.StorageService,Seq[edu.berkeley.cs.scads.storage.StorageService]]" class="delimiter">(</span><a href="#61376" title="edu.berkeley.cs.scads.storage.PartitionService">_</a>.<a href="../Messages.scala.html#21953" title="=&gt; edu.berkeley.cs.scads.storage.StorageService">storageService</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61351">mergePartition</a> = <a href="#41726" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.StorageService])Seq[edu.berkeley.cs.scads.storage.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#61347" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">bound</a>.<a href="util/RangeTable.scala.html#113608" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">left</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#61347" title="edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]#RangeBound">bound</a>.<a href="util/RangeTable.scala.html#113610" title="=&gt; edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">right</a>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#61350" title="Seq[edu.berkeley.cs.scads.storage.StorageService]">storageServers</a><span class="delimiter">)</span>

      <a href="#41709" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">_routingTable</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45398" title="(key: Array[Byte], values: Seq[edu.berkeley.cs.scads.storage.PartitionService])edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">merge</a><span class="delimiter">(</span><a href="#61346" title="Array[Byte]">mergeKey</a>, <a href="#61351" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">mergePartition</a><span class="delimiter">)</span>
      <span title="(_1: Seq[edu.berkeley.cs.scads.storage.PartitionService], _2: Seq[edu.berkeley.cs.scads.storage.PartitionService])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService])" class="delimiter">(</span><a href="#61348" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">leftPart</a>, <a href="#61349" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">rightPart</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#41717" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// TODO: same as for splitPartition, could do this in parallel </span>
    <span class="keyword">for</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61465">leftPart</a>, <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61466">rightPart</a><span class="delimiter">)</span> &lt;- <a href="#61290" title="(f: (Seq[edu.berkeley.cs.scads.storage.PartitionService], Seq[edu.berkeley.cs.scads.storage.PartitionService]) =&gt; Unit)Unit">oldPartitions</a><span class="delimiter">)</span><span class="delimiter">{</span>
      <a href="#41727" title="(partitions: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#61465" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">leftPart</a><span class="delimiter">)</span>
      <a href="#41727" title="(partitions: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#61466" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">rightPart</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(partitionHandlers: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit" id="41730">deletePartitions</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61468">partitionHandlers</a>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">for</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="61486">partitionHandler</a> &lt;- <a href="#61468" title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; Unit)Unit">partitionHandlers</a><span class="delimiter">)</span><span class="delimiter">{</span>
      <span class="keyword">val</span> <a href="#61488" title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</a><a href="#61487" title="Option[Array[Byte]]" id="61488">startKey</a>, <a href="#61487" title="Option[Array[Byte]]" id="61489">endKey</a><span class="delimiter">)</span> = <a href="#41720" title="(partitionHandler: edu.berkeley.cs.scads.storage.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span title="(Option[Array[Byte]], Option[Array[Byte]]) @unchecked" class="delimiter">(</span><a href="#61486" title="edu.berkeley.cs.scads.storage.PartitionService">partitionHandler</a><span class="delimiter">)</span> <span class="comment">//Not really needed, just an additional check</span>
      <a href="#41709" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">_routingTable</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45403" title="(key: Option[Array[Byte]], value: edu.berkeley.cs.scads.storage.PartitionService)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">removeValueFromRange</a><span class="delimiter">(</span><a href="#61488" title="Option[Array[Byte]]">startKey</a>, <a href="#61486" title="edu.berkeley.cs.scads.storage.PartitionService">partitionHandler</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#41717" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#41727" title="(partitions: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#61468" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">partitionHandlers</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(targets: Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.StorageService)])Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="41731">replicatePartitions</a><span class="delimiter">(</span><a title="Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.StorageService)]" id="61509">targets</a>: <span title="Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.StorageService)]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, StorageService<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)]" id="61511">result</a> = <span class="keyword">for</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="61546">partitionHandler</a>, <a title="edu.berkeley.cs.scads.storage.StorageService" id="61547">storageHandler</a><span class="delimiter">)</span> &lt;- <a href="#61509" title="(f: (edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.StorageService) =&gt; (edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.StorageService)],(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)]])Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)]">targets</a><span class="delimiter">)</span> <span class="keyword">yield</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a href="#61549" title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</a><a href="#61548" title="Option[Array[Byte]]" id="61549">startKey</a>, <a href="#61548" title="Option[Array[Byte]]" id="61550">endKey</a><span class="delimiter">)</span> = <a href="#41720" title="(partitionHandler: edu.berkeley.cs.scads.storage.PartitionService)(Option[Array[Byte]], Option[Array[Byte]])">getStartEndKey</a><span title="(Option[Array[Byte]], Option[Array[Byte]]) @unchecked" class="delimiter">(</span><a href="#61546" title="edu.berkeley.cs.scads.storage.PartitionService">partitionHandler</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionService" id="61551">newPartition</a> = <a href="#41726" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.StorageService])Seq[edu.berkeley.cs.scads.storage.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#61549" title="Option[Array[Byte]]">startKey</a>, <a href="#61550" title="Option[Array[Byte]]">endKey</a>, <span title="(elems: edu.berkeley.cs.scads.storage.StorageService*)Seq[edu.berkeley.cs.scads.storage.StorageService]">Seq</span><span class="delimiter">(</span><a href="#61547" title="edu.berkeley.cs.scads.storage.StorageService">storageHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionService">head</span>
      <a href="#41709" title="(x$1: edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">_routingTable</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45401" title="(key: Option[Array[Byte]], value: edu.berkeley.cs.scads.storage.PartitionService)edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">addValueToRange</a><span class="delimiter">(</span><a href="#61549" title="Option[Array[Byte]]">startKey</a>, <a href="#61551" title="edu.berkeley.cs.scads.storage.PartitionService">newPartition</a><span class="delimiter">)</span>
      <span title="(_1: edu.berkeley.cs.scads.storage.PartitionService, _2: edu.berkeley.cs.scads.storage.PartitionService)(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)" class="delimiter">(</span><a href="#61551" title="edu.berkeley.cs.scads.storage.PartitionService">newPartition</a>, <a href="#61546" title="edu.berkeley.cs.scads.storage.PartitionService">partitionHandler</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#41717" title="()Unit">storeAndPropagateRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#27956" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.storage.StorageMessage, edu.berkeley.cs.scads.storage.PartitionService),Unit])Seq[Unit]">waitForAndThrowException</a><span class="delimiter">(</span>
      <a href="#61511" title="Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)]">result</a>.<span title="(f: (edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService) =&gt; (edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)],(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]">map</span> <a href="#61621" title="(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)" class="delimiter">{</a>
        <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="61624">newPartition</a>, <a title="edu.berkeley.cs.scads.storage.PartitionService" id="61625">oldPartition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], _2: edu.berkeley.cs.scads.storage.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)" class="delimiter">(</span><a href="#61624" title="edu.berkeley.cs.scads.storage.PartitionService">newPartition</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="../Messages.scala.html#25133" title="(src: edu.berkeley.cs.scads.storage.PartitionService, overwrite: Boolean)edu.berkeley.cs.scads.storage.CopyDataRequest">CopyDataRequest</a><span class="delimiter">(</span><a href="#61625" title="edu.berkeley.cs.scads.storage.PartitionService">oldPartition</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>, <a href="#61624" title="edu.berkeley.cs.scads.storage.PartitionService">newPartition</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>, <span class="int">3</span>*<span class="int">60</span><span title="Long(180000L)">*</span><span class="int">1000</span><span class="delimiter">)</span> <a href="#61676" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>CopyDataResponse<span class="delimiter">(</span><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> 
    <span class="delimiter">}</span>
    <a href="#61511" title="Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)]">result</a>.<span title="(f: (edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService) =&gt; edu.berkeley.cs.scads.storage.PartitionService)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)],edu.berkeley.cs.scads.storage.PartitionService,Seq[edu.berkeley.cs.scads.storage.PartitionService]])Seq[edu.berkeley.cs.scads.storage.PartitionService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.PartitionService,Seq[edu.berkeley.cs.scads.storage.PartitionService]]" class="delimiter">(</span><a href="#61691" title="(edu.berkeley.cs.scads.storage.PartitionService, edu.berkeley.cs.scads.storage.PartitionService)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionService">_1</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(scheme: Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])])Unit" id="41732">setPartitionScheme</a><span class="delimiter">(</span><a title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])]" id="61711">scheme</a>: <span title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, Seq<span class="delimiter">[</span>StorageService<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#61711" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Scheme must have at least 1 entry&quot;)" class="string">&quot;Scheme must have at least 1 entry&quot;</span><span class="delimiter">)</span> 
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#61711" title="(idx: Int)(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])">scheme</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">_1</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="object None">None</span>, <span title="java.lang.String(&quot;first entry in scheme must be None&quot;)" class="string">&quot;first entry in scheme must be None&quot;</span><span class="delimiter">)</span>

    <span class="comment">// capture old partition handles so we can delete them later</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="61713">oldServices</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#46932" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">rTable</a>.<span title="(f: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService] =&gt; scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.storage.PartitionService])(implicit bf: scala.collection.generic.CanBuildFrom[Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]],edu.berkeley.cs.scads.storage.PartitionService,Array[edu.berkeley.cs.scads.storage.PartitionService]])Array[edu.berkeley.cs.scads.storage.PartitionService]">flatMap</span><span title="(xs: Array[edu.berkeley.cs.scads.storage.PartitionService])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.storage.PartitionService]" class="delimiter">(</span><a href="#62188" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_</a>.<a href="util/RangeTable.scala.html#115757" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">values</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[edu.berkeley.cs.scads.storage.PartitionService]">toSet</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">toSeq</span> <span class="comment">// will the services ever have duplicates?</span>

    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]" id="61714">rTable</a> = <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">Array</span><span class="delimiter">[</span>RangeType<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#61711" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="61715">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="61716">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Int" id="61717">i</a> = <a href="#61711" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])]">scheme</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])" id="62446">range</a> &lt;- <a href="#61711" title="Seq[(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])]">scheme</a>.<span title="(f: (Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService]) =&gt; Unit)Unit">reverse</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#61715" title="Option[Array[Byte]]">startKey</a> = <a href="#62446" title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])">range</a>.<span title="=&gt; Option[Array[Byte]]">_1</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="62447">handlers</a> = <a href="#41726" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], servers: Seq[edu.berkeley.cs.scads.storage.StorageService])Seq[edu.berkeley.cs.scads.storage.PartitionService]">createPartitions</a><span class="delimiter">(</span><a href="#61715" title="Option[Array[Byte]]">startKey</a>, <a href="#61716" title="Option[Array[Byte]]">endKey</a>, <a href="#62446" title="(Option[Array[Byte]], Seq[edu.berkeley.cs.scads.storage.StorageService])">range</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.StorageService]">_2</span><span class="delimiter">)</span>
      <a href="#61714" title="(i: Int, x: edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService])Unit">rTable</a><span class="delimiter">(</span><a href="#61717" title="Int">i</a><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]" class="keyword">new</span> <a href="util/RangeTable.scala.html#115763" title="edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">RangeType</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, PartitionService<span class="delimiter">]</span><span class="delimiter">(</span><a href="#61715" title="Option[Array[Byte]]">startKey</a>, <a href="#62447" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">handlers</a><span class="delimiter">)</span>
      <a href="#61716" title="Option[Array[Byte]]">endKey</a> = <a href="#61715" title="Option[Array[Byte]]">startKey</a>
      <a href="#61717" title="Int">i</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Setting new routing table: %s&quot;)" class="string">&quot;Setting new routing table: %s&quot;</span>, <a href="#61714" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">rTable</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">toSeq</span><span class="delimiter">)</span>
    <a href="#41725" title="(ranges: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])Unit">createRoutingTable</a><span class="delimiter">(</span><a href="#61714" title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">rTable</a><span class="delimiter">)</span> <span class="comment">// sets _routingTable</span>
    <a href="#41716" title="()Unit">storeRoutingTable</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// propogates via zookeeper</span>

    <span class="comment">// now do cleanup on existing partitions</span>
    <a href="#41727" title="(partitions: Seq[edu.berkeley.cs.scads.storage.PartitionService])Unit">deletePartitionServices</a><span class="delimiter">(</span><a href="#61713" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">oldServices</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike with ScalaObject" id="9911">DefaultKeyRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9910" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a> <span class="delimiter">{</span>
  <span class="comment">/** No op - the key is its own routing key */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="41734">convertToRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="62725">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#62725" title="Array[Byte]">key</a>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="(Array[Byte], Array[Byte]) =&gt; Int" id="41735">routingKeyComp</a> = <a href="Interfaces.scala.html#27933" title="(x: Array[Byte], y: Array[Byte])Int">compareKey</a> _ 
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultHashKeyRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike with ScalaObject" id="9912">DefaultHashKeyRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9910" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutableLike">DefaultKeyRoutableLike</a> <span class="delimiter">{</span>

  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="44477">convertToRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="62937">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// here's where we apply the hash function, and return a </span>
    <span class="comment">// routing key which represents the 4 bytes of the hash</span>
    <span class="keyword">val</span> <a title="Int" id="62940">hash</a> = <a href="Interfaces.scala.html#27934" title="(x: Array[Byte])Int">hashKey</a><span class="delimiter">(</span><a href="#62937" title="Array[Byte]">key</a><span class="delimiter">)</span>

    <span class="comment">// TODO: don't be lazy, and just write the hash directly to a byte array,</span>
    <span class="comment">// saving an object allocation</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="62941">b</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Int)java.nio.ByteBuffer">allocate</span><span class="delimiter">(</span><span title="Int(4)" class="int">4</span><span class="delimiter">)</span>
    <a href="#62941" title="java.nio.ByteBuffer">b</a>.<span title="(x$1: Int)java.nio.ByteBuffer">putInt</span><span class="delimiter">(</span><a href="#62940" title="Int">hash</a><span class="delimiter">)</span>
    <a href="#62941" title="java.nio.ByteBuffer">b</a>.<span title="()Array[Byte]">array</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="(Array[Byte], Array[Byte]) =&gt; Int" id="44478">routingKeyComp</a> = <span class="delimiter">(</span>lhs: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, rhs: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#62730" title="Array[Byte]">lhs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(4)" class="int">4</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#62731" title="Array[Byte]">rhs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(4)" class="int">4</span>, <span title="java.lang.String(&quot;bad routing keys passed to comp&quot;)" class="string">&quot;bad routing keys passed to comp&quot;</span><span class="delimiter">)</span>

    <span class="comment">// TODO: don't be lazy, and just pull the bytes right out of the array</span>
    <span class="comment">// instead of having a byte buffer do the work of converting to int</span>
    <span class="comment">// (saves 2 object allocations per comparison)</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="62732">lhs_bb</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#62730" title="Array[Byte]">lhs</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.nio.ByteBuffer" id="62733">rhs_bb</a> = <span title="object java.nio.ByteBuffer">ByteBuffer</span>.<span title="(x$1: Array[Byte])java.nio.ByteBuffer">wrap</span><span class="delimiter">(</span><a href="#62731" title="Array[Byte]">rhs</a><span class="delimiter">)</span>

    <span class="comment">// equiv to Integer.compareTo, except minus the auto-boxing</span>
    <span class="keyword">val</span> <a title="Int" id="62734">diff</a> = <a href="#62732" title="java.nio.ByteBuffer">lhs_bb</a>.<span title="()Int">getInt</span> <span title="(x: Int)Int">-</span> <a href="#62733" title="java.nio.ByteBuffer">rhs_bb</a>.<span title="()Int">getInt</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#62734" title="Int">diff</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="Int(0)" class="int">0</span> 
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#62734" title="Int">diff</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">else</span> <span title="Int(1)" class="int">1</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DefaultKeyRangeRoutable extends java.lang.Object with edu.berkeley.cs.scads.storage.DefaultKeyRoutable with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9913">DefaultKeyRangeRoutable</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#9911" title="edu.berkeley.cs.scads.storage.DefaultKeyRoutable">DefaultKeyRoutable</a> <span class="keyword">with</span> <a href="Interfaces.scala.html#9864" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>
  <span class="comment">/** No-op b/c routing key is the same key as a range key */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Array[Byte]" id="41738">convertFromRoutingKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="62946">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <a href="#62946" title="Array[Byte]">key</a>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="41739">serversForKeyRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="44062">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="44063">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">Seq</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]" id="62948">ranges</a> = <a href="#41709" title="=&gt; edu.berkeley.cs.scads.util.RangeTable[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">_routingTable</a>.<a href="util/RangeTable.scala.html#45391" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">valuesForRange</a><span class="delimiter">(</span><a href="#44062" title="Option[Array[Byte]]">startKey</a>, <a href="#44063" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Array[edu.berkeley.cs.scads.storage.RangeDesc]" id="62949">result</a> = <span title="Array[edu.berkeley.cs.scads.storage.RangeDesc]" class="keyword">new</span> <span title="Array[edu.berkeley.cs.scads.storage.RangeDesc]">Array</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span><span class="delimiter">(</span><a href="#62948" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">ranges</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="62950">sKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="62951">eKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <a href="#44063" title="Option[Array[Byte]]">endKey</a>

    <span class="keyword">var</span> <a title="Int" id="62952">i</a> = <a href="#62948" title="(xs: Array[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]]">ranges</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#62952" title="Int">i</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#62953" title="()Unit" class="delimiter">{</a>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62952" title="Int">i</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#62950" title="Option[Array[Byte]]">sKey</a> = <a href="#44062" title="Option[Array[Byte]]">startKey</a>
      <span class="keyword">else</span> <a href="#62950" title="Option[Array[Byte]]">sKey</a> = <a href="#62948" title="(i: Int)edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">ranges</a><span class="delimiter">(</span><a href="#62952" title="Int">i</a><span class="delimiter">)</span>.<a href="util/RangeTable.scala.html#115756" title="=&gt; Option[Array[Byte]]">startKey</a>
      <a href="#62949" title="(i: Int, x: edu.berkeley.cs.scads.storage.RangeDesc)Unit">result</a><span class="delimiter">(</span><a href="#62952" title="Int">i</a><span class="delimiter">)</span> = <span title="edu.berkeley.cs.scads.storage.RangeDesc" class="keyword">new</span> <a href="Interfaces.scala.html#9861" title="edu.berkeley.cs.scads.storage.RangeDesc">RangeDesc</a><span class="delimiter">(</span><a href="#62950" title="Option[Array[Byte]]">sKey</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#41738" title="(key: Array[Byte])Array[Byte]">convertFromRoutingKey</a><span class="delimiter">)</span>, <a href="#62951" title="Option[Array[Byte]]">eKey</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#41734" title="(key: Array[Byte])Array[Byte]">convertToRoutingKey</a><span class="delimiter">)</span>, <a href="#62948" title="(i: Int)edu.berkeley.cs.scads.util.RangeType[Array[Byte],edu.berkeley.cs.scads.storage.PartitionService]">ranges</a><span class="delimiter">(</span><a href="#62952" title="Int">i</a><span class="delimiter">)</span>.<a href="util/RangeTable.scala.html#115757" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">values</a><span class="delimiter">)</span>
      <a href="#62951" title="Option[Array[Byte]]">eKey</a> = <a href="#62950" title="Option[Array[Byte]]">sKey</a>
      <a href="#62952" title="Int">i</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="#62949" title="(xs: Array[edu.berkeley.cs.scads.storage.RangeDesc])scala.collection.mutable.ArrayOps[edu.berkeley.cs.scads.storage.RangeDesc]">result</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">toSeq</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>