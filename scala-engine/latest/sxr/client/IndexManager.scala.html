<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/IndexManager.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> org.apache.avro.generic.<span class="delimiter">{</span> GenericData, IndexedRecord <span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.zookeeper.<span class="delimiter">{</span> CreateMode, WatchedEvent <span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.zookeeper.<span title="object org.apache.zookeeper.Watcher">Watcher</span>.<span title="object org.apache.zookeeper.Watcher.Event">Event</span>.EventType

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.immutable.HashMap

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.avro.marker._
<span class="keyword">import</span> org.apache.avro.util.Utf8

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.IndexManager" id="9568">IndexManager</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="40954">indexValueSchema</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="41148">schema</a> = <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: java.lang.String, x$4: Boolean)org.apache.avro.Schema">createRecord</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DummyValue&quot;)" class="string">&quot;DummyValue&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <a href="#41148" title="org.apache.avro.Schema">schema</a>.<span title="(x$1: java.util.List[org.apache.avro.Schema.Field])Unit">setFields</span><span class="delimiter">(</span><span title="(elems: org.apache.avro.Schema.Field*)Seq[org.apache.avro.Schema.Field]">Seq</span><span title="(b: Seq[org.apache.avro.Schema.Field])java.util.List[org.apache.avro.Schema.Field]" class="delimiter">(</span><span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><span title="java.lang.String(&quot;b&quot;)" class="string">&quot;b&quot;</span>, <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: org.apache.avro.Schema.Type)org.apache.avro.Schema">create</span><span class="delimiter">(</span>Schema.Type.<span title="org.apache.avro.Schema.Type(value BOOLEAN)">BOOLEAN</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#41148" title="org.apache.avro.Schema">schema</a>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="40956">dummyIndexValue</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="42303">rec</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#40954" title="=&gt; org.apache.avro.Schema">indexValueSchema</a><span class="delimiter">)</span>
    <a href="#42303" title="org.apache.avro.generic.GenericData.Record">rec</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <a href="#42303" title="org.apache.avro.generic.GenericData.Record">rec</a>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" id="40958">valueReaderWriter</a> = <span title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" class="keyword">new</span> <a href="AvroSerializer.scala.html#9506" title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">AvroGenericReaderWriter</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span><span class="delimiter">(</span><span title="object None">None</span>, <a href="#40954" title="=&gt; org.apache.avro.Schema">indexValueSchema</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="Array[Byte]" id="40960">dummyIndexValueBytes</a> = <a href="#40958" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">valueReaderWriter</a>.<a href="AvroSerializer.scala.html#31479" title="(rec: org.apache.avro.generic.IndexedRecord)Array[Byte]">serialize</a><span class="delimiter">(</span><a href="#40956" title="=&gt; org.apache.avro.generic.GenericData.Record">dummyIndexValue</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.lang.String" id="40962">indexDefinition</a> = <span title="java.lang.String(&quot;indexDef&quot;)" class="string">&quot;indexDef&quot;</span>
<span class="delimiter">}</span>

<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait IndexType extends java.lang.Object with edu.berkeley.cs.avro.marker.AvroUnion" id="109345">IndexType</a> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroUnion">AvroUnion</span>
case <span class="keyword">class</span> <a href="#109347" title="class AttributeIndex extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.storage.IndexType with ScalaObject with Product with Serializable" id="49832">AttributeIndex</a><a href="#49832" title="ScalaObject" class="delimiter">(</a><a href="#49832" title="()edu.berkeley.cs.scads.storage.AttributeIndex" id="108802" class="keyword">var</a> <a title="String" id="46643">fieldName</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#109345" title="edu.berkeley.cs.scads.storage.IndexType">IndexType</a>
case <span class="keyword">class</span> <a href="#110650" title="class TokenIndex extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.storage.IndexType with ScalaObject with Product with Serializable" id="49828">TokenIndex</a><a href="#49828" title="ScalaObject" class="delimiter">(</a><a href="#49828" title="()edu.berkeley.cs.scads.storage.TokenIndex" id="108812" class="keyword">var</a> <a title="Seq[String]" id="49825">fieldNames</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#109345" title="edu.berkeley.cs.scads.storage.IndexType">IndexType</a>

case <span class="keyword">class</span> <a href="#112731" title="class IndexDefinition extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="49821">IndexDefinition</a><a href="#49821" title="ScalaObject" class="delimiter">(</a><a href="#49821" title="()edu.berkeley.cs.scads.storage.IndexDefinition" id="108822" class="keyword">var</a> <a title="Seq[edu.berkeley.cs.scads.storage.IndexType]" id="46605">fields</a>: <span title="Seq[edu.berkeley.cs.scads.storage.IndexType]">Seq</span><span class="delimiter">[</span>IndexType<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>


<span class="keyword">class</span> <a title="class IndexNamespace extends java.lang.Object with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.SimpleRecordMetadata with edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata with edu.berkeley.cs.scads.storage.QuorumRangeProtocol with edu.berkeley.cs.scads.storage.DefaultKeyRangeRoutable with edu.berkeley.cs.scads.storage.RecordStore[org.apache.avro.generic.IndexedRecord] with edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord] with edu.berkeley.cs.scads.storage.NamespaceIterator[org.apache.avro.generic.IndexedRecord] with edu.berkeley.cs.scads.storage.DebuggingClient with ScalaObject" id="9580">IndexNamespace</a><a href="#9580" title="ScalaObject" class="delimiter">(</a>
    <span class="keyword">val</span> <a title="String" id="42629">name</a>: <span title="String">String</span>,
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="42630">cluster</a>: <a href="ScadsCluster.scala.html#9681" title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</a>,
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="42631">root</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
    <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="42632">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="Namespace.scala.html#9625" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a> 
  <span class="keyword">with</span> <a href="SimpleRecordMetadata.scala.html#9693" title="edu.berkeley.cs.scads.storage.SimpleRecordMetadata">SimpleRecordMetadata</a> 
  <span class="keyword">with</span> <a href="ZooKeeperGlobalMetadata.scala.html#9732" title="edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata">ZooKeeperGlobalMetadata</a>
  <span class="keyword">with</span> <a href="QuorumProtocol.scala.html#9648" title="edu.berkeley.cs.scads.storage.QuorumRangeProtocol">QuorumRangeProtocol</a>
  <span class="keyword">with</span> <a href="Routable.scala.html#9664" title="edu.berkeley.cs.scads.storage.DefaultKeyRangeRoutable">DefaultKeyRangeRoutable</a>
  <span class="keyword">with</span> <a href="Stores.scala.html#9723" title="edu.berkeley.cs.scads.storage.RecordStore[org.apache.avro.generic.IndexedRecord]">RecordStore</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9601" title="edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]">Serializer</a><span class="delimiter">[</span>IndexedRecord, IndexedRecord, IndexedRecord<span class="delimiter">]</span>
  <span class="keyword">with</span> <a href="NamespaceIterator.scala.html#9631" title="edu.berkeley.cs.scads.storage.NamespaceIterator[org.apache.avro.generic.IndexedRecord]">NamespaceIterator</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span>
  <span class="keyword">with</span> <a href="Debugging.scala.html#9532" title="edu.berkeley.cs.scads.storage.DebuggingClient">DebuggingClient</a>
<span class="delimiter">{</span> 
  <span class="keyword">import</span> <a href="#9568" title="object edu.berkeley.cs.scads.storage.IndexManager">IndexManager</a>._

  <span class="keyword">val</span> <a title="java.lang.String" id="42596">valueClass</a> = classOf<span title="java.lang.Class[org.apache.avro.generic.IndexedRecord](classOf[org.apache.avro.generic.IndexedRecord])" class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span>.<span title="()java.lang.String">getName</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" id="42599">keyReaderWriter</a> = <span title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" class="keyword">new</span> <a href="AvroSerializer.scala.html#9506" title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">AvroGenericReaderWriter</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span><span class="delimiter">(</span><span title="(x: org.apache.avro.Schema)Some[org.apache.avro.Schema]">Some</span><span class="delimiter">(</span><a href="ZooKeeperGlobalMetadata.scala.html#37956" title="=&gt; org.apache.avro.Schema">remoteKeySchema</a><span class="delimiter">)</span>, <a href="#42632" title="=&gt; org.apache.avro.Schema">keySchema</a><span class="delimiter">)</span>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord" id="42600">bytesToKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="42637">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span> = 
    <a href="#42598" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31480" title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord">deserialize</a><span class="delimiter">(</span><a href="#42637" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord" id="42601">bytesToValue</a><span class="delimiter">(</span><a title="Array[Byte]" id="42643">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span> =
    <a href="#40956" title="=&gt; org.apache.avro.generic.GenericData.Record">dummyIndexValue</a>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Array[Byte])org.apache.avro.generic.IndexedRecord" id="42602">bytesToBulk</a><span class="delimiter">(</span><a title="Array[Byte]" id="42645">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Array[Byte]" id="42646">value</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="#42598" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31480" title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord">deserialize</a><span class="delimiter">(</span><a href="#42645" title="Array[Byte]">key</a><span class="delimiter">)</span>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]" id="42603">keyToBytes</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42653">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> =
    <a href="#42598" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31479" title="(rec: org.apache.avro.generic.IndexedRecord)Array[Byte]">serialize</a><span class="delimiter">(</span><a href="#42653" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(value: org.apache.avro.generic.IndexedRecord)Array[Byte]" id="42604">valueToBytes</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42657">value</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = 
    <a href="#40960" title="=&gt; Array[Byte]">dummyIndexValueBytes</a>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(b: org.apache.avro.generic.IndexedRecord)(Array[Byte], Array[Byte])" id="42605">bulkToBytes</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42660">b</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span>: <span title="(Array[Byte], Array[Byte])" class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = 
    <span title="(_1: Array[Byte], _2: Array[Byte])(Array[Byte], Array[Byte])" class="delimiter">(</span><a href="#42603" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#42660" title="org.apache.avro.generic.IndexedRecord">b</a><span class="delimiter">)</span>, <a href="#40960" title="=&gt; Array[Byte]">dummyIndexValueBytes</a><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; org.apache.avro.generic.GenericData.Record" id="42606">newKeyInstance</a> = <a href="#42598" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31867" title="=&gt; org.apache.avro.generic.GenericData.Record">newInstance</a>

  <span class="keyword">override</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="42608">valueSchema</a> = <a href="#40954" title="=&gt; org.apache.avro.Schema">indexValueSchema</a>

  <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]" id="42609">asyncGetRecord</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42672">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span> = <a href="Stores.scala.html#33566" title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGet</a><span class="delimiter">(</span><a href="#42672" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]" id="42610">getRecord</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42682">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span> = <a href="Stores.scala.html#33563" title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">get</a><span class="delimiter">(</span><a href="#42682" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(schema: org.apache.avro.Schema)org.apache.avro.generic.IndexedRecord" id="42611">newRecord</a><span class="delimiter">(</span><a title="org.apache.avro.Schema" id="42687">schema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> = <a href="#42598" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31482" title="(schema: org.apache.avro.Schema)org.apache.avro.generic.IndexedRecord">newRecord</a><span class="delimiter">(</span><a href="#42687" title="org.apache.avro.Schema">schema</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** An IndexManager is intended to provide index maintainence for AvroPair
 * namespaces. the methods below are not intended to be thread-safe */</span>
<span class="keyword">trait</span> <a title="trait IndexManager[BulkType &lt;: edu.berkeley.cs.avro.marker.AvroPair] extends java.lang.Object with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.Protocol with edu.berkeley.cs.scads.storage.RangeKeyValueStoreLike[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType] with edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType] with edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata with edu.berkeley.cs.scads.storage.RecordStore[BulkType] with ScalaObject" id="9581">IndexManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: edu.berkeley.cs.avro.marker.AvroPair" id="9582">BulkType</a> &lt;: AvroPair<span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="Namespace.scala.html#9625" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a> 
	  <span class="keyword">with</span> <a href="Interfaces.scala.html#9610" title="edu.berkeley.cs.scads.storage.Protocol">Protocol</a>
	  <span class="keyword">with</span> <a href="Interfaces.scala.html#9597" title="edu.berkeley.cs.scads.storage.RangeKeyValueStoreLike[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType]">RangeKeyValueStoreLike</a><span class="delimiter">[</span>IndexedRecord, IndexedRecord, BulkType<span class="delimiter">]</span>
	  <span class="keyword">with</span> <a href="Interfaces.scala.html#9601" title="edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType]">Serializer</a><span class="delimiter">[</span>IndexedRecord, IndexedRecord, BulkType<span class="delimiter">]</span>
	  <span class="keyword">with</span> <a href="ZooKeeperGlobalMetadata.scala.html#9732" title="edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata">ZooKeeperGlobalMetadata</a>
    <span class="keyword">with</span> <a href="Stores.scala.html#9723" title="edu.berkeley.cs.scads.storage.RecordStore[BulkType]">RecordStore</a><span class="delimiter">[</span>BulkType<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">import</span> <a href="#9568" title="object edu.berkeley.cs.scads.storage.IndexManager">IndexManager</a>._

  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="40845">indexCatalogue</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> = _
  <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexManger Constructor: %s&quot;)" class="string">&quot;IndexManger Constructor: %s&quot;</span>, <a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a><span class="delimiter">)</span>

  <span class="comment">/**
   * In memory cache of (index namespaces, seq of field values (left is from
   * key, right is from value)). is a volatile immutable hash map so we don't
   * have to do any synchronization when reading
   */</span>
  @volatile <span class="keyword">protected</span> <span class="keyword">var</span> <a title="scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]" id="40848">indexNamespacesCache</a> = <span title="scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]" class="keyword">new</span> <span title="scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">HashMap</span><span class="delimiter">[</span>String, <span class="delimiter">(</span>IndexNamespace, IndexDefinition<span class="delimiter">)</span><span class="delimiter">]</span>

  <a href="Namespace.scala.html#13607" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span><a title="Boolean" id="43051">isNew</a> =&gt;
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Opening index catalog for namespace %s&quot;)" class="string">&quot;Opening index catalog for namespace %s&quot;</span>, <a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a><span class="delimiter">)</span>
    <a href="#40845" title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)Unit">indexCatalogue</a> = <a href="ZooKeeperGlobalMetadata.scala.html#37952" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="43062">nsRoot</a>.<a href="#43062" title="Int" id="43064">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;indexes&quot;)" id="43063" class="string">&quot;indexes&quot;</a><span class="delimiter">)</span>
    <a href="#40853" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#43051" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13605" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Creating index catalog for namespace %s&quot;)" class="string">&quot;Creating index catalog for namespace %s&quot;</span>, <a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a><span class="delimiter">)</span>
    <a href="#40845" title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)Unit">indexCatalogue</a> = <a href="ZooKeeperGlobalMetadata.scala.html#37952" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><span title="java.lang.String(&quot;indexes&quot;)" class="string">&quot;indexes&quot;</span>, <span title="object Array">Array</span>.<span title="(implicit evidence$1: scala.reflect.ClassManifest[Byte])Array[Byte]">empty</span>, CreateMode.<span title="org.apache.zookeeper.CreateMode(value PERSISTENT)">PERSISTENT</span><span class="delimiter">)</span>
    <a href="#40853" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">abstract</span> <span class="keyword">def</span> <a title="(data: Seq[BulkType], replicationFactor: Int)Unit" id="40850">repartition</a><span class="delimiter">(</span><a title="Seq[BulkType]" id="43106">data</a>: <span title="Seq[BulkType]">Seq</span><span class="delimiter">[</span>BulkType<span class="delimiter">]</span>, <a title="Int" id="43107">replicationFactor</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#40857" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span> <a href="#43150" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="43153">ns</a>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43154">mapping</a><span class="delimiter">)</span> =&gt;
        <a href="#43153" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#40841" title="(data: Seq[org.apache.avro.generic.IndexedRecord], replicationFactor: Int)Unit">repartition</a><span class="delimiter">(</span><a href="#43106" title="Seq[BulkType]">data</a>.<span title="(f: BulkType =&gt; scala.collection.GenTraversableOnce[org.apache.avro.generic.IndexedRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[BulkType],org.apache.avro.generic.IndexedRecord,Seq[org.apache.avro.generic.IndexedRecord]])Seq[org.apache.avro.generic.IndexedRecord]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.generic.IndexedRecord,Seq[org.apache.avro.generic.IndexedRecord]]" class="delimiter">(</span><a title="BulkType" id="43178">d</a> =&gt; <a href="#40861" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#43178" title="BulkType">d</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span>, <a href="#43178" title="BulkType">d</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">value</span>, <a href="#43153" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42632" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43154" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#43107" title="Int">replicationFactor</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#9581" title="edu.berkeley.cs.scads.storage.IndexManager[BulkType]" class="keyword">super</a>.<a href="Stores.scala.html#40841" title="(data: Seq[BulkType], replicationFactor: Int)Unit">repartition</a><span class="delimiter">(</span><a href="#43106" title="Seq[BulkType]">data</a>, <a href="#43107" title="Int">replicationFactor</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">abstract</span> <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit" id="40851">put</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="40951">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span>, <a title="Option[org.apache.avro.generic.IndexedRecord]" id="40952">value</a>: <span title="Option[org.apache.avro.generic.IndexedRecord]">Option</span><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="43207">optOldValue</a> = <a href="Stores.scala.html#33563" title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">get</a><span class="delimiter">(</span><a href="#40951" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>
    <a href="#40857" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span> <a href="#43228" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="43231">ns</a>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43232">mapping</a><span class="delimiter">)</span> =&gt;
      <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43233">oldIndexValues</a> = <a href="#43207" title="Option[org.apache.avro.generic.IndexedRecord]">optOldValue</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Seq[org.apache.avro.generic.IndexedRecord])Option[Seq[org.apache.avro.generic.IndexedRecord]]">map</span><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43238">oldValue</a> =&gt; <a href="#40861" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#40951" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#43238" title="org.apache.avro.generic.IndexedRecord">oldValue</a>, <a href="#43231" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42632" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43232" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; Seq[org.apache.avro.generic.IndexedRecord])Seq[org.apache.avro.generic.IndexedRecord]">getOrElse</span><span class="delimiter">(</span><span title="object Nil">Nil</span><span class="delimiter">)</span>

      <a href="#40952" title="Option[org.apache.avro.generic.IndexedRecord]">value</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="comment">// delete old index (if it exists)</span>
          <a href="#43233" title="Seq[org.apache.avro.generic.IndexedRecord]">oldIndexValues</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43294">oldIndex</a> =&gt; <a href="#43231" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#33564" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#43294" title="org.apache.avro.generic.IndexedRecord">oldIndex</a>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43301">newValue</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span><span class="comment">// update index if necessary, deleting stale ones if necessary</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43302">newIndexValues</a> = <a href="#40861" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#40951" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#43301" title="org.apache.avro.generic.IndexedRecord">newValue</a>, <a href="#43231" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42632" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43232" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43303">toDelete</a> = <a href="#43233" title="Seq[org.apache.avro.generic.IndexedRecord]">oldIndexValues</a> <span title="(that: scala.collection.GenSeq[org.apache.avro.generic.IndexedRecord])Seq[org.apache.avro.generic.IndexedRecord]">diff</span> <a href="#43302" title="Seq[org.apache.avro.generic.IndexedRecord]">newIndexValues</a>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43304">toAdd</a> = <a href="#43302" title="Seq[org.apache.avro.generic.IndexedRecord]">newIndexValues</a> <span title="(that: scala.collection.GenSeq[org.apache.avro.generic.IndexedRecord])Seq[org.apache.avro.generic.IndexedRecord]">diff</span> <a href="#43233" title="Seq[org.apache.avro.generic.IndexedRecord]">oldIndexValues</a>

          <a href="#43304" title="Seq[org.apache.avro.generic.IndexedRecord]">toAdd</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43231" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#33564" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#43347" title="org.apache.avro.generic.IndexedRecord">_</a>, <span title="(x: org.apache.avro.generic.GenericData.Record)Some[org.apache.avro.generic.GenericData.Record]">Some</span><span class="delimiter">(</span><a href="#40956" title="=&gt; org.apache.avro.generic.GenericData.Record">dummyIndexValue</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#43303" title="Seq[org.apache.avro.generic.IndexedRecord]">toDelete</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43231" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#33564" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#43368" title="org.apache.avro.generic.IndexedRecord">_</a>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="comment">// put the actual key/value pair AFTER index maintainence</span>
    <a href="#9581" title="edu.berkeley.cs.scads.storage.IndexManager[BulkType]" class="keyword">super</a>.<a href="Stores.scala.html#33564" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#40951" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#40952" title="Option[org.apache.avro.generic.IndexedRecord]">value</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(that: TraversableOnce[BulkType])Unit" id="40852">++=</a><span class="delimiter">(</span><a title="TraversableOnce[BulkType]" id="43378">that</a>: <span title="TraversableOnce[BulkType]">TraversableOnce</span><span class="delimiter">[</span>BulkType<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Putting index entries&quot;)" class="string">&quot;Putting index entries&quot;</span><span class="delimiter">)</span>
    <a href="#43378" title="TraversableOnce[BulkType]">that</a>.<span title="(f: BulkType =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="BulkType" id="43479">pair</a> =&gt; <span class="delimiter">{</span>
      <a href="Interfaces.scala.html#13534" title="(key: Array[Byte], value: Array[Byte])Unit">putBulkBytes</a><span class="delimiter">(</span><a href="Interfaces.scala.html#33095" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#43479" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span>, <a href="Interfaces.scala.html#33096" title="(value: org.apache.avro.generic.IndexedRecord)Array[Byte]">valueToBytes</a><span class="delimiter">(</span><a href="#43479" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">value</span><span class="delimiter">)</span><span class="delimiter">)</span>

      <a href="#40857" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span> <a href="#43500" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="43503">ns</a>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43504">mapping</a><span class="delimiter">)</span> =&gt;
	      <a href="#40861" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#43479" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span>, <a href="#43479" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">value</span>, <a href="#43503" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42632" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43504" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span>
          .<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="#43503" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42603" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">)</span>
          .<span title="(f: Array[Byte] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43503" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="QuorumProtocol.scala.html#13544" title="(key: Array[Byte], value: Array[Byte])Unit">putBulkBytes</a><span class="delimiter">(</span><a href="#43572" title="Array[Byte]">_</a>, <a href="#40960" title="=&gt; Array[Byte]">dummyIndexValueBytes</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">}</span>

    <a href="Interfaces.scala.html#13533" title="()Unit">flushBulkBytes</a>
    <a href="#40857" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43597" title="(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.IndexNamespace">_1</span>.<a href="QuorumProtocol.scala.html#13545" title="()Unit">flushBulkBytes</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="40853">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.zookeeper.WatchedEvent =&gt; Unit" id="43600">callback</a> = <span class="delimiter">(</span>evt: <span title="org.apache.zookeeper.WatchedEvent">WatchedEvent</span><span class="delimiter">)</span> =&gt; <a href="#43602" title="org.apache.zookeeper.WatchedEvent">evt</a>.<span title="()org.apache.zookeeper.Watcher.Event.EventType">getType</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeChildrenChanged)">NodeChildrenChanged</span> =&gt; <a href="#40853" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span class="comment">/* do nothing */</span>
    <span class="delimiter">}</span>
    <a href="#40856" title="(indexNodes: Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode])Unit">updateIndexNamespaceCache</a><span class="delimiter">(</span><a href="#40845" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">indexCatalogue</a>.<span title="(f: org.apache.zookeeper.WatchedEvent =&gt; Unit)List[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">watchChildren</span><span class="delimiter">(</span><a href="#43600" title="org.apache.zookeeper.WatchedEvent =&gt; Unit">callback</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// TODO: this is hacky for now, until we figure out if we actually want to</span>
  <span class="comment">// store index namespace root nodes inside of a namespace node, or store</span>
  <span class="comment">// them globally with a prefix identifier. Since the storage handlers are</span>
  <span class="comment">// hardcoded with the assumption of a single global namespace, the actual</span>
  <span class="comment">// name of an index's namespace will be prefixed with the name of this</span>
  <span class="comment">// namespace followed by an underscroll</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(fullName: String)String" id="40854">fromGlobalName</a><span class="delimiter">(</span><a title="String" id="43722">fullName</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#43722" title="String">fullName</a>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;_&quot;)" class="string">&quot;_&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#43722" title="String">fullName</a>.<span title="(x$1: Int)java.lang.String">substring</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;_&quot;)" class="string">&quot;_&quot;</span><span class="delimiter">)</span>.<span title="()Int">length</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(indexName: String)String" id="40855">toGlobalName</a><span class="delimiter">(</span><a title="String" id="43731">indexName</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#43731" title="String">indexName</a>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;_&quot;)" class="string">&quot;_&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s_%s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a>, <a href="#43731" title="String">indexName</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(indexNodes: Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode])Unit" id="40856">updateIndexNamespaceCache</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]" id="43716">indexNodes</a>: <span title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">Seq</span><span class="delimiter">[</span>ZooKeeperProxy#ZooKeeperNode<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">// update the cache. </span>
    <span class="comment">// 1) namespaces in the cache which are not in indexCatalogue.children need to</span>
    <span class="comment">// be deleted from the cache</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[String]" id="43744">indexCatalogueChildrenSet</a> = <a href="#43716" title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">indexNodes</a>.<span title="(f: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="#43761" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">_</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[String]">toSet</span>
    <a href="#40848" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> = <a href="#40848" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a> <span title="(p: (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)) =&gt; Boolean)scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">filter</span> <a href="#43995" title="Boolean" class="delimiter">{</a> <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span><a title="String" id="43998">k</a>, _<span class="delimiter">)</span> =&gt; <a href="#43744" title="scala.collection.immutable.Set[String]">indexCatalogueChildrenSet</a>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><a href="#43998" title="String">k</a><span class="delimiter">)</span> <span class="delimiter">}</span> 

    <span class="comment">// 2) elements which are in children but not in the cache need to be added</span>
    <span class="comment">// into the cache</span>
    <a href="#40848" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> <span title="(that: scala.collection.GenTraversableOnce[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)],(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)),scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]])scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">++=</span> <a href="#43716" title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">indexNodes</a>.<span title="(p: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode =&gt; Boolean)Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">filterNot</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="44501">n</a> =&gt; <a href="#40848" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a>.<span title="(key: String)Boolean">contains</span><span class="delimiter">(</span><a href="#44501" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode =&gt; (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode],(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)),Seq[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))]])Seq[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)),Seq[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="44528">n</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="44529">ks</a> = <span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="ZooKeeperGlobalMetadata.scala.html#37950" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s/keySchema&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#40855" title="(indexName: String)String">toGlobalName</a><span class="delimiter">(</span><a href="#44528" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="44530">ns</a> = <span title="edu.berkeley.cs.scads.storage.IndexNamespace" class="keyword">new</span> <a href="#9580" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a><span class="delimiter">(</span><a href="#40855" title="(indexName: String)String">toGlobalName</a><span class="delimiter">(</span><a href="#44528" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span>, <a href="Namespace.scala.html#13586" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>, <a href="ZooKeeperGlobalMetadata.scala.html#37950" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>, <a href="#44529" title="org.apache.avro.Schema">ks</a><span class="delimiter">)</span>
      <a href="#44530" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Namespace.scala.html#13611" title="()Unit">open</a><span class="delimiter">(</span><span class="delimiter">)</span>

      <span title="(_1: String, _2: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))" class="delimiter">(</span><a href="#44528" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span>, <span title="(_1: edu.berkeley.cs.scads.storage.IndexNamespace, _2: edu.berkeley.cs.scads.storage.IndexDefinition)(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)" class="delimiter">(</span><a href="#44530" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>, classOf<span title="java.lang.Class[edu.berkeley.cs.scads.storage.IndexDefinition](classOf[edu.berkeley.cs.scads.storage.IndexDefinition])" class="delimiter">[</span>IndexDefinition<span class="delimiter">]</span>.<span title="()edu.berkeley.cs.scads.storage.IndexDefinition">newInstance</span>.<span title="(data: Array[Byte])edu.berkeley.cs.scads.storage.IndexDefinition">parse</span><span class="delimiter">(</span><a href="#44530" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="ZooKeeperGlobalMetadata.scala.html#37961" title="(key: String)Option[Array[Byte]]">getMetadata</a><span class="delimiter">(</span><a href="#40962" title="=&gt; java.lang.String">indexDefinition</a><span class="delimiter">)</span>.<span title="(default: =&gt; Array[Byte])Array[Byte]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid index definition in ns: &quot;)" class="string">&quot;Invalid index definition in ns: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="Namespace.scala.html#13587" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;, &quot;)" class="string">&quot;, &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#44528" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]" id="40857">indexCache</a> = <a href="#40848" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a>
  
  <span class="comment">/** Get a list of indexes for this namespace */</span>
  <span class="keyword">def</span> <a title="=&gt; Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]" id="40858">listIndexes</a>: <span title="Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">Map</span><span class="delimiter">[</span>String, IndexNamespace<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#40853" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#40848" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a>.<span title="(f: (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)) =&gt; (String, edu.berkeley.cs.scads.storage.IndexNamespace))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)],(String, edu.berkeley.cs.scads.storage.IndexNamespace),scala.collection.immutable.HashMap[String,edu.berkeley.cs.scads.storage.IndexNamespace]])scala.collection.immutable.HashMap[String,edu.berkeley.cs.scads.storage.IndexNamespace]">map</span> <a href="#45424" title="(String, edu.berkeley.cs.scads.storage.IndexNamespace)" class="delimiter">{</a> <span class="keyword">case</span> <span title="(String, edu.berkeley.cs.scads.storage.IndexNamespace)" class="delimiter">(</span><a title="String" id="45427">k</a>, <a title="(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)" id="45428">v</a><span class="delimiter">)</span> =&gt; <span title="(_1: String, _2: edu.berkeley.cs.scads.storage.IndexNamespace)(String, edu.berkeley.cs.scads.storage.IndexNamespace)" class="delimiter">(</span><a href="#45427" title="String">k</a>, <a href="#45428" title="(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)">v</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.IndexNamespace">_1</span><span class="delimiter">)</span> <span class="delimiter">}</span> <span title="(implicit ev: &lt;:&lt;[(String, edu.berkeley.cs.scads.storage.IndexNamespace),(String, edu.berkeley.cs.scads.storage.IndexNamespace)])scala.collection.immutable.Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">toMap</span>
  <span class="delimiter">}</span>

  <span class="comment">/** getOrCreate a secondary index over the given fields */</span>
  <span class="keyword">def</span> <a title="(fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexNamespace" id="40859">getOrCreateIndex</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.IndexType]" id="45679">fields</a>: <span title="Seq[edu.berkeley.cs.scads.storage.IndexType]">Seq</span><span class="delimiter">[</span>IndexType<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9580" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a> = <span class="delimiter">{</span>
    <span class="comment">//TODO: This encoding is certainly not robust enough to handle all possible field names</span>
    <span class="keyword">val</span> <a title="String" id="45681">idxName</a> = <a href="#45679" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="(f: edu.berkeley.cs.scads.storage.IndexType =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],String,Seq[String]])Seq[String]">map</span> <a href="#45698" title="String" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="String">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="45699">field</a><span class="delimiter">)</span> =&gt; <a href="#45699" title="String">field</a>
      <span class="keyword">case</span> <span title="java.lang.String">TokenIndex</span><span class="delimiter">(</span><a title="Seq[String]" id="45700">fields</a><span class="delimiter">)</span> =&gt; <span title="java.lang.String(&quot;t&quot;)" class="string">&quot;t&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45700" title="Seq[String]">fields</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;t&quot;)" class="string">&quot;t&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;0&quot;)" class="string">&quot;0&quot;</span><span class="delimiter">)</span>

    <a href="#40858" title="=&gt; Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">listIndexes</a>.<span title="(key: String)Option[edu.berkeley.cs.scads.storage.IndexNamespace]">get</span><span class="delimiter">(</span><a href="#45681" title="String">idxName</a><span class="delimiter">)</span> <span title="edu.berkeley.cs.scads.storage.IndexNamespace" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.IndexNamespace">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="45757">idx</a><span class="delimiter">)</span> =&gt; <a href="#45757" title="edu.berkeley.cs.scads.storage.IndexNamespace">idx</a>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.IndexNamespace">None</span> =&gt; <a href="#40860" title="(name: String, fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexNamespace">createIndex</a><span class="delimiter">(</span><a href="#45681" title="String">idxName</a>, <a href="#45679" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Create a new index over this pair type, with the given name. The fields
   * given MUST be (1) unique and (2) part of the key schema or the value
   * schema. The ordering of fields determines the layout of the index schema.
   * The actual schema for the index is constructed by taking fields and
   * concatenating (key schema - fields) in order to ensure uniqueness (that
   * each index can uniquely identity a pair object). Additionally, the name
   * must also be unique
   */</span>
  <span class="keyword">def</span> <a title="(name: String, fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexNamespace" id="40860">createIndex</a><span class="delimiter">(</span><a title="String" id="45758">name</a>: <span title="String">String</span>, <a title="Seq[edu.berkeley.cs.scads.storage.IndexType]" id="45759">fields</a>: <span title="Seq[edu.berkeley.cs.scads.storage.IndexType]">Seq</span><span class="delimiter">[</span>IndexType<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9580" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[org.apache.avro.Schema.Field]" id="45761">prefixFields</a> = <a href="#45759" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="(f: edu.berkeley.cs.scads.storage.IndexType =&gt; org.apache.avro.Schema.Field)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],org.apache.avro.Schema.Field,Seq[org.apache.avro.Schema.Field]])Seq[org.apache.avro.Schema.Field]">map</span> <a href="#45783" title="org.apache.avro.Schema.Field" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="org.apache.avro.Schema.Field">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="45784">fieldName</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a href="#45786" title="(org.apache.avro.Schema.Field, org.apache.avro.Schema.Field)" class="delimiter">(</a><a href="#45785" title="org.apache.avro.Schema.Field" id="45786">l</a>, <a href="#45785" title="org.apache.avro.Schema.Field" id="45787">r</a><span class="delimiter">)</span> = <span title="(_1: org.apache.avro.Schema.Field, _2: org.apache.avro.Schema.Field)(org.apache.avro.Schema.Field, org.apache.avro.Schema.Field)" class="delimiter">(</span><a href="Interfaces.scala.html#13627" title="=&gt; org.apache.avro.Schema">keySchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#45784" title="String">fieldName</a><span class="delimiter">)</span>, <a href="Interfaces.scala.html#13628" title="=&gt; org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#45784" title="String">fieldName</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="org.apache.avro.Schema.Field" id="45788">origField</a> =
          <span title="org.apache.avro.Schema.Field" class="keyword">if</span> <span class="delimiter">(</span><a href="#45786" title="org.apache.avro.Schema.Field">l</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45786" title="org.apache.avro.Schema.Field">l</a>
          <span class="keyword">else</span> <span title="org.apache.avro.Schema.Field" class="keyword">if</span> <span class="delimiter">(</span><a href="#45787" title="org.apache.avro.Schema.Field">r</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45787" title="org.apache.avro.Schema.Field">r</a>
          <span class="keyword">else</span> <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid field name: &quot;)" class="string">&quot;Invalid field name: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45784" title="String">fieldName</a><span class="delimiter">)</span>
        <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><a href="#45788" title="org.apache.avro.Schema.Field">origField</a>.<span title="()java.lang.String">name</span>, <a href="#45788" title="org.apache.avro.Schema.Field">origField</a>.<span title="()org.apache.avro.Schema">schema</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="org.apache.avro.Schema.Field">TokenIndex</span><span class="delimiter">(</span><a title="Seq[String]" id="45819">fieldNames</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#45819" title="Seq[String]">fieldNames</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="45836">fieldName</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.apache.avro.Schema.Field" id="45837">field</a> = <span title="(x: org.apache.avro.Schema.Field)Option[org.apache.avro.Schema.Field]">Option</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13628" title="=&gt; org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#45836" title="String">fieldName</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; org.apache.avro.Schema.Field)org.apache.avro.Schema.Field">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid field name: &quot;)" class="string">&quot;Invalid field name: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45819" title="Seq[String]">fieldNames</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#45837" title="org.apache.avro.Schema.Field">field</a>.<span title="()org.apache.avro.Schema">schema</span>.<span title="()org.apache.avro.Schema.Type">getType</span> <span title="(x$1: AnyRef)Boolean">!=</span> Schema.Type.<span title="org.apache.avro.Schema.Type(value STRING)">STRING</span><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Can't build token index over field %s of type %s.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#45819" title="Seq[String]">fieldNames</a>, <a href="#45837" title="org.apache.avro.Schema.Field">field</a>.<span title="()org.apache.avro.Schema">schema</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Token&quot;)" class="string">&quot;Token&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45819" title="Seq[String]">fieldNames</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;0&quot;)" class="string">&quot;0&quot;</span><span class="delimiter">)</span>, <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: org.apache.avro.Schema.Type)org.apache.avro.Schema">create</span><span class="delimiter">(</span>Schema.Type.<span title="org.apache.avro.Schema.Type(value STRING)">STRING</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Seq[String]" id="45762">attrFieldNames</a> = <a href="#45759" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="(pf: PartialFunction[edu.berkeley.cs.scads.storage.IndexType,String])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],String,Seq[String]])Seq[String]">collect</span> <a href="#45898" title="String" class="delimiter">{</a><span class="keyword">case</span> <span title="String">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="45899">f</a><span class="delimiter">)</span> =&gt; <a href="#45899" title="String">f</a><span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]" id="45763">suffixFields</a> = <a href="Interfaces.scala.html#13627" title="=&gt; org.apache.avro.Schema">keySchema</a>.<span title="(l: java.util.List[org.apache.avro.Schema.Field])scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">getFields</span>.<span title="(p: org.apache.avro.Schema.Field =&gt; Boolean)scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">filterNot</span><span class="delimiter">(</span><a title="org.apache.avro.Schema.Field" id="46215">f</a> =&gt; <a href="#45762" title="Seq[String]">attrFieldNames</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#46215" title="org.apache.avro.Schema.Field">f</a>.<span title="()java.lang.String">name</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: org.apache.avro.Schema.Field =&gt; org.apache.avro.Schema.Field)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[org.apache.avro.Schema.Field],org.apache.avro.Schema.Field,scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]])scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,org.apache.avro.Schema.Field,scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]]" class="delimiter">(</span><a title="org.apache.avro.Schema.Field" id="46235">f</a> =&gt; <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><a href="#46235" title="org.apache.avro.Schema.Field">f</a>.<span title="()java.lang.String">name</span>, <a href="#46235" title="org.apache.avro.Schema.Field">f</a>.<span title="()org.apache.avro.Schema">schema</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="45764">indexKeySchema</a> = <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: java.lang.String, x$4: Boolean)org.apache.avro.Schema">createRecord</span><span class="delimiter">(</span><a href="#45758" title="String">name</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;Key&quot;)" class="string">&quot;Key&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <a href="#45764" title="org.apache.avro.Schema">indexKeySchema</a>.<span title="(x$1: java.util.List[org.apache.avro.Schema.Field])Unit">setFields</span><span class="delimiter">(</span><a href="#45761" title="Seq[org.apache.avro.Schema.Field]">prefixFields</a> <span title="(b: Seq[org.apache.avro.Schema.Field])java.util.List[org.apache.avro.Schema.Field]">++</span> <a href="#45763" title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">suffixFields</a><span class="delimiter">)</span>


    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="45765">indexNs</a> = <span title="edu.berkeley.cs.scads.storage.IndexNamespace" class="keyword">new</span> <a href="#9580" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a><span class="delimiter">(</span><a href="#40855" title="(indexName: String)String">toGlobalName</a><span class="delimiter">(</span><a href="#45758" title="String">name</a><span class="delimiter">)</span>, <a href="Namespace.scala.html#13586" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>, <a href="ZooKeeperGlobalMetadata.scala.html#37950" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>, <a href="#45764" title="org.apache.avro.Schema">indexKeySchema</a><span class="delimiter">)</span>
    <span class="comment">// create the actual namespace with no partition strategy here </span>
    <a href="#45765" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>.<a href="Namespace.scala.html#13611" title="()Unit">open</a>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="45766">idxDef</a> = <a href="#49821" title="(fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexDefinition">IndexDefinition</a><span class="delimiter">(</span><a href="#45759" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.storage.IndexType])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],edu.berkeley.cs.scads.storage.IndexType,Seq[edu.berkeley.cs.scads.storage.IndexType]])Seq[edu.berkeley.cs.scads.storage.IndexType]">++</span> <a href="#45763" title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">suffixFields</a>.<span title="(f: org.apache.avro.Schema.Field =&gt; edu.berkeley.cs.scads.storage.AttributeIndex)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[org.apache.avro.Schema.Field],edu.berkeley.cs.scads.storage.AttributeIndex,scala.collection.mutable.Buffer[edu.berkeley.cs.scads.storage.AttributeIndex]])scala.collection.mutable.Buffer[edu.berkeley.cs.scads.storage.AttributeIndex]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,edu.berkeley.cs.scads.storage.AttributeIndex,scala.collection.mutable.Buffer[edu.berkeley.cs.scads.storage.AttributeIndex]]" class="delimiter">(</span><a title="org.apache.avro.Schema.Field" id="46642">f</a> =&gt; <a href="#49832" title="(fieldName: String)edu.berkeley.cs.scads.storage.AttributeIndex">AttributeIndex</a><span class="delimiter">(</span><a href="#46642" title="org.apache.avro.Schema.Field">f</a>.<span title="()java.lang.String">name</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#40848" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> <span title="(kv: (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)))scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">+=</span> <span class="delimiter">(</span><span title="(_1: String, _2: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))" class="delimiter">(</span><a href="#45758" title="String">name</a>, <span title="(_1: edu.berkeley.cs.scads.storage.IndexNamespace, _2: edu.berkeley.cs.scads.storage.IndexDefinition)(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)" class="delimiter">(</span><a href="#45765" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>, <a href="#45766" title="edu.berkeley.cs.scads.storage.IndexDefinition">idxDef</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#45765" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>.<a href="ZooKeeperGlobalMetadata.scala.html#37962" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40962" title="=&gt; java.lang.String">indexDefinition</a>, <a href="#45766" title="edu.berkeley.cs.scads.storage.IndexDefinition">idxDef</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>

    <span class="comment">// add index catalogue entry- causes other clients to be notified if they</span>
    <span class="comment">// are watching</span>
    <a href="#40845" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="46815">indexCatalogue</a>.<a href="#46815" title="Int" id="46817">getOrCreate</a><span class="delimiter">(</span><a href="#45758" title="String" id="46816">name</a><span class="delimiter">)</span>

    <span class="comment">// check if data exists already. if so, warn that indexes will NOT be</span>
    <span class="comment">// created for existing records</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="Stores.scala.html#33556" title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[BulkType]">getRange</a><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, limit=<span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span>
      <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;WARNING: Indexes will not be created for previous existing records!&quot;)" class="string">&quot;WARNING: Indexes will not be created for previous existing records!&quot;</span><span class="delimiter">)</span>

    <a href="#45765" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>  
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]" id="40861">makeIndexFor</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43179">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span>, <a title="org.apache.avro.generic.IndexedRecord" id="43180">value</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span>, <a title="org.apache.avro.Schema" id="43181">indexKeySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43182">mapping</a>: <a href="#49821" title="edu.berkeley.cs.scads.storage.IndexDefinition">IndexDefinition</a><span class="delimiter">)</span>: <span title="Seq[org.apache.avro.generic.IndexedRecord]">Seq</span><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span> = <span class="delimiter">{</span>
    @inline <span class="keyword">def</span> <a title="(fieldName: String)Any" id="46983">getValue</a><span class="delimiter">(</span><a title="String" id="46986">fieldName</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Any">Any</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.apache.avro.Schema.Field" id="46987">idx</a> = <a href="#43179" title="org.apache.avro.generic.IndexedRecord">key</a>.<span title="()org.apache.avro.Schema">getSchema</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#46986" title="String">fieldName</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#46987" title="org.apache.avro.Schema.Field">idx</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#43179" title="org.apache.avro.generic.IndexedRecord">key</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#46987" title="org.apache.avro.Schema.Field">idx</a>.<span title="()Int">pos</span><span class="delimiter">)</span>
      <span class="keyword">else</span>
        <a href="#43180" title="org.apache.avro.generic.IndexedRecord">value</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#43180" title="org.apache.avro.generic.IndexedRecord">value</a>.<span title="()org.apache.avro.Schema">getSchema</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#46986" title="String">fieldName</a><span class="delimiter">)</span>.<span title="()Int">pos</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(pos: Int, records: Seq[org.apache.avro.generic.GenericData.Record])Seq[org.apache.avro.generic.GenericData.Record]" id="46984">buildRecords</a><span class="delimiter">(</span><a title="Int" id="46992">pos</a>: <span title="Int">Int</span>, <a title="Seq[org.apache.avro.generic.GenericData.Record]" id="46993">records</a>: <span title="Seq[org.apache.avro.generic.GenericData.Record]">Seq</span><span class="delimiter">[</span>GenericData.Record<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[org.apache.avro.generic.GenericData.Record]">Seq</span><span class="delimiter">[</span>GenericData.Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#46992" title="Int">pos</a> <span title="(x: Int)Boolean">==</span> <a href="#43182" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a>.<a href="#46605" title="=&gt; Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span> <a href="#46993" title="Seq[org.apache.avro.generic.GenericData.Record]">records</a>

      <span class="keyword">val</span> <a title="Seq[Any]" id="46994">values</a> = <a href="#43182" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a>.<a href="#46605" title="(idx: Int)edu.berkeley.cs.scads.storage.IndexType">fields</a><span class="delimiter">(</span><a href="#46992" title="Int">pos</a><span class="delimiter">)</span> <span title="Seq[Any]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="List[Any]">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="47015">fieldName</a><span class="delimiter">)</span> =&gt; <a href="#46983" title="(fieldName: String)Any">getValue</a><span class="delimiter">(</span><a href="#47015" title="String">fieldName</a><span class="delimiter">)</span> <a href="#47016" title="(x: Any)List[Any]">::</a> <span title="object Nil">Nil</span>
        <span class="keyword">case</span> <span title="Seq[org.apache.avro.util.Utf8]">TokenIndex</span><span class="delimiter">(</span><a title="Seq[String]" id="47022">fieldNames</a><span class="delimiter">)</span> =&gt; <a href="#47022" title="Seq[String]">fieldNames</a>.<span title="(f: String =&gt; scala.collection.GenTraversableOnce[java.lang.String])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],java.lang.String,Seq[java.lang.String]])Seq[java.lang.String]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,java.lang.String,Seq[java.lang.String]]" class="delimiter">(</span><a href="#46983" title="(fieldName: String)Any">getValue</a><span class="delimiter">(</span><a href="#47039" title="String">_</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="org.apache.avro.util.Utf8" class="delimiter">[</span><span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">]</span>.<span title="()java.lang.String">toString</span>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(p: java.lang.String =&gt; Boolean)Seq[java.lang.String]">filterNot</span><span class="delimiter">(</span><a href="#47200" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">_</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; org.apache.avro.util.Utf8)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.lang.String],org.apache.avro.util.Utf8,Seq[org.apache.avro.util.Utf8]])Seq[org.apache.avro.util.Utf8]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.util.Utf8,Seq[org.apache.avro.util.Utf8]]" class="delimiter">(</span><span title="(x$1: java.lang.String)org.apache.avro.util.Utf8" class="keyword">new</span> <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">(</span><a href="#47307" title="java.lang.String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[org.apache.avro.util.Utf8]">distinct</span>
      <span class="delimiter">}</span>

      <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.GenericData.Record]" id="46995">newRecs</a> = <a href="#46994" title="Seq[Any]">values</a>.<span title="(f: Any =&gt; scala.collection.GenTraversableOnce[org.apache.avro.generic.GenericData.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]])Seq[org.apache.avro.generic.GenericData.Record]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]]" class="delimiter">(</span><a title="Any" id="49141">v</a> =&gt; <span class="delimiter">{</span>
        <a href="#46993" title="Seq[org.apache.avro.generic.GenericData.Record]">records</a>.<span title="(f: org.apache.avro.generic.GenericData.Record =&gt; org.apache.avro.generic.GenericData.Record)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.GenericData.Record],org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]])Seq[org.apache.avro.generic.GenericData.Record]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]]" class="delimiter">(</span><a title="org.apache.avro.generic.GenericData.Record" id="49158">r</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="49159">rec</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#43181" title="org.apache.avro.Schema">indexKeySchema</a><span class="delimiter">)</span>
          <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">0</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#46992" title="Int">pos</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="49716">i</a> =&gt; <a href="#49159" title="org.apache.avro.generic.GenericData.Record">rec</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#49716" title="Int">i</a>, <a href="#49158" title="org.apache.avro.generic.GenericData.Record">r</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#49716" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#49159" title="org.apache.avro.generic.GenericData.Record">rec</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#46992" title="Int">pos</a>, <a href="#49141" title="Any">v</a><span class="delimiter">)</span>
          <a href="#49159" title="org.apache.avro.generic.GenericData.Record">rec</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <a href="#46984" title="(pos: Int, records: Seq[org.apache.avro.generic.GenericData.Record])Seq[org.apache.avro.generic.GenericData.Record]">buildRecords</a><span class="delimiter">(</span><a href="#46992" title="Int">pos</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#46995" title="Seq[org.apache.avro.generic.GenericData.Record]">newRecs</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.GenericData.Record]" id="46985">idxRecords</a> = <a href="#46984" title="(pos: Int, records: Seq[org.apache.avro.generic.GenericData.Record])Seq[org.apache.avro.generic.GenericData.Record]">buildRecords</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#43181" title="org.apache.avro.Schema">indexKeySchema</a><span class="delimiter">)</span> <a href="#49772" title="(x: org.apache.avro.generic.GenericData.Record)List[org.apache.avro.generic.GenericData.Record]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
    <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Generated Index Entries for %s, %s: %s&quot;)" class="string">&quot;Generated Index Entries for %s, %s: %s&quot;</span>, <a href="#43179" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#43180" title="org.apache.avro.generic.IndexedRecord">value</a>, <a href="#46985" title="Seq[org.apache.avro.generic.GenericData.Record]">idxRecords</a><span class="delimiter">)</span>
    <a href="#46985" title="Seq[org.apache.avro.generic.GenericData.Record]">idxRecords</a>
  <span class="delimiter">}</span>

  <span class="comment">/** Delete a pre-existing index. The index named must already exist */</span>
  <span class="keyword">def</span> <a title="(name: String)Unit" id="40862">deleteIndex</a><span class="delimiter">(</span><a title="String" id="49782">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#40858" title="=&gt; Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">listIndexes</a>.<span title="(key: String)Option[edu.berkeley.cs.scads.storage.IndexNamespace]">get</span><span class="delimiter">(</span><a href="#49782" title="String">name</a><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.storage.IndexNamespace)edu.berkeley.cs.scads.storage.IndexNamespace">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No such index: &quot;)" class="string">&quot;No such index: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#49782" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="Namespace.scala.html#13613" title="()Unit">delete</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#40848" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> <span title="(key: String)scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">-=</span> <a href="#49782" title="String">name</a>
    <a href="#40845" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">indexCatalogue</a><span class="delimiter">(</span><a href="#49782" title="String">name</a><span class="delimiter">)</span>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>