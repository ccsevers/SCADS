<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/IndexManager.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> org.apache.avro.generic.<span class="delimiter">{</span> GenericData, IndexedRecord <span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.zookeeper.<span class="delimiter">{</span> CreateMode, WatchedEvent <span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.zookeeper.<span title="object org.apache.zookeeper.Watcher">Watcher</span>.<span title="object org.apache.zookeeper.Watcher.Event">Event</span>.EventType

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.immutable.HashMap

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.avro.marker._
<span class="keyword">import</span> org.apache.avro.util.Utf8

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.IndexManager" id="9566">IndexManager</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="40958">indexValueSchema</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="41152">schema</a> = <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: java.lang.String, x$4: Boolean)org.apache.avro.Schema">createRecord</span><span class="delimiter">(</span><span title="java.lang.String(&quot;DummyValue&quot;)" class="string">&quot;DummyValue&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <a href="#41152" title="org.apache.avro.Schema">schema</a>.<span title="(x$1: java.util.List[org.apache.avro.Schema.Field])Unit">setFields</span><span class="delimiter">(</span><span title="(elems: org.apache.avro.Schema.Field*)Seq[org.apache.avro.Schema.Field]">Seq</span><span title="(b: Seq[org.apache.avro.Schema.Field])java.util.List[org.apache.avro.Schema.Field]" class="delimiter">(</span><span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><span title="java.lang.String(&quot;b&quot;)" class="string">&quot;b&quot;</span>, <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: org.apache.avro.Schema.Type)org.apache.avro.Schema">create</span><span class="delimiter">(</span>Schema.Type.<span title="org.apache.avro.Schema.Type(value BOOLEAN)">BOOLEAN</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#41152" title="org.apache.avro.Schema">schema</a>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="40960">dummyIndexValue</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="42307">rec</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#40958" title="=&gt; org.apache.avro.Schema">indexValueSchema</a><span class="delimiter">)</span>
    <a href="#42307" title="org.apache.avro.generic.GenericData.Record">rec</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <a href="#42307" title="org.apache.avro.generic.GenericData.Record">rec</a>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" id="40962">valueReaderWriter</a> = <span title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" class="keyword">new</span> <a href="AvroSerializer.scala.html#9504" title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">AvroGenericReaderWriter</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span><span class="delimiter">(</span><span title="object None">None</span>, <a href="#40958" title="=&gt; org.apache.avro.Schema">indexValueSchema</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="Array[Byte]" id="40964">dummyIndexValueBytes</a> = <a href="#40962" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">valueReaderWriter</a>.<a href="AvroSerializer.scala.html#31483" title="(rec: org.apache.avro.generic.IndexedRecord)Array[Byte]">serialize</a><span class="delimiter">(</span><a href="#40960" title="=&gt; org.apache.avro.generic.GenericData.Record">dummyIndexValue</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.lang.String" id="40966">indexDefinition</a> = <span title="java.lang.String(&quot;indexDef&quot;)" class="string">&quot;indexDef&quot;</span>
<span class="delimiter">}</span>

<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait IndexType extends java.lang.Object with edu.berkeley.cs.avro.marker.AvroUnion" id="109348">IndexType</a> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroUnion">AvroUnion</span>
case <span class="keyword">class</span> <a href="#109350" title="class AttributeIndex extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.storage.IndexType with ScalaObject with Product with Serializable" id="49836">AttributeIndex</a><a href="#49836" title="ScalaObject" class="delimiter">(</a><a href="#49836" title="()edu.berkeley.cs.scads.storage.AttributeIndex" id="108805" class="keyword">var</a> <a title="String" id="46647">fieldName</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#109348" title="edu.berkeley.cs.scads.storage.IndexType">IndexType</a>
case <span class="keyword">class</span> <a href="#110653" title="class TokenIndex extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with edu.berkeley.cs.scads.storage.IndexType with ScalaObject with Product with Serializable" id="49832">TokenIndex</a><a href="#49832" title="ScalaObject" class="delimiter">(</a><a href="#49832" title="()edu.berkeley.cs.scads.storage.TokenIndex" id="108815" class="keyword">var</a> <a title="Seq[String]" id="49829">fieldNames</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="keyword">with</span> <a href="#109348" title="edu.berkeley.cs.scads.storage.IndexType">IndexType</a>

case <span class="keyword">class</span> <a href="#112734" title="class IndexDefinition extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="49825">IndexDefinition</a><a href="#49825" title="ScalaObject" class="delimiter">(</a><a href="#49825" title="()edu.berkeley.cs.scads.storage.IndexDefinition" id="108825" class="keyword">var</a> <a title="Seq[edu.berkeley.cs.scads.storage.IndexType]" id="46609">fields</a>: <span title="Seq[edu.berkeley.cs.scads.storage.IndexType]">Seq</span><span class="delimiter">[</span>IndexType<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>


<span class="keyword">class</span> <a title="class IndexNamespace extends java.lang.Object with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.SimpleRecordMetadata with edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata with edu.berkeley.cs.scads.storage.QuorumRangeProtocol with edu.berkeley.cs.scads.storage.DefaultKeyRangeRoutable with edu.berkeley.cs.scads.storage.RecordStore[org.apache.avro.generic.IndexedRecord] with edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord] with edu.berkeley.cs.scads.storage.NamespaceIterator[org.apache.avro.generic.IndexedRecord] with edu.berkeley.cs.scads.storage.DebuggingClient with ScalaObject" id="9578">IndexNamespace</a><a href="#9578" title="ScalaObject" class="delimiter">(</a>
    <span class="keyword">val</span> <a title="String" id="42633">name</a>: <span title="String">String</span>,
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.ScadsCluster" id="42634">cluster</a>: <a href="ScadsCluster.scala.html#9679" title="edu.berkeley.cs.scads.storage.ScadsCluster">ScadsCluster</a>,
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="42635">root</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
    <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="42636">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="Namespace.scala.html#9623" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a> 
  <span class="keyword">with</span> <a href="SimpleRecordMetadata.scala.html#9691" title="edu.berkeley.cs.scads.storage.SimpleRecordMetadata">SimpleRecordMetadata</a> 
  <span class="keyword">with</span> <a href="ZooKeeperGlobalMetadata.scala.html#9730" title="edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata">ZooKeeperGlobalMetadata</a>
  <span class="keyword">with</span> <a href="QuorumProtocol.scala.html#9646" title="edu.berkeley.cs.scads.storage.QuorumRangeProtocol">QuorumRangeProtocol</a>
  <span class="keyword">with</span> <a href="Routable.scala.html#9662" title="edu.berkeley.cs.scads.storage.DefaultKeyRangeRoutable">DefaultKeyRangeRoutable</a>
  <span class="keyword">with</span> <a href="Stores.scala.html#9721" title="edu.berkeley.cs.scads.storage.RecordStore[org.apache.avro.generic.IndexedRecord]">RecordStore</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9599" title="edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord]">Serializer</a><span class="delimiter">[</span>IndexedRecord, IndexedRecord, IndexedRecord<span class="delimiter">]</span>
  <span class="keyword">with</span> <a href="NamespaceIterator.scala.html#9629" title="edu.berkeley.cs.scads.storage.NamespaceIterator[org.apache.avro.generic.IndexedRecord]">NamespaceIterator</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span>
  <span class="keyword">with</span> <a href="Debugging.scala.html#9530" title="edu.berkeley.cs.scads.storage.DebuggingClient">DebuggingClient</a>
<span class="delimiter">{</span> 
  <span class="keyword">import</span> <a href="#9566" title="object edu.berkeley.cs.scads.storage.IndexManager">IndexManager</a>._

  <span class="keyword">val</span> <a title="java.lang.String" id="42600">valueClass</a> = classOf<span title="java.lang.Class[org.apache.avro.generic.IndexedRecord](classOf[org.apache.avro.generic.IndexedRecord])" class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span>.<span title="()java.lang.String">getName</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" id="42603">keyReaderWriter</a> = <span title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]" class="keyword">new</span> <a href="AvroSerializer.scala.html#9504" title="edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">AvroGenericReaderWriter</a><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span><span class="delimiter">(</span><span title="(x: org.apache.avro.Schema)Some[org.apache.avro.Schema]">Some</span><span class="delimiter">(</span><a href="ZooKeeperGlobalMetadata.scala.html#37960" title="=&gt; org.apache.avro.Schema">remoteKeySchema</a><span class="delimiter">)</span>, <a href="#42636" title="=&gt; org.apache.avro.Schema">keySchema</a><span class="delimiter">)</span>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord" id="42604">bytesToKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="42641">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span> = 
    <a href="#42602" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31484" title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord">deserialize</a><span class="delimiter">(</span><a href="#42641" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord" id="42605">bytesToValue</a><span class="delimiter">(</span><a title="Array[Byte]" id="42647">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span> =
    <a href="#40960" title="=&gt; org.apache.avro.generic.GenericData.Record">dummyIndexValue</a>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Array[Byte])org.apache.avro.generic.IndexedRecord" id="42606">bytesToBulk</a><span class="delimiter">(</span><a title="Array[Byte]" id="42649">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Array[Byte]" id="42650">value</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="#42602" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31484" title="(bytes: Array[Byte])org.apache.avro.generic.IndexedRecord">deserialize</a><span class="delimiter">(</span><a href="#42649" title="Array[Byte]">key</a><span class="delimiter">)</span>
  
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]" id="42607">keyToBytes</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42657">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> =
    <a href="#42602" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31483" title="(rec: org.apache.avro.generic.IndexedRecord)Array[Byte]">serialize</a><span class="delimiter">(</span><a href="#42657" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(value: org.apache.avro.generic.IndexedRecord)Array[Byte]" id="42608">valueToBytes</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42661">value</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = 
    <a href="#40964" title="=&gt; Array[Byte]">dummyIndexValueBytes</a>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(b: org.apache.avro.generic.IndexedRecord)(Array[Byte], Array[Byte])" id="42609">bulkToBytes</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42664">b</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span>: <span title="(Array[Byte], Array[Byte])" class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = 
    <span title="(_1: Array[Byte], _2: Array[Byte])(Array[Byte], Array[Byte])" class="delimiter">(</span><a href="#42607" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#42664" title="org.apache.avro.generic.IndexedRecord">b</a><span class="delimiter">)</span>, <a href="#40964" title="=&gt; Array[Byte]">dummyIndexValueBytes</a><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; org.apache.avro.generic.GenericData.Record" id="42610">newKeyInstance</a> = <a href="#42602" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31871" title="=&gt; org.apache.avro.generic.GenericData.Record">newInstance</a>

  <span class="keyword">override</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="42612">valueSchema</a> = <a href="#40958" title="=&gt; org.apache.avro.Schema">indexValueSchema</a>

  <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]" id="42613">asyncGetRecord</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42676">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span> = <a href="Stores.scala.html#33570" title="(key: org.apache.avro.generic.IndexedRecord)edu.berkeley.cs.scads.comm.ScadsFuture[Option[org.apache.avro.generic.IndexedRecord]]">asyncGet</a><span class="delimiter">(</span><a href="#42676" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]" id="42614">getRecord</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="42686">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span><span class="delimiter">)</span> = <a href="Stores.scala.html#33567" title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">get</a><span class="delimiter">(</span><a href="#42686" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(schema: org.apache.avro.Schema)org.apache.avro.generic.IndexedRecord" id="42615">newRecord</a><span class="delimiter">(</span><a title="org.apache.avro.Schema" id="42691">schema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> = <a href="#42602" title="=&gt; edu.berkeley.cs.scads.storage.AvroGenericReaderWriter[org.apache.avro.generic.IndexedRecord]">keyReaderWriter</a>.<a href="AvroSerializer.scala.html#31486" title="(schema: org.apache.avro.Schema)org.apache.avro.generic.IndexedRecord">newRecord</a><span class="delimiter">(</span><a href="#42691" title="org.apache.avro.Schema">schema</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** An IndexManager is intended to provide index maintainence for AvroPair
 * namespaces. the methods below are not intended to be thread-safe */</span>
<span class="keyword">trait</span> <a title="trait IndexManager[BulkType &lt;: edu.berkeley.cs.avro.marker.AvroPair] extends java.lang.Object with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.Protocol with edu.berkeley.cs.scads.storage.RangeKeyValueStoreLike[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType] with edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType] with edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata with edu.berkeley.cs.scads.storage.RecordStore[BulkType] with ScalaObject" id="9579">IndexManager</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: edu.berkeley.cs.avro.marker.AvroPair" id="9580">BulkType</a> &lt;: AvroPair<span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="Namespace.scala.html#9623" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a> 
	  <span class="keyword">with</span> <a href="Interfaces.scala.html#9608" title="edu.berkeley.cs.scads.storage.Protocol">Protocol</a>
	  <span class="keyword">with</span> <a href="Interfaces.scala.html#9595" title="edu.berkeley.cs.scads.storage.RangeKeyValueStoreLike[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType]">RangeKeyValueStoreLike</a><span class="delimiter">[</span>IndexedRecord, IndexedRecord, BulkType<span class="delimiter">]</span>
	  <span class="keyword">with</span> <a href="Interfaces.scala.html#9599" title="edu.berkeley.cs.scads.storage.Serializer[org.apache.avro.generic.IndexedRecord,org.apache.avro.generic.IndexedRecord,BulkType]">Serializer</a><span class="delimiter">[</span>IndexedRecord, IndexedRecord, BulkType<span class="delimiter">]</span>
	  <span class="keyword">with</span> <a href="ZooKeeperGlobalMetadata.scala.html#9730" title="edu.berkeley.cs.scads.storage.ZooKeeperGlobalMetadata">ZooKeeperGlobalMetadata</a>
    <span class="keyword">with</span> <a href="Stores.scala.html#9721" title="edu.berkeley.cs.scads.storage.RecordStore[BulkType]">RecordStore</a><span class="delimiter">[</span>BulkType<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">import</span> <a href="#9566" title="object edu.berkeley.cs.scads.storage.IndexManager">IndexManager</a>._

  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="40849">indexCatalogue</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> = _
  <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;IndexManger Constructor: %s&quot;)" class="string">&quot;IndexManger Constructor: %s&quot;</span>, <a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a><span class="delimiter">)</span>

  <span class="comment">/**
   * In memory cache of (index namespaces, seq of field values (left is from
   * key, right is from value)). is a volatile immutable hash map so we don't
   * have to do any synchronization when reading
   */</span>
  @volatile <span class="keyword">protected</span> <span class="keyword">var</span> <a title="scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]" id="40852">indexNamespacesCache</a> = <span title="scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]" class="keyword">new</span> <span title="scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">HashMap</span><span class="delimiter">[</span>String, <span class="delimiter">(</span>IndexNamespace, IndexDefinition<span class="delimiter">)</span><span class="delimiter">]</span>

  <a href="Namespace.scala.html#13611" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span><a title="Boolean" id="43055">isNew</a> =&gt;
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Opening index catalog for namespace %s&quot;)" class="string">&quot;Opening index catalog for namespace %s&quot;</span>, <a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a><span class="delimiter">)</span>
    <a href="#40849" title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)Unit">indexCatalogue</a> = <a href="ZooKeeperGlobalMetadata.scala.html#37956" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="43066">nsRoot</a>.<a href="#43066" title="Int" id="43068">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;indexes&quot;)" id="43067" class="string">&quot;indexes&quot;</a><span class="delimiter">)</span>
    <a href="#40857" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#43055" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13609" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Creating index catalog for namespace %s&quot;)" class="string">&quot;Creating index catalog for namespace %s&quot;</span>, <a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a><span class="delimiter">)</span>
    <a href="#40849" title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)Unit">indexCatalogue</a> = <a href="ZooKeeperGlobalMetadata.scala.html#37956" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><span title="java.lang.String(&quot;indexes&quot;)" class="string">&quot;indexes&quot;</span>, <span title="object Array">Array</span>.<span title="(implicit evidence$1: scala.reflect.ClassManifest[Byte])Array[Byte]">empty</span>, CreateMode.<span title="org.apache.zookeeper.CreateMode(value PERSISTENT)">PERSISTENT</span><span class="delimiter">)</span>
    <a href="#40857" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">abstract</span> <span class="keyword">def</span> <a title="(data: Seq[BulkType], replicationFactor: Int)Unit" id="40854">repartition</a><span class="delimiter">(</span><a title="Seq[BulkType]" id="43110">data</a>: <span title="Seq[BulkType]">Seq</span><span class="delimiter">[</span>BulkType<span class="delimiter">]</span>, <a title="Int" id="43111">replicationFactor</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#40861" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span> <a href="#43154" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="43157">ns</a>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43158">mapping</a><span class="delimiter">)</span> =&gt;
        <a href="#43157" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#40845" title="(data: Seq[org.apache.avro.generic.IndexedRecord], replicationFactor: Int)Unit">repartition</a><span class="delimiter">(</span><a href="#43110" title="Seq[BulkType]">data</a>.<span title="(f: BulkType =&gt; scala.collection.GenTraversableOnce[org.apache.avro.generic.IndexedRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[BulkType],org.apache.avro.generic.IndexedRecord,Seq[org.apache.avro.generic.IndexedRecord]])Seq[org.apache.avro.generic.IndexedRecord]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.generic.IndexedRecord,Seq[org.apache.avro.generic.IndexedRecord]]" class="delimiter">(</span><a title="BulkType" id="43182">d</a> =&gt; <a href="#40865" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#43182" title="BulkType">d</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span>, <a href="#43182" title="BulkType">d</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">value</span>, <a href="#43157" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42636" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43158" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#43111" title="Int">replicationFactor</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#9579" title="edu.berkeley.cs.scads.storage.IndexManager[BulkType]" class="keyword">super</a>.<a href="Stores.scala.html#40845" title="(data: Seq[BulkType], replicationFactor: Int)Unit">repartition</a><span class="delimiter">(</span><a href="#43110" title="Seq[BulkType]">data</a>, <a href="#43111" title="Int">replicationFactor</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">abstract</span> <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit" id="40855">put</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="40955">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span>, <a title="Option[org.apache.avro.generic.IndexedRecord]" id="40956">value</a>: <span title="Option[org.apache.avro.generic.IndexedRecord]">Option</span><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[org.apache.avro.generic.IndexedRecord]" id="43211">optOldValue</a> = <a href="Stores.scala.html#33567" title="(key: org.apache.avro.generic.IndexedRecord)Option[org.apache.avro.generic.IndexedRecord]">get</a><span class="delimiter">(</span><a href="#40955" title="org.apache.avro.generic.IndexedRecord">key</a><span class="delimiter">)</span>
    <a href="#40861" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span> <a href="#43232" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="43235">ns</a>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43236">mapping</a><span class="delimiter">)</span> =&gt;
      <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43237">oldIndexValues</a> = <a href="#43211" title="Option[org.apache.avro.generic.IndexedRecord]">optOldValue</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Seq[org.apache.avro.generic.IndexedRecord])Option[Seq[org.apache.avro.generic.IndexedRecord]]">map</span><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43242">oldValue</a> =&gt; <a href="#40865" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#40955" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#43242" title="org.apache.avro.generic.IndexedRecord">oldValue</a>, <a href="#43235" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42636" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43236" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; Seq[org.apache.avro.generic.IndexedRecord])Seq[org.apache.avro.generic.IndexedRecord]">getOrElse</span><span class="delimiter">(</span><span title="object Nil">Nil</span><span class="delimiter">)</span>

      <a href="#40956" title="Option[org.apache.avro.generic.IndexedRecord]">value</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="comment">// delete old index (if it exists)</span>
          <a href="#43237" title="Seq[org.apache.avro.generic.IndexedRecord]">oldIndexValues</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43298">oldIndex</a> =&gt; <a href="#43235" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#33568" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#43298" title="org.apache.avro.generic.IndexedRecord">oldIndex</a>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43305">newValue</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span><span class="comment">// update index if necessary, deleting stale ones if necessary</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43306">newIndexValues</a> = <a href="#40865" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#40955" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#43305" title="org.apache.avro.generic.IndexedRecord">newValue</a>, <a href="#43235" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42636" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43236" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43307">toDelete</a> = <a href="#43237" title="Seq[org.apache.avro.generic.IndexedRecord]">oldIndexValues</a> <span title="(that: scala.collection.GenSeq[org.apache.avro.generic.IndexedRecord])Seq[org.apache.avro.generic.IndexedRecord]">diff</span> <a href="#43306" title="Seq[org.apache.avro.generic.IndexedRecord]">newIndexValues</a>
          <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.IndexedRecord]" id="43308">toAdd</a> = <a href="#43306" title="Seq[org.apache.avro.generic.IndexedRecord]">newIndexValues</a> <span title="(that: scala.collection.GenSeq[org.apache.avro.generic.IndexedRecord])Seq[org.apache.avro.generic.IndexedRecord]">diff</span> <a href="#43237" title="Seq[org.apache.avro.generic.IndexedRecord]">oldIndexValues</a>

          <a href="#43308" title="Seq[org.apache.avro.generic.IndexedRecord]">toAdd</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43235" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#33568" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#43351" title="org.apache.avro.generic.IndexedRecord">_</a>, <span title="(x: org.apache.avro.generic.GenericData.Record)Some[org.apache.avro.generic.GenericData.Record]">Some</span><span class="delimiter">(</span><a href="#40960" title="=&gt; org.apache.avro.generic.GenericData.Record">dummyIndexValue</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#43307" title="Seq[org.apache.avro.generic.IndexedRecord]">toDelete</a>.<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43235" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Stores.scala.html#33568" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#43372" title="org.apache.avro.generic.IndexedRecord">_</a>, <span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="comment">// put the actual key/value pair AFTER index maintainence</span>
    <a href="#9579" title="edu.berkeley.cs.scads.storage.IndexManager[BulkType]" class="keyword">super</a>.<a href="Stores.scala.html#33568" title="(key: org.apache.avro.generic.IndexedRecord, value: Option[org.apache.avro.generic.IndexedRecord])Unit">put</a><span class="delimiter">(</span><a href="#40955" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#40956" title="Option[org.apache.avro.generic.IndexedRecord]">value</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(that: TraversableOnce[BulkType])Unit" id="40856">++=</a><span class="delimiter">(</span><a title="TraversableOnce[BulkType]" id="43382">that</a>: <span title="TraversableOnce[BulkType]">TraversableOnce</span><span class="delimiter">[</span>BulkType<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Putting index entries&quot;)" class="string">&quot;Putting index entries&quot;</span><span class="delimiter">)</span>
    <a href="#43382" title="TraversableOnce[BulkType]">that</a>.<span title="(f: BulkType =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="BulkType" id="43483">pair</a> =&gt; <span class="delimiter">{</span>
      <a href="Interfaces.scala.html#13538" title="(key: Array[Byte], value: Array[Byte])Unit">putBulkBytes</a><span class="delimiter">(</span><a href="Interfaces.scala.html#33099" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#43483" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span><span class="delimiter">)</span>, <a href="Interfaces.scala.html#33100" title="(value: org.apache.avro.generic.IndexedRecord)Array[Byte]">valueToBytes</a><span class="delimiter">(</span><a href="#43483" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">value</span><span class="delimiter">)</span><span class="delimiter">)</span>

      <a href="#40861" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span> <a href="#43504" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="43507">ns</a>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43508">mapping</a><span class="delimiter">)</span> =&gt;
	      <a href="#40865" title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]">makeIndexFor</a><span class="delimiter">(</span><a href="#43483" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">key</span>, <a href="#43483" title="BulkType">pair</a>.<span title="=&gt; org.apache.avro.generic.GenericRecord">value</span>, <a href="#43507" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42636" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#43508" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a><span class="delimiter">)</span>
          .<span title="(f: org.apache.avro.generic.IndexedRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.IndexedRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Array[Byte],Seq[Array[Byte]]]" class="delimiter">(</span><a href="#43507" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="#42607" title="(key: org.apache.avro.generic.IndexedRecord)Array[Byte]">keyToBytes</a><span class="delimiter">)</span>
          .<span title="(f: Array[Byte] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43507" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="QuorumProtocol.scala.html#13548" title="(key: Array[Byte], value: Array[Byte])Unit">putBulkBytes</a><span class="delimiter">(</span><a href="#43576" title="Array[Byte]">_</a>, <a href="#40964" title="=&gt; Array[Byte]">dummyIndexValueBytes</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">}</span>

    <a href="Interfaces.scala.html#13537" title="()Unit">flushBulkBytes</a>
    <a href="#40861" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexCache</a>.<span title="=&gt; Iterable[(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">values</span>.<span title="(f: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#43601" title="(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.IndexNamespace">_1</span>.<a href="QuorumProtocol.scala.html#13549" title="()Unit">flushBulkBytes</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="40857">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.zookeeper.WatchedEvent =&gt; Unit" id="43604">callback</a> = <span class="delimiter">(</span>evt: <span title="org.apache.zookeeper.WatchedEvent">WatchedEvent</span><span class="delimiter">)</span> =&gt; <a href="#43606" title="org.apache.zookeeper.WatchedEvent">evt</a>.<span title="()org.apache.zookeeper.Watcher.Event.EventType">getType</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">EventType</span>.<span title="org.apache.zookeeper.Watcher.Event.EventType(value NodeChildrenChanged)">NodeChildrenChanged</span> =&gt; <a href="#40857" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span class="comment">/* do nothing */</span>
    <span class="delimiter">}</span>
    <a href="#40860" title="(indexNodes: Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode])Unit">updateIndexNamespaceCache</a><span class="delimiter">(</span><a href="#40849" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">indexCatalogue</a>.<span title="(f: org.apache.zookeeper.WatchedEvent =&gt; Unit)List[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">watchChildren</span><span class="delimiter">(</span><a href="#43604" title="org.apache.zookeeper.WatchedEvent =&gt; Unit">callback</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// TODO: this is hacky for now, until we figure out if we actually want to</span>
  <span class="comment">// store index namespace root nodes inside of a namespace node, or store</span>
  <span class="comment">// them globally with a prefix identifier. Since the storage handlers are</span>
  <span class="comment">// hardcoded with the assumption of a single global namespace, the actual</span>
  <span class="comment">// name of an index's namespace will be prefixed with the name of this</span>
  <span class="comment">// namespace followed by an underscroll</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(fullName: String)String" id="40858">fromGlobalName</a><span class="delimiter">(</span><a title="String" id="43726">fullName</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#43726" title="String">fullName</a>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;_&quot;)" class="string">&quot;_&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#43726" title="String">fullName</a>.<span title="(x$1: Int)java.lang.String">substring</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;_&quot;)" class="string">&quot;_&quot;</span><span class="delimiter">)</span>.<span title="()Int">length</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(indexName: String)String" id="40859">toGlobalName</a><span class="delimiter">(</span><a title="String" id="43735">indexName</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#43735" title="String">indexName</a>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;_&quot;)" class="string">&quot;_&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s_%s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a>, <a href="#43735" title="String">indexName</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(indexNodes: Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode])Unit" id="40860">updateIndexNamespaceCache</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]" id="43720">indexNodes</a>: <span title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">Seq</span><span class="delimiter">[</span>ZooKeeperProxy#ZooKeeperNode<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">// update the cache. </span>
    <span class="comment">// 1) namespaces in the cache which are not in indexCatalogue.children need to</span>
    <span class="comment">// be deleted from the cache</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[String]" id="43748">indexCatalogueChildrenSet</a> = <a href="#43720" title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">indexNodes</a>.<span title="(f: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="#43765" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">_</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[String]">toSet</span>
    <a href="#40852" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> = <a href="#40852" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a> <span title="(p: (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)) =&gt; Boolean)scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">filter</span> <a href="#43999" title="Boolean" class="delimiter">{</a> <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span><a title="String" id="44002">k</a>, _<span class="delimiter">)</span> =&gt; <a href="#43748" title="scala.collection.immutable.Set[String]">indexCatalogueChildrenSet</a>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><a href="#44002" title="String">k</a><span class="delimiter">)</span> <span class="delimiter">}</span> 

    <span class="comment">// 2) elements which are in children but not in the cache need to be added</span>
    <span class="comment">// into the cache</span>
    <a href="#40852" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> <span title="(that: scala.collection.GenTraversableOnce[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)],(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)),scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]])scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">++=</span> <a href="#43720" title="Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">indexNodes</a>.<span title="(p: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode =&gt; Boolean)Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">filterNot</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="44505">n</a> =&gt; <a href="#40852" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a>.<span title="(key: String)Boolean">contains</span><span class="delimiter">(</span><a href="#44505" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode =&gt; (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode],(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)),Seq[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))]])Seq[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)),Seq[(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="44532">n</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="44533">ks</a> = <span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="ZooKeeperGlobalMetadata.scala.html#37954" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s/keySchema&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#40859" title="(indexName: String)String">toGlobalName</a><span class="delimiter">(</span><a href="#44532" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="44534">ns</a> = <span title="edu.berkeley.cs.scads.storage.IndexNamespace" class="keyword">new</span> <a href="#9578" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a><span class="delimiter">(</span><a href="#40859" title="(indexName: String)String">toGlobalName</a><span class="delimiter">(</span><a href="#44532" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span>, <a href="Namespace.scala.html#13590" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>, <a href="ZooKeeperGlobalMetadata.scala.html#37954" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>, <a href="#44533" title="org.apache.avro.Schema">ks</a><span class="delimiter">)</span>
      <a href="#44534" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="Namespace.scala.html#13615" title="()Unit">open</a><span class="delimiter">(</span><span class="delimiter">)</span>

      <span title="(_1: String, _2: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))" class="delimiter">(</span><a href="#44532" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span>, <span title="(_1: edu.berkeley.cs.scads.storage.IndexNamespace, _2: edu.berkeley.cs.scads.storage.IndexDefinition)(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)" class="delimiter">(</span><a href="#44534" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>, classOf<span title="java.lang.Class[edu.berkeley.cs.scads.storage.IndexDefinition](classOf[edu.berkeley.cs.scads.storage.IndexDefinition])" class="delimiter">[</span>IndexDefinition<span class="delimiter">]</span>.<span title="()edu.berkeley.cs.scads.storage.IndexDefinition">newInstance</span>.<span title="(data: Array[Byte])edu.berkeley.cs.scads.storage.IndexDefinition">parse</span><span class="delimiter">(</span><a href="#44534" title="edu.berkeley.cs.scads.storage.IndexNamespace">ns</a>.<a href="ZooKeeperGlobalMetadata.scala.html#37965" title="(key: String)Option[Array[Byte]]">getMetadata</a><span class="delimiter">(</span><a href="#40966" title="=&gt; java.lang.String">indexDefinition</a><span class="delimiter">)</span>.<span title="(default: =&gt; Array[Byte])Array[Byte]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid index definition in ns: &quot;)" class="string">&quot;Invalid index definition in ns: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="Namespace.scala.html#13591" title="=&gt; String">namespace</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;, &quot;)" class="string">&quot;, &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#44532" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">n</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]" id="40861">indexCache</a> = <a href="#40852" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a>
  
  <span class="comment">/** Get a list of indexes for this namespace */</span>
  <span class="keyword">def</span> <a title="=&gt; Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]" id="40862">listIndexes</a>: <span title="Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">Map</span><span class="delimiter">[</span>String, IndexNamespace<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#40857" title="()Unit">updateCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#40852" title="=&gt; scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">indexNamespacesCache</a>.<span title="(f: (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)) =&gt; (String, edu.berkeley.cs.scads.storage.IndexNamespace))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)],(String, edu.berkeley.cs.scads.storage.IndexNamespace),scala.collection.immutable.HashMap[String,edu.berkeley.cs.scads.storage.IndexNamespace]])scala.collection.immutable.HashMap[String,edu.berkeley.cs.scads.storage.IndexNamespace]">map</span> <a href="#45428" title="(String, edu.berkeley.cs.scads.storage.IndexNamespace)" class="delimiter">{</a> <span class="keyword">case</span> <span title="(String, edu.berkeley.cs.scads.storage.IndexNamespace)" class="delimiter">(</span><a title="String" id="45431">k</a>, <a title="(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)" id="45432">v</a><span class="delimiter">)</span> =&gt; <span title="(_1: String, _2: edu.berkeley.cs.scads.storage.IndexNamespace)(String, edu.berkeley.cs.scads.storage.IndexNamespace)" class="delimiter">(</span><a href="#45431" title="String">k</a>, <a href="#45432" title="(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)">v</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.IndexNamespace">_1</span><span class="delimiter">)</span> <span class="delimiter">}</span> <span title="(implicit ev: &lt;:&lt;[(String, edu.berkeley.cs.scads.storage.IndexNamespace),(String, edu.berkeley.cs.scads.storage.IndexNamespace)])scala.collection.immutable.Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">toMap</span>
  <span class="delimiter">}</span>

  <span class="comment">/** getOrCreate a secondary index over the given fields */</span>
  <span class="keyword">def</span> <a title="(fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexNamespace" id="40863">getOrCreateIndex</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.IndexType]" id="45683">fields</a>: <span title="Seq[edu.berkeley.cs.scads.storage.IndexType]">Seq</span><span class="delimiter">[</span>IndexType<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9578" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a> = <span class="delimiter">{</span>
    <span class="comment">//TODO: This encoding is certainly not robust enough to handle all possible field names</span>
    <span class="keyword">val</span> <a title="String" id="45685">idxName</a> = <a href="#45683" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="(f: edu.berkeley.cs.scads.storage.IndexType =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],String,Seq[String]])Seq[String]">map</span> <a href="#45702" title="String" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="String">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="45703">field</a><span class="delimiter">)</span> =&gt; <a href="#45703" title="String">field</a>
      <span class="keyword">case</span> <span title="java.lang.String">TokenIndex</span><span class="delimiter">(</span><a title="Seq[String]" id="45704">fields</a><span class="delimiter">)</span> =&gt; <span title="java.lang.String(&quot;t&quot;)" class="string">&quot;t&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45704" title="Seq[String]">fields</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;t&quot;)" class="string">&quot;t&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;0&quot;)" class="string">&quot;0&quot;</span><span class="delimiter">)</span>

    <a href="#40862" title="=&gt; Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">listIndexes</a>.<span title="(key: String)Option[edu.berkeley.cs.scads.storage.IndexNamespace]">get</span><span class="delimiter">(</span><a href="#45685" title="String">idxName</a><span class="delimiter">)</span> <span title="edu.berkeley.cs.scads.storage.IndexNamespace" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.IndexNamespace">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="45761">idx</a><span class="delimiter">)</span> =&gt; <a href="#45761" title="edu.berkeley.cs.scads.storage.IndexNamespace">idx</a>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.IndexNamespace">None</span> =&gt; <a href="#40864" title="(name: String, fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexNamespace">createIndex</a><span class="delimiter">(</span><a href="#45685" title="String">idxName</a>, <a href="#45683" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Create a new index over this pair type, with the given name. The fields
   * given MUST be (1) unique and (2) part of the key schema or the value
   * schema. The ordering of fields determines the layout of the index schema.
   * The actual schema for the index is constructed by taking fields and
   * concatenating (key schema - fields) in order to ensure uniqueness (that
   * each index can uniquely identity a pair object). Additionally, the name
   * must also be unique
   */</span>
  <span class="keyword">def</span> <a title="(name: String, fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexNamespace" id="40864">createIndex</a><span class="delimiter">(</span><a title="String" id="45762">name</a>: <span title="String">String</span>, <a title="Seq[edu.berkeley.cs.scads.storage.IndexType]" id="45763">fields</a>: <span title="Seq[edu.berkeley.cs.scads.storage.IndexType]">Seq</span><span class="delimiter">[</span>IndexType<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#9578" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[org.apache.avro.Schema.Field]" id="45765">prefixFields</a> = <a href="#45763" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="(f: edu.berkeley.cs.scads.storage.IndexType =&gt; org.apache.avro.Schema.Field)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],org.apache.avro.Schema.Field,Seq[org.apache.avro.Schema.Field]])Seq[org.apache.avro.Schema.Field]">map</span> <a href="#45787" title="org.apache.avro.Schema.Field" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="org.apache.avro.Schema.Field">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="45788">fieldName</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a href="#45790" title="(org.apache.avro.Schema.Field, org.apache.avro.Schema.Field)" class="delimiter">(</a><a href="#45789" title="org.apache.avro.Schema.Field" id="45790">l</a>, <a href="#45789" title="org.apache.avro.Schema.Field" id="45791">r</a><span class="delimiter">)</span> = <span title="(_1: org.apache.avro.Schema.Field, _2: org.apache.avro.Schema.Field)(org.apache.avro.Schema.Field, org.apache.avro.Schema.Field)" class="delimiter">(</span><a href="Interfaces.scala.html#13631" title="=&gt; org.apache.avro.Schema">keySchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#45788" title="String">fieldName</a><span class="delimiter">)</span>, <a href="Interfaces.scala.html#13632" title="=&gt; org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#45788" title="String">fieldName</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="org.apache.avro.Schema.Field" id="45792">origField</a> =
          <span title="org.apache.avro.Schema.Field" class="keyword">if</span> <span class="delimiter">(</span><a href="#45790" title="org.apache.avro.Schema.Field">l</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45790" title="org.apache.avro.Schema.Field">l</a>
          <span class="keyword">else</span> <span title="org.apache.avro.Schema.Field" class="keyword">if</span> <span class="delimiter">(</span><a href="#45791" title="org.apache.avro.Schema.Field">r</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#45791" title="org.apache.avro.Schema.Field">r</a>
          <span class="keyword">else</span> <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid field name: &quot;)" class="string">&quot;Invalid field name: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45788" title="String">fieldName</a><span class="delimiter">)</span>
        <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><a href="#45792" title="org.apache.avro.Schema.Field">origField</a>.<span title="()java.lang.String">name</span>, <a href="#45792" title="org.apache.avro.Schema.Field">origField</a>.<span title="()org.apache.avro.Schema">schema</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="org.apache.avro.Schema.Field">TokenIndex</span><span class="delimiter">(</span><a title="Seq[String]" id="45823">fieldNames</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#45823" title="Seq[String]">fieldNames</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="45840">fieldName</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.apache.avro.Schema.Field" id="45841">field</a> = <span title="(x: org.apache.avro.Schema.Field)Option[org.apache.avro.Schema.Field]">Option</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13632" title="=&gt; org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#45840" title="String">fieldName</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; org.apache.avro.Schema.Field)org.apache.avro.Schema.Field">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid field name: &quot;)" class="string">&quot;Invalid field name: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45823" title="Seq[String]">fieldNames</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#45841" title="org.apache.avro.Schema.Field">field</a>.<span title="()org.apache.avro.Schema">schema</span>.<span title="()org.apache.avro.Schema.Type">getType</span> <span title="(x$1: AnyRef)Boolean">!=</span> Schema.Type.<span title="org.apache.avro.Schema.Type(value STRING)">STRING</span><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalArgumentException" class="keyword">new</span> <span title="java.lang.IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Can't build token index over field %s of type %s.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#45823" title="Seq[String]">fieldNames</a>, <a href="#45841" title="org.apache.avro.Schema.Field">field</a>.<span title="()org.apache.avro.Schema">schema</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Token&quot;)" class="string">&quot;Token&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#45823" title="Seq[String]">fieldNames</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;0&quot;)" class="string">&quot;0&quot;</span><span class="delimiter">)</span>, <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: org.apache.avro.Schema.Type)org.apache.avro.Schema">create</span><span class="delimiter">(</span>Schema.Type.<span title="org.apache.avro.Schema.Type(value STRING)">STRING</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Seq[String]" id="45766">attrFieldNames</a> = <a href="#45763" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="(pf: PartialFunction[edu.berkeley.cs.scads.storage.IndexType,String])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],String,Seq[String]])Seq[String]">collect</span> <a href="#45902" title="String" class="delimiter">{</a><span class="keyword">case</span> <span title="String">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="45903">f</a><span class="delimiter">)</span> =&gt; <a href="#45903" title="String">f</a><span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]" id="45767">suffixFields</a> = <a href="Interfaces.scala.html#13631" title="=&gt; org.apache.avro.Schema">keySchema</a>.<span title="(l: java.util.List[org.apache.avro.Schema.Field])scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">getFields</span>.<span title="(p: org.apache.avro.Schema.Field =&gt; Boolean)scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">filterNot</span><span class="delimiter">(</span><a title="org.apache.avro.Schema.Field" id="46219">f</a> =&gt; <a href="#45766" title="Seq[String]">attrFieldNames</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#46219" title="org.apache.avro.Schema.Field">f</a>.<span title="()java.lang.String">name</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: org.apache.avro.Schema.Field =&gt; org.apache.avro.Schema.Field)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[org.apache.avro.Schema.Field],org.apache.avro.Schema.Field,scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]])scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,org.apache.avro.Schema.Field,scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]]" class="delimiter">(</span><a title="org.apache.avro.Schema.Field" id="46239">f</a> =&gt; <span title="org.apache.avro.Schema.Field" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Field">Field</span><span class="delimiter">(</span><a href="#46239" title="org.apache.avro.Schema.Field">f</a>.<span title="()java.lang.String">name</span>, <a href="#46239" title="org.apache.avro.Schema.Field">f</a>.<span title="()org.apache.avro.Schema">schema</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="45768">indexKeySchema</a> = <span title="object org.apache.avro.Schema">Schema</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: java.lang.String, x$4: Boolean)org.apache.avro.Schema">createRecord</span><span class="delimiter">(</span><a href="#45762" title="String">name</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;Key&quot;)" class="string">&quot;Key&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <a href="#45768" title="org.apache.avro.Schema">indexKeySchema</a>.<span title="(x$1: java.util.List[org.apache.avro.Schema.Field])Unit">setFields</span><span class="delimiter">(</span><a href="#45765" title="Seq[org.apache.avro.Schema.Field]">prefixFields</a> <span title="(b: Seq[org.apache.avro.Schema.Field])java.util.List[org.apache.avro.Schema.Field]">++</span> <a href="#45767" title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">suffixFields</a><span class="delimiter">)</span>


    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.IndexNamespace" id="45769">indexNs</a> = <span title="edu.berkeley.cs.scads.storage.IndexNamespace" class="keyword">new</span> <a href="#9578" title="edu.berkeley.cs.scads.storage.IndexNamespace">IndexNamespace</a><span class="delimiter">(</span><a href="#40859" title="(indexName: String)String">toGlobalName</a><span class="delimiter">(</span><a href="#45762" title="String">name</a><span class="delimiter">)</span>, <a href="Namespace.scala.html#13590" title="=&gt; edu.berkeley.cs.scads.storage.ScadsCluster">cluster</a>, <a href="ZooKeeperGlobalMetadata.scala.html#37954" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>, <a href="#45768" title="org.apache.avro.Schema">indexKeySchema</a><span class="delimiter">)</span>
    <span class="comment">// create the actual namespace with no partition strategy here </span>
    <a href="#45769" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>.<a href="Namespace.scala.html#13615" title="()Unit">open</a>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="45770">idxDef</a> = <a href="#49825" title="(fields: Seq[edu.berkeley.cs.scads.storage.IndexType])edu.berkeley.cs.scads.storage.IndexDefinition">IndexDefinition</a><span class="delimiter">(</span><a href="#45763" title="Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.storage.IndexType])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.IndexType],edu.berkeley.cs.scads.storage.IndexType,Seq[edu.berkeley.cs.scads.storage.IndexType]])Seq[edu.berkeley.cs.scads.storage.IndexType]">++</span> <a href="#45767" title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">suffixFields</a>.<span title="(f: org.apache.avro.Schema.Field =&gt; edu.berkeley.cs.scads.storage.AttributeIndex)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[org.apache.avro.Schema.Field],edu.berkeley.cs.scads.storage.AttributeIndex,scala.collection.mutable.Buffer[edu.berkeley.cs.scads.storage.AttributeIndex]])scala.collection.mutable.Buffer[edu.berkeley.cs.scads.storage.AttributeIndex]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,edu.berkeley.cs.scads.storage.AttributeIndex,scala.collection.mutable.Buffer[edu.berkeley.cs.scads.storage.AttributeIndex]]" class="delimiter">(</span><a title="org.apache.avro.Schema.Field" id="46646">f</a> =&gt; <a href="#49836" title="(fieldName: String)edu.berkeley.cs.scads.storage.AttributeIndex">AttributeIndex</a><span class="delimiter">(</span><a href="#46646" title="org.apache.avro.Schema.Field">f</a>.<span title="()java.lang.String">name</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#40852" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> <span title="(kv: (String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)))scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">+=</span> <span class="delimiter">(</span><span title="(_1: String, _2: (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))(String, (edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition))" class="delimiter">(</span><a href="#45762" title="String">name</a>, <span title="(_1: edu.berkeley.cs.scads.storage.IndexNamespace, _2: edu.berkeley.cs.scads.storage.IndexDefinition)(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)" class="delimiter">(</span><a href="#45769" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>, <a href="#45770" title="edu.berkeley.cs.scads.storage.IndexDefinition">idxDef</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#45769" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>.<a href="ZooKeeperGlobalMetadata.scala.html#37966" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40966" title="=&gt; java.lang.String">indexDefinition</a>, <a href="#45770" title="edu.berkeley.cs.scads.storage.IndexDefinition">idxDef</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>

    <span class="comment">// add index catalogue entry- causes other clients to be notified if they</span>
    <span class="comment">// are watching</span>
    <a href="#40849" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="46819">indexCatalogue</a>.<a href="#46819" title="Int" id="46821">getOrCreate</a><span class="delimiter">(</span><a href="#45762" title="String" id="46820">name</a><span class="delimiter">)</span>

    <span class="comment">// check if data exists already. if so, warn that indexes will NOT be</span>
    <span class="comment">// created for existing records</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="Stores.scala.html#33560" title="(start: Option[org.apache.avro.generic.IndexedRecord], end: Option[org.apache.avro.generic.IndexedRecord], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[BulkType]">getRange</a><span class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span>, limit=<span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span>
      <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;WARNING: Indexes will not be created for previous existing records!&quot;)" class="string">&quot;WARNING: Indexes will not be created for previous existing records!&quot;</span><span class="delimiter">)</span>

    <a href="#45769" title="edu.berkeley.cs.scads.storage.IndexNamespace">indexNs</a>  
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: org.apache.avro.generic.IndexedRecord, value: org.apache.avro.generic.IndexedRecord, indexKeySchema: org.apache.avro.Schema, mapping: edu.berkeley.cs.scads.storage.IndexDefinition)Seq[org.apache.avro.generic.IndexedRecord]" id="40865">makeIndexFor</a><span class="delimiter">(</span><a title="org.apache.avro.generic.IndexedRecord" id="43183">key</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span>, <a title="org.apache.avro.generic.IndexedRecord" id="43184">value</a>: <span title="org.apache.avro.generic.IndexedRecord">IndexedRecord</span>, <a title="org.apache.avro.Schema" id="43185">indexKeySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="edu.berkeley.cs.scads.storage.IndexDefinition" id="43186">mapping</a>: <a href="#49825" title="edu.berkeley.cs.scads.storage.IndexDefinition">IndexDefinition</a><span class="delimiter">)</span>: <span title="Seq[org.apache.avro.generic.IndexedRecord]">Seq</span><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span> = <span class="delimiter">{</span>
    @inline <span class="keyword">def</span> <a title="(fieldName: String)Any" id="46987">getValue</a><span class="delimiter">(</span><a title="String" id="46990">fieldName</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Any">Any</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="org.apache.avro.Schema.Field" id="46991">idx</a> = <a href="#43183" title="org.apache.avro.generic.IndexedRecord">key</a>.<span title="()org.apache.avro.Schema">getSchema</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#46990" title="String">fieldName</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#46991" title="org.apache.avro.Schema.Field">idx</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#43183" title="org.apache.avro.generic.IndexedRecord">key</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#46991" title="org.apache.avro.Schema.Field">idx</a>.<span title="()Int">pos</span><span class="delimiter">)</span>
      <span class="keyword">else</span>
        <a href="#43184" title="org.apache.avro.generic.IndexedRecord">value</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#43184" title="org.apache.avro.generic.IndexedRecord">value</a>.<span title="()org.apache.avro.Schema">getSchema</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#46990" title="String">fieldName</a><span class="delimiter">)</span>.<span title="()Int">pos</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(pos: Int, records: Seq[org.apache.avro.generic.GenericData.Record])Seq[org.apache.avro.generic.GenericData.Record]" id="46988">buildRecords</a><span class="delimiter">(</span><a title="Int" id="46996">pos</a>: <span title="Int">Int</span>, <a title="Seq[org.apache.avro.generic.GenericData.Record]" id="46997">records</a>: <span title="Seq[org.apache.avro.generic.GenericData.Record]">Seq</span><span class="delimiter">[</span>GenericData.Record<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[org.apache.avro.generic.GenericData.Record]">Seq</span><span class="delimiter">[</span>GenericData.Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#46996" title="Int">pos</a> <span title="(x: Int)Boolean">==</span> <a href="#43186" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a>.<a href="#46609" title="=&gt; Seq[edu.berkeley.cs.scads.storage.IndexType]">fields</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span> <a href="#46997" title="Seq[org.apache.avro.generic.GenericData.Record]">records</a>

      <span class="keyword">val</span> <a title="Seq[Any]" id="46998">values</a> = <a href="#43186" title="edu.berkeley.cs.scads.storage.IndexDefinition">mapping</a>.<a href="#46609" title="(idx: Int)edu.berkeley.cs.scads.storage.IndexType">fields</a><span class="delimiter">(</span><a href="#46996" title="Int">pos</a><span class="delimiter">)</span> <span title="Seq[Any]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="List[Any]">AttributeIndex</span><span class="delimiter">(</span><a title="String" id="47019">fieldName</a><span class="delimiter">)</span> =&gt; <a href="#46987" title="(fieldName: String)Any">getValue</a><span class="delimiter">(</span><a href="#47019" title="String">fieldName</a><span class="delimiter">)</span> <a href="#47020" title="(x: Any)List[Any]">::</a> <span title="object Nil">Nil</span>
        <span class="keyword">case</span> <span title="Seq[org.apache.avro.util.Utf8]">TokenIndex</span><span class="delimiter">(</span><a title="Seq[String]" id="47026">fieldNames</a><span class="delimiter">)</span> =&gt; <a href="#47026" title="Seq[String]">fieldNames</a>.<span title="(f: String =&gt; scala.collection.GenTraversableOnce[java.lang.String])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],java.lang.String,Seq[java.lang.String]])Seq[java.lang.String]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,java.lang.String,Seq[java.lang.String]]" class="delimiter">(</span><a href="#46987" title="(fieldName: String)Any">getValue</a><span class="delimiter">(</span><a href="#47043" title="String">_</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="org.apache.avro.util.Utf8" class="delimiter">[</span><span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">]</span>.<span title="()java.lang.String">toString</span>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(p: java.lang.String =&gt; Boolean)Seq[java.lang.String]">filterNot</span><span class="delimiter">(</span><a href="#47204" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">_</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; org.apache.avro.util.Utf8)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.lang.String],org.apache.avro.util.Utf8,Seq[org.apache.avro.util.Utf8]])Seq[org.apache.avro.util.Utf8]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.util.Utf8,Seq[org.apache.avro.util.Utf8]]" class="delimiter">(</span><span title="(x$1: java.lang.String)org.apache.avro.util.Utf8" class="keyword">new</span> <span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">(</span><a href="#47311" title="java.lang.String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[org.apache.avro.util.Utf8]">distinct</span>
      <span class="delimiter">}</span>

      <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.GenericData.Record]" id="46999">newRecs</a> = <a href="#46998" title="Seq[Any]">values</a>.<span title="(f: Any =&gt; scala.collection.GenTraversableOnce[org.apache.avro.generic.GenericData.Record])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Any],org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]])Seq[org.apache.avro.generic.GenericData.Record]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]]" class="delimiter">(</span><a title="Any" id="49145">v</a> =&gt; <span class="delimiter">{</span>
        <a href="#46997" title="Seq[org.apache.avro.generic.GenericData.Record]">records</a>.<span title="(f: org.apache.avro.generic.GenericData.Record =&gt; org.apache.avro.generic.GenericData.Record)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[org.apache.avro.generic.GenericData.Record],org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]])Seq[org.apache.avro.generic.GenericData.Record]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.generic.GenericData.Record,Seq[org.apache.avro.generic.GenericData.Record]]" class="delimiter">(</span><a title="org.apache.avro.generic.GenericData.Record" id="49162">r</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="49163">rec</a> = <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#43185" title="org.apache.avro.Schema">indexKeySchema</a><span class="delimiter">)</span>
          <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">0</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#46996" title="Int">pos</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="49720">i</a> =&gt; <a href="#49163" title="org.apache.avro.generic.GenericData.Record">rec</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#49720" title="Int">i</a>, <a href="#49162" title="org.apache.avro.generic.GenericData.Record">r</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#49720" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#49163" title="org.apache.avro.generic.GenericData.Record">rec</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#46996" title="Int">pos</a>, <a href="#49145" title="Any">v</a><span class="delimiter">)</span>
          <a href="#49163" title="org.apache.avro.generic.GenericData.Record">rec</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <a href="#46988" title="(pos: Int, records: Seq[org.apache.avro.generic.GenericData.Record])Seq[org.apache.avro.generic.GenericData.Record]">buildRecords</a><span class="delimiter">(</span><a href="#46996" title="Int">pos</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#46999" title="Seq[org.apache.avro.generic.GenericData.Record]">newRecs</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="Seq[org.apache.avro.generic.GenericData.Record]" id="46989">idxRecords</a> = <a href="#46988" title="(pos: Int, records: Seq[org.apache.avro.generic.GenericData.Record])Seq[org.apache.avro.generic.GenericData.Record]">buildRecords</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="org.apache.avro.generic.GenericData.Record" class="keyword">new</span> <span title="object org.apache.avro.generic.GenericData">GenericData</span>.<span title="org.apache.avro.generic.GenericData.Record">Record</span><span class="delimiter">(</span><a href="#43185" title="org.apache.avro.Schema">indexKeySchema</a><span class="delimiter">)</span> <a href="#49776" title="(x: org.apache.avro.generic.GenericData.Record)List[org.apache.avro.generic.GenericData.Record]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
    <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Generated Index Entries for %s, %s: %s&quot;)" class="string">&quot;Generated Index Entries for %s, %s: %s&quot;</span>, <a href="#43183" title="org.apache.avro.generic.IndexedRecord">key</a>, <a href="#43184" title="org.apache.avro.generic.IndexedRecord">value</a>, <a href="#46989" title="Seq[org.apache.avro.generic.GenericData.Record]">idxRecords</a><span class="delimiter">)</span>
    <a href="#46989" title="Seq[org.apache.avro.generic.GenericData.Record]">idxRecords</a>
  <span class="delimiter">}</span>

  <span class="comment">/** Delete a pre-existing index. The index named must already exist */</span>
  <span class="keyword">def</span> <a title="(name: String)Unit" id="40866">deleteIndex</a><span class="delimiter">(</span><a title="String" id="49786">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#40862" title="=&gt; Map[String,edu.berkeley.cs.scads.storage.IndexNamespace]">listIndexes</a>.<span title="(key: String)Option[edu.berkeley.cs.scads.storage.IndexNamespace]">get</span><span class="delimiter">(</span><a href="#49786" title="String">name</a><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.storage.IndexNamespace)edu.berkeley.cs.scads.storage.IndexNamespace">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No such index: &quot;)" class="string">&quot;No such index: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#49786" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="Namespace.scala.html#13617" title="()Unit">delete</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#40852" title="(x$1: scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)])Unit">indexNamespacesCache</a> <span title="(key: String)scala.collection.immutable.HashMap[String,(edu.berkeley.cs.scads.storage.IndexNamespace, edu.berkeley.cs.scads.storage.IndexDefinition)]">-=</span> <a href="#49786" title="String">name</a>
    <a href="#40849" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">indexCatalogue</a><span class="delimiter">(</span><a href="#49786" title="String">name</a><span class="delimiter">)</span>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>