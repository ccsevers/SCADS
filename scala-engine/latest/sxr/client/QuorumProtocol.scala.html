<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/QuorumProtocol.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.avro.marker._
<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> org.apache.avro.Schema 
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> actors.Actor
<span class="keyword">import</span> collection.mutable.<span class="delimiter">{</span> Seq =&gt; MutSeq, _ <span class="delimiter">}</span>
<span class="keyword">import</span> concurrent.ManagedBlocker

<span class="keyword">import</span> java.util.concurrent._

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.QuorumProtocol" id="9892">QuorumProtocol</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="44735">ZK_QUORUM_CONFIG</a> = <span title="java.lang.String(&quot;quorumProtConfig&quot;)" class="string">&quot;quorumProtConfig&quot;</span>

  <span class="keyword">val</span> <a title="Int" id="44737">BulkPutBufSize</a> = <span title="Int(1024)" class="int">1024</span>
  <span class="keyword">val</span> <a title="Int" id="44739">BulkPutMaxOutstanding</a> = <span title="Int(64)" class="int">64</span>
  <span class="keyword">val</span> <a title="Int" id="44741">BulkPutTimeout</a> = <span class="int">60</span> <span title="Int(60000)">*</span> <span class="int">1000</span>

  <span class="comment">//TODO: there is probably a better way to do this...</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]" id="44743">awaitingReadRepair</a> = <span title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]" class="keyword">new</span> <span title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">ArrayBlockingQueue</span><span class="delimiter">[</span>RequestHandler<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.lang.Thread" id="44745">readRepairThread</a> = <a href="#54657" title="java.lang.Thread" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Thread" id="54657">Thread</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Read Repair&quot;)" class="string">&quot;Read Repair&quot;</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="55034">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	<a href="#44743" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<span title="()edu.berkeley.cs.scads.storage.RequestHandler">take</span>.<a href="#55103" title="()Unit">finish</a><a href="#55102" title="()Unit" class="delimiter">(</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <a href="#44745" title="=&gt; java.lang.Thread">readRepairThread</a>.<span title="(x$1: Boolean)Unit">setDaemon</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <a href="#44745" title="=&gt; java.lang.Thread">readRepairThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="44747">flushReadRepair</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#44743" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<span title="()Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><a href="#55111" title="()Unit" class="delimiter">(</a><span title="Long(100L)" class="int">100</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class TimeoutCounter extends java.lang.Object with ScalaObject" id="9894">TimeoutCounter</a><a href="#9894" title="ScalaObject" class="delimiter">(</a><a title="Long" id="32602">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="Long" id="32599">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Long" id="32601">remaining</a>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Long" id="55120">remainingTime</a> = <a href="#32602" title="Long">timeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#32599" title="=&gt; Long">startTime</a><span class="delimiter">)</span>
    <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#55120" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span title="Long(1L)" class="int">1</span>
    <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#55120" title="Long">remainingTime</a> <span title="(x: Long)Boolean">&gt;</span> <a href="#32602" title="Long">timeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
      <a href="#32602" title="Long">timeout</a>
    <span class="keyword">else</span>
      <a href="#55120" title="Long">remainingTime</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait RequestHandler extends java.lang.Object" id="9895">RequestHandler</a> <span title="java.lang.Object" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="()Unit" id="55103">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.Protocol with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.KeyRoutable with edu.berkeley.cs.scads.storage.RecordMetadata with edu.berkeley.cs.scads.storage.GlobalMetadata with edu.berkeley.cs.scads.storage.ParFuture with ScalaObject" id="9896">QuorumProtocol</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9858" title="edu.berkeley.cs.scads.storage.Protocol">Protocol</a>
  <span class="keyword">with</span> <a href="Namespace.scala.html#9873" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9860" title="edu.berkeley.cs.scads.storage.KeyRoutable">KeyRoutable</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9868" title="edu.berkeley.cs.scads.storage.RecordMetadata">RecordMetadata</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9866" title="edu.berkeley.cs.scads.storage.GlobalMetadata">GlobalMetadata</a>
  <span class="keyword">with</span> <a href="../util/ParFuture.scala.html#10128" title="edu.berkeley.cs.scads.storage.ParFuture">ParFuture</a> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="#9892" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>._

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Option[Array[Byte]]" id="27858">getBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="44767">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#55310" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int)" class="delimiter">(</a><a href="#55309" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55310">ftchs</a>, <a href="#55309" title="Int" id="55311">quorum</a><span class="delimiter">)</span> = <a href="#27860" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int) @unchecked" class="delimiter">(</span><a href="#44767" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#27861" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><a href="#55425" title="QuorumProtocol.this.GetHandler" class="keyword">new</a> <a href="#27888" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#44767" title="Array[Byte]">key</a>, <a href="#55310" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">ftchs</a><span class="delimiter">)</span>, <a href="#55311" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Issues a get request but does not block the current thread waiting for
   * responses. A ScadsFuture is returned which can be used to block for
   * responses. Calls to get/apply on the ScadsFuture are idempotent - the
   * first call will cause the current thread to wait for GetResponse
   * messages, and vote on the winning record, handling the read repair in the
   * process. Subsequent calls (regardless of thread) then wait for the first
   * call to finish and piggyback off the result.
   *
   * NOTE: There *IS* a subtle difference between calling get(key) and calling
   * asyncGet(key).get(), in the case where the servers do not respond to the
   * get request. In the former case, an exception is thrown after a default
   * (for now hardcoded) timeout value expires. In the latter case, the thread
   * is blocked forever. Use with timeouts is recommended.
   *
   * NOTE: The returned future does not implement cancel
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]" id="27859">asyncGetBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="44733">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]">ScadsFuture</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#55438" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int)" class="delimiter">(</a><a href="#55437" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55438">ftchs</a>, <a href="#55437" title="Int" id="55439">quorum</a><span class="delimiter">)</span> = <a href="#27860" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int) @unchecked" class="delimiter">(</span><a href="#44733" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#55450" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" id="55450">ComputationFuture</a><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Option[Array[Byte]]" id="55474">compute</a><span class="delimiter">(</span><a title="Long" id="55476">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="55477">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#27861" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><span title="QuorumProtocol.this.GetHandler" class="keyword">new</span> <a href="#27888" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#44733" title="Array[Byte]">key</a>, <a href="#55438" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">ftchs</a>, <a href="#55477" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#55476" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#55439" title="Int">quorum</a><span class="delimiter">)</span>
          .<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="55475">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int)" id="27860">makeGetRequests</a><span class="delimiter">(</span><a title="Array[Byte]" id="55312">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#55316" title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</a><a href="#55315" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="55316">servers</a>, <a href="#55315" title="Int" id="55317">quorum</a><span class="delimiter">)</span> = <a href="#27885" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#55312" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.GetRequest" id="55318">getRequest</a> = <a href="../Messages.scala.html#22594" title="(key: Array[Byte])edu.berkeley.cs.scads.storage.GetRequest">GetRequest</a><span class="delimiter">(</span><a href="#55312" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="comment">// (ftch, quorum)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], _2: Int)(Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]], Int)" class="delimiter">(</span><a href="#55316" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a href="#55352" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#55318" title="edu.berkeley.cs.scads.storage.GetRequest">getRequest</a><span class="delimiter">)</span>, <a href="#55317" title="Int">quorum</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]" id="27861">finishGetHandler</a><span class="delimiter">(</span><a title="QuorumProtocol.this.GetHandler" id="55386">handler</a>: <a href="#27888" title="QuorumProtocol.this.GetHandler">GetHandler</a>, <a title="Int" id="55387">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Option[Array[Byte]]]">Option</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="55605">record</a> = <a href="#55386" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#55417" title="(quorum: Int)Option[Array[Byte]]">vote</a><span class="delimiter">(</span><a href="#55387" title="Int">quorum</a><span class="delimiter">)</span>
    <span title="Option[Option[Array[Byte]]]" class="keyword">if</span> <span class="delimiter">(</span><a href="#55386" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#55414" title="=&gt; Boolean">failed</a><span class="delimiter">)</span> <span title="object None">None</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#9892" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>.<a href="#44743" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<span title="(x$1: edu.berkeley.cs.scads.storage.RequestHandler)Boolean">offer</span><span class="delimiter">(</span><a href="#55386" title="QuorumProtocol.this.GetHandler">handler</a><span class="delimiter">)</span>
      <span title="(x: Option[Array[Byte]])Some[Option[Array[Byte]]]">Some</span><span class="delimiter">(</span><a href="#55605" title="Option[Array[Byte]]">record</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#27938" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.ScadsFuture[Unit]" id="27862">asyncPutBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="55628">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="55629">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Unit]">ScadsFuture</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#55632" title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</a><a href="#55631" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="55632">servers</a>, <a href="#55631" title="Int" id="55633">quorum</a><span class="delimiter">)</span> = <a href="#27883" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#55628" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PutRequest" id="55634">putRequest</a> = <a href="../Messages.scala.html#22714" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PutRequest">PutRequest</a><span class="delimiter">(</span><a href="#55628" title="Array[Byte]">key</a>, <a href="#55629" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#27935" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55635">responses</a> = <a href="Interfaces.scala.html#27929" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.storage.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#55628" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a href="#55679" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#55634" title="edu.berkeley.cs.scads.storage.PutRequest">putRequest</a><span class="delimiter">)</span>

    <a href="#55701" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" id="55701">ComputationFuture</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Unit" id="55705">compute</a><span class="delimiter">(</span><a title="Long" id="55707">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="55708">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <a href="#55635" title="(futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])edu.berkeley.cs.scads.comm.FutureCollection[edu.berkeley.cs.scads.storage.StorageMessage]">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#55633" title="Int">quorum</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="keyword">def</span> <a title="=&gt; Nothing" id="55706">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])Unit" id="27863">putBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="55749">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="55750">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#55753" title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</a><a href="#55752" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="55753">servers</a>, <a href="#55752" title="Int" id="55754">quorum</a><span class="delimiter">)</span> = <a href="#27883" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#55749" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PutRequest" id="55755">putRequest</a> = <a href="../Messages.scala.html#22714" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PutRequest">PutRequest</a><span class="delimiter">(</span><a href="#55749" title="Array[Byte]">key</a>, <a href="#55750" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#27935" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55756">responses</a> = <a href="Interfaces.scala.html#27929" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.storage.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#55749" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a href="#55792" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#55755" title="edu.berkeley.cs.scads.storage.PutRequest">putRequest</a><span class="delimiter">)</span>
    <a href="#55756" title="(futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])edu.berkeley.cs.scads.comm.FutureCollection[edu.berkeley.cs.scads.storage.StorageMessage]">responses</a>.<span title="(count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#55754" title="Int">quorum</a>, <span title="Long(5000L)" class="int">5000</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/* Buffers KV tuples until the average buffer size for all the servers is
   * greater than BufSize. Then sends the request to the servers, while
   * repeating the buffering process for the next set of KV tuples. When the
   * tuple stream runs out, or when the outstanding future collection grows
   * above a certain threshold, blocks on each of the returned
   * future collections.
   *
   * Note: the current implementation is Write All not quorum based.
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Array[Byte])Unit" id="27864">putBulkBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="47305">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Array[Byte]" id="47306">value</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#55845" title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</a><a href="#55844" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="55845">servers</a>, <a href="#55844" title="Int" id="55846">quorum</a><span class="delimiter">)</span> = <a href="#27883" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#47305" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PutRequest" id="55847">putRequest</a> = <a href="../Messages.scala.html#22714" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PutRequest">PutRequest</a><span class="delimiter">(</span><a href="#47305" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="Interfaces.scala.html#27935" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">(</span><a href="#47306" title="Array[Byte]">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="55877">server</a> &lt;- <a href="#55845" title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; Unit)Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]" id="55878">buf</a> = <a href="#27866" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.storage.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]]">serverBuffers</a>.<span title="(key: edu.berkeley.cs.scads.storage.PartitionService, op: =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest])scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">getOrElseUpdate</span><span class="delimiter">(</span><a href="#55877" title="edu.berkeley.cs.scads.storage.PartitionService">server</a>, <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">(</span><a href="#44737" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#55878" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">buf</a> <span title="(elem: edu.berkeley.cs.scads.storage.PutRequest)buf.type">+=</span> <a href="#55847" title="edu.berkeley.cs.scads.storage.PutRequest">putRequest</a>

      <span class="comment">/* send the buffer when its full */</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#55878" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">buf</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#44737" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span>
        <a href="#27873" title="(server: edu.berkeley.cs.scads.storage.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#55877" title="edu.berkeley.cs.scads.storage.PartitionService">server</a>, <a href="#55878" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">buf</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#27871" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#44739" title="=&gt; Int">BulkPutMaxOutstanding</a><span class="delimiter">)</span>
      <a href="#27874" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="27865">flushBulkBytes</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">/* flush any remaining send buffers */</span>
    <a href="#27866" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.storage.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]]">serverBuffers</a>.<span title="(f: (edu.berkeley.cs.scads.storage.PartitionService, scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]) =&gt; Unit)Unit">foreach</span> <a href="#55942" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="55945">server</a>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]" id="55946">buffer</a><span class="delimiter">)</span> =&gt; <a href="#27873" title="(server: edu.berkeley.cs.scads.storage.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#55945" title="edu.berkeley.cs.scads.storage.PartitionService">server</a>, <a href="#55946" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">buffer</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/* block until we receive responses for all sent requests */</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#27871" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <a href="#27874" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.storage.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]]" id="27866">serverBuffers</a> = <span title="()scala.collection.mutable.HashMap[edu.berkeley.cs.scads.storage.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.storage.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]]">HashMap</span><span class="delimiter">[</span>PartitionService, ArrayBuffer<span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">protected</span> case <span class="keyword">class</span> <a title="class OutstandingPut extends java.lang.Object with ScalaObject with Product with Serializable" id="55983">OutstandingPut</a><a href="#55983" title="ScalaObject" class="delimiter">(</a><a title="Long" id="56107">timestamp</a>: <span title="Long">Long</span>, <a title="edu.berkeley.cs.scads.storage.PartitionService" id="56108">server</a>: <a href="../Messages.scala.html#9559" title="edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]" id="56109">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]" id="56110">future</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">MessageFuture</span><span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span>, <a title="Int" id="56111">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" id="27871">outstandingPuts</a> = <span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" class="keyword">new</span> collection.mutable.<span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">Queue</span><span class="delimiter">[</span>OutstandingPut<span class="delimiter">]</span>

  <span class="comment">/* send the request and append it to the list of outstanding requests */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(server: edu.berkeley.cs.scads.storage.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest], tries: Int)Unit" id="27873">sendBuffer</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="55904">server</a>: <a href="../Messages.scala.html#9559" title="edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]" id="55905">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="Int" id="55908">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#55908" title="Int">tries</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(5)" class="int">5</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Retries exceeded for server %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#55904" title="edu.berkeley.cs.scads.storage.PartitionService">server</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#27871" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a> <span title="(elems: QuorumProtocol.this.OutstandingPut*)Unit">enqueue</span> <a href="#55983" title="(timestamp: Long, server: edu.berkeley.cs.scads.storage.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest], future: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], tries: Int)QuorumProtocol.this.OutstandingPut">OutstandingPut</a><span class="delimiter">(</span>
      <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>,
      <a href="#55904" title="edu.berkeley.cs.scads.storage.PartitionService">server</a>,
      <a href="#55905" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">sendBuffer</a>,
      <a href="#55904" title="edu.berkeley.cs.scads.storage.PartitionService">server</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="../Messages.scala.html#22901" title="(records: Seq[edu.berkeley.cs.scads.storage.PutRequest])edu.berkeley.cs.scads.storage.BulkPutRequest">BulkPutRequest</a><span class="delimiter">(</span><a href="#55905" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">sendBuffer</a><span class="delimiter">)</span>,
      <a href="#55908" title="Int">tries</a><span class="delimiter">)</span>
    <a href="#27866" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.storage.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]]">serverBuffers</a> <span title="(key: edu.berkeley.cs.scads.storage.PartitionService)QuorumProtocol.this.serverBuffers.type">-=</span> <a href="#55904" title="edu.berkeley.cs.scads.storage.PartitionService">server</a>
  <span class="delimiter">}</span>

  <span class="comment">/* wait up to timeout for the oldest request to return if it doesn't resend it*/</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="27874">processNextOutstandingRequest</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="QuorumProtocol.this.OutstandingPut" id="56134">oldestRequest</a> = <a href="#27871" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="()QuorumProtocol.this.OutstandingPut">dequeue</span>
    <span class="keyword">val</span> <a title="Long" id="56135">remainingTime</a> = <a href="#44741" title="=&gt; Int">BulkPutTimeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56107" title="=&gt; Long">timestamp</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Long" id="56136">timeout</a> =
      <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#56135" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Long(1L)" class="int">1</span>
      <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#56135" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#44741" title="=&gt; Int">BulkPutTimeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
        <a href="#44741" title="=&gt; Long">BulkPutTimeout</a>
      <span class="keyword">else</span>
        <a href="#56135" title="Long">remainingTime</a>

    <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56110" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.storage.StorageMessage]">get</span><span class="delimiter">(</span><a href="#56136" title="Long">timeout</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span>BulkPutResponse<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.StorageMessage" id="56157">otherMsg</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;)" class="string">&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;</span>, <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56108" title="=&gt; edu.berkeley.cs.scads.storage.PartitionService">server</a>, <a href="#56157" title="edu.berkeley.cs.scads.storage.StorageMessage">otherMsg</a><span class="delimiter">)</span>
        <a href="#27873" title="(server: edu.berkeley.cs.scads.storage.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56108" title="=&gt; edu.berkeley.cs.scads.storage.PartitionService">server</a>, <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56109" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">sendBuffer</a>, <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56111" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bulkput to %s timed out. Resending.&quot;)" class="string">&quot;Bulkput to %s timed out. Resending.&quot;</span>, <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56108" title="=&gt; edu.berkeley.cs.scads.storage.PartitionService">server</a><span class="delimiter">)</span>
        <a href="#27873" title="(server: edu.berkeley.cs.scads.storage.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56108" title="=&gt; edu.berkeley.cs.scads.storage.PartitionService">server</a>, <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56109" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.PutRequest]">sendBuffer</a>, <a href="#56134" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#56111" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>


  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="27876">readQuorum</a>: <span title="Double">Double</span> = <span title="Double(0.0010)" class="double">0.001</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="27879">writeQuorum</a>: <span title="Double">Double</span> = <span title="Double(1.0)" class="double">1.0</span>

  <span class="comment">/** Initialization callbacks */</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="27881">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig" id="56175">config</a> = <span title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig" class="keyword">new</span> <a href="../Messages.scala.html#9714" title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig">QuorumProtocolConfig</a><span class="delimiter">(</span><a href="#27876" title="=&gt; Double">readQuorum</a>, <a href="#27879" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#27947" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#44735" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#56175" title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27918" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="#27881" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27920" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span> <a title="Boolean" id="56185">isNew</a> =&gt;
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#56185" title="Boolean">isNew</a><span class="delimiter">)</span> <a href="#27881" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="Interfaces.scala.html#27946" title="(key: String)Option[Array[Byte]]">getMetadata</a><span class="delimiter">(</span><a href="#44735" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="56187">bytes</a><span class="delimiter">)</span> =&gt; 
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig" id="56188">config</a> = classOf<span title="java.lang.Class[edu.berkeley.cs.scads.storage.QuorumProtocolConfig](classOf[edu.berkeley.cs.scads.storage.QuorumProtocolConfig])" class="delimiter">[</span>QuorumProtocolConfig<span class="delimiter">]</span>.<span title="()edu.berkeley.cs.scads.storage.QuorumProtocolConfig">newInstance</span>
        <a href="#56188" title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig">config</a>.<span title="(data: Array[Byte])config.type">parse</span><span class="delimiter">(</span><a href="#56187" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
        <a href="#27876" title="(x$1: Double)Unit">readQuorum</a>  = <a href="#56188" title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig">config</a>.<a href="../Messages.scala.html#25899" title="=&gt; Double">readQuorum</a>
        <a href="#27879" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#56188" title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig">config</a>.<a href="../Messages.scala.html#25902" title="=&gt; Double">writeQuorum</a>
      <span class="keyword">case</span> <span title="Nothing">None</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;could not find quorum protocol&quot;)" class="string">&quot;could not find quorum protocol&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#56185" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27921" title="(f: =&gt; Unit)Unit">onClose</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">// no-op </span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#27922" title="(f: =&gt; Unit)Unit">onDelete</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">//deleteMetadata(ZK_QUORUM_CONFIG)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** NOT thread-safe to set */</span>
  <span class="keyword">def</span> <a title="(readQuorum: Double, writeQuorum: Double)Unit" id="27882">setReadWriteQuorum</a><span class="delimiter">(</span><a title="Double" id="56201">readQuorum</a>: <span title="Double">Double</span>, <a title="Double" id="56202">writeQuorum</a>: <span title="Double">Double</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#56201" title="Double">readQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#56201" title="Double">readQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;)" class="string">&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56201" title="Double">readQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#56202" title="Double">writeQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#56202" title="Double">writeQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;)" class="string">&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56202" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#56202" title="Double">writeQuorum</a> <span title="(x: Double)Double">+</span> <a href="#56201" title="Double">readQuorum</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read + write quorum has to be &gt;= 1 but was &quot;)" class="string">&quot;Read + write quorum has to be &gt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#56201" title="Double">readQuorum</a> <span title="(x: Double)Double">+</span> <a href="#56202" title="Double">writeQuorum</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#9896" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#27876" title="(x$1: Double)Unit">readQuorum</a> = <a href="#56201" title="Double">readQuorum</a>
    <a href="#9896" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#27879" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#56202" title="Double">writeQuorum</a>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig" id="56204">config</a> = <span title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig" class="keyword">new</span> <a href="../Messages.scala.html#9714" title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig">QuorumProtocolConfig</a><span class="delimiter">(</span><a href="#56201" title="Double">readQuorum</a>, <a href="#56202" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#27947" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#44735" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#56204" title="edu.berkeley.cs.scads.storage.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" id="27883">writeQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="55636">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="56243">servers</a> = <a href="Interfaces.scala.html#27929" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.storage.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#55636" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.storage.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</span><a href="#56243" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>, scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#56243" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="=&gt; Int">size</span> <span title="(x: Double)Double">*</span> <a href="#27879" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(nbServers: Int)Int" id="27884">readQuorum</a><span class="delimiter">(</span><a title="Int" id="56180">nbServers</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#56180" title="Int">nbServers</a> <span title="(x: Double)Double">*</span> <a href="#27876" title="=&gt; Double">readQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" id="27885">readQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="55319">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="56262">servers</a> = <a href="Interfaces.scala.html#27929" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.storage.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#55319" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.storage.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</span><a href="#56262" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>, <a href="#27884" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#56262" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns all value versions for a given key. Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(key: Array[Byte])Seq[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]])]" id="27886">getAllVersions</a><span class="delimiter">(</span><a title="Array[Byte]" id="56273">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#56276" title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)" class="delimiter">(</a><a href="#56275" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="56276">partitions</a>, <a href="#56275" title="Int" id="56277">quorum</a><span class="delimiter">)</span> = <a href="#27885" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.storage.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#56273" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.GetRequest" id="56278">getRequest</a> = <a href="../Messages.scala.html#22594" title="(key: Array[Byte])edu.berkeley.cs.scads.storage.GetRequest">GetRequest</a><span class="delimiter">(</span><a href="#56273" title="Array[Byte]">key</a><span class="delimiter">)</span>

    <a href="../util/ParFuture.scala.html#27956" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.storage.StorageMessage, edu.berkeley.cs.scads.storage.PartitionService),(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]])])Seq[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]])]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#56276" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="56312">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], _2: edu.berkeley.cs.scads.storage.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)" class="delimiter">(</span><a href="#56312" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#56278" title="edu.berkeley.cs.scads.storage.GetRequest">getRequest</a>, <a href="#56312" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#56357" title="(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]])" class="delimiter">{</a> 
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]])" class="delimiter">(</span>GetResponse<span class="delimiter">(</span><a title="Option[Array[Byte]]" id="56360">optV</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.storage.PartitionService" id="56361">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.storage.PartitionService, _2: Option[Array[Byte]])(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]])" class="delimiter">(</span><a href="#56361" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a>, <a href="#56360" title="Option[Array[Byte]]">optV</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#27938" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class GetHandler extends java.lang.Object with edu.berkeley.cs.scads.storage.RequestHandler with ScalaObject" id="27888">GetHandler</a><a href="#27888" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Array[Byte]" id="55421">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55422">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="55425">timeout</a>: <span title="Long">Long</span> = <span title="Long(5000L)" class="int">5000</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9895" title="edu.berkeley.cs.scads.storage.RequestHandler">RequestHandler</a><span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55399">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>
    <a href="#55422" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#56486" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])Unit">forward</span><span class="delimiter">(</span><a href="#55399" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55401">losers</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">ArrayBuffer</span><span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55403">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">ArrayBuffer</span><span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="55406">winnerValue</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="55409">ctr</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="55411">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9894" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#55425" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="55414">failed</a> = <span title="Boolean(false)" class="keyword">false</span>

    <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" id="55416">repairList</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#55401" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">losers</a>

    <span class="keyword">def</span> <a title="(quorum: Int)Option[Array[Byte]]" id="55417">vote</a><span class="delimiter">(</span><a title="Int" id="55606">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#55606" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="56623">_</a> =&gt; <a href="#55419" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#55406" title="=&gt; Option[Array[Byte]]">winnerValue</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="55418">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="56764">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#55422" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#55409" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#55419" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="55419">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#55409" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]" id="56766">future</a> = <a href="#55399" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">poll</span><span class="delimiter">(</span><a href="#55411" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#32601" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#56766" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#55414" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <a href="#56766" title="()edu.berkeley.cs.scads.storage.StorageMessage">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">GetResponse</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="56780">v</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Int" id="56781">cmp</a> = <a href="#27890" title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int">optCompareMetadata</a><span class="delimiter">(</span><a href="#55406" title="=&gt; Option[Array[Byte]]">winnerValue</a>, <a href="#56780" title="Option[Array[Byte]]">v</a><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#56781" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#56766" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])Unit">foreach</span><span class="delimiter">(</span><a href="#55401" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">losers</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])GetHandler.this.losers.type">+=</span> <a href="#56793" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#56781" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#55401" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">losers</a> <span title="(xs: scala.collection.TraversableOnce[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])GetHandler.this.losers.type">++=</span> <a href="#55403" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">winners</a>
            <a href="#55403" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">winners</a>.<span title="()Unit">clear</span>
            <a href="#56766" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])Unit">foreach</span><span class="delimiter">(</span><a href="#55403" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])GetHandler.this.winners.type">+=</span> <a href="#56818" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">_</a><span class="delimiter">)</span>
            <a href="#55406" title="(x$1: Option[Array[Byte]])Unit">winnerValue</a> = <a href="#56780" title="Option[Array[Byte]]">v</a>
          <span class="delimiter">}</span><span class="keyword">else</span><span class="delimiter">{</span>
            <a href="#56766" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])Unit">foreach</span><span class="delimiter">(</span><a href="#55403" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])GetHandler.this.winners.type">+=</span> <a href="#56832" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Nothing" id="56836">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown message &quot;)" class="string">&quot;Unknown message &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56836" title="edu.berkeley.cs.scads.storage.StorageMessage">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="55420">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#55418" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]" id="56911">server</a> &lt;- <a href="#55416" title="(f: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])Unit">repairList</a><span class="delimiter">)</span>
        <a href="#56911" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">server</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="../Messages.scala.html#22714" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PutRequest">PutRequest</a><span class="delimiter">(</span><a href="#55421" title="=&gt; Array[Byte]">key</a>, <a href="#55406" title="=&gt; Option[Array[Byte]]">winnerValue</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int" id="27890">optCompareMetadata</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="56782">optLhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="56783">optRhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#56782" title="Option[Array[Byte]]">optLhs</a>, <a href="#56783" title="Option[Array[Byte]]">optRhs</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="object None">None</span>, Some<span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span>Some<span class="delimiter">(</span>_<span class="delimiter">)</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="56931">lhs</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="56933">rhs</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="Interfaces.scala.html#27936" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#56931" title="Array[Byte]">lhs</a>, <a href="#56933" title="Array[Byte]">rhs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumRangeProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.RangeProtocol with edu.berkeley.cs.scads.storage.QuorumProtocol with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9897">QuorumRangeProtocol</a> 
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9859" title="edu.berkeley.cs.scads.storage.RangeProtocol">RangeProtocol</a>
  <span class="keyword">with</span> <a href="#9896" title="edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9864" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>

  <span class="comment">/** assumes start/end key prepopulated w/ sentinel min/max values */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])" id="41747">startGetRangeRequest</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="56944">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="56945">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="56946">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="56947">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="56948">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])" class="delimiter">(</span>Seq<span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, Seq<span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="56950">partitions</a> = <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" class="keyword">if</span> <span class="delimiter">(</span><a href="#56948" title="Boolean">ascending</a><span class="delimiter">)</span> <a href="Interfaces.scala.html#27961" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#56944" title="Option[Array[Byte]]">startKey</a>, <a href="#56945" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span> <span class="keyword">else</span> <a href="Interfaces.scala.html#27961" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#56944" title="Option[Array[Byte]]">startKey</a>, <a href="#56945" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">reverse</span>

    <a href="#56946" title="Option[Int]">limit</a> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])">Some</span><span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <span class="comment">/* if limit is defined, then only send a req to the first server. return a pointer to the tail of the first partition */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="56962">range</a> = <a href="#56950" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.GetRangeRequest" id="56963">rangeRequest</a> = <span title="edu.berkeley.cs.scads.storage.GetRangeRequest" class="keyword">new</span> <a href="../Messages.scala.html#9598" title="edu.berkeley.cs.scads.storage.GetRangeRequest">GetRangeRequest</a><span class="delimiter">(</span><a href="#56962" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31375" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#56962" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31377" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#56946" title="Option[Int]">limit</a>, <a href="#56947" title="Option[Int]">offset</a>, <a href="#56948" title="Boolean">ascending</a><span class="delimiter">)</span>
        <span title="(_1: Seq[edu.berkeley.cs.scads.storage.RangeDesc], _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])" class="delimiter">(</span><a href="#56950" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>, <span title="(elems: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]*)Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">Seq</span><span class="delimiter">(</span><a href="#56962" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31379" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a href="#57004" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#56963" title="edu.berkeley.cs.scads.storage.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])">None</span> =&gt; <span class="comment">/* if no limit is defined, then we'll have to send a request to every server. the pointer should be nil since no servers left */</span>
        <span title="(_1: scala.collection.immutable.Nil.type, _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])" class="delimiter">(</span><span title="object Nil">Nil</span>, <a href="#56950" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]])Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="57050">range</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.GetRangeRequest" id="57051">rangeRequest</a> = <span title="edu.berkeley.cs.scads.storage.GetRangeRequest" class="keyword">new</span> <a href="../Messages.scala.html#9598" title="edu.berkeley.cs.scads.storage.GetRangeRequest">GetRangeRequest</a><span class="delimiter">(</span><a href="#57050" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31375" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#57050" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31377" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#56946" title="Option[Int]">limit</a>, <a href="#56947" title="Option[Int]">offset</a>, <a href="#56948" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#57050" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31379" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a href="#57068" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#57051" title="edu.berkeley.cs.scads.storage.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">toSeq</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Finish a get range request. Ftchs are the GetRangeRequests which have
   * already been sent out, and partitions are the available servers to pull
   * data from 
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]" id="41748">finishGetRangeRequest</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="57115">partitions</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">Seq</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, <a title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" id="57116">ftchs</a>: <span title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="57117">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="57118">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="57119">ascending</a>: <span title="Boolean">Boolean</span>, <a title="Option[Long]" id="57120">timeout</a>: <span title="Option[Long]">Option</span><span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>

    <span class="keyword">def</span> <a title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])QuorumRangeProtocol.this.RangeHandle" id="57122">newRangeHandle</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="57128">ftchs</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =
      <a href="#57120" title="Option[Long]">timeout</a>.<span title="(f: Long =&gt; QuorumRangeProtocol.this.RangeHandle)Option[QuorumRangeProtocol.this.RangeHandle]">map</span><span class="delimiter">(</span><a title="Long" id="57133">t</a> =&gt; <span title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</span> <a href="#41752" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#57128" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">ftchs</a>, <a href="#57133" title="Long">t</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; QuorumRangeProtocol.this.RangeHandle)QuorumRangeProtocol.this.RangeHandle">getOrElse</span><span class="delimiter">(</span><a href="#57170" title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</a> <a href="#41752" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#57128" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">ftchs</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]" id="57123">handlers</a> = <a href="#57116" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">ftchs</a>.<span title="(f: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]] =&gt; QuorumRangeProtocol.this.RangeHandle)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]],QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]])Seq[QuorumRangeProtocol.this.RangeHandle]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]]" class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="57195">x</a> =&gt; <a href="#57122" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#57195" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">x</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">toBuffer</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" id="57124">result</a> = <span title="()scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">ArrayBuffer</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Long" id="57125">openRec</a> = <a href="#57117" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Long)Option[Long]">map</span><span class="delimiter">(</span><a href="#57239" title="Int">_</a>.<span title="=&gt; Long">toLong</span><span class="delimiter">)</span>.<span title="(default: =&gt; Long)Long">getOrElse</span><span class="delimiter">(</span>java.lang.Long.<span title="Long(9223372036854775807L)">MAX_VALUE</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="57126">servers</a> = <a href="#57115" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>
    <span class="keyword">var</span> <a title="Int" id="57127">cur</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="QuorumRangeProtocol.this.RangeHandle" id="57291">handler</a> &lt;- <a href="#57123" title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Unit)Unit">handlers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#57125" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" id="57296">records</a> = <a href="#57291" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#57162" title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">vote</a><span class="delimiter">(</span><a href="#27884" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#57291" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#57167" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">futures</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#57291" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#57157" title="=&gt; Boolean">failed</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;)" class="string">&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;</span><span class="delimiter">)</span>
        <span class="comment">//if we do not get enough records, we request more, before we process the current batch</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#57296" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a>.<span title="=&gt; Int">length</span> <span title="(x: Long)Boolean">&lt;=</span> <a href="#57125" title="Long">openRec</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#57126" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="57318">range</a> = <a href="#57126" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
          <span class="keyword">val</span> <a title="Option[Int]" id="57319">newLimit</a> = <span title="Option[Int]" class="keyword">if</span><span class="delimiter">(</span><a href="#57117" title="Option[Int]">limit</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#57125" title="Long">openRec</a>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span> <span class="keyword">else</span> <span title="object None">None</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.GetRangeRequest" id="57320">rangeRequest</a> = <span title="edu.berkeley.cs.scads.storage.GetRangeRequest" class="keyword">new</span> <a href="../Messages.scala.html#9598" title="edu.berkeley.cs.scads.storage.GetRangeRequest">GetRangeRequest</a><span class="delimiter">(</span><a href="#57318" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31375" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#57318" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31377" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#57319" title="Option[Int]">newLimit</a>, <a href="#57118" title="Option[Int]">offset</a>, <a href="#57119" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#57123" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(elems: QuorumRangeProtocol.this.RangeHandle*)Unit">append</span><span class="delimiter">(</span><a href="#57122" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#57318" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31379" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a href="#57353" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#57320" title="edu.berkeley.cs.scads.storage.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#57126" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a> = <a href="#57126" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>
        <span class="delimiter">}</span>
        <a href="#57124" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>.<span title="(xs: scala.collection.TraversableOnce[(Array[Byte], Array[Byte])])Unit">appendAll</span><span class="delimiter">(</span><a href="#57296" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.storage.Record =&gt; scala.collection.GenTraversableOnce[(Array[Byte], Array[Byte])])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record],(Array[Byte], Array[Byte]),scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]])scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer.Coll,(Array[Byte], Array[Byte]),scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.Record" id="57392">rec</a> =&gt;
          <span title="List[(Array[Byte], Array[Byte])]" class="keyword">if</span> <span class="delimiter">(</span><a href="#57125" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#57125" title="Long">openRec</a> <span title="(x: Int)Long">-=</span> <span title="Int(1)" class="int">1</span>
            <a href="#57392" title="edu.berkeley.cs.scads.storage.Record">rec</a>.<a href="../Messages.scala.html#22205" title="=&gt; Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; (Array[Byte], Array[Byte]))Option[(Array[Byte], Array[Byte])]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="57405">v</a> =&gt; <span title="(_1: Array[Byte], _2: Array[Byte])(Array[Byte], Array[Byte])" class="delimiter">(</span><a href="#57392" title="edu.berkeley.cs.scads.storage.Record">rec</a>.<a href="../Messages.scala.html#22202" title="=&gt; Array[Byte]">key</a>, <a href="Interfaces.scala.html#27938" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">(</span><a href="#57405" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[(Array[Byte], Array[Byte])]">toList</span>
          <span class="delimiter">}</span> <span class="keyword">else</span>
            <span title="object Nil">Nil</span>
          <span class="delimiter">)</span>
        <span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#57123" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Boolean)Unit">foreach</span><span class="delimiter">(</span><a href="#9892" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>.<a href="#44743" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<a href="#57784" title="(x$1: edu.berkeley.cs.scads.storage.RequestHandler)Boolean">offer</a><span class="delimiter">)</span>
    <a href="#57124" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[(Array[Byte], Array[Byte])]" id="41749">getKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="57788">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Array[Byte]]" id="57789">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="57790">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="57791">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Boolean" id="57792">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#57795" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])" class="delimiter">(</a><a href="#57794" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="57795">ptr</a>, <a href="#57794" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" id="57796">ftchs</a><span class="delimiter">)</span> = <a href="#41747" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]) @unchecked" class="delimiter">(</span><a href="#57788" title="Option[Array[Byte]]">start</a>, <a href="#57789" title="Option[Array[Byte]]">end</a>, <a href="#57790" title="Option[Int]">limit</a>, <a href="#57791" title="Option[Int]">offset</a>, <a href="#57792" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#41748" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#57795" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#57796" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">ftchs</a>, <a href="#57790" title="Option[Int]">limit</a>, <a href="#57791" title="Option[Int]">offset</a>, <a href="#57792" title="Boolean">ascending</a>, <span title="object None">None</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]" id="41750">asyncGetKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="57807">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="57808">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="57809">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="57810">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="57811">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#57814" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])" class="delimiter">(</a><a href="#57813" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="57814">ptr</a>, <a href="#57813" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" id="57815">ftchs</a><span class="delimiter">)</span> = <a href="#41747" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]) @unchecked" class="delimiter">(</span><a href="#57807" title="Option[Array[Byte]]">start</a>, <a href="#57808" title="Option[Array[Byte]]">end</a>, <a href="#57809" title="Option[Int]">limit</a>, <a href="#57810" title="Option[Int]">offset</a>, <a href="#57811" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#57826" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" id="57826">ComputationFuture</a><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Seq[(Array[Byte], Array[Byte])]" id="57830">compute</a><span class="delimiter">(</span><a title="Long" id="57832">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="57833">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#41748" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#57814" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#57815" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">ftchs</a>, <a href="#57809" title="Option[Int]">limit</a>, <a href="#57810" title="Option[Int]">offset</a>, <a href="#57811" title="Boolean">ascending</a>, <span title="(x: Long)Some[Long]">Some</span><span class="delimiter">(</span><a href="#57833" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#57832" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="57831">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Tests the range for conflicts and marks all violations for future resolution.
   * This class is optimized for none/few violations.
   */</span>
  <span class="keyword">class</span> <a title="class RangeHandle extends java.lang.Object with edu.berkeley.cs.scads.storage.RequestHandler with ScalaObject" id="41752">RangeHandle</a><a href="#41752" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="57167">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="57170">timeout</a>: <span title="Long">Long</span> = <span class="int">10</span> <span title="Long(10000L)">*</span> <span class="int">1000</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9895" title="edu.berkeley.cs.scads.storage.RequestHandler">RequestHandler</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="57141">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9894" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#57170" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="57143">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>
    <a href="#57167" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#57957" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])Unit">forward</span><span class="delimiter">(</span><a href="#57143" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// TODO: hashing on byte array like this is no good. this should be redone</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])]" id="57145">losers</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, List<span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" id="57147">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>

    <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]" id="57150">baseServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">RemoteServiceProxy</span><span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span> <span class="comment">//The whole comparison is based on the first response</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" id="57152">winnerExceptions</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, RemoteServiceProxy<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>

    <span class="keyword">val</span> <a title="Long" id="57154">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">var</span> <a title="Boolean" id="57157">failed</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="57160">ctr</a> = <span title="Int(0)" class="int">0</span>

    <span class="keyword">def</span> <a title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" id="57162">vote</a><span class="delimiter">(</span><a title="Int" id="57297">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#57297" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="58059">_</a> =&gt; <a href="#57164" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#57147" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">winners</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="57163">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="58167">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#57167" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#57160" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#57164" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="57164">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#57160" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
       <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]" id="58169">future</a> = <a href="#57143" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">poll</span><span class="delimiter">(</span><a href="#57141" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#32601" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58169" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#57157" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.Record]" id="58170">result</a> = <a href="#58169" title="()edu.berkeley.cs.scads.storage.StorageMessage">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Seq[edu.berkeley.cs.scads.storage.Record]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Seq[edu.berkeley.cs.scads.storage.Record]">GetRangeResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.Record]" id="58184">v</a><span class="delimiter">)</span> =&gt; <a href="#58184" title="Seq[edu.berkeley.cs.scads.storage.Record]">v</a>
        <span class="keyword">case</span> <a title="Nothing" id="58185">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message (was expecting GetRangeResponse): &quot;)" class="string">&quot;Unexpected Message (was expecting GetRangeResponse): &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#58185" title="edu.berkeley.cs.scads.storage.StorageMessage">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#57147" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">winners</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">//println(&quot;first result &quot; + result.map(a =&gt; QuorumProtocol.this.deserializeKey(a.key)))</span>
        <a href="#57147" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">winners</a>.<span title="(n: Int, seq: Traversable[edu.berkeley.cs.scads.storage.Record])Unit">insertAll</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <a href="#58170" title="Seq[edu.berkeley.cs.scads.storage.Record]">result</a><span class="delimiter">)</span>
        <a href="#57150" title="(x$1: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])Unit">baseServer</a> = <a href="#58169" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">get</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#57165" title="(newRecords: Seq[edu.berkeley.cs.scads.storage.Record], newServer: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])Unit">merge</a><span class="delimiter">(</span><a href="#58170" title="Seq[edu.berkeley.cs.scads.storage.Record]">result</a>, <a href="#58169" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">get</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(newRecords: Seq[edu.berkeley.cs.scads.storage.Record], newServer: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])Unit" id="57165">merge</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.Record]" id="58212">newRecords</a>: <span title="Seq[edu.berkeley.cs.scads.storage.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]" id="58213">newServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">RemoteServiceProxy</span><span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.Record]" id="58215">recordPtr</a> = <a href="#58212" title="Seq[edu.berkeley.cs.scads.storage.Record]">newRecords</a>
      <span class="keyword">var</span> <a title="Int" id="58216">i</a> = <span title="Int(0)" class="int">0</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#58216" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#57147" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">winners</a>.<span title="=&gt; Int">length</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#58217" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="Array[Byte]" id="58227">winnerKey</a> = <a href="#57147" title="(idx: Int)edu.berkeley.cs.scads.storage.Record">winners</a><span class="delimiter">(</span><a href="#58216" title="Int">i</a><span class="delimiter">)</span>.<a href="../Messages.scala.html#22202" title="=&gt; Array[Byte]">key</a>
        <span class="keyword">val</span> <a title="Array[Byte]" id="58228">newKey</a> = <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.Record">head</span>.<a href="../Messages.scala.html#22202" title="=&gt; Array[Byte]">key</a>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#57147" title="(idx: Int)edu.berkeley.cs.scads.storage.Record">winners</a><span class="delimiter">(</span><a href="#58216" title="Int">i</a><span class="delimiter">)</span>.<a href="../Messages.scala.html#22205" title="=&gt; Option[Array[Byte]]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="comment">//should always be defined if we get data back, otherwise delete might not work</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="58229">winnerValue</a> = <a href="#57147" title="(idx: Int)edu.berkeley.cs.scads.storage.Record">winners</a><span class="delimiter">(</span><a href="#58216" title="Int">i</a><span class="delimiter">)</span>.<a href="../Messages.scala.html#22205" title="=&gt; Option[Array[Byte]]">value</a>.<span title="=&gt; Array[Byte]">get</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.Record">head</span>.<a href="../Messages.scala.html#22205" title="=&gt; Option[Array[Byte]]">value</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="58230">newValue</a> = <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.Record">head</span>.<a href="../Messages.scala.html#22205" title="=&gt; Option[Array[Byte]]">value</a>.<span title="=&gt; Array[Byte]">get</span>
        <a href="Interfaces.scala.html#27933" title="(x: Array[Byte], y: Array[Byte])Int">compareKey</a><span class="delimiter">(</span><a href="#58227" title="Array[Byte]">winnerKey</a>, <a href="#58228" title="Array[Byte]">newKey</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="58275">cmp</a> <span class="keyword">if</span> <a href="#58275" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> =&gt;
            <a href="#58216" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="Interfaces.scala.html#27936" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#58229" title="Array[Byte]">winnerValue</a>, <a href="#58230" title="Array[Byte]">newValue</a><span class="delimiter">)</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">-</span><span class="int">1</span> =&gt; <span class="delimiter">{</span>
                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]" id="58284">outdatedServer</a> = <a href="#57152" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">winnerExceptions</a>.<span title="(key: Array[Byte], default: =&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">getOrElse</span><span class="delimiter">(</span><a href="#58227" title="Array[Byte]">winnerKey</a>, <a href="#57150" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">baseServer</a><span class="delimiter">)</span>
                <a href="#57145" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])))RangeHandle.this.losers.type">+=</span> <a href="#58227" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]))">-&gt;</span> <span class="delimiter">(</span><a href="#58230" title="Array[Byte]">newValue</a>, <a href="#58284" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">outdatedServer</a> <a href="#58334" title="(x: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">::</a> <a href="#57145" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])">getOrElse</span><span class="delimiter">(</span><a href="#58227" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">_2</span><span class="delimiter">)</span>
                <a href="#57152" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#58227" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])(Array[Byte], edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])">-&gt;</span> <a href="#58213" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">newServer</a>
                <a href="#57147" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">winners</a>.<span title="(idx: Int, elem: edu.berkeley.cs.scads.storage.Record)Unit">update</span><span class="delimiter">(</span><a href="#58216" title="Int">i</a>, <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.Record">head</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="RangeHandle.this.losers.type" class="int">1</span> =&gt; <span class="delimiter">{</span>
                <a href="#57145" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])))RangeHandle.this.losers.type">+=</span> <a href="#58227" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]))">-&gt;</span> <span class="delimiter">(</span><a href="#58229" title="Array[Byte]">winnerValue</a>, <a href="#58213" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">newServer</a> <a href="#58433" title="(x: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">::</a> <a href="#57145" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])">getOrElse</span><span class="delimiter">(</span><a href="#58227" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">_2</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a> = <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.Record]">tail</span>
            <a href="#58216" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <a title="Unit" id="58480">cmp</a> <span class="keyword">if</span> <a href="#58480" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="#57147" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">winners</a>.<span title="(n: Int, elems: edu.berkeley.cs.scads.storage.Record*)Unit">insert</span><span class="delimiter">(</span><a href="#58216" title="Int">i</a>, <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.Record">head</span><span class="delimiter">)</span>
            <a href="#58216" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span> <span class="comment">//because of the insert</span>
            <a href="#57152" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#58228" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">newKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])(Array[Byte], edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])">-&gt;</span> <a href="#58213" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">newServer</a>
            <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a> = <a href="#58215" title="Seq[edu.berkeley.cs.scads.storage.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.Record]">tail</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="57166">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#57163" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="Array[Byte]" id="58554">key</a>, <span class="delimiter">(</span><a title="Array[Byte]" id="58557">data</a>, <a title="List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" id="58558">servers</a><span class="delimiter">)</span><span class="delimiter">)</span> &lt;- <a href="#57145" title="(f: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]])) =&gt; Unit)Unit">losers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]" id="58589">server</a> &lt;- <a href="#58558" title="(f: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#58589" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">server</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="../Messages.scala.html#22714" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PutRequest">PutRequest</a><span class="delimiter">(</span><a href="#58554" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#58557" title="Array[Byte]">data</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
 
  <span class="comment">/*
   * NB: We trust the caller here that the records produced from the given locations will
   * all have keys in between firstKey and lastKey.  Therefore we just check that
   * firstKey&lt;-&gt;lastKey only covers one partition
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(parser: edu.berkeley.cs.scads.storage.RecParser, locations: Array[String], firstKey: Option[Array[Byte]], lastKey: Option[Array[Byte]])Unit" id="41754">putBulkLocations</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecParser" id="58596">parser</a>:<a href="../server/PartitionHandler.scala.html#10056" title="edu.berkeley.cs.scads.storage.RecParser">RecParser</a>,<a title="Array[String]" id="58597">locations</a>:<span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
                                <a title="Option[Array[Byte]]" id="58598">firstKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,<a title="Option[Array[Byte]]" id="58599">lastKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="58601">partitions</a> = <a href="Interfaces.scala.html#27961" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#58598" title="Option[Array[Byte]]">firstKey</a>, <a href="#58599" title="Option[Array[Byte]]">lastKey</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58601" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Can\'t bulk put locations over more than one partition&quot;)" class="string">&quot;Can't bulk put locations over more than one partition&quot;</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="58606">baos</a> = <span title="java.io.ByteArrayOutputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span>
      <span class="keyword">val</span> <a title="java.io.ObjectOutputStream" id="58607">oos</a> = <span title="java.io.ObjectOutputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectOutputStream">ObjectOutputStream</span><span class="delimiter">(</span><a href="#58606" title="java.io.ByteArrayOutputStream">baos</a><span class="delimiter">)</span>
      <a href="#58607" title="java.io.ObjectOutputStream">oos</a>.<span title="(x$1: Any)Unit">writeObject</span><span class="delimiter">(</span><a href="#58596" title="edu.berkeley.cs.scads.storage.RecParser">parser</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="58608">responses</a> = <a href="#58601" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#31379" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a href="#58638" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="../Messages.scala.html#22818" title="(parser: Array[Byte], locations: Seq[String])edu.berkeley.cs.scads.storage.BulkUrlPutReqest">BulkUrlPutReqest</a><span class="delimiter">(</span><a href="#58606" title="java.io.ByteArrayOutputStream">baos</a>.<span title="()Array[Byte]">toByteArray</span>,<a href="#58597" title="(xs: Array[String])scala.collection.mutable.WrappedArray[String]">locations</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#58608" title="(futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])edu.berkeley.cs.scads.comm.FutureCollection[edu.berkeley.cs.scads.storage.StorageMessage]">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#58601" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#31379" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get all value versions for a range of keys.  Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Seq[(edu.berkeley.cs.scads.storage.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]" id="41755">getAllRangeVersions</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="58710">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="58711">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.storage.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>,Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="58713">partitions</a> = <a href="Interfaces.scala.html#27961" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#58710" title="Option[Array[Byte]]">startKey</a>, <a href="#58711" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#27956" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.storage.StorageMessage, edu.berkeley.cs.scads.storage.PartitionService),(edu.berkeley.cs.scads.storage.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])])Seq[(edu.berkeley.cs.scads.storage.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">waitForAndThrowException</a><span class="delimiter">(</span>
      <a href="#58713" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; scala.collection.GenTraversableOnce[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="58736">range</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.GetRangeRequest" id="58737">rangeReq</a> = <a href="../Messages.scala.html#23010" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.storage.GetRangeRequest">GetRangeRequest</a><span class="delimiter">(</span><a href="#58736" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31375" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#58736" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31377" title="=&gt; Option[Array[Byte]]">endKey</a>, <span title="object None">None</span>, <span title="object None">None</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
        <a href="#58736" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#31379" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="58759">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], _2: edu.berkeley.cs.scads.storage.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage], edu.berkeley.cs.scads.storage.PartitionService)" class="delimiter">(</span><a href="#58759" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#58737" title="edu.berkeley.cs.scads.storage.GetRangeRequest">rangeReq</a>, <a href="#58759" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span> 
      <span class="delimiter">}</span><span class="delimiter">)</span> 
    <span class="delimiter">)</span> <a href="#58821" title="(edu.berkeley.cs.scads.storage.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">{</a>    
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.storage.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span>GetRangeResponse<span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.Record]" id="58824">recs</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.storage.PartitionService" id="58825">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.storage.PartitionService, _2: Seq[(Array[Byte], Option[Array[Byte]])])(edu.berkeley.cs.scads.storage.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span><a href="#58825" title="edu.berkeley.cs.scads.storage.PartitionService">partition</a>, <a href="#58824" title="Seq[edu.berkeley.cs.scads.storage.Record]">recs</a>.<span title="(f: edu.berkeley.cs.scads.storage.Record =&gt; (Array[Byte], Option[Array[Byte]]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.Record],(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]])Seq[(Array[Byte], Option[Array[Byte]])]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.Record" id="58855">r</a>=&gt;<span title="(_1: Array[Byte], _2: Option[Array[Byte]])(Array[Byte], Option[Array[Byte]])" class="delimiter">(</span><a href="#58855" title="edu.berkeley.cs.scads.storage.Record">r</a>.<a href="../Messages.scala.html#22202" title="=&gt; Array[Byte]">key</a>,<a href="#58855" title="edu.berkeley.cs.scads.storage.Record">r</a>.<a href="../Messages.scala.html#22205" title="=&gt; Option[Array[Byte]]">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>