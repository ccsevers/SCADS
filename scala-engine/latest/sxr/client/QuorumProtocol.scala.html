<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/QuorumProtocol.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.avro.marker._
<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> org.apache.avro.Schema 
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> actors.Actor
<span class="keyword">import</span> collection.mutable.<span class="delimiter">{</span> Seq =&gt; MutSeq, _ <span class="delimiter">}</span>
<span class="keyword">import</span> concurrent.ManagedBlocker

<span class="keyword">import</span> java.util.concurrent._

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.QuorumProtocol" id="9647">QuorumProtocol</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="40913">ZK_QUORUM_CONFIG</a> = <span title="java.lang.String(&quot;quorumProtConfig&quot;)" class="string">&quot;quorumProtConfig&quot;</span>

  <span class="keyword">val</span> <a title="Int" id="40915">BulkPutBufSize</a> = <span title="Int(1024)" class="int">1024</span>
  <span class="keyword">val</span> <a title="Int" id="40917">BulkPutMaxOutstanding</a> = <span title="Int(64)" class="int">64</span>
  <span class="keyword">val</span> <a title="Int" id="40919">BulkPutTimeout</a> = <span class="int">60</span> <span title="Int(60000)">*</span> <span class="int">1000</span>

  <span class="comment">//TODO: there is probably a better way to do this...</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]" id="40921">awaitingReadRepair</a> = <span title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]" class="keyword">new</span> <span title="java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">ArrayBlockingQueue</span><span class="delimiter">[</span>RequestHandler<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.lang.Thread" id="40923">readRepairThread</a> = <a href="#51019" title="java.lang.Thread" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Thread" id="51019">Thread</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Read Repair&quot;)" class="string">&quot;Read Repair&quot;</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="51396">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	<a href="#40921" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<span title="()edu.berkeley.cs.scads.storage.RequestHandler">take</span>.<a href="#51465" title="()Unit">finish</a><a href="#51464" title="()Unit" class="delimiter">(</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <a href="#40923" title="=&gt; java.lang.Thread">readRepairThread</a>.<span title="(x$1: Boolean)Unit">setDaemon</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <a href="#40923" title="=&gt; java.lang.Thread">readRepairThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="40925">flushReadRepair</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#40921" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<span title="()Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><a href="#51473" title="()Unit" class="delimiter">(</a><span title="Long(100L)" class="int">100</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class TimeoutCounter extends java.lang.Object with ScalaObject" id="9649">TimeoutCounter</a><a href="#9649" title="ScalaObject" class="delimiter">(</a><a title="Long" id="29158">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="Long" id="29155">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Long" id="29157">remaining</a>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Long" id="51482">remainingTime</a> = <a href="#29158" title="Long">timeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#29155" title="=&gt; Long">startTime</a><span class="delimiter">)</span>
    <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#51482" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span title="Long(1L)" class="int">1</span>
    <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#51482" title="Long">remainingTime</a> <span title="(x: Long)Boolean">&gt;</span> <a href="#29158" title="Long">timeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
      <a href="#29158" title="Long">timeout</a>
    <span class="keyword">else</span>
      <a href="#51482" title="Long">remainingTime</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait RequestHandler extends java.lang.Object" id="9650">RequestHandler</a> <span title="java.lang.Object" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="()Unit" id="51465">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.Protocol with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.KeyRoutable with edu.berkeley.cs.scads.storage.RecordMetadata with edu.berkeley.cs.scads.storage.GlobalMetadata with edu.berkeley.cs.scads.storage.ParFuture with ScalaObject" id="9651">QuorumProtocol</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9613" title="edu.berkeley.cs.scads.storage.Protocol">Protocol</a>
  <span class="keyword">with</span> <a href="Namespace.scala.html#9628" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9615" title="edu.berkeley.cs.scads.storage.KeyRoutable">KeyRoutable</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9623" title="edu.berkeley.cs.scads.storage.RecordMetadata">RecordMetadata</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9621" title="edu.berkeley.cs.scads.storage.GlobalMetadata">GlobalMetadata</a>
  <span class="keyword">with</span> <a href="../util/ParFuture.scala.html#9980" title="edu.berkeley.cs.scads.storage.ParFuture">ParFuture</a> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="#9647" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>._

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Option[Array[Byte]]" id="13548">getBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="40945">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51715" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</a><a href="#51714" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51715">ftchs</a>, <a href="#51714" title="Int" id="51716">quorum</a><span class="delimiter">)</span> = <a href="#13550" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int) @unchecked" class="delimiter">(</span><a href="#40945" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#13551" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><a href="#51865" title="QuorumProtocol.this.GetHandler" class="keyword">new</a> <a href="#13578" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#40945" title="Array[Byte]">key</a>, <a href="#51715" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a><span class="delimiter">)</span>, <a href="#51716" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Issues a get request but does not block the current thread waiting for
   * responses. A ScadsFuture is returned which can be used to block for
   * responses. Calls to get/apply on the ScadsFuture are idempotent - the
   * first call will cause the current thread to wait for GetResponse
   * messages, and vote on the winning record, handling the read repair in the
   * process. Subsequent calls (regardless of thread) then wait for the first
   * call to finish and piggyback off the result.
   *
   * NOTE: There *IS* a subtle difference between calling get(key) and calling
   * asyncGet(key).get(), in the case where the servers do not respond to the
   * get request. In the former case, an exception is thrown after a default
   * (for now hardcoded) timeout value expires. In the latter case, the thread
   * is blocked forever. Use with timeouts is recommended.
   *
   * NOTE: The returned future does not implement cancel
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]" id="13549">asyncGetBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="40911">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]">ScadsFuture</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51878" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</a><a href="#51877" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51878">ftchs</a>, <a href="#51877" title="Int" id="51879">quorum</a><span class="delimiter">)</span> = <a href="#13550" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int) @unchecked" class="delimiter">(</span><a href="#40911" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#51890" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" id="51890">ComputationFuture</a><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Option[Array[Byte]]" id="51914">compute</a><span class="delimiter">(</span><a title="Long" id="51916">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="51917">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#13551" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><span title="QuorumProtocol.this.GetHandler" class="keyword">new</span> <a href="#13578" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#40911" title="Array[Byte]">key</a>, <a href="#51878" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a>, <a href="#51917" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#51916" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#51879" title="Int">quorum</a><span class="delimiter">)</span>
          .<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="51915">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" id="13550">makeGetRequests</a><span class="delimiter">(</span><a title="Array[Byte]" id="51717">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51721" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51720" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51721">servers</a>, <a href="#51720" title="Int" id="51722">quorum</a><span class="delimiter">)</span> = <a href="#13575" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#51717" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRequest" id="51723">getRequest</a> = <span title="(key: Array[Byte])edu.berkeley.cs.scads.comm.GetRequest">GetRequest</span><span class="delimiter">(</span><a href="#51717" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="comment">// (ftch, quorum)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.MessageFuture], _2: Int)(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</span><a href="#51721" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#51793" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#51723" title="edu.berkeley.cs.scads.comm.GetRequest">getRequest</a><span class="delimiter">)</span>, <a href="#51722" title="Int">quorum</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]" id="13551">finishGetHandler</a><span class="delimiter">(</span><a title="QuorumProtocol.this.GetHandler" id="51826">handler</a>: <a href="#13578" title="QuorumProtocol.this.GetHandler">GetHandler</a>, <a title="Int" id="51827">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Option[Array[Byte]]]">Option</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="52045">record</a> = <a href="#51826" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51857" title="(quorum: Int)Option[Array[Byte]]">vote</a><span class="delimiter">(</span><a href="#51827" title="Int">quorum</a><span class="delimiter">)</span>
    <span title="Option[Option[Array[Byte]]]" class="keyword">if</span> <span class="delimiter">(</span><a href="#51826" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51854" title="=&gt; Boolean">failed</a><span class="delimiter">)</span> <span title="object None">None</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#9647" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>.<a href="#40921" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<span title="(x$1: edu.berkeley.cs.scads.storage.RequestHandler)Boolean">offer</span><span class="delimiter">(</span><a href="#51826" title="QuorumProtocol.this.GetHandler">handler</a><span class="delimiter">)</span>
      <span title="(x: Option[Array[Byte]])Some[Option[Array[Byte]]]">Some</span><span class="delimiter">(</span><a href="#52045" title="Option[Array[Byte]]">record</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13628" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.ScadsFuture[Unit]" id="13552">asyncPutBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="52068">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="52069">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Unit]">ScadsFuture</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#52072" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#52071" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52072">servers</a>, <a href="#52071" title="Int" id="52073">quorum</a><span class="delimiter">)</span> = <a href="#13573" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#52068" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="52074">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#52068" title="Array[Byte]">key</a>, <a href="#52069" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13625" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="52075">responses</a> = <a href="Interfaces.scala.html#13619" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#52068" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#52121" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#52074" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a><span class="delimiter">)</span>

    <a href="#52142" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" id="52142">ComputationFuture</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Unit" id="52146">compute</a><span class="delimiter">(</span><a title="Long" id="52148">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="52149">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <a href="#52075" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#52073" title="Int">quorum</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="keyword">def</span> <a title="=&gt; Nothing" id="52147">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])Unit" id="13553">putBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="52180">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="52181">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#52184" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#52183" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52184">servers</a>, <a href="#52183" title="Int" id="52185">quorum</a><span class="delimiter">)</span> = <a href="#13573" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#52180" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="52186">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#52180" title="Array[Byte]">key</a>, <a href="#52181" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13625" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="52187">responses</a> = <a href="Interfaces.scala.html#13619" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#52180" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#52227" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#52186" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a><span class="delimiter">)</span>
    <a href="#52187" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#52185" title="Int">quorum</a>, <span title="Long(500L)" class="int">500</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/* Buffers KV tuples until the average buffer size for all the servers is
   * greater than BufSize. Then sends the request to the servers, while
   * repeating the buffering process for the next set of KV tuples. When the
   * tuple stream runs out, or when the outstanding future collection grows
   * above a certain threshold, blocks on each of the returned
   * future collections.
   *
   * Note: the current implementation is Write All not quorum based.
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Array[Byte])Unit" id="13554">putBulkBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="43578">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Array[Byte]" id="43579">value</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#52257" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#52256" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52257">servers</a>, <a href="#52256" title="Int" id="52258">quorum</a><span class="delimiter">)</span> = <a href="#13573" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#43578" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="52259">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#43578" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13625" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">(</span><a href="#43579" title="Array[Byte]">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="52293">server</a> &lt;- <a href="#52257" title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; Unit)Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="52294">buf</a> = <a href="#13556" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a>.<span title="(key: edu.berkeley.cs.scads.comm.PartitionService, op: =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest])scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">getOrElseUpdate</span><span class="delimiter">(</span><a href="#52293" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">(</span><a href="#40915" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#52294" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a> <span title="(elem: edu.berkeley.cs.scads.comm.PutRequest)buf.type">+=</span> <a href="#52259" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a>

      <span class="comment">/* send the buffer when its full */</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52294" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#40915" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span>
        <a href="#13563" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52293" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52294" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#13561" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#40917" title="=&gt; Int">BulkPutMaxOutstanding</a><span class="delimiter">)</span>
      <a href="#13564" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="13555">flushBulkBytes</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">/* flush any remaining send buffers */</span>
    <a href="#13556" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a>.<span title="(f: (edu.berkeley.cs.scads.comm.PartitionService, scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]) =&gt; Unit)Unit">foreach</span> <a href="#52358" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="52361">server</a>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="52362">buffer</a><span class="delimiter">)</span> =&gt; <a href="#13563" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52361" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52362" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buffer</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/* block until we receive responses for all sent requests */</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#13561" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <a href="#13564" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]" id="13556">serverBuffers</a> = <span title="()scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">HashMap</span><span class="delimiter">[</span>PartitionService, ArrayBuffer<span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">protected</span> case <span class="keyword">class</span> <a title="class OutstandingPut extends java.lang.Object with ScalaObject with Product with Serializable" id="52399">OutstandingPut</a><a href="#52399" title="ScalaObject" class="delimiter">(</a><a title="Long" id="52523">timestamp</a>: <span title="Long">Long</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="52524">server</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="52525">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="52526">future</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span>, <a title="Int" id="52527">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" id="13561">outstandingPuts</a> = <span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" class="keyword">new</span> collection.mutable.<span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">Queue</span><span class="delimiter">[</span>OutstandingPut<span class="delimiter">]</span>

  <span class="comment">/* send the request and append it to the list of outstanding requests */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit" id="13563">sendBuffer</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="52320">server</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="52321">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="Int" id="52324">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52324" title="Int">tries</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(5)" class="int">5</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Retries exceeded for server %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#52320" title="edu.berkeley.cs.scads.comm.PartitionService">server</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#13561" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a> <span title="(elems: QuorumProtocol.this.OutstandingPut*)Unit">enqueue</span> <a href="#52399" title="(timestamp: Long, server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], future: edu.berkeley.cs.scads.comm.MessageFuture, tries: Int)QuorumProtocol.this.OutstandingPut">OutstandingPut</a><span class="delimiter">(</span>
      <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>,
      <a href="#52320" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>,
      <a href="#52321" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>,
      <a href="#52320" title="edu.berkeley.cs.scads.comm.PartitionService">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(records: Seq[edu.berkeley.cs.scads.comm.PutRequest])edu.berkeley.cs.scads.comm.BulkPutRequest">BulkPutRequest</span><span class="delimiter">(</span><a href="#52321" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a><span class="delimiter">)</span>,
      <a href="#52324" title="Int">tries</a><span class="delimiter">)</span>
    <a href="#13556" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a> <span title="(key: edu.berkeley.cs.scads.comm.PartitionService)QuorumProtocol.this.serverBuffers.type">-=</span> <a href="#52320" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>
  <span class="delimiter">}</span>

  <span class="comment">/* wait up to timeout for the oldest request to return if it doesn't resend it*/</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="13564">processNextOutstandingRequest</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="QuorumProtocol.this.OutstandingPut" id="52585">oldestRequest</a> = <a href="#13561" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="()QuorumProtocol.this.OutstandingPut">dequeue</span>
    <span class="keyword">val</span> <a title="Long" id="52586">remainingTime</a> = <a href="#40919" title="=&gt; Int">BulkPutTimeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52523" title="=&gt; Long">timestamp</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Long" id="52587">timeout</a> =
      <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#52586" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Long(1L)" class="int">1</span>
      <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#52586" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#40919" title="=&gt; Int">BulkPutTimeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
        <a href="#40919" title="=&gt; Long">BulkPutTimeout</a>
      <span class="keyword">else</span>
        <a href="#52586" title="Long">remainingTime</a>

    <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52526" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</span><span class="delimiter">(</span><a href="#52587" title="Long">timeout</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span>BulkPutResponse<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="52633">otherMsg</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#13592" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;)" class="string">&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;</span>, <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52524" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52633" title="edu.berkeley.cs.scads.comm.MessageBody">otherMsg</a><span class="delimiter">)</span>
        <a href="#13563" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52524" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52525" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>, <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52527" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#13592" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bulkput to %s timed out. Resending.&quot;)" class="string">&quot;Bulkput to %s timed out. Resending.&quot;</span>, <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52524" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a><span class="delimiter">)</span>
        <a href="#13563" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52524" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52525" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>, <a href="#52585" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52527" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>


  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="13566">readQuorum</a>: <span title="Double">Double</span> = <span title="Double(0.0010)" class="double">0.001</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="13569">writeQuorum</a>: <span title="Double">Double</span> = <span title="Double(1.0)" class="double">1.0</span>

  <span class="comment">/** Initialization callbacks */</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="13571">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52651">config</a> = <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span><span class="delimiter">(</span><a href="#13566" title="=&gt; Double">readQuorum</a>, <a href="#13569" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13637" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40913" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#52651" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13608" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="#13571" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13610" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span> <a title="Boolean" id="52706">isNew</a> =&gt;
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52706" title="Boolean">isNew</a><span class="delimiter">)</span> <a href="#13571" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="Interfaces.scala.html#13636" title="(key: String)Option[Array[Byte]]">getMetadata</a><span class="delimiter">(</span><a href="#40913" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="52708">bytes</a><span class="delimiter">)</span> =&gt; 
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52709">config</a> = <span title="()edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span>
        <a href="#52709" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="(data: Array[Byte])config.type">parse</span><span class="delimiter">(</span><a href="#52708" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
        <a href="#13566" title="(x$1: Double)Unit">readQuorum</a>  = <a href="#52709" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Double">readQuorum</span>
        <a href="#13569" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#52709" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Double">writeQuorum</span>
      <span class="keyword">case</span> <span title="Nothing">None</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;could not find quorum protocol&quot;)" class="string">&quot;could not find quorum protocol&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#52706" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13611" title="(f: =&gt; Unit)Unit">onClose</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">// no-op </span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13612" title="(f: =&gt; Unit)Unit">onDelete</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">//deleteMetadata(ZK_QUORUM_CONFIG)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** NOT thread-safe to set */</span>
  <span class="keyword">def</span> <a title="(readQuorum: Double, writeQuorum: Double)Unit" id="13572">setReadWriteQuorum</a><span class="delimiter">(</span><a title="Double" id="52724">readQuorum</a>: <span title="Double">Double</span>, <a title="Double" id="52725">writeQuorum</a>: <span title="Double">Double</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#52724" title="Double">readQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#52724" title="Double">readQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;)" class="string">&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52724" title="Double">readQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#52725" title="Double">writeQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#52725" title="Double">writeQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;)" class="string">&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52725" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#52725" title="Double">writeQuorum</a> <span title="(x: Double)Double">+</span> <a href="#52724" title="Double">readQuorum</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read + write quorum has to be &gt;= 1 but was &quot;)" class="string">&quot;Read + write quorum has to be &gt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#52724" title="Double">readQuorum</a> <span title="(x: Double)Double">+</span> <a href="#52725" title="Double">writeQuorum</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#9651" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#13566" title="(x$1: Double)Unit">readQuorum</a> = <a href="#52724" title="Double">readQuorum</a>
    <a href="#9651" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#13569" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#52725" title="Double">writeQuorum</a>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52727">config</a> = <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span><span class="delimiter">(</span><a href="#52724" title="Double">readQuorum</a>, <a href="#52725" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13637" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40913" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#52727" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" id="13573">writeQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="52076">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52768">servers</a> = <a href="Interfaces.scala.html#13619" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#52076" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span><a href="#52768" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>, scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#52768" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">size</span> <span title="(x: Double)Double">*</span> <a href="#13569" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(nbServers: Int)Int" id="13574">readQuorum</a><span class="delimiter">(</span><a title="Int" id="52701">nbServers</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#52701" title="Int">nbServers</a> <span title="(x: Double)Double">*</span> <a href="#13566" title="=&gt; Double">readQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" id="13575">readQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="51724">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52787">servers</a> = <a href="Interfaces.scala.html#13619" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51724" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span><a href="#52787" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>, <a href="#13574" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#52787" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns all value versions for a given key. Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(key: Array[Byte])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]" id="13576">getAllVersions</a><span class="delimiter">(</span><a title="Array[Byte]" id="52798">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#52801" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#52800" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52801">partitions</a>, <a href="#52800" title="Int" id="52802">quorum</a><span class="delimiter">)</span> = <a href="#13575" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#52798" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRequest" id="52803">getRequest</a> = <span title="(key: Array[Byte])edu.berkeley.cs.scads.comm.GetRequest">GetRequest</span><span class="delimiter">(</span><a href="#52798" title="Array[Byte]">key</a><span class="delimiter">)</span>

    <a href="../util/ParFuture.scala.html#13646" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#52801" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="52838">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#52838" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#52803" title="edu.berkeley.cs.scads.comm.GetRequest">getRequest</a>, <a href="#52838" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#52878" title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">{</a> 
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">(</span>GetResponse<span class="delimiter">(</span><a title="Option[Array[Byte]]" id="52917">optV</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="52918">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: Option[Array[Byte]])(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">(</span><a href="#52918" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>, <a href="#52917" title="Option[Array[Byte]]">optV</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13628" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class GetHandler extends java.lang.Object with edu.berkeley.cs.scads.storage.RequestHandler with ScalaObject" id="13578">GetHandler</a><a href="#13578" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Array[Byte]" id="51861">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51862">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="51865">timeout</a>: <span title="Long">Long</span> = <span title="Long(5000L)" class="int">5000</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9650" title="edu.berkeley.cs.scads.storage.RequestHandler">RequestHandler</a><span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="51839">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>
    <a href="#51862" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#53043" title="edu.berkeley.cs.scads.comm.MessageFuture">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit">forward</span><span class="delimiter">(</span><a href="#51839" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51841">losers</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">ArrayBuffer</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span> 
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51843">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">ArrayBuffer</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="51846">winnerValue</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="51849">ctr</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="51851">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9649" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#51865" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="51854">failed</a> = <span title="Boolean(false)" class="keyword">false</span>

    <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51856">repairList</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#51841" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a>

    <span class="keyword">def</span> <a title="(quorum: Int)Option[Array[Byte]]" id="51857">vote</a><span class="delimiter">(</span><a title="Int" id="52046">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#52046" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="53179">_</a> =&gt; <a href="#51859" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#51846" title="=&gt; Option[Array[Byte]]">winnerValue</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="51858">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="53320">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#51862" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#51849" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#51859" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="51859">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#51849" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="53322">future</a> = <a href="#51839" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture">poll</span><span class="delimiter">(</span><a href="#51851" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#29157" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53322" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#51854" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <a href="#53322" title="()edu.berkeley.cs.scads.comm.MessageBody">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">GetResponse</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="53337">v</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Int" id="53338">cmp</a> = <a href="#13580" title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int">optCompareMetadata</a><span class="delimiter">(</span><a href="#51846" title="=&gt; Option[Array[Byte]]">winnerValue</a>, <a href="#53337" title="Option[Array[Byte]]">v</a><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53338" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#53322" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51841" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.losers.type">+=</span> <a href="#53350" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53338" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#51841" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a> <span title="(xs: scala.collection.TraversableOnce[edu.berkeley.cs.scads.comm.RemoteActorProxy])GetHandler.this.losers.type">++=</span> <a href="#51843" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a>
            <a href="#51843" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a>.<span title="()Unit">clear</span>
            <a href="#53322" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51843" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.winners.type">+=</span> <a href="#53375" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
            <a href="#51846" title="(x$1: Option[Array[Byte]])Unit">winnerValue</a> = <a href="#53337" title="Option[Array[Byte]]">v</a>
          <span class="delimiter">}</span><span class="keyword">else</span><span class="delimiter">{</span>
            <a href="#53322" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51843" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.winners.type">+=</span> <a href="#53389" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Nothing" id="53393">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown message &quot;)" class="string">&quot;Unknown message &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#53393" title="edu.berkeley.cs.scads.comm.MessageBody">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="51860">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#51858" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="53468">server</a> &lt;- <a href="#51856" title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; edu.berkeley.cs.scads.comm.MessageFuture)Unit">repairList</a><span class="delimiter">)</span>
        <a href="#53468" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#51861" title="=&gt; Array[Byte]">key</a>, <a href="#51846" title="=&gt; Option[Array[Byte]]">winnerValue</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int" id="13580">optCompareMetadata</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="53339">optLhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="53340">optRhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#53339" title="Option[Array[Byte]]">optLhs</a>, <a href="#53340" title="Option[Array[Byte]]">optRhs</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="object None">None</span>, Some<span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span>Some<span class="delimiter">(</span>_<span class="delimiter">)</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="53491">lhs</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="53493">rhs</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="Interfaces.scala.html#13626" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#53491" title="Array[Byte]">lhs</a>, <a href="#53493" title="Array[Byte]">rhs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumRangeProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.RangeProtocol with edu.berkeley.cs.scads.storage.QuorumProtocol with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9652">QuorumRangeProtocol</a> 
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9614" title="edu.berkeley.cs.scads.storage.RangeProtocol">RangeProtocol</a>
  <span class="keyword">with</span> <a href="#9651" title="edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9619" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>

  <span class="comment">/** assumes start/end key prepopulated w/ sentinel min/max values */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" id="38009">startGetRangeRequest</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="53504">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="53505">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="53506">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="53507">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="53508">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span>Seq<span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, Seq<span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53510">partitions</a> = <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" class="keyword">if</span> <span class="delimiter">(</span><a href="#53508" title="Boolean">ascending</a><span class="delimiter">)</span> <a href="Interfaces.scala.html#13651" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#53504" title="Option[Array[Byte]]">startKey</a>, <a href="#53505" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span> <span class="keyword">else</span> <a href="Interfaces.scala.html#13651" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#53504" title="Option[Array[Byte]]">startKey</a>, <a href="#53505" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">reverse</span>

    <a href="#53506" title="Option[Int]">limit</a> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">Some</span><span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <span class="comment">/* if limit is defined, then only send a req to the first server. return a pointer to the tail of the first partition */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53518">range</a> = <a href="#53510" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53519">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53518" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27799" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53518" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27801" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53506" title="Option[Int]">limit</a>, <a href="#53507" title="Option[Int]">offset</a>, <a href="#53508" title="Boolean">ascending</a><span class="delimiter">)</span>
        <span title="(_1: Seq[edu.berkeley.cs.scads.storage.RangeDesc], _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span><a href="#53510" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>, <span title="(elems: Seq[edu.berkeley.cs.scads.comm.MessageFuture]*)Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">Seq</span><span class="delimiter">(</span><a href="#53518" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27803" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53627" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53519" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">None</span> =&gt; <span class="comment">/* if no limit is defined, then we'll have to send a request to every server. the pointer should be nil since no servers left */</span>
        <span title="(_1: scala.collection.immutable.Nil.type, _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span><span title="object Nil">Nil</span>, <a href="#53510" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],Seq[edu.berkeley.cs.scads.comm.MessageFuture],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]])Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Seq[edu.berkeley.cs.scads.comm.MessageFuture],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53672">range</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53673">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53672" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27799" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53672" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27801" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53506" title="Option[Int]">limit</a>, <a href="#53507" title="Option[Int]">offset</a>, <a href="#53508" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#53672" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27803" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53692" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53673" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">toSeq</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Finish a get range request. Ftchs are the GetRangeRequests which have
   * already been sent out, and partitions are the available servers to pull
   * data from 
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]" id="38010">finishGetRangeRequest</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53738">partitions</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">Seq</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, <a title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="53739">ftchs</a>: <span title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="53740">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="53741">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="53742">ascending</a>: <span title="Boolean">Boolean</span>, <a title="Option[Long]" id="53743">timeout</a>: <span title="Option[Long]">Option</span><span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>

    <span class="keyword">def</span> <a title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle" id="53745">newRangeHandle</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53751">ftchs</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">)</span> = 
      <a href="#53743" title="Option[Long]">timeout</a>.<span title="(f: Long =&gt; QuorumRangeProtocol.this.RangeHandle)Option[QuorumRangeProtocol.this.RangeHandle]">map</span><span class="delimiter">(</span><a title="Long" id="53756">t</a> =&gt; <span title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</span> <a href="#38014" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#53751" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a>, <a href="#53756" title="Long">t</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; QuorumRangeProtocol.this.RangeHandle)QuorumRangeProtocol.this.RangeHandle">getOrElse</span><span class="delimiter">(</span><a href="#53793" title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</a> <a href="#38014" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#53751" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]" id="53746">handlers</a> = <a href="#53739" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>.<span title="(f: Seq[edu.berkeley.cs.scads.comm.MessageFuture] =&gt; QuorumRangeProtocol.this.RangeHandle)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]],QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]])Seq[QuorumRangeProtocol.this.RangeHandle]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]]" class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53818">x</a> =&gt; <a href="#53745" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#53818" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">x</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">toBuffer</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" id="53747">result</a> = <span title="()scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">ArrayBuffer</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Long" id="53748">openRec</a> = <a href="#53740" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Long)Option[Long]">map</span><span class="delimiter">(</span><a href="#53862" title="Int">_</a>.<span title="=&gt; Long">toLong</span><span class="delimiter">)</span>.<span title="(default: =&gt; Long)Long">getOrElse</span><span class="delimiter">(</span>java.lang.Long.<span title="Long(9223372036854775807L)">MAX_VALUE</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53749">servers</a> = <a href="#53738" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>
    <span class="keyword">var</span> <a title="Int" id="53750">cur</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="QuorumRangeProtocol.this.RangeHandle" id="53914">handler</a> &lt;- <a href="#53746" title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Unit)Unit">handlers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53748" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53919">records</a> = <a href="#53914" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53785" title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">vote</a><span class="delimiter">(</span><a href="#13574" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#53914" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53790" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53914" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53780" title="=&gt; Boolean">failed</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;)" class="string">&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;</span><span class="delimiter">)</span>
        <span class="comment">//if we do not get enough records, we request more, before we process the current batch</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53919" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="=&gt; Int">length</span> <span title="(x: Long)Boolean">&lt;=</span> <a href="#53748" title="Long">openRec</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#53749" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53941">range</a> = <a href="#53749" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
          <span class="keyword">val</span> <a title="Option[Int]" id="53942">newLimit</a> = <span title="Option[Int]" class="keyword">if</span><span class="delimiter">(</span><a href="#53740" title="Option[Int]">limit</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#53748" title="Long">openRec</a>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span> <span class="keyword">else</span> <span title="object None">None</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53943">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53941" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27799" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53941" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27801" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53942" title="Option[Int]">newLimit</a>, <a href="#53741" title="Option[Int]">offset</a>, <a href="#53742" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#53746" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(elems: QuorumRangeProtocol.this.RangeHandle*)Unit">append</span><span class="delimiter">(</span><a href="#53745" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#53941" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27803" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53978" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53943" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#53749" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a> = <a href="#53749" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>
        <span class="delimiter">}</span>
        <a href="#53747" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>.<span title="(xs: scala.collection.TraversableOnce[(Array[Byte], Array[Byte])])Unit">appendAll</span><span class="delimiter">(</span><a href="#53919" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; scala.collection.GenTraversableOnce[(Array[Byte], Array[Byte])])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record],(Array[Byte], Array[Byte]),scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]])scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer.Coll,(Array[Byte], Array[Byte]),scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="54016">rec</a> =&gt;
          <span title="List[(Array[Byte], Array[Byte])]" class="keyword">if</span> <span class="delimiter">(</span><a href="#53748" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#53748" title="Long">openRec</a> <span title="(x: Int)Long">-=</span> <span title="Int(1)" class="int">1</span>
            <a href="#54016" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="(f: Array[Byte] =&gt; (Array[Byte], Array[Byte]))Option[(Array[Byte], Array[Byte])]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="54029">v</a> =&gt; <span title="(_1: Array[Byte], _2: Array[Byte])(Array[Byte], Array[Byte])" class="delimiter">(</span><a href="#54016" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Array[Byte]">key</span>, <a href="Interfaces.scala.html#13628" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">(</span><a href="#54029" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[(Array[Byte], Array[Byte])]">toList</span>
          <span class="delimiter">}</span> <span class="keyword">else</span>
            <span title="object Nil">Nil</span>
          <span class="delimiter">)</span>
        <span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#53746" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Boolean)Unit">foreach</span><span class="delimiter">(</span><a href="#9647" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>.<a href="#40921" title="=&gt; java.util.concurrent.ArrayBlockingQueue[edu.berkeley.cs.scads.storage.RequestHandler]">awaitingReadRepair</a>.<a href="#54419" title="(x$1: edu.berkeley.cs.scads.storage.RequestHandler)Boolean">offer</a><span class="delimiter">)</span>
    <a href="#53747" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[(Array[Byte], Array[Byte])]" id="38011">getKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="54423">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Array[Byte]]" id="54424">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="54425">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="54426">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Boolean" id="54427">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#54430" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</a><a href="#54429" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54430">ptr</a>, <a href="#54429" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="54431">ftchs</a><span class="delimiter">)</span> = <a href="#38009" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]) @unchecked" class="delimiter">(</span><a href="#54423" title="Option[Array[Byte]]">start</a>, <a href="#54424" title="Option[Array[Byte]]">end</a>, <a href="#54425" title="Option[Int]">limit</a>, <a href="#54426" title="Option[Int]">offset</a>, <a href="#54427" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#38010" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#54430" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#54431" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>, <a href="#54425" title="Option[Int]">limit</a>, <a href="#54426" title="Option[Int]">offset</a>, <a href="#54427" title="Boolean">ascending</a>, <span title="object None">None</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]" id="38012">asyncGetKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="54442">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="54443">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="54444">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="54445">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="54446">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#54449" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</a><a href="#54448" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54449">ptr</a>, <a href="#54448" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="54450">ftchs</a><span class="delimiter">)</span> = <a href="#38009" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]) @unchecked" class="delimiter">(</span><a href="#54442" title="Option[Array[Byte]]">start</a>, <a href="#54443" title="Option[Array[Byte]]">end</a>, <a href="#54444" title="Option[Int]">limit</a>, <a href="#54445" title="Option[Int]">offset</a>, <a href="#54446" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#54461" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" id="54461">ComputationFuture</a><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Seq[(Array[Byte], Array[Byte])]" id="54465">compute</a><span class="delimiter">(</span><a title="Long" id="54467">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="54468">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#38010" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#54449" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#54450" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>, <a href="#54444" title="Option[Int]">limit</a>, <a href="#54445" title="Option[Int]">offset</a>, <a href="#54446" title="Boolean">ascending</a>, <span title="(x: Long)Some[Long]">Some</span><span class="delimiter">(</span><a href="#54468" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#54467" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="54466">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Tests the range for conflicts and marks all violations for future resolution.
   * This class is optimized for none/few violations.
   */</span>
  <span class="keyword">class</span> <a title="class RangeHandle extends java.lang.Object with edu.berkeley.cs.scads.storage.RequestHandler with ScalaObject" id="38014">RangeHandle</a><a href="#38014" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53790">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="53793">timeout</a>: <span title="Long">Long</span> = <span class="int">10</span> <span title="Long(10000L)">*</span> <span class="int">1000</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#9650" title="edu.berkeley.cs.scads.storage.RequestHandler">RequestHandler</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="53764">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9649" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#53793" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="53766">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>
    <a href="#53790" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#54592" title="edu.berkeley.cs.scads.comm.MessageFuture">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit">forward</span><span class="delimiter">(</span><a href="#53766" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// TODO: hashing on byte array like this is no good. this should be redone</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]" id="53768">losers</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, List<span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53770">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>

    <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="53773">baseServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</span> = <span title="Null(null)" class="keyword">null</span> <span class="comment">//The whole comparison is based on the first response</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="53775">winnerExceptions</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, RemoteActorProxy<span class="delimiter">]</span>

    <span class="keyword">val</span> <a title="Long" id="53777">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">var</span> <a title="Boolean" id="53780">failed</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="53783">ctr</a> = <span title="Int(0)" class="int">0</span>

    <span class="keyword">def</span> <a title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53785">vote</a><span class="delimiter">(</span><a title="Int" id="53920">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#53920" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="54693">_</a> =&gt; <a href="#53787" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#53770" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="53786">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="54801">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#53790" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#53783" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#53787" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="53787">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#53783" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
       <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="54803">future</a> = <a href="#53766" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture">poll</span><span class="delimiter">(</span><a href="#53764" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#29157" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#54803" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#53780" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54804">result</a> = <a href="#54803" title="()edu.berkeley.cs.scads.comm.MessageBody">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Seq[edu.berkeley.cs.scads.comm.Record]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Seq[edu.berkeley.cs.scads.comm.Record]">GetRangeResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54854">v</a><span class="delimiter">)</span> =&gt; <a href="#54854" title="Seq[edu.berkeley.cs.scads.comm.Record]">v</a>
        <span class="keyword">case</span> <a title="Nothing" id="54855">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message (was expecting GetRangeResponse): &quot;)" class="string">&quot;Unexpected Message (was expecting GetRangeResponse): &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#54855" title="edu.berkeley.cs.scads.comm.MessageBody">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53770" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">//println(&quot;first result &quot; + result.map(a =&gt; QuorumProtocol.this.deserializeKey(a.key)))</span>
        <a href="#53770" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(n: Int, seq: Traversable[edu.berkeley.cs.scads.comm.Record])Unit">insertAll</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <a href="#54804" title="Seq[edu.berkeley.cs.scads.comm.Record]">result</a><span class="delimiter">)</span>
        <a href="#53773" title="(x$1: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">baseServer</a> = <a href="#54803" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">get</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#53788" title="(newRecords: Seq[edu.berkeley.cs.scads.comm.Record], newServer: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">merge</a><span class="delimiter">(</span><a href="#54804" title="Seq[edu.berkeley.cs.scads.comm.Record]">result</a>, <a href="#54803" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">get</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(newRecords: Seq[edu.berkeley.cs.scads.comm.Record], newServer: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit" id="53788">merge</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54887">newRecords</a>: <span title="Seq[edu.berkeley.cs.scads.comm.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54888">newServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54890">recordPtr</a> = <a href="#54887" title="Seq[edu.berkeley.cs.scads.comm.Record]">newRecords</a>
      <span class="keyword">var</span> <a title="Int" id="54891">i</a> = <span title="Int(0)" class="int">0</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#54891" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#53770" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="=&gt; Int">length</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#54892" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54902">winnerKey</a> = <a href="#53770" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54891" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">key</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54903">newKey</a> = <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Array[Byte]">key</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#53770" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54891" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="comment">//should always be defined if we get data back, otherwise delete might not work</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54904">winnerValue</a> = <a href="#53770" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54891" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54905">newValue</a> = <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span>
        <a href="Interfaces.scala.html#13623" title="(x: Array[Byte], y: Array[Byte])Int">compareKey</a><span class="delimiter">(</span><a href="#54902" title="Array[Byte]">winnerKey</a>, <a href="#54903" title="Array[Byte]">newKey</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="54950">cmp</a> <span class="keyword">if</span> <a href="#54950" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> =&gt;
            <a href="#54891" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="Interfaces.scala.html#13626" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#54904" title="Array[Byte]">winnerValue</a>, <a href="#54905" title="Array[Byte]">newValue</a><span class="delimiter">)</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">-</span><span class="int">1</span> =&gt; <span class="delimiter">{</span>
                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54959">outdatedServer</a> = <a href="#53775" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a>.<span title="(key: Array[Byte], default: =&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy)edu.berkeley.cs.scads.comm.RemoteActorProxy">getOrElse</span><span class="delimiter">(</span><a href="#54902" title="Array[Byte]">winnerKey</a>, <a href="#53773" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">baseServer</a><span class="delimiter">)</span>
                <a href="#53768" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])))RangeHandle.this.losers.type">+=</span> <a href="#54902" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))">-&gt;</span> <span class="delimiter">(</span><a href="#54905" title="Array[Byte]">newValue</a>, <a href="#54959" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">outdatedServer</a> <a href="#55009" title="(x: edu.berkeley.cs.scads.comm.RemoteActorProxy)List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">::</a> <a href="#53768" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])">getOrElse</span><span class="delimiter">(</span><a href="#54902" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">_2</span><span class="delimiter">)</span>
                <a href="#53775" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#54902" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteActorProxy)(Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy)">-&gt;</span> <a href="#54888" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a>
                <a href="#53770" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(idx: Int, elem: edu.berkeley.cs.scads.comm.Record)Unit">update</span><span class="delimiter">(</span><a href="#54891" title="Int">i</a>, <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="RangeHandle.this.losers.type" class="int">1</span> =&gt; <span class="delimiter">{</span>
                <a href="#53768" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])))RangeHandle.this.losers.type">+=</span> <a href="#54902" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))">-&gt;</span> <span class="delimiter">(</span><a href="#54904" title="Array[Byte]">winnerValue</a>, <a href="#54888" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a> <a href="#55108" title="(x: edu.berkeley.cs.scads.comm.RemoteActorProxy)List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">::</a> <a href="#53768" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])">getOrElse</span><span class="delimiter">(</span><a href="#54902" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">_2</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a> = <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">tail</span>
            <a href="#54891" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <a title="Unit" id="55155">cmp</a> <span class="keyword">if</span> <a href="#55155" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="#53770" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(n: Int, elems: edu.berkeley.cs.scads.comm.Record*)Unit">insert</span><span class="delimiter">(</span><a href="#54891" title="Int">i</a>, <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span><span class="delimiter">)</span>
            <a href="#54891" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span> <span class="comment">//because of the insert</span>
            <a href="#53775" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#54903" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">newKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteActorProxy)(Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy)">-&gt;</span> <a href="#54888" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a>
            <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a> = <a href="#54890" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">tail</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="53789">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#53786" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="Array[Byte]" id="55229">key</a>, <span class="delimiter">(</span><a title="Array[Byte]" id="55232">data</a>, <a title="List[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="55233">servers</a><span class="delimiter">)</span><span class="delimiter">)</span> &lt;- <a href="#53768" title="(f: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])) =&gt; Unit)Unit">losers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="55264">server</a> &lt;- <a href="#55233" title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; edu.berkeley.cs.scads.comm.MessageFuture)Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#55264" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#55229" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#55232" title="Array[Byte]">data</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
 
  <span class="comment">/*
   * NB: We trust the caller here that the records produced from the given locations will
   * all have keys in between firstKey and lastKey.  Therefore we just check that
   * firstKey&lt;-&gt;lastKey only covers one partition
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(parser: edu.berkeley.cs.scads.storage.RecParser, locations: Array[String], firstKey: Option[Array[Byte]], lastKey: Option[Array[Byte]])Unit" id="38016">putBulkLocations</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecParser" id="55274">parser</a>:<a href="../server/PartitionHandler.scala.html#9816" title="edu.berkeley.cs.scads.storage.RecParser">RecParser</a>,<a title="Array[String]" id="55275">locations</a>:<span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
                                <a title="Option[Array[Byte]]" id="55276">firstKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,<a title="Option[Array[Byte]]" id="55277">lastKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="55279">partitions</a> = <a href="Interfaces.scala.html#13651" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#55276" title="Option[Array[Byte]]">firstKey</a>, <a href="#55277" title="Option[Array[Byte]]">lastKey</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#55279" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Can\'t bulk put locations over more than one partition&quot;)" class="string">&quot;Can't bulk put locations over more than one partition&quot;</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="55284">baos</a> = <span title="java.io.ByteArrayOutputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span>
      <span class="keyword">val</span> <a title="java.io.ObjectOutputStream" id="55285">oos</a> = <span title="java.io.ObjectOutputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectOutputStream">ObjectOutputStream</span><span class="delimiter">(</span><a href="#55284" title="java.io.ByteArrayOutputStream">baos</a><span class="delimiter">)</span>
      <a href="#55285" title="java.io.ObjectOutputStream">oos</a>.<span title="(x$1: Any)Unit">writeObject</span><span class="delimiter">(</span><a href="#55274" title="edu.berkeley.cs.scads.storage.RecParser">parser</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="55286">responses</a> = <a href="#55279" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#27803" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#55316" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(parser: Array[Byte], locations: Seq[String])edu.berkeley.cs.scads.comm.BulkUrlPutReqest">BulkUrlPutReqest</span><span class="delimiter">(</span><a href="#55284" title="java.io.ByteArrayOutputStream">baos</a>.<span title="()Array[Byte]">toByteArray</span>,<a href="#55275" title="(xs: Array[String])scala.collection.mutable.WrappedArray[String]">locations</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#55286" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#55279" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#27803" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get all value versions for a range of keys.  Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]" id="38017">getAllRangeVersions</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="55410">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="55411">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>,Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="55413">partitions</a> = <a href="Interfaces.scala.html#13651" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#55410" title="Option[Array[Byte]]">startKey</a>, <a href="#55411" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13646" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">waitForAndThrowException</a><span class="delimiter">(</span>
      <a href="#55413" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; scala.collection.GenTraversableOnce[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="55436">range</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="55437">rangeReq</a> = <span title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#55436" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27799" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#55436" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27801" title="=&gt; Option[Array[Byte]]">endKey</a>, <span title="object None">None</span>, <span title="object None">None</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
        <a href="#55436" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27803" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="55464">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#55464" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#55437" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeReq</a>, <a href="#55464" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span> 
      <span class="delimiter">}</span><span class="delimiter">)</span> 
    <span class="delimiter">)</span> <a href="#55521" title="(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">{</a>    
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span>GetRangeResponse<span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="55525">recs</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="55526">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: Seq[(Array[Byte], Option[Array[Byte]])])(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span><a href="#55526" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>, <a href="#55525" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; (Array[Byte], Option[Array[Byte]]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.Record],(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]])Seq[(Array[Byte], Option[Array[Byte]])]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="55552">r</a>=&gt;<span title="(_1: Array[Byte], _2: Option[Array[Byte]])(Array[Byte], Option[Array[Byte]])" class="delimiter">(</span><a href="#55552" title="edu.berkeley.cs.scads.comm.Record">r</a>.<span title="=&gt; Array[Byte]">key</span>,<a href="#55552" title="edu.berkeley.cs.scads.comm.Record">r</a>.<span title="=&gt; Option[Array[Byte]]">value</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>