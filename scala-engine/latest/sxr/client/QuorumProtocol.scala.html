<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/QuorumProtocol.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.avro.marker._
<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> org.apache.avro.Schema 
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> actors.Actor
<span class="keyword">import</span> collection.mutable.<span class="delimiter">{</span> Seq =&gt; MutSeq, _ <span class="delimiter">}</span>
<span class="keyword">import</span> concurrent.ManagedBlocker

<span class="keyword">import</span> java.util.concurrent.TimeUnit

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.QuorumProtocol" id="9644">QuorumProtocol</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="40913">ZK_QUORUM_CONFIG</a> = <span title="java.lang.String(&quot;quorumProtConfig&quot;)" class="string">&quot;quorumProtConfig&quot;</span>

  <span class="keyword">val</span> <a title="Int" id="40915">BulkPutBufSize</a> = <span title="Int(1024)" class="int">1024</span>
  <span class="keyword">val</span> <a title="Int" id="40917">BulkPutMaxOutstanding</a> = <span title="Int(64)" class="int">64</span>
  <span class="keyword">val</span> <a title="Int" id="40919">BulkPutTimeout</a> = <span class="int">60</span> <span title="Int(60000)">*</span> <span class="int">1000</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class TimeoutCounter extends java.lang.Object with ScalaObject" id="9646">TimeoutCounter</a><a href="#9646" title="ScalaObject" class="delimiter">(</a><a title="Long" id="29155">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="Long" id="29152">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Long" id="29154">remaining</a>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Long" id="50849">remainingTime</a> = <a href="#29155" title="Long">timeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#29152" title="=&gt; Long">startTime</a><span class="delimiter">)</span>
    <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#50849" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span title="Long(1L)" class="int">1</span>
    <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#50849" title="Long">remainingTime</a> <span title="(x: Long)Boolean">&gt;</span> <a href="#29155" title="Long">timeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
      <a href="#29155" title="Long">timeout</a>
    <span class="keyword">else</span>
      <a href="#50849" title="Long">remainingTime</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.Protocol with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.KeyRoutable with edu.berkeley.cs.scads.storage.RecordMetadata with edu.berkeley.cs.scads.storage.GlobalMetadata with edu.berkeley.cs.scads.storage.ParFuture with ScalaObject" id="9647">QuorumProtocol</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9610" title="edu.berkeley.cs.scads.storage.Protocol">Protocol</a>
  <span class="keyword">with</span> <a href="Namespace.scala.html#9625" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9612" title="edu.berkeley.cs.scads.storage.KeyRoutable">KeyRoutable</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9620" title="edu.berkeley.cs.scads.storage.RecordMetadata">RecordMetadata</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9618" title="edu.berkeley.cs.scads.storage.GlobalMetadata">GlobalMetadata</a>
  <span class="keyword">with</span> <a href="../util/ParFuture.scala.html#9972" title="edu.berkeley.cs.scads.storage.ParFuture">ParFuture</a> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="#9644" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>._

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Option[Array[Byte]]" id="13538">getBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="40940">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51081" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</a><a href="#51080" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51081">ftchs</a>, <a href="#51080" title="Int" id="51082">quorum</a><span class="delimiter">)</span> = <a href="#13540" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int) @unchecked" class="delimiter">(</span><a href="#40940" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#13541" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><a href="#51230" title="QuorumProtocol.this.GetHandler" class="keyword">new</a> <a href="#13568" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#40940" title="Array[Byte]">key</a>, <a href="#51081" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a><span class="delimiter">)</span>, <a href="#51082" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Issues a get request but does not block the current thread waiting for
   * responses. A ScadsFuture is returned which can be used to block for
   * responses. Calls to get/apply on the ScadsFuture are idempotent - the
   * first call will cause the current thread to wait for GetResponse
   * messages, and vote on the winning record, handling the read repair in the
   * process. Subsequent calls (regardless of thread) then wait for the first
   * call to finish and piggyback off the result.
   *
   * NOTE: There *IS* a subtle difference between calling get(key) and calling
   * asyncGet(key).get(), in the case where the servers do not respond to the
   * get request. In the former case, an exception is thrown after a default
   * (for now hardcoded) timeout value expires. In the latter case, the thread
   * is blocked forever. Use with timeouts is recommended.
   *
   * NOTE: The returned future does not implement cancel
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]" id="13539">asyncGetBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="40911">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]">ScadsFuture</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51243" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</a><a href="#51242" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51243">ftchs</a>, <a href="#51242" title="Int" id="51244">quorum</a><span class="delimiter">)</span> = <a href="#13540" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int) @unchecked" class="delimiter">(</span><a href="#40911" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#51255" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" id="51255">ComputationFuture</a><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Option[Array[Byte]]" id="51279">compute</a><span class="delimiter">(</span><a title="Long" id="51281">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="51282">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#13541" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><span title="QuorumProtocol.this.GetHandler" class="keyword">new</span> <a href="#13568" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#40911" title="Array[Byte]">key</a>, <a href="#51243" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a>, <a href="#51282" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#51281" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#51244" title="Int">quorum</a><span class="delimiter">)</span>
          .<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="51280">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" id="13540">makeGetRequests</a><span class="delimiter">(</span><a title="Array[Byte]" id="51083">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51087" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51086" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51087">servers</a>, <a href="#51086" title="Int" id="51088">quorum</a><span class="delimiter">)</span> = <a href="#13565" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#51083" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRequest" id="51089">getRequest</a> = <span title="(key: Array[Byte])edu.berkeley.cs.scads.comm.GetRequest">GetRequest</span><span class="delimiter">(</span><a href="#51083" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="comment">// (ftch, quorum)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.MessageFuture], _2: Int)(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</span><a href="#51087" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#51159" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#51089" title="edu.berkeley.cs.scads.comm.GetRequest">getRequest</a><span class="delimiter">)</span>, <a href="#51088" title="Int">quorum</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]" id="13541">finishGetHandler</a><span class="delimiter">(</span><a title="QuorumProtocol.this.GetHandler" id="51192">handler</a>: <a href="#13568" title="QuorumProtocol.this.GetHandler">GetHandler</a>, <a title="Int" id="51193">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Option[Array[Byte]]]">Option</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="51410">record</a> = <a href="#51192" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51223" title="(quorum: Int)Option[Array[Byte]]">vote</a><span class="delimiter">(</span><a href="#51193" title="Int">quorum</a><span class="delimiter">)</span>
    <span title="Option[Option[Array[Byte]]]" class="keyword">if</span> <span class="delimiter">(</span><a href="#51192" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51220" title="=&gt; Boolean">failed</a><span class="delimiter">)</span> <span title="object None">None</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// TODO: repair on failed case (above) still?</span>
      <a href="#13574" title="object QuorumProtocol.this.ReadRepairer">ReadRepairer</a> <span title="(msg: Any)Unit">!</span> <a href="#51192" title="QuorumProtocol.this.GetHandler">handler</a>
      <span title="(x: Option[Array[Byte]])Some[Option[Array[Byte]]]">Some</span><span class="delimiter">(</span><a href="#51410" title="Option[Array[Byte]]">record</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13625" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.ScadsFuture[Unit]" id="13542">asyncPutBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="51618">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="51619">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Unit]">ScadsFuture</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51622" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51621" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51622">servers</a>, <a href="#51621" title="Int" id="51623">quorum</a><span class="delimiter">)</span> = <a href="#13563" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#51618" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="51624">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#51618" title="Array[Byte]">key</a>, <a href="#51619" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13622" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51625">responses</a> = <a href="Interfaces.scala.html#13616" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51618" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#51671" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#51624" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a><span class="delimiter">)</span>

    <a href="#51692" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" id="51692">ComputationFuture</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Unit" id="51696">compute</a><span class="delimiter">(</span><a title="Long" id="51698">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="51699">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <a href="#51625" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#51623" title="Int">quorum</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="keyword">def</span> <a title="=&gt; Nothing" id="51697">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])Unit" id="13543">putBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="51730">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="51731">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51734" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51733" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51734">servers</a>, <a href="#51733" title="Int" id="51735">quorum</a><span class="delimiter">)</span> = <a href="#13563" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#51730" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="51736">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#51730" title="Array[Byte]">key</a>, <a href="#51731" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13622" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51737">responses</a> = <a href="Interfaces.scala.html#13616" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51730" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#51777" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#51736" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a><span class="delimiter">)</span>
    <a href="#51737" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#51735" title="Int">quorum</a>, <span title="Long(500L)" class="int">500</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/* Buffers KV tuples until the average buffer size for all the servers is
   * greater than BufSize. Then sends the request to the servers, while
   * repeating the buffering process for the next set of KV tuples. When the
   * tuple stream runs out, or when the outstanding future collection grows
   * above a certain threshold, blocks on each of the returned
   * future collections.
   *
   * Note: the current implementation is Write All not quorum based.
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Array[Byte])Unit" id="13544">putBulkBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="43573">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Array[Byte]" id="43574">value</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51807" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51806" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51807">servers</a>, <a href="#51806" title="Int" id="51808">quorum</a><span class="delimiter">)</span> = <a href="#13563" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#43573" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="51809">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#43573" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13622" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">(</span><a href="#43574" title="Array[Byte]">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="51843">server</a> &lt;- <a href="#51807" title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; Unit)Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="51844">buf</a> = <a href="#13546" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a>.<span title="(key: edu.berkeley.cs.scads.comm.PartitionService, op: =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest])scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">getOrElseUpdate</span><span class="delimiter">(</span><a href="#51843" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">(</span><a href="#40915" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#51844" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a> <span title="(elem: edu.berkeley.cs.scads.comm.PutRequest)buf.type">+=</span> <a href="#51809" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a>

      <span class="comment">/* send the buffer when its full */</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#51844" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#40915" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span>
        <a href="#13553" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#51843" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#51844" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#13551" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#40917" title="=&gt; Int">BulkPutMaxOutstanding</a><span class="delimiter">)</span>
      <a href="#13554" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="13545">flushBulkBytes</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">/* flush any remaining send buffers */</span>
    <a href="#13546" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a>.<span title="(f: (edu.berkeley.cs.scads.comm.PartitionService, scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]) =&gt; Unit)Unit">foreach</span> <a href="#51908" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="51911">server</a>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="51912">buffer</a><span class="delimiter">)</span> =&gt; <a href="#13553" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#51911" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#51912" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buffer</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/* block until we receive responses for all sent requests */</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#13551" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <a href="#13554" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]" id="13546">serverBuffers</a> = <span title="()scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">HashMap</span><span class="delimiter">[</span>PartitionService, ArrayBuffer<span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">protected</span> case <span class="keyword">class</span> <a title="class OutstandingPut extends java.lang.Object with ScalaObject with Product with Serializable" id="51949">OutstandingPut</a><a href="#51949" title="ScalaObject" class="delimiter">(</a><a title="Long" id="52073">timestamp</a>: <span title="Long">Long</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="52074">server</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="52075">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="52076">future</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span>, <a title="Int" id="52077">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" id="13551">outstandingPuts</a> = <span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" class="keyword">new</span> collection.mutable.<span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">Queue</span><span class="delimiter">[</span>OutstandingPut<span class="delimiter">]</span>

  <span class="comment">/* send the request and append it to the list of outstanding requests */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit" id="13553">sendBuffer</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="51870">server</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="51871">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="Int" id="51874">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#51874" title="Int">tries</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(5)" class="int">5</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Retries exceeded for server %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#51870" title="edu.berkeley.cs.scads.comm.PartitionService">server</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#13551" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a> <span title="(elems: QuorumProtocol.this.OutstandingPut*)Unit">enqueue</span> <a href="#51949" title="(timestamp: Long, server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], future: edu.berkeley.cs.scads.comm.MessageFuture, tries: Int)QuorumProtocol.this.OutstandingPut">OutstandingPut</a><span class="delimiter">(</span>
      <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>,
      <a href="#51870" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>,
      <a href="#51871" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>,
      <a href="#51870" title="edu.berkeley.cs.scads.comm.PartitionService">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(records: Seq[edu.berkeley.cs.scads.comm.PutRequest])edu.berkeley.cs.scads.comm.BulkPutRequest">BulkPutRequest</span><span class="delimiter">(</span><a href="#51871" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a><span class="delimiter">)</span>,
      <a href="#51874" title="Int">tries</a><span class="delimiter">)</span>
    <a href="#13546" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a> <span title="(key: edu.berkeley.cs.scads.comm.PartitionService)QuorumProtocol.this.serverBuffers.type">-=</span> <a href="#51870" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>
  <span class="delimiter">}</span>

  <span class="comment">/* wait up to timeout for the oldest request to return if it doesn't resend it*/</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="13554">processNextOutstandingRequest</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="QuorumProtocol.this.OutstandingPut" id="52135">oldestRequest</a> = <a href="#13551" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="()QuorumProtocol.this.OutstandingPut">dequeue</span>
    <span class="keyword">val</span> <a title="Long" id="52136">remainingTime</a> = <a href="#40919" title="=&gt; Int">BulkPutTimeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52073" title="=&gt; Long">timestamp</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Long" id="52137">timeout</a> =
      <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#52136" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Long(1L)" class="int">1</span>
      <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#52136" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#40919" title="=&gt; Int">BulkPutTimeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
        <a href="#40919" title="=&gt; Long">BulkPutTimeout</a>
      <span class="keyword">else</span>
        <a href="#52136" title="Long">remainingTime</a>

    <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52076" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</span><span class="delimiter">(</span><a href="#52137" title="Long">timeout</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span>BulkPutResponse<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="52183">otherMsg</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;)" class="string">&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;</span>, <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52074" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52183" title="edu.berkeley.cs.scads.comm.MessageBody">otherMsg</a><span class="delimiter">)</span>
        <a href="#13553" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52074" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52075" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>, <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52077" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#13589" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bulkput to %s timed out. Resending.&quot;)" class="string">&quot;Bulkput to %s timed out. Resending.&quot;</span>, <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52074" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a><span class="delimiter">)</span>
        <a href="#13553" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52074" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52075" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>, <a href="#52135" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52077" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>


  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="13556">readQuorum</a>: <span title="Double">Double</span> = <span title="Double(0.0010)" class="double">0.001</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="13559">writeQuorum</a>: <span title="Double">Double</span> = <span title="Double(1.0)" class="double">1.0</span>

  <span class="comment">/** Initialization callbacks */</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="13561">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52201">config</a> = <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span><span class="delimiter">(</span><a href="#13556" title="=&gt; Double">readQuorum</a>, <a href="#13559" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13634" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40913" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#52201" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13605" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="#13561" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13607" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span> <a title="Boolean" id="52256">isNew</a> =&gt;
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52256" title="Boolean">isNew</a><span class="delimiter">)</span> <a href="#13561" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="Interfaces.scala.html#13633" title="(key: String)Option[Array[Byte]]">getMetadata</a><span class="delimiter">(</span><a href="#40913" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="52258">bytes</a><span class="delimiter">)</span> =&gt; 
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52259">config</a> = <span title="()edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span>
        <a href="#52259" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="(data: Array[Byte])config.type">parse</span><span class="delimiter">(</span><a href="#52258" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
        <a href="#13556" title="(x$1: Double)Unit">readQuorum</a>  = <a href="#52259" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Double">readQuorum</span>
        <a href="#13559" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#52259" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Double">writeQuorum</span>
      <span class="keyword">case</span> <span title="Nothing">None</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;could not find quorum protocol&quot;)" class="string">&quot;could not find quorum protocol&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#52256" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13608" title="(f: =&gt; Unit)Unit">onClose</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">// no-op </span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13609" title="(f: =&gt; Unit)Unit">onDelete</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">//deleteMetadata(ZK_QUORUM_CONFIG)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** NOT thread-safe to set */</span>
  <span class="keyword">def</span> <a title="(readQuorum: Double, writeQuorum: Double)Unit" id="13562">setReadWriteQuorum</a><span class="delimiter">(</span><a title="Double" id="52274">readQuorum</a>: <span title="Double">Double</span>, <a title="Double" id="52275">writeQuorum</a>: <span title="Double">Double</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#52274" title="Double">readQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#52274" title="Double">readQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;)" class="string">&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52274" title="Double">readQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#52275" title="Double">writeQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#52275" title="Double">writeQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;)" class="string">&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52275" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#52275" title="Double">writeQuorum</a> <span title="(x: Double)Double">+</span> <a href="#52274" title="Double">readQuorum</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read + write quorum has to be &gt;= 1 but was &quot;)" class="string">&quot;Read + write quorum has to be &gt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#52274" title="Double">readQuorum</a> <span title="(x: Double)Double">+</span> <a href="#52275" title="Double">writeQuorum</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#9647" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#13556" title="(x$1: Double)Unit">readQuorum</a> = <a href="#52274" title="Double">readQuorum</a>
    <a href="#9647" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#13559" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#52275" title="Double">writeQuorum</a>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52277">config</a> = <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span><span class="delimiter">(</span><a href="#52274" title="Double">readQuorum</a>, <a href="#52275" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13634" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40913" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#52277" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" id="13563">writeQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="51626">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52318">servers</a> = <a href="Interfaces.scala.html#13616" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51626" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span><a href="#52318" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>, scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#52318" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">size</span> <span title="(x: Double)Double">*</span> <a href="#13559" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(nbServers: Int)Int" id="13564">readQuorum</a><span class="delimiter">(</span><a title="Int" id="52251">nbServers</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#52251" title="Int">nbServers</a> <span title="(x: Double)Double">*</span> <a href="#13556" title="=&gt; Double">readQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" id="13565">readQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="51090">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52337">servers</a> = <a href="Interfaces.scala.html#13616" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51090" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span><a href="#52337" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>, <a href="#13564" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#52337" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns all value versions for a given key. Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(key: Array[Byte])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]" id="13566">getAllVersions</a><span class="delimiter">(</span><a title="Array[Byte]" id="52348">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#52351" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#52350" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52351">partitions</a>, <a href="#52350" title="Int" id="52352">quorum</a><span class="delimiter">)</span> = <a href="#13565" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#52348" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRequest" id="52353">getRequest</a> = <span title="(key: Array[Byte])edu.berkeley.cs.scads.comm.GetRequest">GetRequest</span><span class="delimiter">(</span><a href="#52348" title="Array[Byte]">key</a><span class="delimiter">)</span>

    <a href="../util/ParFuture.scala.html#13643" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#52351" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="52388">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#52388" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#52353" title="edu.berkeley.cs.scads.comm.GetRequest">getRequest</a>, <a href="#52388" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#52428" title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">{</a> 
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">(</span>GetResponse<span class="delimiter">(</span><a title="Option[Array[Byte]]" id="52467">optV</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="52468">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: Option[Array[Byte]])(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">(</span><a href="#52468" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>, <a href="#52467" title="Option[Array[Byte]]">optV</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13625" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class GetHandler extends java.lang.Object with ScalaObject" id="13568">GetHandler</a><a href="#13568" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Array[Byte]" id="51226">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51227">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="51230">timeout</a>: <span title="Long">Long</span> = <span title="Long(5000L)" class="int">5000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="51205">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>
    <a href="#51227" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#52593" title="edu.berkeley.cs.scads.comm.MessageFuture">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit">forward</span><span class="delimiter">(</span><a href="#51205" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51207">losers</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">ArrayBuffer</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span> 
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51209">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">ArrayBuffer</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="51212">winnerValue</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="51215">ctr</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="51217">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9646" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#51230" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="51220">failed</a> = <span title="Boolean(false)" class="keyword">false</span>

    <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51222">repairList</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#51207" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a>

    <span class="keyword">def</span> <a title="(quorum: Int)Option[Array[Byte]]" id="51223">vote</a><span class="delimiter">(</span><a title="Int" id="51411">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#51411" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="52729">_</a> =&gt; <a href="#51225" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#51212" title="=&gt; Option[Array[Byte]]">winnerValue</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="51224">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="52870">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#51227" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#51215" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#51225" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="51225">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#51215" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="52872">future</a> = <a href="#51205" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture">poll</span><span class="delimiter">(</span><a href="#51217" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#29154" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52872" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#51220" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <a href="#52872" title="()edu.berkeley.cs.scads.comm.MessageBody">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">GetResponse</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="52887">v</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Int" id="52888">cmp</a> = <a href="#13570" title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int">optCompareMetadata</a><span class="delimiter">(</span><a href="#51212" title="=&gt; Option[Array[Byte]]">winnerValue</a>, <a href="#52887" title="Option[Array[Byte]]">v</a><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52888" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#52872" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51207" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.losers.type">+=</span> <a href="#52900" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52888" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#51207" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a> <span title="(xs: scala.collection.TraversableOnce[edu.berkeley.cs.scads.comm.RemoteActorProxy])GetHandler.this.losers.type">++=</span> <a href="#51209" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a>
            <a href="#51209" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a>.<span title="()Unit">clear</span>
            <a href="#52872" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51209" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.winners.type">+=</span> <a href="#52925" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
            <a href="#51212" title="(x$1: Option[Array[Byte]])Unit">winnerValue</a> = <a href="#52887" title="Option[Array[Byte]]">v</a>
          <span class="delimiter">}</span><span class="keyword">else</span><span class="delimiter">{</span>
            <a href="#52872" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51209" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.winners.type">+=</span> <a href="#52939" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Nothing" id="52943">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown message &quot;)" class="string">&quot;Unknown message &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52943" title="edu.berkeley.cs.scads.comm.MessageBody">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int" id="13570">optCompareMetadata</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="52889">optLhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="52890">optRhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#52889" title="Option[Array[Byte]]">optLhs</a>, <a href="#52890" title="Option[Array[Byte]]">optRhs</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="object None">None</span>, Some<span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span>Some<span class="delimiter">(</span>_<span class="delimiter">)</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="52965">lhs</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="52967">rhs</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="Interfaces.scala.html#13623" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#52965" title="Array[Byte]">lhs</a>, <a href="#52967" title="Array[Byte]">rhs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; PartialFunction[Any,Unit]" id="13571">readRepairPF</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <a href="#13572" title="=&gt; PartialFunction[Any,Unit]">_rrpf</a> 

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="PartialFunction[Any,Unit]" id="13572">_rrpf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <a href="#52971" title="Unit" class="delimiter">{</a>
    <span class="keyword">case</span> <a title="Unit" id="52972">handler</a>: <a href="#13568" title="QuorumProtocol.this.GetHandler">GetHandler</a> =&gt;
      <a href="#13577" title="(f: =&gt; Unit)Unit">readRepairManagedBlock</a> <span class="delimiter">{</span>
        <a href="#52972" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51224" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="53044">server</a> &lt;- <a href="#52972" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51222" title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; edu.berkeley.cs.scads.comm.MessageFuture)Unit">repairList</a><span class="delimiter">)</span>
        <a href="#53044" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#52972" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51226" title="=&gt; Array[Byte]">key</a>, <a href="#52972" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51212" title="=&gt; Option[Array[Byte]]">winnerValue</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * ReadRepairer actor - calls to processRest() run in a managed blocker, so that
   * the ForkJoinPool does not starve
   * TODO: Consider replacing this read repair actor with just a standard
   * thread pool
   */</span>
  <span class="keyword">object</span> <a title="object QuorumProtocol.this.ReadRepairer" id="13574">ReadRepairer</a> <span title="ScalaObject" class="keyword">extends</span> <span title="scala.actors.Actor">Actor</span> <span class="delimiter">{</span>
    <span title="()scala.actors.Actor">start</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">/* Auto start */</span>
    
    <span class="keyword">def</span> <a title="()Unit" id="51414">act</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(body: =&gt; Unit)Unit">loop</span> <span class="delimiter">{</span>
        <span title="(handler: PartialFunction[Any,Unit])Nothing">react</span> <a href="#53055" title="Unit" class="delimiter">{</a>
          <span class="keyword">case</span> <a title="Unit" id="53056">m</a> =&gt;
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#13571" title="=&gt; PartialFunction[Any,Unit]">readRepairPF</a>.<span title="(x: Any)Boolean">isDefinedAt</span><span class="delimiter">(</span><a href="#53056" title="Any">m</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#13571" title="=&gt; PartialFunction[Any,Unit]">readRepairPF</a>.<span title="(v1: Any)Unit">apply</span><span class="delimiter">(</span><a href="#53056" title="Any">m</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown message&quot;)" class="string">&quot;Unknown message&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#53056" title="Any">m</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/** expose the scheduler for blocks */</span>
    <span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">def</span> <a title="=&gt; scala.actors.IScheduler" id="51415">getScheduler</a> = <span title="=&gt; scala.actors.IScheduler">scheduler</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Default ManagedBlocker for a function which has no means to query
   * progress
   */</span>
  <span class="keyword">class</span> <a title="class DefaultManagedBlocker extends java.lang.Object with scala.concurrent.ManagedBlocker with ScalaObject" id="13576">DefaultManagedBlocker</a><a href="#13576" title="ScalaObject" class="delimiter">(</a><a title="() =&gt; Unit" id="53105">f</a>: <span class="delimiter">(</span><span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span> <span class="keyword">extends</span> <span title="scala.concurrent.ManagedBlocker">ManagedBlocker</span> <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="53098">completed</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">def</span> <a title="()Boolean" id="53100">block</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#53105" title="()Unit">f</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#53098" title="(x$1: Boolean)Unit">completed</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="53101">isReleasable</a> = <a href="#53098" title="=&gt; Boolean">completed</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(f: =&gt; Unit)Unit" id="13577">readRepairManagedBlock</a><span class="delimiter">(</span><a title="=&gt; Unit" id="52973">f</a>: =&gt; Unit<span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#13574" title="object QuorumProtocol.this.ReadRepairer">ReadRepairer</a>.<a href="#51415" title="=&gt; scala.actors.IScheduler">getScheduler</a>.<span title="(blocker: scala.concurrent.ManagedBlocker)Unit">managedBlock</span><span class="delimiter">(</span><span title="QuorumProtocol.this.DefaultManagedBlocker" class="keyword">new</span> <a href="#13576" title="QuorumProtocol.this.DefaultManagedBlocker">DefaultManagedBlocker</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <a href="#52973" title="=&gt; Unit">f</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumRangeProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.RangeProtocol with edu.berkeley.cs.scads.storage.QuorumProtocol with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9648">QuorumRangeProtocol</a> 
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9611" title="edu.berkeley.cs.scads.storage.RangeProtocol">RangeProtocol</a>
  <span class="keyword">with</span> <a href="#9647" title="edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9616" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>

  <span class="comment">/** assumes start/end key prepopulated w/ sentinel min/max values */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" id="38006">startGetRangeRequest</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="53122">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="53123">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="53124">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="53125">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="53126">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span>Seq<span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, Seq<span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53128">partitions</a> = <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" class="keyword">if</span> <span class="delimiter">(</span><a href="#53126" title="Boolean">ascending</a><span class="delimiter">)</span> <a href="Interfaces.scala.html#13648" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#53122" title="Option[Array[Byte]]">startKey</a>, <a href="#53123" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span> <span class="keyword">else</span> <a href="Interfaces.scala.html#13648" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#53122" title="Option[Array[Byte]]">startKey</a>, <a href="#53123" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">reverse</span>

    <a href="#53124" title="Option[Int]">limit</a> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">Some</span><span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <span class="comment">/* if limit is defined, then only send a req to the first server. return a pointer to the tail of the first partition */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53136">range</a> = <a href="#53128" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53137">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53136" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27796" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53136" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27798" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53124" title="Option[Int]">limit</a>, <a href="#53125" title="Option[Int]">offset</a>, <a href="#53126" title="Boolean">ascending</a><span class="delimiter">)</span>
        <span title="(_1: Seq[edu.berkeley.cs.scads.storage.RangeDesc], _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span><a href="#53128" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>, <span title="(elems: Seq[edu.berkeley.cs.scads.comm.MessageFuture]*)Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">Seq</span><span class="delimiter">(</span><a href="#53136" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53245" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53137" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">None</span> =&gt; <span class="comment">/* if no limit is defined, then we'll have to send a request to every server. the pointer should be nil since no servers left */</span>
        <span title="(_1: scala.collection.immutable.Nil.type, _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span><span title="object Nil">Nil</span>, <a href="#53128" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],Seq[edu.berkeley.cs.scads.comm.MessageFuture],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]])Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Seq[edu.berkeley.cs.scads.comm.MessageFuture],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53290">range</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53291">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53290" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27796" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53290" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27798" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53124" title="Option[Int]">limit</a>, <a href="#53125" title="Option[Int]">offset</a>, <a href="#53126" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#53290" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53310" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53291" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">toSeq</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Finish a get range request. Ftchs are the GetRangeRequests which have
   * already been sent out, and partitions are the available servers to pull
   * data from 
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]" id="38007">finishGetRangeRequest</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53356">partitions</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">Seq</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, <a title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="53357">ftchs</a>: <span title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="53358">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="53359">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="53360">ascending</a>: <span title="Boolean">Boolean</span>, <a title="Option[Long]" id="53361">timeout</a>: <span title="Option[Long]">Option</span><span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>

    <span class="keyword">def</span> <a title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle" id="53363">newRangeHandle</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53369">ftchs</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">)</span> = 
      <a href="#53361" title="Option[Long]">timeout</a>.<span title="(f: Long =&gt; QuorumRangeProtocol.this.RangeHandle)Option[QuorumRangeProtocol.this.RangeHandle]">map</span><span class="delimiter">(</span><a title="Long" id="53374">t</a> =&gt; <span title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</span> <a href="#38014" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#53369" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a>, <a href="#53374" title="Long">t</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; QuorumRangeProtocol.this.RangeHandle)QuorumRangeProtocol.this.RangeHandle">getOrElse</span><span class="delimiter">(</span><a href="#53410" title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</a> <a href="#38014" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#53369" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]" id="53364">handlers</a> = <a href="#53357" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>.<span title="(f: Seq[edu.berkeley.cs.scads.comm.MessageFuture] =&gt; QuorumRangeProtocol.this.RangeHandle)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]],QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]])Seq[QuorumRangeProtocol.this.RangeHandle]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]]" class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53435">x</a> =&gt; <a href="#53363" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#53435" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">x</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">toBuffer</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" id="53365">result</a> = <span title="()scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">ArrayBuffer</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Long" id="53366">openRec</a> = <a href="#53358" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Long)Option[Long]">map</span><span class="delimiter">(</span><a href="#53479" title="Int">_</a>.<span title="=&gt; Long">toLong</span><span class="delimiter">)</span>.<span title="(default: =&gt; Long)Long">getOrElse</span><span class="delimiter">(</span>java.lang.Long.<span title="Long(9223372036854775807L)">MAX_VALUE</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53367">servers</a> = <a href="#53356" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>
    <span class="keyword">var</span> <a title="Int" id="53368">cur</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="QuorumRangeProtocol.this.RangeHandle" id="53531">handler</a> &lt;- <a href="#53364" title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Unit)Unit">handlers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53366" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53536">records</a> = <a href="#53531" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53403" title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">vote</a><span class="delimiter">(</span><a href="#13564" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#53531" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53407" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53531" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53398" title="=&gt; Boolean">failed</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;)" class="string">&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;</span><span class="delimiter">)</span>
        <span class="comment">//if we do not get enough records, we request more, before we process the current batch</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53536" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="=&gt; Int">length</span> <span title="(x: Long)Boolean">&lt;=</span> <a href="#53366" title="Long">openRec</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#53367" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53558">range</a> = <a href="#53367" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
          <span class="keyword">val</span> <a title="Option[Int]" id="53559">newLimit</a> = <span title="Option[Int]" class="keyword">if</span><span class="delimiter">(</span><a href="#53358" title="Option[Int]">limit</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#53366" title="Long">openRec</a>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span> <span class="keyword">else</span> <span title="object None">None</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53560">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53558" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27796" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53558" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27798" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53559" title="Option[Int]">newLimit</a>, <a href="#53359" title="Option[Int]">offset</a>, <a href="#53360" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#53364" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(elems: QuorumRangeProtocol.this.RangeHandle*)Unit">append</span><span class="delimiter">(</span><a href="#53363" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#53558" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53595" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53560" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#53367" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a> = <a href="#53367" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>
        <span class="delimiter">}</span>
        <a href="#53365" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>.<span title="(xs: scala.collection.TraversableOnce[(Array[Byte], Array[Byte])])Unit">appendAll</span><span class="delimiter">(</span><a href="#53536" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; scala.collection.GenTraversableOnce[(Array[Byte], Array[Byte])])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record],(Array[Byte], Array[Byte]),scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]])scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer.Coll,(Array[Byte], Array[Byte]),scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="53633">rec</a> =&gt;
          <span title="List[(Array[Byte], Array[Byte])]" class="keyword">if</span> <span class="delimiter">(</span><a href="#53366" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#53366" title="Long">openRec</a> <span title="(x: Int)Long">-=</span> <span title="Int(1)" class="int">1</span>
            <a href="#53633" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="(f: Array[Byte] =&gt; (Array[Byte], Array[Byte]))Option[(Array[Byte], Array[Byte])]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="53646">v</a> =&gt; <span title="(_1: Array[Byte], _2: Array[Byte])(Array[Byte], Array[Byte])" class="delimiter">(</span><a href="#53633" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Array[Byte]">key</span>, <a href="Interfaces.scala.html#13625" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">(</span><a href="#53646" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[(Array[Byte], Array[Byte])]">toList</span>
          <span class="delimiter">}</span> <span class="keyword">else</span>
            <span title="object Nil">Nil</span>
          <span class="delimiter">)</span>
        <span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#53364" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#13574" title="object QuorumRangeProtocol.this.ReadRepairer">ReadRepairer</a> <span title="(msg: Any)Unit">!</span> <a href="#54034" title="QuorumRangeProtocol.this.RangeHandle">_</a><span class="delimiter">)</span>
    <a href="#53365" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[(Array[Byte], Array[Byte])]" id="38008">getKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="54038">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Array[Byte]]" id="54039">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="54040">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="54041">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Boolean" id="54042">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#54045" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</a><a href="#54044" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54045">ptr</a>, <a href="#54044" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="54046">ftchs</a><span class="delimiter">)</span> = <a href="#38006" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]) @unchecked" class="delimiter">(</span><a href="#54038" title="Option[Array[Byte]]">start</a>, <a href="#54039" title="Option[Array[Byte]]">end</a>, <a href="#54040" title="Option[Int]">limit</a>, <a href="#54041" title="Option[Int]">offset</a>, <a href="#54042" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#38007" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#54045" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#54046" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>, <a href="#54040" title="Option[Int]">limit</a>, <a href="#54041" title="Option[Int]">offset</a>, <a href="#54042" title="Boolean">ascending</a>, <span title="object None">None</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]" id="38009">asyncGetKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="54057">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="54058">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="54059">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="54060">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="54061">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#54064" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</a><a href="#54063" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54064">ptr</a>, <a href="#54063" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="54065">ftchs</a><span class="delimiter">)</span> = <a href="#38006" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]) @unchecked" class="delimiter">(</span><a href="#54057" title="Option[Array[Byte]]">start</a>, <a href="#54058" title="Option[Array[Byte]]">end</a>, <a href="#54059" title="Option[Int]">limit</a>, <a href="#54060" title="Option[Int]">offset</a>, <a href="#54061" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#54076" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" id="54076">ComputationFuture</a><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Seq[(Array[Byte], Array[Byte])]" id="54080">compute</a><span class="delimiter">(</span><a title="Long" id="54082">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="54083">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#38007" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#54064" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#54065" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>, <a href="#54059" title="Option[Int]">limit</a>, <a href="#54060" title="Option[Int]">offset</a>, <a href="#54061" title="Boolean">ascending</a>, <span title="(x: Long)Some[Long]">Some</span><span class="delimiter">(</span><a href="#54083" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#54082" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="54081">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; PartialFunction[Any,Unit]" id="38010">readRepairPF</a> = <a href="#38011" title="=&gt; PartialFunction[Any,Unit]">_rrpf</a> 

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="PartialFunction[Any,Unit]" id="38011">_rrpf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="PartialFunction[Any,Unit]" id="54099">pf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <a href="#54101" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <a title="Unit" id="54102">handler</a>: <a href="#38014" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a> =&gt;
        <a href="#13577" title="(f: =&gt; Unit)Unit">readRepairManagedBlock</a> <span class="delimiter">{</span>
          <a href="#54102" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53404" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="Array[Byte]" id="54257">key</a>, <span class="delimiter">(</span><a title="Array[Byte]" id="54260">data</a>, <a title="List[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="54261">servers</a><span class="delimiter">)</span><span class="delimiter">)</span> &lt;- <a href="#54102" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53386" title="(f: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])) =&gt; Unit)Unit">losers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54292">server</a> &lt;- <a href="#54261" title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; edu.berkeley.cs.scads.comm.MessageFuture)Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#54292" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#54257" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#54260" title="Array[Byte]">data</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#54099" title="PartialFunction[Any,Unit]">pf</a>.<span title="(that: PartialFunction[Any,Unit])PartialFunction[Any,Unit]">orElse</span><span class="delimiter">(</span><a href="#9648" title="edu.berkeley.cs.scads.storage.QuorumRangeProtocol" class="keyword">super</a>.<a href="#13571" title="=&gt; PartialFunction[Any,Unit]">readRepairPF</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Tests the range for conflicts and marks all violations for future resolution.
   * This class is optimized for none/few violations.
   */</span>
  <span class="keyword">class</span> <a title="class RangeHandle extends java.lang.Object with ScalaObject" id="38014">RangeHandle</a><a href="#38014" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53407">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="53410">timeout</a>: <span title="Long">Long</span> = <span title="Long(100000L)" class="int">100000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="53382">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9646" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#53410" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="53384">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>
    <a href="#53407" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#54418" title="edu.berkeley.cs.scads.comm.MessageFuture">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit">forward</span><span class="delimiter">(</span><a href="#53384" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// TODO: hashing on byte array like this is no good. this should be redone</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]" id="53386">losers</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, List<span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53388">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>

    <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="53391">baseServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</span> = <span title="Null(null)" class="keyword">null</span> <span class="comment">//The whole comparison is based on the first response</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="53393">winnerExceptions</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, RemoteActorProxy<span class="delimiter">]</span>

    <span class="keyword">val</span> <a title="Long" id="53395">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">var</span> <a title="Boolean" id="53398">failed</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="53401">ctr</a> = <span title="Int(0)" class="int">0</span>

    <span class="keyword">def</span> <a title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53403">vote</a><span class="delimiter">(</span><a title="Int" id="53537">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#53537" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="54519">_</a> =&gt; <a href="#53405" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#53388" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="53404">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="54208">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#53407" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#53401" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#53405" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="53405">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#53401" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="54521">future</a> = <a href="#53384" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture">poll</span><span class="delimiter">(</span><a href="#53382" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#29154" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#54521" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#53398" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54522">result</a> = <a href="#54521" title="()edu.berkeley.cs.scads.comm.MessageBody">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Seq[edu.berkeley.cs.scads.comm.Record]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Seq[edu.berkeley.cs.scads.comm.Record]">GetRangeResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54572">v</a><span class="delimiter">)</span> =&gt; <a href="#54572" title="Seq[edu.berkeley.cs.scads.comm.Record]">v</a>
        <span class="keyword">case</span> <a title="Nothing" id="54573">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message (was expecting GetRangeResponse): &quot;)" class="string">&quot;Unexpected Message (was expecting GetRangeResponse): &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#54573" title="edu.berkeley.cs.scads.comm.MessageBody">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53388" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">//println(&quot;first result &quot; + result.map(a =&gt; QuorumProtocol.this.deserializeKey(a.key)))</span>
        <a href="#53388" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(n: Int, seq: Traversable[edu.berkeley.cs.scads.comm.Record])Unit">insertAll</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <a href="#54522" title="Seq[edu.berkeley.cs.scads.comm.Record]">result</a><span class="delimiter">)</span>
        <a href="#53391" title="(x$1: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">baseServer</a> = <a href="#54521" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">get</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#53406" title="(newRecords: Seq[edu.berkeley.cs.scads.comm.Record], newServer: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">merge</a><span class="delimiter">(</span><a href="#54522" title="Seq[edu.berkeley.cs.scads.comm.Record]">result</a>, <a href="#54521" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">get</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(newRecords: Seq[edu.berkeley.cs.scads.comm.Record], newServer: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit" id="53406">merge</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54605">newRecords</a>: <span title="Seq[edu.berkeley.cs.scads.comm.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54606">newServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54608">recordPtr</a> = <a href="#54605" title="Seq[edu.berkeley.cs.scads.comm.Record]">newRecords</a>
      <span class="keyword">var</span> <a title="Int" id="54609">i</a> = <span title="Int(0)" class="int">0</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#54609" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#53388" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="=&gt; Int">length</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#54610" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54620">winnerKey</a> = <a href="#53388" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54609" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">key</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54621">newKey</a> = <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Array[Byte]">key</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#53388" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54609" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="comment">//should always be defined if we get data back, otherwise delete might not work</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54622">winnerValue</a> = <a href="#53388" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54609" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54623">newValue</a> = <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span>
        <a href="Interfaces.scala.html#13620" title="(x: Array[Byte], y: Array[Byte])Int">compareKey</a><span class="delimiter">(</span><a href="#54620" title="Array[Byte]">winnerKey</a>, <a href="#54621" title="Array[Byte]">newKey</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="54668">cmp</a> <span class="keyword">if</span> <a href="#54668" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> =&gt;
            <a href="#54609" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="Interfaces.scala.html#13623" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#54622" title="Array[Byte]">winnerValue</a>, <a href="#54623" title="Array[Byte]">newValue</a><span class="delimiter">)</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">-</span><span class="int">1</span> =&gt; <span class="delimiter">{</span>
                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54677">outdatedServer</a> = <a href="#53393" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a>.<span title="(key: Array[Byte], default: =&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy)edu.berkeley.cs.scads.comm.RemoteActorProxy">getOrElse</span><span class="delimiter">(</span><a href="#54620" title="Array[Byte]">winnerKey</a>, <a href="#53391" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">baseServer</a><span class="delimiter">)</span>
                <a href="#53386" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])))RangeHandle.this.losers.type">+=</span> <a href="#54620" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))">-&gt;</span> <span class="delimiter">(</span><a href="#54623" title="Array[Byte]">newValue</a>, <a href="#54677" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">outdatedServer</a> <a href="#54727" title="(x: edu.berkeley.cs.scads.comm.RemoteActorProxy)List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">::</a> <a href="#53386" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])">getOrElse</span><span class="delimiter">(</span><a href="#54620" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">_2</span><span class="delimiter">)</span>
                <a href="#53393" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#54620" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteActorProxy)(Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy)">-&gt;</span> <a href="#54606" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a>
                <a href="#53388" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(idx: Int, elem: edu.berkeley.cs.scads.comm.Record)Unit">update</span><span class="delimiter">(</span><a href="#54609" title="Int">i</a>, <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="RangeHandle.this.losers.type" class="int">1</span> =&gt; <span class="delimiter">{</span>
                <a href="#53386" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])))RangeHandle.this.losers.type">+=</span> <a href="#54620" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))">-&gt;</span> <span class="delimiter">(</span><a href="#54622" title="Array[Byte]">winnerValue</a>, <a href="#54606" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a> <a href="#54821" title="(x: edu.berkeley.cs.scads.comm.RemoteActorProxy)List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">::</a> <a href="#53386" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])">getOrElse</span><span class="delimiter">(</span><a href="#54620" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">_2</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a> = <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">tail</span>
            <a href="#54609" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <a title="Unit" id="54858">cmp</a> <span class="keyword">if</span> <a href="#54858" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="#53388" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(n: Int, elems: edu.berkeley.cs.scads.comm.Record*)Unit">insert</span><span class="delimiter">(</span><a href="#54609" title="Int">i</a>, <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span><span class="delimiter">)</span>
            <a href="#54609" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span> <span class="comment">//because of the insert</span>
            <a href="#53393" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#54621" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">newKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteActorProxy)(Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy)">-&gt;</span> <a href="#54606" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a>
            <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a> = <a href="#54608" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">tail</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="delimiter">}</span>
 
  <span class="comment">/*
   * NB: We trust the caller here that the records produced from the given locations will
   * all have keys in between firstKey and lastKey.  Therefore we just check that
   * firstKey&lt;-&gt;lastKey only covers one partition
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(parser: edu.berkeley.cs.scads.storage.RecParser, locations: Array[String], firstKey: Option[Array[Byte]], lastKey: Option[Array[Byte]])Unit" id="38016">putBulkLocations</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecParser" id="54896">parser</a>:<a href="../server/PartitionHandler.scala.html#9812" title="edu.berkeley.cs.scads.storage.RecParser">RecParser</a>,<a title="Array[String]" id="54897">locations</a>:<span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
                                <a title="Option[Array[Byte]]" id="54898">firstKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,<a title="Option[Array[Byte]]" id="54899">lastKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54901">partitions</a> = <a href="Interfaces.scala.html#13648" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#54898" title="Option[Array[Byte]]">firstKey</a>, <a href="#54899" title="Option[Array[Byte]]">lastKey</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#54901" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Can\'t bulk put locations over more than one partition&quot;)" class="string">&quot;Can't bulk put locations over more than one partition&quot;</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="54906">baos</a> = <span title="java.io.ByteArrayOutputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span>
      <span class="keyword">val</span> <a title="java.io.ObjectOutputStream" id="54907">oos</a> = <span title="java.io.ObjectOutputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectOutputStream">ObjectOutputStream</span><span class="delimiter">(</span><a href="#54906" title="java.io.ByteArrayOutputStream">baos</a><span class="delimiter">)</span>
      <a href="#54907" title="java.io.ObjectOutputStream">oos</a>.<span title="(x$1: Any)Unit">writeObject</span><span class="delimiter">(</span><a href="#54896" title="edu.berkeley.cs.scads.storage.RecParser">parser</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="54908">responses</a> = <a href="#54901" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#27800" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#54938" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(parser: Array[Byte], locations: Seq[String])edu.berkeley.cs.scads.comm.BulkUrlPutReqest">BulkUrlPutReqest</span><span class="delimiter">(</span><a href="#54906" title="java.io.ByteArrayOutputStream">baos</a>.<span title="()Array[Byte]">toByteArray</span>,<a href="#54897" title="(xs: Array[String])scala.collection.mutable.WrappedArray[String]">locations</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#54908" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#54901" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#27800" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get all value versions for a range of keys.  Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]" id="38017">getAllRangeVersions</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="55032">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="55033">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>,Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="55035">partitions</a> = <a href="Interfaces.scala.html#13648" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#55032" title="Option[Array[Byte]]">startKey</a>, <a href="#55033" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13643" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">waitForAndThrowException</a><span class="delimiter">(</span>
      <a href="#55035" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; scala.collection.GenTraversableOnce[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="55058">range</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="55059">rangeReq</a> = <span title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#55058" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27796" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#55058" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27798" title="=&gt; Option[Array[Byte]]">endKey</a>, <span title="object None">None</span>, <span title="object None">None</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
        <a href="#55058" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="55086">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#55086" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#55059" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeReq</a>, <a href="#55086" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span> 
      <span class="delimiter">}</span><span class="delimiter">)</span> 
    <span class="delimiter">)</span> <a href="#55143" title="(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">{</a>    
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span>GetRangeResponse<span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="55147">recs</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="55148">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: Seq[(Array[Byte], Option[Array[Byte]])])(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span><a href="#55148" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>, <a href="#55147" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; (Array[Byte], Option[Array[Byte]]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.Record],(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]])Seq[(Array[Byte], Option[Array[Byte]])]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="55174">r</a>=&gt;<span title="(_1: Array[Byte], _2: Option[Array[Byte]])(Array[Byte], Option[Array[Byte]])" class="delimiter">(</span><a href="#55174" title="edu.berkeley.cs.scads.comm.Record">r</a>.<span title="=&gt; Array[Byte]">key</span>,<a href="#55174" title="edu.berkeley.cs.scads.comm.Record">r</a>.<span title="=&gt; Option[Array[Byte]]">value</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>