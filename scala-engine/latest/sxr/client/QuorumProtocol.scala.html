<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/QuorumProtocol.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.avro.marker._
<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> org.apache.avro.Schema 
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> actors.Actor
<span class="keyword">import</span> collection.mutable.<span class="delimiter">{</span> Seq =&gt; MutSeq, _ <span class="delimiter">}</span>
<span class="keyword">import</span> concurrent.ManagedBlocker

<span class="keyword">import</span> java.util.concurrent.TimeUnit

<span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.QuorumProtocol" id="9642">QuorumProtocol</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="40917">ZK_QUORUM_CONFIG</a> = <span title="java.lang.String(&quot;quorumProtConfig&quot;)" class="string">&quot;quorumProtConfig&quot;</span>

  <span class="keyword">val</span> <a title="Int" id="40919">BulkPutBufSize</a> = <span title="Int(1024)" class="int">1024</span>
  <span class="keyword">val</span> <a title="Int" id="40921">BulkPutMaxOutstanding</a> = <span title="Int(64)" class="int">64</span>
  <span class="keyword">val</span> <a title="Int" id="40923">BulkPutTimeout</a> = <span class="int">60</span> <span title="Int(60000)">*</span> <span class="int">1000</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class TimeoutCounter extends java.lang.Object with ScalaObject" id="9644">TimeoutCounter</a><a href="#9644" title="ScalaObject" class="delimiter">(</a><a title="Long" id="29159">timeout</a>: <span title="Long">Long</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="Long" id="29156">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; Long" id="29158">remaining</a>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Long" id="50853">remainingTime</a> = <a href="#29159" title="Long">timeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#29156" title="=&gt; Long">startTime</a><span class="delimiter">)</span>
    <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#50853" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span title="Long(1L)" class="int">1</span>
    <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#50853" title="Long">remainingTime</a> <span title="(x: Long)Boolean">&gt;</span> <a href="#29159" title="Long">timeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
      <a href="#29159" title="Long">timeout</a>
    <span class="keyword">else</span>
      <a href="#50853" title="Long">remainingTime</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.Protocol with edu.berkeley.cs.scads.storage.Namespace with edu.berkeley.cs.scads.storage.KeyRoutable with edu.berkeley.cs.scads.storage.RecordMetadata with edu.berkeley.cs.scads.storage.GlobalMetadata with edu.berkeley.cs.scads.storage.ParFuture with ScalaObject" id="9645">QuorumProtocol</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9608" title="edu.berkeley.cs.scads.storage.Protocol">Protocol</a>
  <span class="keyword">with</span> <a href="Namespace.scala.html#9623" title="edu.berkeley.cs.scads.storage.Namespace">Namespace</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9610" title="edu.berkeley.cs.scads.storage.KeyRoutable">KeyRoutable</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9618" title="edu.berkeley.cs.scads.storage.RecordMetadata">RecordMetadata</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9616" title="edu.berkeley.cs.scads.storage.GlobalMetadata">GlobalMetadata</a>
  <span class="keyword">with</span> <a href="../util/ParFuture.scala.html#9974" title="edu.berkeley.cs.scads.storage.ParFuture">ParFuture</a> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="#9642" title="object edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>._

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Option[Array[Byte]]" id="13542">getBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="40944">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51085" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</a><a href="#51084" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51085">ftchs</a>, <a href="#51084" title="Int" id="51086">quorum</a><span class="delimiter">)</span> = <a href="#13544" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int) @unchecked" class="delimiter">(</span><a href="#40944" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#13545" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><a href="#51234" title="QuorumProtocol.this.GetHandler" class="keyword">new</a> <a href="#13572" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#40944" title="Array[Byte]">key</a>, <a href="#51085" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a><span class="delimiter">)</span>, <a href="#51086" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Issues a get request but does not block the current thread waiting for
   * responses. A ScadsFuture is returned which can be used to block for
   * responses. Calls to get/apply on the ScadsFuture are idempotent - the
   * first call will cause the current thread to wait for GetResponse
   * messages, and vote on the winning record, handling the read repair in the
   * process. Subsequent calls (regardless of thread) then wait for the first
   * call to finish and piggyback off the result.
   *
   * NOTE: There *IS* a subtle difference between calling get(key) and calling
   * asyncGet(key).get(), in the case where the servers do not respond to the
   * get request. In the former case, an exception is thrown after a default
   * (for now hardcoded) timeout value expires. In the latter case, the thread
   * is blocked forever. Use with timeouts is recommended.
   *
   * NOTE: The returned future does not implement cancel
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]" id="13543">asyncGetBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="40915">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Option[Array[Byte]]]">ScadsFuture</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51247" title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</a><a href="#51246" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51247">ftchs</a>, <a href="#51246" title="Int" id="51248">quorum</a><span class="delimiter">)</span> = <a href="#13544" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)">makeGetRequests</a><span title="(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int) @unchecked" class="delimiter">(</span><a href="#40915" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <a href="#51259" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Option[Array[Byte]]]" id="51259">ComputationFuture</a><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Option[Array[Byte]]" id="51283">compute</a><span class="delimiter">(</span><a title="Long" id="51285">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="51286">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#13545" title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]">finishGetHandler</a><span class="delimiter">(</span><span title="QuorumProtocol.this.GetHandler" class="keyword">new</span> <a href="#13572" title="QuorumProtocol.this.GetHandler">GetHandler</a><span class="delimiter">(</span><a href="#40915" title="Array[Byte]">key</a>, <a href="#51247" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a>, <a href="#51286" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#51285" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#51248" title="Int">quorum</a><span class="delimiter">)</span>
          .<span title="(default: =&gt; Option[Array[Byte]])Option[Array[Byte]]">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Could not complete get request - not enough servers responded&quot;)" class="string">&quot;Could not complete get request - not enough servers responded&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="51284">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" id="13544">makeGetRequests</a><span class="delimiter">(</span><a title="Array[Byte]" id="51087">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51091" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51090" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51091">servers</a>, <a href="#51090" title="Int" id="51092">quorum</a><span class="delimiter">)</span> = <a href="#13569" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#51087" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRequest" id="51093">getRequest</a> = <span title="(key: Array[Byte])edu.berkeley.cs.scads.comm.GetRequest">GetRequest</span><span class="delimiter">(</span><a href="#51087" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="comment">// (ftch, quorum)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.MessageFuture], _2: Int)(Seq[edu.berkeley.cs.scads.comm.MessageFuture], Int)" class="delimiter">(</span><a href="#51091" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#51163" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#51093" title="edu.berkeley.cs.scads.comm.GetRequest">getRequest</a><span class="delimiter">)</span>, <a href="#51092" title="Int">quorum</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: QuorumProtocol.this.GetHandler, quorum: Int)Option[Option[Array[Byte]]]" id="13545">finishGetHandler</a><span class="delimiter">(</span><a title="QuorumProtocol.this.GetHandler" id="51196">handler</a>: <a href="#13572" title="QuorumProtocol.this.GetHandler">GetHandler</a>, <a title="Int" id="51197">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Option[Array[Byte]]]">Option</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="51414">record</a> = <a href="#51196" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51227" title="(quorum: Int)Option[Array[Byte]]">vote</a><span class="delimiter">(</span><a href="#51197" title="Int">quorum</a><span class="delimiter">)</span>
    <span title="Option[Option[Array[Byte]]]" class="keyword">if</span> <span class="delimiter">(</span><a href="#51196" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51224" title="=&gt; Boolean">failed</a><span class="delimiter">)</span> <span title="object None">None</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// TODO: repair on failed case (above) still?</span>
      <a href="#13578" title="object QuorumProtocol.this.ReadRepairer">ReadRepairer</a> <span title="(msg: Any)Unit">!</span> <a href="#51196" title="QuorumProtocol.this.GetHandler">handler</a>
      <span title="(x: Option[Array[Byte]])Some[Option[Array[Byte]]]">Some</span><span class="delimiter">(</span><a href="#51414" title="Option[Array[Byte]]">record</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13629" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.ScadsFuture[Unit]" id="13546">asyncPutBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="51622">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="51623">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Unit]">ScadsFuture</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51626" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51625" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51626">servers</a>, <a href="#51625" title="Int" id="51627">quorum</a><span class="delimiter">)</span> = <a href="#13567" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#51622" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="51628">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#51622" title="Array[Byte]">key</a>, <a href="#51623" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13626" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51629">responses</a> = <a href="Interfaces.scala.html#13620" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51622" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#51675" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#51628" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a><span class="delimiter">)</span>

    <a href="#51696" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Unit]" id="51696">ComputationFuture</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Unit" id="51700">compute</a><span class="delimiter">(</span><a title="Long" id="51702">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="51703">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <a href="#51629" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#51627" title="Int">quorum</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="keyword">def</span> <a title="=&gt; Nothing" id="51701">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])Unit" id="13547">putBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="51734">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="51735">value</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51738" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51737" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51738">servers</a>, <a href="#51737" title="Int" id="51739">quorum</a><span class="delimiter">)</span> = <a href="#13567" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#51734" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="51740">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#51734" title="Array[Byte]">key</a>, <a href="#51735" title="Option[Array[Byte]]">value</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13626" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51741">responses</a> = <a href="Interfaces.scala.html#13620" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51734" title="Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#51781" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#51740" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a><span class="delimiter">)</span>
    <a href="#51741" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int, timeout: Long, unit: java.util.concurrent.TimeUnit)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#51739" title="Int">quorum</a>, <span title="Long(500L)" class="int">500</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/* Buffers KV tuples until the average buffer size for all the servers is
   * greater than BufSize. Then sends the request to the servers, while
   * repeating the buffering process for the next set of KV tuples. When the
   * tuple stream runs out, or when the outstanding future collection grows
   * above a certain threshold, blocks on each of the returned
   * future collections.
   *
   * Note: the current implementation is Write All not quorum based.
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte], value: Array[Byte])Unit" id="13548">putBulkBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="43577">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Array[Byte]" id="43578">value</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#51811" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#51810" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="51811">servers</a>, <a href="#51810" title="Int" id="51812">quorum</a><span class="delimiter">)</span> = <a href="#13567" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">writeQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#43577" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.PutRequest" id="51813">putRequest</a> = <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#43577" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13626" title="(rec: Array[Byte])Array[Byte]">createMetadata</a><span class="delimiter">(</span><a href="#43578" title="Array[Byte]">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="51847">server</a> &lt;- <a href="#51811" title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; Unit)Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="51848">buf</a> = <a href="#13550" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a>.<span title="(key: edu.berkeley.cs.scads.comm.PartitionService, op: =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest])scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">getOrElseUpdate</span><span class="delimiter">(</span><a href="#51847" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">(</span><a href="#40919" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#51848" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a> <span title="(elem: edu.berkeley.cs.scads.comm.PutRequest)buf.type">+=</span> <a href="#51813" title="edu.berkeley.cs.scads.comm.PutRequest">putRequest</a>

      <span class="comment">/* send the buffer when its full */</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#51848" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#40919" title="=&gt; Int">BulkPutBufSize</a><span class="delimiter">)</span>
        <a href="#13557" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#51847" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#51848" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buf</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#13555" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#40921" title="=&gt; Int">BulkPutMaxOutstanding</a><span class="delimiter">)</span>
      <a href="#13558" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="13549">flushBulkBytes</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">/* flush any remaining send buffers */</span>
    <a href="#13550" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a>.<span title="(f: (edu.berkeley.cs.scads.comm.PartitionService, scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]) =&gt; Unit)Unit">foreach</span> <a href="#51912" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="51915">server</a>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="51916">buffer</a><span class="delimiter">)</span> =&gt; <a href="#13557" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#51915" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#51916" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">buffer</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/* block until we receive responses for all sent requests */</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#13555" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <a href="#13558" title="=&gt; Unit">processNextOutstandingRequest</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]" id="13550">serverBuffers</a> = <span title="()scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">HashMap</span><span class="delimiter">[</span>PartitionService, ArrayBuffer<span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">protected</span> case <span class="keyword">class</span> <a title="class OutstandingPut extends java.lang.Object with ScalaObject with Product with Serializable" id="51953">OutstandingPut</a><a href="#51953" title="ScalaObject" class="delimiter">(</a><a title="Long" id="52077">timestamp</a>: <span title="Long">Long</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="52078">server</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="52079">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="52080">future</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span>, <a title="Int" id="52081">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" id="13555">outstandingPuts</a> = <span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]" class="keyword">new</span> collection.mutable.<span title="scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">Queue</span><span class="delimiter">[</span>OutstandingPut<span class="delimiter">]</span>

  <span class="comment">/* send the request and append it to the list of outstanding requests */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit" id="13557">sendBuffer</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="51874">server</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]" id="51875">sendBuffer</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">ArrayBuffer</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span>, <a title="Int" id="51878">tries</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#51878" title="Int">tries</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(5)" class="int">5</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Retries exceeded for server %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#51874" title="edu.berkeley.cs.scads.comm.PartitionService">server</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#13555" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a> <span title="(elems: QuorumProtocol.this.OutstandingPut*)Unit">enqueue</span> <a href="#51953" title="(timestamp: Long, server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], future: edu.berkeley.cs.scads.comm.MessageFuture, tries: Int)QuorumProtocol.this.OutstandingPut">OutstandingPut</a><span class="delimiter">(</span>
      <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>,
      <a href="#51874" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>,
      <a href="#51875" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>,
      <a href="#51874" title="edu.berkeley.cs.scads.comm.PartitionService">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(records: Seq[edu.berkeley.cs.scads.comm.PutRequest])edu.berkeley.cs.scads.comm.BulkPutRequest">BulkPutRequest</span><span class="delimiter">(</span><a href="#51875" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a><span class="delimiter">)</span>,
      <a href="#51878" title="Int">tries</a><span class="delimiter">)</span>
    <a href="#13550" title="=&gt; scala.collection.mutable.HashMap[edu.berkeley.cs.scads.comm.PartitionService,scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]]">serverBuffers</a> <span title="(key: edu.berkeley.cs.scads.comm.PartitionService)QuorumProtocol.this.serverBuffers.type">-=</span> <a href="#51874" title="edu.berkeley.cs.scads.comm.PartitionService">server</a>
  <span class="delimiter">}</span>

  <span class="comment">/* wait up to timeout for the oldest request to return if it doesn't resend it*/</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Unit" id="13558">processNextOutstandingRequest</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="QuorumProtocol.this.OutstandingPut" id="52139">oldestRequest</a> = <a href="#13555" title="=&gt; scala.collection.mutable.Queue[QuorumProtocol.this.OutstandingPut]">outstandingPuts</a>.<span title="()QuorumProtocol.this.OutstandingPut">dequeue</span>
    <span class="keyword">val</span> <a title="Long" id="52140">remainingTime</a> = <a href="#40923" title="=&gt; Int">BulkPutTimeout</a> <span title="(x: Long)Long">-</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52077" title="=&gt; Long">timestamp</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Long" id="52141">timeout</a> =
      <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#52140" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <span title="Long(1L)" class="int">1</span>
      <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#52140" title="Long">remainingTime</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#40923" title="=&gt; Int">BulkPutTimeout</a><span class="delimiter">)</span> <span class="comment">/* handle ec2 timeskips */</span>
        <a href="#40923" title="=&gt; Long">BulkPutTimeout</a>
      <span class="keyword">else</span>
        <a href="#52140" title="Long">remainingTime</a>

    <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52080" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</span><span class="delimiter">(</span><a href="#52141" title="Long">timeout</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span>BulkPutResponse<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="52187">otherMsg</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;)" class="string">&quot;Received unexpected message for bulk put to %s: %s. Resending&quot;</span>, <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52078" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52187" title="edu.berkeley.cs.scads.comm.MessageBody">otherMsg</a><span class="delimiter">)</span>
        <a href="#13557" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52078" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52079" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>, <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52081" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="delimiter">{</span>
        <a href="Namespace.scala.html#13593" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Bulkput to %s timed out. Resending.&quot;)" class="string">&quot;Bulkput to %s timed out. Resending.&quot;</span>, <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52078" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a><span class="delimiter">)</span>
        <a href="#13557" title="(server: edu.berkeley.cs.scads.comm.PartitionService, sendBuffer: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest], tries: Int)Unit">sendBuffer</a><span class="delimiter">(</span><a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52078" title="=&gt; edu.berkeley.cs.scads.comm.PartitionService">server</a>, <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52079" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.PutRequest]">sendBuffer</a>, <a href="#52139" title="QuorumProtocol.this.OutstandingPut">oldestRequest</a>.<a href="#52081" title="=&gt; Int">tries</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>


  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="13560">readQuorum</a>: <span title="Double">Double</span> = <span title="Double(0.0010)" class="double">0.001</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Double" id="13563">writeQuorum</a>: <span title="Double">Double</span> = <span title="Double(1.0)" class="double">1.0</span>

  <span class="comment">/** Initialization callbacks */</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="13565">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52205">config</a> = <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span><span class="delimiter">(</span><a href="#13560" title="=&gt; Double">readQuorum</a>, <a href="#13563" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13638" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40917" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#52205" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13609" title="(f: =&gt; Unit)Unit">onCreate</a> <span class="delimiter">{</span>
    <a href="#13565" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13611" title="(f: Boolean =&gt; Boolean)Unit">onOpen</a> <span class="delimiter">{</span> <a title="Boolean" id="52260">isNew</a> =&gt;
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52260" title="Boolean">isNew</a><span class="delimiter">)</span> <a href="#13565" title="()Unit">doCreate</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="Interfaces.scala.html#13637" title="(key: String)Option[Array[Byte]]">getMetadata</a><span class="delimiter">(</span><a href="#40917" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="52262">bytes</a><span class="delimiter">)</span> =&gt; 
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52263">config</a> = <span title="()edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span>
        <a href="#52263" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="(data: Array[Byte])config.type">parse</span><span class="delimiter">(</span><a href="#52262" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
        <a href="#13560" title="(x$1: Double)Unit">readQuorum</a>  = <a href="#52263" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Double">readQuorum</span>
        <a href="#13563" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#52263" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Double">writeQuorum</span>
      <span class="keyword">case</span> <span title="Nothing">None</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;could not find quorum protocol&quot;)" class="string">&quot;could not find quorum protocol&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#52260" title="Boolean">isNew</a>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13612" title="(f: =&gt; Unit)Unit">onClose</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">// no-op </span>
  <span class="delimiter">}</span>

  <a href="Namespace.scala.html#13613" title="(f: =&gt; Unit)Unit">onDelete</a> <span title="Unit" class="delimiter">{</span>
    <span class="comment">//deleteMetadata(ZK_QUORUM_CONFIG)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** NOT thread-safe to set */</span>
  <span class="keyword">def</span> <a title="(readQuorum: Double, writeQuorum: Double)Unit" id="13566">setReadWriteQuorum</a><span class="delimiter">(</span><a title="Double" id="52278">readQuorum</a>: <span title="Double">Double</span>, <a title="Double" id="52279">writeQuorum</a>: <span title="Double">Double</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#52278" title="Double">readQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#52278" title="Double">readQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;)" class="string">&quot;Read quorum has to be in the range 0 &lt; RQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52278" title="Double">readQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span> <span title="(x: Double)Boolean">&lt;</span> <a href="#52279" title="Double">writeQuorum</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#52279" title="Double">writeQuorum</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;)" class="string">&quot;Write quorum has to be in the range 0 &lt; WQ &lt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52279" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#52279" title="Double">writeQuorum</a> <span title="(x: Double)Double">+</span> <a href="#52278" title="Double">readQuorum</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(1)" class="int">1</span>, <span title="java.lang.String(&quot;Read + write quorum has to be &gt;= 1 but was &quot;)" class="string">&quot;Read + write quorum has to be &gt;= 1 but was &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#52278" title="Double">readQuorum</a> <span title="(x: Double)Double">+</span> <a href="#52279" title="Double">writeQuorum</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#9645" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#13560" title="(x$1: Double)Unit">readQuorum</a> = <a href="#52278" title="Double">readQuorum</a>
    <a href="#9645" title="QuorumProtocol.this.type" class="keyword">this</a>.<a href="#13563" title="(x$1: Double)Unit">writeQuorum</a> = <a href="#52279" title="Double">writeQuorum</a>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" id="52281">config</a> = <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">QuorumProtocolConfig</span><span class="delimiter">(</span><a href="#52278" title="Double">readQuorum</a>, <a href="#52279" title="Double">writeQuorum</a><span class="delimiter">)</span>
    <a href="Interfaces.scala.html#13638" title="(key: String, value: Array[Byte])Unit">putMetadata</a><span class="delimiter">(</span><a href="#40917" title="=&gt; java.lang.String">ZK_QUORUM_CONFIG</a>, <a href="#52281" title="edu.berkeley.cs.scads.comm.QuorumProtocolConfig">config</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" id="13567">writeQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="51630">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52322">servers</a> = <a href="Interfaces.scala.html#13620" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51630" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span><a href="#52322" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>, scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#52322" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">size</span> <span title="(x: Double)Double">*</span> <a href="#13563" title="=&gt; Double">writeQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(nbServers: Int)Int" id="13568">readQuorum</a><span class="delimiter">(</span><a title="Int" id="52255">nbServers</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = scala.math.<span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><a href="#52255" title="Int">nbServers</a> <span title="(x: Double)Double">*</span> <a href="#13560" title="=&gt; Double">readQuorum</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" id="13569">readQuorumForKey</a><span class="delimiter">(</span><a title="Array[Byte]" id="51094">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span>Seq<span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, Int<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52341">servers</a> = <a href="Interfaces.scala.html#13620" title="(key: Array[Byte])Seq[edu.berkeley.cs.scads.comm.PartitionService]">serversForKey</a><span class="delimiter">(</span><a href="#51094" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span title="(_1: Seq[edu.berkeley.cs.scads.comm.PartitionService], _2: Int)(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</span><a href="#52341" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>, <a href="#13568" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#52341" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns all value versions for a given key. Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(key: Array[Byte])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]" id="13570">getAllVersions</a><span class="delimiter">(</span><a title="Array[Byte]" id="52352">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#52355" title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)" class="delimiter">(</a><a href="#52354" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]" id="52355">partitions</a>, <a href="#52354" title="Int" id="52356">quorum</a><span class="delimiter">)</span> = <a href="#13569" title="(key: Array[Byte])(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int)">readQuorumForKey</a><span title="(Seq[edu.berkeley.cs.scads.comm.PartitionService], Int) @unchecked" class="delimiter">(</span><a href="#52352" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRequest" id="52357">getRequest</a> = <span title="(key: Array[Byte])edu.berkeley.cs.scads.comm.GetRequest">GetRequest</span><span class="delimiter">(</span><a href="#52352" title="Array[Byte]">key</a><span class="delimiter">)</span>

    <a href="../util/ParFuture.scala.html#13647" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])]">waitForAndThrowException</a><span class="delimiter">(</span><a href="#52355" title="Seq[edu.berkeley.cs.scads.comm.PartitionService]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="52392">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#52392" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#52357" title="edu.berkeley.cs.scads.comm.GetRequest">getRequest</a>, <a href="#52392" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#52432" title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">{</a> 
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">(</span>GetResponse<span class="delimiter">(</span><a title="Option[Array[Byte]]" id="52471">optV</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="52472">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: Option[Array[Byte]])(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]])" class="delimiter">(</span><a href="#52472" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>, <a href="#52471" title="Option[Array[Byte]]">optV</a>.<span title="(f: Array[Byte] =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="Interfaces.scala.html#13629" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class GetHandler extends java.lang.Object with ScalaObject" id="13572">GetHandler</a><a href="#13572" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Array[Byte]" id="51230">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="51231">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="51234">timeout</a>: <span title="Long">Long</span> = <span title="Long(5000L)" class="int">5000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="51209">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>
    <a href="#51231" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#52597" title="edu.berkeley.cs.scads.comm.MessageFuture">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit">forward</span><span class="delimiter">(</span><a href="#51209" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51211">losers</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">ArrayBuffer</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span> 
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51213">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">ArrayBuffer</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="51216">winnerValue</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="51219">ctr</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="51221">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9644" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#51234" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="51224">failed</a> = <span title="Boolean(false)" class="keyword">false</span>

    <span class="keyword">def</span> <a title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="51226">repairList</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#51211" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a>

    <span class="keyword">def</span> <a title="(quorum: Int)Option[Array[Byte]]" id="51227">vote</a><span class="delimiter">(</span><a title="Int" id="51415">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#51415" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="52733">_</a> =&gt; <a href="#51229" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#51216" title="=&gt; Option[Array[Byte]]">winnerValue</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="51228">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="52874">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#51231" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#51219" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#51229" title="()Unit">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="51229">compareNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#51219" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="52876">future</a> = <a href="#51209" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture">poll</span><span class="delimiter">(</span><a href="#51221" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#29158" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52876" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#51224" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <a href="#52876" title="()edu.berkeley.cs.scads.comm.MessageBody">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">GetResponse</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="52891">v</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Int" id="52892">cmp</a> = <a href="#13574" title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int">optCompareMetadata</a><span class="delimiter">(</span><a href="#51216" title="=&gt; Option[Array[Byte]]">winnerValue</a>, <a href="#52891" title="Option[Array[Byte]]">v</a><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52892" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#52876" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51211" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.losers.type">+=</span> <a href="#52904" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#52892" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#51211" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">losers</a> <span title="(xs: scala.collection.TraversableOnce[edu.berkeley.cs.scads.comm.RemoteActorProxy])GetHandler.this.losers.type">++=</span> <a href="#51213" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a>
            <a href="#51213" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a>.<span title="()Unit">clear</span>
            <a href="#52876" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51213" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.winners.type">+=</span> <a href="#52929" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
            <a href="#51216" title="(x$1: Option[Array[Byte]])Unit">winnerValue</a> = <a href="#52891" title="Option[Array[Byte]]">v</a>
          <span class="delimiter">}</span><span class="keyword">else</span><span class="delimiter">{</span>
            <a href="#52876" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy])Unit">foreach</span><span class="delimiter">(</span><a href="#51213" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.RemoteActorProxy]">winners</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteActorProxy)GetHandler.this.winners.type">+=</span> <a href="#52943" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Nothing" id="52947">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown message &quot;)" class="string">&quot;Unknown message &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#52947" title="edu.berkeley.cs.scads.comm.MessageBody">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(optLhs: Option[Array[Byte]], optRhs: Option[Array[Byte]])Int" id="13574">optCompareMetadata</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="52893">optLhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="52894">optRhs</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#52893" title="Option[Array[Byte]]">optLhs</a>, <a href="#52894" title="Option[Array[Byte]]">optRhs</a><span class="delimiter">)</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="Int(0)" class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(0)" class="int">0</span>
    <span class="keyword">case</span> <span title="Int(-1)" class="delimiter">(</span><span title="object None">None</span>, Some<span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span> =&gt; -<span title="Int(-1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int(1)" class="delimiter">(</span>Some<span class="delimiter">(</span>_<span class="delimiter">)</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Int(1)" class="int">1</span>
    <span class="keyword">case</span> <span title="Int" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="52969">lhs</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="52971">rhs</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="Interfaces.scala.html#13627" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#52969" title="Array[Byte]">lhs</a>, <a href="#52971" title="Array[Byte]">rhs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; PartialFunction[Any,Unit]" id="13575">readRepairPF</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <a href="#13576" title="=&gt; PartialFunction[Any,Unit]">_rrpf</a> 

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="PartialFunction[Any,Unit]" id="13576">_rrpf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <a href="#52975" title="Unit" class="delimiter">{</a>
    <span class="keyword">case</span> <a title="Unit" id="52976">handler</a>: <a href="#13572" title="QuorumProtocol.this.GetHandler">GetHandler</a> =&gt;
      <a href="#13581" title="(f: =&gt; Unit)Unit">readRepairManagedBlock</a> <span class="delimiter">{</span>
        <a href="#52976" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51228" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="53048">server</a> &lt;- <a href="#52976" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51226" title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; edu.berkeley.cs.scads.comm.MessageFuture)Unit">repairList</a><span class="delimiter">)</span>
        <a href="#53048" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#52976" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51230" title="=&gt; Array[Byte]">key</a>, <a href="#52976" title="QuorumProtocol.this.GetHandler">handler</a>.<a href="#51216" title="=&gt; Option[Array[Byte]]">winnerValue</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * ReadRepairer actor - calls to processRest() run in a managed blocker, so that
   * the ForkJoinPool does not starve
   * TODO: Consider replacing this read repair actor with just a standard
   * thread pool
   */</span>
  <span class="keyword">object</span> <a title="object QuorumProtocol.this.ReadRepairer" id="13578">ReadRepairer</a> <span title="ScalaObject" class="keyword">extends</span> <span title="scala.actors.Actor">Actor</span> <span class="delimiter">{</span>
    <span title="()scala.actors.Actor">start</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">/* Auto start */</span>
    
    <span class="keyword">def</span> <a title="()Unit" id="51418">act</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(body: =&gt; Unit)Unit">loop</span> <span class="delimiter">{</span>
        <span title="(handler: PartialFunction[Any,Unit])Nothing">react</span> <a href="#53059" title="Unit" class="delimiter">{</a>
          <span class="keyword">case</span> <a title="Unit" id="53060">m</a> =&gt;
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#13575" title="=&gt; PartialFunction[Any,Unit]">readRepairPF</a>.<span title="(x: Any)Boolean">isDefinedAt</span><span class="delimiter">(</span><a href="#53060" title="Any">m</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#13575" title="=&gt; PartialFunction[Any,Unit]">readRepairPF</a>.<span title="(v1: Any)Unit">apply</span><span class="delimiter">(</span><a href="#53060" title="Any">m</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown message&quot;)" class="string">&quot;Unknown message&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#53060" title="Any">m</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/** expose the scheduler for blocks */</span>
    <span class="keyword">private</span><span class="delimiter">[</span>storage<span class="delimiter">]</span> <span class="keyword">def</span> <a title="=&gt; scala.actors.IScheduler" id="51419">getScheduler</a> = <span title="=&gt; scala.actors.IScheduler">scheduler</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Default ManagedBlocker for a function which has no means to query
   * progress
   */</span>
  <span class="keyword">class</span> <a title="class DefaultManagedBlocker extends java.lang.Object with scala.concurrent.ManagedBlocker with ScalaObject" id="13580">DefaultManagedBlocker</a><a href="#13580" title="ScalaObject" class="delimiter">(</a><a title="() =&gt; Unit" id="53109">f</a>: <span class="delimiter">(</span><span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span> <span class="keyword">extends</span> <span title="scala.concurrent.ManagedBlocker">ManagedBlocker</span> <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="53102">completed</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">def</span> <a title="()Boolean" id="53104">block</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#53109" title="()Unit">f</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#53102" title="(x$1: Boolean)Unit">completed</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="53105">isReleasable</a> = <a href="#53102" title="=&gt; Boolean">completed</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(f: =&gt; Unit)Unit" id="13581">readRepairManagedBlock</a><span class="delimiter">(</span><a title="=&gt; Unit" id="52977">f</a>: =&gt; Unit<span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#13578" title="object QuorumProtocol.this.ReadRepairer">ReadRepairer</a>.<a href="#51419" title="=&gt; scala.actors.IScheduler">getScheduler</a>.<span title="(blocker: scala.concurrent.ManagedBlocker)Unit">managedBlock</span><span class="delimiter">(</span><span title="QuorumProtocol.this.DefaultManagedBlocker" class="keyword">new</span> <a href="#13580" title="QuorumProtocol.this.DefaultManagedBlocker">DefaultManagedBlocker</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <a href="#52977" title="=&gt; Unit">f</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait QuorumRangeProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.RangeProtocol with edu.berkeley.cs.scads.storage.QuorumProtocol with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9646">QuorumRangeProtocol</a> 
  <span title="ScalaObject" class="keyword">extends</span> <a href="Interfaces.scala.html#9609" title="edu.berkeley.cs.scads.storage.RangeProtocol">RangeProtocol</a>
  <span class="keyword">with</span> <a href="#9645" title="edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a>
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9614" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>

  <span class="comment">/** assumes start/end key prepopulated w/ sentinel min/max values */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" id="38010">startGetRangeRequest</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="53126">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="53127">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="53128">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="53129">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="53130">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span>Seq<span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, Seq<span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53132">partitions</a> = <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" class="keyword">if</span> <span class="delimiter">(</span><a href="#53130" title="Boolean">ascending</a><span class="delimiter">)</span> <a href="Interfaces.scala.html#13652" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#53126" title="Option[Array[Byte]]">startKey</a>, <a href="#53127" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span> <span class="keyword">else</span> <a href="Interfaces.scala.html#13652" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#53126" title="Option[Array[Byte]]">startKey</a>, <a href="#53127" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">reverse</span>

    <a href="#53128" title="Option[Int]">limit</a> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">Some</span><span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <span class="comment">/* if limit is defined, then only send a req to the first server. return a pointer to the tail of the first partition */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53140">range</a> = <a href="#53132" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53141">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53140" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53140" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27802" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53128" title="Option[Int]">limit</a>, <a href="#53129" title="Option[Int]">offset</a>, <a href="#53130" title="Boolean">ascending</a><span class="delimiter">)</span>
        <span title="(_1: Seq[edu.berkeley.cs.scads.storage.RangeDesc], _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span><a href="#53132" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>, <span title="(elems: Seq[edu.berkeley.cs.scads.comm.MessageFuture]*)Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">Seq</span><span class="delimiter">(</span><a href="#53140" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27804" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53249" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53141" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">None</span> =&gt; <span class="comment">/* if no limit is defined, then we'll have to send a request to every server. the pointer should be nil since no servers left */</span>
        <span title="(_1: scala.collection.immutable.Nil.type, _2: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])(scala.collection.immutable.Nil.type, Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</span><span title="object Nil">Nil</span>, <a href="#53132" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],Seq[edu.berkeley.cs.scads.comm.MessageFuture],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]])Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Seq[edu.berkeley.cs.scads.comm.MessageFuture],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53294">range</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53295">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53294" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53294" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27802" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53128" title="Option[Int]">limit</a>, <a href="#53129" title="Option[Int]">offset</a>, <a href="#53130" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#53294" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27804" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53314" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53295" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">toSeq</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Finish a get range request. Ftchs are the GetRangeRequests which have
   * already been sent out, and partitions are the available servers to pull
   * data from 
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]" id="38011">finishGetRangeRequest</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53360">partitions</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">Seq</span><span class="delimiter">[</span>RangeDesc<span class="delimiter">]</span>, <a title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="53361">ftchs</a>: <span title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="53362">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="53363">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="53364">ascending</a>: <span title="Boolean">Boolean</span>, <a title="Option[Long]" id="53365">timeout</a>: <span title="Option[Long]">Option</span><span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>

    <span class="keyword">def</span> <a title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle" id="53367">newRangeHandle</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53373">ftchs</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span><span class="delimiter">)</span> = 
      <a href="#53365" title="Option[Long]">timeout</a>.<span title="(f: Long =&gt; QuorumRangeProtocol.this.RangeHandle)Option[QuorumRangeProtocol.this.RangeHandle]">map</span><span class="delimiter">(</span><a title="Long" id="53378">t</a> =&gt; <span title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</span> <a href="#38018" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#53373" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a>, <a href="#53378" title="Long">t</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; QuorumRangeProtocol.this.RangeHandle)QuorumRangeProtocol.this.RangeHandle">getOrElse</span><span class="delimiter">(</span><a href="#53414" title="QuorumRangeProtocol.this.RangeHandle" class="keyword">new</a> <a href="#38018" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a><span class="delimiter">(</span><a href="#53373" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">ftchs</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]" id="53368">handlers</a> = <a href="#53361" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>.<span title="(f: Seq[edu.berkeley.cs.scads.comm.MessageFuture] =&gt; QuorumRangeProtocol.this.RangeHandle)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]],QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]])Seq[QuorumRangeProtocol.this.RangeHandle]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,QuorumRangeProtocol.this.RangeHandle,Seq[QuorumRangeProtocol.this.RangeHandle]]" class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53439">x</a> =&gt; <a href="#53367" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#53439" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">x</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">toBuffer</span>

    <span class="keyword">var</span> <a title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" id="53369">result</a> = <span title="()scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">ArrayBuffer</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">var</span> <a title="Long" id="53370">openRec</a> = <a href="#53362" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Long)Option[Long]">map</span><span class="delimiter">(</span><a href="#53483" title="Int">_</a>.<span title="=&gt; Long">toLong</span><span class="delimiter">)</span>.<span title="(default: =&gt; Long)Long">getOrElse</span><span class="delimiter">(</span>java.lang.Long.<span title="Long(9223372036854775807L)">MAX_VALUE</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="53371">servers</a> = <a href="#53360" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>
    <span class="keyword">var</span> <a title="Int" id="53372">cur</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="QuorumRangeProtocol.this.RangeHandle" id="53535">handler</a> &lt;- <a href="#53368" title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Unit)Unit">handlers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53370" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53540">records</a> = <a href="#53535" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53407" title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">vote</a><span class="delimiter">(</span><a href="#13568" title="(nbServers: Int)Int">readQuorum</a><span class="delimiter">(</span><a href="#53535" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53411" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53535" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53402" title="=&gt; Boolean">failed</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;)" class="string">&quot;Not enough servers responded. We need to throw better exceptions for that case&quot;</span><span class="delimiter">)</span>
        <span class="comment">//if we do not get enough records, we request more, before we process the current batch</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53540" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="=&gt; Int">length</span> <span title="(x: Long)Boolean">&lt;=</span> <a href="#53370" title="Long">openRec</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#53371" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.RangeDesc" id="53562">range</a> = <a href="#53371" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.RangeDesc">head</span>
          <span class="keyword">val</span> <a title="Option[Int]" id="53563">newLimit</a> = <span title="Option[Int]" class="keyword">if</span><span class="delimiter">(</span><a href="#53362" title="Option[Int]">limit</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#53370" title="Long">openRec</a>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span> <span class="keyword">else</span> <span title="object None">None</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="53564">rangeRequest</a> = <span title="edu.berkeley.cs.scads.comm.GetRangeRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#53562" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#53562" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27802" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#53563" title="Option[Int]">newLimit</a>, <a href="#53363" title="Option[Int]">offset</a>, <a href="#53364" title="Boolean">ascending</a><span class="delimiter">)</span>
          <a href="#53368" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(elems: QuorumRangeProtocol.this.RangeHandle*)Unit">append</span><span class="delimiter">(</span><a href="#53367" title="(ftchs: Seq[edu.berkeley.cs.scads.comm.MessageFuture])QuorumRangeProtocol.this.RangeHandle">newRangeHandle</a><span class="delimiter">(</span><a href="#53562" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27804" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#53599" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#53564" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeRequest</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#53371" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a> = <a href="#53371" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">servers</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.RangeDesc]">tail</span>
        <span class="delimiter">}</span>
        <a href="#53369" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>.<span title="(xs: scala.collection.TraversableOnce[(Array[Byte], Array[Byte])])Unit">appendAll</span><span class="delimiter">(</span><a href="#53540" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; scala.collection.GenTraversableOnce[(Array[Byte], Array[Byte])])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record],(Array[Byte], Array[Byte]),scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]])scala.collection.TraversableOnce[(Array[Byte], Array[Byte])]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArrayBuffer.Coll,(Array[Byte], Array[Byte]),scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="53637">rec</a> =&gt;
          <span title="List[(Array[Byte], Array[Byte])]" class="keyword">if</span> <span class="delimiter">(</span><a href="#53370" title="Long">openRec</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#53370" title="Long">openRec</a> <span title="(x: Int)Long">-=</span> <span title="Int(1)" class="int">1</span>
            <a href="#53637" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="(f: Array[Byte] =&gt; (Array[Byte], Array[Byte]))Option[(Array[Byte], Array[Byte])]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="53650">v</a> =&gt; <span title="(_1: Array[Byte], _2: Array[Byte])(Array[Byte], Array[Byte])" class="delimiter">(</span><a href="#53637" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Array[Byte]">key</span>, <a href="Interfaces.scala.html#13629" title="(value: Array[Byte])Array[Byte]">extractRecordFromValue</a><span class="delimiter">(</span><a href="#53650" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[(Array[Byte], Array[Byte])]">toList</span>
          <span class="delimiter">}</span> <span class="keyword">else</span>
            <span title="object Nil">Nil</span>
          <span class="delimiter">)</span>
        <span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#53368" title="scala.collection.mutable.Buffer[QuorumRangeProtocol.this.RangeHandle]">handlers</a>.<span title="(f: QuorumRangeProtocol.this.RangeHandle =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#13578" title="object QuorumRangeProtocol.this.ReadRepairer">ReadRepairer</a> <span title="(msg: Any)Unit">!</span> <a href="#54038" title="QuorumRangeProtocol.this.RangeHandle">_</a><span class="delimiter">)</span>
    <a href="#53369" title="scala.collection.mutable.ArrayBuffer[(Array[Byte], Array[Byte])]">result</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[(Array[Byte], Array[Byte])]" id="38012">getKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="54042">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Array[Byte]]" id="54043">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="54044">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Option[Int]" id="54045">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, 
                       <a title="Boolean" id="54046">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], Array[Byte])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#54049" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</a><a href="#54048" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54049">ptr</a>, <a href="#54048" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="54050">ftchs</a><span class="delimiter">)</span> = <a href="#38010" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]) @unchecked" class="delimiter">(</span><a href="#54042" title="Option[Array[Byte]]">start</a>, <a href="#54043" title="Option[Array[Byte]]">end</a>, <a href="#54044" title="Option[Int]">limit</a>, <a href="#54045" title="Option[Int]">offset</a>, <a href="#54046" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#38011" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#54049" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#54050" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>, <a href="#54044" title="Option[Int]">limit</a>, <a href="#54045" title="Option[Int]">offset</a>, <a href="#54046" title="Boolean">ascending</a>, <span title="object None">None</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(start: Option[Array[Byte]], end: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]" id="38013">asyncGetKeys</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="54061">start</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="54062">end</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="54063">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="54064">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="54065">ascending</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.ScadsFuture[Seq[(Array[Byte], Array[Byte])]]">ScadsFuture</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#54068" title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])" class="delimiter">(</a><a href="#54067" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54068">ptr</a>, <a href="#54067" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" id="54069">ftchs</a><span class="delimiter">)</span> = <a href="#38010" title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]])">startGetRangeRequest</a><span title="(Seq[edu.berkeley.cs.scads.storage.RangeDesc], Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]) @unchecked" class="delimiter">(</span><a href="#54061" title="Option[Array[Byte]]">start</a>, <a href="#54062" title="Option[Array[Byte]]">end</a>, <a href="#54063" title="Option[Int]">limit</a>, <a href="#54064" title="Option[Int]">offset</a>, <a href="#54065" title="Boolean">ascending</a><span class="delimiter">)</span>
    <a href="#54080" title="java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.comm.ComputationFuture[Seq[(Array[Byte], Array[Byte])]]" id="54080">ComputationFuture</a><span class="delimiter">[</span>Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(timeoutHint: Long, unit: java.util.concurrent.TimeUnit)Seq[(Array[Byte], Array[Byte])]" id="54084">compute</a><span class="delimiter">(</span><a title="Long" id="54086">timeoutHint</a>: <span title="Long">Long</span>, <a title="java.util.concurrent.TimeUnit" id="54087">unit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = 
        <a href="#38011" title="(partitions: Seq[edu.berkeley.cs.scads.storage.RangeDesc], ftchs: Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]], limit: Option[Int], offset: Option[Int], ascending: Boolean, timeout: Option[Long])Seq[(Array[Byte], Array[Byte])]">finishGetRangeRequest</a><span class="delimiter">(</span><a href="#54068" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">ptr</a>, <a href="#54069" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture]]">ftchs</a>, <a href="#54063" title="Option[Int]">limit</a>, <a href="#54064" title="Option[Int]">offset</a>, <a href="#54065" title="Boolean">ascending</a>, <span title="(x: Long)Some[Long]">Some</span><span class="delimiter">(</span><a href="#54087" title="java.util.concurrent.TimeUnit">unit</a>.<span title="(x$1: Long)Long">toMillis</span><span class="delimiter">(</span><a href="#54086" title="Long">timeoutHint</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="=&gt; Nothing" id="54085">cancelComputation</a> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;NOT IMPLEMENTED&quot;)" class="string">&quot;NOT IMPLEMENTED&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; PartialFunction[Any,Unit]" id="38014">readRepairPF</a> = <a href="#38015" title="=&gt; PartialFunction[Any,Unit]">_rrpf</a> 

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="PartialFunction[Any,Unit]" id="38015">_rrpf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="PartialFunction[Any,Unit]" id="54103">pf</a>: <span title="PartialFunction[Any,Unit]">PartialFunction</span><span class="delimiter">[</span>Any, Unit<span class="delimiter">]</span> = <a href="#54105" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <a title="Unit" id="54106">handler</a>: <a href="#38018" title="QuorumRangeProtocol.this.RangeHandle">RangeHandle</a> =&gt;
        <a href="#13581" title="(f: =&gt; Unit)Unit">readRepairManagedBlock</a> <span class="delimiter">{</span>
          <a href="#54106" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53408" title="()Unit">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="Array[Byte]" id="54261">key</a>, <span class="delimiter">(</span><a title="Array[Byte]" id="54264">data</a>, <a title="List[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="54265">servers</a><span class="delimiter">)</span><span class="delimiter">)</span> &lt;- <a href="#54106" title="QuorumRangeProtocol.this.RangeHandle">handler</a>.<a href="#53390" title="(f: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])) =&gt; Unit)Unit">losers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">for</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54296">server</a> &lt;- <a href="#54265" title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; edu.berkeley.cs.scads.comm.MessageFuture)Unit">servers</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#54296" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">server</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.PutRequest">PutRequest</span><span class="delimiter">(</span><a href="#54261" title="Array[Byte]">key</a>, <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#54264" title="Array[Byte]">data</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#54103" title="PartialFunction[Any,Unit]">pf</a>.<span title="(that: PartialFunction[Any,Unit])PartialFunction[Any,Unit]">orElse</span><span class="delimiter">(</span><a href="#9646" title="edu.berkeley.cs.scads.storage.QuorumRangeProtocol" class="keyword">super</a>.<a href="#13575" title="=&gt; PartialFunction[Any,Unit]">readRepairPF</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Tests the range for conflicts and marks all violations for future resolution.
   * This class is optimized for none/few violations.
   */</span>
  <span class="keyword">class</span> <a title="class RangeHandle extends java.lang.Object with ScalaObject" id="38018">RangeHandle</a><a href="#38018" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="53411">futures</a>: <span title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]">Seq</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="Long" id="53414">timeout</a>: <span title="Long">Long</span> = <span title="Long(100000L)" class="int">100000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="53386">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="#9644" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#53414" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" id="53388">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">]</span>
    <a href="#53411" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#54422" title="edu.berkeley.cs.scads.comm.MessageFuture">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture])Unit">forward</span><span class="delimiter">(</span><a href="#53388" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// TODO: hashing on byte array like this is no good. this should be redone</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]" id="53390">losers</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, List<span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53392">winners</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>

    <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="53395">baseServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</span> = <span title="Null(null)" class="keyword">null</span> <span class="comment">//The whole comparison is based on the first response</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="53397">winnerExceptions</a> = <span title="()scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">HashMap</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, RemoteActorProxy<span class="delimiter">]</span>

    <span class="keyword">val</span> <a title="Long" id="53399">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">var</span> <a title="Boolean" id="53402">failed</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="53405">ctr</a> = <span title="Int(0)" class="int">0</span>

    <span class="keyword">def</span> <a title="(quorum: Int)scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="53407">vote</a><span class="delimiter">(</span><a title="Int" id="53541">quorum</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(end: Int)scala.collection.immutable.Range.Inclusive">to</span> <a href="#53541" title="Int">quorum</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="Int" id="54523">_</a> =&gt; <a href="#53409" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span> <a href="#53392" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="()Unit" id="53408">processRest</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="54212">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">1</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <a href="#53411" title="=&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture]">futures</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">-</span> <a href="#53405" title="=&gt; Int">ctr</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#53409" title="()Unit">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="53409">processNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#53405" title="(x$1: Int)Unit">ctr</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="54525">future</a> = <a href="#53388" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture">poll</span><span class="delimiter">(</span><a href="#53386" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="#29158" title="=&gt; Long">remaining</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#54525" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#53402" title="(x$1: Boolean)Unit">failed</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span title="Nothing" class="keyword">return</span>
      <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54526">result</a> = <a href="#54525" title="()edu.berkeley.cs.scads.comm.MessageBody">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Seq[edu.berkeley.cs.scads.comm.Record]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Seq[edu.berkeley.cs.scads.comm.Record]">GetRangeResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54576">v</a><span class="delimiter">)</span> =&gt; <a href="#54576" title="Seq[edu.berkeley.cs.scads.comm.Record]">v</a>
        <span class="keyword">case</span> <a title="Nothing" id="54577">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message (was expecting GetRangeResponse): &quot;)" class="string">&quot;Unexpected Message (was expecting GetRangeResponse): &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#54577" title="edu.berkeley.cs.scads.comm.MessageBody">m</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#53392" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">//println(&quot;first result &quot; + result.map(a =&gt; QuorumProtocol.this.deserializeKey(a.key)))</span>
        <a href="#53392" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(n: Int, seq: Traversable[edu.berkeley.cs.scads.comm.Record])Unit">insertAll</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <a href="#54526" title="Seq[edu.berkeley.cs.scads.comm.Record]">result</a><span class="delimiter">)</span>
        <a href="#53395" title="(x$1: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">baseServer</a> = <a href="#54525" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">get</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#53410" title="(newRecords: Seq[edu.berkeley.cs.scads.comm.Record], newServer: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">merge</a><span class="delimiter">(</span><a href="#54526" title="Seq[edu.berkeley.cs.scads.comm.Record]">result</a>, <a href="#54525" title="edu.berkeley.cs.scads.comm.MessageFuture">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">source</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">get</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(newRecords: Seq[edu.berkeley.cs.scads.comm.Record], newServer: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit" id="53410">merge</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54609">newRecords</a>: <span title="Seq[edu.berkeley.cs.scads.comm.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54610">newServer</a>: <span title="edu.berkeley.cs.scads.comm.RemoteActorProxy">RemoteActorProxy</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="54612">recordPtr</a> = <a href="#54609" title="Seq[edu.berkeley.cs.scads.comm.Record]">newRecords</a>
      <span class="keyword">var</span> <a title="Int" id="54613">i</a> = <span title="Int(0)" class="int">0</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#54613" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#53392" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="=&gt; Int">length</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#54614" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54624">winnerKey</a> = <a href="#53392" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54613" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">key</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54625">newKey</a> = <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Array[Byte]">key</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#53392" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54613" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="comment">//should always be defined if we get data back, otherwise delete might not work</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54626">winnerValue</a> = <a href="#53392" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">winners</a><span class="delimiter">(</span><a href="#54613" title="Int">i</a><span class="delimiter">)</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="54627">newValue</a> = <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span>
        <a href="Interfaces.scala.html#13624" title="(x: Array[Byte], y: Array[Byte])Int">compareKey</a><span class="delimiter">(</span><a href="#54624" title="Array[Byte]">winnerKey</a>, <a href="#54625" title="Array[Byte]">newKey</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="54672">cmp</a> <span class="keyword">if</span> <a href="#54672" title="Int">cmp</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> =&gt;
            <a href="#54613" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="Interfaces.scala.html#13627" title="(lhs: Array[Byte], rhs: Array[Byte])Int">compareMetadata</a><span class="delimiter">(</span><a href="#54626" title="Array[Byte]">winnerValue</a>, <a href="#54627" title="Array[Byte]">newValue</a><span class="delimiter">)</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Unit">-</span><span class="int">1</span> =&gt; <span class="delimiter">{</span>
                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="54681">outdatedServer</a> = <a href="#53397" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a>.<span title="(key: Array[Byte], default: =&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy)edu.berkeley.cs.scads.comm.RemoteActorProxy">getOrElse</span><span class="delimiter">(</span><a href="#54624" title="Array[Byte]">winnerKey</a>, <a href="#53395" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActorProxy">baseServer</a><span class="delimiter">)</span>
                <a href="#53390" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])))RangeHandle.this.losers.type">+=</span> <a href="#54624" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))">-&gt;</span> <span class="delimiter">(</span><a href="#54627" title="Array[Byte]">newValue</a>, <a href="#54681" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">outdatedServer</a> <a href="#54731" title="(x: edu.berkeley.cs.scads.comm.RemoteActorProxy)List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">::</a> <a href="#53390" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])">getOrElse</span><span class="delimiter">(</span><a href="#54624" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">_2</span><span class="delimiter">)</span>
                <a href="#53397" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#54624" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteActorProxy)(Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy)">-&gt;</span> <a href="#54610" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a>
                <a href="#53392" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(idx: Int, elem: edu.berkeley.cs.scads.comm.Record)Unit">update</span><span class="delimiter">(</span><a href="#54613" title="Int">i</a>, <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="RangeHandle.this.losers.type" class="int">1</span> =&gt; <span class="delimiter">{</span>
                <a href="#53390" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a> <span title="(kv: (Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])))RangeHandle.this.losers.type">+=</span> <a href="#54624" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">winnerKey</a> <span title="(y: (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))">-&gt;</span> <span class="delimiter">(</span><a href="#54626" title="Array[Byte]">winnerValue</a>, <a href="#54610" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a> <a href="#54825" title="(x: edu.berkeley.cs.scads.comm.RemoteActorProxy)List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">::</a> <a href="#53390" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])]">losers</a>.<span title="(key: Array[Byte], default: =&gt; (Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy]))(Array[Byte], List[edu.berkeley.cs.scads.comm.RemoteActorProxy])">getOrElse</span><span class="delimiter">(</span><a href="#54624" title="Array[Byte]">winnerKey</a>, <span title="(_1: Null, _2: scala.collection.immutable.Nil.type)(Null, scala.collection.immutable.Nil.type)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.RemoteActorProxy]">_2</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Unit" class="int">0</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a> = <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">tail</span>
            <a href="#54613" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <a title="Unit" id="54862">cmp</a> <span class="keyword">if</span> <a href="#54862" title="Int">cmp</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> =&gt; <span class="delimiter">{</span>
            <a href="#53392" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">winners</a>.<span title="(n: Int, elems: edu.berkeley.cs.scads.comm.Record*)Unit">insert</span><span class="delimiter">(</span><a href="#54613" title="Int">i</a>, <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">head</span><span class="delimiter">)</span>
            <a href="#54613" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span> <span class="comment">//because of the insert</span>
            <a href="#53397" title="=&gt; scala.collection.mutable.HashMap[Array[Byte],edu.berkeley.cs.scads.comm.RemoteActorProxy]">winnerExceptions</a> <span title="(kv: (Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy))RangeHandle.this.winnerExceptions.type">+=</span> <a href="#54625" title="(x: Array[Byte])ArrowAssoc[Array[Byte]]">newKey</a> <span title="(y: edu.berkeley.cs.scads.comm.RemoteActorProxy)(Array[Byte], edu.berkeley.cs.scads.comm.RemoteActorProxy)">-&gt;</span> <a href="#54610" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">newServer</a>
            <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a> = <a href="#54612" title="Seq[edu.berkeley.cs.scads.comm.Record]">recordPtr</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">tail</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="delimiter">}</span>
 
  <span class="comment">/*
   * NB: We trust the caller here that the records produced from the given locations will
   * all have keys in between firstKey and lastKey.  Therefore we just check that
   * firstKey&lt;-&gt;lastKey only covers one partition
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(parser: edu.berkeley.cs.scads.storage.RecParser, locations: Array[String], firstKey: Option[Array[Byte]], lastKey: Option[Array[Byte]])Unit" id="38020">putBulkLocations</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecParser" id="54900">parser</a>:<a href="../server/PartitionHandler.scala.html#9810" title="edu.berkeley.cs.scads.storage.RecParser">RecParser</a>,<a title="Array[String]" id="54901">locations</a>:<span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
                                <a title="Option[Array[Byte]]" id="54902">firstKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,<a title="Option[Array[Byte]]" id="54903">lastKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="54905">partitions</a> = <a href="Interfaces.scala.html#13652" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#54902" title="Option[Array[Byte]]">firstKey</a>, <a href="#54903" title="Option[Array[Byte]]">lastKey</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#54905" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Can\'t bulk put locations over more than one partition&quot;)" class="string">&quot;Can't bulk put locations over more than one partition&quot;</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="54910">baos</a> = <span title="java.io.ByteArrayOutputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span>
      <span class="keyword">val</span> <a title="java.io.ObjectOutputStream" id="54911">oos</a> = <span title="java.io.ObjectOutputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectOutputStream">ObjectOutputStream</span><span class="delimiter">(</span><a href="#54910" title="java.io.ByteArrayOutputStream">baos</a><span class="delimiter">)</span>
      <a href="#54911" title="java.io.ObjectOutputStream">oos</a>.<span title="(x$1: Any)Unit">writeObject</span><span class="delimiter">(</span><a href="#54900" title="edu.berkeley.cs.scads.storage.RecParser">parser</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.MessageFuture]" id="54912">responses</a> = <a href="#54905" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#27804" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]])Seq[edu.berkeley.cs.scads.comm.MessageFuture]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture,Seq[edu.berkeley.cs.scads.comm.MessageFuture]]" class="delimiter">(</span><a href="#54942" title="edu.berkeley.cs.scads.comm.PartitionService">_</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <span title="(parser: Array[Byte], locations: Seq[String])edu.berkeley.cs.scads.comm.BulkUrlPutReqest">BulkUrlPutReqest</span><span class="delimiter">(</span><a href="#54910" title="java.io.ByteArrayOutputStream">baos</a>.<span title="()Array[Byte]">toByteArray</span>,<a href="#54901" title="(xs: Array[String])scala.collection.mutable.WrappedArray[String]">locations</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#54912" title="implicit edu.berkeley.cs.scads.comm.MessageFuture.toFutureCollection : (futures: Seq[edu.berkeley.cs.scads.comm.MessageFuture])edu.berkeley.cs.scads.comm.FutureCollection">responses</a>.<span title="(count: Int)Seq[edu.berkeley.cs.scads.comm.MessageFuture]">blockFor</span><span title="Unit" class="delimiter">(</span><a href="#54905" title="(idx: Int)edu.berkeley.cs.scads.storage.RangeDesc">partitions</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<a href="Interfaces.scala.html#27804" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Get all value versions for a range of keys.  Does not perform read-repair.
   */</span>
  <span class="keyword">def</span> <a title="(startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]" id="38021">getAllRangeVersions</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="55036">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="55037">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>PartitionService, Seq<span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>,Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="55039">partitions</a> = <a href="Interfaces.scala.html#13652" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><a href="#55036" title="Option[Array[Byte]]">startKey</a>, <a href="#55037" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
    <a href="../util/ParFuture.scala.html#13647" title="(futures: Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)], timeout: Long)(f: PartialFunction[(edu.berkeley.cs.scads.comm.MessageBody, edu.berkeley.cs.scads.comm.PartitionService),(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])])Seq[(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])]">waitForAndThrowException</a><span class="delimiter">(</span>
      <a href="#55039" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; scala.collection.GenTraversableOnce[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="55062">range</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="55063">rangeReq</a> = <span title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#55062" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27800" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#55062" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27802" title="=&gt; Option[Array[Byte]]">endKey</a>, <span title="object None">None</span>, <span title="object None">None</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
        <a href="#55062" title="edu.berkeley.cs.scads.storage.RangeDesc">range</a>.<a href="Interfaces.scala.html#27804" title="=&gt; Seq[edu.berkeley.cs.scads.comm.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.comm.PartitionService =&gt; (edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.PartitionService],(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]])Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService),Seq[(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="55090">partition</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.MessageFuture, _2: edu.berkeley.cs.scads.comm.PartitionService)(edu.berkeley.cs.scads.comm.MessageFuture, edu.berkeley.cs.scads.comm.PartitionService)" class="delimiter">(</span><a href="#55090" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#55063" title="edu.berkeley.cs.scads.comm.GetRangeRequest">rangeReq</a>, <a href="#55090" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a><span class="delimiter">)</span><span class="delimiter">)</span> 
      <span class="delimiter">}</span><span class="delimiter">)</span> 
    <span class="delimiter">)</span> <a href="#55147" title="(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">{</a>    
      <span class="keyword">case</span> <span title="(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span>GetRangeResponse<span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="55151">recs</a><span class="delimiter">)</span>, <a title="edu.berkeley.cs.scads.comm.PartitionService" id="55152">partition</a><span class="delimiter">)</span> =&gt; <span title="(_1: edu.berkeley.cs.scads.comm.PartitionService, _2: Seq[(Array[Byte], Option[Array[Byte]])])(edu.berkeley.cs.scads.comm.PartitionService, Seq[(Array[Byte], Option[Array[Byte]])])" class="delimiter">(</span><a href="#55152" title="edu.berkeley.cs.scads.comm.PartitionService">partition</a>, <a href="#55151" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; (Array[Byte], Option[Array[Byte]]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.Record],(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]])Seq[(Array[Byte], Option[Array[Byte]])]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Array[Byte], Option[Array[Byte]]),Seq[(Array[Byte], Option[Array[Byte]])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="55178">r</a>=&gt;<span title="(_1: Array[Byte], _2: Option[Array[Byte]])(Array[Byte], Option[Array[Byte]])" class="delimiter">(</span><a href="#55178" title="edu.berkeley.cs.scads.comm.Record">r</a>.<span title="=&gt; Array[Byte]">key</span>,<a href="#55178" title="edu.berkeley.cs.scads.comm.Record">r</a>.<span title="=&gt; Option[Array[Byte]]">value</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>