<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>client/AnalyticsProtocol.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> edu.berkeley.cs.avro.runtime.ScalaSpecificRecord
<span class="keyword">import</span> edu.berkeley.cs.avro.marker._
<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.scads.util._

<span class="keyword">import</span> org.apache.avro.Schema 
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> actors.Actor
<span class="keyword">import</span> collection.mutable.<span class="delimiter">{</span> Seq =&gt; MutSeq, _ <span class="delimiter">}</span>
<span class="keyword">import</span> concurrent.ManagedBlocker

<span class="keyword">import</span> java.util.concurrent.TimeUnit
<span class="keyword">import</span> java.io.<span class="delimiter">{</span>ByteArrayOutputStream,ObjectOutputStream<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait AnalyticsProtocol extends java.lang.Object with edu.berkeley.cs.scads.storage.QuorumProtocol with edu.berkeley.cs.scads.storage.KeyRangeRoutable with ScalaObject" id="9737">AnalyticsProtocol</a>
  <span title="ScalaObject" class="keyword">extends</span> <a href="QuorumProtocol.scala.html#9896" title="edu.berkeley.cs.scads.storage.QuorumProtocol">QuorumProtocol</a> 
  <span class="keyword">with</span> <a href="Interfaces.scala.html#9864" title="edu.berkeley.cs.scads.storage.KeyRangeRoutable">KeyRangeRoutable</a> <span class="delimiter">{</span>
   
  <span class="keyword">def</span> <a title="(groups: Seq[String], keyType: String, valType: String, filtFuncs: Seq[edu.berkeley.cs.scads.util.Filter[_]], aggClasses: Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])])Seq[(org.apache.avro.generic.GenericData.Record, Seq[_])]" id="27892">applyAggregate</a>
    <span class="delimiter">(</span><a title="Seq[String]" id="27967">groups</a>:<span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
     <a title="String" id="27968">keyType</a>:<span title="String">String</span>,
     <a title="String" id="27969">valType</a>:<span title="String">String</span>,
     <a title="Seq[edu.berkeley.cs.scads.util.Filter[_]]" id="27970">filtFuncs</a>:<span title="Seq[edu.berkeley.cs.scads.util.Filter[_]]">Seq</span><span class="delimiter">[</span>Filter<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">]</span>,
     <a title="Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])]" id="27971">aggClasses</a>:<span title="Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>LocalAggregate<span class="delimiter">[</span>_,_<span class="delimiter">]</span>,RemoteAggregate<span class="delimiter">[</span>_,_,_<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Seq[(org.apache.avro.generic.GenericData.Record, Seq[_])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>GenericData.Record,Seq<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.AggFilter]" id="28151">filters</a> = <a href="#27970" title="Seq[edu.berkeley.cs.scads.util.Filter[_]]">filtFuncs</a>.<span title="(f: edu.berkeley.cs.scads.util.Filter[_] =&gt; edu.berkeley.cs.scads.storage.AggFilter)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.Filter[_]],edu.berkeley.cs.scads.storage.AggFilter,Seq[edu.berkeley.cs.scads.storage.AggFilter]])Seq[edu.berkeley.cs.scads.storage.AggFilter]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.AggFilter,Seq[edu.berkeley.cs.scads.storage.AggFilter]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.Filter[_]" id="28175">func</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="28176">baos</a> = <span title="java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span>
        <span class="keyword">val</span> <a title="java.io.ObjectOutputStream" id="28177">oos</a> = <span title="java.io.ObjectOutputStream" class="keyword">new</span> <span title="java.io.ObjectOutputStream">ObjectOutputStream</span><span class="delimiter">(</span><a href="#28176" title="java.io.ByteArrayOutputStream">baos</a><span class="delimiter">)</span>
        <a href="#28177" title="java.io.ObjectOutputStream">oos</a>.<span title="(x$1: Any)Unit">writeObject</span><span class="delimiter">(</span><a href="#28175" title="edu.berkeley.cs.scads.util.Filter[_]">func</a><span class="delimiter">)</span>
        <a href="../Messages.scala.html#23921" title="(obj: Array[Byte])edu.berkeley.cs.scads.storage.AggFilter">AggFilter</a><span class="delimiter">(</span><a href="#28176" title="java.io.ByteArrayOutputStream">baos</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.AggOp]" id="28152">aggs</a> = <a href="#27971" title="Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])]">aggClasses</a>.<span title="(f: (edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _]) =&gt; edu.berkeley.cs.scads.storage.AggOp)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])],edu.berkeley.cs.scads.storage.AggOp,Seq[edu.berkeley.cs.scads.storage.AggOp]])Seq[edu.berkeley.cs.scads.storage.AggOp]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.AggOp,Seq[edu.berkeley.cs.scads.storage.AggOp]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])" id="30506">ac</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="30507">baos</a> = <span title="java.io.ByteArrayOutputStream" class="keyword">new</span> <span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span>
        <span class="keyword">val</span> <a title="java.io.ObjectOutputStream" id="30508">oos</a> = <span title="java.io.ObjectOutputStream" class="keyword">new</span> <span title="java.io.ObjectOutputStream">ObjectOutputStream</span><span class="delimiter">(</span><a href="#30507" title="java.io.ByteArrayOutputStream">baos</a><span class="delimiter">)</span>
        <a href="#30508" title="java.io.ObjectOutputStream">oos</a>.<span title="(x$1: Any)Unit">writeObject</span><span class="delimiter">(</span><a href="#30506" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])">ac</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _]">_2</span><span class="delimiter">)</span>
        <a href="../Messages.scala.html#24017" title="(codename: String, code: Array[Byte], obj: Array[Byte], raw: Boolean)edu.berkeley.cs.scads.storage.AggOp">AggOp</a><span class="delimiter">(</span><a href="#30506" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])">ac</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _]">_2</span>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.String">getName</span>,<a href="util/AnalyticsUtils.scala.html#10482" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="util/AnalyticsUtils.scala.html#34670" title="(cl: AnyRef)Array[Byte]">getClassBytes</a><span class="delimiter">(</span><a href="#30506" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])">ac</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _]">_2</span><span class="delimiter">)</span>,<a href="#30507" title="java.io.ByteArrayOutputStream">baos</a>.<span title="()Array[Byte]">toByteArray</span>,<span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.AggRequest" id="28153">aggRequest</a> = <a href="../Messages.scala.html#24251" title="(groups: Seq[String], keyType: String, valueType: String, filters: Seq[edu.berkeley.cs.scads.storage.AggFilter], aggs: Seq[edu.berkeley.cs.scads.storage.AggOp])edu.berkeley.cs.scads.storage.AggRequest">AggRequest</a><span class="delimiter">(</span><a href="#27967" title="Seq[String]">groups</a>,<a href="#27968" title="String">keyType</a>, <a href="#27969" title="String">valType</a>,<a href="#28151" title="Seq[edu.berkeley.cs.scads.storage.AggFilter]">filters</a>,<a href="#28152" title="Seq[edu.berkeley.cs.scads.storage.AggOp]">aggs</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]" id="28154">partitions</a> = <a href="Interfaces.scala.html#27961" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])Seq[edu.berkeley.cs.scads.storage.RangeDesc]">serversForKeyRange</a><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,String]" id="28155">partitionMap</a> = <span title="()scala.collection.mutable.HashMap[String,String]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[String,String]">HashMap</span><span class="delimiter">[</span>String,String<span class="delimiter">]</span>
      <span class="keyword">val</span> <a title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" id="28156">responses</a> = <a href="#28154" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="(f: edu.berkeley.cs.scads.storage.RangeDesc =&gt; Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RangeDesc],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]])Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]],Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RangeDesc" id="31371">partition</a> =&gt; <span class="delimiter">{</span>
        <a href="#31371" title="edu.berkeley.cs.scads.storage.RangeDesc">partition</a>.<a href="Interfaces.scala.html#31379" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]])Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage],Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="31399">server</a> =&gt; <span class="delimiter">{</span>
          <a href="#28155" title="scala.collection.mutable.HashMap[String,String]">partitionMap</a> <span title="(kv: (String, String))partitionMap.type">+=</span> <span class="delimiter">(</span><span title="(_1: String, _2: String)(String, String)" class="delimiter">(</span><a href="#31399" title="edu.berkeley.cs.scads.storage.PartitionService">server</a>.<span title="()String">toString</span>,<a href="#31399" title="edu.berkeley.cs.scads.storage.PartitionService">server</a>.<a href="../Messages.scala.html#21950" title="=&gt; String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#31399" title="edu.berkeley.cs.scads.storage.PartitionService">server</a> <span title="(body: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">!!</span> <a href="#28153" title="edu.berkeley.cs.scads.storage.AggRequest">aggRequest</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="28157">groupSchema</a> = <a href="util/AnalyticsUtils.scala.html#10482" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="util/AnalyticsUtils.scala.html#34665" title="(fields: Seq[String], original: org.apache.avro.Schema)org.apache.avro.Schema">getSubSchema</a><span class="delimiter">(</span><a href="#27967" title="Seq[String]">groups</a>,<a href="Interfaces.scala.html#27941" title="=&gt; org.apache.avro.Schema">valueSchema</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="AnalyticsProtocol.this.AggHandler" id="28158">handler</a> = <a href="#32102" title="AnalyticsProtocol.this.AggHandler" class="keyword">new</a> <a href="#27894" title="AnalyticsProtocol.this.AggHandler">AggHandler</a><span class="delimiter">(</span><a href="#28156" title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">responses</a>,<a href="#28155" title="scala.collection.mutable.HashMap[String,String]">partitionMap</a>,<a href="#28154" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Int">size</span>,<a href="#27971" title="Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])]">aggClasses</a>.<span title="(f: (edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _]) =&gt; edu.berkeley.cs.scads.util.LocalAggregate[_, _])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])],edu.berkeley.cs.scads.util.LocalAggregate[_, _],Seq[edu.berkeley.cs.scads.util.LocalAggregate[_, _]]])Seq[edu.berkeley.cs.scads.util.LocalAggregate[_, _]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.LocalAggregate[_, _],Seq[edu.berkeley.cs.scads.util.LocalAggregate[_, _]]]" class="delimiter">(</span><a href="#32125" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], edu.berkeley.cs.scads.util.RemoteAggregate[_, _, _])">_</a>.<span title="=&gt; edu.berkeley.cs.scads.util.LocalAggregate[_, _]">_1</span><span class="delimiter">)</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.LocalAggregate[_, _]],(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int),Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)]])Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)]">zipWithIndex</span>,<a href="#28157" title="org.apache.avro.Schema">groupSchema</a>,<a href="#28154" title="Seq[edu.berkeley.cs.scads.storage.RangeDesc]">partitions</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
      <a href="#28158" title="AnalyticsProtocol.this.AggHandler">handler</a>.<a href="#32092" title="()Unit">getReplies</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#28158" title="AnalyticsProtocol.this.AggHandler">handler</a>.<a href="#32093" title="()Seq[(org.apache.avro.generic.GenericData.Record, Seq[_])]">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>


  <span class="keyword">class</span> <a title="class AggHandler extends java.lang.Object with ScalaObject" id="27894">AggHandler</a>
    <span class="delimiter">(</span><span class="keyword">val</span> <a title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]" id="32094">futures</a>:<span title="Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>,
     <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,String]" id="32095">partitionMap</a>:<span title="scala.collection.mutable.HashMap[String,String]">HashMap</span><span class="delimiter">[</span>String,String<span class="delimiter">]</span>,
     <span class="keyword">val</span> <a title="Int" id="32096">numParts</a>:<span title="Int">Int</span>,
     <span class="keyword">val</span> <a title="Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)]" id="32097">aggs</a>:<span title="Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>LocalAggregate<span class="delimiter">[</span>_,_<span class="delimiter">]</span>,Int<span class="delimiter">)</span><span class="delimiter">]</span>,
     <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="32098">groupSchema</a>:<span title="org.apache.avro.Schema">Schema</span>,
     <span class="keyword">val</span> <a title="Int" id="32099">numRanges</a>:<span title="Int">Int</span>,
     <span class="keyword">val</span> <a title="Long" id="32102">timeout</a>:<span title="Long">Long</span> = <span title="Long(60000L)" class="int">60000</span><span class="delimiter">)</span> <span class="delimiter">{</span>

      <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="32086">responses</a> = <span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" class="keyword">new</span> java.util.concurrent.<span title="java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">LinkedBlockingQueue</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.storage.AggReply]" id="32088">partitionReplies</a> = <span title="()scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.storage.AggReply]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.storage.AggReply]">HashMap</span><span class="delimiter">[</span>String,AggReply<span class="delimiter">]</span>
      <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.TimeoutCounter" id="32090">timeoutCounter</a> = <span title="edu.berkeley.cs.scads.storage.TimeoutCounter" class="keyword">new</span> <a href="QuorumProtocol.scala.html#9894" title="edu.berkeley.cs.scads.storage.TimeoutCounter">TimeoutCounter</a><span class="delimiter">(</span><a href="#32102" title="=&gt; Long">timeout</a><span class="delimiter">)</span>
      
      <span class="keyword">def</span> <a title="()Unit" id="32092">getReplies</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
        <a href="#32094" title="=&gt; Seq[Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]]">futures</a>.<span title="(f: Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#32629" title="Seq[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">_</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#32646" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">_</a>.<span title="(dest: java.util.Queue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]])Unit">forward</span><span class="delimiter">(</span><a href="#32086" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">responses</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Long" id="32607">startTime</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
        
        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#32088" title="=&gt; scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.storage.AggReply]">partitionReplies</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#32096" title="=&gt; Int">numParts</a><span class="delimiter">)</span> <a href="#32830" title="()Unit" class="delimiter">{</a>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]" id="32835">future</a> = 
            <span title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]" class="keyword">if</span> <span class="delimiter">(</span><a href="#32102" title="=&gt; Long">timeout</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
              <a href="#32086" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">responses</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">poll</span><span class="delimiter">(</span><a href="#32090" title="=&gt; edu.berkeley.cs.scads.storage.TimeoutCounter">timeoutCounter</a>.<a href="QuorumProtocol.scala.html#32601" title="=&gt; Long">remaining</a>,TimeUnit.<span title="java.util.concurrent.TimeUnit(value MILLISECONDS)">MILLISECONDS</span><span class="delimiter">)</span>
            <span class="keyword">else</span>
              <a href="#32086" title="=&gt; java.util.concurrent.LinkedBlockingQueue[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">responses</a>.<span title="()edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">take</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#32835" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> 
            <a href="Namespace.scala.html#27902" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;FAILED&quot;)" class="string">&quot;FAILED&quot;</span><span class="delimiter">)</span>
          <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#32835" title="edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]">future</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">source</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Any">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]" id="33455">rap</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
                <span class="keyword">val</span> <a title="String" id="33456">pstr</a> = <a href="#33455" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">rap</a>.<span title="()String">toString</span>
                <span class="keyword">val</span> <a title="String" id="33457">pid</a> = <a href="#32095" title="(key: String)String">partitionMap</a><span class="delimiter">(</span><a href="#33456" title="String">pstr</a><span class="delimiter">)</span>
                <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#32088" title="=&gt; scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.storage.AggReply]">partitionReplies</a>.<span title="(key: String)Boolean">contains</span><span class="delimiter">(</span><a href="#33456" title="String">pstr</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// this is a partition we haven't seen yet</span>
                  <a href="#32835" title="()edu.berkeley.cs.scads.storage.StorageMessage">future</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="AggHandler.this.partitionReplies.type" class="keyword">match</span> <span class="delimiter">{</span>
                    <span class="keyword">case</span> <a title="AggHandler.this.partitionReplies.type" id="33513">a</a>:<a href="../Messages.scala.html#9646" title="edu.berkeley.cs.scads.storage.AggReply">AggReply</a> =&gt; <a href="#32088" title="=&gt; scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.storage.AggReply]">partitionReplies</a> <span title="(kv: (String, edu.berkeley.cs.scads.storage.AggReply))AggHandler.this.partitionReplies.type">+=</span> <span class="delimiter">(</span><span title="(_1: String, _2: edu.berkeley.cs.scads.storage.AggReply)(String, edu.berkeley.cs.scads.storage.AggReply)" class="delimiter">(</span><a href="#33456" title="String">pstr</a>,<a href="#33513" title="edu.berkeley.cs.scads.storage.AggReply">a</a><span class="delimiter">)</span><span class="delimiter">)</span>
                    <span class="keyword">case</span> <a title="Nothing" id="33529">m</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unexpected Message: &quot;)" class="string">&quot;Unexpected Message: &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="#33529" title="edu.berkeley.cs.scads.storage.StorageMessage">m</a><span class="delimiter">)</span>
                  <span class="delimiter">}</span>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Error, no source&quot;)" class="string">&quot;Error, no source&quot;</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

    
      <span class="keyword">def</span> <a title="()Seq[(org.apache.avro.generic.GenericData.Record, Seq[_])]" id="32093">finish</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="Seq[(org.apache.avro.generic.GenericData.Record, Seq[_])]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>GenericData.Record,Seq<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[org.apache.avro.generic.GenericData.Record,scala.collection.mutable.ArrayBuilder[Array[Byte]]]" id="33582">replyMap</a> = <span title="()scala.collection.mutable.HashMap[org.apache.avro.generic.GenericData.Record,scala.collection.mutable.ArrayBuilder[Array[Byte]]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[org.apache.avro.generic.GenericData.Record,scala.collection.mutable.ArrayBuilder[Array[Byte]]]">HashMap</span><span class="delimiter">[</span>GenericData.Record,ArrayBuilder<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>
        <a href="#32088" title="=&gt; scala.collection.mutable.HashMap[String,edu.berkeley.cs.scads.storage.AggReply]">partitionReplies</a> <span title="(f: (String, edu.berkeley.cs.scads.storage.AggReply) =&gt; Unit)Unit">foreach</span> <span class="delimiter">(</span><a title="(String, edu.berkeley.cs.scads.storage.AggReply)" id="33929">pr</a> =&gt; <span class="delimiter">{</span>
          <a href="#33929" title="(String, edu.berkeley.cs.scads.storage.AggReply)">pr</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.AggReply">_2</span>.<a href="../Messages.scala.html#24423" title="=&gt; Seq[edu.berkeley.cs.scads.storage.GroupedAgg]">results</a> <span title="(f: edu.berkeley.cs.scads.storage.GroupedAgg =&gt; Unit)Unit">foreach</span> <span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.GroupedAgg" id="33956">result</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="org.apache.avro.generic.GenericData.Record" id="33957">groupRec</a> = <a href="#33956" title="edu.berkeley.cs.scads.storage.GroupedAgg">result</a>.<a href="../Messages.scala.html#24338" title="=&gt; Option[Array[Byte]]">group</a> <span title="org.apache.avro.generic.GenericData.Record" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Null(null)">None</span> =&gt; <span title="Null(null)" class="keyword">null</span>
              <span class="keyword">case</span> <span title="org.apache.avro.generic.GenericData.Record">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="33959">bytes</a><span class="delimiter">)</span> =&gt; <a href="util/AnalyticsUtils.scala.html#10482" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="util/AnalyticsUtils.scala.html#34667" title="(filterSchema: org.apache.avro.Schema, bytes: Array[Byte])org.apache.avro.generic.GenericData.Record">getRecord</a><span class="delimiter">(</span><a href="#32098" title="=&gt; org.apache.avro.Schema">groupSchema</a>,<a href="#33959" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
              <a href="#32097" title="=&gt; Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)]">aggs</a> <span title="(f: (edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int) =&gt; Unit)Unit">foreach</span> <span class="delimiter">(</span><a title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)" id="33981">ap</a> =&gt; <span class="delimiter">{</span>
                <a href="#33981" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)">ap</a>.<span title="=&gt; edu.berkeley.cs.scads.util.LocalAggregate[_, _]">_1</span>.<a href="util/AnalyticsUtils.scala.html#34695" title="(group: org.apache.avro.generic.GenericData.Record, ar: Array[Byte])Unit">addForGroup</a><span class="delimiter">(</span><a href="#33957" title="org.apache.avro.generic.GenericData.Record">groupRec</a>,<a href="#33956" title="edu.berkeley.cs.scads.storage.GroupedAgg">result</a>.<a href="../Messages.scala.html#24341" title="(idx: Int)Array[Byte]">groupVals</a><span class="delimiter">(</span><a href="#33981" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)">ap</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <span class="delimiter">}</span><span class="delimiter">)</span>
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <a title="Unit" id="34001">e</a>:<span title="Exception">Exception</span> =&gt; <span class="delimiter">{</span><a href="#34001" title="Exception">e</a>.<span title="()Unit">printStackTrace</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Iterable[org.apache.avro.generic.GenericData.Record]" id="33583">grps</a> = <a href="#32097" title="(idx: Int)(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)">aggs</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="=&gt; edu.berkeley.cs.scads.util.LocalAggregate[_, _]">_1</span>.<a href="util/AnalyticsUtils.scala.html#34698" title="()Iterable[org.apache.avro.generic.GenericData.Record]">groups</a> <span class="comment">// all aggs have same groups</span>
        <span title="Seq[(org.apache.avro.generic.GenericData.Record, Seq[_])]" class="keyword">if</span> <span class="delimiter">(</span><a href="#33583" title="Iterable[org.apache.avro.generic.GenericData.Record]">grps</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// not grouping</span>
          <span title="(xs: (Null, Seq[_$10])*)List[(Null, Seq[_$10])]">List</span><span class="delimiter">(</span>
            <span title="(_1: Null, _2: Seq[_$10])(Null, Seq[_$10])" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>,
             <a href="#32097" title="=&gt; Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)]">aggs</a>.<span title="(f: (edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int) =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)],Any,Seq[_]])Seq[_]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Any,Seq[Any]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)" id="34364">ap</a> =&gt; <span class="delimiter">{</span>
               <a href="#34364" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)">ap</a>.<span title="=&gt; edu.berkeley.cs.scads.util.LocalAggregate[_, _]">_1</span>.<a href="util/AnalyticsUtils.scala.html#34696" title="(group: org.apache.avro.generic.GenericData.Record)Any">finishForGroup</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
             <span class="delimiter">}</span><span class="delimiter">)</span>
           <span class="delimiter">)</span>
          <span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <a href="#33583" title="Iterable[org.apache.avro.generic.GenericData.Record]">grps</a>.<span title="(f: org.apache.avro.generic.GenericData.Record =&gt; (org.apache.avro.generic.GenericData.Record, Seq[Any]))(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[org.apache.avro.generic.GenericData.Record],(org.apache.avro.generic.GenericData.Record, Seq[Any]),Iterable[(org.apache.avro.generic.GenericData.Record, Seq[Any])]])Iterable[(org.apache.avro.generic.GenericData.Record, Seq[Any])]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.Iterable.Coll,(org.apache.avro.generic.GenericData.Record, Seq[Any]),Iterable[(org.apache.avro.generic.GenericData.Record, Seq[Any])]]" class="delimiter">(</span><a title="org.apache.avro.generic.GenericData.Record" id="34430">group</a> =&gt; <span class="delimiter">{</span>
            <span title="(_1: org.apache.avro.generic.GenericData.Record, _2: Seq[Any])(org.apache.avro.generic.GenericData.Record, Seq[Any])" class="delimiter">(</span> 
              <a href="#34430" title="org.apache.avro.generic.GenericData.Record">group</a>,
              <a href="#32097" title="=&gt; Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)]">aggs</a>.<span title="(f: (edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int) =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)],Any,Seq[Any]])Seq[Any]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Any,Seq[Any]]" class="delimiter">(</span><a title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)" id="34451">ap</a> =&gt; <span class="delimiter">{</span>
                <a href="#34451" title="(edu.berkeley.cs.scads.util.LocalAggregate[_, _], Int)">ap</a>.<span title="=&gt; edu.berkeley.cs.scads.util.LocalAggregate[_, _]">_1</span>.<a href="util/AnalyticsUtils.scala.html#34696" title="(group: org.apache.avro.generic.GenericData.Record)Any">finishForGroup</a><span class="delimiter">(</span><a href="#34430" title="org.apache.avro.generic.GenericData.Record">group</a><span class="delimiter">)</span>
              <span class="delimiter">}</span><span class="delimiter">)</span> 
            <span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(org.apache.avro.generic.GenericData.Record, Seq[Any])]">toSeq</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>
        

        <span class="comment">//results.foreach (result =&gt; {</span>

          <span class="comment">//            aggs foreach(ap =&gt; {</span>
          <span class="comment">//              val aggReply = ap._1.replyInstance</span>
          <span class="comment">//              aggReply.parse(result.groupVals(ap._2))</span>
          <span class="comment">//              aggReplies = aggReply :: aggReplies                </span>
          <span class="comment">//            })</span>
          <span class="comment">//          })</span>
          <span class="comment">//        }</span>

        <span class="comment">//val f = aggReplies.foldLeft(aggClasses(0).localAggregate.init())(aggClasses(0).localAggregate.foldFunction)</span>
        <span class="comment">//aggClasses(0).localAggregate.finalize(f)</span>




        </pre>
    </body>
</html>