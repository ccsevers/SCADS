<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>transactions/conflict/PendingUpdates.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage
<span class="keyword">package</span> transactions
<span class="keyword">package</span> conflict

<span class="keyword">import</span> actors.threadpool.<span title="object scala.actors.threadpool.ThreadPoolExecutor">ThreadPoolExecutor</span>.AbortPolicy
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer

<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> java.util.Arrays

<span class="keyword">import</span> scala.collection.mutable.Buffer
<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.mutable.HashMap

<span class="keyword">import</span> java.io._
<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> org.apache.avro.io.<span class="delimiter">{</span>BinaryData, DecoderFactory, BinaryEncoder, BinaryDecoder, EncoderFactory<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.specific.<span class="delimiter">{</span>SpecificDatumWriter, SpecificDatumReader, SpecificRecordBase, SpecificRecord<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.Schema

<span class="keyword">import</span> edu.berkeley.cs.avro.marker._

<span class="comment">// TODO: Make thread-safe.  It might already be, by using TxDB</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.transactions.conflict.Status" id="10366">Status</a> <span title="ScalaObject" class="keyword">extends</span> <span title="Enumeration">Enumeration</span> <span class="delimiter">{</span>
  <span class="keyword">type</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value" id="81105">Status</a> = <span title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Value</span>
  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value" id="81106">Commit</a>, <a title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value" id="81108">Abort</a>, <a title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value" id="81110">Unknown</a>, <a title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value" id="81112">Accept</a>, <a title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value" id="81114">Reject</a> = <span title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Value</span>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait DBRecords extends java.lang.Object" id="10368">DBRecords</a> <span title="java.lang.Object" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]" id="74781">db</a>: <a href="../TxDB.scala.html#10286" title="edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">TxDB</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">val</span> <a title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDBFactory" id="74782">factory</a>: <a href="../TxDB.scala.html#10296" title="edu.berkeley.cs.scads.storage.transactions.TxDBFactory">TxDBFactory</a>
<span class="delimiter">}</span>

<span class="keyword">trait</span> <a title="trait PendingUpdates extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.conflict.DBRecords with ScalaObject" id="10369">PendingUpdates</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10368" title="edu.berkeley.cs.scads.storage.transactions.conflict.DBRecords">DBRecords</a> <span class="delimiter">{</span>
  <span class="comment">// Even on abort, store the xid and always abort it afterwards --&gt; Check</span>
  <span class="comment">// NoOp property</span>
  <span class="comment">// Is only allowed to accept, if the operation will be successful, even</span>
  <span class="comment">// if all outstanding Cmd might be NullOps</span>
  <span class="comment">// If accepted, returns all the cstructs for all the keys.  Otherwise, None</span>
  <span class="comment">// is returned.</span>
  <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]" id="74784">accept</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="80621">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>, <a title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]" id="80622">updates</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">Seq</span><span class="delimiter">[</span>RecordUpdate<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, CStruct<span class="delimiter">)</span><span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, update: edu.berkeley.cs.scads.storage.RecordUpdate)Option[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]" id="74785">accept</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="80614">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>, <a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="80615">update</a>: <a href="../../Messages.scala.html#9680" title="edu.berkeley.cs.scads.storage.RecordUpdate">RecordUpdate</a><span class="delimiter">)</span>: <span title="Option[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">Option</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, CStruct<span class="delimiter">)</span><span class="delimiter">]</span>

  <span class="comment">// Value is chosen (reflected in the db) and confirms trx state.</span>
  <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])Boolean" id="74786">commit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="80670">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>, <a title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]" id="80671">updates</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">Seq</span><span class="delimiter">[</span>RecordUpdate<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span>

  <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid)Unit" id="74787">abort</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="81139">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid)edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status" id="74788">getDecision</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="98338">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a><span class="delimiter">)</span>: Status.<span title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status">Status</span>

  <span class="keyword">def</span> <a title="(key: Array[Byte])Option[edu.berkeley.cs.scads.storage.CStruct]" id="74789">getCStruct</a><span class="delimiter">(</span><a title="Array[Byte]" id="98340">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[edu.berkeley.cs.scads.storage.CStruct]">Option</span><span class="delimiter">[</span>CStruct<span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="()Unit" id="74790">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="74791">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(ics: edu.berkeley.cs.scads.storage.FieldICList)Unit" id="74792">setICs</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.FieldICList" id="75435">ics</a>: <a href="../../Messages.scala.html#9707" title="edu.berkeley.cs.scads.storage.FieldICList">FieldICList</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">// TODO: Enumerations do not work with AvroRecords. Must be changed if we want</span>
<span class="comment">//       to use AvroRecords for serialization.</span>
<span class="comment">// Status of a transaction.  Stores all the updates in the transaction.</span>
case <span class="keyword">class</span> <a title="class TxStatusEntry extends java.lang.Object with java.io.Serializable with ScalaObject with Product with Serializable" id="100118">TxStatusEntry</a><a href="#100118" title="ScalaObject" class="delimiter">(</a><span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status" id="81120">status</a>: Status.<span title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status">Status</span>,
                         <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]" id="81121">updates</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">Seq</span><span class="delimiter">[</span>RecordUpdate<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.io.Serializable">Serializable</span>

case <span class="keyword">class</span> <a href="#177943" title="class PendingStateInfo extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with java.io.Serializable with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="100114">PendingStateInfo</a><a href="#100114" title="ScalaObject" class="delimiter">(</a><a href="#100114" title="()edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="133575" class="keyword">var</a> <a title="Array[Byte]" id="99219">state</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>,
                            <span class="keyword">var</span> <a title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]" id="99220">xids</a>: <span title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">List</span><span class="delimiter">[</span>List<span class="delimiter">[</span>ScadsXid<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.io.Serializable">Serializable</span> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span>
case <span class="keyword">class</span> <a href="#179300" title="class PendingCommandsInfo extends org.apache.avro.specific.SpecificRecordBase with edu.berkeley.cs.avro.runtime.HasAvroConversions with java.io.Serializable with edu.berkeley.cs.avro.marker.AvroRecord with ScalaObject with Product with Serializable" id="100110">PendingCommandsInfo</a><a href="#100110" title="ScalaObject" class="delimiter">(</a><a href="#100110" title="()edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo" id="133585" class="keyword">var</a> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" id="80763">commands</a>: <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">ArrayBuffer</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>,
                               <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]" id="80764">states</a>: <span title="Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">Seq</span><span class="delimiter">[</span>PendingStateInfo<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.io.Serializable">Serializable</span> <span class="keyword">with</span> <span title="edu.berkeley.cs.avro.marker.AvroRecord">AvroRecord</span> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(command: edu.berkeley.cs.scads.storage.CStructCommand)Unit" id="76133">appendCommand</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="98483">command</a>: <a href="../../Messages.scala.html#9671" title="edu.berkeley.cs.scads.storage.CStructCommand">CStructCommand</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(elems: edu.berkeley.cs.scads.storage.CStructCommand*)Unit">append</span><span class="delimiter">(</span><a href="#98483" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(command: edu.berkeley.cs.scads.storage.CStructCommand, logicalUpdater: edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater)Unit" id="76134">commitCommand</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="80775">command</a>: <a href="../../Messages.scala.html#9671" title="edu.berkeley.cs.scads.storage.CStructCommand">CStructCommand</a>, <a title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater" id="80776">logicalUpdater</a>: <a href="#10382" title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">LogicalRecordUpdater</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// TODO: Linear search for xid.  Store hash for performance?</span>
    <span class="keyword">val</span> <a title="Int" id="80779">index</a> = <a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(p: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Boolean)Int">indexWhere</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="80806">x</a> =&gt; <a href="#80806" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#80775" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80779" title="Int">index</a> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// This commmand was not pending.</span>
      <a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(elems: edu.berkeley.cs.scads.storage.CStructCommand*)Unit">append</span><span class="delimiter">(</span><a href="#80775" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a><span class="delimiter">)</span>
      <span class="comment">// Update all the states to include this command.  Only the states</span>
      <span class="comment">// have to change.</span>
      <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="80816">deltaBytes</a> = <a href="#80775" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26997" title="=&gt; edu.berkeley.cs.scads.storage.RecordUpdate">command</a> <span title="Option[Array[Byte]]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Option[Array[Byte]]">LogicalUpdate</span><span class="delimiter">(</span>_, <a title="Array[Byte]" id="80818">delta</a><span class="delimiter">)</span> =&gt; <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#80818" title="Array[Byte]">delta</a><span class="delimiter">)</span>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a>
        <span class="keyword">case</span> <span title="None.type">_</span> =&gt; <span title="object None">None</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80816" title="Option[Array[Byte]]">deltaBytes</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#80764" title="(x$1: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">states</a> = <a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="(f: edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo =&gt; edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo],edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]])Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="80852">x</a> =&gt; <span class="delimiter">{</span>
          <a href="#80852" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99219" title="(x$1: Array[Byte])Unit">state</a> = <a href="#80776" title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">logicalUpdater</a>.<a href="#80730" title="(baseBytes: Option[Array[Byte]], deltaBytes: Option[Array[Byte]])Array[Byte]">applyDeltaBytes</a><span class="delimiter">(</span><span title="(x: Array[Byte])Option[Array[Byte]]">Option</span><span class="delimiter">(</span><a href="#80852" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99219" title="=&gt; Array[Byte]">state</a><span class="delimiter">)</span>, <a href="#80816" title="Option[Array[Byte]]">deltaBytes</a><span class="delimiter">)</span>
          <a href="#80852" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a><span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(idx: Int, elem: edu.berkeley.cs.scads.storage.CStructCommand)Unit">update</span><span class="delimiter">(</span><a href="#80779" title="Int">index</a>, <a href="#80775" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a><span class="delimiter">)</span>
      <span class="comment">// Update all the states and the xid lists.</span>
      <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="80890">deltaBytes</a> = <a href="#80775" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26997" title="=&gt; edu.berkeley.cs.scads.storage.RecordUpdate">command</a> <span title="Option[Array[Byte]]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Option[Array[Byte]]">LogicalUpdate</span><span class="delimiter">(</span>_, <a title="Array[Byte]" id="80902">delta</a><span class="delimiter">)</span> =&gt; <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#80902" title="Array[Byte]">delta</a><span class="delimiter">)</span>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a>
        <span class="keyword">case</span> <span title="None.type">_</span> =&gt; <span title="object None">None</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80890" title="Option[Array[Byte]]">deltaBytes</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#80764" title="(x$1: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">states</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">ArrayBuffer</span><span class="delimiter">[</span>PendingStateInfo<span class="delimiter">]</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#80764" title="(x$1: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">states</a> = <a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="(p: edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo =&gt; Boolean)Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">filter</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="80921">x</a> =&gt; <a href="#80921" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99220" title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">xids</a>.<span title="(p: List[edu.berkeley.cs.scads.storage.ScadsXid] =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a title="List[edu.berkeley.cs.scads.storage.ScadsXid]" id="80940">y</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#80940" title="List[edu.berkeley.cs.scads.storage.ScadsXid]">y</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#80775" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo =&gt; edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo],edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]])Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="80960">x</a> =&gt; <span class="delimiter">{</span>
            <a href="#80960" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99220" title="(x$1: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])Unit">xids</a> = <a href="#80960" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99220" title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">xids</a>.<span title="(p: List[edu.berkeley.cs.scads.storage.ScadsXid] =&gt; Boolean)List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">filterNot</span><span class="delimiter">(</span><a title="List[edu.berkeley.cs.scads.storage.ScadsXid]" id="80967">y</a> =&gt; <a href="#80967" title="List[edu.berkeley.cs.scads.storage.ScadsXid]">y</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#80775" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#80960" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99219" title="(x$1: Array[Byte])Unit">state</a> = <a href="#80776" title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">logicalUpdater</a>.<a href="#80730" title="(baseBytes: Option[Array[Byte]], deltaBytes: Option[Array[Byte]])Array[Byte]">applyDeltaBytes</a><span class="delimiter">(</span><span title="(x: Array[Byte])Option[Array[Byte]]">Option</span><span class="delimiter">(</span><a href="#80960" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99219" title="=&gt; Array[Byte]">state</a><span class="delimiter">)</span>, <a href="#80890" title="Option[Array[Byte]]">deltaBytes</a><span class="delimiter">)</span>
            <a href="#80960" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a><span class="delimiter">}</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(command: edu.berkeley.cs.scads.storage.CStructCommand)Unit" id="76135">abortCommand</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="81191">command</a>: <a href="../../Messages.scala.html#9671" title="edu.berkeley.cs.scads.storage.CStructCommand">CStructCommand</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// TODO: Linear search for xid.  Store hash for performance?</span>
    <span class="keyword">val</span> <a title="Int" id="81194">index</a> = <a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(p: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Boolean)Int">indexWhere</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="81209">x</a> =&gt; <a href="#81209" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#81191" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#81194" title="Int">index</a> <span title="(x: Int)Boolean">!=</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(n: Int)edu.berkeley.cs.scads.storage.CStructCommand">remove</span><span class="delimiter">(</span><a href="#81194" title="Int">index</a><span class="delimiter">)</span>
      <span class="comment">// Update the states and the xid lists to reflect this abort.</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#80764" title="(x$1: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">states</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">ArrayBuffer</span><span class="delimiter">[</span>PendingStateInfo<span class="delimiter">]</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#80764" title="(x$1: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">states</a> = <a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="(p: edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo =&gt; Boolean)Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">filter</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="81240">x</a> =&gt; <a href="#81240" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99220" title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">xids</a>.<span title="(p: List[edu.berkeley.cs.scads.storage.ScadsXid] =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a title="List[edu.berkeley.cs.scads.storage.ScadsXid]" id="81249">y</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#81249" title="List[edu.berkeley.cs.scads.storage.ScadsXid]">y</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#81191" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo =&gt; edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo],edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]])Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="81269">x</a> =&gt; <span class="delimiter">{</span>
          <a href="#81269" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99220" title="(x$1: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])Unit">xids</a> = <a href="#81269" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a>.<a href="#99220" title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">xids</a>.<span title="(p: List[edu.berkeley.cs.scads.storage.ScadsXid] =&gt; Boolean)List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">filterNot</span><span class="delimiter">(</span><a title="List[edu.berkeley.cs.scads.storage.ScadsXid]" id="81275">y</a> =&gt; <a href="#81275" title="List[edu.berkeley.cs.scads.storage.ScadsXid]">y</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#81191" title="edu.berkeley.cs.scads.storage.CStructCommand">command</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#81269" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">x</a><span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(newStates: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit" id="76136">updateStates</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]" id="98487">newStates</a>: <span title="Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">Seq</span><span class="delimiter">[</span>PendingStateInfo<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#80764" title="(x$1: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">states</a> = <a href="#98487" title="Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">newStates</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class PendingUpdatesController extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.conflict.PendingUpdates with ScalaObject" id="10379">PendingUpdatesController</a><a href="#10379" title="ScalaObject" class="delimiter">(</a><span class="keyword">override</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]" id="74826">db</a>: <a href="../TxDB.scala.html#10286" title="edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">TxDB</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,
                               <span class="keyword">override</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TxDBFactory" id="74827">factory</a>: <a href="../TxDB.scala.html#10296" title="edu.berkeley.cs.scads.storage.transactions.TxDBFactory">TxDBFactory</a>,
                               <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="74828">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>,
                               <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="74829">valueSchema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#10369" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingUpdates">PendingUpdates</a> <span class="delimiter">{</span>

  <span class="comment">// Transaction state info. Maps txid -&gt; txstatus/decision.</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]" id="74806">txStatus</a> =
    <a href="#74827" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDBFactory">factory</a>.<a href="../TxDB.scala.html#74881" title="[K &lt;: AnyRef, V &lt;: AnyRef](name: String)edu.berkeley.cs.scads.storage.transactions.TxDB[K,V]">getNewDB</a><span title="(name: String)edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]" class="delimiter">[</span><a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>, <a href="#100118" title="edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">TxStatusEntry</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74841" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd">getName</a> <span title="(other: String)java.lang.String">+</span> <span title="java.lang.String(&quot;.txstatus&quot;)" class="string">&quot;.txstatus&quot;</span><span class="delimiter">)</span>
  <span class="comment">// CStructs per key.</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]" id="74808">pendingCStructs</a> =
    <a href="#74827" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDBFactory">factory</a>.<a href="../TxDB.scala.html#74881" title="[K &lt;: AnyRef, V &lt;: AnyRef](name: String)edu.berkeley.cs.scads.storage.transactions.TxDB[K,V]">getNewDB</a><span title="(name: String)edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a href="#100110" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">PendingCommandsInfo</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74841" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd">getName</a> <span title="(other: String)java.lang.String">+</span> <span title="java.lang.String(&quot;.pendingcstructs&quot;)" class="string">&quot;.pendingcstructs&quot;</span><span class="delimiter">)</span>

  <span class="comment">// Detects conflicts for new updates.</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.NewUpdateResolver" id="74811">newUpdateResolver</a> = <span title="edu.berkeley.cs.scads.storage.transactions.conflict.NewUpdateResolver" class="keyword">new</span> <a href="#10380" title="edu.berkeley.cs.scads.storage.transactions.conflict.NewUpdateResolver">NewUpdateResolver</a><span class="delimiter">(</span><a href="#74828" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#74829" title="=&gt; org.apache.avro.Schema">valueSchema</a>, <a href="#74816" title="=&gt; edu.berkeley.cs.scads.storage.FieldICList">valueICs</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater" id="74813">logicalRecordUpdater</a> = <span title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater" class="keyword">new</span> <a href="#10382" title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">LogicalRecordUpdater</a><span class="delimiter">(</span><a href="#74829" title="=&gt; org.apache.avro.Schema">valueSchema</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.FieldICList" id="74816">valueICs</a>: <a href="../../Messages.scala.html#9707" title="edu.berkeley.cs.scads.storage.FieldICList">FieldICList</a> = <span title="Null(null)" class="keyword">null</span>

  <span class="keyword">def</span> <a title="(ics: edu.berkeley.cs.scads.storage.FieldICList)Unit" id="74818">setICs</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.FieldICList" id="75433">ics</a>: <a href="../../Messages.scala.html#9707" title="edu.berkeley.cs.scads.storage.FieldICList">FieldICList</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#74816" title="(x$1: edu.berkeley.cs.scads.storage.FieldICList)Unit">valueICs</a> = <a href="#75433" title="edu.berkeley.cs.scads.storage.FieldICList">ics</a>
    <a href="#74811" title="(x$1: edu.berkeley.cs.scads.storage.transactions.conflict.NewUpdateResolver)Unit">newUpdateResolver</a> = <span title="edu.berkeley.cs.scads.storage.transactions.conflict.NewUpdateResolver" class="keyword">new</span> <a href="#10380" title="edu.berkeley.cs.scads.storage.transactions.conflict.NewUpdateResolver">NewUpdateResolver</a><span class="delimiter">(</span><a href="#74828" title="=&gt; org.apache.avro.Schema">keySchema</a>, <a href="#74829" title="=&gt; org.apache.avro.Schema">valueSchema</a>, <a href="#74816" title="=&gt; edu.berkeley.cs.scads.storage.FieldICList">valueICs</a><span class="delimiter">)</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="java.lang.String(&quot;ics: &quot;)" class="string">&quot;ics: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#74816" title="=&gt; edu.berkeley.cs.scads.storage.FieldICList">valueICs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>


  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, update: edu.berkeley.cs.scads.storage.RecordUpdate)Option[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]" id="74819">accept</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="80617">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>, <a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="80618">update</a>: <a href="../../Messages.scala.html#9680" title="edu.berkeley.cs.scads.storage.RecordUpdate">RecordUpdate</a><span class="delimiter">)</span>: <span title="Option[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">Option</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, CStruct<span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#74820" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">accept</a><span class="delimiter">(</span><a href="#80617" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#80618" title="edu.berkeley.cs.scads.storage.RecordUpdate">update</a> <a href="#98557" title="(x: edu.berkeley.cs.scads.storage.RecordUpdate)List[edu.berkeley.cs.scads.storage.RecordUpdate]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>.<span title="=&gt; Option[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">headOption</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]" id="74820">accept</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="80624">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>, <a title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]" id="80625">updates</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">Seq</span><span class="delimiter">[</span>RecordUpdate<span class="delimiter">]</span><span class="delimiter">)</span> : <span title="Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, CStruct<span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Boolean" id="98563">success</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="98564">txn</a> = <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74836" title="()edu.berkeley.cs.scads.storage.transactions.TransactionData">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="98565">pendingCommandsTxn</a> = <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74836" title="()edu.berkeley.cs.scads.storage.transactions.TransactionData">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]" id="98566">cstructs</a>: <span title="Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">Seq</span><span class="delimiter">[</span><span class="delimiter">(</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, CStruct<span class="delimiter">)</span><span class="delimiter">]</span> = <span title="object Nil">Nil</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <a href="#98566" title="Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">cstructs</a> = <a href="#80625" title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">updates</a>.<span title="(f: edu.berkeley.cs.scads.storage.RecordUpdate =&gt; (Array[Byte], edu.berkeley.cs.scads.storage.CStruct))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.RecordUpdate],(Array[Byte], edu.berkeley.cs.scads.storage.CStruct),Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]])Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Array[Byte], edu.berkeley.cs.scads.storage.CStruct),Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="98583">r</a> =&gt; <span class="delimiter">{</span>
        <span title="(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)" class="keyword">if</span> <span class="delimiter">(</span><a href="#98563" title="Boolean">success</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]" id="98584">storedMDCCRec</a>: <span title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">Option</span><span class="delimiter">[</span>MDCCRecord<span class="delimiter">]</span> =
            <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74835" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte])Option[Array[Byte]]">get</a><span class="delimiter">(</span><a href="#98564" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a>, <a href="#98583" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(f: Array[Byte] =&gt; edu.berkeley.cs.scads.storage.MDCCRecord)Option[edu.berkeley.cs.scads.storage.MDCCRecord]">map</span><span class="delimiter">(</span><a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#98593" title="Array[Byte]">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="98585">storedRecValue</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> =
            <a href="#98584" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">storedMDCCRec</a> <span title="Option[Array[Byte]]" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Option[Array[Byte]]">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="98596">v</a><span class="delimiter">)</span> =&gt; <a href="#98596" title="edu.berkeley.cs.scads.storage.MDCCRecord">v</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a>
              <span class="keyword">case</span> <span title="None.type">None</span> =&gt; <span title="object None">None</span>
            <span class="delimiter">}</span>

          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo" id="98586">commandsInfo</a> = <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74835" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte])Option[edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">get</a><span class="delimiter">(</span><a href="#98565" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a>, <a href="#98583" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a><span class="delimiter">)</span> <span title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">None</span> =&gt; <a href="#100110" title="(commands: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand], states: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">PendingCommandsInfo</a><span class="delimiter">(</span><span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">ArrayBuffer</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>,
                                             <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">ArrayBuffer</span><span class="delimiter">[</span>PendingStateInfo<span class="delimiter">]</span><span class="delimiter">)</span>
            <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo" id="98608">c</a><span class="delimiter">)</span> =&gt; <a href="#98608" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">c</a>
          <span class="delimiter">}</span>

          <span class="comment">// Add the updates to the pending list, if compatible.</span>
          <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><a href="#74811" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.NewUpdateResolver">newUpdateResolver</a>.<a href="#75453" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, commandsInfo: edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo, dbValue: Option[edu.berkeley.cs.scads.storage.MDCCRecord], newUpdate: edu.berkeley.cs.scads.storage.RecordUpdate)Boolean">isCompatible</a><span class="delimiter">(</span><a href="#80624" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#98586" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>, <a href="#98584" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">storedMDCCRec</a>, <a href="#98583" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// No conflict</span>
            <a href="#98586" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#76133" title="(command: edu.berkeley.cs.scads.storage.CStructCommand)Unit">appendCommand</a><span class="delimiter">(</span><a href="../../Messages.scala.html#27050" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, command: edu.berkeley.cs.scads.storage.RecordUpdate, pending: Boolean)edu.berkeley.cs.scads.storage.CStructCommand">CStructCommand</a><span class="delimiter">(</span><a href="#80624" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#98583" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte], value: edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo)Boolean">put</a><span class="delimiter">(</span><a href="#98565" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a>, <a href="#98583" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a>, <a href="#98586" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#98563" title="Boolean">success</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>
          <span title="(_1: Array[Byte], _2: edu.berkeley.cs.scads.storage.CStruct)(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)" class="delimiter">(</span><a href="#98583" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a>, <a href="../../Messages.scala.html#27135" title="(value: Option[Array[Byte]], commands: Seq[edu.berkeley.cs.scads.storage.CStructCommand])edu.berkeley.cs.scads.storage.CStruct">CStruct</a><span class="delimiter">(</span><a href="#98585" title="Option[Array[Byte]]">storedRecValue</a>, <a href="#98586" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span title="(_1: Null, _2: Null)(Null, Null)" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="98670">e</a>: <span title="Exception">Exception</span> =&gt; <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
      <a href="#98563" title="Boolean">success</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
    <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><a href="#98563" title="Boolean">success</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74837" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txCommit</a><span class="delimiter">(</span><a href="#98564" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a><span class="delimiter">)</span>
      <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74837" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txCommit</a><span class="delimiter">(</span><a href="#98565" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a><span class="delimiter">)</span>
      <span class="comment">// TODO: Handle the case when the commit arrives before the prepare.</span>
      <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74833" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: edu.berkeley.cs.scads.storage.ScadsXid, value: edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry)Boolean">putNoOverwrite</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#80624" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#100118" title="(status: edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">TxStatusEntry</a><span class="delimiter">(</span><a href="#10366" title="object edu.berkeley.cs.scads.storage.transactions.conflict.Status">Status</a>.<a href="#81112" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Accept</a>, <a href="#80625" title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">updates</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74838" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txAbort</a><span class="delimiter">(</span><a href="#98564" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a><span class="delimiter">)</span>
      <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74838" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txAbort</a><span class="delimiter">(</span><a href="#98565" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a><span class="delimiter">)</span>
      <span class="comment">// TODO: Handle the case when the commit arrives before the prepare.</span>
      <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74833" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: edu.berkeley.cs.scads.storage.ScadsXid, value: edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry)Boolean">putNoOverwrite</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#80624" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#100118" title="(status: edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">TxStatusEntry</a><span class="delimiter">(</span><a href="#10366" title="object edu.berkeley.cs.scads.storage.transactions.conflict.Status">Status</a>.<a href="#81114" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Reject</a>, <a href="#80625" title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">updates</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#98566" title="Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">cstructs</a> = <span title="object Nil">Nil</span>
    <span class="delimiter">}</span>
    <a href="#98566" title="Seq[(Array[Byte], edu.berkeley.cs.scads.storage.CStruct)]">cstructs</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])Boolean" id="74821">commit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="80667">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>, <a title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]" id="80668">updates</a>: <span title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">Seq</span><span class="delimiter">[</span>RecordUpdate<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// TODO: Handle out of order commits to same records.</span>
    <span class="keyword">var</span> <a title="Boolean" id="80674">success</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="80675">txn</a> = <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74836" title="()edu.berkeley.cs.scads.storage.transactions.TransactionData">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="80676">pendingCommandsTxn</a> = <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74836" title="()edu.berkeley.cs.scads.storage.transactions.TransactionData">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <a href="#80668" title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">updates</a>.<span title="(f: edu.berkeley.cs.scads.storage.RecordUpdate =&gt; Boolean)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="80694">r</a> =&gt; <span class="delimiter">{</span>
        <span class="comment">// TODO: These updates overwrite the metadata.  Probably have to</span>
        <span class="comment">//       selectively update only the value part of the record.</span>
        <a href="#80694" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Boolean">LogicalUpdate</span><span class="delimiter">(</span><a title="Array[Byte]" id="80696">key</a>, <a title="Array[Byte]" id="80697">delta</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
            <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74835" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte])Option[Array[Byte]]">get</a><span class="delimiter">(</span><a href="#80675" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a>, <a href="#80696" title="Array[Byte]">key</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Boolean">None</span> =&gt; <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte], value: Array[Byte])Boolean">put</a><span class="delimiter">(</span><a href="#80675" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a>, <a href="#80696" title="Array[Byte]">key</a>, <a href="#80697" title="Array[Byte]">delta</a><span class="delimiter">)</span>
              <span class="keyword">case</span> <span title="Boolean">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="80711">recBytes</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="80712">deltaRec</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#80697" title="Array[Byte]">delta</a><span class="delimiter">)</span>
                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="80713">dbRec</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#80711" title="Array[Byte]">recBytes</a><span class="delimiter">)</span>
                <span class="keyword">val</span> <a title="Array[Byte]" id="80714">newBytes</a> = <a href="#74813" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">logicalRecordUpdater</a>.<a href="#80730" title="(baseBytes: Option[Array[Byte]], deltaBytes: Option[Array[Byte]])Array[Byte]">applyDeltaBytes</a><span class="delimiter">(</span><a href="#80713" title="edu.berkeley.cs.scads.storage.MDCCRecord">dbRec</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a>, <a href="#80712" title="edu.berkeley.cs.scads.storage.MDCCRecord">deltaRec</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a><span class="delimiter">)</span>
                <span class="keyword">val</span> <a title="Array[Byte]" id="80715">newRec</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80719" title="(rec: edu.berkeley.cs.scads.storage.MDCCRecord)Array[Byte]">toBytes</a><span class="delimiter">(</span><a href="../../Messages.scala.html#27221" title="(value: Option[Array[Byte]], metadata: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.MDCCRecord">MDCCRecord</a><span class="delimiter">(</span><span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#80714" title="Array[Byte]">newBytes</a><span class="delimiter">)</span>, <a href="#80713" title="edu.berkeley.cs.scads.storage.MDCCRecord">dbRec</a>.<a href="../../Messages.scala.html#27192" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">metadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte], value: Array[Byte])Boolean">put</a><span class="delimiter">(</span><a href="#80675" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a>, <a href="#80696" title="Array[Byte]">key</a>, <a href="#80715" title="Array[Byte]">newRec</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <span title="Boolean">ValueUpdate</span><span class="delimiter">(</span><a title="Array[Byte]" id="80748">key</a>, <a title="Option[Array[Byte]]" id="80749">oldValue</a>, <a title="Array[Byte]" id="80750">newValue</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
            <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte], value: Array[Byte])Boolean">put</a><span class="delimiter">(</span><a href="#80675" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a>, <a href="#80748" title="Array[Byte]">key</a>, <a href="#80750" title="Array[Byte]">newValue</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <span title="Boolean">VersionUpdate</span><span class="delimiter">(</span><a title="Array[Byte]" id="80751">key</a>, <a title="Array[Byte]" id="80752">newValue</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
            <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte], value: Array[Byte])Boolean">put</a><span class="delimiter">(</span><a href="#80675" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a>, <a href="#80751" title="Array[Byte]">key</a>, <a href="#80752" title="Array[Byte]">newValue</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="comment">// Commit the updates in the pending list.</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo" id="80695">commandsInfo</a> = <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74835" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte])Option[edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">get</a><span class="delimiter">(</span><a href="#80676" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a>, <a href="#80694" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo)edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">getOrElse</span><span class="delimiter">(</span><a href="#100110" title="(commands: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand], states: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">PendingCommandsInfo</a><span class="delimiter">(</span><span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">ArrayBuffer</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>, <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">ArrayBuffer</span><span class="delimiter">[</span>PendingStateInfo<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#80695" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#76134" title="(command: edu.berkeley.cs.scads.storage.CStructCommand, logicalUpdater: edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater)Unit">commitCommand</a><span class="delimiter">(</span><a href="../../Messages.scala.html#27050" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, command: edu.berkeley.cs.scads.storage.RecordUpdate, pending: Boolean)edu.berkeley.cs.scads.storage.CStructCommand">CStructCommand</a><span class="delimiter">(</span><a href="#80667" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#80694" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>, <a href="#74813" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">logicalRecordUpdater</a><span class="delimiter">)</span>

        <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte], value: edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo)Boolean">put</a><span class="delimiter">(</span><a href="#80676" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a>, <a href="#80694" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a>, <a href="#80695" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74837" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txCommit</a><span class="delimiter">(</span><a href="#80675" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a><span class="delimiter">)</span>
      <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74837" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txCommit</a><span class="delimiter">(</span><a href="#80676" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="80999">e</a>: <span title="Exception">Exception</span> =&gt; <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
      <a href="#74826" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],Array[Byte]]">db</a>.<a href="../TxDB.scala.html#74838" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txAbort</a><span class="delimiter">(</span><a href="#80675" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">txn</a><span class="delimiter">)</span>
      <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74838" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txAbort</a><span class="delimiter">(</span><a href="#80676" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a><span class="delimiter">)</span>
      <a href="#80674" title="Boolean">success</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>

    <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: edu.berkeley.cs.scads.storage.ScadsXid, value: edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry)Boolean">put</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#80667" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#100118" title="(status: edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">TxStatusEntry</a><span class="delimiter">(</span><a href="#10366" title="object edu.berkeley.cs.scads.storage.transactions.conflict.Status">Status</a>.<a href="#81106" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Commit</a>, <a href="#80668" title="Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">updates</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#80674" title="Boolean">success</a>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid)Unit" id="74822">abort</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="81137">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="81142">pendingCommandsTxn</a> = <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74836" title="()edu.berkeley.cs.scads.storage.transactions.TransactionData">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74835" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: edu.berkeley.cs.scads.storage.ScadsXid)Option[edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">get</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#81137" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Boolean">None</span> =&gt; <span class="delimiter">{</span>
          <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: edu.berkeley.cs.scads.storage.ScadsXid, value: edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry)Boolean">put</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#81137" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#100118" title="(status: edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">TxStatusEntry</a><span class="delimiter">(</span><a href="#10366" title="object edu.berkeley.cs.scads.storage.transactions.conflict.Status">Status</a>.<a href="#81108" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Abort</a>, List<span class="delimiter">[</span>RecordUpdate<span class="delimiter">]</span><span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Boolean">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry" id="81155">status</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#81155" title="edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">status</a>.<a href="#81121" title="=&gt; Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">updates</a>.<span title="(f: edu.berkeley.cs.scads.storage.RecordUpdate =&gt; Boolean)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="81178">r</a> =&gt; <span class="delimiter">{</span>
            <span class="comment">// Remove the updates in the pending list.</span>
            <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo" id="81179">commandsInfo</a> = <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74835" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte])Option[edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">get</a><span class="delimiter">(</span><a href="#81142" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a>, <a href="#81178" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo)edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">getOrElse</span><span class="delimiter">(</span><a href="#100110" title="(commands: scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand], states: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">PendingCommandsInfo</a><span class="delimiter">(</span><span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">ArrayBuffer</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>, <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">ArrayBuffer</span><span class="delimiter">[</span>PendingStateInfo<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#81179" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#76135" title="(command: edu.berkeley.cs.scads.storage.CStructCommand)Unit">abortCommand</a><span class="delimiter">(</span><a href="../../Messages.scala.html#27050" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, command: edu.berkeley.cs.scads.storage.RecordUpdate, pending: Boolean)edu.berkeley.cs.scads.storage.CStructCommand">CStructCommand</a><span class="delimiter">(</span><a href="#81137" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#81178" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span>

            <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: Array[Byte], value: edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo)Boolean">put</a><span class="delimiter">(</span><a href="#81142" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a>, <a href="#81178" title="edu.berkeley.cs.scads.storage.RecordUpdate">r</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a>, <a href="#81179" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>
          <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74832" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: edu.berkeley.cs.scads.storage.ScadsXid, value: edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry)Boolean">put</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#81137" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <a href="#100118" title="(status: edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status, updates: Seq[edu.berkeley.cs.scads.storage.RecordUpdate])edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">TxStatusEntry</a><span class="delimiter">(</span><a href="#10366" title="object edu.berkeley.cs.scads.storage.transactions.conflict.Status">Status</a>.<a href="#81108" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Abort</a>, <a href="#81155" title="edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">status</a>.<a href="#81121" title="=&gt; Seq[edu.berkeley.cs.scads.storage.RecordUpdate]">updates</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74837" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txCommit</a><span class="delimiter">(</span><a href="#81142" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="81304">e</a>: <span title="Exception">Exception</span> =&gt; <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>
      <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74838" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit">txAbort</a><span class="delimiter">(</span><a href="#81142" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">pendingCommandsTxn</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid)edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status" id="74823">getDecision</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="98690">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74835" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: edu.berkeley.cs.scads.storage.ScadsXid)Option[edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">get</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#98690" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span> <span title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">None</span> =&gt; <a href="#10366" title="object edu.berkeley.cs.scads.storage.transactions.conflict.Status">Status</a>.<a href="#81110" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Value">Unknown</a>
      <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry" id="98696">status</a><span class="delimiter">)</span> =&gt; <a href="#98696" title="edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry">status</a>.<a href="#81120" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.Status.Status">status</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(key: Array[Byte])None.type" id="74824">getCStruct</a><span class="delimiter">(</span><a title="Array[Byte]" id="98697">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="object None">None</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="74825">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#74806" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[edu.berkeley.cs.scads.storage.ScadsXid,edu.berkeley.cs.scads.storage.transactions.conflict.TxStatusEntry]">txStatus</a>.<a href="../TxDB.scala.html#74840" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#74808" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxDB[Array[Byte],edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo]">pendingCStructs</a>.<a href="../TxDB.scala.html#74840" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class NewUpdateResolver extends java.lang.Object with ScalaObject" id="10380">NewUpdateResolver</a><a href="#10380" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="org.apache.avro.Schema" id="75454">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="75455">valueSchema</a>: <span title="org.apache.avro.Schema">Schema</span>,
                        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.FieldICList" id="75456">ics</a>: <a href="../../Messages.scala.html#9707" title="edu.berkeley.cs.scads.storage.FieldICList">FieldICList</a><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil" id="75449">util</a> = <span title="edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil" class="keyword">new</span> <a href="#10381" title="edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil">SpecificRecordUtil</a><span class="delimiter">(</span><a href="#75455" title="=&gt; org.apache.avro.Schema">valueSchema</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater" id="75451">logicalRecordUpdater</a> = <span title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater" class="keyword">new</span> <a href="#10382" title="edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">LogicalRecordUpdater</a><span class="delimiter">(</span><a href="#75455" title="=&gt; org.apache.avro.Schema">valueSchema</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, commandsInfo: edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo, dbValue: Option[edu.berkeley.cs.scads.storage.MDCCRecord], newUpdate: edu.berkeley.cs.scads.storage.RecordUpdate)Boolean" id="75453">isCompatible</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="98609">xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>,
                   <a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo" id="98610">commandsInfo</a>: <a href="#100110" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">PendingCommandsInfo</a>,
                   <a title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]" id="98611">dbValue</a>: <span title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">Option</span><span class="delimiter">[</span>MDCCRecord<span class="delimiter">]</span>,
                   <a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="98612">newUpdate</a>: <a href="../../Messages.scala.html#9680" title="edu.berkeley.cs.scads.storage.RecordUpdate">RecordUpdate</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <a href="#98612" title="edu.berkeley.cs.scads.storage.RecordUpdate">newUpdate</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Boolean">LogicalUpdate</span><span class="delimiter">(</span><a title="Array[Byte]" id="98719">key</a>, <a title="Array[Byte]" id="98720">delta</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="comment">// TODO: what about deleted/non-existent records???</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#98611" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">dbValue</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;base record should exist for logical updates&quot;)" class="string">&quot;base record should exist for logical updates&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="98721">deltaRec</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#98720" title="Array[Byte]">delta</a><span class="delimiter">)</span>

        <span class="keyword">var</span> <a title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]" id="98722">oldStates</a> = <span title="()scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">HashMap</span><span class="delimiter">[</span>List<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, List<span class="delimiter">[</span>List<span class="delimiter">[</span>ScadsXid<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#98722" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">oldStates</a> <span title="(xs: scala.collection.TraversableOnce[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])])scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">++=</span> <a href="#98610" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="(f: edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo =&gt; (List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]]))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo],(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]]),scala.collection.TraversableOnce[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])]])scala.collection.TraversableOnce[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]]),Seq[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="98756">s</a> =&gt; <span title="(_1: List[Byte], _2: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])" class="delimiter">(</span><a href="#98756" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">s</a>.<a href="#99219" title="implicit scala.Predef.byteArrayOps : (xs: Array[Byte])scala.collection.mutable.ArrayOps[Byte]">state</a>.<span title="=&gt; List[Byte]">toList</span>, <a href="#98756" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">s</a>.<a href="#99220" title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">xids</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">var</span> <a title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]" id="98723">newStates</a> = <span title="()scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">HashMap</span><span class="delimiter">[</span>List<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, List<span class="delimiter">[</span>List<span class="delimiter">[</span>ScadsXid<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>

        <span class="comment">// Apply to base record first</span>
        <span class="keyword">val</span> <a title="Array[Byte]" id="98724">newStateBytes</a> = <a href="#75451" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">logicalRecordUpdater</a>.<a href="#80730" title="(baseBytes: Option[Array[Byte]], deltaBytes: Option[Array[Byte]])Array[Byte]">applyDeltaBytes</a><span class="delimiter">(</span><a href="#98611" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">dbValue</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.MDCCRecord">get</span>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a>, <a href="#98721" title="edu.berkeley.cs.scads.storage.MDCCRecord">deltaRec</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="List[Byte]" id="98725">newState</a> = <a href="#98724" title="implicit scala.Predef.byteArrayOps : (xs: Array[Byte])scala.collection.mutable.ArrayOps[Byte]">newStateBytes</a>.<span title="=&gt; List[Byte]">toList</span>
        <span class="keyword">val</span> <a title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]" id="98726">newXidList</a> = <a href="#98722" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">oldStates</a>.<span title="(key: List[Byte], default: =&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]])List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">getOrElse</span><span class="delimiter">(</span><a href="#98725" title="List[Byte]">newState</a>, List<span class="delimiter">[</span>List<span class="delimiter">[</span>ScadsXid<span class="delimiter">]</span><span class="delimiter">]</span><span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[List[edu.berkeley.cs.scads.storage.ScadsXid]])(implicit bf: scala.collection.generic.CanBuildFrom[List[List[edu.berkeley.cs.scads.storage.ScadsXid]],List[edu.berkeley.cs.scads.storage.ScadsXid],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]])List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">++</span> <span title="(xs: List[edu.berkeley.cs.scads.storage.ScadsXid]*)List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">List</span><span class="delimiter">(</span><span title="(xs: edu.berkeley.cs.scads.storage.ScadsXid*)List[edu.berkeley.cs.scads.storage.ScadsXid]">List</span><span class="delimiter">(</span><a href="#98609" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="keyword">var</span> <a title="Boolean" id="98727">valid</a> = <a href="#98723" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">newStates</a>.<span title="(key: List[Byte], value: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])Option[List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">put</span><span class="delimiter">(</span><a href="#98725" title="List[Byte]">newState</a>, <a href="#98726" title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">newXidList</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Boolean">None</span> =&gt; <a href="#10383" title="object edu.berkeley.cs.scads.storage.transactions.conflict.ICChecker">ICChecker</a>.<a href="#99172" title="(rec: org.apache.avro.specific.SpecificRecord, ics: edu.berkeley.cs.scads.storage.FieldICList)Boolean">check</a><span class="delimiter">(</span><a href="#75449" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil">util</a>.<a href="#98716" title="(bytes: Array[Byte])org.apache.avro.specific.SpecificRecord">fromBytes</a><span class="delimiter">(</span><a href="#98725" title="List[Byte]">newState</a>.<span title="(implicit evidence$1: ClassManifest[Byte])Array[Byte]">toArray</span><span class="delimiter">)</span>, <a href="#75456" title="=&gt; edu.berkeley.cs.scads.storage.FieldICList">ics</a><span class="delimiter">)</span>
          <span class="keyword">case</span> <span title="Boolean(true)">Some</span><span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>

        <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#98727" title="Boolean">valid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#98610" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#76136" title="(newStates: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">updateStates</a><span class="delimiter">(</span><a href="#98723" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">newStates</a>.<span title="=&gt; List[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])]">toList</span>.<span title="(f: (List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]]) =&gt; edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo)(implicit bf: scala.collection.generic.CanBuildFrom[List[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])],edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]])Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,List[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]]" class="delimiter">(</span><a title="(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])" id="99218">x</a> =&gt; <a href="#100114" title="(state: Array[Byte], xids: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">PendingStateInfo</a><span class="delimiter">(</span><a href="#99218" title="(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])">x</a>.<span title="=&gt; List[Byte]">_1</span>.<span title="(implicit evidence$1: ClassManifest[Byte])Array[Byte]">toArray</span>, <a href="#99218" title="(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])">x</a>.<span title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">_2</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>

          <span class="comment">// TODO: what if current old state is NOT currently in new states?</span>
          <a href="#98610" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#80764" title="=&gt; Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">states</a>.<span title="(f: edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo" id="99284">s</a> =&gt; <span class="delimiter">{</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#98727" title="Boolean">valid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="List[Byte]" id="99285">newState</a> = <a href="#75451" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.LogicalRecordUpdater">logicalRecordUpdater</a>.<a href="#80730" title="(baseBytes: Option[Array[Byte]], deltaBytes: Option[Array[Byte]])Array[Byte]">applyDeltaBytes</a><span title="implicit scala.Predef.byteArrayOps : (xs: Array[Byte])scala.collection.mutable.ArrayOps[Byte]" class="delimiter">(</span><span title="(x: Array[Byte])Option[Array[Byte]]">Option</span><span class="delimiter">(</span><a href="#99284" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">s</a>.<a href="#99219" title="=&gt; Array[Byte]">state</a><span class="delimiter">)</span>, <a href="#98721" title="edu.berkeley.cs.scads.storage.MDCCRecord">deltaRec</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a><span class="delimiter">)</span>.<span title="=&gt; List[Byte]">toList</span>
              <span class="keyword">val</span> <a title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]" id="99286">baseXidList</a> = <a href="#98722" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">oldStates</a>.<span title="(key: List[Byte])Option[List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">get</span><span class="delimiter">(</span><a href="#99284" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">s</a>.<a href="#99219" title="implicit scala.Predef.byteArrayOps : (xs: Array[Byte])scala.collection.mutable.ArrayOps[Byte]">state</a>.<span title="=&gt; List[Byte]">toList</span><span class="delimiter">)</span>.<span title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">get</span>.<span title="(f: List[edu.berkeley.cs.scads.storage.ScadsXid] =&gt; List[edu.berkeley.cs.scads.storage.ScadsXid])(implicit bf: scala.collection.generic.CanBuildFrom[List[List[edu.berkeley.cs.scads.storage.ScadsXid]],List[edu.berkeley.cs.scads.storage.ScadsXid],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]])List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,List[edu.berkeley.cs.scads.storage.ScadsXid],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]" class="delimiter">(</span><a href="#99517" title="List[edu.berkeley.cs.scads.storage.ScadsXid]">_</a> <span title="(that: scala.collection.GenTraversableOnce[edu.berkeley.cs.scads.storage.ScadsXid])(implicit bf: scala.collection.generic.CanBuildFrom[List[edu.berkeley.cs.scads.storage.ScadsXid],edu.berkeley.cs.scads.storage.ScadsXid,List[edu.berkeley.cs.scads.storage.ScadsXid]])List[edu.berkeley.cs.scads.storage.ScadsXid]">++</span> <span title="(xs: edu.berkeley.cs.scads.storage.ScadsXid*)List[edu.berkeley.cs.scads.storage.ScadsXid]">List</span><span class="delimiter">(</span><a href="#98609" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <span class="keyword">val</span> <a title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]" id="99287">newXidList</a> = <a href="#98722" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">oldStates</a>.<span title="(key: List[Byte], default: =&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]])List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">getOrElse</span><span class="delimiter">(</span><a href="#99285" title="List[Byte]">newState</a>, List<span class="delimiter">[</span>List<span class="delimiter">[</span>ScadsXid<span class="delimiter">]</span><span class="delimiter">]</span><span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[List[edu.berkeley.cs.scads.storage.ScadsXid]])(implicit bf: scala.collection.generic.CanBuildFrom[List[List[edu.berkeley.cs.scads.storage.ScadsXid]],List[edu.berkeley.cs.scads.storage.ScadsXid],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]])List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">++</span> <a href="#99286" title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">baseXidList</a>
              <a href="#98723" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">newStates</a>.<span title="(key: List[Byte], value: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])Option[List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">put</span><span class="delimiter">(</span><a href="#99285" title="List[Byte]">newState</a>, <a href="#99287" title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">newXidList</a><span class="delimiter">)</span>
              <a href="#98727" title="Boolean">valid</a> = <a href="#98723" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">newStates</a>.<span title="(key: List[Byte], value: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])Option[List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">put</span><span class="delimiter">(</span><a href="#99285" title="List[Byte]">newState</a>, <a href="#99287" title="List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">newXidList</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
                <span class="keyword">case</span> <span title="Boolean">None</span> =&gt; <a href="#10383" title="object edu.berkeley.cs.scads.storage.transactions.conflict.ICChecker">ICChecker</a>.<a href="#99172" title="(rec: org.apache.avro.specific.SpecificRecord, ics: edu.berkeley.cs.scads.storage.FieldICList)Boolean">check</a><span class="delimiter">(</span><a href="#75449" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil">util</a>.<a href="#98716" title="(bytes: Array[Byte])org.apache.avro.specific.SpecificRecord">fromBytes</a><span class="delimiter">(</span><a href="#99285" title="List[Byte]">newState</a>.<span title="(implicit evidence$1: ClassManifest[Byte])Array[Byte]">toArray</span><span class="delimiter">)</span>, <a href="#75456" title="=&gt; edu.berkeley.cs.scads.storage.FieldICList">ics</a><span class="delimiter">)</span>
                <span class="keyword">case</span> <span title="Boolean(true)">Some</span><span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>

          <a href="#98610" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#76136" title="(newStates: Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo])Unit">updateStates</a><span class="delimiter">(</span><a href="#98723" title="scala.collection.mutable.HashMap[List[Byte],List[List[edu.berkeley.cs.scads.storage.ScadsXid]]]">newStates</a>.<span title="=&gt; List[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])]">toList</span>.<span title="(f: (List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]]) =&gt; edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo)(implicit bf: scala.collection.generic.CanBuildFrom[List[(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])],edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]])Seq[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo,List[edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo]]" class="delimiter">(</span><a title="(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])" id="99731">x</a> =&gt; <a href="#100114" title="(state: Array[Byte], xids: List[List[edu.berkeley.cs.scads.storage.ScadsXid]])edu.berkeley.cs.scads.storage.transactions.conflict.PendingStateInfo">PendingStateInfo</a><span class="delimiter">(</span><a href="#99731" title="(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])">x</a>.<span title="=&gt; List[Byte]">_1</span>.<span title="(implicit evidence$1: ClassManifest[Byte])Array[Byte]">toArray</span>, <a href="#99731" title="(List[Byte], List[List[edu.berkeley.cs.scads.storage.ScadsXid]])">x</a>.<span title="=&gt; List[List[edu.berkeley.cs.scads.storage.ScadsXid]]">_2</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#98727" title="Boolean">valid</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Boolean">ValueUpdate</span><span class="delimiter">(</span><a title="Array[Byte]" id="99772">key</a>, <a title="Option[Array[Byte]]" id="99773">oldValue</a>, <a title="Array[Byte]" id="99774">newValue</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="comment">// Value updates conflict with all pending updates</span>
        <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#98610" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(p: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Boolean)Int">indexWhere</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="99789">x</a> =&gt; <a href="#99789" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#27000" title="=&gt; Boolean">pending</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// No pending commands.</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="99795">newRec</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#99774" title="Array[Byte]">newValue</a><span class="delimiter">)</span>
          <span title="(_1: Option[Array[Byte]], _2: Option[edu.berkeley.cs.scads.storage.MDCCRecord])(Option[Array[Byte]], Option[edu.berkeley.cs.scads.storage.MDCCRecord])" class="delimiter">(</span><a href="#99773" title="Option[Array[Byte]]">oldValue</a>, <a href="#98611" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">dbValue</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="99805">old</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="99807">dbRec</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>

              <span class="comment">// Record found in db, compare with the old version</span>
              <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="99808">oldRec</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#99805" title="Array[Byte]">old</a><span class="delimiter">)</span>

              <span class="comment">// TODO: Don't compare versions, but compare the list of</span>
              <span class="comment">//       masters?</span>
              <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#99808" title="edu.berkeley.cs.scads.storage.MDCCRecord">oldRec</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a>, <a href="#99807" title="edu.berkeley.cs.scads.storage.MDCCRecord">dbRec</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
                <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="Array[Byte]" id="99818">a</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="99820">b</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="object java.util.Arrays">Arrays</span>.<span title="(x$1: Array[Byte], x$2: Array[Byte])Boolean">equals</span><span class="delimiter">(</span><a href="#99818" title="Array[Byte]">a</a>, <a href="#99820" title="Array[Byte]">b</a><span class="delimiter">)</span>
                <span class="keyword">case</span> <span title="Boolean(true)" class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
                <span class="keyword">case</span> <span title="Boolean(false)" class="delimiter">(</span>_, _<span class="delimiter">)</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <span class="keyword">case</span> <span title="Boolean(true)" class="delimiter">(</span><span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">case</span> <span title="Boolean(false)" class="delimiter">(</span>_, _<span class="delimiter">)</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="comment">// There exists a pending command.  Value update is not compatible.</span>
          <span class="comment">// TODO: in a fast round, multiple physical updates are sometimes</span>
          <span class="comment">//       compatible.</span>
          <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Boolean">VersionUpdate</span><span class="delimiter">(</span><a title="Array[Byte]" id="99833">key</a>, <a title="Array[Byte]" id="99834">newValue</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="comment">// Version updates conflict with all pending updates</span>
        <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#98610" title="edu.berkeley.cs.scads.storage.transactions.conflict.PendingCommandsInfo">commandsInfo</a>.<a href="#80763" title="=&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(p: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Boolean)Int">indexWhere</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="99849">x</a> =&gt; <a href="#99849" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#27000" title="=&gt; Boolean">pending</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// No pending commands.</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="99855">newRec</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80721" title="(bytes: Array[Byte])edu.berkeley.cs.scads.storage.MDCCRecord">fromBytes</a><span class="delimiter">(</span><a href="#99834" title="Array[Byte]">newValue</a><span class="delimiter">)</span>
          <a href="#98611" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">dbValue</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Boolean">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="99857">v</a><span class="delimiter">)</span> =&gt;
              <span class="delimiter">(</span><a href="#99855" title="edu.berkeley.cs.scads.storage.MDCCRecord">newRec</a>.<a href="../../Messages.scala.html#27192" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">metadata</a>.<a href="../../Messages.scala.html#26907" title="=&gt; Long">currentRound</a> <span title="(x: Long)Boolean">==</span> <a href="#99857" title="edu.berkeley.cs.scads.storage.MDCCRecord">v</a>.<a href="../../Messages.scala.html#27192" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">metadata</a>.<a href="../../Messages.scala.html#26907" title="=&gt; Long">currentRound</a> <span title="(x: Int)Long">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
            <span class="keyword">case</span> <span title="Boolean(true)">None</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="comment">// There exists a pending command.  Version update is not compatible.</span>
          <span class="comment">// TODO: in a fast round, multiple physical updates are sometimes</span>
          <span class="comment">//       compatible.</span>
          <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span> <span class="comment">// isCompatible</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class SpecificRecordUtil extends java.lang.Object with ScalaObject" id="10381">SpecificRecordUtil</a><a href="#10381" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="org.apache.avro.Schema" id="98718">schema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumReader[org.apache.avro.specific.SpecificRecord]" id="98708">reader</a> = <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumReader[org.apache.avro.specific.SpecificRecord]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumReader[org.apache.avro.specific.SpecificRecord]">SpecificDatumReader</span><span class="delimiter">[</span>SpecificRecord<span class="delimiter">]</span><span class="delimiter">(</span><a href="#98718" title="=&gt; org.apache.avro.Schema">schema</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificDatumWriter[org.apache.avro.specific.SpecificRecord]" id="98710">writer</a> = <span title="(x$1: org.apache.avro.Schema)org.apache.avro.specific.SpecificDatumWriter[org.apache.avro.specific.SpecificRecord]" class="keyword">new</span> <span title="org.apache.avro.specific.SpecificDatumWriter[org.apache.avro.specific.SpecificRecord]">SpecificDatumWriter</span><span class="delimiter">[</span>SpecificRecord<span class="delimiter">]</span><span class="delimiter">(</span><a href="#98718" title="=&gt; org.apache.avro.Schema">schema</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="98712">out</a> = <span title="(x$1: Int)java.io.ByteArrayOutputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span><span class="delimiter">(</span><span title="Int(128)" class="int">128</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="org.apache.avro.io.BinaryEncoder" id="98714">encoder</a> = <span title="object org.apache.avro.io.EncoderFactory">EncoderFactory</span>.<span title="()org.apache.avro.io.EncoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.OutputStream, x$2: org.apache.avro.io.BinaryEncoder)org.apache.avro.io.BinaryEncoder">binaryEncoder</span><span class="delimiter">(</span><a href="#98712" title="=&gt; java.io.ByteArrayOutputStream">out</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(bytes: Array[Byte])org.apache.avro.specific.SpecificRecord" id="98716">fromBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="99176">bytes</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="org.apache.avro.specific.SpecificRecord">SpecificRecord</span> = <span class="delimiter">{</span>
    <a href="#98708" title="=&gt; org.apache.avro.specific.SpecificDatumReader[org.apache.avro.specific.SpecificRecord]">reader</a>.<span title="(x$1: org.apache.avro.specific.SpecificRecord, x$2: org.apache.avro.io.Decoder)org.apache.avro.specific.SpecificRecord">read</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="object org.apache.avro.io.DecoderFactory">DecoderFactory</span>.<span title="()org.apache.avro.io.DecoderFactory">get</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.io.InputStream, x$2: org.apache.avro.io.BinaryDecoder)org.apache.avro.io.BinaryDecoder">directBinaryDecoder</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> <span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#99176" title="Array[Byte]">bytes</a><span class="delimiter">)</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="org.apache.avro.specific.SpecificRecord" class="delimiter">[</span><span title="org.apache.avro.specific.SpecificRecord">SpecificRecord</span><span class="delimiter">]</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(record: org.apache.avro.specific.SpecificRecord)Array[Byte]" id="98717">toBytes</a><span class="delimiter">(</span><a title="org.apache.avro.specific.SpecificRecord" id="99890">record</a>: <span title="org.apache.avro.specific.SpecificRecord">SpecificRecord</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#98712" title="=&gt; java.io.ByteArrayOutputStream">out</a>.<span title="()Unit">reset</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#98710" title="=&gt; org.apache.avro.specific.SpecificDatumWriter[org.apache.avro.specific.SpecificRecord]">writer</a>.<span title="(x$1: org.apache.avro.specific.SpecificRecord, x$2: org.apache.avro.io.Encoder)Unit">write</span><span class="delimiter">(</span><a href="#99890" title="org.apache.avro.specific.SpecificRecord">record</a>, <a href="#98714" title="=&gt; org.apache.avro.io.BinaryEncoder">encoder</a><span class="delimiter">)</span>
    <a href="#98714" title="=&gt; org.apache.avro.io.BinaryEncoder">encoder</a>.<span title="()Unit">flush</span>
    <a href="#98712" title="=&gt; java.io.ByteArrayOutputStream">out</a>.<span title="()Array[Byte]">toByteArray</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class LogicalRecordUpdater extends java.lang.Object with ScalaObject" id="10382">LogicalRecordUpdater</a><a href="#10382" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="org.apache.avro.Schema" id="80732">schema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil" id="80728">util</a> = <span title="edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil" class="keyword">new</span> <a href="#10381" title="edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil">SpecificRecordUtil</a><span class="delimiter">(</span><a href="#80732" title="=&gt; org.apache.avro.Schema">schema</a><span class="delimiter">)</span>

  <span class="comment">// base is the (optional) byte array of the serialized AvroRecord.</span>
  <span class="comment">// delta is the (optional) byte array of the serialized delta AvroRecord.</span>
  <span class="comment">// A byte array of the serialized resulting record is returned.</span>
  <span class="keyword">def</span> <a title="(baseBytes: Option[Array[Byte]], deltaBytes: Option[Array[Byte]])Array[Byte]" id="80730">applyDeltaBytes</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="80733">baseBytes</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="80734">deltaBytes</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#80734" title="Option[Array[Byte]]">deltaBytes</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Delta records should always exist.&quot;)" class="string">&quot;Delta records should always exist.&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#80733" title="Option[Array[Byte]]">baseBytes</a> <span title="Array[Byte]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Array[Byte]">None</span> =&gt; <a href="#80734" title="Option[Array[Byte]]">deltaBytes</a>.<span title="=&gt; Array[Byte]">get</span>
      <span class="keyword">case</span> <span title="Array[Byte]">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="99906">avroBytes</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificRecord" id="99907">avro</a> = <a href="#80728" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil">util</a>.<a href="#98716" title="(bytes: Array[Byte])org.apache.avro.specific.SpecificRecord">fromBytes</a><span class="delimiter">(</span><a href="#99906" title="Array[Byte]">avroBytes</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificRecord" id="99908">avroDelta</a> = <a href="#80728" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil">util</a>.<a href="#98716" title="(bytes: Array[Byte])org.apache.avro.specific.SpecificRecord">fromBytes</a><span class="delimiter">(</span><a href="#80734" title="Option[Array[Byte]]">deltaBytes</a>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="org.apache.avro.specific.SpecificRecord" id="99909">avroNew</a> = <a href="#80731" title="(base: org.apache.avro.specific.SpecificRecord, delta: org.apache.avro.specific.SpecificRecord)org.apache.avro.specific.SpecificRecord">applyDeltaRecord</a><span class="delimiter">(</span><a href="#99907" title="org.apache.avro.specific.SpecificRecord">avro</a>, <a href="#99908" title="org.apache.avro.specific.SpecificRecord">avroDelta</a><span class="delimiter">)</span>
        <a href="#80728" title="=&gt; edu.berkeley.cs.scads.storage.transactions.conflict.SpecificRecordUtil">util</a>.<a href="#98717" title="(record: org.apache.avro.specific.SpecificRecord)Array[Byte]">toBytes</a><span class="delimiter">(</span><a href="#99909" title="org.apache.avro.specific.SpecificRecord">avroNew</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(base: org.apache.avro.specific.SpecificRecord, delta: org.apache.avro.specific.SpecificRecord)org.apache.avro.specific.SpecificRecord" id="80731">applyDeltaRecord</a><span class="delimiter">(</span><a title="org.apache.avro.specific.SpecificRecord" id="99910">base</a>: <span title="org.apache.avro.specific.SpecificRecord">SpecificRecord</span>, <a title="org.apache.avro.specific.SpecificRecord" id="99911">delta</a>: <span title="org.apache.avro.specific.SpecificRecord">SpecificRecord</span><span class="delimiter">)</span>: <span title="org.apache.avro.specific.SpecificRecord">SpecificRecord</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="99913">schema</a> = <a href="#99911" title="org.apache.avro.specific.SpecificRecord">delta</a>.<span title="()org.apache.avro.Schema">getSchema</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]" id="99914">fields</a>: <span title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">Buffer</span><span class="delimiter">[</span>org.apache.avro.Schema.Field<span class="delimiter">]</span> = <a href="#99913" title="org.apache.avro.Schema">schema</a>.<span title="(l: java.util.List[org.apache.avro.Schema.Field])scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">getFields</span>

    <a href="#99914" title="scala.collection.mutable.Buffer[org.apache.avro.Schema.Field]">fields</a>.<span title="(f: org.apache.avro.Schema.Field =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="org.apache.avro.Schema.Field" id="99944">field</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.lang.Object" id="99945">fieldDelta</a> = <a href="#99911" title="org.apache.avro.specific.SpecificRecord">delta</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#99944" title="org.apache.avro.Schema.Field">field</a>.<span title="()Int">pos</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.lang.Object" id="99946">baseField</a> = <a href="#99910" title="org.apache.avro.specific.SpecificRecord">base</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#99944" title="org.apache.avro.Schema.Field">field</a>.<span title="()Int">pos</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="AnyRef" id="99947">newField</a>: <span title="AnyRef">AnyRef</span> = <span title="(_1: java.lang.Object, _2: java.lang.Object)(java.lang.Object, java.lang.Object)" class="delimiter">(</span><a href="#99946" title="java.lang.Object">baseField</a>, <a href="#99945" title="java.lang.Object">fieldDelta</a><span class="delimiter">)</span> <span title="AnyRef" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="AnyRef" class="delimiter">(</span><a title="java.lang.Integer" id="99956">x</a>: java.lang.<span title="java.lang.Integer">Integer</span>, <a title="java.lang.Integer" id="99957">y</a>: java.lang.<span title="java.lang.Integer">Integer</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span title="AnyRef" class="keyword">if</span> <span class="delimiter">(</span><a href="#99957" title="java.lang.Integer">y</a> <span title="(x$1: Any)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span title="java.lang.Integer" class="keyword">new</span> java.lang.<span title="java.lang.Integer">Integer</span><span class="delimiter">(</span><a href="#99956" title="java.lang.Integer">x</a>.<span title="()Int">intValue</span> <span title="(x: Int)Int">+</span> <a href="#99957" title="java.lang.Integer">y</a>.<span title="()Int">intValue</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="AnyRef" class="delimiter">(</span><a title="String" id="99972">x</a>: <span title="String">String</span>, <a title="String" id="99973">y</a>: <span title="String">String</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span title="AnyRef" class="keyword">if</span> <span class="delimiter">(</span><a href="#99973" title="String">y</a>.<span title="()Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#99973" title="String">y</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="AnyRef" class="delimiter">(</span><a title="org.apache.avro.util.Utf8" id="99981">x</a>: org.apache.avro.util.<span title="org.apache.avro.util.Utf8">Utf8</span>, <a title="org.apache.avro.util.Utf8" id="99982">y</a>: org.apache.avro.util.<span title="org.apache.avro.util.Utf8">Utf8</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span title="AnyRef" class="keyword">if</span> <span class="delimiter">(</span><a href="#99982" title="org.apache.avro.util.Utf8">y</a>.<span title="()Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#99982" title="org.apache.avro.util.Utf8">y</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="AnyRef" class="delimiter">(</span><a title="java.lang.Long" id="99990">x</a>: java.lang.<span title="java.lang.Long">Long</span>, <a title="java.lang.Long" id="99991">y</a>: java.lang.<span title="java.lang.Long">Long</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span title="AnyRef" class="keyword">if</span> <span class="delimiter">(</span><a href="#99991" title="java.lang.Long">y</a> <span title="(x$1: Any)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span title="java.lang.Long" class="keyword">new</span> java.lang.<span title="java.lang.Long">Long</span><span class="delimiter">(</span><a href="#99990" title="java.lang.Long">x</a>.<span title="()Long">longValue</span> <span title="(x: Long)Long">+</span> <a href="#99991" title="java.lang.Long">y</a>.<span title="()Long">longValue</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="AnyRef" class="delimiter">(</span><a title="java.lang.Float" id="100006">x</a>: java.lang.<span title="java.lang.Float">Float</span>, <a title="java.lang.Float" id="100007">y</a>: java.lang.<span title="java.lang.Float">Float</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span title="AnyRef" class="keyword">if</span> <span class="delimiter">(</span><a href="#100007" title="java.lang.Float">y</a> <span title="(x$1: Any)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span title="java.lang.Float" class="keyword">new</span> java.lang.<span title="java.lang.Float">Float</span><span class="delimiter">(</span><a href="#100006" title="java.lang.Float">x</a>.<span title="()Float">floatValue</span> <span title="(x: Float)Float">+</span> <a href="#100007" title="java.lang.Float">y</a>.<span title="()Float">floatValue</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="AnyRef" class="delimiter">(</span><a title="java.lang.Double" id="100022">x</a>: java.lang.<span title="java.lang.Double">Double</span>, <a title="java.lang.Double" id="100023">y</a>: java.lang.<span title="java.lang.Double">Double</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span title="AnyRef" class="keyword">if</span> <span class="delimiter">(</span><a href="#100023" title="java.lang.Double">y</a> <span title="(x$1: Any)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span title="Null(null)" class="keyword">null</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span title="java.lang.Double" class="keyword">new</span> java.lang.<span title="java.lang.Double">Double</span><span class="delimiter">(</span><a href="#100022" title="java.lang.Double">x</a>.<span title="()Double">doubleValue</span> <span title="(x: Double)Double">+</span> <a href="#100023" title="java.lang.Double">y</a>.<span title="()Double">doubleValue</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Null(null)" class="delimiter">(</span>_, _<span class="delimiter">)</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="delimiter">}</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#99947" title="AnyRef">newField</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#99910" title="org.apache.avro.specific.SpecificRecord">base</a>.<span title="(x$1: Int, x$2: Any)Unit">put</span><span class="delimiter">(</span><a href="#99944" title="org.apache.avro.Schema.Field">field</a>.<span title="()Int">pos</span>, <a href="#99947" title="AnyRef">newField</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#99910" title="org.apache.avro.specific.SpecificRecord">base</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.transactions.conflict.ICChecker" id="10383">ICChecker</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(f: Any)Double" id="99171">convertFieldToDouble</a><span class="delimiter">(</span><a title="Any" id="100044">f</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Double">Double</span> = <span class="delimiter">{</span>
    <a href="#100044" title="Any">f</a> <span title="Double" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Double" id="100046">x</a>: java.lang.<span title="java.lang.Integer">Integer</span> =&gt; <a href="#100046" title="java.lang.Integer">x</a>.<span title="()Double">doubleValue</span>
      <span class="keyword">case</span> <a title="Double(0.0)" id="100047">x</a>: <span title="String">String</span> =&gt; <span title="Double(0.0)" class="int">0</span>
      <span class="keyword">case</span> <a title="Double(0.0)" id="100048">x</a>: org.apache.avro.util.<span title="org.apache.avro.util.Utf8">Utf8</span> =&gt; <span title="Double(0.0)" class="int">0</span>
      <span class="keyword">case</span> <a title="Double" id="100049">x</a>: java.lang.<span title="java.lang.Long">Long</span> =&gt; <a href="#100049" title="java.lang.Long">x</a>.<span title="()Double">doubleValue</span>
      <span class="keyword">case</span> <a title="Double" id="100050">x</a>: java.lang.<span title="java.lang.Float">Float</span> =&gt; <a href="#100050" title="java.lang.Float">x</a>.<span title="()Double">doubleValue</span>
      <span class="keyword">case</span> <a title="Double" id="100051">x</a>: java.lang.<span title="java.lang.Double">Double</span> =&gt; <a href="#100051" title="implicit scala.Predef.Double2double : (x: java.lang.Double)Double">x</a>
      <span class="keyword">case</span> <span title="Double(0.0)">_</span> =&gt; <span title="Double(0.0)" class="int">0</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(rec: org.apache.avro.specific.SpecificRecord, ics: edu.berkeley.cs.scads.storage.FieldICList)Boolean" id="99172">check</a><span class="delimiter">(</span><a title="org.apache.avro.specific.SpecificRecord" id="99173">rec</a>: <span title="org.apache.avro.specific.SpecificRecord">SpecificRecord</span>, <a title="edu.berkeley.cs.scads.storage.FieldICList" id="99174">ics</a>: <a href="../../Messages.scala.html#9707" title="edu.berkeley.cs.scads.storage.FieldICList">FieldICList</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Boolean" id="100052">valid</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#99174" title="edu.berkeley.cs.scads.storage.FieldICList">ics</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#99174" title="edu.berkeley.cs.scads.storage.FieldICList">ics</a>.<a href="../../Messages.scala.html#27839" title="=&gt; Seq[edu.berkeley.cs.scads.storage.FieldIC]">ics</a>.<span title="(f: edu.berkeley.cs.scads.storage.FieldIC =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.FieldIC" id="100079">ic</a> =&gt; <span class="delimiter">{</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#100052" title="Boolean">valid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Double" id="100080">doubleField</a> = <a href="#99171" title="(f: Any)Double">convertFieldToDouble</a><span class="delimiter">(</span><a href="#99173" title="org.apache.avro.specific.SpecificRecord">rec</a>.<span title="(x$1: Int)java.lang.Object">get</span><span class="delimiter">(</span><a href="#100079" title="edu.berkeley.cs.scads.storage.FieldIC">ic</a>.<a href="../../Messages.scala.html#27744" title="=&gt; Int">fieldPos</a><span class="delimiter">)</span><span class="delimiter">)</span>

          <span class="keyword">val</span> <a title="Boolean" id="100081">lowerValid</a> = <a href="#100079" title="edu.berkeley.cs.scads.storage.FieldIC">ic</a>.<a href="../../Messages.scala.html#27747" title="=&gt; Option[edu.berkeley.cs.scads.storage.FieldRestriction]">lower</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Boolean(true)">None</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">case</span> <span title="Boolean">Some</span><span class="delimiter">(</span>FieldRestrictionGT<span class="delimiter">(</span><a title="Double" id="100083">x</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="#100080" title="Double">doubleField</a> <span title="(x: Double)Boolean">&gt;</span> <a href="#100083" title="Double">x</a>
            <span class="keyword">case</span> <span title="Boolean">Some</span><span class="delimiter">(</span>FieldRestrictionGE<span class="delimiter">(</span><a title="Double" id="100089">x</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="#100080" title="Double">doubleField</a> <span title="(x: Double)Boolean">&gt;=</span> <a href="#100089" title="Double">x</a>
            <span class="keyword">case</span> <span title="Boolean(false)">_</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span>

          <a href="#100052" title="Boolean">valid</a> = <a href="#100081" title="Boolean">lowerValid</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#100079" title="edu.berkeley.cs.scads.storage.FieldIC">ic</a>.<a href="../../Messages.scala.html#27750" title="=&gt; Option[edu.berkeley.cs.scads.storage.FieldRestriction]">upper</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="Boolean(true)">None</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
            <span class="keyword">case</span> <span title="Boolean">Some</span><span class="delimiter">(</span>FieldRestrictionLT<span class="delimiter">(</span><a title="Double" id="100095">x</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="#100080" title="Double">doubleField</a> <span title="(x: Double)Boolean">&lt;</span> <a href="#100095" title="Double">x</a>
            <span class="keyword">case</span> <span title="Boolean">Some</span><span class="delimiter">(</span>FieldRestrictionLE<span class="delimiter">(</span><a title="Double" id="100101">x</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="#100080" title="Double">doubleField</a> <span title="(x: Double)Boolean">&lt;=</span> <a href="#100101" title="Double">x</a>
            <span class="keyword">case</span> <span title="Boolean(false)">_</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <a href="#100052" title="Boolean">valid</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>