<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>transactions/conflict/ConflictResolver.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage
<span class="keyword">package</span> transactions
<span class="keyword">package</span> conflict

<span class="keyword">import</span> actors.threadpool.<span title="object scala.actors.threadpool.ThreadPoolExecutor">ThreadPoolExecutor</span>.AbortPolicy
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer
<span class="keyword">import</span> scala.collection.mutable.HashSet

<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> java.util.Arrays

<span class="keyword">import</span> scala.collection.mutable.Buffer
<span class="keyword">import</span> scala.collection.mutable.ListBuffer
<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._

<span class="keyword">import</span> java.io._
<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> org.apache.avro.io.<span class="delimiter">{</span>BinaryData, DecoderFactory, BinaryEncoder, BinaryDecoder, EncoderFactory<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.specific.<span class="delimiter">{</span>SpecificDatumWriter, SpecificDatumReader, SpecificRecordBase, SpecificRecord<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.Schema

<span class="keyword">class</span> <a title="class ConflictResolver extends java.lang.Object with ScalaObject" id="10349">ConflictResolver</a><a href="#10349" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="org.apache.avro.Schema" id="97259">valueSchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.FieldICList" id="97260">ics</a>: <a href="../../Messages.scala.html#9707" title="edu.berkeley.cs.scads.storage.FieldICList">FieldICList</a><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">type</span> <a title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]" id="97242">CommandSets</a> = <span title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]">ArrayBuffer</span><span class="delimiter">[</span>HashSet<span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="(cstructs: Seq[edu.berkeley.cs.scads.storage.CStruct])edu.berkeley.cs.scads.storage.CStruct" id="97243">getLUB</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStruct]" id="97261">cstructs</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStruct]">Seq</span><span class="delimiter">[</span>CStruct<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a> = <span class="delimiter">{</span>
    <span title="edu.berkeley.cs.scads.storage.CStruct" class="keyword">if</span> <span class="delimiter">(</span><a href="#97261" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#97261" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.CStruct">head</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.CStruct" id="97268">head</a> = <a href="#97261" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.CStruct">head</span>
      <span class="keyword">val</span> <a title="ConflictResolver.this.CommandSets" id="97269">result</a> = <a href="#97250" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])ConflictResolver.this.CommandSets">convertToSets</a><span class="delimiter">(</span><a href="#97268" title="edu.berkeley.cs.scads.storage.CStruct">head</a>.<a href="../../Messages.scala.html#27106" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span>

      <span class="comment">// Iterate over the rest of the cstructs.</span>
      <a href="#97261" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStruct]">tail</span>.<span title="(f: edu.berkeley.cs.scads.storage.CStruct =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStruct" id="97294">x</a> =&gt; <span class="delimiter">{</span>
        <a href="#97248" title="(result: ConflictResolver.this.CommandSets, c2: ConflictResolver.this.CommandSets, intersect: Boolean)Unit">updateMerge</a><span class="delimiter">(</span><a href="#97269" title="ConflictResolver.this.CommandSets">result</a>, <a href="#97250" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])ConflictResolver.this.CommandSets">convertToSets</a><span class="delimiter">(</span><a href="#97294" title="edu.berkeley.cs.scads.storage.CStruct">x</a>.<a href="../../Messages.scala.html#27106" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span>, intersect=<span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="../../Messages.scala.html#27135" title="(value: Option[Array[Byte]], commands: Seq[edu.berkeley.cs.scads.storage.CStructCommand])edu.berkeley.cs.scads.storage.CStruct">CStruct</a><span class="delimiter">(</span><a href="#97268" title="edu.berkeley.cs.scads.storage.CStruct">head</a>.<a href="../../Messages.scala.html#27103" title="=&gt; Option[Array[Byte]]">value</a>, <a href="#97249" title="(c: ConflictResolver.this.CommandSets)Seq[edu.berkeley.cs.scads.storage.CStructCommand]">convertToSeq</a><span class="delimiter">(</span><a href="#97269" title="ConflictResolver.this.CommandSets">result</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(cstructs: Seq[edu.berkeley.cs.scads.storage.CStruct])edu.berkeley.cs.scads.storage.CStruct" id="97244">getGLB</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStruct]" id="97901">cstructs</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStruct]">Seq</span><span class="delimiter">[</span>CStruct<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a> = <span class="delimiter">{</span>
    <span title="edu.berkeley.cs.scads.storage.CStruct" class="keyword">if</span> <span class="delimiter">(</span><a href="#97901" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#97901" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.CStruct">head</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.CStruct" id="97908">head</a> = <a href="#97901" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.CStruct">head</span>
      <span class="keyword">val</span> <a title="ConflictResolver.this.CommandSets" id="97909">result</a> = <a href="#97250" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])ConflictResolver.this.CommandSets">convertToSets</a><span class="delimiter">(</span><a href="#97908" title="edu.berkeley.cs.scads.storage.CStruct">head</a>.<a href="../../Messages.scala.html#27106" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span>

      <span class="comment">// Iterate over the rest of the cstructs.</span>
      <a href="#97901" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStruct]">tail</span>.<span title="(f: edu.berkeley.cs.scads.storage.CStruct =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStruct" id="97928">x</a> =&gt; <span class="delimiter">{</span>
        <a href="#97248" title="(result: ConflictResolver.this.CommandSets, c2: ConflictResolver.this.CommandSets, intersect: Boolean)Unit">updateMerge</a><span class="delimiter">(</span><a href="#97909" title="ConflictResolver.this.CommandSets">result</a>, <a href="#97250" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])ConflictResolver.this.CommandSets">convertToSets</a><span class="delimiter">(</span><a href="#97928" title="edu.berkeley.cs.scads.storage.CStruct">x</a>.<a href="../../Messages.scala.html#27106" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>

      <a href="../../Messages.scala.html#27135" title="(value: Option[Array[Byte]], commands: Seq[edu.berkeley.cs.scads.storage.CStructCommand])edu.berkeley.cs.scads.storage.CStruct">CStruct</a><span class="delimiter">(</span><a href="#97908" title="edu.berkeley.cs.scads.storage.CStruct">head</a>.<a href="../../Messages.scala.html#27103" title="=&gt; Option[Array[Byte]]">value</a>, <a href="#97249" title="(c: ConflictResolver.this.CommandSets)Seq[edu.berkeley.cs.scads.storage.CStructCommand]">convertToSeq</a><span class="delimiter">(</span><a href="#97909" title="ConflictResolver.this.CommandSets">result</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// Returns true if c1 is a subset of c2.  If strict is true,</span>
  <span class="comment">// only returns true if c1 is a strict subset of c2.</span>
  <span class="keyword">def</span> <a title="(c1: edu.berkeley.cs.scads.storage.CStruct, c2: edu.berkeley.cs.scads.storage.CStruct, strict: Boolean)Boolean" id="97245">isSubset</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStruct" id="97932">c1</a>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a>, <a title="edu.berkeley.cs.scads.storage.CStruct" id="97933">c2</a>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a>, <a title="Boolean" id="97936">strict</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="ConflictResolver.this.CommandSets" id="97937">cs1</a> = <a href="#97250" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])ConflictResolver.this.CommandSets">convertToSets</a><span class="delimiter">(</span><a href="#97932" title="edu.berkeley.cs.scads.storage.CStruct">c1</a>.<a href="../../Messages.scala.html#27106" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="ConflictResolver.this.CommandSets" id="97938">cs2</a> = <a href="#97250" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])ConflictResolver.this.CommandSets">convertToSets</a><span class="delimiter">(</span><a href="#97933" title="edu.berkeley.cs.scads.storage.CStruct">c2</a>.<a href="../../Messages.scala.html#27106" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span>
    <span title="Boolean(true)" class="keyword">true</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(cstruct1: edu.berkeley.cs.scads.storage.CStruct, cstruct2: edu.berkeley.cs.scads.storage.CStruct)Boolean" id="97246">isStrictSubset</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStruct" id="97939">cstruct1</a>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a>, <a title="edu.berkeley.cs.scads.storage.CStruct" id="97940">cstruct2</a>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a><span class="delimiter">)</span> = <a href="#97245" title="(c1: edu.berkeley.cs.scads.storage.CStruct, c2: edu.berkeley.cs.scads.storage.CStruct, strict: Boolean)Boolean">isSubset</a><span class="delimiter">(</span><a href="#97939" title="edu.berkeley.cs.scads.storage.CStruct">cstruct1</a>, <a href="#97940" title="edu.berkeley.cs.scads.storage.CStruct">cstruct2</a>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(cstructs: Seq[edu.berkeley.cs.scads.storage.CStruct], fastQuorumSize: Int, classicQuorumSize: Int)edu.berkeley.cs.scads.storage.CStruct" id="97247">provedSafe</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStruct]" id="97943">cstructs</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStruct]">Seq</span><span class="delimiter">[</span>CStruct<span class="delimiter">]</span>, <a title="Int" id="97944">fastQuorumSize</a>: <span title="Int">Int</span>,
                 <a title="Int" id="97945">classicQuorumSize</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a> = <span class="delimiter">{</span>
    <span class="comment">// TODO: does cstructs require fastQuorumSize number of elements??</span>


    <a href="#97943" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.CStruct">head</span>
  <span class="delimiter">}</span>

  <span class="comment">// Modifies first CommandSet to be merged with the second CommandSet.</span>
  <span class="comment">// If intersect is true, computes the intersection.  Otherwise, computes the</span>
  <span class="comment">// union.</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(result: ConflictResolver.this.CommandSets, c2: ConflictResolver.this.CommandSets, intersect: Boolean)Unit" id="97248">updateMerge</a><span class="delimiter">(</span><a title="ConflictResolver.this.CommandSets" id="97295">result</a>: <span title="ConflictResolver.this.CommandSets">CommandSets</span>, <a title="ConflictResolver.this.CommandSets" id="97296">c2</a>: <span title="ConflictResolver.this.CommandSets">CommandSets</span>,
                          <a title="Boolean" id="97300">intersect</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// Iterator for result.</span>
    <span class="keyword">var</span> <a title="Int" id="97301">i</a> = <span title="Int(0)" class="int">0</span>
    <span class="comment">// Iterator for c2.</span>
    <span class="keyword">var</span> <a title="Int" id="97302">j</a> = <span title="Int(0)" class="int">0</span>

    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#97301" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#97295" title="ConflictResolver.this.CommandSets">result</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span> <a href="#97303" title="()Unit" class="delimiter">{</a>
      <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" id="97308">currentSet</a> = <a href="#97295" title="(idx: Int)scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">result</a><span class="delimiter">(</span><a href="#97301" title="Int">i</a><span class="delimiter">)</span>
      <span class="comment">// Find the corresponding HashSet in c2.</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" id="97309">newSet</a> = <a href="#97296" title="ConflictResolver.this.CommandSets">c2</a>.<span title="(p: scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand] =&gt; Boolean, from: Int)Int">indexWhere</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#97824" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">_</a>.<span title="(that: scala.collection.GenSet[edu.berkeley.cs.scads.storage.CStructCommand])scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">intersect</span><span class="delimiter">(</span><a href="#97308" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">currentSet</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">isEmpty</span>, <a href="#97302" title="Int">j</a><span class="delimiter">)</span> <span title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">-</span><span class="int">1</span> =&gt; <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#97300" title="Boolean">intersect</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#97308" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">currentSet</a>.<span title="()Unit">clear</span>
          <span class="delimiter">}</span>
          <a href="#97308" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">currentSet</a>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" id="97866">x</a> =&gt; <span class="delimiter">{</span>
          <span title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">if</span> <span class="delimiter">(</span><a href="#97300" title="Boolean">intersect</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#97308" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">currentSet</a>.<span title="(that: scala.collection.GenSet[edu.berkeley.cs.scads.storage.CStructCommand])scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">intersect</span><span class="delimiter">(</span><a href="#97296" title="(idx: Int)scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">c2</a><span class="delimiter">(</span><a href="#97866" title="Int">x</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#97308" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">currentSet</a>.<span title="(that: scala.collection.GenSet[edu.berkeley.cs.scads.storage.CStructCommand])scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">union</span><span class="delimiter">(</span><a href="#97296" title="(idx: Int)scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">c2</a><span class="delimiter">(</span><a href="#97866" title="Int">x</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span class="comment">// TODO: If there is an empty intersection, should it short circuit the</span>
      <span class="comment">//       rest of the comparisons?</span>
      <a href="#97295" title="ConflictResolver.this.CommandSets">result</a>.<span title="(idx: Int, elem: scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand])Unit">update</span><span class="delimiter">(</span><a href="#97301" title="Int">i</a>, <a href="#97309" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">newSet</a><span class="delimiter">)</span>
      <a href="#97301" title="Int">i</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(c: ConflictResolver.this.CommandSets)Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="97249">convertToSeq</a><span class="delimiter">(</span><a title="ConflictResolver.this.CommandSets" id="97899">c</a>: <span title="ConflictResolver.this.CommandSets">CommandSets</span><span class="delimiter">)</span>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" id="97947">result</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">ArrayBuffer</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>
    <a href="#97899" title="ConflictResolver.this.CommandSets">c</a>.<span title="(f: scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" id="97974">x</a> =&gt; <span class="delimiter">{</span>
      <a href="#97947" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">result</a>.<span title="(xs: scala.collection.TraversableOnce[edu.berkeley.cs.scads.storage.CStructCommand])Unit">appendAll</span><span class="delimiter">(</span><a href="#97974" title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">x</a>.<span title="=&gt; List[edu.berkeley.cs.scads.storage.CStructCommand]">toList</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#97947" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">result</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])ConflictResolver.this.CommandSets" id="97250">convertToSets</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="97270">c</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="ConflictResolver.this.CommandSets">CommandSets</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]" id="97977">result</a> = <span title="()scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]" class="keyword">new</span> <a href="#97242" title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]">CommandSets</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="97978">isLogical</a> = <span title="Boolean(false)" class="keyword">false</span>
    <a href="#97270" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">c</a>.<span title="(f: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="97997">x</a> =&gt; <span class="delimiter">{</span>
      <a href="#97997" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#26997" title="=&gt; edu.berkeley.cs.scads.storage.RecordUpdate">command</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="97998">up</a>: <a href="../../Messages.scala.html#9681" title="edu.berkeley.cs.scads.storage.LogicalUpdate">LogicalUpdate</a> =&gt; <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#97978" title="Boolean">isLogical</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#97977" title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]">result</a>.<span title="(elems: scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]*)Unit">append</span><span class="delimiter">(</span><span title="()scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">HashSet</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#97977" title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]">result</a>.<span title="=&gt; scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">last</span>.<span title="(elem: edu.berkeley.cs.scads.storage.CStructCommand)Boolean">add</span><span class="delimiter">(</span><a href="#97997" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a><span class="delimiter">)</span>
          <a href="#97978" title="Boolean">isLogical</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Unit" id="98007">up</a>: <a href="../../Messages.scala.html#9684" title="edu.berkeley.cs.scads.storage.PhysicalUpdate">PhysicalUpdate</a> =&gt; <span class="delimiter">{</span>
          <a href="#97977" title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]">result</a>.<span title="(elems: scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]*)Unit">append</span><span class="delimiter">(</span><span title="()scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">HashSet</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#97977" title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]">result</a>.<span title="=&gt; scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]">last</span>.<span title="(elem: edu.berkeley.cs.scads.storage.CStructCommand)Boolean">add</span><span class="delimiter">(</span><a href="#97997" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a><span class="delimiter">)</span>
          <a href="#97978" title="Boolean">isLogical</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">_</span> =&gt;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#97977" title="scala.collection.mutable.ArrayBuffer[scala.collection.mutable.HashSet[edu.berkeley.cs.scads.storage.CStructCommand]]">result</a>
  <span class="delimiter">}</span>








<span class="comment">/***********************************************************************
 **************** old code, will probably go away **********************
 ********************************************************************* */</span>

  <span class="keyword">def</span> <a title="(cstructs: Seq[edu.berkeley.cs.scads.storage.CStruct])Boolean" id="97251">isCompatible</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStruct]" id="98014">cstructs</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStruct]">Seq</span><span class="delimiter">[</span>CStruct<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#98014" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98020">commandsList</a> = <a href="#98014" title="Seq[edu.berkeley.cs.scads.storage.CStruct]">cstructs</a>.<span title="(f: edu.berkeley.cs.scads.storage.CStruct =&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.CStruct],Seq[edu.berkeley.cs.scads.storage.CStructCommand],Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]])Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Seq[edu.berkeley.cs.scads.storage.CStructCommand],Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStruct" id="98039">x</a> =&gt; <a href="#98039" title="edu.berkeley.cs.scads.storage.CStruct">x</a>.<a href="../../Messages.scala.html#27106" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a><span class="delimiter">)</span>
      <span class="comment">// TODO: only pending?</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98021">head</a> = <a href="#97254" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">reduceCommandList</a><span class="delimiter">(</span><a href="#98020" title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">commandsList</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">head</span>.<span title="(p: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Boolean)Seq[edu.berkeley.cs.scads.storage.CStructCommand]">filter</span><span class="delimiter">(</span><a href="#98100" title="edu.berkeley.cs.scads.storage.CStructCommand">_</a>.<a href="../../Messages.scala.html#27000" title="=&gt; Boolean">pending</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98022">tail</a> = <a href="#98020" title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">commandsList</a>.<span title="=&gt; Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">tail</span>
      <a href="#98022" title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">tail</a>.<span title="[B](z: B)(op: (B, Seq[edu.berkeley.cs.scads.storage.CStructCommand]) =&gt; B)B">foldLeft</span><span title="(z: Boolean)(op: (Boolean, Seq[edu.berkeley.cs.scads.storage.CStructCommand]) =&gt; Boolean)Boolean" class="delimiter">[</span><span title="Boolean">Boolean</span><span class="delimiter">]</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#97255" title="(head: Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]])(valid: Boolean, commands: Seq[edu.berkeley.cs.scads.storage.CStructCommand])Boolean">foldCommandList</a><a href="#98310" title="Boolean" class="delimiter">(</a><a href="#98021" title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">head</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(c1: Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]], c2: Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]])Boolean" id="97252">compareCommandList</a><span class="delimiter">(</span><a title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98117">c1</a>: <span title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">]</span>,
                                 <a title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98118">c2</a>: <span title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand])]" id="98121">zipped</a> = <a href="#98117" title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">c1</a>.<span title="(that: scala.collection.GenIterable[Seq[edu.berkeley.cs.scads.storage.CStructCommand]], thisElem: Seq[edu.berkeley.cs.scads.storage.CStructCommand], thatElem: Seq[edu.berkeley.cs.scads.storage.CStructCommand])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]],(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand]),Seq[(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand])]])Seq[(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand])]">zipAll</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand]),Seq[(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand])]]" class="delimiter">(</span><a href="#98118" title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">c2</a>, List<span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span>, List<span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="98122">success</a> = <span title="Boolean(true)" class="keyword">true</span>

    <a href="#98121" title="Seq[(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand])]">zipped</a>.<span title="(f: (Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand]) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand])" id="98214">t</a> =&gt; <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#98122" title="Boolean">success</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#98214" title="(Seq[edu.berkeley.cs.scads.storage.CStructCommand], Seq[edu.berkeley.cs.scads.storage.CStructCommand])">t</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="98217">l1</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>, <a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="98218">l2</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
            <a href="#98122" title="Boolean">success</a> = <a href="#97253" title="(c1: Seq[edu.berkeley.cs.scads.storage.CStructCommand], c2: Seq[edu.berkeley.cs.scads.storage.CStructCommand])Boolean">compareCommands</a><span class="delimiter">(</span><a href="#98217" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">l1</a>, <a href="#98218" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">l2</a><span class="delimiter">)</span>
          <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>_, _<span class="delimiter">)</span> =&gt; <a href="#98122" title="Boolean">success</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#98122" title="Boolean">success</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(c1: Seq[edu.berkeley.cs.scads.storage.CStructCommand], c2: Seq[edu.berkeley.cs.scads.storage.CStructCommand])Boolean" id="97253">compareCommands</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="98219">c1</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>,
                              <a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="98220">c2</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#98219" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">c1</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">!=</span> <a href="#98220" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">c2</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="comment">// Match xids for now.</span>
      <span class="keyword">val</span> <a title="scala.collection.immutable.Map[edu.berkeley.cs.scads.storage.ScadsXid,Int]" id="98228">map1</a> = <a href="#98219" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">c1</a>.<span title="(f: edu.berkeley.cs.scads.storage.CStructCommand =&gt; (edu.berkeley.cs.scads.storage.ScadsXid, Int))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.CStructCommand],(edu.berkeley.cs.scads.storage.ScadsXid, Int),Seq[(edu.berkeley.cs.scads.storage.ScadsXid, Int)]])Seq[(edu.berkeley.cs.scads.storage.ScadsXid, Int)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(edu.berkeley.cs.scads.storage.ScadsXid, Int),Seq[(edu.berkeley.cs.scads.storage.ScadsXid, Int)]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="98246">x</a> =&gt; <span title="(_1: edu.berkeley.cs.scads.storage.ScadsXid, _2: Int)(edu.berkeley.cs.scads.storage.ScadsXid, Int)" class="delimiter">(</span><a href="#98246" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a>, <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(edu.berkeley.cs.scads.storage.ScadsXid, Int),(edu.berkeley.cs.scads.storage.ScadsXid, Int)])scala.collection.immutable.Map[edu.berkeley.cs.scads.storage.ScadsXid,Int]">toMap</span>
      <span class="keyword">var</span> <a title="Boolean" id="98229">success</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#98220" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">c2</a>.<span title="(f: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="98303">x</a> =&gt; <span class="delimiter">{</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#98228" title="scala.collection.immutable.Map[edu.berkeley.cs.scads.storage.ScadsXid,Int]">map1</a>.<span title="(key: edu.berkeley.cs.scads.storage.ScadsXid)Boolean">contains</span><span class="delimiter">(</span><a href="#98303" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#26994" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">xid</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#98229" title="Boolean">success</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <a href="#98229" title="Boolean">success</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// Reduces a sequence of logical updates into a single sequence.</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]" id="97254">reduceCommandList</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="98059">c</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98062">reduced</a> = <span title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]" class="keyword">new</span> <span title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">ListBuffer</span><span class="delimiter">[</span>ListBuffer<span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="98063">isLogical</a> = <span title="Boolean(false)" class="keyword">false</span>
    <a href="#98059" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">c</a>.<span title="(f: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.CStructCommand" id="98080">x</a> =&gt; <span class="delimiter">{</span>
      <a href="#98080" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a>.<a href="../../Messages.scala.html#26997" title="=&gt; edu.berkeley.cs.scads.storage.RecordUpdate">command</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="98081">up</a>: <a href="../../Messages.scala.html#9681" title="edu.berkeley.cs.scads.storage.LogicalUpdate">LogicalUpdate</a> =&gt; <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#98063" title="Boolean">isLogical</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#98062" title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">reduced</a>.<span title="=&gt; scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">last</span>.<span title="(elems: edu.berkeley.cs.scads.storage.CStructCommand*)Unit">append</span><span class="delimiter">(</span><a href="#98080" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" id="98083">newIds</a> = <span title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">ListBuffer</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#98083" title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">newIds</a>.<span title="(elems: edu.berkeley.cs.scads.storage.CStructCommand*)Unit">append</span><span class="delimiter">(</span><a href="#98080" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a><span class="delimiter">)</span>
            <a href="#98062" title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">reduced</a>.<span title="(elems: scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]*)Unit">append</span><span class="delimiter">(</span><a href="#98083" title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">newIds</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <a href="#98063" title="Boolean">isLogical</a> = <span title="Boolean(true)" class="keyword">true</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="Unit" id="98086">up</a>: <a href="../../Messages.scala.html#9684" title="edu.berkeley.cs.scads.storage.PhysicalUpdate">PhysicalUpdate</a> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" id="98087">newIds</a> = <span title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]" class="keyword">new</span> <span title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">ListBuffer</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#98087" title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">newIds</a>.<span title="(elems: edu.berkeley.cs.scads.storage.CStructCommand*)Unit">append</span><span class="delimiter">(</span><a href="#98080" title="edu.berkeley.cs.scads.storage.CStructCommand">x</a><span class="delimiter">)</span>
          <a href="#98062" title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">reduced</a>.<span title="(elems: scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]*)Unit">append</span><span class="delimiter">(</span><a href="#98087" title="scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]">newIds</a><span class="delimiter">)</span>
          <a href="#98063" title="Boolean">isLogical</a> = <span title="Boolean(false)" class="keyword">false</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">_</span> =&gt;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#98062" title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">reduced</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(head: Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]])(valid: Boolean, commands: Seq[edu.berkeley.cs.scads.storage.CStructCommand])Boolean" id="97255">foldCommandList</a><span class="delimiter">(</span><a title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98107">head</a>: <span title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">Seq</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="Boolean" id="98108">valid</a>: <span title="Boolean">Boolean</span>, <a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="98109">commands</a>: <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#98108" title="Boolean">valid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="=&gt; Boolean">!</span><a href="#98108" title="Boolean">valid</a>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]" id="98112">pendingCommands</a> = <a href="#97254" title="(c: Seq[edu.berkeley.cs.scads.storage.CStructCommand])scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">reduceCommandList</a><span class="delimiter">(</span><a href="#98109" title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">commands</a>.<span title="(p: edu.berkeley.cs.scads.storage.CStructCommand =&gt; Boolean)Seq[edu.berkeley.cs.scads.storage.CStructCommand]">filter</span><span class="delimiter">(</span><a href="#98116" title="edu.berkeley.cs.scads.storage.CStructCommand">_</a>.<a href="../../Messages.scala.html#27000" title="=&gt; Boolean">pending</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#97252" title="(c1: Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]], c2: Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]])Boolean">compareCommandList</a><span class="delimiter">(</span><a href="#98107" title="Seq[Seq[edu.berkeley.cs.scads.storage.CStructCommand]]">head</a>, <a href="#98112" title="scala.collection.mutable.ListBuffer[scala.collection.mutable.ListBuffer[edu.berkeley.cs.scads.storage.CStructCommand]]">pendingCommands</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>