<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>transactions/protocol/ProtocolMDCC.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads
<span class="keyword">package</span> storage
<span class="keyword">package</span> transactions
<span class="keyword">package</span> mdcc

<span class="keyword">import</span> comm._
<span class="keyword">import</span> <a href="MDCCMetaHelper.scala.html#10403" title="object edu.berkeley.cs.scads.storage.transactions.MDCCMetaHelper">MDCCMetaHelper</a>._
<span class="keyword">import</span> scala.math.<span class="delimiter">{</span>floor, ceil<span class="delimiter">}</span>

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> java.lang.Thread
<span class="keyword">import</span> java.util.Calendar

<span class="keyword">import</span> collection.mutable.HashSet
<span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger
<span class="keyword">import</span> util.<span class="delimiter">{</span>LRUMap<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.generic.IndexedRecord

<span class="comment">//import tools.nsc.matching.ParallelMatching.MatchMatrix.VariableRule</span>
<span class="keyword">import</span> actors.Actor

<span class="keyword">sealed</span> case <span class="keyword">class</span> <a title="class MDCCUpdateInfo extends java.lang.Object with ScalaObject with Product with Serializable" id="103004">MDCCUpdateInfo</a><a href="#103004" title="ScalaObject" class="delimiter">(</a>   <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="102993">update</a>: <a href="../../Messages.scala.html#9680" title="edu.berkeley.cs.scads.storage.RecordUpdate">RecordUpdate</a>,
                                    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="102994">servers</a>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>,
                                    <span class="keyword">var</span> <a title="Option[edu.berkeley.cs.scads.storage.MDCCMetadata]" id="102995">meta</a>: <span title="Option[edu.berkeley.cs.scads.storage.MDCCMetadata]">Option</span><span class="delimiter">[</span>MDCCMetadata<span class="delimiter">]</span>,
                                    <span class="keyword">var</span> <a title="List[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="102996">futures</a>: <span title="List[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">List</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>,
                                    <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus" id="102997">status</a>: <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Int" id="101633">hashCode</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#102993" title="=&gt; edu.berkeley.cs.scads.storage.RecordUpdate">update</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a>.<span title="()Int">hashCode</span><span class="delimiter">(</span><span class="delimiter">)</span>
<span class="delimiter">}</span>


<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.transactions.mdcc.MDCCHandler" id="10433">MDCCHandler</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../ProtocolBase.scala.html#10172" title="edu.berkeley.cs.scads.storage.transactions.ProtocolBase">ProtocolBase</a> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.Tx)Unit" id="96030">RunProtocol</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.Tx" id="96031">tx</a>: <a href="../Tx.scala.html#10267" title="edu.berkeley.cs.scads.storage.transactions.Tx">Tx</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCTrxHandler" id="96034">trxHandler</a> = <span title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCTrxHandler" class="keyword">new</span> <a href="#10435" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCTrxHandler">MCCCTrxHandler</a><span class="delimiter">(</span><a href="#96031" title="edu.berkeley.cs.scads.storage.transactions.Tx">tx</a><span class="delimiter">)</span>
    <a href="#96034" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCTrxHandler">trxHandler</a>.<span title="()scala.actors.Actor">start</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class MCCCTrxHandler extends java.lang.Object with scala.actors.Actor with ScalaObject" id="10435">MCCCTrxHandler</a><a href="#10435" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.storage.transactions.Tx" id="96245">tx</a>: <a href="../Tx.scala.html#10267" title="edu.berkeley.cs.scads.storage.transactions.Tx">Tx</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="scala.actors.Actor">Actor</span> <span class="delimiter">{</span>
  <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.transactions.TxStatus" id="96039">status</a>: <a href="../Tx.scala.html#10250" title="edu.berkeley.cs.scads.storage.transactions.TxStatus">TxStatus</a> = <a href="../Tx.scala.html#10251" title="object edu.berkeley.cs.scads.storage.transactions.UNKNOWN">UNKNOWN</a>
  <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.ScadsXid" id="96042">Xid</a> = <a href="../../Messages.scala.html#9711" title="object edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a>.<a href="../../Messages.scala.html#28102" title="()edu.berkeley.cs.scads.storage.ScadsXid">createUniqueXid</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">var</span> <a title="Int" id="96045">count</a> = <span title="Int(0)" class="int">0</span>
  <span class="keyword">var</span> <a title="Int" id="96048">size</a> = <span title="Int(0)" class="int">0</span>

  <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]" id="96050">remoteHandle</a> = <a href="../../package.scala.html#10642" title="object edu.berkeley.cs.scads.storage.package.StorageRegistry">StorageRegistry</a>.<span title="(actor: scala.actors.Actor)edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">registerActor</span><span class="delimiter">(</span><a href="#10435" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCTrxHandler" class="keyword">this</a><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]" class="delimiter">[</span><span title="edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]">RemoteService</span><span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(updateList: edu.berkeley.cs.scads.storage.transactions.UpdateList, readList: edu.berkeley.cs.scads.storage.transactions.ReadList)Unit" id="96052">startTrx</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.UpdateList" id="101819">updateList</a>: <a href="../UpdateList.scala.html#10330" title="edu.berkeley.cs.scads.storage.transactions.UpdateList">UpdateList</a>, <a title="edu.berkeley.cs.scads.storage.transactions.ReadList" id="101820">readList</a>: <a href="../ReadList.scala.html#10185" title="edu.berkeley.cs.scads.storage.transactions.ReadList">ReadList</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#101819" title="edu.berkeley.cs.scads.storage.transactions.UpdateList">updateList</a>.<a href="../UpdateList.scala.html#90713" title="()List[edu.berkeley.cs.scads.storage.transactions.UpdateInfo]">getUpdateList</a>.<span title="(f: edu.berkeley.cs.scads.storage.transactions.UpdateInfo =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.UpdateInfo" id="101844">update</a> =&gt; <span class="delimiter">{</span>
      <a href="#96048" title="(x$1: Int)Unit">size</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <a href="#101844" title="edu.berkeley.cs.scads.storage.transactions.UpdateInfo">update</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">ValueUpdateInfo</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionDefaultMetadata" id="101863">ns</a>, <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="101864">servers</a>, <a title="Array[Byte]" id="101865">key</a>, <a title="Option[Array[Byte]]" id="101866">value</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]" id="101867">oldRrecord</a> = <a href="#101820" title="edu.berkeley.cs.scads.storage.transactions.ReadList">readList</a>.<a href="../ReadList.scala.html#90719" title="(key: Array[Byte])Option[edu.berkeley.cs.scads.storage.MDCCRecord]">getRecord</a><span class="delimiter">(</span><a href="#101865" title="Array[Byte]">key</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCMetadata" id="101868">md</a> : <a href="../../Messages.scala.html#9668" title="edu.berkeley.cs.scads.storage.MDCCMetadata">MDCCMetadata</a>= <a href="#101867" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">oldRrecord</a>
                                  .<span title="(f: edu.berkeley.cs.scads.storage.MDCCRecord =&gt; edu.berkeley.cs.scads.storage.MDCCMetadata)Option[edu.berkeley.cs.scads.storage.MDCCMetadata]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="101875">r</a> =&gt; <a href="../../Messages.scala.html#26939" title="(currentRound: Long, ballots: Seq[edu.berkeley.cs.scads.storage.MDCCBallotRange])edu.berkeley.cs.scads.storage.MDCCMetadata">MDCCMetadata</a><span class="delimiter">(</span><a href="#101875" title="edu.berkeley.cs.scads.storage.MDCCRecord">r</a>.<a href="../../Messages.scala.html#27192" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">metadata</a>.<a href="../../Messages.scala.html#26907" title="=&gt; Long">currentRound</a>, <a href="#101875" title="edu.berkeley.cs.scads.storage.MDCCRecord">r</a>.<a href="../../Messages.scala.html#27192" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">metadata</a>.<a href="../../Messages.scala.html#26910" title="=&gt; Seq[edu.berkeley.cs.scads.storage.MDCCBallotRange]">ballots</a><span class="delimiter">)</span><span class="delimiter">)</span>
                                  .<span title="(default: =&gt; edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.MDCCMetadata">getOrElse</span><span class="delimiter">(</span><a href="#101863" title="edu.berkeley.cs.scads.storage.transactions.TransactionDefaultMetadata">ns</a>.<a href="../Transactions.scala.html#91374" title="()edu.berkeley.cs.scads.storage.MDCCMetadata">getDefaultMeta</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="comment">//TODO: Do we really need the MDCCMetadata</span>
          <span class="keyword">val</span> <a title="Array[Byte]" id="101869">newBytes</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80720" title="(rec: Option[Array[Byte]], metadata: Option[edu.berkeley.cs.scads.storage.MDCCMetadata])Array[Byte]">toBytes</a><span class="delimiter">(</span><a href="#101866" title="Option[Array[Byte]]">value</a>, <a href="#101868" title="(a: edu.berkeley.cs.scads.storage.MDCCMetadata)Option[edu.berkeley.cs.scads.storage.MDCCMetadata]">md</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.Envelope[edu.berkeley.cs.scads.storage.StorageMessage]" id="101870">propose</a> = <span title="(src: Option[edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]], msg: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.Envelope[edu.berkeley.cs.scads.storage.StorageMessage]">Envelope</span><span class="delimiter">(</span><span title="(x: edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage])Some[edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]]">Some</span><span class="delimiter">(</span><a href="#96050" title="=&gt; edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span>, <a href="../../Messages.scala.html#28472" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, update: edu.berkeley.cs.scads.storage.RecordUpdate)edu.berkeley.cs.scads.storage.Propose">Propose</a><span class="delimiter">(</span><a href="#96042" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">Xid</a>, <a href="../../Messages.scala.html#27473" title="(key: Array[Byte], oldValue: Option[Array[Byte]], newValue: Array[Byte])edu.berkeley.cs.scads.storage.ValueUpdate">ValueUpdate</a><span class="delimiter">(</span><a href="#101865" title="Array[Byte]">key</a>, <a href="#101867" title="Option[edu.berkeley.cs.scads.storage.MDCCRecord]">oldRrecord</a>.<span title="(f: edu.berkeley.cs.scads.storage.MDCCRecord =&gt; Option[Array[Byte]])Option[Array[Byte]]">flatMap</span><span class="delimiter">(</span><a href="#101944" title="edu.berkeley.cs.scads.storage.MDCCRecord">_</a>.<a href="../../Messages.scala.html#27189" title="=&gt; Option[Array[Byte]]">value</a><span class="delimiter">)</span>, <a href="#101866" title="Option[Array[Byte]]">value</a>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#10436" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.MDCCRecordCache">MDCCRecordCache</a>.<a href="#101955" title="(key: Array[Byte], servers: Seq[edu.berkeley.cs.scads.storage.PartitionService], meta: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">getOrCreate</a><span class="delimiter">(</span><a href="#101865" title="Array[Byte]">key</a>, <a href="#101864" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>, <a href="#101868" title="edu.berkeley.cs.scads.storage.MDCCMetadata">md</a><span class="delimiter">)</span> <span title="(msg: Any)Unit">!</span> <a href="#101870" title="edu.berkeley.cs.scads.comm.Envelope[edu.berkeley.cs.scads.storage.StorageMessage]">propose</a>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">LogicalUpdateInfo</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionDefaultMetadata" id="102015">ns</a>, <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="102016">servers</a>, <a title="Array[Byte]" id="102017">key</a>, <a title="Option[Array[Byte]]" id="102018">value</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.MDCCMetadata" id="102019">md</a> = <a href="#101820" title="edu.berkeley.cs.scads.storage.transactions.ReadList">readList</a>.<a href="../ReadList.scala.html#90719" title="(key: Array[Byte])Option[edu.berkeley.cs.scads.storage.MDCCRecord]">getRecord</a><span class="delimiter">(</span><a href="#102017" title="Array[Byte]">key</a><span class="delimiter">)</span>
                              .<span title="(f: edu.berkeley.cs.scads.storage.MDCCRecord =&gt; edu.berkeley.cs.scads.storage.MDCCMetadata)Option[edu.berkeley.cs.scads.storage.MDCCMetadata]">map</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCRecord" id="102026">r</a> =&gt; <a href="../../Messages.scala.html#26939" title="(currentRound: Long, ballots: Seq[edu.berkeley.cs.scads.storage.MDCCBallotRange])edu.berkeley.cs.scads.storage.MDCCMetadata">MDCCMetadata</a><span class="delimiter">(</span><a href="#102026" title="edu.berkeley.cs.scads.storage.MDCCRecord">r</a>.<a href="../../Messages.scala.html#27192" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">metadata</a>.<a href="../../Messages.scala.html#26907" title="=&gt; Long">currentRound</a>, <a href="#102026" title="edu.berkeley.cs.scads.storage.MDCCRecord">r</a>.<a href="../../Messages.scala.html#27192" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">metadata</a>.<a href="../../Messages.scala.html#26910" title="=&gt; Seq[edu.berkeley.cs.scads.storage.MDCCBallotRange]">ballots</a><span class="delimiter">)</span><span class="delimiter">)</span>
                              .<span title="(default: =&gt; edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.MDCCMetadata">getOrElse</span><span class="delimiter">(</span><a href="#102015" title="edu.berkeley.cs.scads.storage.transactions.TransactionDefaultMetadata">ns</a>.<a href="../Transactions.scala.html#91374" title="()edu.berkeley.cs.scads.storage.MDCCMetadata">getDefaultMeta</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="Array[Byte]" id="102020">newBytes</a> = <a href="../Transactions.scala.html#10232" title="object edu.berkeley.cs.scads.storage.transactions.MDCCRecordUtil">MDCCRecordUtil</a>.<a href="../Transactions.scala.html#80720" title="(rec: Option[Array[Byte]], metadata: Option[edu.berkeley.cs.scads.storage.MDCCMetadata])Array[Byte]">toBytes</a><span class="delimiter">(</span><a href="#102018" title="Option[Array[Byte]]">value</a>, <a href="#102019" title="(a: edu.berkeley.cs.scads.storage.MDCCMetadata)Option[edu.berkeley.cs.scads.storage.MDCCMetadata]">md</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.Envelope[edu.berkeley.cs.scads.storage.StorageMessage]" id="102021">propose</a> = <span title="(src: Option[edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]], msg: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.comm.Envelope[edu.berkeley.cs.scads.storage.StorageMessage]">Envelope</span><span class="delimiter">(</span><span title="(x: edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage])Some[edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]]">Some</span><span class="delimiter">(</span><a href="#96050" title="=&gt; edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span>, <a href="../../Messages.scala.html#28472" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, update: edu.berkeley.cs.scads.storage.RecordUpdate)edu.berkeley.cs.scads.storage.Propose">Propose</a><span class="delimiter">(</span><a href="#96042" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">Xid</a>, <a href="../../Messages.scala.html#27300" title="(key: Array[Byte], delta: Array[Byte])edu.berkeley.cs.scads.storage.LogicalUpdate">LogicalUpdate</a><span class="delimiter">(</span><a href="#102017" title="Array[Byte]">key</a>, <a href="#102018" title="Option[Array[Byte]]">value</a>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#10436" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.MDCCRecordCache">MDCCRecordCache</a>.<a href="#101955" title="(key: Array[Byte], servers: Seq[edu.berkeley.cs.scads.storage.PartitionService], meta: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">getOrCreate</a><span class="delimiter">(</span><a href="#102017" title="Array[Byte]">key</a>, <a href="#102016" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>, <a href="#102019" title="edu.berkeley.cs.scads.storage.MDCCMetadata">md</a><span class="delimiter">)</span> <span title="(msg: Any)Unit">!</span> <a href="#102021" title="edu.berkeley.cs.scads.comm.Envelope[edu.berkeley.cs.scads.storage.StorageMessage]">propose</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="96053">act</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#96052" title="(updateList: edu.berkeley.cs.scads.storage.transactions.UpdateList, readList: edu.berkeley.cs.scads.storage.transactions.ReadList)Unit">startTrx</a><span class="delimiter">(</span><a href="#96245" title="edu.berkeley.cs.scads.storage.transactions.Tx">tx</a>.<a href="../Tx.scala.html#90407" title="=&gt; edu.berkeley.cs.scads.storage.transactions.UpdateList">updateList</a>, <a href="#96245" title="edu.berkeley.cs.scads.storage.transactions.Tx">tx</a>.<a href="../Tx.scala.html#90410" title="=&gt; edu.berkeley.cs.scads.storage.transactions.ReadList">readList</a><span class="delimiter">)</span>
    <a href="#10435" title="(body: =&gt; Unit)Unit">loop</a> <span class="delimiter">{</span>
      <a href="#10435" title="(handler: PartialFunction[Any,Unit])Nothing">react</a> <a href="#102062" title="Unit" class="delimiter">{</a>
        <span class="keyword">case</span> <a href="#102437" title="Unit">LEARNED_ABORT</a> =&gt; <span class="delimiter">{</span>
          <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#96039" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxStatus">status</a> <span title="(x$1: AnyRef)Boolean">!=</span> <a href="../Tx.scala.html#10253" title="object edu.berkeley.cs.scads.storage.transactions.COMMIT">COMMIT</a><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#96039" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="../Tx.scala.html#10251" title="object edu.berkeley.cs.scads.storage.transactions.UNKNOWN">UNKNOWN</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#96039" title="(x$1: edu.berkeley.cs.scads.storage.transactions.TxStatus)Unit">status</a> = <a href="../Tx.scala.html#10255" title="object edu.berkeley.cs.scads.storage.transactions.ABORT">ABORT</a>
            <a href="#10435" title="MCCCTrxHandler.this.type" class="keyword">this</a> <span title="(msg: Any)Unit">!</span> <a href="#102338" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.EXIT">EXIT</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a href="#102449" title="Unit">LEARNED_ACCEPT</a> =&gt; <span class="delimiter">{</span>
          <a href="#96045" title="(x$1: Int)Unit">count</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#96045" title="=&gt; Int">count</a> <span title="(x: Int)Boolean">==</span> <a href="#96048" title="=&gt; Int">size</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#96039" title="=&gt; edu.berkeley.cs.scads.storage.transactions.TxStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="../Tx.scala.html#10251" title="object edu.berkeley.cs.scads.storage.transactions.UNKNOWN">UNKNOWN</a><span class="delimiter">)</span><span class="delimiter">{</span>
            <a href="#96039" title="(x$1: edu.berkeley.cs.scads.storage.transactions.TxStatus)Unit">status</a> = <a href="../Tx.scala.html#10253" title="object edu.berkeley.cs.scads.storage.transactions.COMMIT">COMMIT</a>
            <a href="#10435" title="MCCCTrxHandler.this.type" class="keyword">this</a> <span title="(msg: Any)Unit">!</span> <a href="#102338" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.EXIT">EXIT</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a href="#102338" title="Nothing">EXIT</a> =&gt; <span class="delimiter">{</span>
          <a href="../../package.scala.html#10642" title="object edu.berkeley.cs.scads.storage.package.StorageRegistry">StorageRegistry</a>.<span title="(service: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])edu.berkeley.cs.scads.comm.MessageReceiver[edu.berkeley.cs.scads.storage.StorageMessage]">unregisterService</span><span class="delimiter">(</span><a href="#96050" title="=&gt; edu.berkeley.cs.scads.comm.RemoteService[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span>
          <a href="#10435" title="()Nothing">exit</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Nothing">_</span> =&gt;
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown message&quot;)" class="string">&quot;Unknown message&quot;</span><span class="delimiter">)</span>

      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>


<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.transactions.mdcc.MDCCRecordCache" id="10436">MDCCRecordCache</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="keyword">val</span> <a title="Int" id="101949">CACHE_SIZE</a> = <span title="Int(500)" class="int">500</span>

  <span class="comment">//TODO: If we wanna use the cache for reads, we should use a lock-free structure</span>
  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]" id="101952">cache</a> = <a href="#102217" title="edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]" class="keyword">new</a> <a title="anonymous class $anon extends edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]" id="102217">LRUMap</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, MCCCRecordHandler<span class="delimiter">]</span><span class="delimiter">(</span><a href="#101949" title="=&gt; Int">CACHE_SIZE</a>, <span title="object None">None</span>, <a href="#101953" title="(key: Array[Byte], handler: edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler)Unit">killHandler</a><span class="delimiter">)</span><span class="delimiter">{</span>
      <span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">def</span> <a title="(k: Array[Byte], v: edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler)Boolean" id="102261">canExpire</a><span class="delimiter">(</span><a title="Array[Byte]" id="102262">k</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" id="102263">v</a>: <a href="#10457" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">MCCCRecordHandler</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#102263" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">v</a>.<a href="#102002" title="=&gt; edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">getStatus</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#102350" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.READY">READY</a>
    <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: Array[Byte], handler: edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler)Unit" id="101953">killHandler</a> <span class="delimiter">(</span><a title="Array[Byte]" id="102279">key</a> : <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" id="102280">handler</a> :  <a href="#10457" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">MCCCRecordHandler</a><span class="delimiter">)</span> = <a href="#102280" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">handler</a> <span title="(msg: Any)Unit">!</span> <a href="#102338" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.EXIT">EXIT</a>

  <span class="keyword">def</span> <a title="(key: Array[Byte])Option[edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]" id="101954">get</a><span class="delimiter">(</span><a title="Array[Byte]" id="102303">key</a> : <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> : <span title="Option[edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">Option</span><span class="delimiter">[</span>MCCCRecordHandler<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#101951" title="=&gt; edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">cache</a>.<span title="(x$1: Option[edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler])Option[edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">synchronized</span><span class="delimiter">{</span>
      <a href="#101951" title="=&gt; edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">cache</a>.<a href="../../util/LRUMap.scala.html#102248" title="(key: Array[Byte])Option[edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">get</a><span class="delimiter">(</span><a href="#102303" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: Array[Byte], servers: Seq[edu.berkeley.cs.scads.storage.PartitionService], meta: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" id="101955">getOrCreate</a><span class="delimiter">(</span><a title="Array[Byte]" id="101956">key</a> : <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="101957">servers</a>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.storage.MDCCMetadata" id="101958">meta</a>: <a href="../../Messages.scala.html#9668" title="edu.berkeley.cs.scads.storage.MDCCMetadata">MDCCMetadata</a><span class="delimiter">)</span> : <a href="#10457" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">MCCCRecordHandler</a> = <span class="delimiter">{</span>
    <a href="#101951" title="=&gt; edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">cache</a>.<span title="(x$1: edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler)edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">synchronized</span><span class="delimiter">{</span>
      <a href="#101951" title="=&gt; edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">cache</a>.<a href="../../util/LRUMap.scala.html#102248" title="(key: Array[Byte])Option[edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">get</a><span class="delimiter">(</span><a href="#101956" title="Array[Byte]">key</a><span class="delimiter">)</span> <span title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">None</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" id="102313">handler</a> = <span title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" class="keyword">new</span> <a href="#10457" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">MCCCRecordHandler</a><span class="delimiter">(</span><a href="#101956" title="Array[Byte]">key</a>, <a href="#101957" title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>, <a href="#101958" title="edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span>
          <a href="#102313" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">handler</a>.<span title="()scala.actors.Actor">start</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#101951" title="=&gt; edu.berkeley.cs.scads.util.LRUMap[Array[Byte],edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler]">cache</a>.<a href="../../util/LRUMap.scala.html#102253" title="(key: Array[Byte], value: edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler)Unit">update</a><span class="delimiter">(</span><a href="#101956" title="Array[Byte]">key</a>, <a href="#102313" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">handler</a><span class="delimiter">)</span>
          <a href="#102313" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">handler</a>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">Some</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" id="102324">v</a><span class="delimiter">)</span> =&gt; <a href="#102324" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">v</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>


<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait RecordStatus extends java.lang.Object" id="10438">RecordStatus</a> <span title="java.lang.Object" class="delimiter">{</span><span class="keyword">def</span> <a title="=&gt; String" id="101645">name</a>: <span title="String">String</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102333" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.EXIT" id="102338">EXIT</a>
case <span class="keyword">object</span> <a href="#102345" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.READY" id="102350">READY</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102298">name</a> = <span title="java.lang.String(&quot;READY&quot;)" class="string">&quot;READY&quot;</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102360" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PROPOSE" id="102365">PROPOSE</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102352">name</a> = <span title="java.lang.String(&quot;PROPOSE&quot;)" class="string">&quot;PROPOSE&quot;</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102375" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PROPOSED" id="102380">PROPOSED</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102367">name</a> = <span title="java.lang.String(&quot;PROPOSED&quot;)" class="string">&quot;PROPOSED&quot;</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102390" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.FAST_PROPOSED" id="102395">FAST_PROPOSED</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102382">name</a> = <span title="java.lang.String(&quot;FAST_PROPOSED&quot;)" class="string">&quot;FAST_PROPOSED&quot;</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102405" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PHASE1A" id="102410">PHASE1A</a>  <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102397">name</a> = <span title="java.lang.String(&quot;PHASE1A&quot;)" class="string">&quot;PHASE1A&quot;</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102420" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PHASE2A" id="102425">PHASE2A</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102412">name</a> = <span title="java.lang.String(&quot;PHASE2A&quot;)" class="string">&quot;PHASE2A&quot;</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102432" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.LEARNED_ABORT" id="102437">LEARNED_ABORT</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102064">name</a> = <span title="java.lang.String(&quot;LEARNED_ABORT&quot;)" class="string">&quot;LEARNED_ABORT&quot;</span><span class="delimiter">}</span>
case <span class="keyword">object</span> <a href="#102444" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.LEARNED_ACCEPT" id="102449">LEARNED_ACCEPT</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> <span class="delimiter">{</span><span class="keyword">val</span> <a title="java.lang.String" id="102082">name</a> = <span title="java.lang.String(&quot;LEARNED_ACCEPT&quot;)" class="string">&quot;LEARNED_ACCEPT&quot;</span><span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class MCCCRecordHandler extends java.lang.Object with scala.actors.Actor with ScalaObject" id="10457">MCCCRecordHandler</a> <a href="#10457" title="ScalaObject" class="delimiter">(</a>
       <span class="keyword">var</span> <a title="Array[Byte]" id="102314">key</a> : <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>,
       <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.PartitionService]" id="102315">servers</a>: <span title="Seq[edu.berkeley.cs.scads.storage.PartitionService]">Seq</span><span class="delimiter">[</span>PartitionService<span class="delimiter">]</span>,
       <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.MDCCMetadata" id="102316">meta</a>: <a href="../../Messages.scala.html#9668" title="edu.berkeley.cs.scads.storage.MDCCMetadata">MDCCMetadata</a>
  <span class="delimiter">)</span> <span class="keyword">extends</span> <span title="scala.actors.Actor">Actor</span> <span class="delimiter">{</span>

  <span class="keyword">type</span> <a title="edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]" id="101973">ServiceType</a> =  <span title="edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]">RemoteService</span><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler.extractSource : (src: Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]])edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]" id="101974">extractSource</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]" id="102465">src</a> : <span title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]">Option</span><span class="delimiter">[</span>RemoteService<span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#102465" title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]">src</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]">get</span>

  <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]" id="101975">remoteHandle</a> = <a href="../../package.scala.html#10642" title="object edu.berkeley.cs.scads.storage.package.StorageRegistry">StorageRegistry</a>.<span title="(actor: scala.actors.Actor)edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">registerActor</span><span class="delimiter">(</span><a href="#10457" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler" class="keyword">this</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="101978">value</a> : <span title="Seq[edu.berkeley.cs.scads.storage.CStructCommand]">Seq</span><span class="delimiter">[</span>CStructCommand<span class="delimiter">]</span>  = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus" id="101981">status</a>: <a href="#10438" title="edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">RecordStatus</a> = <a href="#102350" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.READY">READY</a>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.MDCCProtocol" id="101984">currentRequest</a> : <a href="../../Messages.scala.html#9717" title="edu.berkeley.cs.scads.storage.MDCCProtocol">MDCCProtocol</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]" id="101987">quorum</a> =  <span title="()scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]">HashSet</span><span class="delimiter">[</span>ServiceType<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.ScadsXid" id="101990">Xid</a>: <a href="../../Messages.scala.html#9710" title="edu.berkeley.cs.scads.storage.ScadsXid">ScadsXid</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="101993">update</a>: <a href="../../Messages.scala.html#9680" title="edu.berkeley.cs.scads.storage.RecordUpdate">RecordUpdate</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]" id="101996">source</a> : <span title="edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]">RemoteService</span><span class="delimiter">[</span>IndexedRecord<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>

  <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="Null" id="101998">localAddress</a> = <span title="Null(null)" class="keyword">null</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Int" id="102000">hashCode</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#102314" title="=&gt; Array[Byte]">key</a>.<span title="()Int">hashCode</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(that: Any)Boolean" id="102001">equals</a><span class="delimiter">(</span><a title="Any" id="102471">that</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#102471" title="Any">that</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
     <span class="keyword">case</span> <a title="Boolean" id="102473">other</a>: <a href="#10457" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">MCCCRecordHandler</a> =&gt; <a href="#102314" title="=&gt; Array[Byte]">key</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#102473" title="edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler">other</a>.<a href="#102314" title="=&gt; Array[Byte]">key</a>
     <span class="keyword">case</span> <span title="Boolean(false)">_</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
  <span class="delimiter">}</span>


  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus" id="102002">getStatus</a> = <a href="#101981" title="=&gt; edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">status</a>
  <span class="keyword">def</span> <a title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]" id="102003">getValue</a> = <a href="#101978" title="=&gt; Seq[edu.berkeley.cs.scads.storage.CStructCommand]">value</a>

  <span class="keyword">def</span> <a title="()Unit" id="102004">act</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#10457" title="(body: =&gt; Unit)Unit">loop</a> <span class="delimiter">{</span>
      <a href="#10457" title="(handler: PartialFunction[Any,Unit])Nothing">react</a> <a href="#102486" title="Unit" class="delimiter">{</a>
        <span class="keyword">case</span> <a href="#102338" title="Nothing">EXIT</a> =&gt;<span class="delimiter">{</span>
          <a href="../../package.scala.html#10642" title="object edu.berkeley.cs.scads.storage.package.StorageRegistry">StorageRegistry</a>.<span title="(service: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])edu.berkeley.cs.scads.comm.MessageReceiver[edu.berkeley.cs.scads.storage.StorageMessage]">unregisterService</span><span class="delimiter">(</span><a href="#101975" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span>
          <a href="#10457" title="()Nothing">exit</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">Envelope</span><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]" id="102595">src</a>, <a title="edu.berkeley.cs.scads.storage.BeMaster" id="102596">msg</a> @ BeMaster<span class="delimiter">(</span><a title="Array[Byte]" id="102597">key</a>, <a title="Long" id="102598">startRound</a>, <a title="Long" id="102599">endRound</a>, <a title="Boolean" id="102600">fast</a> <span class="delimiter">)</span><span class="delimiter">)</span> <span class="keyword">if</span> <a href="#101981" title="=&gt; edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#102350" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.READY">READY</a> =&gt; <span class="delimiter">{</span>
          <a href="#101996" title="(x$1: edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord])Unit">source</a> = <a href="#102595" title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]">src</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]">get</span>
          <a href="#101984" title="(x$1: edu.berkeley.cs.scads.storage.MDCCProtocol)Unit">currentRequest</a> = <a href="#102596" title="edu.berkeley.cs.scads.storage.BeMaster">msg</a>
          <a href="#102008" title="()Unit">startPhase1a</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">Envelope</span><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]" id="102609">src</a>, <a title="edu.berkeley.cs.scads.storage.Propose" id="102610">msg</a> @ Propose<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="102611">xid</a>, <a title="edu.berkeley.cs.scads.storage.RecordUpdate" id="102612">update</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="keyword">if</span> <a href="#101981" title="=&gt; edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#102350" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.READY">READY</a> =&gt; <span class="delimiter">{</span>
          <a href="#101996" title="(x$1: edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord])Unit">source</a> = <a href="#102609" title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]">src</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]">get</span>
          <a href="#101984" title="(x$1: edu.berkeley.cs.scads.storage.MDCCProtocol)Unit">currentRequest</a> = <a href="#102610" title="edu.berkeley.cs.scads.storage.Propose">msg</a>
          <a href="#10457" title="MCCCRecordHandler.this.type" class="keyword">this</a>.<a href="#101993" title="(x$1: edu.berkeley.cs.scads.storage.RecordUpdate)Unit">update</a> = <a href="#102612" title="edu.berkeley.cs.scads.storage.RecordUpdate">update</a>
          <a href="#10457" title="MCCCRecordHandler.this.type" class="keyword">this</a>.<a href="#101990" title="(x$1: edu.berkeley.cs.scads.storage.ScadsXid)Unit">Xid</a> = <a href="#102611" title="edu.berkeley.cs.scads.storage.ScadsXid">xid</a>
          <a href="#102009" title="()Any">SendProposal</a><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">Envelope</span><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]" id="102726">src</a>, Phase1b<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCMetadata" id="102727">ballot</a>, <a title="edu.berkeley.cs.scads.storage.CStruct" id="102728">value</a><span class="delimiter">)</span> <span class="delimiter">)</span> =&gt;   <span class="delimiter">{</span>   <span class="comment">//we do the phase check afterwards to empty out old messages</span>
          <a href="#101981" title="=&gt; edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">status</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a href="#102410" title="Unit">PHASE1A</a> =&gt; <a href="#102005" title="(src: MCCCRecordHandler.this.ServiceType, aMeta: edu.berkeley.cs.scads.storage.MDCCMetadata, value: edu.berkeley.cs.scads.storage.CStruct)Any">processPhase1b</a><span title="Unit" class="delimiter">(</span><a href="#101974" title="implicit edu.berkeley.cs.scads.storage.transactions.mdcc.MCCCRecordHandler.extractSource : (src: Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]])edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]">src</a>, <a href="#102727" title="edu.berkeley.cs.scads.storage.MDCCMetadata">ballot</a>, <a href="#102728" title="edu.berkeley.cs.scads.storage.CStruct">value</a><span class="delimiter">)</span>
            <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span class="comment">//out of phase message</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">Envelope</span><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]" id="102877">src</a>, Phase2bClassic<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCBallot" id="102878">ballot</a>, <a title="Option[edu.berkeley.cs.scads.storage.CStruct]" id="102879">value</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        <span class="keyword">case</span> <span title="Unit">Envelope</span><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]" id="102882">src</a>, Phase2bFast<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.MDCCBallot" id="102883">ballot</a>, <a title="Option[edu.berkeley.cs.scads.storage.CStruct]" id="102884">value</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        <span class="keyword">case</span> <span title="Unit">Envelope</span><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]]" id="102887">src</a>, Accept<span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.ScadsXid" id="102888">xid</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        <span class="keyword">case</span> <span title="Nothing">_</span> =&gt;  <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Not supported request&quot;)" class="string">&quot;Not supported request&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">//TODO: At the moment we agree on the full meta data, we could also just agree on the new value</span>
  <span class="keyword">def</span> <a title="(src: MCCCRecordHandler.this.ServiceType, aMeta: edu.berkeley.cs.scads.storage.MDCCMetadata, value: edu.berkeley.cs.scads.storage.CStruct)Any" id="102005">processPhase1b</a><span class="delimiter">(</span><a title="MCCCRecordHandler.this.ServiceType" id="102729">src</a> : <span title="MCCCRecordHandler.this.ServiceType">ServiceType</span>, <a title="edu.berkeley.cs.scads.storage.MDCCMetadata" id="102730">aMeta</a>: <a href="../../Messages.scala.html#9668" title="edu.berkeley.cs.scads.storage.MDCCMetadata">MDCCMetadata</a>, <a title="edu.berkeley.cs.scads.storage.CStruct" id="102731">value</a>: <a href="../../Messages.scala.html#9674" title="edu.berkeley.cs.scads.storage.CStruct">CStruct</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#101981" title="=&gt; edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#102410" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PHASE1A">PHASE1A</a><span class="delimiter">)</span>
    <a href="MDCCMetaHelper.scala.html#95821" title="(metaL: edu.berkeley.cs.scads.storage.MDCCMetadata, metaR: edu.berkeley.cs.scads.storage.MDCCMetadata)Int">compareMetadata</a><span class="delimiter">(</span><a href="#102730" title="edu.berkeley.cs.scads.storage.MDCCMetadata">aMeta</a>, <a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]" class="int">0</span> =&gt;
        <span class="comment">//The storage node accepted the new meta data</span>
        <a href="#101987" title="=&gt; scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]">quorum</a> <span title="(elem: edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord])scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]">+=</span> <a href="#102729" title="MCCCRecordHandler.this.ServiceType">src</a>
      <span class="keyword">case</span> <span title="Unit" class="int">1</span> =&gt;
        <span class="comment">//We got an old message, we can ignore this case</span>
      <span class="keyword">case</span> <span title="Unit">-</span><span class="int">1</span>  | <span title="Int(-2)">-</span><span class="int">2</span> =&gt; <span class="delimiter">{</span>
        <span class="comment">//TODO We need to ensure progress while two nodes try to get the mastership</span>
        <span class="comment">//There was a new meta data version out there, so we try it again</span>
        <a href="#102316" title="(x$1: edu.berkeley.cs.scads.storage.MDCCMetadata)Unit">meta</a> = <a href="MDCCMetaHelper.scala.html#95813" title="(lMeta: edu.berkeley.cs.scads.storage.MDCCMetadata, rMeta: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.MDCCMetadata">combine</a><span class="delimiter">(</span><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a>, <a href="#102730" title="edu.berkeley.cs.scads.storage.MDCCMetadata">aMeta</a><span class="delimiter">)</span>
        <a href="#102008" title="()Unit">startPhase1a</a><span class="delimiter">(</span><span class="delimiter">)</span>  <span class="comment">//we start over</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <span class="comment">//should never happen</span>
    <span class="delimiter">}</span>
    <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#101987" title="=&gt; scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]">quorum</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#102006" title="=&gt; Int">classicQuorum</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">//only if we need to do an update we go on to Phase2a</span>
      <a href="#101984" title="=&gt; edu.berkeley.cs.scads.storage.MDCCProtocol">currentRequest</a> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>                <span class="comment">//why are we doing this</span>
        <span class="keyword">case</span> <a title="Unit" id="102851">x</a> : <a href="../../Messages.scala.html#9718" title="edu.berkeley.cs.scads.storage.BeMaster">BeMaster</a> =&gt; <span class="delimiter">{</span>
          <a href="#101996" title="=&gt; edu.berkeley.cs.scads.comm.RemoteService[org.apache.avro.generic.IndexedRecord]">source</a> <a href="#101998" title="(msg: org.apache.avro.generic.IndexedRecord)(implicit sender: edu.berkeley.cs.scads.comm.RemoteServiceProxy[org.apache.avro.generic.IndexedRecord])Unit">!</a> <a href="../../Messages.scala.html#28406" title="(ballots: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.GotMastership">GotMastership</a><span class="delimiter">(</span><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span>
          <a href="#101981" title="(x$1: edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus)Unit">status</a> = <a href="#102350" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.READY">READY</a>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <a title="List[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="102855">x</a> : <a href="../../Messages.scala.html#9724" title="edu.berkeley.cs.scads.storage.Propose">Propose</a> =&gt;  <a href="#102010" title="()List[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">startPhase2a</a>
        <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unallowed request&quot;)" class="string">&quot;Unallowed request&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">def</span> <a title="=&gt; Int" id="102006">classicQuorum</a> = <span title="(x: Double)Double">floor</span><span class="delimiter">(</span><a href="#102315" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="=&gt; Int">size</span>.<span title="=&gt; Double">toDouble</span> <span title="(x: Double)Double">/</span> <span title="Double(2.0)" class="double">2.0</span><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>
  @inline <span class="keyword">def</span> <a title="=&gt; Int" id="102007">fastQuorum</a> = <span title="(x: Double)Double">ceil</span><span class="delimiter">(</span><span title="Double(3.0)" class="double">3.0</span> <span title="(x: Double)Double">*</span> <a href="#102315" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="=&gt; Int">size</span>.<span title="=&gt; Double">toDouble</span> <span title="(x: Double)Double">/</span> <span title="Double(4.0)" class="double">4.0</span><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>




  <span class="keyword">def</span> <a title="()Unit" id="102008">startPhase1a</a><span class="delimiter">(</span><span class="delimiter">)</span> : <span title="Unit">Unit</span> =  <span class="delimiter">{</span>
    <a href="#101981" title="(x$1: edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus)Unit">status</a> = <a href="#102410" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PHASE1A">PHASE1A</a>
    <a href="#101984" title="=&gt; edu.berkeley.cs.scads.storage.MDCCProtocol">currentRequest</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>                <span class="comment">//why are we doing this</span>
      <span class="keyword">case</span> <span title="Unit">BeMaster</span><span class="delimiter">(</span><a title="Array[Byte]" id="102906">key</a>, <a title="Long" id="102907">startRound</a>, <a title="Long" id="102908">endRound</a>, <a title="Boolean" id="102909">fast</a> <span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#102316" title="(x$1: edu.berkeley.cs.scads.storage.MDCCMetadata)Unit">meta</a> = <a href="MDCCMetaHelper.scala.html#95812" title="(meta: edu.berkeley.cs.scads.storage.MDCCMetadata, startRound: Long, endRound: Long, fast: Boolean)(implicit r: edu.berkeley.cs.scads.storage.SCADSService)edu.berkeley.cs.scads.storage.MDCCMetadata">getOwnership</a><a href="#101998" title="=&gt; Null" class="delimiter">(</a><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a>, <a href="#102907" title="Long">startRound</a>, <a href="#102908" title="Long">endRound</a>, <a href="#102909" title="Boolean">fast</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <a title="Unit" id="102930">x</a> : <a href="../../Messages.scala.html#9724" title="edu.berkeley.cs.scads.storage.Propose">Propose</a> =&gt;
        <a href="#102316" title="(x$1: edu.berkeley.cs.scads.storage.MDCCMetadata)Unit">meta</a> = <a href="MDCCMetaHelper.scala.html#95812" title="(meta: edu.berkeley.cs.scads.storage.MDCCMetadata, startRound: Long, endRound: Long, fast: Boolean)(implicit r: edu.berkeley.cs.scads.storage.SCADSService)edu.berkeley.cs.scads.storage.MDCCMetadata">getOwnership</a><a href="#101998" title="=&gt; Null" class="delimiter">(</a><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a>, <a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a>.<a href="../../Messages.scala.html#26907" title="=&gt; Long">currentRound</a>, <a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a>.<a href="../../Messages.scala.html#26907" title="=&gt; Long">currentRound</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unallowed request&quot;)" class="string">&quot;Unallowed request&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.Phase1a" id="102905">phase1aMsg</a> = <a href="../../Messages.scala.html#28549" title="(key: Array[Byte], ballots: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.Phase1a">Phase1a</a><span class="delimiter">(</span><a href="#101993" title="=&gt; edu.berkeley.cs.scads.storage.RecordUpdate">update</a>.<a href="../../Messages.scala.html#27021" title="=&gt; Array[Byte]">key</a>, <a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span>
    <a href="#101987" title="=&gt; scala.collection.mutable.HashSet[MCCCRecordHandler.this.ServiceType]">quorum</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#101978" title="(x$1: Seq[edu.berkeley.cs.scads.storage.CStructCommand])Unit">value</a> = <span title="Null(null)" class="keyword">null</span>
    <a href="#102315" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; Unit)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.PartitionService],Unit,Any])Any">map</span><a href="#101998" title="=&gt; Null" class="delimiter">(</a><a href="#102977" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <a href="#101998" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)(implicit sender: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])Unit">!</a> <a href="#102905" title="edu.berkeley.cs.scads.storage.Phase1a">phase1aMsg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Any" id="102009">SendProposal</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.Propose" id="102620">propose</a> = <a href="../../Messages.scala.html#28472" title="(xid: edu.berkeley.cs.scads.storage.ScadsXid, update: edu.berkeley.cs.scads.storage.RecordUpdate)edu.berkeley.cs.scads.storage.Propose">Propose</a><span class="delimiter">(</span><a href="#101990" title="=&gt; edu.berkeley.cs.scads.storage.ScadsXid">Xid</a>, <a href="#101993" title="=&gt; edu.berkeley.cs.scads.storage.RecordUpdate">update</a><span class="delimiter">)</span>
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="MDCCMetaHelper.scala.html#95819" title="(meta: edu.berkeley.cs.scads.storage.MDCCMetadata)Boolean">fastRound</a><span class="delimiter">(</span><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">{</span>  <span class="comment">//If we have a fast round, we can propose directly</span>
      <a href="#101981" title="(x$1: edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus)Unit">status</a> = <a href="#102395" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.FAST_PROPOSED">FAST_PROPOSED</a>
      <a href="#102315" title="=&gt; Seq[edu.berkeley.cs.scads.storage.PartitionService]">servers</a>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionService =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#102641" title="edu.berkeley.cs.scads.storage.PartitionService">_</a> <a href="#101998" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)(implicit sender: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])Unit">!</a> <a href="#102620" title="edu.berkeley.cs.scads.storage.Propose">propose</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="keyword">else</span><span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.SCADSService" id="102647">master</a> = <a href="MDCCMetaHelper.scala.html#95820" title="(meta: edu.berkeley.cs.scads.storage.MDCCMetadata)edu.berkeley.cs.scads.storage.SCADSService">getMaster</a><span class="delimiter">(</span><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="MDCCMetaHelper.scala.html#95818" title="(meta: edu.berkeley.cs.scads.storage.MDCCMetadata)(implicit r: edu.berkeley.cs.scads.storage.SCADSService)Boolean">isMaster</a><a href="#101998" title="=&gt; Null" class="delimiter">(</a><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <a href="#101981" title="(x$1: edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus)Unit">status</a> = <a href="#102425" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PHASE2A">PHASE2A</a>
        <a href="#102010" title="()List[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">startPhase2a</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="keyword">else</span><span class="delimiter">{</span>
        <a href="#101981" title="(x$1: edu.berkeley.cs.scads.storage.transactions.mdcc.RecordStatus)Unit">status</a> = <a href="#102380" title="object edu.berkeley.cs.scads.storage.transactions.mdcc.PROPOSED">PROPOSED</a>
        <a href="#102647" title="edu.berkeley.cs.scads.storage.SCADSService">master</a> <a href="#101998" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)(implicit sender: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])Unit">!</a> <a href="#102620" title="edu.berkeley.cs.scads.storage.Propose">propose</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>



  <span class="keyword">def</span> <a title="()List[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]" id="102010">startPhase2a</a><span class="delimiter">(</span><span class="delimiter">)</span> : <span title="List[edu.berkeley.cs.scads.comm.MessageFuture[edu.berkeley.cs.scads.storage.StorageMessage]]">List</span><span class="delimiter">[</span>MessageFuture<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="MDCCMetaHelper.scala.html#95818" title="(meta: edu.berkeley.cs.scads.storage.MDCCMetadata)(implicit r: edu.berkeley.cs.scads.storage.SCADSService)Boolean">isMaster</a><a href="#101998" title="=&gt; Null" class="delimiter">(</a><a href="#102316" title="=&gt; edu.berkeley.cs.scads.storage.MDCCMetadata">meta</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">//Enabled if maxTried = [None]</span>
    <span class="comment">//leader received &quot;1b&quot; for balnom m from every acceptor in quorum</span>
    <span class="comment">// v = w add sigma, where sigma is element of Seq(propCmd ),</span>
    <span class="comment">// w element of ProvedSafe(Q; m; beta), and beta is any ballot array such that,</span>
    <span class="comment">// for every acceptor a in Q, beta_head_a = k and the leader has received a message (&quot;1b&quot;; m; a; p)</span>
    <span class="comment">// with beta_a = p</span>

    <span title="object Nil">Nil</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="102011">processAccept</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span title="Unit" class="delimiter">{</span>

  <span class="delimiter">}</span>


<span class="delimiter">}</span>

        </pre>
    </body>
</html>