<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>transactions/TxDB.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage.transactions

<span class="keyword">import</span> edu.berkeley.cs.avro.marker._

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.scads.util._

<span class="keyword">import</span> collection.mutable.ArrayBuffer

<span class="keyword">import</span> org.apache.avro._
<span class="keyword">import</span> generic._
<span class="keyword">import</span> io._
<span class="keyword">import</span> specific._

<span class="keyword">import</span> java.util.Comparator

<span class="keyword">import</span> com.sleepycat.je.<span class="delimiter">{</span>Cursor, Database, DatabaseConfig, CursorConfig,
                         DatabaseException, DatabaseEntry, Environment,
                         LockMode, OperationStatus, Durability, Transaction<span class="delimiter">}</span>

<span class="keyword">import</span> java.util.concurrent.TimeUnit

<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap

<span class="keyword">import</span> scala.concurrent.Lock
<span class="keyword">import</span> scala.collection.mutable.ListBuffer

<span class="keyword">import</span> java.nio._

<span class="comment">// Transactional db interface.</span>
<span class="comment">// The underlying store can be a hashmap (for testing) or a bdb instance.</span>
<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait TxDB[K &lt;: AnyRef, V &lt;: AnyRef] extends java.lang.Object with ScalaObject" id="10286">TxDB</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10287">K</a> &lt;: AnyRef, <a title="&gt;: Nothing &lt;: AnyRef" id="10288">V</a> &lt;: AnyRef<span class="delimiter">]</span> <span title="ScalaObject" class="delimiter">{</span>
  <span class="comment">// Put a (key, value) pair in the db and will overwrite values.  Returns true</span>
  <span class="comment">// if the value was stored successfully.</span>
  <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K, value: V)Boolean" id="74832">put</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="80703">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="80704">key</a>: <a href="#10287" title="K">K</a>, <a title="V" id="80705">value</a>: <a href="#10288" title="V">V</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span>

  <span class="comment">// Like put(), but only stores the value if the key does NOT exist already.</span>
  <span class="comment">// Returns true if the new value was stored successfully.</span>
  <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K, value: V)Boolean" id="74833">putNoOverwrite</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96269">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96270">key</a>: <a href="#10287" title="K">K</a>, <a title="V" id="96271">value</a>: <a href="#10288" title="V">V</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span>

  <span class="comment">// Removes the value for the key.</span>
  <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K)Boolean" id="74834">delete</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96273">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96274">key</a>: <a href="#10287" title="K">K</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span>

  <span class="comment">// Returns the value for the key.</span>
  <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K)Option[V]" id="74835">get</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="80698">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="80699">key</a>: <a href="#10287" title="K">K</a><span class="delimiter">)</span>: <span title="Option[V]">Option</span><span class="delimiter">[</span>V<span class="delimiter">]</span>

  <span class="comment">// Starts a transaction in the db.  Returns an object which must be passed</span>
  <span class="comment">// into other methods to be part of the transaction.</span>
  <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.storage.transactions.TransactionData" id="74836">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>

  <span class="comment">// Commit the transaction.</span>
  <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit" id="74837">txCommit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="80997">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a><span class="delimiter">)</span>

  <span class="comment">// Abort the transaction.  </span>
  <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit" id="74838">txAbort</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="81000">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()Unit" id="74839">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="74840">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span title="Unit" class="delimiter">{</span><span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="74841">getName</a><span class="delimiter">(</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">// Transaction data for the transactionactional dbs</span>
<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait TransactionData extends java.lang.Object" id="10289">TransactionData</a>
case <span class="keyword">class</span> <a title="class BDBTransactionData extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TransactionData with ScalaObject with Product with Serializable" id="97068">BDBTransactionData</a><a href="#97068" title="ScalaObject" class="delimiter">(</a><a title="com.sleepycat.je.Transaction" id="96623">tx</a>: <span title="com.sleepycat.je.Transaction">Transaction</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>
case <span class="keyword">class</span> <a title="class MapTransactionData extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TransactionData with ScalaObject with Product with Serializable" id="97064">MapTransactionData</a><a href="#97064" title="ScalaObject" class="delimiter">(</a><a title="scala.collection.mutable.ListBuffer[(Any, Any)]" id="96753">tx</a>: <span title="scala.collection.mutable.ListBuffer[(Any, Any)]">ListBuffer</span><span class="delimiter">[</span><span class="delimiter">(</span>Any, Any<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>

<span class="comment">// Factory for creating new transactional dbs.</span>
<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait TxDBFactory extends java.lang.Object" id="10296">TxDBFactory</a> <span title="java.lang.Object" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[K &lt;: AnyRef, V &lt;: AnyRef](name: String)edu.berkeley.cs.scads.storage.transactions.TxDB[K,V]" id="74881">getNewDB</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="74884">K</a> &lt;: AnyRef, <a title="&gt;: Nothing &lt;: AnyRef" id="74885">V</a> &lt;: AnyRef<span class="delimiter">]</span><span class="delimiter">(</span><a title="String" id="75768">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="#10286" title="edu.berkeley.cs.scads.storage.transactions.TxDB[K,V]">TxDB</a><span class="delimiter">[</span>K, V<span class="delimiter">]</span>
<span class="delimiter">}</span>

<span class="comment">// A factory for creating BDB transactional dbs.</span>
<span class="keyword">class</span> <a title="class BDBTxDBFactory extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TxDBFactory with ScalaObject" id="10297">BDBTxDBFactory</a><a href="#10297" title="ScalaObject" class="delimiter">(</a><a title="com.sleepycat.je.Environment" id="74894">env</a>: <span title="com.sleepycat.je.Environment">Environment</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#10296" title="edu.berkeley.cs.scads.storage.transactions.TxDBFactory">TxDBFactory</a> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="[K &lt;: AnyRef, V &lt;: AnyRef](name: String)edu.berkeley.cs.scads.storage.transactions.BDBTxDB[K,V]" id="74889">getNewDB</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="74892">K</a> &lt;: AnyRef, <a title="&gt;: Nothing &lt;: AnyRef" id="74893">V</a> &lt;: AnyRef<span class="delimiter">]</span><span class="delimiter">(</span><a title="String" id="96399">name</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseConfig" id="96402">dbConfig</a> = <span title="com.sleepycat.je.DatabaseConfig" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseConfig">DatabaseConfig</span>
    <a href="#96402" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setAllowCreate</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#96402" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setTransactional</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="96403">db</a> = <a href="#74894" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String, x$3: com.sleepycat.je.DatabaseConfig)com.sleepycat.je.Database">openDatabase</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#96399" title="String">name</a>, <a href="#96402" title="com.sleepycat.je.DatabaseConfig">dbConfig</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.transactions.BDBTxDB[K,V]" class="keyword">new</span> <a href="#10308" title="edu.berkeley.cs.scads.storage.transactions.BDBTxDB[K,V]">BDBTxDB</a><span class="delimiter">[</span>K, V<span class="delimiter">]</span><span class="delimiter">(</span><a href="#96403" title="com.sleepycat.je.Database">db</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">// A factory for creating hashmap transactional dbs.</span>
<span class="keyword">class</span> <a title="class MapTxDBFactory extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TxDBFactory with ScalaObject" id="10298">MapTxDBFactory</a> <a href="#10298" title="ScalaObject" class="keyword">extends</a> <a href="#10296" title="edu.berkeley.cs.scads.storage.transactions.TxDBFactory">TxDBFactory</a> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="[K &lt;: AnyRef, V &lt;: AnyRef](name: String)edu.berkeley.cs.scads.storage.transactions.MapTxDB[K,V]" id="96405">getNewDB</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="96408">K</a> &lt;: AnyRef, <a title="&gt;: Nothing &lt;: AnyRef" id="96409">V</a> &lt;: AnyRef<span class="delimiter">]</span><span class="delimiter">(</span><a title="String" id="96411">name</a>: <span title="String">String</span><span class="delimiter">)</span> =
    <span title="edu.berkeley.cs.scads.storage.transactions.MapTxDB[K,V]" class="keyword">new</span> <a href="#10311" title="edu.berkeley.cs.scads.storage.transactions.MapTxDB[K,V]">MapTxDB</a><span class="delimiter">[</span>K, V<span class="delimiter">]</span><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]" class="keyword">new</span> <a href="#10314" title="edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">ByteArrayHashMap</a><span class="delimiter">[</span>K, V<span class="delimiter">]</span>, <a href="#96411" title="String">name</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">// Default serializer which just uses java streams.</span>
<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait TxRecordSerializer extends java.lang.Object with ScalaObject" id="10299">TxRecordSerializer</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T &lt;: AnyRef](v: T)Array[Byte]" id="74862">toBytes</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="74864">T</a> &lt;: AnyRef<span class="delimiter">]</span><span class="delimiter">(</span><a title="T" id="96446">v</a>: <a href="#74864" title="T">T</a><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#96446" title="T">v</a> <span title="Array[Byte]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Array[Byte]" id="96449">x</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> =&gt; <a href="#96449" title="Array[Byte]">x</a>
      <span class="keyword">case</span> <span title="Array[Byte]">_</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.ByteArrayOutputStream" id="96450">baos</a> = <span title="java.io.ByteArrayOutputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayOutputStream">ByteArrayOutputStream</span>
        <span class="keyword">val</span> <a title="java.io.ObjectOutputStream" id="96451">oos</a> = <span title="java.io.ObjectOutputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectOutputStream">ObjectOutputStream</span><span class="delimiter">(</span><a href="#96450" title="java.io.ByteArrayOutputStream">baos</a><span class="delimiter">)</span>
        <a href="#96451" title="java.io.ObjectOutputStream">oos</a>.<span title="(x$1: Any)Unit">writeObject</span><span class="delimiter">(</span><a href="#96446" title="T">v</a><span class="delimiter">)</span>
        <a href="#96450" title="java.io.ByteArrayOutputStream">baos</a>.<span title="()Array[Byte]">toByteArray</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="[T &lt;: AnyRef](b: Array[Byte])T" id="74865">fromBytes</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="74867">T</a> &lt;: AnyRef<span class="delimiter">]</span><span class="delimiter">(</span><a title="Array[Byte]" id="96456">b</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#74867" title="T">T</a> = <span class="delimiter">{</span>
    <span class="comment">// TODO: better way to do this?  common case is slow...</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <span class="comment">// Try converting first</span>
      <span class="keyword">val</span> <a title="java.io.ByteArrayInputStream" id="96458">bais</a> = <span title="java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#96456" title="Array[Byte]">b</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.io.ObjectInputStream" id="96459">ois</a> = <span title="java.io.ObjectInputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectInputStream">ObjectInputStream</span><span class="delimiter">(</span><a href="#96458" title="java.io.ByteArrayInputStream">bais</a><span class="delimiter">)</span>
      <a href="#96459" title="java.io.ObjectInputStream">ois</a>.<span title="()java.lang.Object">readObject</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="T" class="delimiter">[</span><a href="#74867" title="T">T</a><span class="delimiter">]</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="T">_</span> =&gt; <span class="delimiter">{</span> 
        <span class="comment">// Fall back to casting it to byte array. Hopefully T is Array[Byte]?</span>
        <a href="#96456" title="Array[Byte]">b</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="T" class="delimiter">[</span><a href="#74867" title="T">T</a><span class="delimiter">]</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait KeySerializer[T &lt;: AnyRef] extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TxRecordSerializer with ScalaObject" id="10300">KeySerializer</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10301">T</a> &lt;: AnyRef<span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="#10299" title="edu.berkeley.cs.scads.storage.transactions.TxRecordSerializer">TxRecordSerializer</a> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(k: T)Array[Byte]" id="74869">keyToBytes</a><span class="delimiter">(</span><a title="T" id="96465">k</a>: <a href="#10301" title="T">T</a><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#74862" title="[T &lt;: AnyRef](v: T)Array[Byte]">toBytes</a><span title="(v: T)Array[Byte]" class="delimiter">[</span><a href="#10301" title="T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#96465" title="T">k</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="(b: Array[Byte])T" id="74870">keyFromBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="96468">b</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#10301" title="T">T</a> = <span class="delimiter">{</span>
    <a href="#74865" title="[T &lt;: AnyRef](b: Array[Byte])T">fromBytes</a><span title="(b: Array[Byte])T" class="delimiter">[</span><a href="#10301" title="T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#96468" title="Array[Byte]">b</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
<span class="keyword">sealed</span> <span class="keyword">trait</span> <a title="trait ValueSerializer[T &lt;: AnyRef] extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TxRecordSerializer with ScalaObject" id="10302">ValueSerializer</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10303">T</a> &lt;: AnyRef<span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="#10299" title="edu.berkeley.cs.scads.storage.transactions.TxRecordSerializer">TxRecordSerializer</a> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(v: T)Array[Byte]" id="74875">valueToBytes</a><span class="delimiter">(</span><a title="T" id="96472">v</a>: <a href="#10303" title="T">T</a><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#74862" title="[T &lt;: AnyRef](v: T)Array[Byte]">toBytes</a><span title="(v: T)Array[Byte]" class="delimiter">[</span><a href="#10303" title="T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#96472" title="T">v</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="(b: Array[Byte])T" id="74876">valueFromBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="96475">b</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#10303" title="T">T</a> = <span class="delimiter">{</span>
    <a href="#74865" title="[T &lt;: AnyRef](b: Array[Byte])T">fromBytes</a><span title="(b: Array[Byte])T" class="delimiter">[</span><a href="#10303" title="T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#96475" title="Array[Byte]">b</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">// Array[Byte] versions for better performance.</span>
<span class="comment">// Any way to check/force T to be Array[Byte]???</span>
<span class="keyword">trait</span> <a title="trait ByteArrayKeySerializer[T &lt;: AnyRef] extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.KeySerializer[T] with ScalaObject" id="10304">ByteArrayKeySerializer</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10305">T</a> &lt;: AnyRef<span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="#10300" title="edu.berkeley.cs.scads.storage.transactions.KeySerializer[T]">KeySerializer</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(k: T)Array[Byte]" id="74872">keyToBytes</a><span class="delimiter">(</span><a title="T" id="96479">k</a>: <a href="#10305" title="T">T</a><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#96479" title="T">k</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(b: Array[Byte])T" id="74873">keyFromBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="96482">b</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#10305" title="T">T</a> = <span class="delimiter">{</span>
    <a href="#96482" title="Array[Byte]">b</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="T" class="delimiter">[</span><a href="#10305" title="T">T</a><span class="delimiter">]</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
<span class="keyword">trait</span> <a title="trait ByteArrayValueSerializer[T &lt;: AnyRef] extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.ValueSerializer[T] with ScalaObject" id="10306">ByteArrayValueSerializer</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10307">T</a> &lt;: AnyRef<span class="delimiter">]</span> <span title="ScalaObject" class="keyword">extends</span> <a href="#10302" title="edu.berkeley.cs.scads.storage.transactions.ValueSerializer[T]">ValueSerializer</a><span class="delimiter">[</span>T<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(v: T)Array[Byte]" id="74878">valueToBytes</a><span class="delimiter">(</span><a title="T" id="96486">v</a>: <a href="#10307" title="T">T</a><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#96486" title="T">v</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(b: Array[Byte])T" id="74879">valueFromBytes</a><span class="delimiter">(</span><a title="Array[Byte]" id="96489">b</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#10307" title="T">T</a> = <span class="delimiter">{</span>
    <a href="#96489" title="Array[Byte]">b</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="T" class="delimiter">[</span><a href="#10307" title="T">T</a><span class="delimiter">]</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">// Transactional db using BDB as the underlying store.</span>
<span class="keyword">class</span> <a title="class BDBTxDB[K &lt;: AnyRef, V &lt;: AnyRef] extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TxDB[K,V] with edu.berkeley.cs.scads.storage.transactions.KeySerializer[K] with edu.berkeley.cs.scads.storage.transactions.ValueSerializer[V] with ScalaObject" id="10308">BDBTxDB</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10309">K</a> &lt;: AnyRef, <a title="&gt;: Nothing &lt;: AnyRef" id="10310">V</a> &lt;: AnyRef<span class="delimiter">]</span><a href="#10308" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="74880">db</a>: <span title="com.sleepycat.je.Database">Database</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#10286" title="edu.berkeley.cs.scads.storage.transactions.TxDB[K,V]">TxDB</a><span class="delimiter">[</span>K, V<span class="delimiter">]</span> <span class="keyword">with</span> <a href="#10300" title="edu.berkeley.cs.scads.storage.transactions.KeySerializer[K]">KeySerializer</a><span class="delimiter">[</span>K<span class="delimiter">]</span> <span class="keyword">with</span> <a href="#10302" title="edu.berkeley.cs.scads.storage.transactions.ValueSerializer[V]">ValueSerializer</a><span class="delimiter">[</span>V<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)com.sleepycat.je.Transaction" id="74848">getTransaction</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96493">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="String" id="96494">msg</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Transaction">Transaction</span> = <span class="delimiter">{</span>
    <a href="#96493" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a> <span title="com.sleepycat.je.Transaction" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.Transaction">BDBTransactionData</span><span class="delimiter">(</span><a title="com.sleepycat.je.Transaction" id="96496">txn</a><span class="delimiter">)</span> =&gt; <a href="#96496" title="com.sleepycat.je.Transaction">txn</a>
      <span class="keyword">case</span> <span title="Null(null)" class="keyword">null</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;wrong transaction type: &quot;)" class="string">&quot;wrong transaction type: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#96494" title="String">msg</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K, value: V)Boolean" id="74849">put</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96501">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96502">key</a>: <a href="#10309" title="K">K</a>, <a title="V" id="96503">value</a>: <a href="#10310" title="V">V</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span> 
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="96508">txn</a> = <a href="#74848" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)com.sleepycat.je.Transaction">getTransaction</a><span class="delimiter">(</span><a href="#96501" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;BDB.put()&quot;)" class="string">&quot;BDB.put()&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a href="#96510" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#96509" title="com.sleepycat.je.DatabaseEntry" id="96510">dbeKey</a>, <a href="#96509" title="com.sleepycat.je.DatabaseEntry" id="96511">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74869" title="(k: K)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#96502" title="K">key</a><span class="delimiter">)</span><span class="delimiter">)</span>,
                              <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74875" title="(v: V)Array[Byte]">valueToBytes</a><span class="delimiter">(</span><a href="#96503" title="V">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.OperationStatus" id="96512">opStatus</a> = <a href="#74880" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#96508" title="com.sleepycat.je.Transaction">txn</a>, <a href="#96510" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#96511" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
    <span class="delimiter">(</span><a href="#96512" title="com.sleepycat.je.OperationStatus">opStatus</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K, value: V)Boolean" id="74850">putNoOverwrite</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96539">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>,
                              <a title="K" id="96540">key</a>: <a href="#10309" title="K">K</a>, <a title="V" id="96541">value</a>: <a href="#10310" title="V">V</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="96546">txn</a> = <a href="#74848" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)com.sleepycat.je.Transaction">getTransaction</a><span class="delimiter">(</span><a href="#96539" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;BDB.putNoOverWrite()&quot;)" class="string">&quot;BDB.putNoOverWrite()&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a href="#96548" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#96547" title="com.sleepycat.je.DatabaseEntry" id="96548">dbeKey</a>, <a href="#96547" title="com.sleepycat.je.DatabaseEntry" id="96549">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74869" title="(k: K)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#96540" title="K">key</a><span class="delimiter">)</span><span class="delimiter">)</span>,
                              <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74875" title="(v: V)Array[Byte]">valueToBytes</a><span class="delimiter">(</span><a href="#96541" title="V">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.OperationStatus" id="96550">opStatus</a> = <a href="#74880" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">putNoOverwrite</span><span class="delimiter">(</span><a href="#96546" title="com.sleepycat.je.Transaction">txn</a>, <a href="#96548" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#96549" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
    <span class="delimiter">(</span><a href="#96550" title="com.sleepycat.je.OperationStatus">opStatus</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K)Boolean" id="74851">delete</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96575">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96576">key</a>: <a href="#10309" title="K">K</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="96580">txn</a> = <a href="#74848" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)com.sleepycat.je.Transaction">getTransaction</a><span class="delimiter">(</span><a href="#96575" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;BDB.delete()&quot;)" class="string">&quot;BDB.delete()&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="96581">dbeKey</a> = <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74869" title="(k: K)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#96576" title="K">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#74880" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#96580" title="com.sleepycat.je.Transaction">txn</a>, <a href="#96581" title="com.sleepycat.je.DatabaseEntry">dbeKey</a><span class="delimiter">)</span>
    <span title="Boolean(true)" class="keyword">true</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K)Option[V]" id="74852">get</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96584">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96585">key</a>: <a href="#10309" title="K">K</a><span class="delimiter">)</span>: <span title="Option[V]">Option</span><span class="delimiter">[</span>V<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="96589">txn</a> = <a href="#74848" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)com.sleepycat.je.Transaction">getTransaction</a><span class="delimiter">(</span><a href="#96584" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;BDB.get()&quot;)" class="string">&quot;BDB.get()&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a href="#96591" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#96590" title="com.sleepycat.je.DatabaseEntry" id="96591">dbeKey</a>, <a href="#96590" title="com.sleepycat.je.DatabaseEntry" id="96592">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74869" title="(k: K)Array[Byte]">keyToBytes</a><span class="delimiter">(</span><a href="#96585" title="K">key</a><span class="delimiter">)</span><span class="delimiter">)</span>,
                              <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.OperationStatus" id="96593">opStatus</a> = <a href="#74880" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry, x$4: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">get</span><span class="delimiter">(</span><a href="#96589" title="com.sleepycat.je.Transaction">txn</a>, <a href="#96591" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#96592" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, LockMode.<span title="com.sleepycat.je.LockMode(value READ_COMMITTED)">READ_COMMITTED</span><span class="delimiter">)</span>
    <span title="Option[V]" class="keyword">if</span> <span class="delimiter">(</span><a href="#96593" title="com.sleepycat.je.OperationStatus">opStatus</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// Record found in db</span>
      <span title="(x: V)Some[V]">Some</span><span class="delimiter">(</span><a href="#74876" title="(b: Array[Byte])V">valueFromBytes</a><span class="delimiter">(</span><a href="#96592" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="object None">None</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.storage.transactions.BDBTransactionData" id="74853">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#97068" title="(tx: com.sleepycat.je.Transaction)edu.berkeley.cs.scads.storage.transactions.BDBTransactionData">BDBTransactionData</a><span class="delimiter">(</span><a href="#74880" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit" id="74854">txCommit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96627">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a><span class="delimiter">)</span> <span class="delimiter">{</span> 
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="96629">txn</a> = <a href="#74848" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)com.sleepycat.je.Transaction">getTransaction</a><span class="delimiter">(</span><a href="#96627" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;BDB.txCommit()&quot;)" class="string">&quot;BDB.txCommit()&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#96629" title="com.sleepycat.je.Transaction">txn</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#96629" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit" id="74855">txAbort</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96636">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="96638">txn</a> = <a href="#74848" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)com.sleepycat.je.Transaction">getTransaction</a><span class="delimiter">(</span><a href="#96636" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;BDB.txAbort()&quot;)" class="string">&quot;BDB.txAbort()&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#96638" title="com.sleepycat.je.Transaction">txn</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#96638" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">abort</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="74856">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#74880" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="74857">getName</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#74880" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()java.lang.String">getDatabaseName</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">// Transactional db using a hashmap as the underlying store.</span>
<span class="keyword">class</span> <a title="class MapTxDB[K &lt;: AnyRef, V &lt;: AnyRef] extends java.lang.Object with edu.berkeley.cs.scads.storage.transactions.TxDB[K,V] with ScalaObject" id="10311">MapTxDB</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10312">K</a> &lt;: AnyRef, <a title="&gt;: Nothing &lt;: AnyRef" id="10313">V</a> &lt;: AnyRef<span class="delimiter">]</span><a href="#10311" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]" id="96432">map</a>: <a href="#10314" title="edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">ByteArrayHashMap</a><span class="delimiter">[</span>K, V<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="String" id="96433">name</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#10286" title="edu.berkeley.cs.scads.storage.transactions.TxDB[K,V]">TxDB</a><span class="delimiter">[</span>K, V<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.concurrent.Lock" id="96421">lock</a> = <span title="scala.concurrent.Lock" class="keyword">new</span> <span title="scala.concurrent.Lock">Lock</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)scala.collection.mutable.ListBuffer[(Any, Any)]" id="96423">getTransaction</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96657">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="String" id="96658">msg</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="scala.collection.mutable.ListBuffer[(Any, Any)]">ListBuffer</span><span class="delimiter">[</span><span class="delimiter">(</span>Any, Any<span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#96657" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a> <span title="scala.collection.mutable.ListBuffer[(Any, Any)]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="scala.collection.mutable.ListBuffer[(Any, Any)]">MapTransactionData</span><span class="delimiter">(</span><a title="scala.collection.mutable.ListBuffer[(Any, Any)]" id="96660">txn</a><span class="delimiter">)</span> =&gt; <a href="#96660" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a>
      <span class="keyword">case</span> <span title="Null(null)" class="keyword">null</span> =&gt; <span title="Null(null)" class="keyword">null</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;wrong transaction type: &quot;)" class="string">&quot;wrong transaction type: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#96658" title="String">msg</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K, value: V)Boolean" id="96424">put</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96665">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96666">key</a>: <a href="#10312" title="K">K</a>, <a title="V" id="96667">value</a>: <a href="#10313" title="V">V</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[(Any, Any)]" id="96672">txn</a> = <a href="#96423" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)scala.collection.mutable.ListBuffer[(Any, Any)]">getTransaction</a><span class="delimiter">(</span><a href="#96665" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;Map.put()&quot;)" class="string">&quot;Map.put()&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="V" id="96673">oldVal</a> = <a href="#96432" title="=&gt; edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">map</a>.<a href="#96440" title="(key: K, value: V)V">put</a><span class="delimiter">(</span><a href="#96666" title="K">key</a>, <a href="#96667" title="V">value</a><span class="delimiter">)</span> 
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#96672" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#96672" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a>.<span title="(elems: (Any, Any)*)Unit">append</span><span class="delimiter">(</span><span title="(_1: K, _2: V)(K, V)" class="delimiter">(</span><a href="#96666" title="K">key</a>, <a href="#96673" title="V">oldVal</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Boolean(true)" class="keyword">true</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K, value: V)Boolean" id="96425">putNoOverwrite</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96690">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96691">key</a>: <a href="#10312" title="K">K</a>, <a title="V" id="96692">value</a>: <a href="#10313" title="V">V</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[(Any, Any)]" id="96697">txn</a> = <a href="#96423" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)scala.collection.mutable.ListBuffer[(Any, Any)]">getTransaction</a><span class="delimiter">(</span><a href="#96690" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;Map.putNoOverwrite()&quot;)" class="string">&quot;Map.putNoOverwrite()&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="V" id="96698">oldVal</a> = <a href="#96432" title="=&gt; edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">map</a>.<a href="#96441" title="(key: K, value: V)V">putIfAbsent</a><span class="delimiter">(</span><a href="#96691" title="K">key</a>, <a href="#96692" title="V">value</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#96697" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#96697" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a>.<span title="(elems: (Any, Any)*)Unit">append</span><span class="delimiter">(</span><span title="(_1: K, _2: V)(K, V)" class="delimiter">(</span><a href="#96691" title="K">key</a>, <a href="#96698" title="V">oldVal</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="delimiter">(</span><a href="#96698" title="V">oldVal</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K)Boolean" id="96426">delete</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96719">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96720">key</a>: <a href="#10312" title="K">K</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[(Any, Any)]" id="96724">txn</a> = <a href="#96423" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)scala.collection.mutable.ListBuffer[(Any, Any)]">getTransaction</a><span class="delimiter">(</span><a href="#96719" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;Map.delete()&quot;)" class="string">&quot;Map.delete()&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="V" id="96725">oldVal</a> = <a href="#96432" title="=&gt; edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">map</a>.<a href="#96442" title="(key: K)V">remove</a><span class="delimiter">(</span><a href="#96720" title="K">key</a><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#96724" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#96724" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a>.<span title="(elems: (Any, Any)*)Unit">append</span><span class="delimiter">(</span><span title="(_1: K, _2: V)(K, V)" class="delimiter">(</span><a href="#96720" title="K">key</a>, <a href="#96725" title="V">oldVal</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Boolean(true)" class="keyword">true</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, key: K)Option[V]" id="96427">get</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96740">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a>, <a title="K" id="96741">key</a>: <a href="#10312" title="K">K</a><span class="delimiter">)</span>: <span title="Option[V]">Option</span><span class="delimiter">[</span>V<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span title="(x: V)Option[V]">Option</span><span class="delimiter">(</span><a href="#96432" title="=&gt; edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">map</a>.<a href="#96443" title="(key: K)V">get</a><span class="delimiter">(</span><a href="#96741" title="K">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.storage.transactions.MapTransactionData" id="96428">txStart</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// For transactional map access, just lock the entire structure.</span>
    <span class="comment">// TODO: If locking entire map is a bottle neck, implement better</span>
    <span class="comment">//       transactional system?</span>
    <a href="#96421" title="=&gt; scala.concurrent.Lock">lock</a>.<span title="()Unit">acquire</span>
    <a href="#97064" title="(tx: scala.collection.mutable.ListBuffer[(Any, Any)])edu.berkeley.cs.scads.storage.transactions.MapTransactionData">MapTransactionData</a><span class="delimiter">(</span><span title="scala.collection.mutable.ListBuffer[(Any, Any)]" class="keyword">new</span> <span title="scala.collection.mutable.ListBuffer[(Any, Any)]">ListBuffer</span><span class="delimiter">[</span><span class="delimiter">(</span>Any, Any<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit" id="96429">txCommit</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96757">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#96421" title="=&gt; scala.concurrent.Lock">lock</a>.<span title="()Unit">release</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[(Any, Any)]" id="96759">txn</a> = <a href="#96423" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)scala.collection.mutable.ListBuffer[(Any, Any)]">getTransaction</a><span class="delimiter">(</span><a href="#96757" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;Map.txComit()&quot;)" class="string">&quot;Map.txComit()&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#96759" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#96759" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a>.<span title="()Unit">clear</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData)Unit" id="96430">txAbort</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.transactions.TransactionData" id="96764">tx</a>: <a href="#10289" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">TransactionData</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[(Any, Any)]" id="96766">txn</a> = <a href="#96423" title="(tx: edu.berkeley.cs.scads.storage.transactions.TransactionData, msg: String)scala.collection.mutable.ListBuffer[(Any, Any)]">getTransaction</a><span class="delimiter">(</span><a href="#96764" title="edu.berkeley.cs.scads.storage.transactions.TransactionData">tx</a>, <span title="java.lang.String(&quot;Map.txAbort()&quot;)" class="string">&quot;Map.txAbort()&quot;</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#96766" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// Undo the changes</span>
      <a href="#96766" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a>.<span title="(f: (Any, Any) =&gt; Any)Unit">foreach</span><span class="delimiter">(</span><a title="(Any, Any)" id="96799">x</a> =&gt; <a href="#96799" title="(Any, Any)">x</a> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="V" class="delimiter">(</span><a title="K" id="96802">k</a>: <a href="#10312" title="K">K</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> =&gt; <a href="#96432" title="=&gt; edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">map</a>.<a href="#96442" title="(key: K)V">remove</a><span class="delimiter">(</span><a href="#96802" title="K">k</a><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="V" class="delimiter">(</span><a title="K" id="96805">k</a>: <a href="#10312" title="K">K</a>, <a title="V" id="96806">v</a>: <a href="#10313" title="V">V</a><span class="delimiter">)</span> =&gt; <a href="#96432" title="=&gt; edu.berkeley.cs.scads.storage.transactions.ByteArrayHashMap[K,V]">map</a>.<a href="#96440" title="(key: K, value: V)V">put</a><span class="delimiter">(</span><a href="#96805" title="K">k</a>, <a href="#96806" title="V">v</a><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>_, _<span class="delimiter">)</span> =&gt; <span class="comment">// this is the wrong format</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <a href="#96766" title="scala.collection.mutable.ListBuffer[(Any, Any)]">txn</a>.<span title="()Unit">clear</span>
    <span class="delimiter">}</span>
    <a href="#96421" title="=&gt; scala.concurrent.Lock">lock</a>.<span title="()Unit">release</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="96431">getName</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#96433" title="=&gt; String">name</a>
<span class="delimiter">}</span>

<span class="comment">// This is like ConcurrentHashMap, but automatically converts keys of type</span>
<span class="comment">// Array[Byte] to List[Byte], in order for hashCode() and equals() to work as</span>
<span class="comment">// expected.</span>
<span class="keyword">class</span> <a title="class ByteArrayHashMap[K, V] extends java.lang.Object with ScalaObject" id="10314">ByteArrayHashMap</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="10315">K</a>, <a title="&gt;: Nothing &lt;: Any" id="10316">V</a><span class="delimiter">]</span> <a href="#10314" title="ScalaObject" class="delimiter">{</a>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Any,V]" id="96437">map</a> = <span title="()java.util.concurrent.ConcurrentHashMap[Any,V]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Any,V]">ConcurrentHashMap</span><span class="delimiter">[</span>Any, V<span class="delimiter">]</span>

  <span class="comment">// Converts Array[Byte] to List[Byte] for better equals() and hashCode().</span>
  <span class="comment">// Other types are unchanged.</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: K)Any" id="96439">convertKey</a><span class="delimiter">(</span><a title="K" id="96925">key</a>: <a href="#10315" title="K">K</a><span class="delimiter">)</span>: <span title="Any">Any</span> = <span class="delimiter">{</span>
    <a href="#96925" title="K">key</a> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="List[Byte]" id="96927">x</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> =&gt; <a href="#96927" title="implicit scala.Predef.byteArrayOps : (xs: Array[Byte])scala.collection.mutable.ArrayOps[Byte]">x</a>.<span title="=&gt; List[Byte]">toList</span>
      <span class="keyword">case</span> <span title="K">_</span> =&gt; <a href="#96925" title="K">key</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// ConcurrentHashMap-like method wrappers to convert the key.</span>
  <span class="keyword">def</span> <a title="(key: K, value: V)V" id="96440">put</a><span class="delimiter">(</span><a title="K" id="96674">key</a>: <a href="#10315" title="K">K</a>, <a title="V" id="96675">value</a>: <a href="#10316" title="V">V</a><span class="delimiter">)</span>: <a href="#10316" title="V">V</a> = <span class="delimiter">{</span>
    <a href="#96437" title="=&gt; java.util.concurrent.ConcurrentHashMap[Any,V]">map</a>.<span title="(x$1: Any, x$2: V)V">put</span><span class="delimiter">(</span><a href="#96439" title="(key: K)Any">convertKey</a><span class="delimiter">(</span><a href="#96674" title="K">key</a><span class="delimiter">)</span>, <a href="#96675" title="V">value</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="(key: K, value: V)V" id="96441">putIfAbsent</a><span class="delimiter">(</span><a title="K" id="96699">key</a>: <a href="#10315" title="K">K</a>, <a title="V" id="96700">value</a>: <a href="#10316" title="V">V</a><span class="delimiter">)</span>: <a href="#10316" title="V">V</a> = <span class="delimiter">{</span>
    <a href="#96437" title="=&gt; java.util.concurrent.ConcurrentHashMap[Any,V]">map</a>.<span title="(x$1: Any, x$2: V)V">putIfAbsent</span><span class="delimiter">(</span><a href="#96439" title="(key: K)Any">convertKey</a><span class="delimiter">(</span><a href="#96699" title="K">key</a><span class="delimiter">)</span>, <a href="#96700" title="V">value</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="(key: K)V" id="96442">remove</a><span class="delimiter">(</span><a title="K" id="96726">key</a>: <a href="#10315" title="K">K</a><span class="delimiter">)</span>: <a href="#10316" title="V">V</a> = <span class="delimiter">{</span>
    <a href="#96437" title="=&gt; java.util.concurrent.ConcurrentHashMap[Any,V]">map</a>.<span title="(x$1: Any)V">remove</span><span class="delimiter">(</span><a href="#96439" title="(key: K)Any">convertKey</a><span class="delimiter">(</span><a href="#96726" title="K">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="(key: K)V" id="96443">get</a><span class="delimiter">(</span><a title="K" id="96747">key</a>: <a href="#10315" title="K">K</a><span class="delimiter">)</span>: <a href="#10316" title="V">V</a> = <span class="delimiter">{</span>
    <a href="#96437" title="=&gt; java.util.concurrent.ConcurrentHashMap[Any,V]">map</a>.<span title="(x$1: Any)V">get</span><span class="delimiter">(</span><a href="#96439" title="(key: K)Any">convertKey</a><span class="delimiter">(</span><a href="#96747" title="K">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>