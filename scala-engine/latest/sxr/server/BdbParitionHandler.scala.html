<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>server/BdbParitionHandler.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> com.sleepycat.je.<span class="delimiter">{</span>Cursor,Database, DatabaseConfig, CursorConfig, DatabaseException, DatabaseEntry, Environment, LockMode, OperationStatus, Durability, Transaction<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.scads.config._
<span class="keyword">import</span> edu.berkeley.cs.scads.util._

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> scala.util.control.Breaks

<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>
<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span> Future =&gt; JFuture, _ <span class="delimiter">}</span>
<span class="keyword">import</span> java.lang.reflect.Method
<span class="keyword">import</span> java.io.<span class="delimiter">{</span>BufferedReader,ObjectInputStream,InputStreamReader,ByteArrayInputStream<span class="delimiter">}</span>
<span class="keyword">import</span> atomic._

<span class="keyword">import</span> edu.berkeley.cs.avro.runtime.ScalaSpecificRecord



<span class="comment">/**
 * Handles a partition from [startKey, endKey). Refuses to service any
 * requests which fall out of this range, by returning a ProcessingException
 */</span>
<span class="keyword">class</span> <a title="class BdbStorageManager extends java.lang.Object with edu.berkeley.cs.scads.storage.StorageManager with edu.berkeley.cs.scads.storage.AvroComparator with ScalaObject" id="10007">BdbStorageManager</a><a href="#10007" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="71812">db</a>: <span title="com.sleepycat.je.Database">Database</span>, 
                        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="71813">partitionIdLock</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, 
                        <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="71814">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                        <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="71815">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="71816">nsRoot</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, 
                        <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="71817">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="org.apache.avro.Schema" id="71818">valueSchema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> 
                       <span class="keyword">extends</span> <a href="PartitionHandler.scala.html#10058" title="edu.berkeley.cs.scads.storage.StorageManager">StorageManager</a>
                       <span class="keyword">with</span>    <a href="server/KeyComparison.scala.html#10091" title="edu.berkeley.cs.scads.storage.AvroComparator">AvroComparator</a> <span class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="68550">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.configgy.Config" id="68552">config</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.FutureBasedIterator" id="68555">copyIteratorCtor</a> = 
    <a href="#68552" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String)Option[String]">getString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.storage.copy.iteratorType&quot;)" class="string">&quot;scads.storage.copy.iteratorType&quot;</span><span class="delimiter">)</span>.<span title="(f: String =&gt; Option[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.FutureBasedIterator])Option[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.FutureBasedIterator]">flatMap</span><span class="delimiter">(</span><a title="String" id="69761">tpe</a> =&gt; <a href="#69761" title="String">tpe</a>.<span title="()java.lang.String">toLowerCase</span> <span title="Option[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.FutureBasedIterator]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator]" class="string">&quot;cursor&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator)Some[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <a href="../Messages.scala.html#9559" title="edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <span title="edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#10042" title="edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator">CursorBasedPartitionIterator</a><span class="delimiter">(</span><a href="#69835" title="edu.berkeley.cs.scads.storage.PartitionService">ps</a>, <a href="#69836" title="Option[Array[Byte]]">minKey</a>, <a href="#69837" title="Option[Array[Byte]]">maxKey</a>, <a href="#68556" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator]" class="string">&quot;actorfree&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator)Some[(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <a href="../Messages.scala.html#9559" title="edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <span title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#10039" title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator">ActorlessPartitionIterator</a><span class="delimiter">(</span><a href="#69868" title="edu.berkeley.cs.scads.storage.PartitionService">ps</a>, <a href="#69869" title="Option[Array[Byte]]">minKey</a>, <a href="#69870" title="Option[Array[Byte]]">maxKey</a>, <a href="#68556" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="None.type" id="69872">invalid</a> =&gt; 
        <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;copy iterator type %s is invalid&quot;)" class="string">&quot;copy iterator type %s is invalid&quot;</span>, <a href="#69872" title="java.lang.String">invalid</a><span class="delimiter">)</span>
        <span title="object None">None</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(default: =&gt; (edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.FutureBasedIterator)(edu.berkeley.cs.scads.storage.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.FutureBasedIterator">getOrElse</span><span class="delimiter">(</span><span class="delimiter">{</span>
        <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Using standard ActorlessPartitionIterator&quot;)" class="string">&quot;Using standard ActorlessPartitionIterator&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">(</span>ps: <a href="../Messages.scala.html#9559" title="edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
          <span title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#10039" title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator">ActorlessPartitionIterator</a><span class="delimiter">(</span><a href="#70430" title="edu.berkeley.cs.scads.storage.PartitionService">ps</a>, <a href="#70431" title="Option[Array[Byte]]">minKey</a>, <a href="#70432" title="Option[Array[Byte]]">maxKey</a>, <a href="#68556" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Int" id="68557">copyRecsPerMessage</a> = <a href="#68552" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String, defaultValue: Int)Int">getInt</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.storage.copy.recsPerMessage&quot;)" class="string">&quot;scads.storage.copy.recsPerMessage&quot;</span>, <span title="Int(8192)" class="int">8192</span><span class="delimiter">)</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="68558">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="68560">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="68970">a</a>: <a href="#68560" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#68970" title="A">a</a><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="Int" id="68561">cursorTimeout</a> = <span class="int">3</span> * <span class="int">60</span> <span title="Int(180000)">*</span> <span class="int">1000</span> <span class="comment">// 3 minutes (in ms)</span>

  case <span class="keyword">class</span> <a title="class CursorContext extends java.lang.Object with ScalaObject with Product with Serializable" id="71583">CursorContext</a><a href="#71583" title="ScalaObject" class="delimiter">(</a><a title="Int" id="76907">cursorId</a>: <span title="Int">Int</span>, <a title="com.sleepycat.je.Cursor" id="76908">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span>, <a title="com.sleepycat.je.Transaction" id="76909">txn</a>: <span title="com.sleepycat.je.Transaction">Transaction</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Long" id="71595">lastActivity</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="71598">valid</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span class="keyword">def</span> <a title="()Unit" id="71600">updateActivity</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <a href="#71595" title="(x$1: Long)Unit">lastActivity</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">def</span> <a title="()Unit" id="71601">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
      <a href="#71598" title="(x$1: Boolean)Unit">valid</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="71602">isTimedout</a>: <span title="Boolean">Boolean</span> = <span class="delimiter">(</span><a href="#71595" title="=&gt; Long">lastActivity</a> <span title="(x: Int)Long">+</span> <a href="#68561" title="=&gt; Int">cursorTimeout</a><span class="delimiter">)</span> <span title="(x: Long)Long">-</span> <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="71603">isValid</a>: <span title="Boolean">Boolean</span> = <a href="#71598" title="=&gt; Boolean">valid</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicInteger" id="68566">cursorIdGen</a> = <span title="()java.util.concurrent.atomic.AtomicInteger" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]" id="68568">openCursors</a> = <span title="()java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">ConcurrentHashMap</span><span class="delimiter">[</span>Int, CursorContext<span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="68570">cursorTimeoutThread</a> = <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newSingleThreadExecutor</span>

  <span class="keyword">protected</span> <span class="keyword">object</span> <a title="object BdbStorageManager.this.CursorTimeoutRunnable" id="68572">CursorTimeoutRunnable</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">val</span> <a title="runnable extends java.lang.Object with java.lang.Runnable" id="71927">runnable</a> = <a href="#71930" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="71930">Runnable</a> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="()Unit" id="71932">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
        <span class="keyword">try</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <a href="#71936" title="()Unit" class="delimiter">{</a>
            <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#68561" title="=&gt; Long">cursorTimeout</a><span class="delimiter">)</span> <span class="comment">// runs every 3 min</span>
            <span class="keyword">val</span> <a title="Iterable[Int]" id="71937">toRemove</a> = <a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(i: java.util.Collection[BdbStorageManager.this.CursorContext])Iterable[BdbStorageManager.this.CursorContext]">values</span>.<span title="(f: BdbStorageManager.this.CursorContext =&gt; scala.collection.GenTraversableOnce[Int])(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[BdbStorageManager.this.CursorContext],Int,Iterable[Int]])Iterable[Int]">flatMap</span> <a href="#72186" title="List[Int]" class="delimiter">{</a>
              <span class="keyword">case</span> <a title="List[Int]" id="72187">ctx</a> @ CursorContext<span class="delimiter">(</span><a title="Int" id="72188">id</a>, <a title="com.sleepycat.je.Cursor" id="72189">cursor</a>, <a title="com.sleepycat.je.Transaction" id="72190">txn</a><span class="delimiter">)</span> =&gt;
                <a href="#72187" title="BdbStorageManager.this.CursorContext">ctx</a>.<span title="(x$1: List[Int])List[Int]">synchronized</span> <span class="delimiter">{</span>
                  <span title="List[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#72187" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#71603" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span title="List[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#72187" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#71602" title="=&gt; Boolean">isTimedout</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                      <a href="#72189" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
                      <a href="#72190" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                      <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor %d closed and marked invalid by cleanup thread&quot;)" class="string">&quot;Cursor %d closed and marked invalid by cleanup thread&quot;</span>, <a href="#72188" title="Int">id</a><span class="delimiter">)</span>
                      <a href="#72187" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#71601" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
                      <span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#72188" title="Int">id</a><span class="delimiter">)</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="object Nil">Nil</span>
                  <span class="delimiter">}</span> <span class="keyword">else</span> <span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#72188" title="Int">id</a><span class="delimiter">)</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#71937" title="Iterable[Int]">toRemove</a>.<span title="(f: Int =&gt; BdbStorageManager.this.CursorContext)Unit">foreach</span><span class="delimiter">(</span><a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#72281" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="72285">e</a>: <span title="java.lang.InterruptedException">InterruptedException</span> =&gt;
            <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor timeout thread got signal to shutdown&quot;)" class="string">&quot;Cursor timeout thread got signal to shutdown&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#68570" title="=&gt; java.util.concurrent.ExecutorService">cursorTimeoutThread</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#71927" title="=&gt; java.lang.Object with java.lang.Runnable">runnable</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="68574">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span> <span class="comment">/* No-op */</span> <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="()Unit" id="68575">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// stop the cursor tasks</span>
    <a href="#68570" title="=&gt; java.util.concurrent.ExecutorService">cursorTimeoutThread</a>.<span title="()java.util.List[java.lang.Runnable]">shutdownNow</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#71813" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(i: java.util.Collection[BdbStorageManager.this.CursorContext])Iterable[BdbStorageManager.this.CursorContext]">values</span>.<span title="(f: BdbStorageManager.this.CursorContext =&gt; Unit)Unit">foreach</span> <a href="#72585" title="Unit" class="delimiter">{</a> 
      <span class="keyword">case</span> <a title="Unit" id="72586">ctx</a> @ CursorContext<span class="delimiter">(</span><a title="Int" id="72587">id</a>, <a title="com.sleepycat.je.Cursor" id="72588">cursor</a>, <a title="com.sleepycat.je.Transaction" id="72589">txn</a><span class="delimiter">)</span> =&gt;
        <a href="#72586" title="BdbStorageManager.this.CursorContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#72586" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#71603" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#72588" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#72589" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor %d closed and marked invalid by shutdown task&quot;)" class="string">&quot;Cursor %d closed and marked invalid by shutdown task&quot;</span>, <a href="#72587" title="Int">id</a><span class="delimiter">)</span>
            <a href="#72586" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#71601" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.util.control.Breaks" id="68576">iterateRangeBreakable</a> = <span title="scala.util.control.Breaks" class="keyword">new</span> <span title="scala.util.control.Breaks">Breaks</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="68578">toString</a> = 
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&lt;PartitionHandler namespace: %s, keyRange: [%s, %s)&gt;&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span>
      <a href="#71813" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#71814" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#71815" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * True iff a particular (non-null) key is bounded by [startKey, endKey)
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Boolean" id="68579">isInRange</a><span class="delimiter">(</span><a title="Array[Byte]" id="72628">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">//just for the moment because of the Hash partitioning</span>
  <span class="comment">//TODO: I turned of the check, for the hash partitiong. Though, this is really dangerous and can cause hard to find bugs.</span>
  <span class="comment">//We should make the starte aware of the routing, and fix it as soon as possible.</span>
  <span class="comment">//  startKey.map(sk =&gt; compare(sk, key) &lt;= 0).getOrElse(true) &amp;&amp;</span>
  <span class="comment">//  endKey.map(ek =&gt; compare(ek, key) &gt; 0).getOrElse(true)</span>

  <span class="comment">/**
   * True iff startKey &lt;= key
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Option[Array[Byte]])Boolean" id="68580">isStartKeyLEQ</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="72631">key</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = 
    <a href="#71814" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="72638">sk</a> =&gt; <span class="comment">/* If we have startKey that is not -INF */</span>
        <a href="#72631" title="Option[Array[Byte]]">key</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="72643">usrKey</a> =&gt; <span class="comment">/* If we have a user key that is not -INF */</span>
          <a href="server/KeyComparison.scala.html#76909" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#72638" title="Array[Byte]">sk</a>, <a href="#72643" title="Array[Byte]">usrKey</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">/* Both keys exist (not -INF), use compare to check range */</span>
        .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">/* startKey not -INF, but user key is -INF, so false */</span>
    .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">/* startKey is -INF, so any user key works */</span>

  <span class="comment">/**
   * True iff endKey &gt;= key
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Option[Array[Byte]])Boolean" id="68581">isEndKeyGEQ</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="72666">key</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="#71815" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="72673">ek</a> =&gt; <span class="comment">/* If we have endKey that is not +INF */</span>
        <a href="#72666" title="Option[Array[Byte]]">key</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="72678">usrKey</a> =&gt; <span class="comment">/* If we have a user key that is not +INF */</span>
          <a href="server/KeyComparison.scala.html#76909" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#72673" title="Array[Byte]">ek</a>, <a href="#72678" title="Array[Byte]">usrKey</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">/* Both keys exist (not +INF), use compare to check range */</span>
        .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">/* endKey not +INF, but user key is +INF, so false */</span>
    .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">/* startKey is +INF, so any user key works */</span>

                        

    <span class="comment">// key validation</span>
    <span class="comment">// val (keysInRange, keysInQuestion) = msg match {</span>
    <span class="comment">//   /* GetRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case GetRequest(key) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   /* PutRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case PutRequest(key, _) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   /* Requires startKey &lt;= minKey and endKey &gt;= maxKey (so specifying the</span>
    <span class="comment">//    * entire range is allowed */</span>
    <span class="comment">//   case GetRangeRequest(minKey, maxKey, _, _, _) =&gt;</span>
    <span class="comment">//     (isStartKeyLEQ(minKey) &amp;&amp; isEndKeyGEQ(maxKey), Right((minKey, maxKey)))</span>
    <span class="comment">//   /* Requires startKey &lt;= minKey and endKey &gt;= maxKey (so specifying the</span>
    <span class="comment">//    * entire range is allowed */</span>
    <span class="comment">//   case CountRangeRequest(minKey, maxKey) =&gt;</span>
    <span class="comment">//     (isStartKeyLEQ(minKey) &amp;&amp; isEndKeyGEQ(maxKey), Right((minKey, maxKey)))</span>
    <span class="comment">//   /* TestSetRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case TestSetRequest(key, _, _) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   case _ =&gt; (true, null)</span>
    <span class="comment">// }</span>

      <span class="comment">// val errorMsg = keysInQuestion match {</span>
      <span class="comment">//   case Left(key) =&gt;</span>
      <span class="comment">//     &quot;Expected a key in range [%s, %s), but got %s&quot;.format(</span>
      <span class="comment">//       JArrays.toString(startKey.orNull), </span>
      <span class="comment">//       JArrays.toString(endKey.orNull), </span>
      <span class="comment">//       JArrays.toString(key))</span>
      <span class="comment">//   case Right((minKey, maxKey)) =&gt;</span>
      <span class="comment">//     &quot;Expected a range bounded (inclusively) by [%s, %s), but got [%s, %s)&quot;.format(</span>
      <span class="comment">//       JArrays.toString(startKey.orNull),</span>
      <span class="comment">//       JArrays.toString(endKey.orNull),</span>
      <span class="comment">//       JArrays.toString(minKey.orNull),</span>
      <span class="comment">//       JArrays.toString(maxKey.orNull))</span>
      <span class="comment">// }</span>
      <span class="comment">// logger.error(&quot;Received errorneous request %s. Error was: %s&quot;, msg, errorMsg)</span>
      <span class="comment">// reply(RequestRejected(&quot;Key(s) are out of range: %s&quot;.format(errorMsg), msg))</span>


   <span class="keyword">def</span> <a title="(key: Array[Byte])Option[Array[Byte]]" id="68582">get</a><span class="delimiter">(</span><a title="Array[Byte]" id="72697">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
     <span class="keyword">val</span> <a href="#72701" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#72700" title="com.sleepycat.je.DatabaseEntry" id="72701">dbeKey</a>, <a href="#72700" title="com.sleepycat.je.DatabaseEntry" id="72702">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72697" title="Array[Byte]">key</a><span class="delimiter">)</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
     <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Running get %s %s&quot;)" class="string">&quot;Running get %s %s&quot;</span>, <a href="#72701" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#72702" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
     <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry, x$4: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">get</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#72701" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#72702" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, LockMode.<span title="com.sleepycat.je.LockMode(value READ_COMMITTED)">READ_COMMITTED</span><span class="delimiter">)</span>
     <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;get operation complete %s %s&quot;)" class="string">&quot;get operation complete %s %s&quot;</span>, <a href="#72701" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#72702" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
     <span title="(x: Array[Byte])Option[Array[Byte]]">Option</span><span class="delimiter">(</span><a href="#72702" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
   <span class="delimiter">}</span>


  <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])Unit" id="68583">put</a><span class="delimiter">(</span><a title="Array[Byte]" id="72792">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>,<a title="Option[Array[Byte]]" id="72793">value</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#72793" title="Option[Array[Byte]]">value</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="72798">v</a><span class="delimiter">)</span> =&gt; <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span title="Unit" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72792" title="Array[Byte]">key</a><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72798" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span title="Unit" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72792" title="Array[Byte]">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]], expectedValue: Option[Array[Byte]])Boolean" id="68584">testAndSet</a><span class="delimiter">(</span><a title="Array[Byte]" id="72805">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="72806">value</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="72807">expectedValue</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="72812">txn</a> = <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="72813">dbeKey</a> = <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72805" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="72814">dbeCurrentValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry, x$4: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">get</span><span class="delimiter">(</span><a href="#72812" title="com.sleepycat.je.Transaction">txn</a>, <a href="#72813" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#72814" title="com.sleepycat.je.DatabaseEntry">dbeCurrentValue</a>, LockMode.<span title="com.sleepycat.je.LockMode(value READ_COMMITTED)">READ_COMMITTED</span><span class="delimiter">)</span>
    <span title="Boolean" class="keyword">if</span><span class="delimiter">(</span><span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte], x$2: Array[Byte])Boolean">equals</span><span class="delimiter">(</span><a href="#72807" title="Option[Array[Byte]]">expectedValue</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span>, <a href="#72814" title="com.sleepycat.je.DatabaseEntry">dbeCurrentValue</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">{</span>
      <a href="#72806" title="Option[Array[Byte]]">value</a> <span title="com.sleepycat.je.OperationStatus" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="72870">v</a><span class="delimiter">)</span> =&gt; <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#72812" title="com.sleepycat.je.Transaction">txn</a>, <a href="#72813" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72870" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus">None</span> =&gt; <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#72812" title="com.sleepycat.je.Transaction">txn</a>, <a href="#72813" title="com.sleepycat.je.DatabaseEntry">dbeKey</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#72812" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#72812" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">abort</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(parser: edu.berkeley.cs.scads.storage.RecParser, locations: Seq[String])Unit" id="68585">bulkUrlPut</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecParser" id="72875">parser</a>:<a href="PartitionHandler.scala.html#10056" title="edu.berkeley.cs.scads.storage.RecParser">RecParser</a>, <a title="Seq[String]" id="72876">locations</a>:<span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="72880">txn</a> = <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>,<span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#72876" title="Seq[String]">locations</a> <span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="72897">location</a> =&gt; <span class="delimiter">{</span>
      <a href="#72875" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#53616" title="(location: String)Unit">setLocation</a><span class="delimiter">(</span><a href="#72897" title="String">location</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.net.URL" id="72898">url</a> = <span title="(x$1: java.lang.String)java.net.URL" class="keyword">new</span> java.net.<span title="java.net.URL">URL</span><span class="delimiter">(</span><a href="#72897" title="String">location</a><span class="delimiter">)</span>
      <a href="#72875" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#53617" title="(in: java.io.InputStream)Unit">setInput</a><span class="delimiter">(</span><a href="#72898" title="java.net.URL">url</a>.<span title="()java.io.InputStream">openStream</span><span class="delimiter">)</span>
      <span class="keyword">var</span> <a title="(AnyRef, AnyRef)" id="72899">kv</a> = <a href="#72875" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#53618" title="()(AnyRef, AnyRef)">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#72899" title="(AnyRef, AnyRef)">kv</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#73028" title="()Unit" class="delimiter">{</a>
        <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#72880" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72899" title="(AnyRef, AnyRef)">kv</a>.<span title="=&gt; AnyRef">_1</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#72899" title="(AnyRef, AnyRef)">kv</a>.<span title="=&gt; AnyRef">_2</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#72899" title="(AnyRef, AnyRef)">kv</a> = <a href="#72875" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#53618" title="()(AnyRef, AnyRef)">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#72880" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// exception here will get caught above</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(records: Seq[edu.berkeley.cs.scads.storage.PutRequest])Unit" id="68586">bulkPut</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.PutRequest]" id="73043">records</a>:<span title="Seq[edu.berkeley.cs.scads.storage.PutRequest]">Seq</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="73046">txn</a> = <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="73047">reccount</a> = <span title="Int(0)" class="int">0</span>
    <a href="#73043" title="Seq[edu.berkeley.cs.scads.storage.PutRequest]">records</a>.<span title="(f: edu.berkeley.cs.scads.storage.PutRequest =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PutRequest" id="73064">rec</a> =&gt; <span class="delimiter">{</span> <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#73046" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#73064" title="edu.berkeley.cs.scads.storage.PutRequest">rec</a>.<a href="../Messages.scala.html#22682" title="=&gt; Array[Byte]">key</a><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#73064" title="edu.berkeley.cs.scads.storage.PutRequest">rec</a>.<a href="../Messages.scala.html#22685" title="=&gt; Option[Array[Byte]]">value</a>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span><span class="delimiter">)</span>; <a href="#73047" title="Int">reccount</a><span title="(x: Int)Int">+=</span><span title="Int(1)" class="int">1</span><span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#73046" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>  <span class="comment">// exception here will get caught above</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[edu.berkeley.cs.scads.storage.Record]" id="68587">getRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="73076">minKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="73077">maxKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="73078">limit</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="73079">offset</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="73080">ascending</a>:<span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Seq[edu.berkeley.cs.scads.storage.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] GetRangeRequest: [%s, %s)&quot;)" class="string">&quot;[%s] GetRangeRequest: [%s, %s)&quot;</span>, <a href="#10007" title="edu.berkeley.cs.scads.storage.BdbStorageManager" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#73076" title="Option[Array[Byte]]">minKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#73077" title="Option[Array[Byte]]">maxKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" id="73087">records</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
    <a href="#73078" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Unit)Option[Unit]">map</span><span class="delimiter">(</span><a href="#73087" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#73120" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#68598" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#73076" title="Option[Array[Byte]]">minKey</a>, <a href="#73077" title="Option[Array[Byte]]">maxKey</a>, <a href="#73078" title="Option[Int]">limit</a>, <a href="#73079" title="Option[Int]">offset</a>, <a href="#73080" title="Boolean">ascending</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="73145">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="73146">value</a>, <a title="com.sleepycat.je.Cursor" id="73147">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#73087" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a> <span title="(elem: edu.berkeley.cs.scads.storage.Record)records.type">+=</span> <a href="../Messages.scala.html#22238" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.Record">Record</a><span class="delimiter">(</span><a href="#73145" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>, <a href="#73146" title="com.sleepycat.je.DatabaseEntry">value</a>.<a href="#68558" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="comment">// reccount commented out b/c its not being used and it causes each</span>
    <span class="comment">// GetRangeRequest to be a lot slower</span>
    <span class="comment">//var reccount = 0</span>
    <span class="comment">//iterateOverRange(minKey, maxKey)((_,_,_) =&gt; reccount += 1)</span>
    <a href="#73087" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(ranges: Seq[edu.berkeley.cs.scads.storage.StorageMessage])scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]" id="68588">getBatch</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.storage.StorageMessage]" id="73164">ranges</a>:<span title="Seq[edu.berkeley.cs.scads.storage.StorageMessage]">Seq</span><span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]">ArrayBuffer</span><span class="delimiter">[</span>GetRangeResponse<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]" id="73167">results</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]">ArrayBuffer</span><span class="delimiter">[</span>GetRangeResponse<span class="delimiter">]</span>
    <a href="#73167" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]">results</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#73164" title="Seq[edu.berkeley.cs.scads.storage.StorageMessage]">ranges</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <a href="#73164" title="Seq[edu.berkeley.cs.scads.storage.StorageMessage]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.storage.StorageMessage =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse])Unit">foreach</span> <a href="#73194" title="results.type" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="results.type">GetRangeRequest</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="73195">minKey</a>, <a title="Option[Array[Byte]]" id="73196">maxKey</a>, <a title="Option[Int]" id="73197">limit</a>, <a title="Option[Int]" id="73198">offset</a>, <a title="Boolean" id="73199">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" id="73200">records</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
        <a href="#73197" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Unit)Option[Unit]">map</span><span class="delimiter">(</span><a href="#73200" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#73207" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#68598" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#73195" title="Option[Array[Byte]]">minKey</a>, <a href="#73196" title="Option[Array[Byte]]">maxKey</a>, <a href="#73197" title="Option[Int]">limit</a>, <a href="#73198" title="Option[Int]">offset</a>, <a href="#73199" title="Boolean">ascending</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="73218">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="73219">value</a>, <a title="com.sleepycat.je.Cursor" id="73220">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#73200" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a> <span title="(elem: edu.berkeley.cs.scads.storage.Record)records.type">+=</span> <a href="../Messages.scala.html#22238" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.Record">Record</a><span class="delimiter">(</span><a href="#73218" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>, <a href="#73219" title="com.sleepycat.je.DatabaseEntry">value</a>.<a href="#68558" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <a href="#73167" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]">results</a> <span title="(elem: edu.berkeley.cs.scads.storage.GetRangeResponse)results.type">+=</span> <a href="../Messages.scala.html#23149" title="(records: Seq[edu.berkeley.cs.scads.storage.Record])edu.berkeley.cs.scads.storage.GetRangeResponse">GetRangeResponse</a><span class="delimiter">(</span><a href="#73200" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">records</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BatchRequests only implemented for GetRange&quot;)" class="string">&quot;BatchRequests only implemented for GetRange&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#73167" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.GetRangeResponse]">results</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]])Int" id="68589">countRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="73256">minKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="73257">maxKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Int">Int</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="73261">count</a> = <span title="Int(0)" class="int">0</span>
    <a href="#68598" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#73256" title="Option[Array[Byte]]">minKey</a>, <a href="#73257" title="Option[Array[Byte]]">maxKey</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="73269">_</a>,<a title="com.sleepycat.je.DatabaseEntry" id="73270">_</a>,<a title="com.sleepycat.je.Cursor" id="73271">_</a><span class="delimiter">)</span> =&gt; <a href="#73261" title="Int">count</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <a href="#73261" title="Int">count</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(src: edu.berkeley.cs.scads.storage.PartitionService, overwrite: Boolean)Unit" id="68590">copyData</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.PartitionService" id="73276">src</a>:<a href="../Messages.scala.html#9559" title="edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a>, <a title="Boolean" id="73277">overwrite</a>:<span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begin CopyDataRequest src = &quot;)" class="string">&quot;Begin CopyDataRequest src = &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#73276" title="edu.berkeley.cs.scads.storage.PartitionService">src</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;, overwrite = &quot;)" class="string">&quot;, overwrite = &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#73277" title="Boolean">overwrite</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="73281">txn</a> = <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="73282">dbeExistingValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="73283">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="73284">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Opening iterator for data copy&quot;)" class="string">&quot;Opening iterator for data copy&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.FutureBasedIterator" id="73285">iter</a> = <a href="#68554" title="(v1: edu.berkeley.cs.scads.storage.PartitionService, v2: Option[Array[Byte]], v3: Option[Array[Byte]])edu.berkeley.cs.scads.storage.FutureBasedIterator">copyIteratorCtor</a><span class="delimiter">(</span><a href="#73276" title="edu.berkeley.cs.scads.storage.PartitionService">src</a>, <a href="#71814" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#71815" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span> 

    <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Beginning copy&quot;)" class="string">&quot;Beginning copy&quot;</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="73286">numRec</a> = <span title="Int(0)" class="int">0</span>
    <a href="#73285" title="edu.berkeley.cs.scads.storage.FutureBasedIterator">iter</a>.<span title="(f: edu.berkeley.cs.scads.storage.Record =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.Record" id="73310">rec</a> =&gt; <span class="delimiter">{</span>
      <a href="#73283" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="(x$1: Array[Byte])Unit">setData</span><span class="delimiter">(</span><a href="#73310" title="edu.berkeley.cs.scads.storage.Record">rec</a>.<a href="../Messages.scala.html#22202" title="=&gt; Array[Byte]">key</a><span class="delimiter">)</span>
      <a href="#73284" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<span title="(x$1: Array[Byte])Unit">setData</span><span class="delimiter">(</span><a href="#73310" title="edu.berkeley.cs.scads.storage.Record">rec</a>.<a href="../Messages.scala.html#22205" title="=&gt; Option[Array[Byte]]">value</a>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span>
      
      <span title="com.sleepycat.je.OperationStatus" class="keyword">if</span> <span class="delimiter">(</span><a href="#73277" title="Boolean">overwrite</a><span class="delimiter">)</span> <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#73281" title="com.sleepycat.je.Transaction">txn</a>, <a href="#73283" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#73284" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
      <span class="keyword">else</span> <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">putNoOverwrite</span><span class="delimiter">(</span><a href="#73281" title="com.sleepycat.je.Transaction">txn</a>, <a href="#73283" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#73284" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
      <span class="comment">// NOTE: was previously the code below, but putNoOverwrite seems</span>
      <span class="comment">// to give us the exact semantics we are looking for here (plus</span>
      <span class="comment">// possibly more efficient than a get() followed by a put())</span>
      <span class="comment">//if(db.get(txn, dbeKey, dbeExistingValue, LockMode.READ_COMMITTED) != OperationStatus.SUCCESS)</span>
      <span class="comment">//  db.put(txn, dbeKey, dbeValue)</span>

      <a href="#73286" title="Int">numRec</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#73286" title="Int">numRec</a> <span title="(x: Int)Int">%</span> <span title="Int(10000)" class="int">10000</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;copied %d records so far&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#73286" title="Int">numRec</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Finished copying %d records&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#73286" title="Int">numRec</a><span class="delimiter">)</span><span class="delimiter">)</span>
    
    <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Beginning commit&quot;)" class="string">&quot;Beginning commit&quot;</span><span class="delimiter">)</span>
    <a href="#73281" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Ending commit&quot;)" class="string">&quot;Ending commit&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
                         
  <span class="keyword">def</span> <a title="()(Option[Array[Byte]], Option[Array[Byte]])" id="68591">getResponsibility</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#71814" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#71815" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(groups: Seq[String], keyType: String, valType: String, filters: Seq[edu.berkeley.cs.scads.storage.AggFilter], aggs: Seq[edu.berkeley.cs.scads.storage.AggOp])Seq[edu.berkeley.cs.scads.storage.GroupedAgg]" id="68592">applyAggregate</a><span class="delimiter">(</span><a title="Seq[String]" id="73352">groups</a>:<span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
                     <a title="String" id="73353">keyType</a>:<span title="String">String</span>,
                     <a title="String" id="73354">valType</a>:<span title="String">String</span>,
                     <a title="Seq[edu.berkeley.cs.scads.storage.AggFilter]" id="73355">filters</a>:<span title="Seq[edu.berkeley.cs.scads.storage.AggFilter]">Seq</span><span class="delimiter">[</span>AggFilter<span class="delimiter">]</span>,
                     <a title="Seq[edu.berkeley.cs.scads.storage.AggOp]" id="73356">aggs</a>:<span title="Seq[edu.berkeley.cs.scads.storage.AggOp]">Seq</span><span class="delimiter">[</span>AggOp<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Seq[edu.berkeley.cs.scads.storage.GroupedAgg]">Seq</span><span class="delimiter">[</span>GroupedAgg<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="73363">filterFunctions</a> = <a href="#73355" title="Seq[edu.berkeley.cs.scads.storage.AggFilter]">filters</a>.<span title="(f: edu.berkeley.cs.scads.storage.AggFilter =&gt; edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.AggFilter],edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]])Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.AggFilter" id="73392">f</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ObjectInputStream" id="73393">ois</a> = <span title="java.io.ObjectInputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectInputStream">ObjectInputStream</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#73392" title="edu.berkeley.cs.scads.storage.AggFilter">f</a>.<a href="../Messages.scala.html#23900" title="=&gt; Array[Byte]">obj</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#73393" title="java.io.ObjectInputStream">ois</a>.<span title="()java.lang.Object">readObject</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="delimiter">[</span><a href="util/AnalyticsUtils.scala.html#10473" title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Filter</a><span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="73364">filterPassed</a> = <span title="Boolean(true)" class="keyword">true</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="73365">aggregates</a> =
      <a href="#73356" title="Seq[edu.berkeley.cs.scads.storage.AggOp]">aggs</a>.<span title="(f: edu.berkeley.cs.scads.storage.AggOp =&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.storage.AggOp],edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]])Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.AggOp" id="73569">aggOp</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.ObjectInputStream" id="73570">ois</a> = <span title="java.io.ObjectInputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectInputStream">ObjectInputStream</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#73569" title="edu.berkeley.cs.scads.storage.AggOp">aggOp</a>.<a href="../Messages.scala.html#23963" title="=&gt; Array[Byte]">obj</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#73570" title="java.io.ObjectInputStream">ois</a>.<span title="()java.lang.Object">readObject</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="delimiter">[</span><a href="util/AnalyticsUtils.scala.html#10478" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">RemoteAggregate</a><span class="delimiter">[</span>ScalaSpecificRecord,ScalaSpecificRecord,ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
            

    <span class="keyword">val</span> <a title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" id="73366">remKey</a> = <span title="object java.lang.Class">Class</span>.<span title="(x$1: java.lang.String)java.lang.Class[_]">forName</span><span class="delimiter">(</span><a href="#73353" title="String">keyType</a><span class="delimiter">)</span>.<span title="()?0">newInstance</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" id="73367">remVal</a> = <span title="object java.lang.Class">Class</span>.<span title="(x$1: java.lang.String)java.lang.Class[_]">forName</span><span class="delimiter">(</span><a href="#73354" title="String">valType</a><span class="delimiter">)</span>.<span title="()?0">newInstance</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>
    
    <span class="keyword">val</span> <a title="Seq[org.apache.avro.Schema]" id="73368">groupSchemas</a> = <a href="#73352" title="Seq[String]">groups</a>.<span title="(f: String =&gt; org.apache.avro.Schema)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],org.apache.avro.Schema,Seq[org.apache.avro.Schema]])Seq[org.apache.avro.Schema]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.Schema,Seq[org.apache.avro.Schema]]" class="delimiter">(</span><a href="#71818" title="org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#73615" title="String">_</a><span class="delimiter">)</span>.<span title="()org.apache.avro.Schema">schema</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[Int]" id="73369">groupInts</a> = <a href="#73352" title="Seq[String]">groups</a>.<span title="(f: String =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],Int,Seq[Int]])Seq[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Int,Seq[Int]]" class="delimiter">(</span><a href="#71818" title="org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#73645" title="String">_</a><span class="delimiter">)</span>.<span title="()Int">pos</span><span class="delimiter">)</span>
    
    <span class="keyword">var</span> <a title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="73370">groupMap</a>:<span title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">Map</span><span class="delimiter">[</span>CharSequence, scala.collection.mutable.ArraySeq<span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span class="keyword">var</span> <a title="Map[java.lang.CharSequence,Array[Byte]]" id="73371">groupBytesMap</a>:<span title="Map[java.lang.CharSequence,Array[Byte]]">Map</span><span class="delimiter">[</span>CharSequence, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span class="keyword">var</span> <a title="java.lang.CharSequence" id="73372">groupKey</a>:<span title="java.lang.CharSequence">CharSequence</span> = <span title="Null(null)" class="keyword">null</span>
    
    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="73373">aggVals</a>:<span title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Seq</span><span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#73352" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// no groups, so let's init values now</span>
      <a href="#73373" title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">aggVals</a> = <a href="#73365" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="(f: edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]])Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="delimiter">(</span><a href="#73975" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_</a>.<a href="util/AnalyticsUtils.scala.html#34634" title="()edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">init</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#73370" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a> = <span title="scala.collection.immutable.HashMap[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="keyword">new</span> scala.collection.immutable.<span title="scala.collection.immutable.HashMap[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">HashMap</span><span class="delimiter">[</span>CharSequence,scala.collection.mutable.ArraySeq<span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
      <a href="#73371" title="Map[java.lang.CharSequence,Array[Byte]]">groupBytesMap</a> = <span title="scala.collection.immutable.HashMap[java.lang.CharSequence,Array[Byte]]" class="keyword">new</span> scala.collection.immutable.<span title="scala.collection.immutable.HashMap[java.lang.CharSequence,Array[Byte]]">HashMap</span><span class="delimiter">[</span>CharSequence, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="delimiter">}</span>
    
    <span class="keyword">var</span> <a title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="73374">curAggVal</a> =
      <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="keyword">if</span> <span class="delimiter">(</span><a href="#73352" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        scala.collection.mutable.<span title="(elems: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord*)scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ArraySeq</span><span class="delimiter">(</span><a href="#73373" title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">aggVals</a>:_*<span class="delimiter">)</span>
      <span class="keyword">else</span>
        <span title="Null(null)" class="keyword">null</span>

    <span class="keyword">var</span> <a title="Boolean" id="73375">stop</a> = <span title="Boolean(false)" class="keyword">false</span>

    <a href="#68598" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="74171">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="74172">value</a>, <a title="com.sleepycat.je.Cursor" id="74173">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// TODO: Use lazy values here</span>
      <span class="keyword">val</span> <a title="Array[Byte]" id="74174">valBytes</a> = <a href="#74172" title="com.sleepycat.je.DatabaseEntry">value</a>.<span title="()Array[Byte]">getData</span>
      <a href="#73367" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a>.<span title="(inputStream: java.io.InputStream)remVal.type">parse</span><span class="delimiter">(</span><span title="(x$1: Array[Byte], x$2: Int, x$3: Int)java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#74174" title="Array[Byte]">valBytes</a>,<span title="Int(16)" class="int">16</span>,<span class="delimiter">(</span><a href="#74174" title="Array[Byte]">valBytes</a>.<span title="=&gt; Int">length</span><span title="(x: Int)Int">-</span><span title="Int(16)" class="int">16</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Array[Byte]" id="74175">keyBytes</a> = <a href="#74171" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>
      <a href="#73366" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remKey</a>.<span title="(data: Array[Byte])remKey.type">parse</span><span class="delimiter">(</span><a href="#74175" title="Array[Byte]">keyBytes</a><span class="delimiter">)</span>
      
      <a href="#73364" title="Boolean">filterPassed</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#73363" title="Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">filterFunctions</a>.<span title="(f: edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="74206">ff</a> =&gt; <span class="delimiter">{</span> 
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#73364" title="Boolean">filterPassed</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// once one failed just ignore the rest</span>
          <a href="#73364" title="Boolean">filterPassed</a> = <a href="#74206" title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ff</a>.<a href="util/AnalyticsUtils.scala.html#32514" title="(r: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)Boolean">applyFilter</a><span class="delimiter">(</span><a href="#73367" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#73364" title="Boolean">filterPassed</a><span class="delimiter">)</span> <span class="delimiter">{</span>  <span class="comment">// record passes filters</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#73352" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#73372" title="java.lang.CharSequence">groupKey</a> = <a href="util/AnalyticsUtils.scala.html#10482" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="util/AnalyticsUtils.scala.html#34669" title="(groups: Seq[Int], rec: org.apache.avro.generic.IndexedRecord)java.lang.CharSequence">getGroupKey</a><span class="delimiter">(</span><a href="#73369" title="Seq[Int]">groupInts</a>,<a href="#73367" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
          <a href="#73374" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a> = <a href="#73370" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a>.<span title="(key: java.lang.CharSequence)Option[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">get</span><span class="delimiter">(</span><a href="#73372" title="java.lang.CharSequence">groupKey</a><span class="delimiter">)</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Some</span><span class="delimiter">(</span><a title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="74397">thing</a><span class="delimiter">)</span> =&gt; <a href="#74397" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">thing</a>
            <span class="keyword">case</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">None</span> =&gt; <span class="delimiter">{</span> <span class="comment">// this is a new group, so init the starting values for the agg</span>
              <a href="#73371" title="Map[java.lang.CharSequence,Array[Byte]]">groupBytesMap</a> <span title="(kv: (java.lang.CharSequence, Array[Byte]))scala.collection.immutable.Map[java.lang.CharSequence,Array[Byte]]">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.CharSequence, _2: Array[Byte])(java.lang.CharSequence, Array[Byte])" class="delimiter">(</span><a href="#73372" title="java.lang.CharSequence">groupKey</a>,<a href="util/AnalyticsUtils.scala.html#10482" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="util/AnalyticsUtils.scala.html#34666" title="(groups: Seq[Int], groupSchemas: Seq[org.apache.avro.Schema], rec: org.apache.avro.generic.IndexedRecord)Array[Byte]">getGroupBytes</a><span class="delimiter">(</span><a href="#73369" title="Seq[Int]">groupInts</a>,<a href="#73368" title="Seq[org.apache.avro.Schema]">groupSchemas</a>,<a href="#73367" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              scala.collection.mutable.<span title="(elems: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord*)scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ArraySeq</span><span class="delimiter">(</span><a href="#73365" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="(f: edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]])Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="delimiter">(</span><a href="#74516" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_</a>.<a href="util/AnalyticsUtils.scala.html#34634" title="()edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">init</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>:_*<span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <a href="#73375" title="Boolean">stop</a> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#73365" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]">view</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]],(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),scala.collection.SeqView[(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),Seq[_]]])scala.collection.SeqView[(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),Seq[_]]">zipWithIndex</span> <span title="(f: (edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)" id="76099">aggregate</a> =&gt; <span class="delimiter">{</span>
          <a href="#73374" title="(idx: Int, elem: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)Unit">curAggVal</a><span class="delimiter">(</span><a href="#76099" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span> = <a href="#76099" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_1</span>.<a href="util/AnalyticsUtils.scala.html#34635" title="(a: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord, k: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord, v: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">applyAggregate</a><span class="delimiter">(</span><a href="#73374" title="(idx: Int)edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">curAggVal</a><span class="delimiter">(</span><a href="#76099" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span>,<a href="#73366" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remKey</a>,<a href="#73367" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
          <a href="#73375" title="Boolean">stop</a> <span title="(x: Boolean)Boolean">&amp;=</span> <a href="#76099" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_1</span>.<a href="util/AnalyticsUtils.scala.html#34631" title="=&gt; Boolean">stop</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#73352" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
          <a href="#73370" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a> <span title="(kv: (java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]))scala.collection.immutable.Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.CharSequence, _2: scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])" class="delimiter">(</span><a href="#73372" title="java.lang.CharSequence">groupKey</a>,<a href="#73374" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#73375" title="Boolean">stop</a><span class="delimiter">)</span>
          <a href="#68576" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="()Unit">break</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <span title="Seq[edu.berkeley.cs.scads.storage.GroupedAgg]" class="keyword">if</span> <span class="delimiter">(</span><a href="#73352" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(xs: edu.berkeley.cs.scads.storage.GroupedAgg*)List[edu.berkeley.cs.scads.storage.GroupedAgg]">List</span><span class="delimiter">(</span><a href="../Messages.scala.html#24370" title="(group: Option[Array[Byte]], groupVals: Seq[Array[Byte]])edu.berkeley.cs.scads.storage.GroupedAgg">GroupedAgg</a><span class="delimiter">(</span><span title="object None">None</span>,<a href="#73374" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a>.<span title="(f: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq.Coll,Array[Byte],scala.collection.mutable.ArraySeq[Array[Byte]]]" class="delimiter">(</span><a href="#76578" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">_</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#73370" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a>.<span title="(f: (java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]) =&gt; edu.berkeley.cs.scads.storage.GroupedAgg)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.scads.storage.GroupedAgg,scala.collection.immutable.Iterable[edu.berkeley.cs.scads.storage.GroupedAgg]])scala.collection.immutable.Iterable[edu.berkeley.cs.scads.storage.GroupedAgg]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Iterable.Coll,edu.berkeley.cs.scads.storage.GroupedAgg,scala.collection.immutable.Iterable[edu.berkeley.cs.scads.storage.GroupedAgg]]" class="delimiter">(</span><a title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])" id="76676">kv</a> =&gt; <span class="delimiter">{</span>
        <a href="../Messages.scala.html#24370" title="(group: Option[Array[Byte]], groupVals: Seq[Array[Byte]])edu.berkeley.cs.scads.storage.GroupedAgg">GroupedAgg</a><span class="delimiter">(</span><a href="#73371" title="(key: java.lang.CharSequence)Array[Byte]">groupBytesMap</a><a href="#68558" title="(a: Array[Byte])Option[Array[Byte]]" class="delimiter">(</a><a href="#76676" title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])">kv</a>.<span title="=&gt; java.lang.CharSequence">_1</span><span class="delimiter">)</span>,<a href="#76676" title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])">kv</a>.<span title="=&gt; scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_2</span>.<span title="(f: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq.Coll,Array[Byte],scala.collection.mutable.ArraySeq[Array[Byte]]]" class="delimiter">(</span><a href="#76715" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">_</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.storage.GroupedAgg]">toSeq</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(optCursorId: Option[Int], recsPerMessage: Int)(Option[Int], IndexedSeq[edu.berkeley.cs.scads.storage.Record])" id="68593">cursorScan</a><span class="delimiter">(</span><a title="Option[Int]" id="76831">optCursorId</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Int" id="76832">recsPerMessage</a>:<span title="Int">Int</span><span class="delimiter">)</span>:<span title="(Option[Int], IndexedSeq[edu.berkeley.cs.scads.storage.Record])" class="delimiter">(</span>Option<span class="delimiter">[</span>Int<span class="delimiter">]</span>,IndexedSeq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#76832" title="Int">recsPerMessage</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#10057" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Recs per message needs to be &gt; 0: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#76832" title="Int">recsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="runnable extends java.lang.Object with java.lang.Runnable" id="76834">dummy</a> = <a href="#68572" title="object BdbStorageManager.this.CursorTimeoutRunnable">CursorTimeoutRunnable</a>.<a href="#71927" title="=&gt; java.lang.Object with java.lang.Runnable">runnable</a> <span class="comment">// initialize it (lazily)</span>

    <span class="comment">//logger.info(&quot;CursorScanRequest: %s&quot;, msg)</span>

    <span class="keyword">val</span> <a href="#76836" title="(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</a><a href="#76835" title="Int" id="76836">cursorId</a>, <a href="#76835" title="BdbStorageManager.this.CursorContext" id="76837">cursorCtx</a><span class="delimiter">)</span> = <a href="#76831" title="Option[Int]">optCursorId</a>.<span title="(f: Int =&gt; (Int, BdbStorageManager.this.CursorContext))Option[(Int, BdbStorageManager.this.CursorContext)]">map</span><span class="delimiter">(</span><a title="Int" id="76856">id</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="BdbStorageManager.this.CursorContext" id="76857">ctx</a> = <span title="(x: BdbStorageManager.this.CursorContext)Option[BdbStorageManager.this.CursorContext]">Option</span><span class="delimiter">(</span><a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">get</span><span class="delimiter">(</span><a href="#76856" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; BdbStorageManager.this.CursorContext)BdbStorageManager.this.CursorContext">getOrElse</span><span class="delimiter">(</span><span class="delimiter">{</span> 
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#10057" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid cursor Id: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#76856" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span title="(_1: Int, _2: BdbStorageManager.this.CursorContext)(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</span><a href="#76856" title="Int">id</a>, <a href="#76857" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(default: =&gt; (Int, BdbStorageManager.this.CursorContext))(Int, BdbStorageManager.this.CursorContext)">getOrElse</span><span title="(Int, BdbStorageManager.this.CursorContext) @unchecked" class="delimiter">(</span><span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="76880">id</a> = <a href="#68566" title="=&gt; java.util.concurrent.atomic.AtomicInteger">cursorIdGen</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="76881">txn</a> = <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="76882">newCursor</a> = <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><a href="#76881" title="com.sleepycat.je.Transaction">txn</a>, <span title="object com.sleepycat.je.CursorConfig">CursorConfig</span>.<span title="com.sleepycat.je.CursorConfig">READ_UNCOMMITTED</span><span class="delimiter">)</span>
      <a href="#68596" title="(cursor: com.sleepycat.je.Cursor)com.sleepycat.je.OperationStatus">initCursor</a><span class="delimiter">(</span><a href="#76882" title="com.sleepycat.je.Cursor">newCursor</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="BdbStorageManager.this.CursorContext" id="76883">ctx</a> = <a href="#71583" title="(cursorId: Int, cursor: com.sleepycat.je.Cursor, txn: com.sleepycat.je.Transaction)BdbStorageManager.this.CursorContext">CursorContext</a><span class="delimiter">(</span><a href="#76880" title="Int">id</a>, <a href="#76882" title="com.sleepycat.je.Cursor">newCursor</a>, <a href="#76881" title="com.sleepycat.je.Transaction">txn</a><span class="delimiter">)</span>
      <a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Int, x$2: BdbStorageManager.this.CursorContext)BdbStorageManager.this.CursorContext">put</span><span class="delimiter">(</span><a href="#76880" title="Int">id</a>, <a href="#76883" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
      <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;made new cursor with id %d, txn with id %d&quot;)" class="string">&quot;made new cursor with id %d, txn with id %d&quot;</span>, <a href="#76880" title="Int">id</a>, <a href="#76881" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Long">getId</span><span class="delimiter">)</span>
      <span title="(_1: Int, _2: BdbStorageManager.this.CursorContext)(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</span><a href="#76880" title="Int">id</a>, <a href="#76883" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    
    <span class="comment">// lock the cursor context</span>
    <span class="keyword">val</span> <a href="#76839" title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record])" class="delimiter">(</a><a href="#76838" title="Boolean" id="76839">moreRecs</a>, <a href="#76838" title="IndexedSeq[edu.berkeley.cs.scads.storage.Record]" id="76840">recs</a><span class="delimiter">)</span> = <a href="#76837" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<span title="(x$1: (Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record]))(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record])">synchronized</span> <span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record]) @unchecked" class="delimiter">{</span>
      <span class="comment">// check to see if the cursor is still valid</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#76837" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#71603" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#76836" title="Int">cursorId</a><span class="delimiter">)</span> <span class="comment">// just to be sure </span>
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#10057" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Cursor ID: %d has already timedout&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#76836" title="Int">cursorId</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#76837" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#71600" title="()Unit">updateActivity</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// set a new timeout</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="76946">cursor</a> = <a href="#76837" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#76908" title="=&gt; com.sleepycat.je.Cursor">cursor</a>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="76947">txn</a> = <a href="#76837" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#76909" title="=&gt; com.sleepycat.je.Transaction">txn</a>
      <span class="keyword">val</span> <a href="#76949" title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record])" class="delimiter">(</a><a href="#76948" title="Boolean" id="76949">moreRecs</a>, <a href="#76948" title="IndexedSeq[edu.berkeley.cs.scads.storage.Record]" id="76950">recs</a><span class="delimiter">)</span> = <a href="#68597" title="(cursor: com.sleepycat.je.Cursor, recsPerMessage: Int)(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record])">advanceCursor</a><span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record]) @unchecked" class="delimiter">(</span><a href="#76946" title="com.sleepycat.je.Cursor">cursor</a>, <a href="#76832" title="Int">recsPerMessage</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#76949" title="Boolean">moreRecs</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// done, close this cursor up</span>
        <a href="#76946" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#76947" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#68550" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;closing cursor %d and commit txn %d&quot;)" class="string">&quot;closing cursor %d and commit txn %d&quot;</span>, <a href="#76836" title="Int">cursorId</a>, <a href="#76947" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Long">getId</span><span class="delimiter">)</span>
        <a href="#76837" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#71601" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#68568" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#76836" title="Int">cursorId</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span title="(_1: Boolean, _2: IndexedSeq[edu.berkeley.cs.scads.storage.Record])(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record])" class="delimiter">(</span><a href="#76949" title="Boolean">moreRecs</a>, <a href="#76950" title="IndexedSeq[edu.berkeley.cs.scads.storage.Record]">recs</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="comment">//logger.info(&quot;read %d recs, moreRecs = %s&quot;, recs.size, moreRecs)</span>
    
    <span title="(_1: Option[Int], _2: IndexedSeq[edu.berkeley.cs.scads.storage.Record])(Option[Int], IndexedSeq[edu.berkeley.cs.scads.storage.Record])" class="delimiter">(</span><span title="Option[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#76839" title="Boolean">moreRecs</a><span class="delimiter">)</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#76836" title="Int">cursorId</a><span class="delimiter">)</span> <span class="keyword">else</span> <span title="object None">None</span>, <a href="#76840" title="IndexedSeq[edu.berkeley.cs.scads.storage.Record]">recs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Delete [startKey, endKey)
   */</span>
  <span class="keyword">def</span> <a title="(txn: Option[com.sleepycat.je.Transaction])Unit" id="68594">deleteEntireRange</a><span class="delimiter">(</span><a title="Option[com.sleepycat.je.Transaction]" id="77011">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#68595" title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit">deleteRange</a><span class="delimiter">(</span><a href="#71814" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#71815" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#77011" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="comment">/**
   * Delete [lowerKey, upperKey)
   */</span>
  <span class="keyword">def</span> <a title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit" id="68595">deleteRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="77013">lowerKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="77014">upperKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[com.sleepycat.je.Transaction]" id="77015">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#68580" title="(key: Option[Array[Byte]])Boolean">isStartKeyLEQ</a><span class="delimiter">(</span><a href="#77013" title="Option[Array[Byte]]">lowerKey</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#68581" title="(key: Option[Array[Byte]])Boolean">isEndKeyGEQ</a><span class="delimiter">(</span><a href="#77014" title="Option[Array[Byte]]">upperKey</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;startKey &lt;= lowerKey &amp;&amp; endKey &gt;= upperKey required&quot;)" class="string">&quot;startKey &lt;= lowerKey &amp;&amp; endKey &gt;= upperKey required&quot;</span><span class="delimiter">)</span>
    <a href="#73138" title="Option[Int]" id="77024">iterateOverRange</a><span class="delimiter">(</span><a href="#77013" title="Option[Array[Byte]]" id="77019">lowerKey</a>, <a href="#77014" title="Option[Array[Byte]]" id="77020">upperKey</a>, txn = <a href="#77015" title="Option[com.sleepycat.je.Transaction]" id="77021">txn</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="77026">_</a>, <a title="com.sleepycat.je.DatabaseEntry" id="77027">_</a>, <a title="com.sleepycat.je.Cursor" id="77028">cursor</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#77028" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()com.sleepycat.je.OperationStatus">delete</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(cursor: com.sleepycat.je.Cursor)com.sleepycat.je.OperationStatus" id="68596">initCursor</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="76898">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="76901">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="76902">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#76898" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getFirst</span><span class="delimiter">(</span><a href="#76901" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#76902" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** returns (does the cursor still have more elements?, buffer) */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(cursor: com.sleepycat.je.Cursor, recsPerMessage: Int)(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record])" id="68597">advanceCursor</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="76956">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span>, <a title="Int" id="76957">recsPerMessage</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.storage.Record])" class="delimiter">(</span>Boolean, IndexedSeq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="77030">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="77031">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" id="77032">buf</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
    <a href="#77032" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">buf</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#76957" title="Int">recsPerMessage</a><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="77033">stat</a> = <a href="#76956" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#77030" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77031" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="77034">recs</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#77033" title="com.sleepycat.je.OperationStatus">stat</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#77034" title="Int">recs</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#76957" title="Int">recsPerMessage</a><span class="delimiter">)</span> <a href="#77036" title="()Unit" class="delimiter">{</a>
      <a href="#77032" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">buf</a> <span title="(elem: edu.berkeley.cs.scads.storage.Record)buf.type">+=</span> <a href="../Messages.scala.html#22238" title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.storage.Record">Record</a><span class="delimiter">(</span><a href="#77030" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span>, <a href="#77031" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<a href="#68558" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
      <a href="#77034" title="Int">recs</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <a href="#77033" title="com.sleepycat.je.OperationStatus">stat</a> = <a href="#76956" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#77030" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77031" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record])" id="77035">ret</a> = <span title="(_1: Boolean, _2: scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record])(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record])" class="delimiter">(</span><a href="#77033" title="com.sleepycat.je.OperationStatus">stat</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span>, <a href="#77032" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.storage.Record]">buf</a>.<span title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record]">toIndexedSeq</span><span class="delimiter">)</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#77035" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record])">ret</a>.<span title="=&gt; Boolean">_1</span> <span title="(x: Boolean)Boolean">||</span> <a href="#77035" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record])">ret</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record]">_2</span>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#76957" title="Int">recsPerMessage</a><span class="delimiter">)</span>
    <a href="#77035" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.storage.Record])">ret</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Low level method to iterate over a given range on the database. it is up
   * to the caller to validate minKey and maxKey. The range iterated over is
   * [minKey, maxKey), with the order specified by ascending (and limits
   * respected)
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit" id="68598">iterateOverRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="73130">minKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                               <a title="Option[Array[Byte]]" id="73131">maxKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                               <a title="Option[Int]" id="73138">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>, 
                               <a title="Option[Int]" id="73139">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>, 
                               <a title="Boolean" id="73140">ascending</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span>, 
                               <a title="Option[com.sleepycat.je.Transaction]" id="73141">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span>
      <span class="delimiter">(</span><a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit" id="73136">func</a>: <span class="delimiter">(</span>DatabaseEntry, DatabaseEntry, Cursor<span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#77190" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#77189" title="com.sleepycat.je.DatabaseEntry" id="77190">dbeKey</a>, <a href="#77189" title="com.sleepycat.je.DatabaseEntry" id="77191">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="77192">cur</a> = <a href="#71812" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><a href="#73141" title="Option[com.sleepycat.je.Transaction]">txn</a>.<span title="(implicit ev: &lt;:&lt;[Null,com.sleepycat.je.Transaction])com.sleepycat.je.Transaction">orNull</span>, <span title="object com.sleepycat.je.CursorConfig">CursorConfig</span>.<span title="com.sleepycat.je.CursorConfig">READ_UNCOMMITTED</span><span class="delimiter">)</span>

    <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="77193">status</a>: <span title="com.sleepycat.je.OperationStatus">OperationStatus</span> = <span title="(_1: Boolean, _2: Option[Array[Byte]], _3: Option[Array[Byte]])(Boolean, Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#73140" title="Boolean">ascending</a>, <a href="#73130" title="Option[Array[Byte]]">minKey</a>, <a href="#73131" title="Option[Array[Byte]]">maxKey</a><span class="delimiter">)</span> <span title="com.sleepycat.je.OperationStatus" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="object None">None</span>, _<span class="delimiter">)</span> =&gt; <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getFirst</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="77239">startKey</a><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getSearchKeyRange</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#77239" title="Array[Byte]">startKey</a><span class="delimiter">)</span>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, _, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getLast</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, _, Some<span class="delimiter">(</span><a title="Array[Byte]" id="77249">startKey</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="comment">// Check if maxKey is past the last key in the database, if so start from the end</span>
        <span title="com.sleepycat.je.OperationStatus" class="keyword">if</span><span class="delimiter">(</span><a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getSearchKeyRange</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#77249" title="Array[Byte]">startKey</a><span class="delimiter">)</span>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value NOTFOUND)">NOTFOUND</span><span class="delimiter">)</span>
          <span class="comment">// no need to skip back one since the maxKey was not found anyways</span>
          <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getLast</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="comment">// need to check that the cursor is pointing to the first key that</span>
          <span class="comment">// is LESS THAN maxKey. getSearchKeyRange semantics only guarantee</span>
          <span class="comment">// that the cursor is pointing to the smallest key &gt;= maxKey</span>
          <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="77257">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#77257" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="server/KeyComparison.scala.html#76909" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#77249" title="Array[Byte]">startKey</a>, <a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
            <a href="#77257" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <a href="#77257" title="com.sleepycat.je.OperationStatus">status</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">var</span> <a title="Int" id="77194">toSkip</a> = <a href="#73139" title="Option[Int]">offset</a>.<span title="(default: =&gt; Int)Int">getOrElse</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="77195">returnedCount</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">!=</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#73140" title="Boolean">ascending</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#77194" title="Int">toSkip</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <a href="#77283" title="()Unit" class="delimiter">{</a>
        <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#77194" title="Int">toSkip</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
        <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#68576" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="(op: =&gt; Unit)Unit">breakable</span> <span class="delimiter">{</span> <span class="comment">// used to allow func to break out early</span>
        <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#73138" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="#77312" title="Int">_</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#77195" title="Int">returnedCount</a><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#73131" title="Option[Array[Byte]]">maxKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="77327">mk</a> =&gt; <a href="server/KeyComparison.scala.html#76909" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span>, <a href="#77327" title="Array[Byte]">mk</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span class="comment">/* Exclude maxKey from range */</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#77302" title="()Unit" class="delimiter">{</a>
                <a href="#73136" title="(v1: com.sleepycat.je.DatabaseEntry, v2: com.sleepycat.je.DatabaseEntry, v3: com.sleepycat.je.Cursor)Unit">func</a><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <a href="#77192" title="com.sleepycat.je.Cursor">cur</a><span class="delimiter">)</span>
                <a href="#77195" title="Int">returnedCount</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
                <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#77194" title="Int">toSkip</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <a href="#77349" title="()Unit" class="delimiter">{</a>
        <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#77194" title="Int">toSkip</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
        <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#68576" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="(op: =&gt; Unit)Unit">breakable</span> <span class="delimiter">{</span> <span class="comment">// used to allow func to break out early</span>
        <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#73138" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="#77378" title="Int">_</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#77195" title="Int">returnedCount</a><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#73130" title="Option[Array[Byte]]">minKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="server/KeyComparison.scala.html#76909" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#77391" title="Array[Byte]">_</a>, <a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#77368" title="()Unit" class="delimiter">{</a>
                <a href="#73136" title="(v1: com.sleepycat.je.DatabaseEntry, v2: com.sleepycat.je.DatabaseEntry, v3: com.sleepycat.je.Cursor)Unit">func</a><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>,<a href="#77192" title="com.sleepycat.je.Cursor">cur</a><span class="delimiter">)</span>
                <a href="#77195" title="Int">returnedCount</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
                <a href="#77193" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#77190" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#77191" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#77192" title="com.sleepycat.je.Cursor">cur</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>