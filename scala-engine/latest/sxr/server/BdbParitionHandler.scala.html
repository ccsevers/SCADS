<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>server/BdbParitionHandler.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> com.sleepycat.je.<span class="delimiter">{</span>Cursor,Database, DatabaseConfig, CursorConfig, DatabaseException, DatabaseEntry, Environment, LockMode, OperationStatus, Durability, Transaction<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.scads.config._
<span class="keyword">import</span> edu.berkeley.cs.scads.util._

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> scala.util.control.Breaks

<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>
<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span> Future =&gt; JFuture, _ <span class="delimiter">}</span>
<span class="keyword">import</span> java.lang.reflect.Method
<span class="keyword">import</span> java.io.<span class="delimiter">{</span>BufferedReader,ObjectInputStream,InputStreamReader,ByteArrayInputStream<span class="delimiter">}</span>
<span class="keyword">import</span> atomic._

<span class="keyword">import</span> edu.berkeley.cs.avro.runtime.ScalaSpecificRecord



<span class="comment">/**
 * Handles a partition from [startKey, endKey). Refuses to service any
 * requests which fall out of this range, by returning a ProcessingException
 */</span>
<span class="keyword">class</span> <a title="class BdbStorageManager extends java.lang.Object with edu.berkeley.cs.scads.storage.StorageManager with edu.berkeley.cs.scads.storage.AvroComparator with ScalaObject" id="9756">BdbStorageManager</a><a href="#9756" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="68959">db</a>: <span title="com.sleepycat.je.Database">Database</span>, 
                        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68960">partitionIdLock</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, 
                        <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="68961">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                        <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="68962">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68963">nsRoot</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, 
                        <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="68964">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="org.apache.avro.Schema" id="68965">valueSchema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> 
                       <span class="keyword">extends</span> <a href="PartitionHandler.scala.html#9818" title="edu.berkeley.cs.scads.storage.StorageManager">StorageManager</a>
                       <span class="keyword">with</span>    <a href="KeyComparison.scala.html#9803" title="edu.berkeley.cs.scads.storage.AvroComparator">AvroComparator</a> <span class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="65789">logger</a> = <span title="(name: String)net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BdbStorageManager&quot;)" class="string">&quot;BdbStorageManager&quot;</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.configgy.Config" id="65791">config</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]" id="65794">copyIteratorCtor</a> = 
    <a href="#65791" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String)Option[String]">getString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.storage.copy.iteratorType&quot;)" class="string">&quot;scads.storage.copy.iteratorType&quot;</span><span class="delimiter">)</span>.<span title="(f: String =&gt; Option[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]])Option[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]]">flatMap</span><span class="delimiter">(</span><a title="String" id="66912">tpe</a> =&gt; <a href="#66912" title="String">tpe</a>.<span title="()java.lang.String">toLowerCase</span> <span title="Option[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator]" class="string">&quot;cursor&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator)Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <span title="edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#9791" title="edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator">CursorBasedPartitionIterator</a><span class="delimiter">(</span><a href="#66986" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#66987" title="Option[Array[Byte]]">minKey</a>, <a href="#66988" title="Option[Array[Byte]]">maxKey</a>, <a href="#65795" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator]" class="string">&quot;actorfree&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator)Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <span title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#9788" title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator">ActorlessPartitionIterator</a><span class="delimiter">(</span><a href="#67024" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#67025" title="Option[Array[Byte]]">minKey</a>, <a href="#67026" title="Option[Array[Byte]]">maxKey</a>, <a href="#65795" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.PartitionIterator]" class="string">&quot;actorbased&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.PartitionIterator)Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.PartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <a href="Iterator.scala.html#67072" title="edu.berkeley.cs.scads.storage.PartitionIterator" class="keyword">new</a> <a href="Iterator.scala.html#9794" title="edu.berkeley.cs.scads.storage.PartitionIterator">PartitionIterator</a><span class="delimiter">(</span><a href="#67031" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#67032" title="Option[Array[Byte]]">minKey</a>, <a href="#67033" title="Option[Array[Byte]]">maxKey</a>, <a href="#65795" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="None.type" id="67076">invalid</a> =&gt; 
        <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;copy iterator type %s is invalid&quot;)" class="string">&quot;copy iterator type %s is invalid&quot;</span>, <a href="#67076" title="java.lang.String">invalid</a><span class="delimiter">)</span>
        <span title="object None">None</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(default: =&gt; (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record])(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]">getOrElse</span><span class="delimiter">(</span><span class="delimiter">{</span>
        <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Using standard ActorlessPartitionIterator&quot;)" class="string">&quot;Using standard ActorlessPartitionIterator&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
          <span title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#9788" title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator">ActorlessPartitionIterator</a><span class="delimiter">(</span><a href="#67577" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#67578" title="Option[Array[Byte]]">minKey</a>, <a href="#67579" title="Option[Array[Byte]]">maxKey</a>, <a href="#65795" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Int" id="65796">copyRecsPerMessage</a> = <a href="#65791" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String, defaultValue: Int)Int">getInt</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.storage.copy.recsPerMessage&quot;)" class="string">&quot;scads.storage.copy.recsPerMessage&quot;</span>, <span title="Int(8192)" class="int">8192</span><span class="delimiter">)</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="65797">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="65799">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="67017">a</a>: <a href="#65799" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#67017" title="A">a</a><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="Int" id="65800">cursorTimeout</a> = <span class="int">3</span> * <span class="int">60</span> <span title="Int(180000)">*</span> <span class="int">1000</span> <span class="comment">// 3 minutes (in ms)</span>

  case <span class="keyword">class</span> <a title="class CursorContext extends java.lang.Object with ScalaObject with Product with Serializable" id="68730">CursorContext</a><a href="#68730" title="ScalaObject" class="delimiter">(</a><a title="Int" id="74088">cursorId</a>: <span title="Int">Int</span>, <a title="com.sleepycat.je.Cursor" id="74089">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span>, <a title="com.sleepycat.je.Transaction" id="74090">txn</a>: <span title="com.sleepycat.je.Transaction">Transaction</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Long" id="68742">lastActivity</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="68745">valid</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span class="keyword">def</span> <a title="()Unit" id="68747">updateActivity</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <a href="#68742" title="(x$1: Long)Unit">lastActivity</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">def</span> <a title="()Unit" id="68748">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
      <a href="#68745" title="(x$1: Boolean)Unit">valid</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="68749">isTimedout</a>: <span title="Boolean">Boolean</span> = <span class="delimiter">(</span><a href="#68742" title="=&gt; Long">lastActivity</a> <span title="(x: Int)Long">+</span> <a href="#65800" title="=&gt; Int">cursorTimeout</a><span class="delimiter">)</span> <span title="(x: Long)Long">-</span> <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="68750">isValid</a>: <span title="Boolean">Boolean</span> = <a href="#68745" title="=&gt; Boolean">valid</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicInteger" id="65805">cursorIdGen</a> = <span title="()java.util.concurrent.atomic.AtomicInteger" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]" id="65807">openCursors</a> = <span title="()java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">ConcurrentHashMap</span><span class="delimiter">[</span>Int, CursorContext<span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="65809">cursorTimeoutThread</a> = <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newSingleThreadExecutor</span>

  <span class="keyword">protected</span> <span class="keyword">object</span> <a title="object BdbStorageManager.this.CursorTimeoutRunnable" id="65811">CursorTimeoutRunnable</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">val</span> <a title="runnable extends java.lang.Object with java.lang.Runnable" id="69074">runnable</a> = <a href="#69077" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="69077">Runnable</a> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="()Unit" id="69079">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
        <span class="keyword">try</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <a href="#69083" title="()Unit" class="delimiter">{</a>
            <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#65800" title="=&gt; Long">cursorTimeout</a><span class="delimiter">)</span> <span class="comment">// runs every 3 min</span>
            <span class="keyword">val</span> <a title="Iterable[Int]" id="69084">toRemove</a> = <a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(i: java.util.Collection[BdbStorageManager.this.CursorContext])Iterable[BdbStorageManager.this.CursorContext]">values</span>.<span title="(f: BdbStorageManager.this.CursorContext =&gt; scala.collection.GenTraversableOnce[Int])(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[BdbStorageManager.this.CursorContext],Int,Iterable[Int]])Iterable[Int]">flatMap</span> <a href="#69333" title="List[Int]" class="delimiter">{</a>
              <span class="keyword">case</span> <a title="List[Int]" id="69334">ctx</a> @ CursorContext<span class="delimiter">(</span><a title="Int" id="69335">id</a>, <a title="com.sleepycat.je.Cursor" id="69336">cursor</a>, <a title="com.sleepycat.je.Transaction" id="69337">txn</a><span class="delimiter">)</span> =&gt;
                <a href="#69334" title="BdbStorageManager.this.CursorContext">ctx</a>.<span title="(x$1: List[Int])List[Int]">synchronized</span> <span class="delimiter">{</span>
                  <span title="List[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#69334" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68750" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span title="List[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#69334" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68749" title="=&gt; Boolean">isTimedout</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                      <a href="#69336" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
                      <a href="#69337" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                      <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor %d closed and marked invalid by cleanup thread&quot;)" class="string">&quot;Cursor %d closed and marked invalid by cleanup thread&quot;</span>, <a href="#69335" title="Int">id</a><span class="delimiter">)</span>
                      <a href="#69334" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68748" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
                      <span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#69335" title="Int">id</a><span class="delimiter">)</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="object Nil">Nil</span>
                  <span class="delimiter">}</span> <span class="keyword">else</span> <span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#69335" title="Int">id</a><span class="delimiter">)</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#69084" title="Iterable[Int]">toRemove</a>.<span title="(f: Int =&gt; BdbStorageManager.this.CursorContext)Unit">foreach</span><span class="delimiter">(</span><a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#69428" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="69432">e</a>: <span title="java.lang.InterruptedException">InterruptedException</span> =&gt;
            <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor timeout thread got signal to shutdown&quot;)" class="string">&quot;Cursor timeout thread got signal to shutdown&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#65809" title="=&gt; java.util.concurrent.ExecutorService">cursorTimeoutThread</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#69074" title="=&gt; java.lang.Object with java.lang.Runnable">runnable</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="65813">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span> <span class="comment">/* No-op */</span> <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="()Unit" id="65814">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// stop the cursor tasks</span>
    <a href="#65809" title="=&gt; java.util.concurrent.ExecutorService">cursorTimeoutThread</a>.<span title="()java.util.List[java.lang.Runnable]">shutdownNow</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#68960" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(i: java.util.Collection[BdbStorageManager.this.CursorContext])Iterable[BdbStorageManager.this.CursorContext]">values</span>.<span title="(f: BdbStorageManager.this.CursorContext =&gt; Unit)Unit">foreach</span> <a href="#69732" title="Unit" class="delimiter">{</a> 
      <span class="keyword">case</span> <a title="Unit" id="69733">ctx</a> @ CursorContext<span class="delimiter">(</span><a title="Int" id="69734">id</a>, <a title="com.sleepycat.je.Cursor" id="69735">cursor</a>, <a title="com.sleepycat.je.Transaction" id="69736">txn</a><span class="delimiter">)</span> =&gt;
        <a href="#69733" title="BdbStorageManager.this.CursorContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#69733" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68750" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#69735" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#69736" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor %d closed and marked invalid by shutdown task&quot;)" class="string">&quot;Cursor %d closed and marked invalid by shutdown task&quot;</span>, <a href="#69734" title="Int">id</a><span class="delimiter">)</span>
            <a href="#69733" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68748" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.util.control.Breaks" id="65815">iterateRangeBreakable</a> = <span title="scala.util.control.Breaks" class="keyword">new</span> <span title="scala.util.control.Breaks">Breaks</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="65817">toString</a> = 
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&lt;PartitionHandler namespace: %s, keyRange: [%s, %s)&gt;&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span>
      <a href="#68960" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#68961" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#68962" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * True iff a particular (non-null) key is bounded by [startKey, endKey)
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Boolean" id="65818">isInRange</a><span class="delimiter">(</span><a title="Array[Byte]" id="69775">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">//just for the moment because of the Hash partitioning</span>
  <span class="comment">//TODO: I turned of the check, for the hash partitiong. Though, this is really dangerous and can cause hard to find bugs.</span>
  <span class="comment">//We should make the starte aware of the routing, and fix it as soon as possible.</span>
  <span class="comment">//  startKey.map(sk =&gt; compare(sk, key) &lt;= 0).getOrElse(true) &amp;&amp;</span>
  <span class="comment">//  endKey.map(ek =&gt; compare(ek, key) &gt; 0).getOrElse(true)</span>

  <span class="comment">/**
   * True iff startKey &lt;= key
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Option[Array[Byte]])Boolean" id="65819">isStartKeyLEQ</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="69778">key</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = 
    <a href="#68961" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69785">sk</a> =&gt; <span class="comment">/* If we have startKey that is not -INF */</span>
        <a href="#69778" title="Option[Array[Byte]]">key</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69790">usrKey</a> =&gt; <span class="comment">/* If we have a user key that is not -INF */</span>
          <a href="KeyComparison.scala.html#65848" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#69785" title="Array[Byte]">sk</a>, <a href="#69790" title="Array[Byte]">usrKey</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">/* Both keys exist (not -INF), use compare to check range */</span>
        .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">/* startKey not -INF, but user key is -INF, so false */</span>
    .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">/* startKey is -INF, so any user key works */</span>

  <span class="comment">/**
   * True iff endKey &gt;= key
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Option[Array[Byte]])Boolean" id="65820">isEndKeyGEQ</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="69824">key</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="#68962" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69831">ek</a> =&gt; <span class="comment">/* If we have endKey that is not +INF */</span>
        <a href="#69824" title="Option[Array[Byte]]">key</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69836">usrKey</a> =&gt; <span class="comment">/* If we have a user key that is not +INF */</span>
          <a href="KeyComparison.scala.html#65848" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#69831" title="Array[Byte]">ek</a>, <a href="#69836" title="Array[Byte]">usrKey</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">/* Both keys exist (not +INF), use compare to check range */</span>
        .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">/* endKey not +INF, but user key is +INF, so false */</span>
    .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">/* startKey is +INF, so any user key works */</span>

                        

    <span class="comment">// key validation</span>
    <span class="comment">// val (keysInRange, keysInQuestion) = msg match {</span>
    <span class="comment">//   /* GetRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case GetRequest(key) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   /* PutRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case PutRequest(key, _) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   /* Requires startKey &lt;= minKey and endKey &gt;= maxKey (so specifying the</span>
    <span class="comment">//    * entire range is allowed */</span>
    <span class="comment">//   case GetRangeRequest(minKey, maxKey, _, _, _) =&gt;</span>
    <span class="comment">//     (isStartKeyLEQ(minKey) &amp;&amp; isEndKeyGEQ(maxKey), Right((minKey, maxKey)))</span>
    <span class="comment">//   /* Requires startKey &lt;= minKey and endKey &gt;= maxKey (so specifying the</span>
    <span class="comment">//    * entire range is allowed */</span>
    <span class="comment">//   case CountRangeRequest(minKey, maxKey) =&gt;</span>
    <span class="comment">//     (isStartKeyLEQ(minKey) &amp;&amp; isEndKeyGEQ(maxKey), Right((minKey, maxKey)))</span>
    <span class="comment">//   /* TestSetRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case TestSetRequest(key, _, _) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   case _ =&gt; (true, null)</span>
    <span class="comment">// }</span>

      <span class="comment">// val errorMsg = keysInQuestion match {</span>
      <span class="comment">//   case Left(key) =&gt;</span>
      <span class="comment">//     &quot;Expected a key in range [%s, %s), but got %s&quot;.format(</span>
      <span class="comment">//       JArrays.toString(startKey.orNull), </span>
      <span class="comment">//       JArrays.toString(endKey.orNull), </span>
      <span class="comment">//       JArrays.toString(key))</span>
      <span class="comment">//   case Right((minKey, maxKey)) =&gt;</span>
      <span class="comment">//     &quot;Expected a range bounded (inclusively) by [%s, %s), but got [%s, %s)&quot;.format(</span>
      <span class="comment">//       JArrays.toString(startKey.orNull),</span>
      <span class="comment">//       JArrays.toString(endKey.orNull),</span>
      <span class="comment">//       JArrays.toString(minKey.orNull),</span>
      <span class="comment">//       JArrays.toString(maxKey.orNull))</span>
      <span class="comment">// }</span>
      <span class="comment">// logger.error(&quot;Received errorneous request %s. Error was: %s&quot;, msg, errorMsg)</span>
      <span class="comment">// reply(RequestRejected(&quot;Key(s) are out of range: %s&quot;.format(errorMsg), msg))</span>


   <span class="keyword">def</span> <a title="(key: Array[Byte])Option[Array[Byte]]" id="65821">get</a><span class="delimiter">(</span><a title="Array[Byte]" id="69857">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
     <span class="keyword">val</span> <a href="#69861" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#69860" title="com.sleepycat.je.DatabaseEntry" id="69861">dbeKey</a>, <a href="#69860" title="com.sleepycat.je.DatabaseEntry" id="69862">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69857" title="Array[Byte]">key</a><span class="delimiter">)</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
     <span class="comment">//try { db.get(null, dbeKey, dbeValue, LockMode.READ_COMMITTED) } catch { case e:com.sleepycat.je.LockTimeoutException =&gt; logger.warning(&quot;lock timeout during GetRequest&quot;) }</span>
     <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry, x$4: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">get</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#69861" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#69862" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, LockMode.<span title="com.sleepycat.je.LockMode(value READ_COMMITTED)">READ_COMMITTED</span><span class="delimiter">)</span>
     <span title="(x: Array[Byte])Option[Array[Byte]]">Option</span><span class="delimiter">(</span><a href="#69862" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
   <span class="delimiter">}</span>


  <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])Unit" id="65822">put</a><span class="delimiter">(</span><a title="Array[Byte]" id="69944">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>,<a title="Option[Array[Byte]]" id="69945">value</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#69945" title="Option[Array[Byte]]">value</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="69950">v</a><span class="delimiter">)</span> =&gt; <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span title="Unit" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69944" title="Array[Byte]">key</a><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69950" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span title="Unit" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69944" title="Array[Byte]">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]], expectedValue: Option[Array[Byte]])Boolean" id="65823">testAndSet</a><span class="delimiter">(</span><a title="Array[Byte]" id="69957">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="69958">value</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="69959">expectedValue</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="69964">txn</a> = <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="69965">dbeKey</a> = <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69957" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="69966">dbeCurrentValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry, x$4: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">get</span><span class="delimiter">(</span><a href="#69964" title="com.sleepycat.je.Transaction">txn</a>, <a href="#69965" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#69966" title="com.sleepycat.je.DatabaseEntry">dbeCurrentValue</a>, LockMode.<span title="com.sleepycat.je.LockMode(value READ_COMMITTED)">READ_COMMITTED</span><span class="delimiter">)</span>
    <span title="Boolean" class="keyword">if</span><span class="delimiter">(</span><span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte], x$2: Array[Byte])Boolean">equals</span><span class="delimiter">(</span><a href="#69959" title="Option[Array[Byte]]">expectedValue</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span>, <a href="#69966" title="com.sleepycat.je.DatabaseEntry">dbeCurrentValue</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">{</span>
      <a href="#69958" title="Option[Array[Byte]]">value</a> <span title="com.sleepycat.je.OperationStatus" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="70022">v</a><span class="delimiter">)</span> =&gt; <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#69964" title="com.sleepycat.je.Transaction">txn</a>, <a href="#69965" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70022" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus">None</span> =&gt; <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#69964" title="com.sleepycat.je.Transaction">txn</a>, <a href="#69965" title="com.sleepycat.je.DatabaseEntry">dbeKey</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#69964" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#69964" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">abort</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(parser: edu.berkeley.cs.scads.storage.RecParser, locations: Seq[String])Unit" id="65824">bulkUrlPut</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecParser" id="70027">parser</a>:<a href="PartitionHandler.scala.html#9816" title="edu.berkeley.cs.scads.storage.RecParser">RecParser</a>, <a title="Seq[String]" id="70028">locations</a>:<span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="70032">txn</a> = <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>,<span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#70028" title="Seq[String]">locations</a> <span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="70049">location</a> =&gt; <span class="delimiter">{</span>
      <a href="#70027" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49885" title="(location: String)Unit">setLocation</a><span class="delimiter">(</span><a href="#70049" title="String">location</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.net.URL" id="70050">url</a> = <span title="(x$1: java.lang.String)java.net.URL" class="keyword">new</span> java.net.<span title="java.net.URL">URL</span><span class="delimiter">(</span><a href="#70049" title="String">location</a><span class="delimiter">)</span>
      <a href="#70027" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49886" title="(in: java.io.InputStream)Unit">setInput</a><span class="delimiter">(</span><a href="#70050" title="java.net.URL">url</a>.<span title="()java.io.InputStream">openStream</span><span class="delimiter">)</span>
      <span class="keyword">var</span> <a title="(AnyRef, AnyRef)" id="70051">kv</a> = <a href="#70027" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49887" title="()(AnyRef, AnyRef)">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#70051" title="(AnyRef, AnyRef)">kv</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#70180" title="()Unit" class="delimiter">{</a>
        <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#70032" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70051" title="(AnyRef, AnyRef)">kv</a>.<span title="=&gt; AnyRef">_1</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70051" title="(AnyRef, AnyRef)">kv</a>.<span title="=&gt; AnyRef">_2</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#70051" title="(AnyRef, AnyRef)">kv</a> = <a href="#70027" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49887" title="()(AnyRef, AnyRef)">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#70032" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// exception here will get caught above</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(records: Seq[edu.berkeley.cs.scads.comm.PutRequest])Unit" id="65825">bulkPut</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PutRequest]" id="70195">records</a>:<span title="Seq[edu.berkeley.cs.scads.comm.PutRequest]">Seq</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="70198">txn</a> = <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="70199">reccount</a> = <span title="Int(0)" class="int">0</span>
    <a href="#70195" title="Seq[edu.berkeley.cs.scads.comm.PutRequest]">records</a>.<span title="(f: edu.berkeley.cs.scads.comm.PutRequest =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PutRequest" id="70216">rec</a> =&gt; <span class="delimiter">{</span> <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#70198" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70216" title="edu.berkeley.cs.scads.comm.PutRequest">rec</a>.<span title="=&gt; Array[Byte]">key</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70216" title="edu.berkeley.cs.scads.comm.PutRequest">rec</a>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span><span class="delimiter">)</span>; <a href="#70199" title="Int">reccount</a><span title="(x: Int)Int">+=</span><span title="Int(1)" class="int">1</span><span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#70198" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>  <span class="comment">// exception here will get caught above</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[edu.berkeley.cs.scads.comm.Record]" id="65826">getRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70228">minKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="70229">maxKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="70230">limit</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="70231">offset</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="70232">ascending</a>:<span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Seq[edu.berkeley.cs.scads.comm.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] GetRangeRequest: [%s, %s)&quot;)" class="string">&quot;[%s] GetRangeRequest: [%s, %s)&quot;</span>, <a href="#9756" title="edu.berkeley.cs.scads.storage.BdbStorageManager" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#70228" title="Option[Array[Byte]]">minKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#70229" title="Option[Array[Byte]]">maxKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="70239">records</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
    <a href="#70230" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Unit)Option[Unit]">map</span><span class="delimiter">(</span><a href="#70239" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#70272" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#65837" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#70228" title="Option[Array[Byte]]">minKey</a>, <a href="#70229" title="Option[Array[Byte]]">maxKey</a>, <a href="#70230" title="Option[Int]">limit</a>, <a href="#70231" title="Option[Int]">offset</a>, <a href="#70232" title="Boolean">ascending</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="70297">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="70298">value</a>, <a title="com.sleepycat.je.Cursor" id="70299">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#70239" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a> <span title="(elem: edu.berkeley.cs.scads.comm.Record)records.type">+=</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.Record">Record</span><span class="delimiter">(</span><a href="#70297" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>, <a href="#70298" title="com.sleepycat.je.DatabaseEntry">value</a>.<a href="#65797" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="comment">// reccount commented out b/c its not being used and it causes each</span>
    <span class="comment">// GetRangeRequest to be a lot slower</span>
    <span class="comment">//var reccount = 0</span>
    <span class="comment">//iterateOverRange(minKey, maxKey)((_,_,_) =&gt; reccount += 1)</span>
    <a href="#70239" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(ranges: Seq[edu.berkeley.cs.scads.comm.MessageBody])scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]" id="65827">getBatch</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageBody]" id="70318">ranges</a>:<span title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">Seq</span><span class="delimiter">[</span>MessageBody<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">ArrayBuffer</span><span class="delimiter">[</span>GetRangeResponse<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]" id="70321">results</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">ArrayBuffer</span><span class="delimiter">[</span>GetRangeResponse<span class="delimiter">]</span>
    <a href="#70321" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">results</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#70318" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <a href="#70318" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageBody =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse])Unit">foreach</span> <a href="#70348" title="results.type" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="results.type">GetRangeRequest</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70350">minKey</a>, <a title="Option[Array[Byte]]" id="70351">maxKey</a>, <a title="Option[Int]" id="70352">limit</a>, <a title="Option[Int]" id="70353">offset</a>, <a title="Boolean" id="70354">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="70355">records</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
        <a href="#70352" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Unit)Option[Unit]">map</span><span class="delimiter">(</span><a href="#70355" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#70362" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#65837" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#70350" title="Option[Array[Byte]]">minKey</a>, <a href="#70351" title="Option[Array[Byte]]">maxKey</a>, <a href="#70352" title="Option[Int]">limit</a>, <a href="#70353" title="Option[Int]">offset</a>, <a href="#70354" title="Boolean">ascending</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="70373">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="70374">value</a>, <a title="com.sleepycat.je.Cursor" id="70375">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#70355" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a> <span title="(elem: edu.berkeley.cs.scads.comm.Record)records.type">+=</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.Record">Record</span><span class="delimiter">(</span><a href="#70373" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>, <a href="#70374" title="com.sleepycat.je.DatabaseEntry">value</a>.<a href="#65797" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <a href="#70321" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">results</a> <span title="(elem: edu.berkeley.cs.scads.comm.GetRangeResponse)results.type">+=</span> <span title="(records: Seq[edu.berkeley.cs.scads.comm.Record])edu.berkeley.cs.scads.comm.GetRangeResponse">GetRangeResponse</span><span class="delimiter">(</span><a href="#70355" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BatchRequests only implemented for GetRange&quot;)" class="string">&quot;BatchRequests only implemented for GetRange&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#70321" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">results</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]])Int" id="65828">countRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70416">minKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="70417">maxKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Int">Int</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="70421">count</a> = <span title="Int(0)" class="int">0</span>
    <a href="#65837" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#70416" title="Option[Array[Byte]]">minKey</a>, <a href="#70417" title="Option[Array[Byte]]">maxKey</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="70429">_</a>,<a title="com.sleepycat.je.DatabaseEntry" id="70430">_</a>,<a title="com.sleepycat.je.Cursor" id="70431">_</a><span class="delimiter">)</span> =&gt; <a href="#70421" title="Int">count</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <a href="#70421" title="Int">count</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(src: edu.berkeley.cs.scads.comm.PartitionService, overwrite: Boolean)Unit" id="65829">copyData</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="70436">src</a>:<span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="Boolean" id="70437">overwrite</a>:<span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begin CopyDataRequest src = &quot;)" class="string">&quot;Begin CopyDataRequest src = &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#70436" title="edu.berkeley.cs.scads.comm.PartitionService">src</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;, overwrite = &quot;)" class="string">&quot;, overwrite = &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#70437" title="Boolean">overwrite</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="70441">txn</a> = <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="70442">dbeExistingValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="70443">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="70444">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Opening iterator for data copy&quot;)" class="string">&quot;Opening iterator for data copy&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Iterator[edu.berkeley.cs.scads.comm.Record]" id="70445">iter</a> = <a href="#65793" title="(v1: edu.berkeley.cs.scads.comm.PartitionService, v2: Option[Array[Byte]], v3: Option[Array[Byte]])Iterator[edu.berkeley.cs.scads.comm.Record]">copyIteratorCtor</a><span class="delimiter">(</span><a href="#70436" title="edu.berkeley.cs.scads.comm.PartitionService">src</a>, <a href="#68961" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#68962" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span> 

    <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Beginning copy&quot;)" class="string">&quot;Beginning copy&quot;</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="70446">numRec</a> = <span title="Int(0)" class="int">0</span>
    <a href="#70445" title="Iterator[edu.berkeley.cs.scads.comm.Record]">iter</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="70470">rec</a> =&gt; <span class="delimiter">{</span>
      <a href="#70443" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="(x$1: Array[Byte])Unit">setData</span><span class="delimiter">(</span><a href="#70470" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Array[Byte]">key</span><span class="delimiter">)</span>
      <a href="#70444" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<span title="(x$1: Array[Byte])Unit">setData</span><span class="delimiter">(</span><a href="#70470" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span>
      
      <span title="com.sleepycat.je.OperationStatus" class="keyword">if</span> <span class="delimiter">(</span><a href="#70437" title="Boolean">overwrite</a><span class="delimiter">)</span> <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#70441" title="com.sleepycat.je.Transaction">txn</a>, <a href="#70443" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#70444" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
      <span class="keyword">else</span> <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">putNoOverwrite</span><span class="delimiter">(</span><a href="#70441" title="com.sleepycat.je.Transaction">txn</a>, <a href="#70443" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#70444" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
      <span class="comment">// NOTE: was previously the code below, but putNoOverwrite seems</span>
      <span class="comment">// to give us the exact semantics we are looking for here (plus</span>
      <span class="comment">// possibly more efficient than a get() followed by a put())</span>
      <span class="comment">//if(db.get(txn, dbeKey, dbeExistingValue, LockMode.READ_COMMITTED) != OperationStatus.SUCCESS)</span>
      <span class="comment">//  db.put(txn, dbeKey, dbeValue)</span>

      <a href="#70446" title="Int">numRec</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70446" title="Int">numRec</a> <span title="(x: Int)Int">%</span> <span title="Int(10000)" class="int">10000</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;copied %d records so far&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#70446" title="Int">numRec</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Finished copying %d records&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#70446" title="Int">numRec</a><span class="delimiter">)</span><span class="delimiter">)</span>
    
    <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Beginning commit&quot;)" class="string">&quot;Beginning commit&quot;</span><span class="delimiter">)</span>
    <a href="#70441" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Ending commit&quot;)" class="string">&quot;Ending commit&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
                         
  <span class="keyword">def</span> <a title="()(Option[Array[Byte]], Option[Array[Byte]])" id="65830">getResponsibility</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#68961" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#68962" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(groups: Seq[String], keyType: String, valType: String, filters: Seq[edu.berkeley.cs.scads.comm.AggFilter], aggs: Seq[edu.berkeley.cs.scads.comm.AggOp])Seq[edu.berkeley.cs.scads.comm.GroupedAgg]" id="65831">applyAggregate</a><span class="delimiter">(</span><a title="Seq[String]" id="70512">groups</a>:<span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
                     <a title="String" id="70513">keyType</a>:<span title="String">String</span>,
                     <a title="String" id="70514">valType</a>:<span title="String">String</span>,
                     <a title="Seq[edu.berkeley.cs.scads.comm.AggFilter]" id="70515">filters</a>:<span title="Seq[edu.berkeley.cs.scads.comm.AggFilter]">Seq</span><span class="delimiter">[</span>AggFilter<span class="delimiter">]</span>,
                     <a title="Seq[edu.berkeley.cs.scads.comm.AggOp]" id="70516">aggs</a>:<span title="Seq[edu.berkeley.cs.scads.comm.AggOp]">Seq</span><span class="delimiter">[</span>AggOp<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Seq[edu.berkeley.cs.scads.comm.GroupedAgg]">Seq</span><span class="delimiter">[</span>GroupedAgg<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="70523">filterFunctions</a> = <a href="#70515" title="Seq[edu.berkeley.cs.scads.comm.AggFilter]">filters</a>.<span title="(f: edu.berkeley.cs.scads.comm.AggFilter =&gt; edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.AggFilter],edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]])Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.AggFilter" id="70552">f</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ObjectInputStream" id="70553">ois</a> = <span title="java.io.ObjectInputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectInputStream">ObjectInputStream</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#70552" title="edu.berkeley.cs.scads.comm.AggFilter">f</a>.<span title="=&gt; Array[Byte]">obj</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#70553" title="java.io.ObjectInputStream">ois</a>.<span title="()java.lang.Object">readObject</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="delimiter">[</span><a href="../util/AnalyticsUtils.scala.html#9873" title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Filter</a><span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="70524">filterPassed</a> = <span title="Boolean(true)" class="keyword">true</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="70525">aggregates</a> =
      <a href="#70516" title="Seq[edu.berkeley.cs.scads.comm.AggOp]">aggs</a>.<span title="(f: edu.berkeley.cs.scads.comm.AggOp =&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.AggOp],edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]])Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.AggOp" id="70729">aggOp</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.ObjectInputStream" id="70730">ois</a> = <span title="java.io.ObjectInputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectInputStream">ObjectInputStream</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#70729" title="edu.berkeley.cs.scads.comm.AggOp">aggOp</a>.<span title="=&gt; Array[Byte]">obj</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#70730" title="java.io.ObjectInputStream">ois</a>.<span title="()java.lang.Object">readObject</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="delimiter">[</span><a href="../util/AnalyticsUtils.scala.html#9878" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">RemoteAggregate</a><span class="delimiter">[</span>ScalaSpecificRecord,ScalaSpecificRecord,ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
            

    <span class="keyword">val</span> <a title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" id="70526">remKey</a> = <span title="object java.lang.Class">Class</span>.<span title="(x$1: java.lang.String)java.lang.Class[_]">forName</span><span class="delimiter">(</span><a href="#70513" title="String">keyType</a><span class="delimiter">)</span>.<span title="()?0">newInstance</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" id="70527">remVal</a> = <span title="object java.lang.Class">Class</span>.<span title="(x$1: java.lang.String)java.lang.Class[_]">forName</span><span class="delimiter">(</span><a href="#70514" title="String">valType</a><span class="delimiter">)</span>.<span title="()?0">newInstance</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>
    
    <span class="keyword">val</span> <a title="Seq[org.apache.avro.Schema]" id="70528">groupSchemas</a> = <a href="#70512" title="Seq[String]">groups</a>.<span title="(f: String =&gt; org.apache.avro.Schema)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],org.apache.avro.Schema,Seq[org.apache.avro.Schema]])Seq[org.apache.avro.Schema]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.Schema,Seq[org.apache.avro.Schema]]" class="delimiter">(</span><a href="#68965" title="org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#70775" title="String">_</a><span class="delimiter">)</span>.<span title="()org.apache.avro.Schema">schema</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[Int]" id="70529">groupInts</a> = <a href="#70512" title="Seq[String]">groups</a>.<span title="(f: String =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],Int,Seq[Int]])Seq[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Int,Seq[Int]]" class="delimiter">(</span><a href="#68965" title="org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#70805" title="String">_</a><span class="delimiter">)</span>.<span title="()Int">pos</span><span class="delimiter">)</span>
    
    <span class="keyword">var</span> <a title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="70530">groupMap</a>:<span title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">Map</span><span class="delimiter">[</span>CharSequence, scala.collection.mutable.ArraySeq<span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span class="keyword">var</span> <a title="Map[java.lang.CharSequence,Array[Byte]]" id="70531">groupBytesMap</a>:<span title="Map[java.lang.CharSequence,Array[Byte]]">Map</span><span class="delimiter">[</span>CharSequence, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span class="keyword">var</span> <a title="java.lang.CharSequence" id="70532">groupKey</a>:<span title="java.lang.CharSequence">CharSequence</span> = <span title="Null(null)" class="keyword">null</span>
    
    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="70533">aggVals</a>:<span title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Seq</span><span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70512" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// no groups, so let's init values now</span>
      <a href="#70533" title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">aggVals</a> = <a href="#70525" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="(f: edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]])Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="delimiter">(</span><a href="#71131" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_</a>.<a href="../util/AnalyticsUtils.scala.html#26761" title="()edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">init</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#70530" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a> = <span title="scala.collection.immutable.HashMap[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="keyword">new</span> scala.collection.immutable.<span title="scala.collection.immutable.HashMap[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">HashMap</span><span class="delimiter">[</span>CharSequence,scala.collection.mutable.ArraySeq<span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
      <a href="#70531" title="Map[java.lang.CharSequence,Array[Byte]]">groupBytesMap</a> = <span title="scala.collection.immutable.HashMap[java.lang.CharSequence,Array[Byte]]" class="keyword">new</span> scala.collection.immutable.<span title="scala.collection.immutable.HashMap[java.lang.CharSequence,Array[Byte]]">HashMap</span><span class="delimiter">[</span>CharSequence, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="delimiter">}</span>
    
    <span class="keyword">var</span> <a title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="70534">curAggVal</a> =
      <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="keyword">if</span> <span class="delimiter">(</span><a href="#70512" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        scala.collection.mutable.<span title="(elems: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord*)scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ArraySeq</span><span class="delimiter">(</span><a href="#70533" title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">aggVals</a>:_*<span class="delimiter">)</span>
      <span class="keyword">else</span>
        <span title="Null(null)" class="keyword">null</span>

    <span class="keyword">var</span> <a title="Boolean" id="70535">stop</a> = <span title="Boolean(false)" class="keyword">false</span>

    <a href="#65837" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="71328">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="71329">value</a>, <a title="com.sleepycat.je.Cursor" id="71330">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// TODO: Use lazy values here</span>
      <span class="keyword">val</span> <a title="Array[Byte]" id="71331">valBytes</a> = <a href="#71329" title="com.sleepycat.je.DatabaseEntry">value</a>.<span title="()Array[Byte]">getData</span>
      <a href="#70527" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a>.<span title="(inputStream: java.io.InputStream)remVal.type">parse</span><span class="delimiter">(</span><span title="(x$1: Array[Byte], x$2: Int, x$3: Int)java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#71331" title="Array[Byte]">valBytes</a>,<span title="Int(16)" class="int">16</span>,<span class="delimiter">(</span><a href="#71331" title="Array[Byte]">valBytes</a>.<span title="=&gt; Int">length</span><span title="(x: Int)Int">-</span><span title="Int(16)" class="int">16</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Array[Byte]" id="71332">keyBytes</a> = <a href="#71328" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>
      <a href="#70526" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remKey</a>.<span title="(data: Array[Byte])remKey.type">parse</span><span class="delimiter">(</span><a href="#71332" title="Array[Byte]">keyBytes</a><span class="delimiter">)</span>
      
      <a href="#70524" title="Boolean">filterPassed</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#70523" title="Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">filterFunctions</a>.<span title="(f: edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="71363">ff</a> =&gt; <span class="delimiter">{</span> 
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70524" title="Boolean">filterPassed</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// once one failed just ignore the rest</span>
          <a href="#70524" title="Boolean">filterPassed</a> = <a href="#71363" title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ff</a>.<a href="../util/AnalyticsUtils.scala.html#24219" title="(r: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)Boolean">applyFilter</a><span class="delimiter">(</span><a href="#70527" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70524" title="Boolean">filterPassed</a><span class="delimiter">)</span> <span class="delimiter">{</span>  <span class="comment">// record passes filters</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70512" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#70532" title="java.lang.CharSequence">groupKey</a> = <a href="../util/AnalyticsUtils.scala.html#9882" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="../util/AnalyticsUtils.scala.html#26880" title="(groups: Seq[Int], rec: org.apache.avro.generic.IndexedRecord)java.lang.CharSequence">getGroupKey</a><span class="delimiter">(</span><a href="#70529" title="Seq[Int]">groupInts</a>,<a href="#70527" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
          <a href="#70534" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a> = <a href="#70530" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a>.<span title="(key: java.lang.CharSequence)Option[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">get</span><span class="delimiter">(</span><a href="#70532" title="java.lang.CharSequence">groupKey</a><span class="delimiter">)</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Some</span><span class="delimiter">(</span><a title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="71559">thing</a><span class="delimiter">)</span> =&gt; <a href="#71559" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">thing</a>
            <span class="keyword">case</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">None</span> =&gt; <span class="delimiter">{</span> <span class="comment">// this is a new group, so init the starting values for the agg</span>
              <a href="#70531" title="Map[java.lang.CharSequence,Array[Byte]]">groupBytesMap</a> <span title="(kv: (java.lang.CharSequence, Array[Byte]))scala.collection.immutable.Map[java.lang.CharSequence,Array[Byte]]">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.CharSequence, _2: Array[Byte])(java.lang.CharSequence, Array[Byte])" class="delimiter">(</span><a href="#70532" title="java.lang.CharSequence">groupKey</a>,<a href="../util/AnalyticsUtils.scala.html#9882" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="../util/AnalyticsUtils.scala.html#26877" title="(groups: Seq[Int], groupSchemas: Seq[org.apache.avro.Schema], rec: org.apache.avro.generic.IndexedRecord)Array[Byte]">getGroupBytes</a><span class="delimiter">(</span><a href="#70529" title="Seq[Int]">groupInts</a>,<a href="#70528" title="Seq[org.apache.avro.Schema]">groupSchemas</a>,<a href="#70527" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              scala.collection.mutable.<span title="(elems: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord*)scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ArraySeq</span><span class="delimiter">(</span><a href="#70525" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="(f: edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]])Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="delimiter">(</span><a href="#71682" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_</a>.<a href="../util/AnalyticsUtils.scala.html#26761" title="()edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">init</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>:_*<span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <a href="#70535" title="Boolean">stop</a> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#70525" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]">view</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]],(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),scala.collection.SeqView[(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),Seq[_]]])scala.collection.SeqView[(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),Seq[_]]">zipWithIndex</span> <span title="(f: (edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)" id="73265">aggregate</a> =&gt; <span class="delimiter">{</span>
          <a href="#70534" title="(idx: Int, elem: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)Unit">curAggVal</a><span class="delimiter">(</span><a href="#73265" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span> = <a href="#73265" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_1</span>.<a href="../util/AnalyticsUtils.scala.html#26762" title="(a: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord, k: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord, v: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">applyAggregate</a><span class="delimiter">(</span><a href="#70534" title="(idx: Int)edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">curAggVal</a><span class="delimiter">(</span><a href="#73265" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span>,<a href="#70526" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remKey</a>,<a href="#70527" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
          <a href="#70535" title="Boolean">stop</a> <span title="(x: Boolean)Boolean">&amp;=</span> <a href="#73265" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_1</span>.<a href="../util/AnalyticsUtils.scala.html#26757" title="=&gt; Boolean">stop</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70512" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
          <a href="#70530" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a> <span title="(kv: (java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]))scala.collection.immutable.Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.CharSequence, _2: scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])" class="delimiter">(</span><a href="#70532" title="java.lang.CharSequence">groupKey</a>,<a href="#70534" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70535" title="Boolean">stop</a><span class="delimiter">)</span>
          <a href="#65815" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="()Unit">break</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <span title="Seq[edu.berkeley.cs.scads.comm.GroupedAgg]" class="keyword">if</span> <span class="delimiter">(</span><a href="#70512" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(xs: edu.berkeley.cs.scads.comm.GroupedAgg*)List[edu.berkeley.cs.scads.comm.GroupedAgg]">List</span><span class="delimiter">(</span><span title="(group: Option[Array[Byte]], groupVals: Seq[Array[Byte]])edu.berkeley.cs.scads.comm.GroupedAgg">GroupedAgg</span><span class="delimiter">(</span><span title="object None">None</span>,<a href="#70534" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a>.<span title="(f: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq.Coll,Array[Byte],scala.collection.mutable.ArraySeq[Array[Byte]]]" class="delimiter">(</span><a href="#73755" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">_</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#70530" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a>.<span title="(f: (java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]) =&gt; edu.berkeley.cs.scads.comm.GroupedAgg)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.scads.comm.GroupedAgg,scala.collection.immutable.Iterable[edu.berkeley.cs.scads.comm.GroupedAgg]])scala.collection.immutable.Iterable[edu.berkeley.cs.scads.comm.GroupedAgg]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Iterable.Coll,edu.berkeley.cs.scads.comm.GroupedAgg,scala.collection.immutable.Iterable[edu.berkeley.cs.scads.comm.GroupedAgg]]" class="delimiter">(</span><a title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])" id="73853">kv</a> =&gt; <span class="delimiter">{</span>
        <span title="(group: Option[Array[Byte]], groupVals: Seq[Array[Byte]])edu.berkeley.cs.scads.comm.GroupedAgg">GroupedAgg</span><span class="delimiter">(</span><a href="#70531" title="(key: java.lang.CharSequence)Array[Byte]">groupBytesMap</a><a href="#65797" title="(a: Array[Byte])Option[Array[Byte]]" class="delimiter">(</a><a href="#73853" title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])">kv</a>.<span title="=&gt; java.lang.CharSequence">_1</span><span class="delimiter">)</span>,<a href="#73853" title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])">kv</a>.<span title="=&gt; scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_2</span>.<span title="(f: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq.Coll,Array[Byte],scala.collection.mutable.ArraySeq[Array[Byte]]]" class="delimiter">(</span><a href="#73896" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">_</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.GroupedAgg]">toSeq</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(optCursorId: Option[Int], recsPerMessage: Int)(Option[Int], IndexedSeq[edu.berkeley.cs.scads.comm.Record])" id="65832">cursorScan</a><span class="delimiter">(</span><a title="Option[Int]" id="74012">optCursorId</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Int" id="74013">recsPerMessage</a>:<span title="Int">Int</span><span class="delimiter">)</span>:<span title="(Option[Int], IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span>Option<span class="delimiter">[</span>Int<span class="delimiter">]</span>,IndexedSeq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74013" title="Int">recsPerMessage</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#9817" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Recs per message needs to be &gt; 0: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#74013" title="Int">recsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="runnable extends java.lang.Object with java.lang.Runnable" id="74015">dummy</a> = <a href="#65811" title="object BdbStorageManager.this.CursorTimeoutRunnable">CursorTimeoutRunnable</a>.<a href="#69074" title="=&gt; java.lang.Object with java.lang.Runnable">runnable</a> <span class="comment">// initialize it (lazily)</span>

    <span class="comment">//logger.info(&quot;CursorScanRequest: %s&quot;, msg)</span>

    <span class="keyword">val</span> <a href="#74017" title="(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</a><a href="#74016" title="Int" id="74017">cursorId</a>, <a href="#74016" title="BdbStorageManager.this.CursorContext" id="74018">cursorCtx</a><span class="delimiter">)</span> = <a href="#74012" title="Option[Int]">optCursorId</a>.<span title="(f: Int =&gt; (Int, BdbStorageManager.this.CursorContext))Option[(Int, BdbStorageManager.this.CursorContext)]">map</span><span class="delimiter">(</span><a title="Int" id="74037">id</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="BdbStorageManager.this.CursorContext" id="74038">ctx</a> = <span title="(x: BdbStorageManager.this.CursorContext)Option[BdbStorageManager.this.CursorContext]">Option</span><span class="delimiter">(</span><a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">get</span><span class="delimiter">(</span><a href="#74037" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; BdbStorageManager.this.CursorContext)BdbStorageManager.this.CursorContext">getOrElse</span><span class="delimiter">(</span><span class="delimiter">{</span> 
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#9817" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid cursor Id: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#74037" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span title="(_1: Int, _2: BdbStorageManager.this.CursorContext)(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</span><a href="#74037" title="Int">id</a>, <a href="#74038" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(default: =&gt; (Int, BdbStorageManager.this.CursorContext))(Int, BdbStorageManager.this.CursorContext)">getOrElse</span><span title="(Int, BdbStorageManager.this.CursorContext) @unchecked" class="delimiter">(</span><span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="74061">id</a> = <a href="#65805" title="=&gt; java.util.concurrent.atomic.AtomicInteger">cursorIdGen</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="74062">txn</a> = <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="74063">newCursor</a> = <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><a href="#74062" title="com.sleepycat.je.Transaction">txn</a>, <span title="object com.sleepycat.je.CursorConfig">CursorConfig</span>.<span title="com.sleepycat.je.CursorConfig">READ_UNCOMMITTED</span><span class="delimiter">)</span>
      <a href="#65835" title="(cursor: com.sleepycat.je.Cursor)com.sleepycat.je.OperationStatus">initCursor</a><span class="delimiter">(</span><a href="#74063" title="com.sleepycat.je.Cursor">newCursor</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="BdbStorageManager.this.CursorContext" id="74064">ctx</a> = <a href="#68730" title="(cursorId: Int, cursor: com.sleepycat.je.Cursor, txn: com.sleepycat.je.Transaction)BdbStorageManager.this.CursorContext">CursorContext</a><span class="delimiter">(</span><a href="#74061" title="Int">id</a>, <a href="#74063" title="com.sleepycat.je.Cursor">newCursor</a>, <a href="#74062" title="com.sleepycat.je.Transaction">txn</a><span class="delimiter">)</span>
      <a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Int, x$2: BdbStorageManager.this.CursorContext)BdbStorageManager.this.CursorContext">put</span><span class="delimiter">(</span><a href="#74061" title="Int">id</a>, <a href="#74064" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
      <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;made new cursor with id %d, txn with id %d&quot;)" class="string">&quot;made new cursor with id %d, txn with id %d&quot;</span>, <a href="#74061" title="Int">id</a>, <a href="#74062" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Long">getId</span><span class="delimiter">)</span>
      <span title="(_1: Int, _2: BdbStorageManager.this.CursorContext)(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</span><a href="#74061" title="Int">id</a>, <a href="#74064" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    
    <span class="comment">// lock the cursor context</span>
    <span class="keyword">val</span> <a href="#74020" title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</a><a href="#74019" title="Boolean" id="74020">moreRecs</a>, <a href="#74019" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="74021">recs</a><span class="delimiter">)</span> = <a href="#74018" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<span title="(x$1: (Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record]))(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])">synchronized</span> <span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record]) @unchecked" class="delimiter">{</span>
      <span class="comment">// check to see if the cursor is still valid</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#74018" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#68750" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#74017" title="Int">cursorId</a><span class="delimiter">)</span> <span class="comment">// just to be sure </span>
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#9817" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Cursor ID: %d has already timedout&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#74017" title="Int">cursorId</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#74018" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#68747" title="()Unit">updateActivity</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// set a new timeout</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="74127">cursor</a> = <a href="#74018" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#74089" title="=&gt; com.sleepycat.je.Cursor">cursor</a>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="74128">txn</a> = <a href="#74018" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#74090" title="=&gt; com.sleepycat.je.Transaction">txn</a>
      <span class="keyword">val</span> <a href="#74130" title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</a><a href="#74129" title="Boolean" id="74130">moreRecs</a>, <a href="#74129" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="74131">recs</a><span class="delimiter">)</span> = <a href="#65836" title="(cursor: com.sleepycat.je.Cursor, recsPerMessage: Int)(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])">advanceCursor</a><span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record]) @unchecked" class="delimiter">(</span><a href="#74127" title="com.sleepycat.je.Cursor">cursor</a>, <a href="#74013" title="Int">recsPerMessage</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#74130" title="Boolean">moreRecs</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// done, close this cursor up</span>
        <a href="#74127" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#74128" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#65789" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;closing cursor %d and commit txn %d&quot;)" class="string">&quot;closing cursor %d and commit txn %d&quot;</span>, <a href="#74017" title="Int">cursorId</a>, <a href="#74128" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Long">getId</span><span class="delimiter">)</span>
        <a href="#74018" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#68748" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#65807" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#74017" title="Int">cursorId</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span title="(_1: Boolean, _2: IndexedSeq[edu.berkeley.cs.scads.comm.Record])(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span><a href="#74130" title="Boolean">moreRecs</a>, <a href="#74131" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">recs</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="comment">//logger.info(&quot;read %d recs, moreRecs = %s&quot;, recs.size, moreRecs)</span>
    
    <span title="(_1: Option[Int], _2: IndexedSeq[edu.berkeley.cs.scads.comm.Record])(Option[Int], IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span><span title="Option[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#74020" title="Boolean">moreRecs</a><span class="delimiter">)</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#74017" title="Int">cursorId</a><span class="delimiter">)</span> <span class="keyword">else</span> <span title="object None">None</span>, <a href="#74021" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">recs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Delete [startKey, endKey)
   */</span>
  <span class="keyword">def</span> <a title="(txn: Option[com.sleepycat.je.Transaction])Unit" id="65833">deleteEntireRange</a><span class="delimiter">(</span><a title="Option[com.sleepycat.je.Transaction]" id="74212">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#65834" title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit">deleteRange</a><span class="delimiter">(</span><a href="#68961" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#68962" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#74212" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="comment">/**
   * Delete [lowerKey, upperKey)
   */</span>
  <span class="keyword">def</span> <a title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit" id="65834">deleteRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="74214">lowerKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="74215">upperKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[com.sleepycat.je.Transaction]" id="74216">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#65819" title="(key: Option[Array[Byte]])Boolean">isStartKeyLEQ</a><span class="delimiter">(</span><a href="#74214" title="Option[Array[Byte]]">lowerKey</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#65820" title="(key: Option[Array[Byte]])Boolean">isEndKeyGEQ</a><span class="delimiter">(</span><a href="#74215" title="Option[Array[Byte]]">upperKey</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;startKey &lt;= lowerKey &amp;&amp; endKey &gt;= upperKey required&quot;)" class="string">&quot;startKey &lt;= lowerKey &amp;&amp; endKey &gt;= upperKey required&quot;</span><span class="delimiter">)</span>
    <a href="#70290" title="Option[Int]" id="74225">iterateOverRange</a><span class="delimiter">(</span><a href="#74214" title="Option[Array[Byte]]" id="74220">lowerKey</a>, <a href="#74215" title="Option[Array[Byte]]" id="74221">upperKey</a>, txn = <a href="#74216" title="Option[com.sleepycat.je.Transaction]" id="74222">txn</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="74227">_</a>, <a title="com.sleepycat.je.DatabaseEntry" id="74228">_</a>, <a title="com.sleepycat.je.Cursor" id="74229">cursor</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#74229" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()com.sleepycat.je.OperationStatus">delete</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(cursor: com.sleepycat.je.Cursor)com.sleepycat.je.OperationStatus" id="65835">initCursor</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="74079">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74082">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74083">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#74079" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getFirst</span><span class="delimiter">(</span><a href="#74082" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74083" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** returns (does the cursor still have more elements?, buffer) */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(cursor: com.sleepycat.je.Cursor, recsPerMessage: Int)(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" id="65836">advanceCursor</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="74137">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span>, <a title="Int" id="74138">recsPerMessage</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span>Boolean, IndexedSeq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74231">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74232">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="74233">buf</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
    <a href="#74233" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">buf</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#74138" title="Int">recsPerMessage</a><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="74234">stat</a> = <a href="#74137" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74231" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74232" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="74235">recs</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#74234" title="com.sleepycat.je.OperationStatus">stat</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#74235" title="Int">recs</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#74138" title="Int">recsPerMessage</a><span class="delimiter">)</span> <a href="#74237" title="()Unit" class="delimiter">{</a>
      <a href="#74233" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">buf</a> <span title="(elem: edu.berkeley.cs.scads.comm.Record)buf.type">+=</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.Record">Record</span><span class="delimiter">(</span><a href="#74231" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span>, <a href="#74232" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<a href="#65797" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
      <a href="#74235" title="Int">recs</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <a href="#74234" title="com.sleepycat.je.OperationStatus">stat</a> = <a href="#74137" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#74231" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74232" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])" id="74236">ret</a> = <span title="(_1: Boolean, _2: scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span><a href="#74234" title="com.sleepycat.je.OperationStatus">stat</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span>, <a href="#74233" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">buf</a>.<span title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record]">toIndexedSeq</span><span class="delimiter">)</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#74236" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])">ret</a>.<span title="=&gt; Boolean">_1</span> <span title="(x: Boolean)Boolean">||</span> <a href="#74236" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])">ret</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record]">_2</span>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#74138" title="Int">recsPerMessage</a><span class="delimiter">)</span>
    <a href="#74236" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])">ret</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Low level method to iterate over a given range on the database. it is up
   * to the caller to validate minKey and maxKey. The range iterated over is
   * [minKey, maxKey), with the order specified by ascending (and limits
   * respected)
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit" id="65837">iterateOverRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70282">minKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                               <a title="Option[Array[Byte]]" id="70283">maxKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                               <a title="Option[Int]" id="70290">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>, 
                               <a title="Option[Int]" id="70291">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>, 
                               <a title="Boolean" id="70292">ascending</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span>, 
                               <a title="Option[com.sleepycat.je.Transaction]" id="70293">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span>
      <span class="delimiter">(</span><a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit" id="70288">func</a>: <span class="delimiter">(</span>DatabaseEntry, DatabaseEntry, Cursor<span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#74393" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#74392" title="com.sleepycat.je.DatabaseEntry" id="74393">dbeKey</a>, <a href="#74392" title="com.sleepycat.je.DatabaseEntry" id="74394">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="74395">cur</a> = <a href="#68959" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><a href="#70293" title="Option[com.sleepycat.je.Transaction]">txn</a>.<span title="(implicit ev: &lt;:&lt;[Null,com.sleepycat.je.Transaction])com.sleepycat.je.Transaction">orNull</span>, <span title="object com.sleepycat.je.CursorConfig">CursorConfig</span>.<span title="com.sleepycat.je.CursorConfig">READ_UNCOMMITTED</span><span class="delimiter">)</span>

    <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="74396">status</a>: <span title="com.sleepycat.je.OperationStatus">OperationStatus</span> = <span title="(_1: Boolean, _2: Option[Array[Byte]], _3: Option[Array[Byte]])(Boolean, Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#70292" title="Boolean">ascending</a>, <a href="#70282" title="Option[Array[Byte]]">minKey</a>, <a href="#70283" title="Option[Array[Byte]]">maxKey</a><span class="delimiter">)</span> <span title="com.sleepycat.je.OperationStatus" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="object None">None</span>, _<span class="delimiter">)</span> =&gt; <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getFirst</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="74442">startKey</a><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getSearchKeyRange</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74442" title="Array[Byte]">startKey</a><span class="delimiter">)</span>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, _, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getLast</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, _, Some<span class="delimiter">(</span><a title="Array[Byte]" id="74452">startKey</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="comment">// Check if maxKey is past the last key in the database, if so start from the end</span>
        <span title="com.sleepycat.je.OperationStatus" class="keyword">if</span><span class="delimiter">(</span><a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getSearchKeyRange</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74452" title="Array[Byte]">startKey</a><span class="delimiter">)</span>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value NOTFOUND)">NOTFOUND</span><span class="delimiter">)</span>
          <span class="comment">// no need to skip back one since the maxKey was not found anyways</span>
          <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getLast</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="comment">// need to check that the cursor is pointing to the first key that</span>
          <span class="comment">// is LESS THAN maxKey. getSearchKeyRange semantics only guarantee</span>
          <span class="comment">// that the cursor is pointing to the smallest key &gt;= maxKey</span>
          <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="74460">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#74460" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="KeyComparison.scala.html#65848" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#74452" title="Array[Byte]">startKey</a>, <a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
            <a href="#74460" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <a href="#74460" title="com.sleepycat.je.OperationStatus">status</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">var</span> <a title="Int" id="74397">toSkip</a> = <a href="#70291" title="Option[Int]">offset</a>.<span title="(default: =&gt; Int)Int">getOrElse</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="74398">returnedCount</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">!=</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#70292" title="Boolean">ascending</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74397" title="Int">toSkip</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <a href="#74486" title="()Unit" class="delimiter">{</a>
        <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#74397" title="Int">toSkip</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
        <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#65815" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="(op: =&gt; Unit)Unit">breakable</span> <span class="delimiter">{</span> <span class="comment">// used to allow func to break out early</span>
        <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70290" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="#74515" title="Int">_</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#74398" title="Int">returnedCount</a><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70283" title="Option[Array[Byte]]">maxKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="74530">mk</a> =&gt; <a href="KeyComparison.scala.html#65848" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span>, <a href="#74530" title="Array[Byte]">mk</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span class="comment">/* Exclude maxKey from range */</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#74505" title="()Unit" class="delimiter">{</a>
                <a href="#70288" title="(v1: com.sleepycat.je.DatabaseEntry, v2: com.sleepycat.je.DatabaseEntry, v3: com.sleepycat.je.Cursor)Unit">func</a><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <a href="#74395" title="com.sleepycat.je.Cursor">cur</a><span class="delimiter">)</span>
                <a href="#74398" title="Int">returnedCount</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
                <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74397" title="Int">toSkip</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <a href="#74552" title="()Unit" class="delimiter">{</a>
        <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#74397" title="Int">toSkip</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
        <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#65815" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="(op: =&gt; Unit)Unit">breakable</span> <span class="delimiter">{</span> <span class="comment">// used to allow func to break out early</span>
        <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70290" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="#74581" title="Int">_</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#74398" title="Int">returnedCount</a><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70282" title="Option[Array[Byte]]">minKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="KeyComparison.scala.html#65848" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#74594" title="Array[Byte]">_</a>, <a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#74571" title="()Unit" class="delimiter">{</a>
                <a href="#70288" title="(v1: com.sleepycat.je.DatabaseEntry, v2: com.sleepycat.je.DatabaseEntry, v3: com.sleepycat.je.Cursor)Unit">func</a><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>,<a href="#74395" title="com.sleepycat.je.Cursor">cur</a><span class="delimiter">)</span>
                <a href="#74398" title="Int">returnedCount</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
                <a href="#74396" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#74393" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74394" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#74395" title="com.sleepycat.je.Cursor">cur</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>