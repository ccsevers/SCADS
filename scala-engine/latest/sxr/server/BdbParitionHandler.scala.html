<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>server/BdbParitionHandler.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> com.sleepycat.je.<span class="delimiter">{</span>Cursor,Database, DatabaseConfig, CursorConfig, DatabaseException, DatabaseEntry, Environment, LockMode, OperationStatus, Durability, Transaction<span class="delimiter">}</span>
<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._
<span class="keyword">import</span> edu.berkeley.cs.scads.config._
<span class="keyword">import</span> edu.berkeley.cs.scads.util._

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer
<span class="keyword">import</span> org.apache.avro.generic._

<span class="keyword">import</span> scala.util.control.Breaks

<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>
<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span> Future =&gt; JFuture, _ <span class="delimiter">}</span>
<span class="keyword">import</span> java.lang.reflect.Method
<span class="keyword">import</span> java.io.<span class="delimiter">{</span>BufferedReader,ObjectInputStream,InputStreamReader,ByteArrayInputStream<span class="delimiter">}</span>
<span class="keyword">import</span> atomic._

<span class="keyword">import</span> edu.berkeley.cs.avro.runtime.ScalaSpecificRecord



<span class="comment">/**
 * Handles a partition from [startKey, endKey). Refuses to service any
 * requests which fall out of this range, by returning a ProcessingException
 */</span>
<span class="keyword">class</span> <a title="class BdbStorageManager extends java.lang.Object with edu.berkeley.cs.scads.storage.StorageManager with edu.berkeley.cs.scads.storage.AvroComparator with ScalaObject" id="9752">BdbStorageManager</a><a href="#9752" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="68952">db</a>: <span title="com.sleepycat.je.Database">Database</span>, 
                        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68953">partitionIdLock</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, 
                        <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="68954">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                        <span class="keyword">val</span> <a title="Option[Array[Byte]]" id="68955">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68956">nsRoot</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, 
                        <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="68957">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="org.apache.avro.Schema" id="68958">valueSchema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span> 
                       <span class="keyword">extends</span> <a href="PartitionHandler.scala.html#9814" title="edu.berkeley.cs.scads.storage.StorageManager">StorageManager</a>
                       <span class="keyword">with</span>    <a href="KeyComparison.scala.html#9799" title="edu.berkeley.cs.scads.storage.AvroComparator">AvroComparator</a> <span class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="65782">logger</a> = <span title="(name: String)net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BdbStorageManager&quot;)" class="string">&quot;BdbStorageManager&quot;</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.configgy.Config" id="65784">config</a> = <span title="object edu.berkeley.cs.scads.config.Config">Config</span>.<span title="=&gt; net.lag.configgy.Config">config</span>

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]" id="65787">copyIteratorCtor</a> = 
    <a href="#65784" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String)Option[String]">getString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.storage.copy.iteratorType&quot;)" class="string">&quot;scads.storage.copy.iteratorType&quot;</span><span class="delimiter">)</span>.<span title="(f: String =&gt; Option[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]])Option[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]]">flatMap</span><span class="delimiter">(</span><a title="String" id="66905">tpe</a> =&gt; <a href="#66905" title="String">tpe</a>.<span title="()java.lang.String">toLowerCase</span> <span title="Option[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator]" class="string">&quot;cursor&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator)Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <span title="edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#9787" title="edu.berkeley.cs.scads.storage.CursorBasedPartitionIterator">CursorBasedPartitionIterator</a><span class="delimiter">(</span><a href="#66979" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#66980" title="Option[Array[Byte]]">minKey</a>, <a href="#66981" title="Option[Array[Byte]]">maxKey</a>, <a href="#65788" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator]" class="string">&quot;actorfree&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator)Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.ActorlessPartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <span title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#9784" title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator">ActorlessPartitionIterator</a><span class="delimiter">(</span><a href="#67017" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#67018" title="Option[Array[Byte]]">minKey</a>, <a href="#67019" title="Option[Array[Byte]]">maxKey</a>, <a href="#65788" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.PartitionIterator]" class="string">&quot;actorbased&quot;</span> =&gt; <span title="(x: (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.PartitionIterator)Some[(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; edu.berkeley.cs.scads.storage.PartitionIterator]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
        <a href="Iterator.scala.html#67065" title="edu.berkeley.cs.scads.storage.PartitionIterator" class="keyword">new</a> <a href="Iterator.scala.html#9790" title="edu.berkeley.cs.scads.storage.PartitionIterator">PartitionIterator</a><span class="delimiter">(</span><a href="#67024" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#67025" title="Option[Array[Byte]]">minKey</a>, <a href="#67026" title="Option[Array[Byte]]">maxKey</a>, <a href="#65788" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="None.type" id="67069">invalid</a> =&gt; 
        <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;copy iterator type %s is invalid&quot;)" class="string">&quot;copy iterator type %s is invalid&quot;</span>, <a href="#67069" title="java.lang.String">invalid</a><span class="delimiter">)</span>
        <span title="object None">None</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(default: =&gt; (edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record])(edu.berkeley.cs.scads.comm.PartitionService, Option[Array[Byte]], Option[Array[Byte]]) =&gt; Iterator[edu.berkeley.cs.scads.comm.Record]">getOrElse</span><span class="delimiter">(</span><span class="delimiter">{</span>
        <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Using standard ActorlessPartitionIterator&quot;)" class="string">&quot;Using standard ActorlessPartitionIterator&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">(</span>ps: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, minKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, maxKey: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =&gt;
          <span title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator" class="keyword">new</span> <a href="Iterator.scala.html#9784" title="edu.berkeley.cs.scads.storage.ActorlessPartitionIterator">ActorlessPartitionIterator</a><span class="delimiter">(</span><a href="#67570" title="edu.berkeley.cs.scads.comm.PartitionService">ps</a>, <a href="#67571" title="Option[Array[Byte]]">minKey</a>, <a href="#67572" title="Option[Array[Byte]]">maxKey</a>, <a href="#65788" title="=&gt; Int">copyRecsPerMessage</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Int" id="65789">copyRecsPerMessage</a> = <a href="#65784" title="=&gt; net.lag.configgy.Config">config</a>.<span title="(key: String, defaultValue: Int)Int">getInt</span><span class="delimiter">(</span><span title="java.lang.String(&quot;scads.storage.copy.recsPerMessage&quot;)" class="string">&quot;scads.storage.copy.recsPerMessage&quot;</span>, <span title="Int(8192)" class="int">8192</span><span class="delimiter">)</span>

  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="65790">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="65792">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="67010">a</a>: <a href="#65792" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#67010" title="A">a</a><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="Int" id="65793">cursorTimeout</a> = <span class="int">3</span> * <span class="int">60</span> <span title="Int(180000)">*</span> <span class="int">1000</span> <span class="comment">// 3 minutes (in ms)</span>

  case <span class="keyword">class</span> <a title="class CursorContext extends java.lang.Object with ScalaObject with Product with Serializable" id="68723">CursorContext</a><a href="#68723" title="ScalaObject" class="delimiter">(</a><a title="Int" id="74082">cursorId</a>: <span title="Int">Int</span>, <a title="com.sleepycat.je.Cursor" id="74083">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span>, <a title="com.sleepycat.je.Transaction" id="74084">txn</a>: <span title="com.sleepycat.je.Transaction">Transaction</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Long" id="68735">lastActivity</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="68738">valid</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span class="keyword">def</span> <a title="()Unit" id="68740">updateActivity</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <a href="#68735" title="(x$1: Long)Unit">lastActivity</a> = <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span>
    <span class="keyword">def</span> <a title="()Unit" id="68741">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
      <a href="#68738" title="(x$1: Boolean)Unit">valid</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="68742">isTimedout</a>: <span title="Boolean">Boolean</span> = <span class="delimiter">(</span><a href="#68735" title="=&gt; Long">lastActivity</a> <span title="(x: Int)Long">+</span> <a href="#65793" title="=&gt; Int">cursorTimeout</a><span class="delimiter">)</span> <span title="(x: Long)Long">-</span> <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="68743">isValid</a>: <span title="Boolean">Boolean</span> = <a href="#68738" title="=&gt; Boolean">valid</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicInteger" id="65798">cursorIdGen</a> = <span title="()java.util.concurrent.atomic.AtomicInteger" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]" id="65800">openCursors</a> = <span title="()java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">ConcurrentHashMap</span><span class="delimiter">[</span>Int, CursorContext<span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="65802">cursorTimeoutThread</a> = <span title="object java.util.concurrent.Executors">Executors</span>.<span title="()java.util.concurrent.ExecutorService">newSingleThreadExecutor</span>

  <span class="keyword">protected</span> <span class="keyword">object</span> <a title="object BdbStorageManager.this.CursorTimeoutRunnable" id="65804">CursorTimeoutRunnable</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">val</span> <a title="runnable extends java.lang.Object with java.lang.Runnable" id="69067">runnable</a> = <a href="#69070" title="java.lang.Object with java.lang.Runnable" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with java.lang.Runnable" id="69070">Runnable</a> <span class="delimiter">{</span>
      <span class="keyword">def</span> <a title="()Unit" id="69073">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
        <span class="keyword">try</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <a href="#69077" title="()Unit" class="delimiter">{</a>
            <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#65793" title="=&gt; Long">cursorTimeout</a><span class="delimiter">)</span> <span class="comment">// runs every 3 min</span>
            <span class="keyword">val</span> <a title="Iterable[Int]" id="69078">toRemove</a> = <a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(i: java.util.Collection[BdbStorageManager.this.CursorContext])Iterable[BdbStorageManager.this.CursorContext]">values</span>.<span title="(f: BdbStorageManager.this.CursorContext =&gt; scala.collection.GenTraversableOnce[Int])(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[BdbStorageManager.this.CursorContext],Int,Iterable[Int]])Iterable[Int]">flatMap</span> <a href="#69327" title="List[Int]" class="delimiter">{</a>
              <span class="keyword">case</span> <a title="List[Int]" id="69328">ctx</a> @ CursorContext<span class="delimiter">(</span><a title="Int" id="69329">id</a>, <a title="com.sleepycat.je.Cursor" id="69330">cursor</a>, <a title="com.sleepycat.je.Transaction" id="69331">txn</a><span class="delimiter">)</span> =&gt;
                <a href="#69328" title="BdbStorageManager.this.CursorContext">ctx</a>.<span title="(x$1: List[Int])List[Int]">synchronized</span> <span class="delimiter">{</span>
                  <span title="List[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#69328" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68743" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span title="List[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#69328" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68742" title="=&gt; Boolean">isTimedout</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                      <a href="#69330" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
                      <a href="#69331" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                      <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor %d closed and marked invalid by cleanup thread&quot;)" class="string">&quot;Cursor %d closed and marked invalid by cleanup thread&quot;</span>, <a href="#69329" title="Int">id</a><span class="delimiter">)</span>
                      <a href="#69328" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68741" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
                      <span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#69329" title="Int">id</a><span class="delimiter">)</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="object Nil">Nil</span>
                  <span class="delimiter">}</span> <span class="keyword">else</span> <span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#69329" title="Int">id</a><span class="delimiter">)</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <a href="#69078" title="Iterable[Int]">toRemove</a>.<span title="(f: Int =&gt; BdbStorageManager.this.CursorContext)Unit">foreach</span><span class="delimiter">(</span><a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#69422" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="69426">e</a>: <span title="java.lang.InterruptedException">InterruptedException</span> =&gt;
            <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor timeout thread got signal to shutdown&quot;)" class="string">&quot;Cursor timeout thread got signal to shutdown&quot;</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#65802" title="=&gt; java.util.concurrent.ExecutorService">cursorTimeoutThread</a>.<span title="(x$1: java.lang.Runnable)Unit">execute</span><span class="delimiter">(</span><a href="#69067" title="=&gt; java.lang.Object with java.lang.Runnable">runnable</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="65806">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span> <span class="comment">/* No-op */</span> <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="()Unit" id="65807">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// stop the cursor tasks</span>
    <a href="#65802" title="=&gt; java.util.concurrent.ExecutorService">cursorTimeoutThread</a>.<span title="()java.util.List[java.lang.Runnable]">shutdownNow</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#68953" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(i: java.util.Collection[BdbStorageManager.this.CursorContext])Iterable[BdbStorageManager.this.CursorContext]">values</span>.<span title="(f: BdbStorageManager.this.CursorContext =&gt; Unit)Unit">foreach</span> <a href="#69726" title="Unit" class="delimiter">{</a> 
      <span class="keyword">case</span> <a title="Unit" id="69727">ctx</a> @ CursorContext<span class="delimiter">(</span><a title="Int" id="69728">id</a>, <a title="com.sleepycat.je.Cursor" id="69729">cursor</a>, <a title="com.sleepycat.je.Transaction" id="69730">txn</a><span class="delimiter">)</span> =&gt;
        <a href="#69727" title="BdbStorageManager.this.CursorContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#69727" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68743" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#69729" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#69730" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cursor %d closed and marked invalid by shutdown task&quot;)" class="string">&quot;Cursor %d closed and marked invalid by shutdown task&quot;</span>, <a href="#69728" title="Int">id</a><span class="delimiter">)</span>
            <a href="#69727" title="BdbStorageManager.this.CursorContext">ctx</a>.<a href="#68741" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.util.control.Breaks" id="65808">iterateRangeBreakable</a> = <span title="scala.util.control.Breaks" class="keyword">new</span> <span title="scala.util.control.Breaks">Breaks</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="65810">toString</a> = 
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&lt;PartitionHandler namespace: %s, keyRange: [%s, %s)&gt;&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span>
      <a href="#68953" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#68954" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#68955" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * True iff a particular (non-null) key is bounded by [startKey, endKey)
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Array[Byte])Boolean" id="65811">isInRange</a><span class="delimiter">(</span><a title="Array[Byte]" id="69769">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">//just for the moment because of the Hash partitioning</span>
  <span class="comment">//TODO: I turned of the check, for the hash partitiong. Though, this is really dangerous and can cause hard to find bugs.</span>
  <span class="comment">//We should make the starte aware of the routing, and fix it as soon as possible.</span>
  <span class="comment">//  startKey.map(sk =&gt; compare(sk, key) &lt;= 0).getOrElse(true) &amp;&amp;</span>
  <span class="comment">//  endKey.map(ek =&gt; compare(ek, key) &gt; 0).getOrElse(true)</span>

  <span class="comment">/**
   * True iff startKey &lt;= key
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Option[Array[Byte]])Boolean" id="65812">isStartKeyLEQ</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="69772">key</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = 
    <a href="#68954" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69779">sk</a> =&gt; <span class="comment">/* If we have startKey that is not -INF */</span>
        <a href="#69772" title="Option[Array[Byte]]">key</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69784">usrKey</a> =&gt; <span class="comment">/* If we have a user key that is not -INF */</span>
          <a href="KeyComparison.scala.html#65841" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#69779" title="Array[Byte]">sk</a>, <a href="#69784" title="Array[Byte]">usrKey</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">/* Both keys exist (not -INF), use compare to check range */</span>
        .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">/* startKey not -INF, but user key is -INF, so false */</span>
    .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">/* startKey is -INF, so any user key works */</span>

  <span class="comment">/**
   * True iff endKey &gt;= key
   */</span>
  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: Option[Array[Byte]])Boolean" id="65813">isEndKeyGEQ</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="69818">key</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="#68955" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69825">ek</a> =&gt; <span class="comment">/* If we have endKey that is not +INF */</span>
        <a href="#69818" title="Option[Array[Byte]]">key</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="69830">usrKey</a> =&gt; <span class="comment">/* If we have a user key that is not +INF */</span>
          <a href="KeyComparison.scala.html#65841" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#69825" title="Array[Byte]">ek</a>, <a href="#69830" title="Array[Byte]">usrKey</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="comment">/* Both keys exist (not +INF), use compare to check range */</span>
        .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">/* endKey not +INF, but user key is +INF, so false */</span>
    .<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span class="comment">/* startKey is +INF, so any user key works */</span>

                        

    <span class="comment">// key validation</span>
    <span class="comment">// val (keysInRange, keysInQuestion) = msg match {</span>
    <span class="comment">//   /* GetRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case GetRequest(key) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   /* PutRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case PutRequest(key, _) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   /* Requires startKey &lt;= minKey and endKey &gt;= maxKey (so specifying the</span>
    <span class="comment">//    * entire range is allowed */</span>
    <span class="comment">//   case GetRangeRequest(minKey, maxKey, _, _, _) =&gt;</span>
    <span class="comment">//     (isStartKeyLEQ(minKey) &amp;&amp; isEndKeyGEQ(maxKey), Right((minKey, maxKey)))</span>
    <span class="comment">//   /* Requires startKey &lt;= minKey and endKey &gt;= maxKey (so specifying the</span>
    <span class="comment">//    * entire range is allowed */</span>
    <span class="comment">//   case CountRangeRequest(minKey, maxKey) =&gt;</span>
    <span class="comment">//     (isStartKeyLEQ(minKey) &amp;&amp; isEndKeyGEQ(maxKey), Right((minKey, maxKey)))</span>
    <span class="comment">//   /* TestSetRequest key must be bounded by [startKey, endKey) */</span>
    <span class="comment">//   case TestSetRequest(key, _, _) =&gt; (isInRange(key), Left(key))</span>
    <span class="comment">//   case _ =&gt; (true, null)</span>
    <span class="comment">// }</span>

      <span class="comment">// val errorMsg = keysInQuestion match {</span>
      <span class="comment">//   case Left(key) =&gt;</span>
      <span class="comment">//     &quot;Expected a key in range [%s, %s), but got %s&quot;.format(</span>
      <span class="comment">//       JArrays.toString(startKey.orNull), </span>
      <span class="comment">//       JArrays.toString(endKey.orNull), </span>
      <span class="comment">//       JArrays.toString(key))</span>
      <span class="comment">//   case Right((minKey, maxKey)) =&gt;</span>
      <span class="comment">//     &quot;Expected a range bounded (inclusively) by [%s, %s), but got [%s, %s)&quot;.format(</span>
      <span class="comment">//       JArrays.toString(startKey.orNull),</span>
      <span class="comment">//       JArrays.toString(endKey.orNull),</span>
      <span class="comment">//       JArrays.toString(minKey.orNull),</span>
      <span class="comment">//       JArrays.toString(maxKey.orNull))</span>
      <span class="comment">// }</span>
      <span class="comment">// logger.error(&quot;Received errorneous request %s. Error was: %s&quot;, msg, errorMsg)</span>
      <span class="comment">// reply(RequestRejected(&quot;Key(s) are out of range: %s&quot;.format(errorMsg), msg))</span>


   <span class="keyword">def</span> <a title="(key: Array[Byte])Option[Array[Byte]]" id="65814">get</a><span class="delimiter">(</span><a title="Array[Byte]" id="69851">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
     <span class="keyword">val</span> <a href="#69855" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#69854" title="com.sleepycat.je.DatabaseEntry" id="69855">dbeKey</a>, <a href="#69854" title="com.sleepycat.je.DatabaseEntry" id="69856">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69851" title="Array[Byte]">key</a><span class="delimiter">)</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
     <span class="comment">//try { db.get(null, dbeKey, dbeValue, LockMode.READ_COMMITTED) } catch { case e:com.sleepycat.je.LockTimeoutException =&gt; logger.warning(&quot;lock timeout during GetRequest&quot;) }</span>
     <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry, x$4: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">get</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#69855" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#69856" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, LockMode.<span title="com.sleepycat.je.LockMode(value READ_COMMITTED)">READ_COMMITTED</span><span class="delimiter">)</span>
     <span title="(x: Array[Byte])Option[Array[Byte]]">Option</span><span class="delimiter">(</span><a href="#69856" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
   <span class="delimiter">}</span>


  <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]])Unit" id="65815">put</a><span class="delimiter">(</span><a title="Array[Byte]" id="69938">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>,<a title="Option[Array[Byte]]" id="69939">value</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#69939" title="Option[Array[Byte]]">value</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="69944">v</a><span class="delimiter">)</span> =&gt; <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span title="Unit" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69938" title="Array[Byte]">key</a><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69944" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span title="Unit" class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69938" title="Array[Byte]">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: Array[Byte], value: Option[Array[Byte]], expectedValue: Option[Array[Byte]])Boolean" id="65816">testAndSet</a><span class="delimiter">(</span><a title="Array[Byte]" id="69951">key</a>:<span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="69952">value</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="69953">expectedValue</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="69958">txn</a> = <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="69959">dbeKey</a> = <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#69951" title="Array[Byte]">key</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="69960">dbeCurrentValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry, x$4: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">get</span><span class="delimiter">(</span><a href="#69958" title="com.sleepycat.je.Transaction">txn</a>, <a href="#69959" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#69960" title="com.sleepycat.je.DatabaseEntry">dbeCurrentValue</a>, LockMode.<span title="com.sleepycat.je.LockMode(value READ_COMMITTED)">READ_COMMITTED</span><span class="delimiter">)</span>
    <span title="Boolean" class="keyword">if</span><span class="delimiter">(</span><span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte], x$2: Array[Byte])Boolean">equals</span><span class="delimiter">(</span><a href="#69953" title="Option[Array[Byte]]">expectedValue</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span>, <a href="#69960" title="com.sleepycat.je.DatabaseEntry">dbeCurrentValue</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">{</span>
      <a href="#69952" title="Option[Array[Byte]]">value</a> <span title="com.sleepycat.je.OperationStatus" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus">Some</span><span class="delimiter">(</span><a title="Array[Byte]" id="70016">v</a><span class="delimiter">)</span> =&gt; <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#69958" title="com.sleepycat.je.Transaction">txn</a>, <a href="#69959" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70016" title="Array[Byte]">v</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus">None</span> =&gt; <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#69958" title="com.sleepycat.je.Transaction">txn</a>, <a href="#69959" title="com.sleepycat.je.DatabaseEntry">dbeKey</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#69958" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Boolean(true)" class="keyword">true</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#69958" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">abort</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(parser: edu.berkeley.cs.scads.storage.RecParser, locations: Seq[String])Unit" id="65817">bulkUrlPut</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.RecParser" id="70021">parser</a>:<a href="PartitionHandler.scala.html#9812" title="edu.berkeley.cs.scads.storage.RecParser">RecParser</a>, <a title="Seq[String]" id="70022">locations</a>:<span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="70026">txn</a> = <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>,<span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#70022" title="Seq[String]">locations</a> <span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="70043">location</a> =&gt; <span class="delimiter">{</span>
      <a href="#70021" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49880" title="(location: String)Unit">setLocation</a><span class="delimiter">(</span><a href="#70043" title="String">location</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.net.URL" id="70044">url</a> = <span title="(x$1: java.lang.String)java.net.URL" class="keyword">new</span> java.net.<span title="java.net.URL">URL</span><span class="delimiter">(</span><a href="#70043" title="String">location</a><span class="delimiter">)</span>
      <a href="#70021" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49881" title="(in: java.io.InputStream)Unit">setInput</a><span class="delimiter">(</span><a href="#70044" title="java.net.URL">url</a>.<span title="()java.io.InputStream">openStream</span><span class="delimiter">)</span>
      <span class="keyword">var</span> <a title="(AnyRef, AnyRef)" id="70045">kv</a> = <a href="#70021" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49882" title="()(AnyRef, AnyRef)">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#70045" title="(AnyRef, AnyRef)">kv</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#70174" title="()Unit" class="delimiter">{</a>
        <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#70026" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70045" title="(AnyRef, AnyRef)">kv</a>.<span title="=&gt; AnyRef">_1</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70045" title="(AnyRef, AnyRef)">kv</a>.<span title="=&gt; AnyRef">_2</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Array[Byte]" class="delimiter">[</span><span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#70045" title="(AnyRef, AnyRef)">kv</a> = <a href="#70021" title="edu.berkeley.cs.scads.storage.RecParser">parser</a>.<a href="PartitionHandler.scala.html#49882" title="()(AnyRef, AnyRef)">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#70026" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// exception here will get caught above</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(records: Seq[edu.berkeley.cs.scads.comm.PutRequest])Unit" id="65818">bulkPut</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.PutRequest]" id="70189">records</a>:<span title="Seq[edu.berkeley.cs.scads.comm.PutRequest]">Seq</span><span class="delimiter">[</span>PutRequest<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="70192">txn</a> = <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="70193">reccount</a> = <span title="Int(0)" class="int">0</span>
    <a href="#70189" title="Seq[edu.berkeley.cs.scads.comm.PutRequest]">records</a>.<span title="(f: edu.berkeley.cs.scads.comm.PutRequest =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PutRequest" id="70210">rec</a> =&gt; <span class="delimiter">{</span> <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#70192" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70210" title="edu.berkeley.cs.scads.comm.PutRequest">rec</a>.<span title="=&gt; Array[Byte]">key</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#70210" title="edu.berkeley.cs.scads.comm.PutRequest">rec</a>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span><span class="delimiter">)</span>; <a href="#70193" title="Int">reccount</a><span title="(x: Int)Int">+=</span><span title="Int(1)" class="int">1</span><span class="delimiter">}</span><span class="delimiter">)</span>
    <a href="#70192" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>  <span class="comment">// exception here will get caught above</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)Seq[edu.berkeley.cs.scads.comm.Record]" id="65819">getRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70222">minKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="70223">maxKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Int]" id="70224">limit</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Option[Int]" id="70225">offset</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Boolean" id="70226">ascending</a>:<span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Seq[edu.berkeley.cs.scads.comm.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] GetRangeRequest: [%s, %s)&quot;)" class="string">&quot;[%s] GetRangeRequest: [%s, %s)&quot;</span>, <a href="#9752" title="edu.berkeley.cs.scads.storage.BdbStorageManager" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#70222" title="Option[Array[Byte]]">minKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#70223" title="Option[Array[Byte]]">maxKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="70233">records</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
    <a href="#70224" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Unit)Option[Unit]">map</span><span class="delimiter">(</span><a href="#70233" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#70266" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#65830" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#70222" title="Option[Array[Byte]]">minKey</a>, <a href="#70223" title="Option[Array[Byte]]">maxKey</a>, <a href="#70224" title="Option[Int]">limit</a>, <a href="#70225" title="Option[Int]">offset</a>, <a href="#70226" title="Boolean">ascending</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="70291">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="70292">value</a>, <a title="com.sleepycat.je.Cursor" id="70293">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#70233" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a> <span title="(elem: edu.berkeley.cs.scads.comm.Record)records.type">+=</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.Record">Record</span><span class="delimiter">(</span><a href="#70291" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>, <a href="#70292" title="com.sleepycat.je.DatabaseEntry">value</a>.<a href="#65790" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="comment">// reccount commented out b/c its not being used and it causes each</span>
    <span class="comment">// GetRangeRequest to be a lot slower</span>
    <span class="comment">//var reccount = 0</span>
    <span class="comment">//iterateOverRange(minKey, maxKey)((_,_,_) =&gt; reccount += 1)</span>
    <a href="#70233" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(ranges: Seq[edu.berkeley.cs.scads.comm.MessageBody])scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]" id="65820">getBatch</a><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.MessageBody]" id="70312">ranges</a>:<span title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">Seq</span><span class="delimiter">[</span>MessageBody<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">ArrayBuffer</span><span class="delimiter">[</span>GetRangeResponse<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]" id="70315">results</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">ArrayBuffer</span><span class="delimiter">[</span>GetRangeResponse<span class="delimiter">]</span>
    <a href="#70315" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">results</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#70312" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
    <a href="#70312" title="Seq[edu.berkeley.cs.scads.comm.MessageBody]">ranges</a>.<span title="(f: edu.berkeley.cs.scads.comm.MessageBody =&gt; scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse])Unit">foreach</span> <a href="#70342" title="results.type" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="results.type">GetRangeRequest</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70344">minKey</a>, <a title="Option[Array[Byte]]" id="70345">maxKey</a>, <a title="Option[Int]" id="70346">limit</a>, <a title="Option[Int]" id="70347">offset</a>, <a title="Boolean" id="70348">ascending</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="70349">records</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
        <a href="#70346" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Unit)Option[Unit]">map</span><span class="delimiter">(</span><a href="#70349" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#70356" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#65830" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#70344" title="Option[Array[Byte]]">minKey</a>, <a href="#70345" title="Option[Array[Byte]]">maxKey</a>, <a href="#70346" title="Option[Int]">limit</a>, <a href="#70347" title="Option[Int]">offset</a>, <a href="#70348" title="Boolean">ascending</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="70367">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="70368">value</a>, <a title="com.sleepycat.je.Cursor" id="70369">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#70349" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a> <span title="(elem: edu.berkeley.cs.scads.comm.Record)records.type">+=</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.Record">Record</span><span class="delimiter">(</span><a href="#70367" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>, <a href="#70368" title="com.sleepycat.je.DatabaseEntry">value</a>.<a href="#65790" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <a href="#70315" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">results</a> <span title="(elem: edu.berkeley.cs.scads.comm.GetRangeResponse)results.type">+=</span> <span title="(records: Seq[edu.berkeley.cs.scads.comm.Record])edu.berkeley.cs.scads.comm.GetRangeResponse">GetRangeResponse</span><span class="delimiter">(</span><a href="#70349" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">records</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;BatchRequests only implemented for GetRange&quot;)" class="string">&quot;BatchRequests only implemented for GetRange&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#70315" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.GetRangeResponse]">results</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]])Int" id="65821">countRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70410">minKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="70411">maxKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Int">Int</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Int" id="70415">count</a> = <span title="Int(0)" class="int">0</span>
    <a href="#65830" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><a href="#70410" title="Option[Array[Byte]]">minKey</a>, <a href="#70411" title="Option[Array[Byte]]">maxKey</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="70423">_</a>,<a title="com.sleepycat.je.DatabaseEntry" id="70424">_</a>,<a title="com.sleepycat.je.Cursor" id="70425">_</a><span class="delimiter">)</span> =&gt; <a href="#70415" title="Int">count</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <a href="#70415" title="Int">count</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(src: edu.berkeley.cs.scads.comm.PartitionService, overwrite: Boolean)Unit" id="65822">copyData</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.PartitionService" id="70430">src</a>:<span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="Boolean" id="70431">overwrite</a>:<span title="Boolean">Boolean</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Begin CopyDataRequest src = &quot;)" class="string">&quot;Begin CopyDataRequest src = &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#70430" title="edu.berkeley.cs.scads.comm.PartitionService">src</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;, overwrite = &quot;)" class="string">&quot;, overwrite = &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#70431" title="Boolean">overwrite</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="70435">txn</a> = <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="70436">dbeExistingValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="70437">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="70438">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Opening iterator for data copy&quot;)" class="string">&quot;Opening iterator for data copy&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Iterator[edu.berkeley.cs.scads.comm.Record]" id="70439">iter</a> = <a href="#65786" title="(v1: edu.berkeley.cs.scads.comm.PartitionService, v2: Option[Array[Byte]], v3: Option[Array[Byte]])Iterator[edu.berkeley.cs.scads.comm.Record]">copyIteratorCtor</a><span class="delimiter">(</span><a href="#70430" title="edu.berkeley.cs.scads.comm.PartitionService">src</a>, <a href="#68954" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#68955" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span> 

    <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Beginning copy&quot;)" class="string">&quot;Beginning copy&quot;</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="70440">numRec</a> = <span title="Int(0)" class="int">0</span>
    <a href="#70439" title="Iterator[edu.berkeley.cs.scads.comm.Record]">iter</a>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.Record" id="70464">rec</a> =&gt; <span class="delimiter">{</span>
      <a href="#70437" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="(x$1: Array[Byte])Unit">setData</span><span class="delimiter">(</span><a href="#70464" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Array[Byte]">key</span><span class="delimiter">)</span>
      <a href="#70438" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<span title="(x$1: Array[Byte])Unit">setData</span><span class="delimiter">(</span><a href="#70464" title="edu.berkeley.cs.scads.comm.Record">rec</a>.<span title="=&gt; Option[Array[Byte]]">value</span>.<span title="=&gt; Array[Byte]">get</span><span class="delimiter">)</span>
      
      <span title="com.sleepycat.je.OperationStatus" class="keyword">if</span> <span class="delimiter">(</span><a href="#70431" title="Boolean">overwrite</a><span class="delimiter">)</span> <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#70435" title="com.sleepycat.je.Transaction">txn</a>, <a href="#70437" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#70438" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
      <span class="keyword">else</span> <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">putNoOverwrite</span><span class="delimiter">(</span><a href="#70435" title="com.sleepycat.je.Transaction">txn</a>, <a href="#70437" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#70438" title="com.sleepycat.je.DatabaseEntry">dbeValue</a><span class="delimiter">)</span>
      <span class="comment">// NOTE: was previously the code below, but putNoOverwrite seems</span>
      <span class="comment">// to give us the exact semantics we are looking for here (plus</span>
      <span class="comment">// possibly more efficient than a get() followed by a put())</span>
      <span class="comment">//if(db.get(txn, dbeKey, dbeExistingValue, LockMode.READ_COMMITTED) != OperationStatus.SUCCESS)</span>
      <span class="comment">//  db.put(txn, dbeKey, dbeValue)</span>

      <a href="#70440" title="Int">numRec</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70440" title="Int">numRec</a> <span title="(x: Int)Int">%</span> <span title="Int(10000)" class="int">10000</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;copied %d records so far&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#70440" title="Int">numRec</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Finished copying %d records&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#70440" title="Int">numRec</a><span class="delimiter">)</span><span class="delimiter">)</span>
    
    <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Beginning commit&quot;)" class="string">&quot;Beginning commit&quot;</span><span class="delimiter">)</span>
    <a href="#70435" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Ending commit&quot;)" class="string">&quot;Ending commit&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
                         
  <span class="keyword">def</span> <a title="()(Option[Array[Byte]], Option[Array[Byte]])" id="65823">getResponsibility</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span>Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>,Option<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span title="(_1: Option[Array[Byte]], _2: Option[Array[Byte]])(Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#68954" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#68955" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(groups: Seq[String], keyType: String, valType: String, filters: Seq[edu.berkeley.cs.scads.comm.AggFilter], aggs: Seq[edu.berkeley.cs.scads.comm.AggOp])Seq[edu.berkeley.cs.scads.comm.GroupedAgg]" id="65824">applyAggregate</a><span class="delimiter">(</span><a title="Seq[String]" id="70506">groups</a>:<span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span>,
                     <a title="String" id="70507">keyType</a>:<span title="String">String</span>,
                     <a title="String" id="70508">valType</a>:<span title="String">String</span>,
                     <a title="Seq[edu.berkeley.cs.scads.comm.AggFilter]" id="70509">filters</a>:<span title="Seq[edu.berkeley.cs.scads.comm.AggFilter]">Seq</span><span class="delimiter">[</span>AggFilter<span class="delimiter">]</span>,
                     <a title="Seq[edu.berkeley.cs.scads.comm.AggOp]" id="70510">aggs</a>:<span title="Seq[edu.berkeley.cs.scads.comm.AggOp]">Seq</span><span class="delimiter">[</span>AggOp<span class="delimiter">]</span><span class="delimiter">)</span>:<span title="Seq[edu.berkeley.cs.scads.comm.GroupedAgg]">Seq</span><span class="delimiter">[</span>GroupedAgg<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="70517">filterFunctions</a> = <a href="#70509" title="Seq[edu.berkeley.cs.scads.comm.AggFilter]">filters</a>.<span title="(f: edu.berkeley.cs.scads.comm.AggFilter =&gt; edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.AggFilter],edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]])Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.AggFilter" id="70546">f</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.ObjectInputStream" id="70547">ois</a> = <span title="java.io.ObjectInputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectInputStream">ObjectInputStream</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#70546" title="edu.berkeley.cs.scads.comm.AggFilter">f</a>.<span title="=&gt; Array[Byte]">obj</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#70547" title="java.io.ObjectInputStream">ois</a>.<span title="()java.lang.Object">readObject</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="delimiter">[</span><a href="../util/AnalyticsUtils.scala.html#9867" title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Filter</a><span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Boolean" id="70518">filterPassed</a> = <span title="Boolean(true)" class="keyword">true</span>

    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="70519">aggregates</a> =
      <a href="#70510" title="Seq[edu.berkeley.cs.scads.comm.AggOp]">aggs</a>.<span title="(f: edu.berkeley.cs.scads.comm.AggOp =&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.comm.AggOp],edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]])Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]" class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.AggOp" id="70723">aggOp</a> =&gt; <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.ObjectInputStream" id="70724">ois</a> = <span title="java.io.ObjectInputStream" class="keyword">new</span> java.io.<span title="java.io.ObjectInputStream">ObjectInputStream</span><span class="delimiter">(</span><span title="java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#70723" title="edu.berkeley.cs.scads.comm.AggOp">aggOp</a>.<span title="=&gt; Array[Byte]">obj</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#70724" title="java.io.ObjectInputStream">ois</a>.<span title="()java.lang.Object">readObject</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="delimiter">[</span><a href="../util/AnalyticsUtils.scala.html#9872" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">RemoteAggregate</a><span class="delimiter">[</span>ScalaSpecificRecord,ScalaSpecificRecord,ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
            

    <span class="keyword">val</span> <a title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" id="70520">remKey</a> = <span title="object java.lang.Class">Class</span>.<span title="(x$1: java.lang.String)java.lang.Class[_]">forName</span><span class="delimiter">(</span><a href="#70507" title="String">keyType</a><span class="delimiter">)</span>.<span title="()?0">newInstance</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" id="70521">remVal</a> = <span title="object java.lang.Class">Class</span>.<span title="(x$1: java.lang.String)java.lang.Class[_]">forName</span><span class="delimiter">(</span><a href="#70508" title="String">valType</a><span class="delimiter">)</span>.<span title="()?0">newInstance</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>
    
    <span class="keyword">val</span> <a title="Seq[org.apache.avro.Schema]" id="70522">groupSchemas</a> = <a href="#70506" title="Seq[String]">groups</a>.<span title="(f: String =&gt; org.apache.avro.Schema)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],org.apache.avro.Schema,Seq[org.apache.avro.Schema]])Seq[org.apache.avro.Schema]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,org.apache.avro.Schema,Seq[org.apache.avro.Schema]]" class="delimiter">(</span><a href="#68958" title="org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#70769" title="String">_</a><span class="delimiter">)</span>.<span title="()org.apache.avro.Schema">schema</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[Int]" id="70523">groupInts</a> = <a href="#70506" title="Seq[String]">groups</a>.<span title="(f: String =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],Int,Seq[Int]])Seq[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Int,Seq[Int]]" class="delimiter">(</span><a href="#68958" title="org.apache.avro.Schema">valueSchema</a>.<span title="(x$1: java.lang.String)org.apache.avro.Schema.Field">getField</span><span class="delimiter">(</span><a href="#70799" title="String">_</a><span class="delimiter">)</span>.<span title="()Int">pos</span><span class="delimiter">)</span>
    
    <span class="keyword">var</span> <a title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" id="70524">groupMap</a>:<span title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">Map</span><span class="delimiter">[</span>CharSequence, scala.collection.mutable.ArraySeq<span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span class="keyword">var</span> <a title="Map[java.lang.CharSequence,Array[Byte]]" id="70525">groupBytesMap</a>:<span title="Map[java.lang.CharSequence,Array[Byte]]">Map</span><span class="delimiter">[</span>CharSequence, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span class="keyword">var</span> <a title="java.lang.CharSequence" id="70526">groupKey</a>:<span title="java.lang.CharSequence">CharSequence</span> = <span title="Null(null)" class="keyword">null</span>
    
    <span class="keyword">var</span> <a title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="70527">aggVals</a>:<span title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Seq</span><span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span> = <span title="Null(null)" class="keyword">null</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70506" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// no groups, so let's init values now</span>
      <a href="#70527" title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">aggVals</a> = <a href="#70519" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="(f: edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]])Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="delimiter">(</span><a href="#71125" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_</a>.<a href="../util/AnalyticsUtils.scala.html#26758" title="()edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">init</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#70524" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a> = <span title="scala.collection.immutable.HashMap[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="keyword">new</span> scala.collection.immutable.<span title="scala.collection.immutable.HashMap[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">HashMap</span><span class="delimiter">[</span>CharSequence,scala.collection.mutable.ArraySeq<span class="delimiter">[</span>ScalaSpecificRecord<span class="delimiter">]</span><span class="delimiter">]</span>
      <a href="#70525" title="Map[java.lang.CharSequence,Array[Byte]]">groupBytesMap</a> = <span title="scala.collection.immutable.HashMap[java.lang.CharSequence,Array[Byte]]" class="keyword">new</span> scala.collection.immutable.<span title="scala.collection.immutable.HashMap[java.lang.CharSequence,Array[Byte]]">HashMap</span><span class="delimiter">[</span>CharSequence, Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="delimiter">}</span>
    
    <span class="keyword">var</span> <a title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="70528">curAggVal</a> =
      <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="keyword">if</span> <span class="delimiter">(</span><a href="#70506" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        scala.collection.mutable.<span title="(elems: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord*)scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ArraySeq</span><span class="delimiter">(</span><a href="#70527" title="Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">aggVals</a>:_*<span class="delimiter">)</span>
      <span class="keyword">else</span>
        <span title="Null(null)" class="keyword">null</span>

    <span class="keyword">var</span> <a title="Boolean" id="70529">stop</a> = <span title="Boolean(false)" class="keyword">false</span>

    <a href="#65830" title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit">iterateOverRange</a><span class="delimiter">(</span><span title="object None">None</span>,<span title="object None">None</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="71322">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="71323">value</a>, <a title="com.sleepycat.je.Cursor" id="71324">_</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <span class="comment">// TODO: Use lazy values here</span>
      <span class="keyword">val</span> <a title="Array[Byte]" id="71325">valBytes</a> = <a href="#71323" title="com.sleepycat.je.DatabaseEntry">value</a>.<span title="()Array[Byte]">getData</span>
      <a href="#70521" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a>.<span title="(inputStream: java.io.InputStream)remVal.type">parse</span><span class="delimiter">(</span><span title="(x$1: Array[Byte], x$2: Int, x$3: Int)java.io.ByteArrayInputStream" class="keyword">new</span> java.io.<span title="java.io.ByteArrayInputStream">ByteArrayInputStream</span><span class="delimiter">(</span><a href="#71325" title="Array[Byte]">valBytes</a>,<span title="Int(16)" class="int">16</span>,<span class="delimiter">(</span><a href="#71325" title="Array[Byte]">valBytes</a>.<span title="=&gt; Int">length</span><span title="(x: Int)Int">-</span><span title="Int(16)" class="int">16</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Array[Byte]" id="71326">keyBytes</a> = <a href="#71322" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span>
      <a href="#70520" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remKey</a>.<span title="(data: Array[Byte])remKey.type">parse</span><span class="delimiter">(</span><a href="#71326" title="Array[Byte]">keyBytes</a><span class="delimiter">)</span>
      
      <a href="#70518" title="Boolean">filterPassed</a> = <span title="Boolean(true)" class="keyword">true</span>
      <a href="#70517" title="Seq[edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">filterFunctions</a>.<span title="(f: edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="71357">ff</a> =&gt; <span class="delimiter">{</span> 
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70518" title="Boolean">filterPassed</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// once one failed just ignore the rest</span>
          <a href="#70518" title="Boolean">filterPassed</a> = <a href="#71357" title="edu.berkeley.cs.scads.util.Filter[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ff</a>.<a href="../util/AnalyticsUtils.scala.html#24216" title="(r: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)Boolean">applyFilter</a><span class="delimiter">(</span><a href="#70521" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70518" title="Boolean">filterPassed</a><span class="delimiter">)</span> <span class="delimiter">{</span>  <span class="comment">// record passes filters</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70506" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#70526" title="java.lang.CharSequence">groupKey</a> = <a href="../util/AnalyticsUtils.scala.html#9876" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="../util/AnalyticsUtils.scala.html#26877" title="(groups: Seq[Int], rec: org.apache.avro.generic.IndexedRecord)java.lang.CharSequence">getGroupKey</a><span class="delimiter">(</span><a href="#70523" title="Seq[Int]">groupInts</a>,<a href="#70521" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
          <a href="#70528" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a> = <a href="#70524" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a>.<span title="(key: java.lang.CharSequence)Option[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">get</span><span class="delimiter">(</span><a href="#70526" title="java.lang.CharSequence">groupKey</a><span class="delimiter">)</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">Some</span><span class="delimiter">(</span><a title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]" id="71553">thing</a><span class="delimiter">)</span> =&gt; <a href="#71553" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">thing</a>
            <span class="keyword">case</span> <span title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">None</span> =&gt; <span class="delimiter">{</span> <span class="comment">// this is a new group, so init the starting values for the agg</span>
              <a href="#70525" title="Map[java.lang.CharSequence,Array[Byte]]">groupBytesMap</a> <span title="(kv: (java.lang.CharSequence, Array[Byte]))scala.collection.immutable.Map[java.lang.CharSequence,Array[Byte]]">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.CharSequence, _2: Array[Byte])(java.lang.CharSequence, Array[Byte])" class="delimiter">(</span><a href="#70526" title="java.lang.CharSequence">groupKey</a>,<a href="../util/AnalyticsUtils.scala.html#9876" title="object edu.berkeley.cs.scads.util.AnalyticsUtils">AnalyticsUtils</a>.<a href="../util/AnalyticsUtils.scala.html#26874" title="(groups: Seq[Int], groupSchemas: Seq[org.apache.avro.Schema], rec: org.apache.avro.generic.IndexedRecord)Array[Byte]">getGroupBytes</a><span class="delimiter">(</span><a href="#70523" title="Seq[Int]">groupInts</a>,<a href="#70522" title="Seq[org.apache.avro.Schema]">groupSchemas</a>,<a href="#70521" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              scala.collection.mutable.<span title="(elems: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord*)scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">ArraySeq</span><span class="delimiter">(</span><a href="#70519" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="(f: edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord] =&gt; edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]])Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,Seq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]" class="delimiter">(</span><a href="#71676" title="edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_</a>.<a href="../util/AnalyticsUtils.scala.html#26758" title="()edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">init</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>:_*<span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <a href="#70529" title="Boolean">stop</a> = <span title="Boolean(true)" class="keyword">true</span>
        <a href="#70519" title="Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">aggregates</a>.<span title="=&gt; java.lang.Object with scala.collection.SeqView[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]]">view</span>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.SeqView[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Seq[edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]],(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),scala.collection.SeqView[(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),Seq[_]]])scala.collection.SeqView[(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int),Seq[_]]">zipWithIndex</span> <span title="(f: (edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)" id="73259">aggregate</a> =&gt; <span class="delimiter">{</span>
          <a href="#70528" title="(idx: Int, elem: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)Unit">curAggVal</a><span class="delimiter">(</span><a href="#73259" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span> = <a href="#73259" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_1</span>.<a href="../util/AnalyticsUtils.scala.html#26759" title="(a: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord, k: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord, v: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord)edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">applyAggregate</a><span class="delimiter">(</span><a href="#70528" title="(idx: Int)edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">curAggVal</a><span class="delimiter">(</span><a href="#73259" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; Int">_2</span><span class="delimiter">)</span>,<a href="#70520" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remKey</a>,<a href="#70521" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">remVal</a><span class="delimiter">)</span>
          <a href="#70529" title="Boolean">stop</a> <span title="(x: Boolean)Boolean">&amp;=</span> <a href="#73259" title="(edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord], Int)">aggregate</a>.<span title="=&gt; edu.berkeley.cs.scads.util.RemoteAggregate[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord,edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_1</span>.<a href="../util/AnalyticsUtils.scala.html#26754" title="=&gt; Boolean">stop</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70506" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
          <a href="#70524" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a> <span title="(kv: (java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]))scala.collection.immutable.Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.CharSequence, _2: scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])" class="delimiter">(</span><a href="#70526" title="java.lang.CharSequence">groupKey</a>,<a href="#70528" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#70529" title="Boolean">stop</a><span class="delimiter">)</span>
          <a href="#65808" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="()Unit">break</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <span title="Seq[edu.berkeley.cs.scads.comm.GroupedAgg]" class="keyword">if</span> <span class="delimiter">(</span><a href="#70506" title="(b: Seq[String])java.util.List[String]">groups</a>.<span title="()Int">size</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(xs: edu.berkeley.cs.scads.comm.GroupedAgg*)List[edu.berkeley.cs.scads.comm.GroupedAgg]">List</span><span class="delimiter">(</span><span title="(group: Option[Array[Byte]], groupVals: Seq[Array[Byte]])edu.berkeley.cs.scads.comm.GroupedAgg">GroupedAgg</span><span class="delimiter">(</span><span title="object None">None</span>,<a href="#70528" title="scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">curAggVal</a>.<span title="(f: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq.Coll,Array[Byte],scala.collection.mutable.ArraySeq[Array[Byte]]]" class="delimiter">(</span><a href="#73749" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">_</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#70524" title="Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]]">groupMap</a>.<span title="(f: (java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]) =&gt; edu.berkeley.cs.scads.comm.GroupedAgg)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[java.lang.CharSequence,scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]],edu.berkeley.cs.scads.comm.GroupedAgg,scala.collection.immutable.Iterable[edu.berkeley.cs.scads.comm.GroupedAgg]])scala.collection.immutable.Iterable[edu.berkeley.cs.scads.comm.GroupedAgg]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Iterable.Coll,edu.berkeley.cs.scads.comm.GroupedAgg,scala.collection.immutable.Iterable[edu.berkeley.cs.scads.comm.GroupedAgg]]" class="delimiter">(</span><a title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])" id="73847">kv</a> =&gt; <span class="delimiter">{</span>
        <span title="(group: Option[Array[Byte]], groupVals: Seq[Array[Byte]])edu.berkeley.cs.scads.comm.GroupedAgg">GroupedAgg</span><span class="delimiter">(</span><a href="#70525" title="(key: java.lang.CharSequence)Array[Byte]">groupBytesMap</a><a href="#65790" title="(a: Array[Byte])Option[Array[Byte]]" class="delimiter">(</a><a href="#73847" title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])">kv</a>.<span title="=&gt; java.lang.CharSequence">_1</span><span class="delimiter">)</span>,<a href="#73847" title="(java.lang.CharSequence, scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord])">kv</a>.<span title="=&gt; scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord]">_2</span>.<span title="(f: edu.berkeley.cs.avro.runtime.ScalaSpecificRecord =&gt; Array[Byte])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq[edu.berkeley.cs.avro.runtime.ScalaSpecificRecord],Array[Byte],Seq[Array[Byte]]])Seq[Array[Byte]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.ArraySeq.Coll,Array[Byte],scala.collection.mutable.ArraySeq[Array[Byte]]]" class="delimiter">(</span><a href="#73890" title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">_</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord" class="delimiter">[</span><span title="edu.berkeley.cs.avro.runtime.ScalaSpecificRecord">ScalaSpecificRecord</span><span class="delimiter">]</span>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.GroupedAgg]">toSeq</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(optCursorId: Option[Int], recsPerMessage: Int)(Option[Int], IndexedSeq[edu.berkeley.cs.scads.comm.Record])" id="65825">cursorScan</a><span class="delimiter">(</span><a title="Option[Int]" id="74006">optCursorId</a>:<span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Int" id="74007">recsPerMessage</a>:<span title="Int">Int</span><span class="delimiter">)</span>:<span title="(Option[Int], IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span>Option<span class="delimiter">[</span>Int<span class="delimiter">]</span>,IndexedSeq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74007" title="Int">recsPerMessage</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#9813" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Recs per message needs to be &gt; 0: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#74007" title="Int">recsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="runnable extends java.lang.Object with java.lang.Runnable" id="74009">dummy</a> = <a href="#65804" title="object BdbStorageManager.this.CursorTimeoutRunnable">CursorTimeoutRunnable</a>.<a href="#69067" title="=&gt; java.lang.Object with java.lang.Runnable">runnable</a> <span class="comment">// initialize it (lazily)</span>

    <span class="comment">//logger.info(&quot;CursorScanRequest: %s&quot;, msg)</span>

    <span class="keyword">val</span> <a href="#74011" title="(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</a><a href="#74010" title="Int" id="74011">cursorId</a>, <a href="#74010" title="BdbStorageManager.this.CursorContext" id="74012">cursorCtx</a><span class="delimiter">)</span> = <a href="#74006" title="Option[Int]">optCursorId</a>.<span title="(f: Int =&gt; (Int, BdbStorageManager.this.CursorContext))Option[(Int, BdbStorageManager.this.CursorContext)]">map</span><span class="delimiter">(</span><a title="Int" id="74031">id</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="BdbStorageManager.this.CursorContext" id="74032">ctx</a> = <span title="(x: BdbStorageManager.this.CursorContext)Option[BdbStorageManager.this.CursorContext]">Option</span><span class="delimiter">(</span><a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">get</span><span class="delimiter">(</span><a href="#74031" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; BdbStorageManager.this.CursorContext)BdbStorageManager.this.CursorContext">getOrElse</span><span class="delimiter">(</span><span class="delimiter">{</span> 
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#9813" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid cursor Id: %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#74031" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span title="(_1: Int, _2: BdbStorageManager.this.CursorContext)(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</span><a href="#74031" title="Int">id</a>, <a href="#74032" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(default: =&gt; (Int, BdbStorageManager.this.CursorContext))(Int, BdbStorageManager.this.CursorContext)">getOrElse</span><span title="(Int, BdbStorageManager.this.CursorContext) @unchecked" class="delimiter">(</span><span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="74055">id</a> = <a href="#65798" title="=&gt; java.util.concurrent.atomic.AtomicInteger">cursorIdGen</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="74056">txn</a> = <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="74057">newCursor</a> = <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><a href="#74056" title="com.sleepycat.je.Transaction">txn</a>, <span title="object com.sleepycat.je.CursorConfig">CursorConfig</span>.<span title="com.sleepycat.je.CursorConfig">READ_UNCOMMITTED</span><span class="delimiter">)</span>
      <a href="#65828" title="(cursor: com.sleepycat.je.Cursor)com.sleepycat.je.OperationStatus">initCursor</a><span class="delimiter">(</span><a href="#74057" title="com.sleepycat.je.Cursor">newCursor</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="BdbStorageManager.this.CursorContext" id="74058">ctx</a> = <a href="#68723" title="(cursorId: Int, cursor: com.sleepycat.je.Cursor, txn: com.sleepycat.je.Transaction)BdbStorageManager.this.CursorContext">CursorContext</a><span class="delimiter">(</span><a href="#74055" title="Int">id</a>, <a href="#74057" title="com.sleepycat.je.Cursor">newCursor</a>, <a href="#74056" title="com.sleepycat.je.Transaction">txn</a><span class="delimiter">)</span>
      <a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Int, x$2: BdbStorageManager.this.CursorContext)BdbStorageManager.this.CursorContext">put</span><span class="delimiter">(</span><a href="#74055" title="Int">id</a>, <a href="#74058" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
      <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;made new cursor with id %d, txn with id %d&quot;)" class="string">&quot;made new cursor with id %d, txn with id %d&quot;</span>, <a href="#74055" title="Int">id</a>, <a href="#74056" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Long">getId</span><span class="delimiter">)</span>
      <span title="(_1: Int, _2: BdbStorageManager.this.CursorContext)(Int, BdbStorageManager.this.CursorContext)" class="delimiter">(</span><a href="#74055" title="Int">id</a>, <a href="#74058" title="BdbStorageManager.this.CursorContext">ctx</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
    
    <span class="comment">// lock the cursor context</span>
    <span class="keyword">val</span> <a href="#74014" title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</a><a href="#74013" title="Boolean" id="74014">moreRecs</a>, <a href="#74013" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="74015">recs</a><span class="delimiter">)</span> = <a href="#74012" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<span title="(x$1: (Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record]))(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])">synchronized</span> <span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record]) @unchecked" class="delimiter">{</span>
      <span class="comment">// check to see if the cursor is still valid</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#74012" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#68743" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#74011" title="Int">cursorId</a><span class="delimiter">)</span> <span class="comment">// just to be sure </span>
        <span title="Nothing" class="keyword">throw</span> <span title="edu.berkeley.cs.scads.storage.RequestRejectedException" class="keyword">new</span> <a href="PartitionHandler.scala.html#9813" title="edu.berkeley.cs.scads.storage.RequestRejectedException">RequestRejectedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Cursor ID: %d has already timedout&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#74011" title="Int">cursorId</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#74012" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#68740" title="()Unit">updateActivity</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// set a new timeout</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="74121">cursor</a> = <a href="#74012" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#74083" title="=&gt; com.sleepycat.je.Cursor">cursor</a>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="74122">txn</a> = <a href="#74012" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#74084" title="=&gt; com.sleepycat.je.Transaction">txn</a>
      <span class="keyword">val</span> <a href="#74124" title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</a><a href="#74123" title="Boolean" id="74124">moreRecs</a>, <a href="#74123" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="74125">recs</a><span class="delimiter">)</span> = <a href="#65829" title="(cursor: com.sleepycat.je.Cursor, recsPerMessage: Int)(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])">advanceCursor</a><span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record]) @unchecked" class="delimiter">(</span><a href="#74121" title="com.sleepycat.je.Cursor">cursor</a>, <a href="#74007" title="Int">recsPerMessage</a><span class="delimiter">)</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#74124" title="Boolean">moreRecs</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// done, close this cursor up</span>
        <a href="#74121" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#74122" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#65782" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;closing cursor %d and commit txn %d&quot;)" class="string">&quot;closing cursor %d and commit txn %d&quot;</span>, <a href="#74011" title="Int">cursorId</a>, <a href="#74122" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Long">getId</span><span class="delimiter">)</span>
        <a href="#74012" title="BdbStorageManager.this.CursorContext">cursorCtx</a>.<a href="#68741" title="()Unit">markInvalid</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#65800" title="=&gt; java.util.concurrent.ConcurrentHashMap[Int,BdbStorageManager.this.CursorContext]">openCursors</a>.<span title="(x$1: Any)BdbStorageManager.this.CursorContext">remove</span><span class="delimiter">(</span><a href="#74011" title="Int">cursorId</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span title="(_1: Boolean, _2: IndexedSeq[edu.berkeley.cs.scads.comm.Record])(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span><a href="#74124" title="Boolean">moreRecs</a>, <a href="#74125" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">recs</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="comment">//logger.info(&quot;read %d recs, moreRecs = %s&quot;, recs.size, moreRecs)</span>
    
    <span title="(_1: Option[Int], _2: IndexedSeq[edu.berkeley.cs.scads.comm.Record])(Option[Int], IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span><span title="Option[Int]" class="keyword">if</span> <span class="delimiter">(</span><a href="#74014" title="Boolean">moreRecs</a><span class="delimiter">)</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#74011" title="Int">cursorId</a><span class="delimiter">)</span> <span class="keyword">else</span> <span title="object None">None</span>, <a href="#74015" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">recs</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Delete [startKey, endKey)
   */</span>
  <span class="keyword">def</span> <a title="(txn: Option[com.sleepycat.je.Transaction])Unit" id="65826">deleteEntireRange</a><span class="delimiter">(</span><a title="Option[com.sleepycat.je.Transaction]" id="74206">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#65827" title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit">deleteRange</a><span class="delimiter">(</span><a href="#68954" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#68955" title="=&gt; Option[Array[Byte]]">endKey</a>, <a href="#74206" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="comment">/**
   * Delete [lowerKey, upperKey)
   */</span>
  <span class="keyword">def</span> <a title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit" id="65827">deleteRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="74208">lowerKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="74209">upperKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[com.sleepycat.je.Transaction]" id="74210">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#65812" title="(key: Option[Array[Byte]])Boolean">isStartKeyLEQ</a><span class="delimiter">(</span><a href="#74208" title="Option[Array[Byte]]">lowerKey</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#65813" title="(key: Option[Array[Byte]])Boolean">isEndKeyGEQ</a><span class="delimiter">(</span><a href="#74209" title="Option[Array[Byte]]">upperKey</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;startKey &lt;= lowerKey &amp;&amp; endKey &gt;= upperKey required&quot;)" class="string">&quot;startKey &lt;= lowerKey &amp;&amp; endKey &gt;= upperKey required&quot;</span><span class="delimiter">)</span>
    <a href="#70284" title="Option[Int]" id="74219">iterateOverRange</a><span class="delimiter">(</span><a href="#74208" title="Option[Array[Byte]]" id="74214">lowerKey</a>, <a href="#74209" title="Option[Array[Byte]]" id="74215">upperKey</a>, txn = <a href="#74210" title="Option[com.sleepycat.je.Transaction]" id="74216">txn</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="74221">_</a>, <a title="com.sleepycat.je.DatabaseEntry" id="74222">_</a>, <a title="com.sleepycat.je.Cursor" id="74223">cursor</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
      <a href="#74223" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()com.sleepycat.je.OperationStatus">delete</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(cursor: com.sleepycat.je.Cursor)com.sleepycat.je.OperationStatus" id="65828">initCursor</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="74073">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74076">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74077">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <a href="#74073" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getFirst</span><span class="delimiter">(</span><a href="#74076" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74077" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** returns (does the cursor still have more elements?, buffer) */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(cursor: com.sleepycat.je.Cursor, recsPerMessage: Int)(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" id="65829">advanceCursor</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="74131">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span>, <a title="Int" id="74132">recsPerMessage</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="(Boolean, IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span>Boolean, IndexedSeq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74225">dbeKey</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseEntry" id="74226">dbeValue</a> = <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" id="74227">buf</a> = <span title="()scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]" class="keyword">new</span> <span title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">ArrayBuffer</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>
    <a href="#74227" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">buf</a>.<span title="(len: Int)Unit">sizeHint</span><span class="delimiter">(</span><a href="#74132" title="Int">recsPerMessage</a><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="74228">stat</a> = <a href="#74131" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74225" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74226" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="74229">recs</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#74228" title="com.sleepycat.je.OperationStatus">stat</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#74229" title="Int">recs</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#74132" title="Int">recsPerMessage</a><span class="delimiter">)</span> <a href="#74231" title="()Unit" class="delimiter">{</a>
      <a href="#74227" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">buf</a> <span title="(elem: edu.berkeley.cs.scads.comm.Record)buf.type">+=</span> <span title="(key: Array[Byte], value: Option[Array[Byte]])edu.berkeley.cs.scads.comm.Record">Record</span><span class="delimiter">(</span><a href="#74225" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span>, <a href="#74226" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>.<a href="#65790" title="(a: Array[Byte])Option[Array[Byte]]">getData</a><span class="delimiter">)</span>
      <a href="#74229" title="Int">recs</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <a href="#74228" title="com.sleepycat.je.OperationStatus">stat</a> = <a href="#74131" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#74225" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74226" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])" id="74230">ret</a> = <span title="(_1: Boolean, _2: scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])" class="delimiter">(</span><a href="#74228" title="com.sleepycat.je.OperationStatus">stat</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span>, <a href="#74227" title="scala.collection.mutable.ArrayBuffer[edu.berkeley.cs.scads.comm.Record]">buf</a>.<span title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record]">toIndexedSeq</span><span class="delimiter">)</span>
    <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#74230" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])">ret</a>.<span title="=&gt; Boolean">_1</span> <span title="(x: Boolean)Boolean">||</span> <a href="#74230" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])">ret</a>.<span title="=&gt; scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record]">_2</span>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#74132" title="Int">recsPerMessage</a><span class="delimiter">)</span>
    <a href="#74230" title="(Boolean, scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record])">ret</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Low level method to iterate over a given range on the database. it is up
   * to the caller to validate minKey and maxKey. The range iterated over is
   * [minKey, maxKey), with the order specified by ascending (and limits
   * respected)
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean, txn: Option[com.sleepycat.je.Transaction])(func: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit)Unit" id="65830">iterateOverRange</a><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="70276">minKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                               <a title="Option[Array[Byte]]" id="70277">maxKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, 
                               <a title="Option[Int]" id="70284">limit</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>, 
                               <a title="Option[Int]" id="70285">offset</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>, 
                               <a title="Boolean" id="70286">ascending</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span>, 
                               <a title="Option[com.sleepycat.je.Transaction]" id="70287">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span>
      <span class="delimiter">(</span><a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry, com.sleepycat.je.Cursor) =&gt; Unit" id="70282">func</a>: <span class="delimiter">(</span>DatabaseEntry, DatabaseEntry, Cursor<span class="delimiter">)</span> =&gt; Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a href="#74387" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</a><a href="#74386" title="com.sleepycat.je.DatabaseEntry" id="74387">dbeKey</a>, <a href="#74386" title="com.sleepycat.je.DatabaseEntry" id="74388">dbeValue</a><span class="delimiter">)</span> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="74389">cur</a> = <a href="#68952" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><a href="#70287" title="Option[com.sleepycat.je.Transaction]">txn</a>.<span title="(implicit ev: &lt;:&lt;[Null,com.sleepycat.je.Transaction])com.sleepycat.je.Transaction">orNull</span>, <span title="object com.sleepycat.je.CursorConfig">CursorConfig</span>.<span title="com.sleepycat.je.CursorConfig">READ_UNCOMMITTED</span><span class="delimiter">)</span>

    <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="74390">status</a>: <span title="com.sleepycat.je.OperationStatus">OperationStatus</span> = <span title="(_1: Boolean, _2: Option[Array[Byte]], _3: Option[Array[Byte]])(Boolean, Option[Array[Byte]], Option[Array[Byte]])" class="delimiter">(</span><a href="#70286" title="Boolean">ascending</a>, <a href="#70276" title="Option[Array[Byte]]">minKey</a>, <a href="#70277" title="Option[Array[Byte]]">maxKey</a><span class="delimiter">)</span> <span title="com.sleepycat.je.OperationStatus" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, <span title="object None">None</span>, _<span class="delimiter">)</span> =&gt; <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getFirst</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span>, Some<span class="delimiter">(</span><a title="Array[Byte]" id="74436">startKey</a><span class="delimiter">)</span>, _<span class="delimiter">)</span> =&gt; <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getSearchKeyRange</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74436" title="Array[Byte]">startKey</a><span class="delimiter">)</span>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, _, <span title="object None">None</span><span class="delimiter">)</span> =&gt; <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getLast</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span>, _, Some<span class="delimiter">(</span><a title="Array[Byte]" id="74446">startKey</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span class="comment">// Check if maxKey is past the last key in the database, if so start from the end</span>
        <span title="com.sleepycat.je.OperationStatus" class="keyword">if</span><span class="delimiter">(</span><a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getSearchKeyRange</span><span class="delimiter">(</span><span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#74446" title="Array[Byte]">startKey</a><span class="delimiter">)</span>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value NOTFOUND)">NOTFOUND</span><span class="delimiter">)</span>
          <span class="comment">// no need to skip back one since the maxKey was not found anyways</span>
          <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getLast</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="comment">// need to check that the cursor is pointing to the first key that</span>
          <span class="comment">// is LESS THAN maxKey. getSearchKeyRange semantics only guarantee</span>
          <span class="comment">// that the cursor is pointing to the smallest key &gt;= maxKey</span>
          <span class="keyword">var</span> <a title="com.sleepycat.je.OperationStatus" id="74454">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#74454" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="KeyComparison.scala.html#65841" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#74446" title="Array[Byte]">startKey</a>, <a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
            <a href="#74454" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <a href="#74454" title="com.sleepycat.je.OperationStatus">status</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">var</span> <a title="Int" id="74391">toSkip</a> = <a href="#70285" title="Option[Int]">offset</a>.<span title="(default: =&gt; Int)Int">getOrElse</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Int" id="74392">returnedCount</a> = <span title="Int(0)" class="int">0</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">!=</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#70286" title="Boolean">ascending</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74391" title="Int">toSkip</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <a href="#74480" title="()Unit" class="delimiter">{</a>
        <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#74391" title="Int">toSkip</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
        <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#65808" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="(op: =&gt; Unit)Unit">breakable</span> <span class="delimiter">{</span> <span class="comment">// used to allow func to break out early</span>
        <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70284" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="#74509" title="Int">_</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#74392" title="Int">returnedCount</a><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70277" title="Option[Array[Byte]]">maxKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="74524">mk</a> =&gt; <a href="KeyComparison.scala.html#65841" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span>, <a href="#74524" title="Array[Byte]">mk</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span class="comment">/* Exclude maxKey from range */</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#74499" title="()Unit" class="delimiter">{</a>
                <a href="#70282" title="(v1: com.sleepycat.je.DatabaseEntry, v2: com.sleepycat.je.DatabaseEntry, v3: com.sleepycat.je.Cursor)Unit">func</a><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <a href="#74389" title="com.sleepycat.je.Cursor">cur</a><span class="delimiter">)</span>
                <a href="#74392" title="Int">returnedCount</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
                <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74391" title="Int">toSkip</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span> <a href="#74546" title="()Unit" class="delimiter">{</a>
        <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#74391" title="Int">toSkip</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
        <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getCurrent</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#65808" title="=&gt; scala.util.control.Breaks">iterateRangeBreakable</a>.<span title="(op: =&gt; Unit)Unit">breakable</span> <span class="delimiter">{</span> <span class="comment">// used to allow func to break out early</span>
        <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70284" title="Option[Int]">limit</a>.<span title="(f: Int =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="#74575" title="Int">_</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#74392" title="Int">returnedCount</a><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
              <a href="#70276" title="Option[Array[Byte]]">minKey</a>.<span title="(f: Array[Byte] =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="KeyComparison.scala.html#65841" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#74588" title="Array[Byte]">_</a>, <a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#74565" title="()Unit" class="delimiter">{</a>
                <a href="#70282" title="(v1: com.sleepycat.je.DatabaseEntry, v2: com.sleepycat.je.DatabaseEntry, v3: com.sleepycat.je.Cursor)Unit">func</a><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>,<a href="#74389" title="com.sleepycat.je.Cursor">cur</a><span class="delimiter">)</span>
                <a href="#74392" title="Int">returnedCount</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
                <a href="#74390" title="com.sleepycat.je.OperationStatus">status</a> = <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getPrev</span><span class="delimiter">(</span><a href="#74387" title="com.sleepycat.je.DatabaseEntry">dbeKey</a>, <a href="#74388" title="com.sleepycat.je.DatabaseEntry">dbeValue</a>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#74389" title="com.sleepycat.je.Cursor">cur</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>