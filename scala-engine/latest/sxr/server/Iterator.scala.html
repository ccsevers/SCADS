<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>server/Iterator.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue

<span class="keyword">import</span> scala.actors._
<span class="keyword">import</span> scala.actors.<span title="object scala.actors.Actor">Actor</span>._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class FutureBasedIterator extends java.lang.Object with Iterator[edu.berkeley.cs.scads.comm.Record] with ScalaObject" id="9780">FutureBasedIterator</a><a href="#9780" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.PartitionService" id="76933">partitionService</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="Option[Array[Byte]]" id="76934">minKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="76935">maxKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Int" id="76937">recsPerMessage</a>: <span title="Int">Int</span> = <span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="Iterator[edu.berkeley.cs.scads.comm.Record]">Iterator</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span title="(requirement: Boolean)Unit">require</span><span class="delimiter">(</span><a href="#76937" title="Int">recsPerMessage</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="50745">recsPerMessageDiv2</a> = <a href="#76937" title="Int">recsPerMessage</a> <span title="(x: Int)Int">/</span> <span title="Int(2)" class="int">2</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="50748">isDone</a> = <span title="Boolean(false)" class="keyword">false</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="50751">currentBuffer</a>: <span title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">IndexedSeq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span title="=&gt; collection.immutable.Vector.type">Vector</span>.<span title="scala.collection.immutable.Vector[Nothing]">empty</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="50754">currentIdx</a> = <span title="Int(0)" class="int">0</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.MessageFuture" id="50757">activeFuture</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span> = _

  <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.Record" id="50759">next</a>: <span title="edu.berkeley.cs.scads.comm.Record">Record</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#50763" title="=&gt; Boolean">hasNext</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.UnsupportedOperationException" class="keyword">new</span> <span title="java.lang.UnsupportedOperationException">UnsupportedOperationException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;next on empty iterator&quot;)" class="string">&quot;next on empty iterator&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.Record" id="77212">res</a> = <a href="#50751" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">currentBuffer</a><span class="delimiter">(</span><a href="#50754" title="=&gt; Int">currentIdx</a><span class="delimiter">)</span>
    <a href="#50754" title="(x$1: Int)Unit">currentIdx</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#50754" title="=&gt; Int">currentIdx</a> <span title="(x: Int)Boolean">&gt;=</span> <a href="#50745" title="=&gt; Int">recsPerMessageDiv2</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#50757" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">activeFuture</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#50761" title="=&gt; Boolean">canRequestMore</a><span class="delimiter">)</span>
      <a href="#50757" title="(x$1: edu.berkeley.cs.scads.comm.MessageFuture)Unit">activeFuture</a> = <a href="#50760" title="()edu.berkeley.cs.scads.comm.MessageFuture">issueNextRequest</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#77212" title="edu.berkeley.cs.scads.comm.Record">res</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.MessageFuture" id="50760">issueNextRequest</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="50761">canRequestMore</a>: <span title="Boolean">Boolean</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(ftch: edu.berkeley.cs.scads.comm.MessageFuture)IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="50762">getRecordsFromFuture</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageFuture" id="77284">ftch</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span><span class="delimiter">)</span>: <span title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">IndexedSeq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="50763">hasNext</a>: <span title="Boolean">Boolean</span> =
    <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#50748" title="=&gt; Boolean">isDone</a><span class="delimiter">)</span> <span title="Boolean(false)" class="keyword">false</span> 
    <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#50754" title="=&gt; Int">currentIdx</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#50751" title="=&gt; IndexedSeq[edu.berkeley.cs.scads.comm.Record]">currentBuffer</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span title="Boolean(true)" class="keyword">true</span>
    <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#50757" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">activeFuture</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#50751" title="(x$1: IndexedSeq[edu.berkeley.cs.scads.comm.Record])Unit">currentBuffer</a> = <a href="#50762" title="(ftch: edu.berkeley.cs.scads.comm.MessageFuture)IndexedSeq[edu.berkeley.cs.scads.comm.Record]">getRecordsFromFuture</a><span class="delimiter">(</span><a href="#50757" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">activeFuture</a><span class="delimiter">)</span>
      <a href="#50754" title="(x$1: Int)Unit">currentIdx</a> = <span title="Int(0)" class="int">0</span>
      <a href="#50757" title="(x$1: edu.berkeley.cs.scads.comm.MessageFuture)Unit">activeFuture</a> = <span title="Null(null)" class="keyword">null</span>
      <a href="#50763" title="=&gt; Boolean">hasNext</a>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#50761" title="=&gt; Boolean">canRequestMore</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#50757" title="=&gt; edu.berkeley.cs.scads.comm.MessageFuture">activeFuture</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#50757" title="(x$1: edu.berkeley.cs.scads.comm.MessageFuture)Unit">activeFuture</a> = <a href="#50760" title="()edu.berkeley.cs.scads.comm.MessageFuture">issueNextRequest</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#50763" title="=&gt; Boolean">hasNext</a>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#50748" title="(x$1: Boolean)Unit">isDone</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class ActorlessPartitionIterator extends edu.berkeley.cs.scads.storage.FutureBasedIterator with ScalaObject" id="9783">ActorlessPartitionIterator</a><a href="#9783" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.PartitionService" id="50782">partitionService</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="Option[Array[Byte]]" id="50783">minKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="50784">maxKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Int" id="50787">recsPerMessage</a>: <span title="Int">Int</span> = <span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <a href="#9780" title="edu.berkeley.cs.scads.storage.FutureBasedIterator">FutureBasedIterator</a><span class="delimiter">(</span><a href="#50782" title="edu.berkeley.cs.scads.comm.PartitionService">partitionService</a>, <a href="#50783" title="Option[Array[Byte]]">minKey</a>, <a href="#50784" title="Option[Array[Byte]]">maxKey</a>, <a href="#50787" title="Int">recsPerMessage</a><span class="delimiter">)</span> <span class="delimiter">{</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="50774">lastRecvKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="50777">lastSizeReturned</a> = <a href="#50787" title="Int">recsPerMessage</a>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.MessageFuture" id="50779">issueNextRequest</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span> = <span class="delimiter">{</span>
    <span class="comment">// dispatch new request</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.GetRangeRequest" id="77301">req</a> = 
      <a href="#50774" title="=&gt; Option[Array[Byte]]">lastRecvKey</a>.<span title="(f: Array[Byte] =&gt; edu.berkeley.cs.scads.comm.GetRangeRequest)Option[edu.berkeley.cs.scads.comm.GetRangeRequest]">map</span><span class="delimiter">(</span><a title="Array[Byte]" id="77306">sk</a> =&gt; <span title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#77306" title="Array[Byte]">sk</a><span class="delimiter">)</span>, <a href="#50784" title="Option[Array[Byte]]">maxKey</a>, limit=<span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#50787" title="Int">recsPerMessage</a><span class="delimiter">)</span>, offset=<span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.comm.GetRangeRequest)edu.berkeley.cs.scads.comm.GetRangeRequest">getOrElse</span><span class="delimiter">(</span><span title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#50783" title="Option[Array[Byte]]">minKey</a>, <a href="#50784" title="Option[Array[Byte]]">maxKey</a>, limit=<span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#50787" title="Int">recsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#50782" title="edu.berkeley.cs.scads.comm.PartitionService">partitionService</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#77301" title="edu.berkeley.cs.scads.comm.GetRangeRequest">req</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="50780">canRequestMore</a> = <a href="#50777" title="=&gt; Int">lastSizeReturned</a> <span title="(x: Int)Boolean">==</span> <a href="#50787" title="Int">recsPerMessage</a>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(ftch: edu.berkeley.cs.scads.comm.MessageFuture)IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="50781">getRecordsFromFuture</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageFuture" id="77353">ftch</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span><span class="delimiter">)</span> =
    <a href="#77353" title="edu.berkeley.cs.scads.comm.MessageFuture">ftch</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</span><span class="delimiter">(</span><span class="int">10</span> * <span class="int">60</span> <span title="Long(600000L)">*</span> <span class="int">1000</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageBody">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;GetRangeRequest timedout&quot;)" class="string">&quot;GetRangeRequest timedout&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record]">GetRangeResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="77382">recs</a><span class="delimiter">)</span> =&gt; 
        <a href="#50777" title="(x$1: Int)Unit">lastSizeReturned</a> = <a href="#77382" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="=&gt; Int">size</span>
        <a href="#50774" title="(x$1: Option[Array[Byte]])Unit">lastRecvKey</a> = <a href="#77382" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="=&gt; Option[edu.berkeley.cs.scads.comm.Record]">lastOption</span>.<span title="(f: edu.berkeley.cs.scads.comm.Record =&gt; Array[Byte])Option[Array[Byte]]">map</span><span class="delimiter">(</span><a href="#77387" title="edu.berkeley.cs.scads.comm.Record">_</a>.<span title="=&gt; Array[Byte]">key</span><span class="delimiter">)</span> 
        <a href="#77382" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="scala.collection.immutable.IndexedSeq[edu.berkeley.cs.scads.comm.Record]">toIndexedSeq</span>
      <span class="keyword">case</span> <a title="Nothing" id="77397">e</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid response to a GetRangeRequest: &quot;)" class="string">&quot;Invalid response to a GetRangeRequest: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#77397" title="edu.berkeley.cs.scads.comm.MessageBody">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class CursorBasedPartitionIterator extends edu.berkeley.cs.scads.storage.FutureBasedIterator with ScalaObject" id="9786">CursorBasedPartitionIterator</a><a href="#9786" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.PartitionService" id="67004">partitionService</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="Option[Array[Byte]]" id="67005">minKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="67006">maxKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Int" id="67009">recsPerMessage</a>: <span title="Int">Int</span> = <span title="Int(8192)" class="int">8192</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <a href="#9780" title="edu.berkeley.cs.scads.storage.FutureBasedIterator">FutureBasedIterator</a><span class="delimiter">(</span><a href="#67004" title="edu.berkeley.cs.scads.comm.PartitionService">partitionService</a>, <a href="#67005" title="Option[Array[Byte]]">minKey</a>, <a href="#67006" title="Option[Array[Byte]]">maxKey</a>, <a href="#67009" title="Int">recsPerMessage</a><span class="delimiter">)</span> <span class="delimiter">{</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[Int]" id="66996">cursorId</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="object None">None</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="66999">isServerDone</a> = <span title="Boolean(false)" class="keyword">false</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.MessageFuture" id="67001">issueNextRequest</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.CursorScanRequest" id="77410">rec</a> = <span title="(cursorId: Option[Int], recsPerRequest: Int)edu.berkeley.cs.scads.comm.CursorScanRequest">CursorScanRequest</span><span class="delimiter">(</span><a href="#66996" title="=&gt; Option[Int]">cursorId</a>, <a href="#67009" title="Int">recsPerMessage</a><span class="delimiter">)</span>
    <a href="#67004" title="edu.berkeley.cs.scads.comm.PartitionService">partitionService</a> <span title="(body: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageFuture">!!</span> <a href="#77410" title="edu.berkeley.cs.scads.comm.CursorScanRequest">rec</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="67002">canRequestMore</a> = <span title="=&gt; Boolean">!</span><a href="#66999" title="=&gt; Boolean">isServerDone</a> 
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(ftch: edu.berkeley.cs.scads.comm.MessageFuture)IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="67003">getRecordsFromFuture</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageFuture" id="77461">ftch</a>: <span title="edu.berkeley.cs.scads.comm.MessageFuture">MessageFuture</span><span class="delimiter">)</span> =
    <a href="#77461" title="edu.berkeley.cs.scads.comm.MessageFuture">ftch</a>.<span title="(timeout: Long)Option[edu.berkeley.cs.scads.comm.MessageBody]">get</span><span class="delimiter">(</span><span class="int">3</span> * <span class="int">60</span> <span title="Long(180000L)">*</span> <span class="int">1000</span><span class="delimiter">)</span>.<span title="(default: =&gt; edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.MessageBody">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;CursorScanRequest timedout&quot;)" class="string">&quot;CursorScanRequest timedout&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">CursorScanResponse</span><span class="delimiter">(</span><a title="Option[Int]" id="77529">id</a>, <a title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]" id="77530">recs</a><span class="delimiter">)</span> =&gt;
        <a href="#66996" title="(x$1: Option[Int])Unit">cursorId</a> = <a href="#77529" title="Option[Int]">id</a>
        <a href="#66999" title="(x$1: Boolean)Unit">isServerDone</a> = <a href="#77529" title="Option[Int]">id</a>.<span title="=&gt; Boolean">isEmpty</span>
        <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#66999" title="=&gt; Boolean">isServerDone</a> <span title="(x: Boolean)Boolean">||</span> <a href="#77530" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#67009" title="Int">recsPerMessage</a><span class="delimiter">)</span>
        <a href="#77530" title="IndexedSeq[edu.berkeley.cs.scads.comm.Record]">recs</a>
      <span class="keyword">case</span> <a title="Nothing" id="77538">e</a> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid response to a CursorScanRequest: &quot;)" class="string">&quot;Invalid response to a CursorScanRequest: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#77538" title="edu.berkeley.cs.scads.comm.MessageBody">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Iterator that makes succesive GetRange requests to the specified partitionService to retrieve all values [minKey, maxKey).
 * Records are retrieved in batches of size recsPerMessage by an async Actor and are buffered upto bufferSize.
 * Note, this iterator is not threadsafe.
 */</span>
<span class="keyword">class</span> <a title="class PartitionIterator extends java.lang.Object with Iterator[edu.berkeley.cs.scads.comm.Record] with ScalaObject" id="9789">PartitionIterator</a><a href="#9789" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.PartitionService" id="67062">partitionService</a>: <span title="edu.berkeley.cs.scads.comm.PartitionService">PartitionService</span>, <a title="Option[Array[Byte]]" id="67063">minKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="67064">maxKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Int" id="67068">recsPerMessage</a>: <span title="Int">Int</span> = <span title="Int(1000)" class="int">1000</span>, <a title="Int" id="67069">bufferSize</a>: <span title="Int">Int</span> = <span title="Int(5)" class="int">5</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="Iterator[edu.berkeley.cs.scads.comm.Record]">Iterator</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="67042">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Queue used to exchange record sets between the actor and the consumer of the iterator
   * Each time a recordset is retrieved a RecordSetTaken message should be sent to the iterActor
   */</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.util.concurrent.ArrayBlockingQueue[Seq[edu.berkeley.cs.scads.comm.Record]]" id="67044">availableRecordSets</a> = <span title="java.util.concurrent.ArrayBlockingQueue[Seq[edu.berkeley.cs.scads.comm.Record]]" class="keyword">new</span> <span title="java.util.concurrent.ArrayBlockingQueue[Seq[edu.berkeley.cs.scads.comm.Record]]">ArrayBlockingQueue</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#67069" title="Int">bufferSize</a><span class="delimiter">)</span>
  <span class="comment">/**
   * The current record set being iterated over.
   * Note it is the responsibility of the taker of the last record to set
   * this back to None so that subsuquent calls to next/hasNext will retrieve a new RecordSet
   * from the queue.
   * A recordset with 0 or 1 items denotes the end of the iterator.
   */</span>
  <span class="keyword">var</span> <a title="Option[Seq[edu.berkeley.cs.scads.comm.Record]]" id="67047">currentRecordSet</a>: <span title="Option[Seq[edu.berkeley.cs.scads.comm.Record]]">Option</span><span class="delimiter">[</span>Seq<span class="delimiter">[</span>Record<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object None">None</span>
  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="Int" id="67050">positionInRecordSet</a> = <span title="Int(0)" class="int">0</span>
  <span class="keyword">protected</span> <span class="keyword">var</span> <a title="Boolean" id="67053">done</a> = <span title="Boolean(false)" class="keyword">false</span>

  <span class="keyword">protected</span> <span class="keyword">object</span> <a title="object PartitionIterator.this.RecordSetTaken" id="67055">RecordSetTaken</a>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="scala.actors.Actor" id="67057">iterActor</a> = <span title="(body: =&gt; Unit)scala.actors.Actor">actor</span> <span class="delimiter">{</span>
    <span class="keyword">implicit</span> <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteActorProxy" id="77840">remoteActor</a> = <span title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</span>.<span title="(a: scala.actors.Actor)edu.berkeley.cs.scads.comm.RemoteActorProxy">registerActor</span><span class="delimiter">(</span><span title="=&gt; scala.actors.Actor">self</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="77841">currentKey</a> = <a href="#67063" title="Option[Array[Byte]]">minKey</a>
    <span class="keyword">var</span> <a title="Int" id="77842">outstandingRecordSets</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">var</span> <a title="Boolean" id="77843">done</a> = <span title="Boolean(false)" class="keyword">false</span>


    <span title="(body: =&gt; Unit)Unit">loop</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#77843" title="Boolean">done</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#77842" title="Int">outstandingRecordSets</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#67069" title="Int">bufferSize</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#67062" title="edu.berkeley.cs.scads.comm.PartitionService">partitionService</a>.<span title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</span><a href="#77840" title="edu.berkeley.cs.scads.comm.RemoteActorProxy" class="delimiter">(</a><span title="(minKey: Option[Array[Byte]], maxKey: Option[Array[Byte]], limit: Option[Int], offset: Option[Int], ascending: Boolean)edu.berkeley.cs.scads.comm.GetRangeRequest">GetRangeRequest</span><span class="delimiter">(</span><a href="#77841" title="Option[Array[Byte]]">currentKey</a>, <a href="#67064" title="Option[Array[Byte]]">maxKey</a>, limit=<span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#67068" title="Int">recsPerMessage</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

        <span title="(f: PartialFunction[Any,Unit])Nothing">react</span> <a href="#77939" title="Unit" class="delimiter">{</a>
          <span class="keyword">case</span> <span title="Unit">GetRangeResponse</span><span class="delimiter">(</span><a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="77941">recs</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
            <a href="#77842" title="Int">outstandingRecordSets</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
            <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#77941" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span title="object edu.berkeley.cs.scads.comm.MessageHandler">MessageHandler</span>.<span title="(ra: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">unregisterActor</span><span class="delimiter">(</span><a href="#77840" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">remoteActor</a><span class="delimiter">)</span>
              <a href="#67044" title="=&gt; java.util.concurrent.ArrayBlockingQueue[Seq[edu.berkeley.cs.scads.comm.Record]]">availableRecordSets</a>.<span title="(x$1: Seq[edu.berkeley.cs.scads.comm.Record])Boolean">offer</span><span class="delimiter">(</span><a href="#77941" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a><span class="delimiter">)</span>
              <a href="#77843" title="Boolean">done</a> = <span title="Boolean(true)" class="keyword">true</span>
            <span class="delimiter">}</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
              <a href="#67044" title="=&gt; java.util.concurrent.ArrayBlockingQueue[Seq[edu.berkeley.cs.scads.comm.Record]]">availableRecordSets</a>.<span title="(x$1: Seq[edu.berkeley.cs.scads.comm.Record])Boolean">offer</span><span class="delimiter">(</span><a href="#77941" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="(n: Int)Seq[edu.berkeley.cs.scads.comm.Record]">dropRight</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#77841" title="Option[Array[Byte]]">currentKey</a> = <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#77941" title="Seq[edu.berkeley.cs.scads.comm.Record]">recs</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.Record">last</span>.<span title="=&gt; Array[Byte]">key</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span class="keyword">else</span> <span class="delimiter">{</span>
        <span title="(f: PartialFunction[Any,Unit])Nothing">react</span> <a href="#77977" title="Unit" class="delimiter">{</a>
          <span class="keyword">case</span> <a href="#67055" title="Unit">RecordSetTaken</a> =&gt; <a href="#77842" title="Int">outstandingRecordSets</a> <span title="(x: Int)Int">-=</span> <span title="Int(1)" class="int">1</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]" id="67059">getCurrentRecordSet</a>: <span title="Seq[edu.berkeley.cs.scads.comm.Record]">Seq</span><span class="delimiter">[</span>Record<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#67047" title="=&gt; Option[Seq[edu.berkeley.cs.scads.comm.Record]]">currentRecordSet</a>.<span title="(default: =&gt; Seq[edu.berkeley.cs.scads.comm.Record])Seq[edu.berkeley.cs.scads.comm.Record]">getOrElse</span> <span class="delimiter">{</span>
      <a href="#67047" title="(x$1: Option[Seq[edu.berkeley.cs.scads.comm.Record]])Unit">currentRecordSet</a> = <span title="(x: Seq[edu.berkeley.cs.scads.comm.Record])Some[Seq[edu.berkeley.cs.scads.comm.Record]]">Some</span><span class="delimiter">(</span><a href="#67044" title="=&gt; java.util.concurrent.ArrayBlockingQueue[Seq[edu.berkeley.cs.scads.comm.Record]]">availableRecordSets</a>.<span title="()Seq[edu.berkeley.cs.scads.comm.Record]">take</span><span class="delimiter">)</span>
      <a href="#67050" title="(x$1: Int)Unit">positionInRecordSet</a> = <span title="Int(0)" class="int">0</span>
      <a href="#67057" title="=&gt; scala.actors.Actor">iterActor</a> <span title="(msg: Any)Unit">!</span> <a href="#67055" title="object PartitionIterator.this.RecordSetTaken">RecordSetTaken</a>
      <a href="#67047" title="=&gt; Option[Seq[edu.berkeley.cs.scads.comm.Record]]">currentRecordSet</a>.<span title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">get</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()edu.berkeley.cs.scads.comm.Record" id="67060">next</a>: <span title="edu.berkeley.cs.scads.comm.Record">Record</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[edu.berkeley.cs.scads.comm.Record]" id="78006">set</a> = <a href="#67059" title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">getCurrentRecordSet</a>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.Record" id="78007">result</a> = <a href="#78006" title="(idx: Int)edu.berkeley.cs.scads.comm.Record">set</a><span class="delimiter">(</span><a href="#67050" title="=&gt; Int">positionInRecordSet</a><span class="delimiter">)</span>
    <a href="#67050" title="(x$1: Int)Unit">positionInRecordSet</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#67050" title="=&gt; Int">positionInRecordSet</a> <span title="(x: Int)Boolean">&gt;=</span> <a href="#78006" title="Seq[edu.berkeley.cs.scads.comm.Record]">set</a>.<span title="=&gt; Int">size</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#78006" title="Seq[edu.berkeley.cs.scads.comm.Record]">set</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <a href="#67047" title="(x$1: Option[Seq[edu.berkeley.cs.scads.comm.Record]])Unit">currentRecordSet</a> = <span title="object None">None</span>
    <a href="#78007" title="edu.berkeley.cs.scads.comm.Record">result</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="67061">hasNext</a>: <span title="Boolean">Boolean</span> = <a href="#67059" title="=&gt; Seq[edu.berkeley.cs.scads.comm.Record]">getCurrentRecordSet</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <a href="#67050" title="=&gt; Int">positionInRecordSet</a>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>