<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>server/StorageHandler.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> com.sleepycat.je.<span class="delimiter">{</span>Cursor,Database, DatabaseConfig, DatabaseException, DatabaseEntry, Environment, LockMode, OperationStatus, Durability, Transaction<span class="delimiter">}</span>

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> edu.berkeley.cs.avro.runtime._

<span class="keyword">import</span> org.apache.zookeeper.CreateMode

<span class="keyword">import</span> java.util.Comparator
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong
<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.mutable.<span class="delimiter">{</span> Set =&gt; MSet, HashSet <span class="delimiter">}</span>

<span class="keyword">import</span> org.apache.zookeeper.<span title="object org.apache.zookeeper.KeeperException">KeeperException</span>.NodeExistsException

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.StorageHandler" id="10095">StorageHandler</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicLong" id="65212">idGen</a> = <span title="()java.util.concurrent.atomic.AtomicLong" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicLong">AtomicLong</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Basic implementation of a storage handler using BDB as a backend.
 */</span>
<span class="keyword">class</span> <a title="class StorageHandler extends java.lang.Object with edu.berkeley.cs.scads.comm.ServiceHandler[edu.berkeley.cs.scads.storage.StorageMessage] with ScalaObject" id="10097">StorageHandler</a><a href="#10097" title="ScalaObject" class="delimiter">(</a><a title="com.sleepycat.je.Environment" id="66248">env</a>: <span title="com.sleepycat.je.Environment">Environment</span>, <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="66249">root</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, <span class="keyword">val</span> <a title="=&gt; Option[String]" id="66250">name</a>:<span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <span title="edu.berkeley.cs.scads.comm.ServiceHandler[edu.berkeley.cs.scads.storage.StorageMessage]">ServiceHandler</span><span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span> <span class="delimiter">{</span>

  @volatile <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="65158">serverNode</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> = _

  <span class="keyword">val</span> <a title="Long" id="65160">counterId</a> = <a href="#10095" title="object edu.berkeley.cs.scads.storage.StorageHandler">StorageHandler</a>.<a href="#65212" title="=&gt; java.util.concurrent.atomic.AtomicLong">idGen</a>.<span title="()Long">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.storage.package.StorageRegistry.type" id="65162">registry</a> = <a href="../package.scala.html#10137" title="object edu.berkeley.cs.scads.storage.package.StorageRegistry">StorageRegistry</a>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="65163">toString</a> = 
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&lt;CounterID: %d, EnvDir: %s, Handle: %s&gt;&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#65160" title="=&gt; Long">counterId</a>, <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="()java.io.File">getHome</span>.<span title="()java.lang.String">getCanonicalPath</span>, <a href="#10097" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span>

  <span class="comment">/** Logger must be lazy so we can reference in startup() */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="65165">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="65166">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="65168">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="82779">a</a>: <a href="#65168" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#82779" title="A">a</a><span class="delimiter">)</span>

  <span class="comment">/** Hashmap of currently open partition handler, indexed by partitionId.
   * Must also be lazy so we can reference in startup() */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]" id="65170">partitions</a> = <span title="()java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">ConcurrentHashMap</span><span class="delimiter">[</span>String, PartitionHandler<span class="delimiter">]</span>

  <span class="comment">/**
   * Factory for NamespaceContext
   */</span>
  <span class="keyword">object</span> <a title="object StorageHandler.this.NamespaceContext" id="65171">NamespaceContext</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(schema: org.apache.avro.Schema)StorageHandler.this.NamespaceContext" id="83109">apply</a><span class="delimiter">(</span><a title="org.apache.avro.Schema" id="83241">schema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span>: <a href="#83549" title="StorageHandler.this.NamespaceContext">NamespaceContext</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="comparator extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator" id="83243">comparator</a> = <a href="#83244" title="java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator{}" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator" id="83244">AvroComparator</a> <span class="delimiter">{</span> <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="83246">keySchema</a> = <a href="#83241" title="org.apache.avro.Schema">schema</a> <span class="delimiter">}</span>
      <a href="#83549" title="(comparator: edu.berkeley.cs.scads.storage.AvroComparator, partitions: scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)])StorageHandler.this.NamespaceContext">NamespaceContext</a><span class="delimiter">(</span><a href="#83243" title="comparator extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator">comparator</a>, <span title="()scala.collection.mutable.HashSet[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">HashSet</span><span class="delimiter">[</span><span class="delimiter">(</span>String, PartitionHandler<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Contains metadata for namespace
   */</span>
  case <span class="keyword">class</span> <a title="(x$0: StorageHandler.this.NamespaceContext)Option[(edu.berkeley.cs.scads.storage.AvroComparator, scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)])]" id="83549">NamespaceContext</a><a href="#83549" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.storage.AvroComparator" id="83521">comparator</a>: <a href="server/KeyComparison.scala.html#10091" title="edu.berkeley.cs.scads.storage.AvroComparator">AvroComparator</a>, <a title="scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]" id="83522">partitions</a>: <span title="scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">MSet</span><span class="delimiter">[</span><span class="delimiter">(</span>String, PartitionHandler<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>

  <span class="comment">/** 
   * Map of namespaces to currently open partitions for that namespace.
   * The values of this map (mutable sets) must be synchronized on before reading/writing 
   */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]" id="65175">namespaces</a> = <span title="()java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">ConcurrentHashMap</span><span class="delimiter">[</span>String, NamespaceContext<span class="delimiter">]</span>

  <span class="comment">/* Register a shutdown hook for proper cleanup */</span>
  <span class="keyword">class</span> <a title="class SDRunner extends java.lang.Thread with ScalaObject" id="65176">SDRunner</a><a href="#65176" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.ServiceHandler[_]" id="83560">sh</a>: <span title="edu.berkeley.cs.scads.comm.ServiceHandler[_]">ServiceHandler</span><span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Thread">Thread</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="83554">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#83560" title="edu.berkeley.cs.scads.comm.ServiceHandler[_]">sh</a>.<span title="=&gt; Unit">stop</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  java.lang.<span title="object java.lang.Runtime">Runtime</span>.<span title="()java.lang.Runtime">getRuntime</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.Thread)Unit">addShutdownHook</span><span class="delimiter">(</span><span title="StorageHandler.this.SDRunner" class="keyword">new</span> <a href="#65176" title="StorageHandler.this.SDRunner">SDRunner</a><span class="delimiter">(</span><a href="#10097" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/** Points to the DB that can recreate partitions on restart.
   * Must also be lazy so we can reference in startup() */</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="65178">partitionDb</a> =
    <a href="#65188" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><span title="java.lang.String(&quot;partitiondb&quot;)" class="string">&quot;partitiondb&quot;</span>, <span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span>

    <span class="comment">/**
     * Workload statistics thread periodically clears the stats from all partitions
     */</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="65179">period</a> = <span title="Int(20)" class="int">20</span> <span class="comment">// seconds</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="65181">intervalsToSave</a> = <span title="Int(3)" class="int">3</span>
    <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.lang.Thread" id="65184">statsThread</a> = <span title="(x$1: java.lang.Runnable, x$2: java.lang.String)java.lang.Thread" class="keyword">new</span> <span title="java.lang.Thread">Thread</span><span class="delimiter">(</span><span title="StorageHandler.this.StatsManager" class="keyword">new</span> <a href="#65185" title="StorageHandler.this.StatsManager">StatsManager</a><span class="delimiter">(</span><a href="#65179" title="=&gt; Int">period</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;workload statistic clearing thread&quot;)" class="string">&quot;workload statistic clearing thread&quot;</span><span class="delimiter">)</span>
    <a href="#65183" title="=&gt; java.lang.Thread">statsThread</a>.<span title="(x$1: Boolean)Unit">setDaemon</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#65183" title="=&gt; java.lang.Thread">statsThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>
    
    <span class="keyword">class</span> <a title="class StatsManager extends java.lang.Object with java.lang.Runnable with ScalaObject" id="65185">StatsManager</a><a href="#65185" title="ScalaObject" class="delimiter">(</a><a title="Int" id="83219">periodInSeconds</a>:<span title="Int">Int</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Runnable">Runnable</span> <span class="delimiter">{</span>
      @volatile <span class="keyword">var</span> <a title="Boolean" id="83215">running</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span class="keyword">def</span> <a title="()Unit" id="83217">run</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> =
	<span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#83215" title="=&gt; Boolean">running</a><span class="delimiter">)</span> <a href="#83629" title="()Unit" class="delimiter">{</a>
	  <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#83219" title="Int">periodInSeconds</a><span title="=&gt; Long">*</span><span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>
	  <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;starting stats clearing&quot;)" class="string">&quot;starting stats clearing&quot;</span><span class="delimiter">)</span>
	  <a href="#65169" title="(m: java.util.concurrent.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler])scala.collection.mutable.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; edu.berkeley.cs.scads.storage.PartitionWorkloadStats)Unit">foreach</span><span class="delimiter">(</span><a href="#84124" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<a href="PartitionHandler.scala.html#80289" title="()edu.berkeley.cs.scads.storage.PartitionWorkloadStats">resetWorkloadStats</a><span class="delimiter">)</span>
	  <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;finished stats clearing&quot;)" class="string">&quot;finished stats clearing&quot;</span><span class="delimiter">)</span>
	<span class="delimiter">}</span>
      <span class="keyword">def</span> <a title="()Unit" id="83218">stop</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#83215" title="(x$1: Boolean)Unit">running</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="65186">makeDatabase</a><span class="delimiter">(</span><a title="String" id="83198">databaseName</a>: <span title="String">String</span>, <a title="org.apache.avro.Schema" id="83199">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="Option[com.sleepycat.je.Transaction]" id="83200">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> =
    <a href="#65188" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#83198" title="String">databaseName</a>, <span title="(x: edu.berkeley.cs.scads.storage.AvroBdbComparator)Some[edu.berkeley.cs.scads.storage.AvroBdbComparator]">Some</span><span class="delimiter">(</span><a href="server/KeyComparison.scala.html#84481" title="(schema: org.apache.avro.Schema)edu.berkeley.cs.scads.storage.AvroBdbComparator" class="keyword">new</a> <a href="server/KeyComparison.scala.html#10092" title="edu.berkeley.cs.scads.storage.AvroBdbComparator">AvroBdbComparator</a><span class="delimiter">(</span><a href="#83199" title="org.apache.avro.Schema">keySchema</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#83200" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, keySchema: String, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="65187">makeDatabase</a><span class="delimiter">(</span><a title="String" id="83194">databaseName</a>: <span title="String">String</span>, <a title="String" id="83195">keySchema</a>: <span title="String">String</span>, <a title="Option[com.sleepycat.je.Transaction]" id="83196">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> =
    <a href="#65188" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#83194" title="String">databaseName</a>, <span title="(x: edu.berkeley.cs.scads.storage.AvroBdbComparator)Some[edu.berkeley.cs.scads.storage.AvroBdbComparator]">Some</span><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.AvroBdbComparator" class="keyword">new</span> <a href="server/KeyComparison.scala.html#10092" title="edu.berkeley.cs.scads.storage.AvroBdbComparator">AvroBdbComparator</a><span class="delimiter">(</span><a href="#83195" title="String">keySchema</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#83196" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="65188">makeDatabase</a><span class="delimiter">(</span><a title="String" id="83190">databaseName</a>: <span title="String">String</span>, <a title="Option[java.util.Comparator[Array[Byte]]]" id="83191">comparator</a>: <span title="Option[java.util.Comparator[Array[Byte]]]">Option</span><span class="delimiter">[</span>Comparator<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[com.sleepycat.je.Transaction]" id="83192">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseConfig" id="84164">dbConfig</a> = <span title="com.sleepycat.je.DatabaseConfig" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseConfig">DatabaseConfig</span>
    <a href="#84164" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setAllowCreate</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#83191" title="Option[java.util.Comparator[Array[Byte]]]">comparator</a>.<span title="(f: java.util.Comparator[Array[Byte]] =&gt; com.sleepycat.je.DatabaseConfig)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Comparator[Array[Byte]]" id="84259">comp</a> =&gt; <a href="#84164" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: java.util.Comparator[Array[Byte]])com.sleepycat.je.DatabaseConfig">setBtreeComparator</span><span class="delimiter">(</span><a href="#84259" title="java.util.Comparator[Array[Byte]]">comp</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#84164" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setTransactional</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String, x$3: com.sleepycat.je.DatabaseConfig)com.sleepycat.je.Database">openDatabase</span><span class="delimiter">(</span><a href="#83192" title="Option[com.sleepycat.je.Transaction]">txn</a>.<span title="(implicit ev: &lt;:&lt;[Null,com.sleepycat.je.Transaction])com.sleepycat.je.Transaction">orNull</span>, <a href="#83190" title="String">databaseName</a>, <a href="#84164" title="com.sleepycat.je.DatabaseConfig">dbConfig</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)org.apache.avro.Schema" id="65189">keySchemaFor</a><span class="delimiter">(</span><a title="String" id="84274">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84277">nsRoot</a> = <a href="#65199" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#84274" title="String">namespace</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="84278">keySchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#84277" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;keySchema&quot;)" class="string">&quot;keySchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#84278" title="java.lang.String">keySchema</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="65190">schemasAndValueClassFor</a><span class="delimiter">(</span><a title="String" id="84296">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84299">nsRoot</a> = <a href="#65199" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#84296" title="String">namespace</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="84300">keySchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#84299" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;keySchema&quot;)" class="string">&quot;keySchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="84301">valueSchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#84299" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;valueSchema&quot;)" class="string">&quot;valueSchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="84302">valueClass</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#84299" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;valueClass&quot;)" class="string">&quot;valueClass&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span title="(_1: org.apache.avro.Schema, _2: org.apache.avro.Schema, _3: java.lang.String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" class="delimiter">(</span><span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#84300" title="java.lang.String">keySchema</a><span class="delimiter">)</span>,<span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#84301" title="java.lang.String">valueSchema</a><span class="delimiter">)</span>,<a href="#84302" title="java.lang.String">valueClass</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** 
   * Preconditions:
   *   (1) namespace is a valid namespace in zookeeper
   *   (2) keySchema is already set in the namespace/keySchema file
   *       in ZooKeeper
   *   (3) valueSchema is already set in the namespace/valueSchema file
   *       in ZooKeeper
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler" id="65191">makeBdbPartitionHandler</a><span class="delimiter">(</span>
      <a title="com.sleepycat.je.Database" id="84335">database</a>: <span title="com.sleepycat.je.Database">Database</span>, <a title="String" id="84336">namespace</a>: <span title="String">String</span>, <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84337">partitionIdLock</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
      <a title="Option[Array[Byte]]" id="84338">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="84339">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="84342">schemasvc</a> = <a href="#65190" title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasAndValueClassFor</a><span class="delimiter">(</span><a href="#84336" title="String">namespace</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">new</span> <a href="PartitionHandler.scala.html#10059" title="edu.berkeley.cs.scads.storage.PartitionHandler">PartitionHandler</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.BdbStorageManager" class="keyword">new</span> <a href="BdbParitionHandler.scala.html#10007" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a><span class="delimiter">(</span><a href="#84335" title="com.sleepycat.je.Database">database</a>, <a href="#84337" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#84338" title="Option[Array[Byte]]">startKey</a>, <a href="#84339" title="Option[Array[Byte]]">endKey</a>, <a href="#65199" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#84336" title="String">namespace</a><span class="delimiter">)</span>, <a href="#84342" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_1</span>, <a href="#84342" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler" id="65192">makeInMemPartitionHandler</a>
    <span class="delimiter">(</span><a title="String" id="84347">namespace</a>:<span title="String">String</span>,<a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84348">partitionIdLock</a>:ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
     <a title="Option[Array[Byte]]" id="84349">startKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="84350">endKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="84353">schemasvc</a> = <a href="#65190" title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasAndValueClassFor</a><span class="delimiter">(</span><a href="#84347" title="String">namespace</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">new</span> <a href="PartitionHandler.scala.html#10059" title="edu.berkeley.cs.scads.storage.PartitionHandler">PartitionHandler</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.InMemStorageManager" class="keyword">new</span> <a href="InMemStorageManager.scala.html#10027" title="edu.berkeley.cs.scads.storage.InMemStorageManager">InMemStorageManager</a><span class="delimiter">(</span><a href="#84348" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#84349" title="Option[Array[Byte]]">startKey</a>, <a href="#84350" title="Option[Array[Byte]]">endKey</a>, <a href="#65199" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#84347" title="String">namespace</a><span class="delimiter">)</span>,<a href="#84353" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_1</span>, <a href="#84353" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_2</span>, <a href="#84353" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; java.lang.String">_3</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
                                        

  <span class="comment">/** Iterator scans the entire cursor and does not close it */</span>
  <span class="keyword">private</span> <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.storage.StorageHandler.cursorToIterator : (cursor: com.sleepycat.je.Cursor)Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="65193">cursorToIterator</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="82785">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span><span class="delimiter">)</span>: <span title="Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">Iterator</span><span class="delimiter">[</span><span class="delimiter">(</span>DatabaseEntry, DatabaseEntry<span class="delimiter">)</span><span class="delimiter">]</span>
    = <a href="#84358" title="java.lang.Object with Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]{}" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="84358">Iterator</a><span class="delimiter">[</span><span class="delimiter">(</span>DatabaseEntry, DatabaseEntry<span class="delimiter">)</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="84530">cur</a> = <a href="#84532" title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="84532">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="84540">tuple</a> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
        <span title="Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" class="keyword">if</span> <span class="delimiter">(</span><a href="#82785" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#84540" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a>.<span title="=&gt; com.sleepycat.je.DatabaseEntry">_1</span>, <a href="#84540" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a>.<span title="=&gt; com.sleepycat.je.DatabaseEntry">_2</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
          <span title="(x: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry))Some[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">Some</span><span class="delimiter">(</span><a href="#84540" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a><span class="delimiter">)</span>
        <span class="keyword">else</span>
          <span title="object None">None</span>
      <span class="delimiter">}</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="84533">hasNext</a> = <a href="#84530" title="=&gt; Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cur</a>.<span title="=&gt; Boolean">isDefined</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="84534">next</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#84530" title="=&gt; Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cur</a> <span title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">Some</span><span class="delimiter">(</span><a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="84573">tup</a><span class="delimiter">)</span> =&gt;
          <a href="#84530" title="(x$1: Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)])Unit">cur</a> = <a href="#84532" title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#84573" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tup</a>
        <span class="keyword">case</span> <span title="Nothing">None</span> =&gt;
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No more elements&quot;)" class="string">&quot;No more elements&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="comment">/**
   * Performs the following startup tasks:
   * * Register with zookeeper as an available server
   * * Reopen any partitions.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="65194">startup</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">/* Register with the zookeper as an available server */</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84591">availServs</a> = <a href="#66249" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>.<span title="(rpath: java.lang.String, tries: Int)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrCreate</span><span class="delimiter">(</span><span title="java.lang.String(&quot;availableServers&quot;)" class="string">&quot;availableServers&quot;</span><span class="delimiter">)</span>
    <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Created StorageHandler&quot;)" class="string">&quot;Created StorageHandler&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#66250" title="=&gt; Option[String]">name</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><a href="#10097" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a>.<span title="()String">toString</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#65158" title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)Unit">serverNode</a> = <a href="#84591" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">availServs</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#66250" title="=&gt; Option[String]">name</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><a href="#10097" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a>.<span title="()String">toString</span><span class="delimiter">)</span>, <a href="../Messages.scala.html#10800" title="(s: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])edu.berkeley.cs.scads.storage.StorageService">StorageService</a><span class="delimiter">(</span><a href="#10097" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">toBytes</span>, <span title="org.apache.zookeeper.CreateMode" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#66250" title="=&gt; Option[String]">name</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> CreateMode.<span title="org.apache.zookeeper.CreateMode(value EPHEMERAL)">EPHEMERAL</span> <span class="keyword">else</span> CreateMode.<span title="org.apache.zookeeper.CreateMode(value EPHEMERAL_SEQUENTIAL)">EPHEMERAL_SEQUENTIAL</span><span class="delimiter">)</span>

    <span class="comment">/* Reopen partitions */</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="84592">cursor</a> = <a href="#65177" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#65193" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.cursorToIterator : (cursor: com.sleepycat.je.Cursor)Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cursor</a>.<span title="(f: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry) =&gt; (java.lang.String, edu.berkeley.cs.scads.storage.CreatePartitionRequest))Iterator[(java.lang.String, edu.berkeley.cs.scads.storage.CreatePartitionRequest)]">map</span> <a href="#84710" title="(java.lang.String, edu.berkeley.cs.scads.storage.CreatePartitionRequest)" class="delimiter">{</a> <span class="keyword">case</span> <span title="(java.lang.String, edu.berkeley.cs.scads.storage.CreatePartitionRequest)" class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="84713">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="84714">value</a><span class="delimiter">)</span> =&gt;
      <span title="(_1: java.lang.String, _2: edu.berkeley.cs.scads.storage.CreatePartitionRequest)(java.lang.String, edu.berkeley.cs.scads.storage.CreatePartitionRequest)" class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#84713" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span>, <span class="delimiter">(</span>classOf<span title="java.lang.Class[edu.berkeley.cs.scads.storage.CreatePartitionRequest](classOf[edu.berkeley.cs.scads.storage.CreatePartitionRequest])" class="delimiter">[</span>CreatePartitionRequest<span class="delimiter">]</span>.<span title="()edu.berkeley.cs.scads.storage.CreatePartitionRequest">newInstance</span><span class="delimiter">)</span>.<span title="(data: Array[Byte])edu.berkeley.cs.scads.storage.CreatePartitionRequest">parse</span><span class="delimiter">(</span><a href="#84714" title="com.sleepycat.je.DatabaseEntry">value</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span title="(f: (java.lang.String, edu.berkeley.cs.scads.storage.CreatePartitionRequest) =&gt; scala.collection.mutable.Set[(java.lang.String, edu.berkeley.cs.scads.storage.PartitionHandler)])Unit">foreach</span> <a href="#84744" title="ctx.partitions.type" class="delimiter">{</a> <span class="keyword">case</span> <span title="ctx.partitions.type" class="delimiter">(</span><a title="java.lang.String" id="84747">partitionId</a>, <a title="edu.berkeley.cs.scads.storage.CreatePartitionRequest" id="84748">request</a><span class="delimiter">)</span> =&gt;

      <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Recreating partition %s from request %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#84747" title="java.lang.String">partitionId</a>, <a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a><span class="delimiter">)</span><span class="delimiter">)</span>

      <span class="comment">/* Grab partition root from ZooKeeper */</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84749">partitionsDir</a> = <a href="#65199" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24490" title="=&gt; String">namespace</a><span class="delimiter">)</span>.<span title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">apply</span><span class="delimiter">(</span><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>

      <span class="comment">/* Create the lock file, assuming that it does not already exist (since
       * the lock files are created ephemerally, so if this node dies, all the
       * lock files should die accordingly) */</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84750">partitionIdLock</a> =
        <span class="keyword">try</span> <span class="delimiter">{</span>
          <a href="#84749" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#84747" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="84767">e</a>: <span title="org.apache.zookeeper.KeeperException.NodeExistsException">NodeExistsException</span> =&gt;
            <span class="comment">/* The lock file has not been removed yet. Assume for now that
             * this lock file belonged to this partition to begin with, and we
             * had a race condition where the ephemeral nodes were not removed
             * in time that the node started back up. Therefore, delete the
             * existing lock file and recreate it */</span>
            <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">critical</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Clobbering lock file! Namespace: %s, PartitionID: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24490" title="=&gt; String">namespace</a>, <a href="#84747" title="java.lang.String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#84749" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: String)Unit">deleteChild</span><span class="delimiter">(</span><a href="#84747" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
            <a href="#84749" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#84747" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#84750" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#84747" title="java.lang.String">partitionId</a>, <span title="java.lang.String(&quot;Lock file was not created with the same name on restore&quot;)" class="string">&quot;Lock file was not created with the same name on restore&quot;</span><span class="delimiter">)</span>

      <span class="comment">// no need to grab locks below, because startup runs w/o any invocations</span>
      <span class="comment">// to process (so no races can occur)</span>

      <span class="comment">/* Make partition handler */</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="84751">db</a>      = <a href="#65186" title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24490" title="=&gt; String">namespace</a>, <a href="#65189" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24490" title="=&gt; String">namespace</a><span class="delimiter">)</span>, <span title="object None">None</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="84752">handler</a> = <a href="#65191" title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeBdbPartitionHandler</a><span class="delimiter">(</span><a href="#84751" title="com.sleepycat.je.Database">db</a>, <a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24490" title="=&gt; String">namespace</a>, <a href="#84750" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24496" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24499" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
			<span class="comment">//val handler = makePartitionHandlerWithAC(db, acdb, request.namespace, partitionIdLock, request.startKey, request.endKey)</span>

      <span class="comment">/* Add to our list of open partitions */</span>
      <a href="#65169" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: String, x$2: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">put</span><span class="delimiter">(</span><a href="#84747" title="java.lang.String">partitionId</a>, <a href="#84752" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span>

      <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="84753">ctx</a> = <a href="#65195" title="(namespace: String)StorageHandler.this.NamespaceContext">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a href="#84748" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">request</a>.<a href="../Messages.scala.html#24490" title="=&gt; String">namespace</a><span class="delimiter">)</span> 
      <a href="#84753" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a> <span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))ctx.partitions.type">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(java.lang.String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#84747" title="java.lang.String">partitionId</a>, <a href="#84752" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="delimiter">}</span>
    <a href="#84592" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    
  <span class="delimiter">}</span>

  <span class="comment">/**
   * WARNING: you must synchronize on the context for a namespace before
   * performaning any mutating operations (or to have the correct memory
   * read semantics)
   *
   * TODO: in the current implementation, once a namespace lock is created, it
   * remains for the duration of the JVM process (and is thus not eligible for
   * GC). this makes implementation easier (since we don't have to worry about
   * locks changing over time), but wastes memory
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)StorageHandler.this.NamespaceContext" id="65195">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a title="String" id="84794">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="84797">test</a> = <a href="#65174" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">get</span><span class="delimiter">(</span><a href="#84794" title="String">namespace</a><span class="delimiter">)</span>
    <span title="StorageHandler.this.NamespaceContext" class="keyword">if</span> <span class="delimiter">(</span><a href="#84797" title="StorageHandler.this.NamespaceContext">test</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#84797" title="StorageHandler.this.NamespaceContext">test</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="84798">ctx</a> = <a href="#83109" title="(schema: org.apache.avro.Schema)StorageHandler.this.NamespaceContext">NamespaceContext</a><span class="delimiter">(</span><a href="#65189" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#84794" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#65174" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: String, x$2: StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">putIfAbsent</span><span class="delimiter">(</span><a href="#84794" title="String">namespace</a>, <a href="#84798" title="StorageHandler.this.NamespaceContext">ctx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <a href="#84798" title="StorageHandler.this.NamespaceContext">ctx</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)Option[StorageHandler.this.NamespaceContext]" id="65196">getContextForNamespace</a><span class="delimiter">(</span><a title="String" id="84836">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = 
    <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#65174" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">get</span><span class="delimiter">(</span><a href="#84836" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)Option[StorageHandler.this.NamespaceContext]" id="65197">removeNamespaceContext</a><span class="delimiter">(</span><a title="String" id="84842">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = 
    <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#65174" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">remove</span><span class="delimiter">(</span><a href="#84842" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Performs the following shutdown tasks:
   *   Shutdown all active partitions
   *   Closes the bdb environment
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="65198">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">try</span> <a href="#65158" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serverNode</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="84851">e</a> =&gt; <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;failed to delete server node from zookeeper&quot;)" class="string">&quot;failed to delete server node from zookeeper&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#65169" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(i: java.util.Collection[edu.berkeley.cs.scads.storage.PartitionHandler])Iterable[edu.berkeley.cs.scads.storage.PartitionHandler]">values</span>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionHandler =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#85131" title="edu.berkeley.cs.scads.storage.PartitionHandler">_</a>.<span title="=&gt; Unit">stop</span><span class="delimiter">)</span>
    <a href="#65169" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#65174" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#65177" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="65199">getNamespaceRoot</a><span class="delimiter">(</span><a title="String" id="84279">namespace</a>: <span title="String">String</span><span class="delimiter">)</span>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> =
    <a href="#66249" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="85138" class="delimiter">(</a><span title="java.lang.String(&quot;namespaces&quot;)" class="string">&quot;namespaces&quot;</span><span class="delimiter">)</span>
      .<a href="#85138" title="Int" id="85140">get</a><span class="delimiter">(</span><a href="#84279" title="String" id="85139">namespace</a><span class="delimiter">)</span>
      .<span title="(default: =&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Attempted to open namespace that doesn\'t exist in zookeeper: &quot;)" class="string">&quot;Attempted to open namespace that doesn't exist in zookeeper: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#84279" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]], msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit" id="65200">process</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]" id="85150">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">Option</span><span class="delimiter">[</span>RemoteServiceProxy<span class="delimiter">[</span>StorageMessage<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.storage.StorageMessage" id="85151">msg</a>: <a href="../Messages.scala.html#9553" title="edu.berkeley.cs.scads.storage.StorageMessage">StorageMessage</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit" id="85155">reply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.storage.StorageMessage" id="85156">msg</a>: <a href="../Messages.scala.html#9553" title="edu.berkeley.cs.scads.storage.StorageMessage">StorageMessage</a><span class="delimiter">)</span> = <a href="#85150" title="Option[edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]]">src</a>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage] =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#85161" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">_</a> <a href="#10097" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)(implicit sender: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])Unit">!</a> <a href="#85156" title="edu.berkeley.cs.scads.storage.StorageMessage">msg</a><span class="delimiter">)</span>

    <a href="#85151" title="edu.berkeley.cs.scads.storage.StorageMessage">msg</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="85165">createRequest</a> @ CreatePartitionRequest<span class="delimiter">(</span><a title="String" id="85166">namespace</a>, <a title="String" id="85167">partitionType</a>, <a title="Option[Array[Byte]]" id="85168">startKey</a>, <a title="Option[Array[Byte]]" id="85169">endKey</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] CreatePartitionRequest for namespace %s, [%s, %s)&quot;)" class="string">&quot;[%s] CreatePartitionRequest for namespace %s, [%s, %s)&quot;</span>, <a href="#10097" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#85166" title="String">namespace</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#85168" title="Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#85169" title="Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="comment">/* Grab root to namespace from ZooKeeper */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="85170">nsRoot</a> = <a href="#65199" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#85166" title="String">namespace</a><span class="delimiter">)</span>

        <span class="comment">/* Grab a lock on the partitionId. 
         * TODO: Handle sequence wrap-around */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="85171">partitionIdLock</a> = <a href="#85170" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="85209" class="delimiter">(</a><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>.<a href="#85209" title="Array[Byte]" id="85212">createChild</a><span class="delimiter">(</span><a href="#85166" title="String" id="85210">namespace</a>, mode = CreateMode.<a title="org.apache.zookeeper.CreateMode(value EPHEMERAL_SEQUENTIAL)" id="85211">EPHEMERAL_SEQUENTIAL</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="String" id="85172">partitionId</a> = <a href="#85171" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span>

        <span class="comment">//logger.info(&quot;Active partitions after insertion in ZooKeeper: %s&quot;.format(nsRoot(&quot;partitions&quot;).children.mkString(&quot;,&quot;)))</span>

        <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%d active partitions after insertion in ZooKeeper&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#85170" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">children</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="85173">ctx</a> = <a href="#65195" title="(namespace: String)StorageHandler.this.NamespaceContext">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a href="#85166" title="String">namespace</a><span class="delimiter">)</span> 

        <span class="comment">/* For now, the creation of DBs under a namespace are executed
         * serially. It is assumed that a single node will not run multiple
         * storage handlers sharing the same namespaces (which allows us to
         * lock the namespace in memory. */</span>
        <span class="comment">// TODO: cleanup if fails</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="85174">handler</a> = <a href="#85173" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="85221">handler</a> =
            <a href="#85167" title="String">partitionType</a> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="string">&quot;inmemory&quot;</span> =&gt; <span class="delimiter">{</span>
                <span class="comment">/* Start a new transaction to atomically add an entry into the partition DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="85224">txn</a> = <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
                <a href="#65177" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#85224" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#85172" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#85165" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">createRequest</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#85224" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                <a href="#65192" title="(namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeInMemPartitionHandler</a><span class="delimiter">(</span><a href="#85166" title="String">namespace</a>,<a href="#85171" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#85168" title="Option[Array[Byte]]">startKey</a>, <a href="#85169" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="string">&quot;bdb&quot;</span> =&gt; <span class="delimiter">{</span>
                <span class="comment">/* Start a new transaction to atomically make both the namespace DB,
                 * and add an entry into the partition DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="85235">txn</a> = <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

                <span class="comment">/* Open the namespace DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="85236">newDb</a> = <a href="#65186" title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#85166" title="String">namespace</a>, <a href="#65189" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#85166" title="String">namespace</a><span class="delimiter">)</span>, <span title="(x: com.sleepycat.je.Transaction)Some[com.sleepycat.je.Transaction]">Some</span><span class="delimiter">(</span><a href="#85235" title="com.sleepycat.je.Transaction">txn</a><span class="delimiter">)</span><span class="delimiter">)</span>
                
	        <span class="comment">/* Open a DB for access control info */</span>
	        <span class="comment">//val acDb = makeDatabase(namespace+&quot;_ac&quot;, keySchemaFor(namespace), Some(txn))</span>
                
                <span class="comment">/* Log to partition DB for recreation */</span>
                <a href="#65177" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#85235" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#85172" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#85165" title="edu.berkeley.cs.scads.storage.CreatePartitionRequest">createRequest</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
                
                <span class="comment">/* for now, let errors propogate up to the exception handler */</span>
                <a href="#85235" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                
                <span class="comment">/* Make partition handler from request */</span>
                <a href="#65191" title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeBdbPartitionHandler</a><span class="delimiter">(</span><a href="#85236" title="com.sleepycat.je.Database">newDb</a>, <a href="#85166" title="String">namespace</a>, <a href="#85171" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#85168" title="Option[Array[Byte]]">startKey</a>, <a href="#85169" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
	        <span class="comment">//val handler = makePartitionHandlerWithAC(newDb, acDb, namespace, partitionIdLock, startKey, endKey)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid partition type specified in create partition request: &quot;)" class="string">&quot;Invalid partition type specified in create partition request: &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="#85167" title="String">partitionType</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="comment">/* Add to our list of open partitions */</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="85222">test</a> = <a href="#65169" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: String, x$2: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">put</span><span class="delimiter">(</span><a href="#85172" title="String">partitionId</a>, <a href="#85221" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#85222" title="edu.berkeley.cs.scads.storage.PartitionHandler">test</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition ID was not unique: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#85172" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          
          <span class="comment">/* On success, add this partitionId to the ctx set */</span>
          <span class="keyword">val</span> <a title="Boolean" id="85223">succ</a> = <a href="#85173" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))Boolean">add</span><span class="delimiter">(</span><span title="(_1: String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#85172" title="String">partitionId</a>, <a href="#85221" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#85223" title="Boolean">succ</a>, <span title="java.lang.String(&quot;Handler not successfully added to partitions&quot;)" class="string">&quot;Handler not successfully added to partitions&quot;</span><span class="delimiter">)</span>
          
          <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;[%s] %d active partitions after insertion on this StorageHandler&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#10097" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#85173" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

          <a href="#85221" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>
        <span class="delimiter">}</span>

        <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s in namespace %s created&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#85172" title="String">partitionId</a>, <a href="#85166" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#24627" title="(partitionActor: edu.berkeley.cs.scads.storage.PartitionService)edu.berkeley.cs.scads.storage.CreatePartitionResponse">CreatePartitionResponse</a><span class="delimiter">(</span><a href="../Messages.scala.html#21934" title="(s: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage], partitionId: String, storageService: edu.berkeley.cs.scads.storage.StorageService)edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a><span class="delimiter">(</span><a href="#85174" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</span>, <a href="#85172" title="String">partitionId</a>, <a href="../Messages.scala.html#10800" title="(s: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])edu.berkeley.cs.scads.storage.StorageService">StorageService</a><span class="delimiter">(</span><a href="#10097" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">DeletePartitionRequest</span><span class="delimiter">(</span><a title="String" id="85298">partitionId</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Deleting partition &quot;)" class="string">&quot;Deleting partition &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#85298" title="String">partitionId</a><span class="delimiter">)</span>

        <span class="comment">/* Get the handler and shut it down */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="85299">handler</a> = <span title="(x: edu.berkeley.cs.scads.storage.PartitionHandler)Option[edu.berkeley.cs.scads.storage.PartitionHandler]">Option</span><span class="delimiter">(</span><a href="#65169" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.storage.PartitionHandler">remove</span><span class="delimiter">(</span><a href="#85298" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(default: =&gt; edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">getOrElse</span> <span class="delimiter">{</span><a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#22485" title="(partitionId: String)edu.berkeley.cs.scads.storage.InvalidPartition">InvalidPartition</a><span class="delimiter">(</span><a href="#85298" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span><span class="delimiter">}</span>
        <a href="#85299" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stopListening</span>

        <a href="#85299" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<a href="PartitionHandler.scala.html#80258" title="=&gt; edu.berkeley.cs.scads.storage.StorageManager">manager</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="85313">bdbManager</a>:<a href="BdbParitionHandler.scala.html#10007" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="java.lang.String" id="85314">dbName</a> = <a href="#85313" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#68536" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()java.lang.String">getDatabaseName</span> <span class="comment">/* dbName is namespace */</span>
            <span class="keyword">val</span> <a title="com.sleepycat.je.Environment" id="85315">dbEnv</a>  = <a href="#85313" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#68536" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>

            <span class="comment">//logger.info(&quot;Unregistering handler from MessageHandler for partition %s in namespace %s&quot;.format(partitionId, dbName))</span>

            <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Deleting partition [%s, %s) for namespace %s&quot;)" class="string">&quot;[%s] Deleting partition [%s, %s) for namespace %s&quot;</span>, <a href="#10097" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#85313" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#68540" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#85313" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#68542" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <a href="#85314" title="java.lang.String">dbName</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="85316">ctx</a> = <a href="#65196" title="(namespace: String)Option[StorageHandler.this.NamespaceContext]">getContextForNamespace</a><span class="delimiter">(</span><a href="#85314" title="java.lang.String">dbName</a><span class="delimiter">)</span> <span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <span class="delimiter">{</span>
              <span class="comment">/**
               * Race condition - a request to delete a namespace is going on
               * right now- this error can actually be safely ignored since this
               * partition will be deleted (in response to the namespace deletion
               * request)
               */</span>
              <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#22417" title="(reason: String, req: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.storage.RequestRejected">RequestRejected</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Partition will be removed by a delete namespace request currently in progress&quot;)" class="string">&quot;Partition will be removed by a delete namespace request currently in progress&quot;</span>, <a href="#85151" title="edu.berkeley.cs.scads.storage.StorageMessage">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>

            <a href="#85316" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="Boolean" id="85352">succ</a> = <a href="#85316" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))Boolean">remove</span><span class="delimiter">(</span><span title="(_1: String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#85298" title="String">partitionId</a>, <a href="#85299" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#85352" title="Boolean">succ</a>, <span title="java.lang.String(&quot;Handler not successfully removed from partitions&quot;)" class="string">&quot;Handler not successfully removed from partitions&quot;</span><span class="delimiter">)</span>

              <span class="comment">/* Delete from partitionDB, and (possibly) delete the database in a
               * single transaction */</span>
              <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="85353">txn</a> = <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

              <span class="comment">/* Remove from bdb map */</span>
              <a href="#65177" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#85353" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#85298" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#85316" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">/* Remove database from environment- this removes all the data
                 * associated with the database */</span>
                <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;[%s] Deleting database %s for namespace %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#10097" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#85314" title="java.lang.String">dbName</a>, <a href="#85314" title="java.lang.String">dbName</a><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#85313" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#68536" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">/* Close underlying DB */</span>
                <a href="#85315" title="com.sleepycat.je.Environment">dbEnv</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String)Unit">removeDatabase</span><span class="delimiter">(</span><a href="#85353" title="com.sleepycat.je.Transaction">txn</a>, <a href="#85314" title="java.lang.String">dbName</a><span class="delimiter">)</span>
              <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Garbage collecting inaccessible keys, since %d partitions in namespace %s remain&quot;)" class="string">&quot;[%s] Garbage collecting inaccessible keys, since %d partitions in namespace %s remain&quot;</span>, <a href="#10097" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#85316" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Int">size</span>, <a href="#85314" title="java.lang.String">dbName</a><span class="delimiter">)</span>

                <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" id="85382">orderedByteArrayView</a><span class="delimiter">(</span><a title="Array[Byte]" id="85389">thiz</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#85390" title="java.lang.Object with Ordered[Array[Byte]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with Ordered[Array[Byte]]" id="85390">Ordered</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
                  <span class="keyword">def</span> <a title="(that: Array[Byte])Int" id="85392">compare</a><span class="delimiter">(</span><a title="Array[Byte]" id="85393">that</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#85316" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83521" title="=&gt; edu.berkeley.cs.scads.storage.AvroComparator">comparator</a>.<a href="server/KeyComparison.scala.html#71592" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#85389" title="Array[Byte]">thiz</a>, <a href="#85393" title="Array[Byte]">that</a><span class="delimiter">)</span> 
                <span class="delimiter">}</span>

                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.BdbStorageManager" id="85383">thisPartition</a> = <a href="#85313" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>
                <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]" id="85384">thisSlice</a> = <a href="util/Slices.scala.html#89855" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])(implicit evidence$1: Array[Byte] =&gt; Ordered[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">Slice</a><a href="#85382" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" class="delimiter">(</a><a href="#85383" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thisPartition</a>.<a href="BdbParitionHandler.scala.html#68540" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#85383" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thisPartition</a>.<a href="BdbParitionHandler.scala.html#68542" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
                <a href="#85316" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)" id="85464">t</a> =&gt;
                  <a href="#85464" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">t</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<a href="PartitionHandler.scala.html#80258" title="=&gt; edu.berkeley.cs.scads.storage.StorageManager">manager</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
                    <span class="keyword">case</span> <a title="Unit" id="85465">thatPartition</a>:<a href="BdbParitionHandler.scala.html#10007" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a> =&gt; <span class="delimiter">{</span>                   
                      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]" id="85466">thatSlice</a> = <a href="util/Slices.scala.html#89855" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])(implicit evidence$1: Array[Byte] =&gt; Ordered[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">Slice</a><a href="#85382" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" class="delimiter">(</a><a href="#85465" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thatPartition</a>.<a href="BdbParitionHandler.scala.html#68540" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#85465" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thatPartition</a>.<a href="BdbParitionHandler.scala.html#68542" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
                      <a href="#85384" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a> = <a href="#85384" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a>.<a href="util/Slices.scala.html#89865" title="(slice: edu.berkeley.cs.scads.storage.Slice[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">remove</a><span class="delimiter">(</span><a href="#85466" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thatSlice</a><span class="delimiter">)</span> <span class="comment">/* Remove (from deletion) slice which cannot be deleted */</span>
                    <span class="delimiter">}</span>
                    <span class="keyword">case</span> <span title="Unit">_</span> =&gt;
                      <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Can\'t properly garbage collect when namespace mixes Bdb and other partitions: &quot;)" class="string">&quot;Can't properly garbage collect when namespace mixes Bdb and other partitions: &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="#85464" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">t</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span><span class="delimiter">)</span>
                  <span class="delimiter">}</span>
                <span class="delimiter">}</span>
                <a href="#85384" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a>.<a href="util/Slices.scala.html#89866" title="(f: (Option[Array[Byte]], Option[Array[Byte]]) =&gt; Unit)Unit">foreach</a><span class="delimiter">(</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="85487">startKey</a>, <a title="Option[Array[Byte]]" id="85488">endKey</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
                  <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;++ [%s] Deleting range: [%s, %s)&quot;)" class="string">&quot;++ [%s] Deleting range: [%s, %s)&quot;</span>, <a href="#10097" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#85487" title="Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#85488" title="Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>
                  <a href="#85313" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#68595" title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit">deleteRange</a><span class="delimiter">(</span><a href="#85487" title="Option[Array[Byte]]">startKey</a>, <a href="#85488" title="Option[Array[Byte]]">endKey</a>, <a href="#65166" title="(a: com.sleepycat.je.Transaction)Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>
                <span class="delimiter">}</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <a href="#85353" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span class="delimiter">{</span>
            <a href="#85299" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span>
            <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#22417" title="(reason: String, req: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.storage.RequestRejected">RequestRejected</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown StorageManager type.  Cannot delete partition&quot;)" class="string">&quot;Unknown StorageManager type.  Cannot delete partition&quot;</span>, <a href="#85151" title="edu.berkeley.cs.scads.storage.StorageMessage">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">return</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <a href="#85299" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span>

        <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#24721" title="()edu.berkeley.cs.scads.storage.DeletePartitionResponse">DeletePartitionResponse</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">GetPartitionsRequest</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#24777" title="(partitions: List[edu.berkeley.cs.scads.storage.PartitionService])edu.berkeley.cs.scads.storage.GetPartitionsResponse">GetPartitionsResponse</a><span class="delimiter">(</span><a href="#65169" title="(m: java.util.concurrent.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler])scala.collection.mutable.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="=&gt; List[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">toList</span>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; edu.berkeley.cs.scads.storage.PartitionService)(implicit bf: scala.collection.generic.CanBuildFrom[List[(String, edu.berkeley.cs.scads.storage.PartitionHandler)],edu.berkeley.cs.scads.storage.PartitionService,List[edu.berkeley.cs.scads.storage.PartitionService]])List[edu.berkeley.cs.scads.storage.PartitionService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.storage.PartitionService,List[edu.berkeley.cs.scads.storage.PartitionService]]" class="delimiter">(</span> <a title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)" id="85753">a</a> =&gt; <a href="../Messages.scala.html#21934" title="(s: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage], partitionId: String, storageService: edu.berkeley.cs.scads.storage.StorageService)edu.berkeley.cs.scads.storage.PartitionService">PartitionService</a><span class="delimiter">(</span><a href="#85753" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">a</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</span>,<a href="#85753" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">a</a>.<span title="=&gt; String">_1</span>, <a href="../Messages.scala.html#10800" title="(s: edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage])edu.berkeley.cs.scads.storage.StorageService">StorageService</a><span class="delimiter">(</span><a href="#10097" title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[edu.berkeley.cs.scads.storage.StorageMessage]">remoteHandle</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">DeleteNamespaceRequest</span><span class="delimiter">(</span><a title="String" id="85793">namespace</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>

        <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="85794">ctx</a> = <a href="#65197" title="(namespace: String)Option[StorageHandler.this.NamespaceContext]">removeNamespaceContext</a><span class="delimiter">(</span><a href="#85793" title="String">namespace</a><span class="delimiter">)</span>.<span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <span class="delimiter">{</span> <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#22539" title="(namespace: String)edu.berkeley.cs.scads.storage.InvalidNamespace">InvalidNamespace</a><span class="delimiter">(</span><a href="#85793" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span> <span class="delimiter">}</span>

        <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;WARNING: About to delete namespace %s! All information and metadata will be lost!&quot;)" class="string">&quot;WARNING: About to delete namespace %s! All information and metadata will be lost!&quot;</span>, <a href="#85793" title="String">namespace</a><span class="delimiter">)</span>

        <a href="#85794" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="85805">txn</a> = <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <a href="#85794" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#83522" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; com.sleepycat.je.OperationStatus)Unit">foreach</span> <a href="#85822" title="com.sleepycat.je.OperationStatus" class="delimiter">{</a> <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><a title="String" id="85825">partitionId</a>, <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="85826">handler</a><span class="delimiter">)</span> =&gt; 
            <a href="#65169" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.storage.PartitionHandler">remove</span><span class="delimiter">(</span><a href="#85825" title="String">partitionId</a><span class="delimiter">)</span> <span class="comment">/* remove from map */</span>
            <a href="#85826" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span> <span class="comment">/* Closes DB handle */</span>
            <a href="#65164" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Deleting metadata for partition %s&quot;)" class="string">&quot;Deleting metadata for partition %s&quot;</span>, <a href="#85825" title="String">partitionId</a><span class="delimiter">)</span>
            <a href="#65177" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#85805" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#85825" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span> 
          <span class="delimiter">}</span>
          <a href="#66248" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String)Unit">removeDatabase</span><span class="delimiter">(</span><a href="#85805" title="com.sleepycat.je.Transaction">txn</a>, <a href="#85793" title="String">namespace</a><span class="delimiter">)</span>
          <a href="#85805" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#25064" title="()edu.berkeley.cs.scads.storage.DeleteNamespaceResponse">DeleteNamespaceResponse</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">ShutdownStorageHandler</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <span title="object java.lang.System">System</span>.<span title="(x$1: Int)Unit">exit</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#85155" title="(msg: edu.berkeley.cs.scads.storage.StorageMessage)Unit">reply</a><span class="delimiter">(</span><a href="../Messages.scala.html#22417" title="(reason: String, req: edu.berkeley.cs.scads.storage.StorageMessage)edu.berkeley.cs.scads.storage.RequestRejected">RequestRejected</a><span class="delimiter">(</span><span title="java.lang.String(&quot;StorageHandler can\'t process this message type&quot;)" class="string">&quot;StorageHandler can't process this message type&quot;</span>, <a href="#85151" title="edu.berkeley.cs.scads.storage.StorageMessage">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>