<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>server/StorageHandler.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> com.sleepycat.je.<span class="delimiter">{</span>Cursor,Database, DatabaseConfig, DatabaseException, DatabaseEntry, Environment, LockMode, OperationStatus, Durability, Transaction<span class="delimiter">}</span>

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> edu.berkeley.cs.avro.runtime._

<span class="keyword">import</span> org.apache.zookeeper.CreateMode

<span class="keyword">import</span> java.util.Comparator
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong
<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.mutable.<span class="delimiter">{</span> Set =&gt; MSet, HashSet <span class="delimiter">}</span>

<span class="keyword">import</span> org.apache.zookeeper.<span title="object org.apache.zookeeper.KeeperException">KeeperException</span>.NodeExistsException

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.StorageHandler" id="9855">StorageHandler</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicLong" id="62489">idGen</a> = <span title="()java.util.concurrent.atomic.AtomicLong" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicLong">AtomicLong</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Basic implementation of a storage handler using BDB as a backend.
 */</span>
<span class="keyword">class</span> <a title="class StorageHandler extends java.lang.Object with edu.berkeley.cs.scads.comm.ServiceHandler[edu.berkeley.cs.scads.comm.StorageServiceOperation] with ScalaObject" id="9857">StorageHandler</a><a href="#9857" title="ScalaObject" class="delimiter">(</a><a title="com.sleepycat.je.Environment" id="63525">env</a>: <span title="com.sleepycat.je.Environment">Environment</span>, <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="63526">root</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, <span class="keyword">val</span> <a title="=&gt; Option[String]" id="63527">name</a>:<span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <span title="edu.berkeley.cs.scads.comm.ServiceHandler[edu.berkeley.cs.scads.comm.StorageServiceOperation]">ServiceHandler</span><span class="delimiter">[</span>StorageServiceOperation<span class="delimiter">]</span> <span class="delimiter">{</span>

  @volatile <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="62442">serverNode</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> = _

  <span class="keyword">val</span> <a title="Long" id="62444">counterId</a> = <a href="#9855" title="object edu.berkeley.cs.scads.storage.StorageHandler">StorageHandler</a>.<a href="#62489" title="=&gt; java.util.concurrent.atomic.AtomicLong">idGen</a>.<span title="()Long">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="62446">toString</a> = 
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&lt;CounterID: %d, EnvDir: %s, Handle: %s&gt;&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62444" title="=&gt; Long">counterId</a>, <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="()java.io.File">getHome</span>.<span title="()java.lang.String">getCanonicalPath</span>, <a href="#9857" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a><span class="delimiter">)</span>

  <span class="comment">/** Logger must be lazy so we can reference in startup() */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="62448">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="62449">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="62451">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="80922">a</a>: <a href="#62451" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#80922" title="A">a</a><span class="delimiter">)</span>

  <span class="comment">/** Hashmap of currently open partition handler, indexed by partitionId.
   * Must also be lazy so we can reference in startup() */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]" id="62453">partitions</a> = <span title="()java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">ConcurrentHashMap</span><span class="delimiter">[</span>String, PartitionHandler<span class="delimiter">]</span>

  <span class="comment">/**
   * Factory for NamespaceContext
   */</span>
  <span class="keyword">object</span> <a title="object StorageHandler.this.NamespaceContext" id="62454">NamespaceContext</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(schema: org.apache.avro.Schema)StorageHandler.this.NamespaceContext" id="81252">apply</a><span class="delimiter">(</span><a title="org.apache.avro.Schema" id="81381">schema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span>: <a href="#81689" title="StorageHandler.this.NamespaceContext">NamespaceContext</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="comparator extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator" id="81383">comparator</a> = <a href="#81384" title="java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator{}" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator" id="81384">AvroComparator</a> <span class="delimiter">{</span> <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="81386">keySchema</a> = <a href="#81381" title="org.apache.avro.Schema">schema</a> <span class="delimiter">}</span>
      <a href="#81689" title="(comparator: edu.berkeley.cs.scads.storage.AvroComparator, partitions: scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)])StorageHandler.this.NamespaceContext">NamespaceContext</a><span class="delimiter">(</span><a href="#81383" title="comparator extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator">comparator</a>, <span title="()scala.collection.mutable.HashSet[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">HashSet</span><span class="delimiter">[</span><span class="delimiter">(</span>String, PartitionHandler<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Contains metadata for namespace
   */</span>
  case <span class="keyword">class</span> <a title="(x$0: StorageHandler.this.NamespaceContext)Option[(edu.berkeley.cs.scads.storage.AvroComparator, scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)])]" id="81689">NamespaceContext</a><a href="#81689" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.storage.AvroComparator" id="81661">comparator</a>: <a href="KeyComparison.scala.html#9803" title="edu.berkeley.cs.scads.storage.AvroComparator">AvroComparator</a>, <a title="scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]" id="81662">partitions</a>: <span title="scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">MSet</span><span class="delimiter">[</span><span class="delimiter">(</span>String, PartitionHandler<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>

  <span class="comment">/** 
   * Map of namespaces to currently open partitions for that namespace.
   * The values of this map (mutable sets) must be synchronized on before reading/writing 
   */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]" id="62458">namespaces</a> = <span title="()java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">ConcurrentHashMap</span><span class="delimiter">[</span>String, NamespaceContext<span class="delimiter">]</span>

  <span class="comment">/* Register a shutdown hook for proper cleanup */</span>
  <span class="keyword">class</span> <a title="class SDRunner extends java.lang.Thread with ScalaObject" id="62459">SDRunner</a><a href="#62459" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.ServiceHandler[_]" id="81700">sh</a>: <span title="edu.berkeley.cs.scads.comm.ServiceHandler[_]">ServiceHandler</span><span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Thread">Thread</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="81694">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#81700" title="edu.berkeley.cs.scads.comm.ServiceHandler[_]">sh</a>.<span title="=&gt; Unit">stop</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  java.lang.<span title="object java.lang.Runtime">Runtime</span>.<span title="()java.lang.Runtime">getRuntime</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.Thread)Unit">addShutdownHook</span><span class="delimiter">(</span><span title="StorageHandler.this.SDRunner" class="keyword">new</span> <a href="#62459" title="StorageHandler.this.SDRunner">SDRunner</a><span class="delimiter">(</span><a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/** Points to the DB that can recreate partitions on restart.
   * Must also be lazy so we can reference in startup() */</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="62461">partitionDb</a> =
    <a href="#62471" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><span title="java.lang.String(&quot;partitiondb&quot;)" class="string">&quot;partitiondb&quot;</span>, <span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span>

    <span class="comment">/**
     * Workload statistics thread periodically clears the stats from all partitions
     */</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="62462">period</a> = <span title="Int(20)" class="int">20</span> <span class="comment">// seconds</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="62464">intervalsToSave</a> = <span title="Int(3)" class="int">3</span>
    <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.lang.Thread" id="62467">statsThread</a> = <span title="(x$1: java.lang.Runnable, x$2: java.lang.String)java.lang.Thread" class="keyword">new</span> <span title="java.lang.Thread">Thread</span><span class="delimiter">(</span><span title="StorageHandler.this.StatsManager" class="keyword">new</span> <a href="#62468" title="StorageHandler.this.StatsManager">StatsManager</a><span class="delimiter">(</span><a href="#62462" title="=&gt; Int">period</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;workload statistic clearing thread&quot;)" class="string">&quot;workload statistic clearing thread&quot;</span><span class="delimiter">)</span>
    <a href="#62466" title="=&gt; java.lang.Thread">statsThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>
    
    <span class="keyword">class</span> <a title="class StatsManager extends java.lang.Object with java.lang.Runnable with ScalaObject" id="62468">StatsManager</a><a href="#62468" title="ScalaObject" class="delimiter">(</a><a title="Int" id="81362">periodInSeconds</a>:<span title="Int">Int</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Runnable">Runnable</span> <span class="delimiter">{</span>
      @volatile <span class="keyword">var</span> <a title="Boolean" id="81358">running</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span class="keyword">def</span> <a title="()Unit" id="81360">run</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> =
	<span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#81358" title="=&gt; Boolean">running</a><span class="delimiter">)</span> <a href="#81769" title="()Unit" class="delimiter">{</a>
	  <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#81362" title="Int">periodInSeconds</a><span title="=&gt; Long">*</span><span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>
	  <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;starting stats clearing&quot;)" class="string">&quot;starting stats clearing&quot;</span><span class="delimiter">)</span>
	  <a href="#62452" title="(m: java.util.concurrent.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler])scala.collection.mutable.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; edu.berkeley.cs.scads.storage.PartitionWorkloadStats)Unit">foreach</span><span class="delimiter">(</span><a href="#82264" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<a href="PartitionHandler.scala.html#78265" title="()edu.berkeley.cs.scads.storage.PartitionWorkloadStats">resetWorkloadStats</a><span class="delimiter">)</span>
	  <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;finished stats clearing&quot;)" class="string">&quot;finished stats clearing&quot;</span><span class="delimiter">)</span>
	<span class="delimiter">}</span>
      <span class="keyword">def</span> <a title="()Unit" id="81361">stop</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#81358" title="(x$1: Boolean)Unit">running</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="62469">makeDatabase</a><span class="delimiter">(</span><a title="String" id="81341">databaseName</a>: <span title="String">String</span>, <a title="org.apache.avro.Schema" id="81342">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="Option[com.sleepycat.je.Transaction]" id="81343">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> =
    <a href="#62471" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#81341" title="String">databaseName</a>, <span title="(x: edu.berkeley.cs.scads.storage.AvroBdbComparator)Some[edu.berkeley.cs.scads.storage.AvroBdbComparator]">Some</span><span class="delimiter">(</span><a href="KeyComparison.scala.html#78118" title="(schema: org.apache.avro.Schema)edu.berkeley.cs.scads.storage.AvroBdbComparator" class="keyword">new</a> <a href="KeyComparison.scala.html#9804" title="edu.berkeley.cs.scads.storage.AvroBdbComparator">AvroBdbComparator</a><span class="delimiter">(</span><a href="#81342" title="org.apache.avro.Schema">keySchema</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#81343" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, keySchema: String, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="62470">makeDatabase</a><span class="delimiter">(</span><a title="String" id="81337">databaseName</a>: <span title="String">String</span>, <a title="String" id="81338">keySchema</a>: <span title="String">String</span>, <a title="Option[com.sleepycat.je.Transaction]" id="81339">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> =
    <a href="#62471" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#81337" title="String">databaseName</a>, <span title="(x: edu.berkeley.cs.scads.storage.AvroBdbComparator)Some[edu.berkeley.cs.scads.storage.AvroBdbComparator]">Some</span><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.AvroBdbComparator" class="keyword">new</span> <a href="KeyComparison.scala.html#9804" title="edu.berkeley.cs.scads.storage.AvroBdbComparator">AvroBdbComparator</a><span class="delimiter">(</span><a href="#81338" title="String">keySchema</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#81339" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="62471">makeDatabase</a><span class="delimiter">(</span><a title="String" id="81333">databaseName</a>: <span title="String">String</span>, <a title="Option[java.util.Comparator[Array[Byte]]]" id="81334">comparator</a>: <span title="Option[java.util.Comparator[Array[Byte]]]">Option</span><span class="delimiter">[</span>Comparator<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[com.sleepycat.je.Transaction]" id="81335">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseConfig" id="82296">dbConfig</a> = <span title="com.sleepycat.je.DatabaseConfig" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseConfig">DatabaseConfig</span>
    <a href="#82296" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setAllowCreate</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#81334" title="Option[java.util.Comparator[Array[Byte]]]">comparator</a>.<span title="(f: java.util.Comparator[Array[Byte]] =&gt; com.sleepycat.je.DatabaseConfig)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Comparator[Array[Byte]]" id="82391">comp</a> =&gt; <a href="#82296" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: java.util.Comparator[Array[Byte]])com.sleepycat.je.DatabaseConfig">setBtreeComparator</span><span class="delimiter">(</span><a href="#82391" title="java.util.Comparator[Array[Byte]]">comp</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#82296" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setTransactional</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String, x$3: com.sleepycat.je.DatabaseConfig)com.sleepycat.je.Database">openDatabase</span><span class="delimiter">(</span><a href="#81335" title="Option[com.sleepycat.je.Transaction]">txn</a>.<span title="(implicit ev: &lt;:&lt;[Null,com.sleepycat.je.Transaction])com.sleepycat.je.Transaction">orNull</span>, <a href="#81333" title="String">databaseName</a>, <a href="#82296" title="com.sleepycat.je.DatabaseConfig">dbConfig</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)org.apache.avro.Schema" id="62472">keySchemaFor</a><span class="delimiter">(</span><a title="String" id="82406">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82409">nsRoot</a> = <a href="#62482" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82406" title="String">namespace</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82410">keySchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82409" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;keySchema&quot;)" class="string">&quot;keySchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#82410" title="java.lang.String">keySchema</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="62473">schemasAndValueClassFor</a><span class="delimiter">(</span><a title="String" id="82428">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82431">nsRoot</a> = <a href="#62482" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82428" title="String">namespace</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82432">keySchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82431" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;keySchema&quot;)" class="string">&quot;keySchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82433">valueSchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82431" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;valueSchema&quot;)" class="string">&quot;valueSchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82434">valueClass</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82431" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;valueClass&quot;)" class="string">&quot;valueClass&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span title="(_1: org.apache.avro.Schema, _2: org.apache.avro.Schema, _3: java.lang.String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" class="delimiter">(</span><span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#82432" title="java.lang.String">keySchema</a><span class="delimiter">)</span>,<span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#82433" title="java.lang.String">valueSchema</a><span class="delimiter">)</span>,<a href="#82434" title="java.lang.String">valueClass</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** 
   * Preconditions:
   *   (1) namespace is a valid namespace in zookeeper
   *   (2) keySchema is already set in the namespace/keySchema file
   *       in ZooKeeper
   *   (3) valueSchema is already set in the namespace/valueSchema file
   *       in ZooKeeper
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler" id="62474">makeBdbPartitionHandler</a><span class="delimiter">(</span>
      <a title="com.sleepycat.je.Database" id="82467">database</a>: <span title="com.sleepycat.je.Database">Database</span>, <a title="String" id="82468">namespace</a>: <span title="String">String</span>, <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82469">partitionIdLock</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
      <a title="Option[Array[Byte]]" id="82470">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="82471">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="82474">schemasvc</a> = <a href="#62473" title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasAndValueClassFor</a><span class="delimiter">(</span><a href="#82468" title="String">namespace</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">new</span> <a href="PartitionHandler.scala.html#9819" title="edu.berkeley.cs.scads.storage.PartitionHandler">PartitionHandler</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.BdbStorageManager" class="keyword">new</span> <a href="BdbParitionHandler.scala.html#9756" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a><span class="delimiter">(</span><a href="#82467" title="com.sleepycat.je.Database">database</a>, <a href="#82469" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#82470" title="Option[Array[Byte]]">startKey</a>, <a href="#82471" title="Option[Array[Byte]]">endKey</a>, <a href="#62482" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82468" title="String">namespace</a><span class="delimiter">)</span>, <a href="#82474" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_1</span>, <a href="#82474" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler" id="62475">makeInMemPartitionHandler</a>
    <span class="delimiter">(</span><a title="String" id="82479">namespace</a>:<span title="String">String</span>,<a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82480">partitionIdLock</a>:ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
     <a title="Option[Array[Byte]]" id="82481">startKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="82482">endKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="82485">schemasvc</a> = <a href="#62473" title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasAndValueClassFor</a><span class="delimiter">(</span><a href="#82479" title="String">namespace</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">new</span> <a href="PartitionHandler.scala.html#9819" title="edu.berkeley.cs.scads.storage.PartitionHandler">PartitionHandler</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.InMemStorageManager" class="keyword">new</span> <a href="InMemStorageManager.scala.html#9776" title="edu.berkeley.cs.scads.storage.InMemStorageManager">InMemStorageManager</a><span class="delimiter">(</span><a href="#82480" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#82481" title="Option[Array[Byte]]">startKey</a>, <a href="#82482" title="Option[Array[Byte]]">endKey</a>, <a href="#62482" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82479" title="String">namespace</a><span class="delimiter">)</span>,<a href="#82485" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_1</span>, <a href="#82485" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_2</span>, <a href="#82485" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; java.lang.String">_3</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
                                        

  <span class="comment">/** Iterator scans the entire cursor and does not close it */</span>
  <span class="keyword">private</span> <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.storage.StorageHandler.cursorToIterator : (cursor: com.sleepycat.je.Cursor)Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="62476">cursorToIterator</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="80928">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span><span class="delimiter">)</span>: <span title="Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">Iterator</span><span class="delimiter">[</span><span class="delimiter">(</span>DatabaseEntry, DatabaseEntry<span class="delimiter">)</span><span class="delimiter">]</span>
    = <a href="#82490" title="java.lang.Object with Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]{}" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="82490">Iterator</a><span class="delimiter">[</span><span class="delimiter">(</span>DatabaseEntry, DatabaseEntry<span class="delimiter">)</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="82662">cur</a> = <a href="#82664" title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="82664">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="82672">tuple</a> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
        <span title="Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" class="keyword">if</span> <span class="delimiter">(</span><a href="#80928" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#82672" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a>.<span title="=&gt; com.sleepycat.je.DatabaseEntry">_1</span>, <a href="#82672" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a>.<span title="=&gt; com.sleepycat.je.DatabaseEntry">_2</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
          <span title="(x: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry))Some[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">Some</span><span class="delimiter">(</span><a href="#82672" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a><span class="delimiter">)</span>
        <span class="keyword">else</span>
          <span title="object None">None</span>
      <span class="delimiter">}</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="82665">hasNext</a> = <a href="#82662" title="=&gt; Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cur</a>.<span title="=&gt; Boolean">isDefined</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="82666">next</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#82662" title="=&gt; Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cur</a> <span title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">Some</span><span class="delimiter">(</span><a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="82705">tup</a><span class="delimiter">)</span> =&gt;
          <a href="#82662" title="(x$1: Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)])Unit">cur</a> = <a href="#82664" title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#82705" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tup</a>
        <span class="keyword">case</span> <span title="Nothing">None</span> =&gt;
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No more elements&quot;)" class="string">&quot;No more elements&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="comment">/**
   * Performs the following startup tasks:
   * * Register with zookeeper as an available server
   * * Reopen any partitions.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="62477">startup</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">/* Register with the zookeper as an available server */</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82723">availServs</a> = <a href="#63526" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>.<span title="(rpath: java.lang.String, tries: Int)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrCreate</span><span class="delimiter">(</span><span title="java.lang.String(&quot;availableServers&quot;)" class="string">&quot;availableServers&quot;</span><span class="delimiter">)</span>
    <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Created StorageHandler&quot;)" class="string">&quot;Created StorageHandler&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#63527" title="=&gt; Option[String]">name</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><a href="#9857" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="()String">toString</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#62442" title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)Unit">serverNode</a> = <a href="#82723" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">availServs</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#63527" title="=&gt; Option[String]">name</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><a href="#9857" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="()String">toString</span><span class="delimiter">)</span>, <a href="#9857" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="=&gt; Array[Byte]">toBytes</span>, <span title="org.apache.zookeeper.CreateMode" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#63527" title="=&gt; Option[String]">name</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> CreateMode.<span title="org.apache.zookeeper.CreateMode(value EPHEMERAL)">EPHEMERAL</span> <span class="keyword">else</span> CreateMode.<span title="org.apache.zookeeper.CreateMode(value EPHEMERAL_SEQUENTIAL)">EPHEMERAL_SEQUENTIAL</span><span class="delimiter">)</span>

    <span class="comment">/* Reopen partitions */</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="82724">cursor</a> = <a href="#62460" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#62476" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.cursorToIterator : (cursor: com.sleepycat.je.Cursor)Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cursor</a>.<span title="(f: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry) =&gt; (java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest))Iterator[(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)]">map</span> <a href="#82836" title="(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)" class="delimiter">{</a> <span class="keyword">case</span> <span title="(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)" class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="82839">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="82840">value</a><span class="delimiter">)</span> =&gt;
      <span title="(_1: java.lang.String, _2: edu.berkeley.cs.scads.comm.CreatePartitionRequest)(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)" class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82839" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span>, <span class="delimiter">(</span><span title="()edu.berkeley.cs.scads.comm.CreatePartitionRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">CreatePartitionRequest</span><span class="delimiter">)</span>.<span title="(data: Array[Byte])edu.berkeley.cs.scads.comm.CreatePartitionRequest">parse</span><span class="delimiter">(</span><a href="#82840" title="com.sleepycat.je.DatabaseEntry">value</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span title="(f: (java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest) =&gt; scala.collection.mutable.Set[(java.lang.String, edu.berkeley.cs.scads.storage.PartitionHandler)])Unit">foreach</span> <a href="#82872" title="ctx.partitions.type" class="delimiter">{</a> <span class="keyword">case</span> <span title="ctx.partitions.type" class="delimiter">(</span><a title="java.lang.String" id="82875">partitionId</a>, <a title="edu.berkeley.cs.scads.comm.CreatePartitionRequest" id="82876">request</a><span class="delimiter">)</span> =&gt;

      <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Recreating partition %s from request %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#82875" title="java.lang.String">partitionId</a>, <a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a><span class="delimiter">)</span><span class="delimiter">)</span>

      <span class="comment">/* Grab partition root from ZooKeeper */</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82877">partitionsDir</a> = <a href="#62482" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span><span class="delimiter">)</span>.<span title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">apply</span><span class="delimiter">(</span><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>

      <span class="comment">/* Create the lock file, assuming that it does not already exist (since
       * the lock files are created ephemerally, so if this node dies, all the
       * lock files should die accordingly) */</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82878">partitionIdLock</a> =
        <span class="keyword">try</span> <span class="delimiter">{</span>
          <a href="#82877" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#82875" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82895">e</a>: <span title="org.apache.zookeeper.KeeperException.NodeExistsException">NodeExistsException</span> =&gt;
            <span class="comment">/* The lock file has not been removed yet. Assume for now that
             * this lock file belonged to this partition to begin with, and we
             * had a race condition where the ephemeral nodes were not removed
             * in time that the node started back up. Therefore, delete the
             * existing lock file and recreate it */</span>
            <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">critical</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Clobbering lock file! Namespace: %s, PartitionID: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span>, <a href="#82875" title="java.lang.String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#82877" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: String)Unit">deleteChild</span><span class="delimiter">(</span><a href="#82875" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
            <a href="#82877" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#82875" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#82878" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#82875" title="java.lang.String">partitionId</a>, <span title="java.lang.String(&quot;Lock file was not created with the same name on restore&quot;)" class="string">&quot;Lock file was not created with the same name on restore&quot;</span><span class="delimiter">)</span>

      <span class="comment">// no need to grab locks below, because startup runs w/o any invocations</span>
      <span class="comment">// to process (so no races can occur)</span>

      <span class="comment">/* Make partition handler */</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="82879">db</a>      = <a href="#62469" title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span>, <a href="#62472" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span><span class="delimiter">)</span>, <span title="object None">None</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="82880">handler</a> = <a href="#62474" title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeBdbPartitionHandler</a><span class="delimiter">(</span><a href="#82879" title="com.sleepycat.je.Database">db</a>, <a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span>, <a href="#82878" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; Option[Array[Byte]]">startKey</span>, <a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; Option[Array[Byte]]">endKey</span><span class="delimiter">)</span>
			<span class="comment">//val handler = makePartitionHandlerWithAC(db, acdb, request.namespace, partitionIdLock, request.startKey, request.endKey)</span>

      <span class="comment">/* Add to our list of open partitions */</span>
      <a href="#62452" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: String, x$2: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">put</span><span class="delimiter">(</span><a href="#82875" title="java.lang.String">partitionId</a>, <a href="#82880" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span>

      <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="82881">ctx</a> = <a href="#62478" title="(namespace: String)StorageHandler.this.NamespaceContext">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a href="#82876" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span><span class="delimiter">)</span> 
      <a href="#82881" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a> <span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))ctx.partitions.type">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(java.lang.String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#82875" title="java.lang.String">partitionId</a>, <a href="#82880" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="delimiter">}</span>
    <a href="#82724" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    
  <span class="delimiter">}</span>

  <span class="comment">/**
   * WARNING: you must synchronize on the context for a namespace before
   * performaning any mutating operations (or to have the correct memory
   * read semantics)
   *
   * TODO: in the current implementation, once a namespace lock is created, it
   * remains for the duration of the JVM process (and is thus not eligible for
   * GC). this makes implementation easier (since we don't have to worry about
   * locks changing over time), but wastes memory
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)StorageHandler.this.NamespaceContext" id="62478">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a title="String" id="82922">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="82925">test</a> = <a href="#62457" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">get</span><span class="delimiter">(</span><a href="#82922" title="String">namespace</a><span class="delimiter">)</span>
    <span title="StorageHandler.this.NamespaceContext" class="keyword">if</span> <span class="delimiter">(</span><a href="#82925" title="StorageHandler.this.NamespaceContext">test</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#82925" title="StorageHandler.this.NamespaceContext">test</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="82926">ctx</a> = <a href="#81252" title="(schema: org.apache.avro.Schema)StorageHandler.this.NamespaceContext">NamespaceContext</a><span class="delimiter">(</span><a href="#62472" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#82922" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#62457" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: String, x$2: StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">putIfAbsent</span><span class="delimiter">(</span><a href="#82922" title="String">namespace</a>, <a href="#82926" title="StorageHandler.this.NamespaceContext">ctx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <a href="#82926" title="StorageHandler.this.NamespaceContext">ctx</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)Option[StorageHandler.this.NamespaceContext]" id="62479">getContextForNamespace</a><span class="delimiter">(</span><a title="String" id="82964">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = 
    <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#62457" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">get</span><span class="delimiter">(</span><a href="#82964" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)Option[StorageHandler.this.NamespaceContext]" id="62480">removeNamespaceContext</a><span class="delimiter">(</span><a title="String" id="82970">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = 
    <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#62457" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">remove</span><span class="delimiter">(</span><a href="#82970" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Performs the following shutdown tasks:
   *   Shutdown all active partitions
   *   Closes the bdb environment
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="62481">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62442" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serverNode</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#62442" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serverNode</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No server node for this storage handler %s&quot;)" class="string">&quot;No server node for this storage handler %s&quot;</span>, <a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a><span class="delimiter">)</span>
    <a href="#62452" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(i: java.util.Collection[edu.berkeley.cs.scads.storage.PartitionHandler])Iterable[edu.berkeley.cs.scads.storage.PartitionHandler]">values</span>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionHandler =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#83260" title="edu.berkeley.cs.scads.storage.PartitionHandler">_</a>.<span title="=&gt; Unit">stop</span><span class="delimiter">)</span>
    <a href="#62452" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#62457" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#62460" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="62482">getNamespaceRoot</a><span class="delimiter">(</span><a title="String" id="82411">namespace</a>: <span title="String">String</span><span class="delimiter">)</span>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> =
    <a href="#63526" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83267" class="delimiter">(</a><span title="java.lang.String(&quot;namespaces&quot;)" class="string">&quot;namespaces&quot;</span><span class="delimiter">)</span>
      .<a href="#83267" title="Int" id="83269">get</a><span class="delimiter">(</span><a href="#82411" title="String" id="83268">namespace</a><span class="delimiter">)</span>
      .<span title="(default: =&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Attempted to open namespace that doesn\'t exist in zookeeper: &quot;)" class="string">&quot;Attempted to open namespace that doesn't exist in zookeeper: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#82411" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.StorageServiceOperation)Unit" id="62483">process</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="83279">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">Option</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.StorageServiceOperation" id="83280">msg</a>: <span title="edu.berkeley.cs.scads.comm.StorageServiceOperation">StorageServiceOperation</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit" id="83284">reply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="83285">msg</a>: <span title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</span><span class="delimiter">)</span> = <a href="#83279" title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">src</a>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#83290" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a> <a href="#9857" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a> <a href="#83285" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a><span class="delimiter">)</span>

    <a href="#83280" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="83292">createRequest</a> @ CreatePartitionRequest<span class="delimiter">(</span><a title="String" id="83294">namespace</a>, <a title="String" id="83295">partitionType</a>, <a title="Option[Array[Byte]]" id="83296">startKey</a>, <a title="Option[Array[Byte]]" id="83297">endKey</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] CreatePartitionRequest for namespace %s, [%s, %s)&quot;)" class="string">&quot;[%s] CreatePartitionRequest for namespace %s, [%s, %s)&quot;</span>, <a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83294" title="String">namespace</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83296" title="Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83297" title="Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="comment">/* Grab root to namespace from ZooKeeper */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83298">nsRoot</a> = <a href="#62482" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#83294" title="String">namespace</a><span class="delimiter">)</span>

        <span class="comment">/* Grab a lock on the partitionId. 
         * TODO: Handle sequence wrap-around */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83299">partitionIdLock</a> = <a href="#83298" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83337" class="delimiter">(</a><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>.<a href="#83337" title="Array[Byte]" id="83340">createChild</a><span class="delimiter">(</span><a href="#83294" title="String" id="83338">namespace</a>, mode = CreateMode.<a title="org.apache.zookeeper.CreateMode(value EPHEMERAL_SEQUENTIAL)" id="83339">EPHEMERAL_SEQUENTIAL</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="String" id="83300">partitionId</a> = <a href="#83299" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span>

        <span class="comment">//logger.info(&quot;Active partitions after insertion in ZooKeeper: %s&quot;.format(nsRoot(&quot;partitions&quot;).children.mkString(&quot;,&quot;)))</span>

        <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%d active partitions after insertion in ZooKeeper&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#83298" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">children</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="83301">ctx</a> = <a href="#62478" title="(namespace: String)StorageHandler.this.NamespaceContext">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a href="#83294" title="String">namespace</a><span class="delimiter">)</span> 

        <span class="comment">/* For now, the creation of DBs under a namespace are executed
         * serially. It is assumed that a single node will not run multiple
         * storage handlers sharing the same namespaces (which allows us to
         * lock the namespace in memory. */</span>
        <span class="comment">// TODO: cleanup if fails</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83302">handler</a> = <a href="#83301" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83349">handler</a> =
            <a href="#83295" title="String">partitionType</a> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="string">&quot;inmemory&quot;</span> =&gt; <span class="delimiter">{</span>
                <span class="comment">/* Start a new transaction to atomically add an entry into the partition DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="83352">txn</a> = <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
                <a href="#62460" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#83352" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83300" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83292" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">createRequest</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#83352" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                <a href="#62475" title="(namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeInMemPartitionHandler</a><span class="delimiter">(</span><a href="#83294" title="String">namespace</a>,<a href="#83299" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#83296" title="Option[Array[Byte]]">startKey</a>, <a href="#83297" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="string">&quot;bdb&quot;</span> =&gt; <span class="delimiter">{</span>
                <span class="comment">/* Start a new transaction to atomically make both the namespace DB,
                 * and add an entry into the partition DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="83363">txn</a> = <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

                <span class="comment">/* Open the namespace DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="83364">newDb</a> = <a href="#62469" title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#83294" title="String">namespace</a>, <a href="#62472" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#83294" title="String">namespace</a><span class="delimiter">)</span>, <span title="(x: com.sleepycat.je.Transaction)Some[com.sleepycat.je.Transaction]">Some</span><span class="delimiter">(</span><a href="#83363" title="com.sleepycat.je.Transaction">txn</a><span class="delimiter">)</span><span class="delimiter">)</span>
                
	        <span class="comment">/* Open a DB for access control info */</span>
	        <span class="comment">//val acDb = makeDatabase(namespace+&quot;_ac&quot;, keySchemaFor(namespace), Some(txn))</span>
                
                <span class="comment">/* Log to partition DB for recreation */</span>
                <a href="#62460" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#83363" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83300" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83292" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">createRequest</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
                
                <span class="comment">/* for now, let errors propogate up to the exception handler */</span>
                <a href="#83363" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                
                <span class="comment">/* Make partition handler from request */</span>
                <a href="#62474" title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeBdbPartitionHandler</a><span class="delimiter">(</span><a href="#83364" title="com.sleepycat.je.Database">newDb</a>, <a href="#83294" title="String">namespace</a>, <a href="#83299" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#83296" title="Option[Array[Byte]]">startKey</a>, <a href="#83297" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
	        <span class="comment">//val handler = makePartitionHandlerWithAC(newDb, acDb, namespace, partitionIdLock, startKey, endKey)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid partition type specified in create partition request: &quot;)" class="string">&quot;Invalid partition type specified in create partition request: &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="#83295" title="String">partitionType</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="comment">/* Add to our list of open partitions */</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83350">test</a> = <a href="#62452" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: String, x$2: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">put</span><span class="delimiter">(</span><a href="#83300" title="String">partitionId</a>, <a href="#83349" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#83350" title="edu.berkeley.cs.scads.storage.PartitionHandler">test</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition ID was not unique: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#83300" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          
          <span class="comment">/* On success, add this partitionId to the ctx set */</span>
          <span class="keyword">val</span> <a title="Boolean" id="83351">succ</a> = <a href="#83301" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))Boolean">add</span><span class="delimiter">(</span><span title="(_1: String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#83300" title="String">partitionId</a>, <a href="#83349" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#83351" title="Boolean">succ</a>, <span title="java.lang.String(&quot;Handler not successfully added to partitions&quot;)" class="string">&quot;Handler not successfully added to partitions&quot;</span><span class="delimiter">)</span>
          
          <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;[%s] %d active partitions after insertion on this StorageHandler&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83301" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

          <a href="#83349" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>
        <span class="delimiter">}</span>

        <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s in namespace %s created&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#83300" title="String">partitionId</a>, <a href="#83294" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(partitionActor: edu.berkeley.cs.scads.comm.PartitionService)edu.berkeley.cs.scads.comm.CreatePartitionResponse">CreatePartitionResponse</span><span class="delimiter">(</span> <a href="#83302" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</span>.<span title="(partitionId: String, storageService: edu.berkeley.cs.scads.comm.StorageService)edu.berkeley.cs.scads.comm.PartitionService">toPartitionService</span><span class="delimiter">(</span><a href="#83300" title="String">partitionId</a>, <a href="#9857" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">toStorageService</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">DeletePartitionRequest</span><span class="delimiter">(</span><a title="String" id="83416">partitionId</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Deleting partition &quot;)" class="string">&quot;Deleting partition &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#83416" title="String">partitionId</a><span class="delimiter">)</span>

        <span class="comment">/* Get the handler and shut it down */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83417">handler</a> = <span title="(x: edu.berkeley.cs.scads.storage.PartitionHandler)Option[edu.berkeley.cs.scads.storage.PartitionHandler]">Option</span><span class="delimiter">(</span><a href="#62452" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.storage.PartitionHandler">remove</span><span class="delimiter">(</span><a href="#83416" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(default: =&gt; edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">getOrElse</span> <span class="delimiter">{</span><a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(partitionId: String)edu.berkeley.cs.scads.comm.InvalidPartition">InvalidPartition</span><span class="delimiter">(</span><a href="#83416" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span><span class="delimiter">}</span>
        <a href="#83417" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stopListening</span>

        <a href="#83417" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<a href="PartitionHandler.scala.html#78235" title="=&gt; edu.berkeley.cs.scads.storage.StorageManager">manager</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="83467">bdbManager</a>:<a href="BdbParitionHandler.scala.html#9756" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="java.lang.String" id="83468">dbName</a> = <a href="#83467" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65775" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()java.lang.String">getDatabaseName</span> <span class="comment">/* dbName is namespace */</span>
            <span class="keyword">val</span> <a title="com.sleepycat.je.Environment" id="83469">dbEnv</a>  = <a href="#83467" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65775" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>

            <span class="comment">//logger.info(&quot;Unregistering handler from MessageHandler for partition %s in namespace %s&quot;.format(partitionId, dbName))</span>

            <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Deleting partition [%s, %s) for namespace %s&quot;)" class="string">&quot;[%s] Deleting partition [%s, %s) for namespace %s&quot;</span>, <a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83467" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65779" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83467" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65781" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <a href="#83468" title="java.lang.String">dbName</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="83470">ctx</a> = <a href="#62479" title="(namespace: String)Option[StorageHandler.this.NamespaceContext]">getContextForNamespace</a><span class="delimiter">(</span><a href="#83468" title="java.lang.String">dbName</a><span class="delimiter">)</span> <span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <span class="delimiter">{</span>
              <span class="comment">/**
               * Race condition - a request to delete a namespace is going on
               * right now- this error can actually be safely ignored since this
               * partition will be deleted (in response to the namespace deletion
               * request)
               */</span>
              <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(reason: String, req: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.RequestRejected">RequestRejected</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Partition will be removed by a delete namespace request currently in progress&quot;)" class="string">&quot;Partition will be removed by a delete namespace request currently in progress&quot;</span>, <a href="#83280" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>

            <a href="#83470" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="Boolean" id="83508">succ</a> = <a href="#83470" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))Boolean">remove</span><span class="delimiter">(</span><span title="(_1: String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#83416" title="String">partitionId</a>, <a href="#83417" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#83508" title="Boolean">succ</a>, <span title="java.lang.String(&quot;Handler not successfully removed from partitions&quot;)" class="string">&quot;Handler not successfully removed from partitions&quot;</span><span class="delimiter">)</span>

              <span class="comment">/* Delete from partitionDB, and (possibly) delete the database in a
               * single transaction */</span>
              <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="83509">txn</a> = <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

              <span class="comment">/* Remove from bdb map */</span>
              <a href="#62460" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#83509" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83416" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#83470" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">/* Remove database from environment- this removes all the data
                 * associated with the database */</span>
                <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;[%s] Deleting database %s for namespace %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83468" title="java.lang.String">dbName</a>, <a href="#83468" title="java.lang.String">dbName</a><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#83467" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65775" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">/* Close underlying DB */</span>
                <a href="#83469" title="com.sleepycat.je.Environment">dbEnv</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String)Unit">removeDatabase</span><span class="delimiter">(</span><a href="#83509" title="com.sleepycat.je.Transaction">txn</a>, <a href="#83468" title="java.lang.String">dbName</a><span class="delimiter">)</span>
              <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Garbage collecting inaccessible keys, since %d partitions in namespace %s remain&quot;)" class="string">&quot;[%s] Garbage collecting inaccessible keys, since %d partitions in namespace %s remain&quot;</span>, <a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83470" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Int">size</span>, <a href="#83468" title="java.lang.String">dbName</a><span class="delimiter">)</span>

                <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" id="83538">orderedByteArrayView</a><span class="delimiter">(</span><a title="Array[Byte]" id="83545">thiz</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#83546" title="java.lang.Object with Ordered[Array[Byte]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with Ordered[Array[Byte]]" id="83546">Ordered</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
                  <span class="keyword">def</span> <a title="(that: Array[Byte])Int" id="83548">compare</a><span class="delimiter">(</span><a title="Array[Byte]" id="83549">that</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#83470" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81661" title="=&gt; edu.berkeley.cs.scads.storage.AvroComparator">comparator</a>.<a href="KeyComparison.scala.html#65848" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#83545" title="Array[Byte]">thiz</a>, <a href="#83549" title="Array[Byte]">that</a><span class="delimiter">)</span> 
                <span class="delimiter">}</span>

                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.BdbStorageManager" id="83539">thisPartition</a> = <a href="#83467" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>
                <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]" id="83540">thisSlice</a> = <a href="../util/Slices.scala.html#83572" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])(implicit evidence$1: Array[Byte] =&gt; Ordered[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">Slice</a><a href="#83538" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" class="delimiter">(</a><a href="#83539" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thisPartition</a>.<a href="BdbParitionHandler.scala.html#65779" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#83539" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thisPartition</a>.<a href="BdbParitionHandler.scala.html#65781" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
                <a href="#83470" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)" id="83619">t</a> =&gt;
                  <a href="#83619" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">t</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<a href="PartitionHandler.scala.html#78235" title="=&gt; edu.berkeley.cs.scads.storage.StorageManager">manager</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
                    <span class="keyword">case</span> <a title="Unit" id="83620">thatPartition</a>:<a href="BdbParitionHandler.scala.html#9756" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a> =&gt; <span class="delimiter">{</span>                   
                      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]" id="83621">thatSlice</a> = <a href="../util/Slices.scala.html#83572" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])(implicit evidence$1: Array[Byte] =&gt; Ordered[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">Slice</a><a href="#83538" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" class="delimiter">(</a><a href="#83620" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thatPartition</a>.<a href="BdbParitionHandler.scala.html#65779" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#83620" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thatPartition</a>.<a href="BdbParitionHandler.scala.html#65781" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
                      <a href="#83540" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a> = <a href="#83540" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a>.<a href="../util/Slices.scala.html#83582" title="(slice: edu.berkeley.cs.scads.storage.Slice[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">remove</a><span class="delimiter">(</span><a href="#83621" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thatSlice</a><span class="delimiter">)</span> <span class="comment">/* Remove (from deletion) slice which cannot be deleted */</span>
                    <span class="delimiter">}</span>
                    <span class="keyword">case</span> <span title="Unit">_</span> =&gt;
                      <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Can\'t properly garbage collect when namespace mixes Bdb and other partitions: &quot;)" class="string">&quot;Can't properly garbage collect when namespace mixes Bdb and other partitions: &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="#83619" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">t</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span><span class="delimiter">)</span>
                  <span class="delimiter">}</span>
                <span class="delimiter">}</span>
                <a href="#83540" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a>.<a href="../util/Slices.scala.html#83583" title="(f: (Option[Array[Byte]], Option[Array[Byte]]) =&gt; Unit)Unit">foreach</a><span class="delimiter">(</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="83647">startKey</a>, <a title="Option[Array[Byte]]" id="83648">endKey</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
                  <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;++ [%s] Deleting range: [%s, %s)&quot;)" class="string">&quot;++ [%s] Deleting range: [%s, %s)&quot;</span>, <a href="#9857" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83647" title="Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83648" title="Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>
                  <a href="#83467" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65834" title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit">deleteRange</a><span class="delimiter">(</span><a href="#83647" title="Option[Array[Byte]]">startKey</a>, <a href="#83648" title="Option[Array[Byte]]">endKey</a>, <a href="#62449" title="(a: com.sleepycat.je.Transaction)Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>
                <span class="delimiter">}</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <a href="#83509" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span class="delimiter">{</span>
            <a href="#83417" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span>
            <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(reason: String, req: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.RequestRejected">RequestRejected</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown StorageManager type.  Cannot delete partition&quot;)" class="string">&quot;Unknown StorageManager type.  Cannot delete partition&quot;</span>, <a href="#83280" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">return</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <a href="#83417" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span>

        <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="()edu.berkeley.cs.scads.comm.DeletePartitionResponse">DeletePartitionResponse</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">GetPartitionsRequest</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(partitions: List[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.comm.GetPartitionsResponse">GetPartitionsResponse</span><span class="delimiter">(</span><a href="#62452" title="(m: java.util.concurrent.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler])scala.collection.mutable.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="=&gt; List[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">toList</span>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; edu.berkeley.cs.scads.comm.PartitionService)(implicit bf: scala.collection.generic.CanBuildFrom[List[(String, edu.berkeley.cs.scads.storage.PartitionHandler)],edu.berkeley.cs.scads.comm.PartitionService,List[edu.berkeley.cs.scads.comm.PartitionService]])List[edu.berkeley.cs.scads.comm.PartitionService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.comm.PartitionService,List[edu.berkeley.cs.scads.comm.PartitionService]]" class="delimiter">(</span> <a title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)" id="83989">a</a> =&gt; <a href="#83989" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">a</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</span>.<span title="(partitionId: String, storageService: edu.berkeley.cs.scads.comm.StorageService)edu.berkeley.cs.scads.comm.PartitionService">toPartitionService</span><span class="delimiter">(</span><a href="#83989" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">a</a>.<span title="=&gt; String">_1</span>, <a href="#9857" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">toStorageService</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">DeleteNamespaceRequest</span><span class="delimiter">(</span><a title="String" id="84018">namespace</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>

        <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="84019">ctx</a> = <a href="#62480" title="(namespace: String)Option[StorageHandler.this.NamespaceContext]">removeNamespaceContext</a><span class="delimiter">(</span><a href="#84018" title="String">namespace</a><span class="delimiter">)</span>.<span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <span class="delimiter">{</span> <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(namespace: String)edu.berkeley.cs.scads.comm.InvalidNamespace">InvalidNamespace</span><span class="delimiter">(</span><a href="#84018" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span> <span class="delimiter">}</span>

        <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;WARNING: About to delete namespace %s! All information and metadata will be lost!&quot;)" class="string">&quot;WARNING: About to delete namespace %s! All information and metadata will be lost!&quot;</span>, <a href="#84018" title="String">namespace</a><span class="delimiter">)</span>

        <a href="#84019" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="84031">txn</a> = <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <a href="#84019" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81662" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; com.sleepycat.je.OperationStatus)Unit">foreach</span> <a href="#84048" title="com.sleepycat.je.OperationStatus" class="delimiter">{</a> <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><a title="String" id="84051">partitionId</a>, <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="84052">handler</a><span class="delimiter">)</span> =&gt; 
            <a href="#62452" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.storage.PartitionHandler">remove</span><span class="delimiter">(</span><a href="#84051" title="String">partitionId</a><span class="delimiter">)</span> <span class="comment">/* remove from map */</span>
            <a href="#84052" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span> <span class="comment">/* Closes DB handle */</span>
            <a href="#62447" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Deleting metadata for partition %s&quot;)" class="string">&quot;Deleting metadata for partition %s&quot;</span>, <a href="#84051" title="String">partitionId</a><span class="delimiter">)</span>
            <a href="#62460" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#84031" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#84051" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span> 
          <span class="delimiter">}</span>
          <a href="#63525" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String)Unit">removeDatabase</span><span class="delimiter">(</span><a href="#84031" title="com.sleepycat.je.Transaction">txn</a>, <a href="#84018" title="String">namespace</a><span class="delimiter">)</span>
          <a href="#84031" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="()edu.berkeley.cs.scads.comm.DeleteNamespaceResponse">DeleteNamespaceResponse</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">ShutdownStorageHandler</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <span title="object java.lang.System">System</span>.<span title="(x$1: Int)Unit">exit</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#83284" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(reason: String, req: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.RequestRejected">RequestRejected</span><span class="delimiter">(</span><span title="java.lang.String(&quot;StorageHandler can\'t process this message type&quot;)" class="string">&quot;StorageHandler can't process this message type&quot;</span>, <a href="#83280" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>