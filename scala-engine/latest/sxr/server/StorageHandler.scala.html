<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>server/StorageHandler.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> edu.berkeley.cs.scads.storage

<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> com.sleepycat.je.<span class="delimiter">{</span>Cursor,Database, DatabaseConfig, DatabaseException, DatabaseEntry, Environment, LockMode, OperationStatus, Durability, Transaction<span class="delimiter">}</span>

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> org.apache.avro.Schema
<span class="keyword">import</span> edu.berkeley.cs.avro.runtime._

<span class="keyword">import</span> org.apache.zookeeper.CreateMode

<span class="keyword">import</span> java.util.Comparator
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong
<span class="keyword">import</span> java.util.<span class="delimiter">{</span> Arrays =&gt; JArrays <span class="delimiter">}</span>

<span class="keyword">import</span> scala.collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> scala.collection.mutable.<span class="delimiter">{</span> Set =&gt; MSet, HashSet <span class="delimiter">}</span>

<span class="keyword">import</span> org.apache.zookeeper.<span title="object org.apache.zookeeper.KeeperException">KeeperException</span>.NodeExistsException

<span class="keyword">object</span> <a title="object edu.berkeley.cs.scads.storage.StorageHandler" id="9851">StorageHandler</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicLong" id="62107">idGen</a> = <span title="()java.util.concurrent.atomic.AtomicLong" class="keyword">new</span> <span title="java.util.concurrent.atomic.AtomicLong">AtomicLong</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Basic implementation of a storage handler using BDB as a backend.
 */</span>
<span class="keyword">class</span> <a title="class StorageHandler extends java.lang.Object with edu.berkeley.cs.scads.comm.ServiceHandler[edu.berkeley.cs.scads.comm.StorageServiceOperation] with ScalaObject" id="9853">StorageHandler</a><a href="#9853" title="ScalaObject" class="delimiter">(</a><a title="com.sleepycat.je.Environment" id="63518">env</a>: <span title="com.sleepycat.je.Environment">Environment</span>, <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="63519">root</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>, <span class="keyword">val</span> <a title="=&gt; Option[String]" id="63520">name</a>:<span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span> 
  <span class="keyword">extends</span> <span title="edu.berkeley.cs.scads.comm.ServiceHandler[edu.berkeley.cs.scads.comm.StorageServiceOperation]">ServiceHandler</span><span class="delimiter">[</span>StorageServiceOperation<span class="delimiter">]</span> <span class="delimiter">{</span>

  @volatile <span class="keyword">private</span> <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="62060">serverNode</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> = _

  <span class="keyword">val</span> <a title="Long" id="62062">counterId</a> = <a href="#9851" title="object edu.berkeley.cs.scads.storage.StorageHandler">StorageHandler</a>.<a href="#62107" title="=&gt; java.util.concurrent.atomic.AtomicLong">idGen</a>.<span title="()Long">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="62064">toString</a> = 
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&lt;CounterID: %d, EnvDir: %s, Handle: %s&gt;&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#62062" title="=&gt; Long">counterId</a>, <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="()java.io.File">getHome</span>.<span title="()java.lang.String">getCanonicalPath</span>, <a href="#9853" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a><span class="delimiter">)</span>

  <span class="comment">/** Logger must be lazy so we can reference in startup() */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="62066">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="[A](a: A)Option[A]" id="62067">toOption</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="62069">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="80875">a</a>: <a href="#62069" title="A">A</a><span class="delimiter">)</span>: <span title="Option[A]">Option</span><span class="delimiter">[</span>A<span class="delimiter">]</span> = <span title="(x: A)Option[A]">Option</span><span class="delimiter">(</span><a href="#80875" title="A">a</a><span class="delimiter">)</span>

  <span class="comment">/** Hashmap of currently open partition handler, indexed by partitionId.
   * Must also be lazy so we can reference in startup() */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]" id="62071">partitions</a> = <span title="()java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">ConcurrentHashMap</span><span class="delimiter">[</span>String, PartitionHandler<span class="delimiter">]</span>

  <span class="comment">/**
   * Factory for NamespaceContext
   */</span>
  <span class="keyword">object</span> <a title="object StorageHandler.this.NamespaceContext" id="62072">NamespaceContext</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(schema: org.apache.avro.Schema)StorageHandler.this.NamespaceContext" id="81205">apply</a><span class="delimiter">(</span><a title="org.apache.avro.Schema" id="81393">schema</a>: <span title="org.apache.avro.Schema">Schema</span><span class="delimiter">)</span>: <a href="#81701" title="StorageHandler.this.NamespaceContext">NamespaceContext</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="comparator extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator" id="81395">comparator</a> = <a href="#81396" title="java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator{}" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator" id="81396">AvroComparator</a> <span class="delimiter">{</span> <span class="keyword">val</span> <a title="org.apache.avro.Schema" id="81398">keySchema</a> = <a href="#81393" title="org.apache.avro.Schema">schema</a> <span class="delimiter">}</span>
      <a href="#81701" title="(comparator: edu.berkeley.cs.scads.storage.AvroComparator, partitions: scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)])StorageHandler.this.NamespaceContext">NamespaceContext</a><span class="delimiter">(</span><a href="#81395" title="comparator extends java.lang.Object with edu.berkeley.cs.scads.storage.AvroComparator">comparator</a>, <span title="()scala.collection.mutable.HashSet[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">HashSet</span><span class="delimiter">[</span><span class="delimiter">(</span>String, PartitionHandler<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Contains metadata for namespace
   */</span>
  case <span class="keyword">class</span> <a title="(x$0: StorageHandler.this.NamespaceContext)Option[(edu.berkeley.cs.scads.storage.AvroComparator, scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)])]" id="81701">NamespaceContext</a><a href="#81701" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.storage.AvroComparator" id="81673">comparator</a>: <a href="KeyComparison.scala.html#9799" title="edu.berkeley.cs.scads.storage.AvroComparator">AvroComparator</a>, <a title="scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]" id="81674">partitions</a>: <span title="scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">MSet</span><span class="delimiter">[</span><span class="delimiter">(</span>String, PartitionHandler<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">)</span>

  <span class="comment">/** 
   * Map of namespaces to currently open partitions for that namespace.
   * The values of this map (mutable sets) must be synchronized on before reading/writing 
   */</span>
  <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]" id="62076">namespaces</a> = <span title="()java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">ConcurrentHashMap</span><span class="delimiter">[</span>String, NamespaceContext<span class="delimiter">]</span>

  <span class="comment">/* Register a shutdown hook for proper cleanup */</span>
  <span class="keyword">class</span> <a title="class SDRunner extends java.lang.Thread with ScalaObject" id="62077">SDRunner</a><a href="#62077" title="ScalaObject" class="delimiter">(</a><a title="edu.berkeley.cs.scads.comm.ServiceHandler[_]" id="81712">sh</a>: <span title="edu.berkeley.cs.scads.comm.ServiceHandler[_]">ServiceHandler</span><span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Thread">Thread</span> <span class="delimiter">{</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="81706">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#81712" title="edu.berkeley.cs.scads.comm.ServiceHandler[_]">sh</a>.<span title="=&gt; Unit">stop</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  java.lang.<span title="object java.lang.Runtime">Runtime</span>.<span title="()java.lang.Runtime">getRuntime</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.Thread)Unit">addShutdownHook</span><span class="delimiter">(</span><span title="StorageHandler.this.SDRunner" class="keyword">new</span> <a href="#62077" title="StorageHandler.this.SDRunner">SDRunner</a><span class="delimiter">(</span><a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/** Points to the DB that can recreate partitions on restart.
   * Must also be lazy so we can reference in startup() */</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="62079">partitionDb</a> =
    <a href="#62089" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><span title="java.lang.String(&quot;partitiondb&quot;)" class="string">&quot;partitiondb&quot;</span>, <span title="object None">None</span>, <span title="object None">None</span><span class="delimiter">)</span>

    <span class="comment">/**
     * Workload statistics thread periodically clears the stats from all partitions
     */</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="62080">period</a> = <span title="Int(20)" class="int">20</span> <span class="comment">// seconds</span>
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="62082">intervalsToSave</a> = <span title="Int(3)" class="int">3</span>
    <span class="keyword">protected</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="java.lang.Thread" id="62085">statsThread</a> = <span title="(x$1: java.lang.Runnable, x$2: java.lang.String)java.lang.Thread" class="keyword">new</span> <span title="java.lang.Thread">Thread</span><span class="delimiter">(</span><span title="StorageHandler.this.StatsManager" class="keyword">new</span> <a href="#62086" title="StorageHandler.this.StatsManager">StatsManager</a><span class="delimiter">(</span><a href="#62080" title="=&gt; Int">period</a><span class="delimiter">)</span>, <span title="java.lang.String(&quot;workload statistic clearing thread&quot;)" class="string">&quot;workload statistic clearing thread&quot;</span><span class="delimiter">)</span>
    <a href="#62084" title="=&gt; java.lang.Thread">statsThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>
    
    <span class="keyword">class</span> <a title="class StatsManager extends java.lang.Object with java.lang.Runnable with ScalaObject" id="62086">StatsManager</a><a href="#62086" title="ScalaObject" class="delimiter">(</a><a title="Int" id="81374">periodInSeconds</a>:<span title="Int">Int</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Runnable">Runnable</span> <span class="delimiter">{</span>
      @volatile <span class="keyword">var</span> <a title="Boolean" id="81370">running</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span class="keyword">def</span> <a title="()Unit" id="81372">run</a><span class="delimiter">(</span><span class="delimiter">)</span>:<span title="Unit">Unit</span> =
	<span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#81370" title="=&gt; Boolean">running</a><span class="delimiter">)</span> <a href="#81781" title="()Unit" class="delimiter">{</a>
	  <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#81374" title="Int">periodInSeconds</a><span title="=&gt; Long">*</span><span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>
	  <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;starting stats clearing&quot;)" class="string">&quot;starting stats clearing&quot;</span><span class="delimiter">)</span>
	  <a href="#62070" title="(m: java.util.concurrent.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler])scala.collection.mutable.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; edu.berkeley.cs.scads.storage.PartitionWorkloadStats)Unit">foreach</span><span class="delimiter">(</span><a href="#82276" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">_</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<a href="PartitionHandler.scala.html#78227" title="()edu.berkeley.cs.scads.storage.PartitionWorkloadStats">resetWorkloadStats</a><span class="delimiter">)</span>
	  <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;finished stats clearing&quot;)" class="string">&quot;finished stats clearing&quot;</span><span class="delimiter">)</span>
	<span class="delimiter">}</span>
      <span class="keyword">def</span> <a title="()Unit" id="81373">stop</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#81370" title="(x$1: Boolean)Unit">running</a> = <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="62087">makeDatabase</a><span class="delimiter">(</span><a title="String" id="81294">databaseName</a>: <span title="String">String</span>, <a title="org.apache.avro.Schema" id="81295">keySchema</a>: <span title="org.apache.avro.Schema">Schema</span>, <a title="Option[com.sleepycat.je.Transaction]" id="81296">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> =
    <a href="#62089" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#81294" title="String">databaseName</a>, <span title="(x: edu.berkeley.cs.scads.storage.AvroBdbComparator)Some[edu.berkeley.cs.scads.storage.AvroBdbComparator]">Some</span><span class="delimiter">(</span><a href="KeyComparison.scala.html#78080" title="(schema: org.apache.avro.Schema)edu.berkeley.cs.scads.storage.AvroBdbComparator" class="keyword">new</a> <a href="KeyComparison.scala.html#9800" title="edu.berkeley.cs.scads.storage.AvroBdbComparator">AvroBdbComparator</a><span class="delimiter">(</span><a href="#81295" title="org.apache.avro.Schema">keySchema</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#81296" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, keySchema: String, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="62088">makeDatabase</a><span class="delimiter">(</span><a title="String" id="81290">databaseName</a>: <span title="String">String</span>, <a title="String" id="81291">keySchema</a>: <span title="String">String</span>, <a title="Option[com.sleepycat.je.Transaction]" id="81292">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> =
    <a href="#62089" title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#81290" title="String">databaseName</a>, <span title="(x: edu.berkeley.cs.scads.storage.AvroBdbComparator)Some[edu.berkeley.cs.scads.storage.AvroBdbComparator]">Some</span><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.AvroBdbComparator" class="keyword">new</span> <a href="KeyComparison.scala.html#9800" title="edu.berkeley.cs.scads.storage.AvroBdbComparator">AvroBdbComparator</a><span class="delimiter">(</span><a href="#81291" title="String">keySchema</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#81292" title="Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(databaseName: String, comparator: Option[java.util.Comparator[Array[Byte]]], txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database" id="62089">makeDatabase</a><span class="delimiter">(</span><a title="String" id="81286">databaseName</a>: <span title="String">String</span>, <a title="Option[java.util.Comparator[Array[Byte]]]" id="81287">comparator</a>: <span title="Option[java.util.Comparator[Array[Byte]]]">Option</span><span class="delimiter">[</span>Comparator<span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[com.sleepycat.je.Transaction]" id="81288">txn</a>: <span title="Option[com.sleepycat.je.Transaction]">Option</span><span class="delimiter">[</span>Transaction<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="com.sleepycat.je.Database">Database</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.DatabaseConfig" id="82308">dbConfig</a> = <span title="com.sleepycat.je.DatabaseConfig" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseConfig">DatabaseConfig</span>
    <a href="#82308" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setAllowCreate</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#81287" title="Option[java.util.Comparator[Array[Byte]]]">comparator</a>.<span title="(f: java.util.Comparator[Array[Byte]] =&gt; com.sleepycat.je.DatabaseConfig)Unit">foreach</span><span class="delimiter">(</span><a title="java.util.Comparator[Array[Byte]]" id="82403">comp</a> =&gt; <a href="#82308" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: java.util.Comparator[Array[Byte]])com.sleepycat.je.DatabaseConfig">setBtreeComparator</span><span class="delimiter">(</span><a href="#82403" title="java.util.Comparator[Array[Byte]]">comp</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#82308" title="com.sleepycat.je.DatabaseConfig">dbConfig</a>.<span title="(x$1: Boolean)com.sleepycat.je.DatabaseConfig">setTransactional</span><span class="delimiter">(</span><span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String, x$3: com.sleepycat.je.DatabaseConfig)com.sleepycat.je.Database">openDatabase</span><span class="delimiter">(</span><a href="#81288" title="Option[com.sleepycat.je.Transaction]">txn</a>.<span title="(implicit ev: &lt;:&lt;[Null,com.sleepycat.je.Transaction])com.sleepycat.je.Transaction">orNull</span>, <a href="#81286" title="String">databaseName</a>, <a href="#82308" title="com.sleepycat.je.DatabaseConfig">dbConfig</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)org.apache.avro.Schema" id="62090">keySchemaFor</a><span class="delimiter">(</span><a title="String" id="82418">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82421">nsRoot</a> = <a href="#62100" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82418" title="String">namespace</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82422">keySchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82421" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;keySchema&quot;)" class="string">&quot;keySchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#82422" title="java.lang.String">keySchema</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="62091">schemasAndValueClassFor</a><span class="delimiter">(</span><a title="String" id="82440">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82443">nsRoot</a> = <a href="#62100" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82440" title="String">namespace</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82444">keySchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82443" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;keySchema&quot;)" class="string">&quot;keySchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82445">valueSchema</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82443" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;valueSchema&quot;)" class="string">&quot;valueSchema&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="82446">valueClass</a> = <span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82443" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;valueClass&quot;)" class="string">&quot;valueClass&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
    <span title="(_1: org.apache.avro.Schema, _2: org.apache.avro.Schema, _3: java.lang.String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" class="delimiter">(</span><span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#82444" title="java.lang.String">keySchema</a><span class="delimiter">)</span>,<span title="org.apache.avro.Schema.Parser" class="keyword">new</span> <span title="object org.apache.avro.Schema">Schema</span>.<span title="org.apache.avro.Schema.Parser">Parser</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)org.apache.avro.Schema">parse</span><span class="delimiter">(</span><a href="#82445" title="java.lang.String">valueSchema</a><span class="delimiter">)</span>,<a href="#82446" title="java.lang.String">valueClass</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** 
   * Preconditions:
   *   (1) namespace is a valid namespace in zookeeper
   *   (2) keySchema is already set in the namespace/keySchema file
   *       in ZooKeeper
   *   (3) valueSchema is already set in the namespace/valueSchema file
   *       in ZooKeeper
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler" id="62092">makeBdbPartitionHandler</a><span class="delimiter">(</span>
      <a title="com.sleepycat.je.Database" id="82479">database</a>: <span title="com.sleepycat.je.Database">Database</span>, <a title="String" id="82480">namespace</a>: <span title="String">String</span>, <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82481">partitionIdLock</a>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
      <a title="Option[Array[Byte]]" id="82482">startKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="82483">endKey</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="82486">schemasvc</a> = <a href="#62091" title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasAndValueClassFor</a><span class="delimiter">(</span><a href="#82480" title="String">namespace</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">new</span> <a href="PartitionHandler.scala.html#9815" title="edu.berkeley.cs.scads.storage.PartitionHandler">PartitionHandler</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.BdbStorageManager" class="keyword">new</span> <a href="BdbParitionHandler.scala.html#9752" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a><span class="delimiter">(</span><a href="#82479" title="com.sleepycat.je.Database">database</a>, <a href="#82481" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#82482" title="Option[Array[Byte]]">startKey</a>, <a href="#82483" title="Option[Array[Byte]]">endKey</a>, <a href="#62100" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82480" title="String">namespace</a><span class="delimiter">)</span>, <a href="#82486" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_1</span>, <a href="#82486" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler" id="62093">makeInMemPartitionHandler</a>
    <span class="delimiter">(</span><a title="String" id="82491">namespace</a>:<span title="String">String</span>,<a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82492">partitionIdLock</a>:ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span>,
     <a title="Option[Array[Byte]]" id="82493">startKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span>, <a title="Option[Array[Byte]]" id="82494">endKey</a>:<span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)" id="82497">schemasvc</a> = <a href="#62091" title="(namespace: String)(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasAndValueClassFor</a><span class="delimiter">(</span><a href="#82491" title="String">namespace</a><span class="delimiter">)</span>
    <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">new</span> <a href="PartitionHandler.scala.html#9815" title="edu.berkeley.cs.scads.storage.PartitionHandler">PartitionHandler</a><span class="delimiter">(</span><span title="edu.berkeley.cs.scads.storage.InMemStorageManager" class="keyword">new</span> <a href="InMemStorageManager.scala.html#9772" title="edu.berkeley.cs.scads.storage.InMemStorageManager">InMemStorageManager</a><span class="delimiter">(</span><a href="#82492" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#82493" title="Option[Array[Byte]]">startKey</a>, <a href="#82494" title="Option[Array[Byte]]">endKey</a>, <a href="#62100" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82491" title="String">namespace</a><span class="delimiter">)</span>,<a href="#82497" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_1</span>, <a href="#82497" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; org.apache.avro.Schema">_2</span>, <a href="#82497" title="(org.apache.avro.Schema, org.apache.avro.Schema, java.lang.String)">schemasvc</a>.<span title="=&gt; java.lang.String">_3</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
                                        

  <span class="comment">/** Iterator scans the entire cursor and does not close it */</span>
  <span class="keyword">private</span> <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.storage.StorageHandler.cursorToIterator : (cursor: com.sleepycat.je.Cursor)Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="62094">cursorToIterator</a><span class="delimiter">(</span><a title="com.sleepycat.je.Cursor" id="80881">cursor</a>: <span title="com.sleepycat.je.Cursor">Cursor</span><span class="delimiter">)</span>: <span title="Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">Iterator</span><span class="delimiter">[</span><span class="delimiter">(</span>DatabaseEntry, DatabaseEntry<span class="delimiter">)</span><span class="delimiter">]</span>
    = <a href="#82502" title="java.lang.Object with Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]{}" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="82502">Iterator</a><span class="delimiter">[</span><span class="delimiter">(</span>DatabaseEntry, DatabaseEntry<span class="delimiter">)</span><span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="82674">cur</a> = <a href="#82676" title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" id="82676">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="82684">tuple</a> = <span title="(_1: com.sleepycat.je.DatabaseEntry, _2: com.sleepycat.je.DatabaseEntry)(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="delimiter">(</span><span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span>, <span title="com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">)</span>
        <span title="Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]" class="keyword">if</span> <span class="delimiter">(</span><a href="#80881" title="com.sleepycat.je.Cursor">cursor</a>.<span title="(x$1: com.sleepycat.je.DatabaseEntry, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.LockMode)com.sleepycat.je.OperationStatus">getNext</span><span class="delimiter">(</span><a href="#82684" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a>.<span title="=&gt; com.sleepycat.je.DatabaseEntry">_1</span>, <a href="#82684" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a>.<span title="=&gt; com.sleepycat.je.DatabaseEntry">_2</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> OperationStatus.<span title="com.sleepycat.je.OperationStatus(value SUCCESS)">SUCCESS</span><span class="delimiter">)</span>
          <span title="(x: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry))Some[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">Some</span><span class="delimiter">(</span><a href="#82684" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tuple</a><span class="delimiter">)</span>
        <span class="keyword">else</span>
          <span title="object None">None</span>
      <span class="delimiter">}</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="82677">hasNext</a> = <a href="#82674" title="=&gt; Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cur</a>.<span title="=&gt; Boolean">isDefined</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="82678">next</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#82674" title="=&gt; Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cur</a> <span title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">Some</span><span class="delimiter">(</span><a title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)" id="82717">tup</a><span class="delimiter">)</span> =&gt;
          <a href="#82674" title="(x$1: Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)])Unit">cur</a> = <a href="#82676" title="()Option[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">getNext</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#82717" title="(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)">tup</a>
        <span class="keyword">case</span> <span title="Nothing">None</span> =&gt;
          <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.IllegalStateException" class="keyword">new</span> <span title="java.lang.IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No more elements&quot;)" class="string">&quot;No more elements&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="comment">/**
   * Performs the following startup tasks:
   * * Register with zookeeper as an available server
   * * Reopen any partitions.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="62095">startup</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">/* Register with the zookeper as an available server */</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82735">availServs</a> = <a href="#63519" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a>.<span title="(rpath: java.lang.String, tries: Int)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrCreate</span><span class="delimiter">(</span><span title="java.lang.String(&quot;availableServers&quot;)" class="string">&quot;availableServers&quot;</span><span class="delimiter">)</span>
    <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Created StorageHandler&quot;)" class="string">&quot;Created StorageHandler&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#63520" title="=&gt; Option[String]">name</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><a href="#9853" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="()String">toString</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#62060" title="(x$1: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)Unit">serverNode</a> = <a href="#82735" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">availServs</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#63520" title="=&gt; Option[String]">name</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><a href="#9853" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="()String">toString</span><span class="delimiter">)</span>, <a href="#9853" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="=&gt; Array[Byte]">toBytes</span>, <span title="org.apache.zookeeper.CreateMode" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#63520" title="=&gt; Option[String]">name</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> CreateMode.<span title="org.apache.zookeeper.CreateMode(value EPHEMERAL)">EPHEMERAL</span> <span class="keyword">else</span> CreateMode.<span title="org.apache.zookeeper.CreateMode(value EPHEMERAL_SEQUENTIAL)">EPHEMERAL_SEQUENTIAL</span><span class="delimiter">)</span>

    <span class="comment">/* Reopen partitions */</span>
    <span class="keyword">val</span> <a title="com.sleepycat.je.Cursor" id="82736">cursor</a> = <a href="#62078" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.CursorConfig)com.sleepycat.je.Cursor">openCursor</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
    <a href="#62094" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.cursorToIterator : (cursor: com.sleepycat.je.Cursor)Iterator[(com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry)]">cursor</a>.<span title="(f: (com.sleepycat.je.DatabaseEntry, com.sleepycat.je.DatabaseEntry) =&gt; (java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest))Iterator[(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)]">map</span> <a href="#82848" title="(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)" class="delimiter">{</a> <span class="keyword">case</span> <span title="(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)" class="delimiter">(</span><a title="com.sleepycat.je.DatabaseEntry" id="82851">key</a>, <a title="com.sleepycat.je.DatabaseEntry" id="82852">value</a><span class="delimiter">)</span> =&gt;
      <span title="(_1: java.lang.String, _2: edu.berkeley.cs.scads.comm.CreatePartitionRequest)(java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest)" class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#82851" title="com.sleepycat.je.DatabaseEntry">key</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span>, <span class="delimiter">(</span><span title="()edu.berkeley.cs.scads.comm.CreatePartitionRequest" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">CreatePartitionRequest</span><span class="delimiter">)</span>.<span title="(data: Array[Byte])edu.berkeley.cs.scads.comm.CreatePartitionRequest">parse</span><span class="delimiter">(</span><a href="#82852" title="com.sleepycat.je.DatabaseEntry">value</a>.<span title="()Array[Byte]">getData</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span title="(f: (java.lang.String, edu.berkeley.cs.scads.comm.CreatePartitionRequest) =&gt; scala.collection.mutable.Set[(java.lang.String, edu.berkeley.cs.scads.storage.PartitionHandler)])Unit">foreach</span> <a href="#82884" title="ctx.partitions.type" class="delimiter">{</a> <span class="keyword">case</span> <span title="ctx.partitions.type" class="delimiter">(</span><a title="java.lang.String" id="82887">partitionId</a>, <a title="edu.berkeley.cs.scads.comm.CreatePartitionRequest" id="82888">request</a><span class="delimiter">)</span> =&gt;

      <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Recreating partition %s from request %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#82887" title="java.lang.String">partitionId</a>, <a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a><span class="delimiter">)</span><span class="delimiter">)</span>

      <span class="comment">/* Grab partition root from ZooKeeper */</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82889">partitionsDir</a> = <a href="#62100" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span><span class="delimiter">)</span>.<span title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">apply</span><span class="delimiter">(</span><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>

      <span class="comment">/* Create the lock file, assuming that it does not already exist (since
       * the lock files are created ephemerally, so if this node dies, all the
       * lock files should die accordingly) */</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82890">partitionIdLock</a> =
        <span class="keyword">try</span> <span class="delimiter">{</span>
          <a href="#82889" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#82887" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="82907">e</a>: <span title="org.apache.zookeeper.KeeperException.NodeExistsException">NodeExistsException</span> =&gt;
            <span class="comment">/* The lock file has not been removed yet. Assume for now that
             * this lock file belonged to this partition to begin with, and we
             * had a race condition where the ephemeral nodes were not removed
             * in time that the node started back up. Therefore, delete the
             * existing lock file and recreate it */</span>
            <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">critical</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Clobbering lock file! Namespace: %s, PartitionID: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span>, <a href="#82887" title="java.lang.String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#82889" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: String)Unit">deleteChild</span><span class="delimiter">(</span><a href="#82887" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
            <a href="#82889" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionsDir</a>.<span title="(name: java.lang.String, data: Array[Byte], mode: org.apache.zookeeper.CreateMode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">createChild</span><span class="delimiter">(</span><a href="#82887" title="java.lang.String">partitionId</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#82890" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#82887" title="java.lang.String">partitionId</a>, <span title="java.lang.String(&quot;Lock file was not created with the same name on restore&quot;)" class="string">&quot;Lock file was not created with the same name on restore&quot;</span><span class="delimiter">)</span>

      <span class="comment">// no need to grab locks below, because startup runs w/o any invocations</span>
      <span class="comment">// to process (so no races can occur)</span>

      <span class="comment">/* Make partition handler */</span>
      <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="82891">db</a>      = <a href="#62087" title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span>, <a href="#62090" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span><span class="delimiter">)</span>, <span title="object None">None</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="82892">handler</a> = <a href="#62092" title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeBdbPartitionHandler</a><span class="delimiter">(</span><a href="#82891" title="com.sleepycat.je.Database">db</a>, <a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span>, <a href="#82890" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; Option[Array[Byte]]">startKey</span>, <a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; Option[Array[Byte]]">endKey</span><span class="delimiter">)</span>
			<span class="comment">//val handler = makePartitionHandlerWithAC(db, acdb, request.namespace, partitionIdLock, request.startKey, request.endKey)</span>

      <span class="comment">/* Add to our list of open partitions */</span>
      <a href="#62070" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: String, x$2: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">put</span><span class="delimiter">(</span><a href="#82887" title="java.lang.String">partitionId</a>, <a href="#82892" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span>

      <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="82893">ctx</a> = <a href="#62096" title="(namespace: String)StorageHandler.this.NamespaceContext">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a href="#82888" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">request</a>.<span title="=&gt; String">namespace</span><span class="delimiter">)</span> 
      <a href="#82893" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a> <span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))ctx.partitions.type">+=</span> <span class="delimiter">(</span><span title="(_1: java.lang.String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(java.lang.String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#82887" title="java.lang.String">partitionId</a>, <a href="#82892" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="delimiter">}</span>
    <a href="#82736" title="com.sleepycat.je.Cursor">cursor</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    
  <span class="delimiter">}</span>

  <span class="comment">/**
   * WARNING: you must synchronize on the context for a namespace before
   * performaning any mutating operations (or to have the correct memory
   * read semantics)
   *
   * TODO: in the current implementation, once a namespace lock is created, it
   * remains for the duration of the JVM process (and is thus not eligible for
   * GC). this makes implementation easier (since we don't have to worry about
   * locks changing over time), but wastes memory
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)StorageHandler.this.NamespaceContext" id="62096">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a title="String" id="82934">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="82937">test</a> = <a href="#62075" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">get</span><span class="delimiter">(</span><a href="#82934" title="String">namespace</a><span class="delimiter">)</span>
    <span title="StorageHandler.this.NamespaceContext" class="keyword">if</span> <span class="delimiter">(</span><a href="#82937" title="StorageHandler.this.NamespaceContext">test</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#82937" title="StorageHandler.this.NamespaceContext">test</a>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="82938">ctx</a> = <a href="#81205" title="(schema: org.apache.avro.Schema)StorageHandler.this.NamespaceContext">NamespaceContext</a><span class="delimiter">(</span><a href="#62090" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#82934" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#62075" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: String, x$2: StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">putIfAbsent</span><span class="delimiter">(</span><a href="#82934" title="String">namespace</a>, <a href="#82938" title="StorageHandler.this.NamespaceContext">ctx</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <a href="#82938" title="StorageHandler.this.NamespaceContext">ctx</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)Option[StorageHandler.this.NamespaceContext]" id="62097">getContextForNamespace</a><span class="delimiter">(</span><a title="String" id="82976">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = 
    <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#62075" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">get</span><span class="delimiter">(</span><a href="#82976" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  @inline <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)Option[StorageHandler.this.NamespaceContext]" id="62098">removeNamespaceContext</a><span class="delimiter">(</span><a title="String" id="82982">namespace</a>: <span title="String">String</span><span class="delimiter">)</span> = 
    <span title="(x: StorageHandler.this.NamespaceContext)Option[StorageHandler.this.NamespaceContext]">Option</span><span class="delimiter">(</span><a href="#62075" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="(x$1: Any)StorageHandler.this.NamespaceContext">remove</span><span class="delimiter">(</span><a href="#82982" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Performs the following shutdown tasks:
   *   Shutdown all active partitions
   *   Closes the bdb environment
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="()Unit" id="62099">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#62060" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serverNode</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#62060" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serverNode</a>.<span title="()Unit">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No server node for this storage handler %s&quot;)" class="string">&quot;No server node for this storage handler %s&quot;</span>, <a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a><span class="delimiter">)</span>
    <a href="#62070" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(i: java.util.Collection[edu.berkeley.cs.scads.storage.PartitionHandler])Iterable[edu.berkeley.cs.scads.storage.PartitionHandler]">values</span>.<span title="(f: edu.berkeley.cs.scads.storage.PartitionHandler =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#83272" title="edu.berkeley.cs.scads.storage.PartitionHandler">_</a>.<span title="=&gt; Unit">stop</span><span class="delimiter">)</span>
    <a href="#62070" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#62075" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,StorageHandler.this.NamespaceContext]">namespaces</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#62078" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="62100">getNamespaceRoot</a><span class="delimiter">(</span><a title="String" id="82423">namespace</a>: <span title="String">String</span><span class="delimiter">)</span>: ZooKeeperProxy#<span title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span> =
    <a href="#63519" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">root</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83279" class="delimiter">(</a><span title="java.lang.String(&quot;namespaces&quot;)" class="string">&quot;namespaces&quot;</span><span class="delimiter">)</span>
      .<a href="#83279" title="Int" id="83281">get</a><span class="delimiter">(</span><a href="#82423" title="String" id="83280">namespace</a><span class="delimiter">)</span>
      .<span title="(default: =&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getOrElse</span><span class="delimiter">(</span><span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Attempted to open namespace that doesn\'t exist in zookeeper: &quot;)" class="string">&quot;Attempted to open namespace that doesn't exist in zookeeper: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#82423" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(src: Option[edu.berkeley.cs.scads.comm.RemoteActorProxy], msg: edu.berkeley.cs.scads.comm.StorageServiceOperation)Unit" id="62101">process</a><span class="delimiter">(</span><a title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]" id="83291">src</a>: <span title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">Option</span><span class="delimiter">[</span>RemoteActorProxy<span class="delimiter">]</span>, <a title="edu.berkeley.cs.scads.comm.StorageServiceOperation" id="83292">msg</a>: <span title="edu.berkeley.cs.scads.comm.StorageServiceOperation">StorageServiceOperation</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit" id="83296">reply</a><span class="delimiter">(</span><a title="edu.berkeley.cs.scads.comm.MessageBody" id="83297">msg</a>: <span title="edu.berkeley.cs.scads.comm.MessageBody">MessageBody</span><span class="delimiter">)</span> = <a href="#83291" title="Option[edu.berkeley.cs.scads.comm.RemoteActorProxy]">src</a>.<span title="(f: edu.berkeley.cs.scads.comm.RemoteActorProxy =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#83302" title="edu.berkeley.cs.scads.comm.RemoteActorProxy">_</a> <a href="#9853" title="(body: edu.berkeley.cs.scads.comm.MessageBody)(implicit sender: edu.berkeley.cs.scads.comm.RemoteActorProxy)Unit">!</a> <a href="#83297" title="edu.berkeley.cs.scads.comm.MessageBody">msg</a><span class="delimiter">)</span>

    <a href="#83292" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="83304">createRequest</a> @ CreatePartitionRequest<span class="delimiter">(</span><a title="String" id="83306">namespace</a>, <a title="String" id="83307">partitionType</a>, <a title="Option[Array[Byte]]" id="83308">startKey</a>, <a title="Option[Array[Byte]]" id="83309">endKey</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] CreatePartitionRequest for namespace %s, [%s, %s)&quot;)" class="string">&quot;[%s] CreatePartitionRequest for namespace %s, [%s, %s)&quot;</span>, <a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83306" title="String">namespace</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83308" title="Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83309" title="Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="comment">/* Grab root to namespace from ZooKeeper */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83310">nsRoot</a> = <a href="#62100" title="(namespace: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">getNamespaceRoot</a><span class="delimiter">(</span><a href="#83306" title="String">namespace</a><span class="delimiter">)</span>

        <span class="comment">/* Grab a lock on the partitionId. 
         * TODO: Handle sequence wrap-around */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83311">partitionIdLock</a> = <a href="#83310" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="83349" class="delimiter">(</a><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>.<a href="#83349" title="Array[Byte]" id="83352">createChild</a><span class="delimiter">(</span><a href="#83306" title="String" id="83350">namespace</a>, mode = CreateMode.<a title="org.apache.zookeeper.CreateMode(value EPHEMERAL_SEQUENTIAL)" id="83351">EPHEMERAL_SEQUENTIAL</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="String" id="83312">partitionId</a> = <a href="#83311" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>.<span title="=&gt; String">name</span>

        <span class="comment">//logger.info(&quot;Active partitions after insertion in ZooKeeper: %s&quot;.format(nsRoot(&quot;partitions&quot;).children.mkString(&quot;,&quot;)))</span>

        <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%d active partitions after insertion in ZooKeeper&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#83310" title="(rpath: java.lang.String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">nsRoot</a><span class="delimiter">(</span><span title="java.lang.String(&quot;partitions&quot;)" class="string">&quot;partitions&quot;</span><span class="delimiter">)</span>.<span title="=&gt; List[edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode]">children</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="83313">ctx</a> = <a href="#62096" title="(namespace: String)StorageHandler.this.NamespaceContext">getOrCreateContextForNamespace</a><span class="delimiter">(</span><a href="#83306" title="String">namespace</a><span class="delimiter">)</span> 

        <span class="comment">/* For now, the creation of DBs under a namespace are executed
         * serially. It is assumed that a single node will not run multiple
         * storage handlers sharing the same namespaces (which allows us to
         * lock the namespace in memory. */</span>
        <span class="comment">// TODO: cleanup if fails</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83314">handler</a> = <a href="#83313" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83361">handler</a> =
            <a href="#83307" title="String">partitionType</a> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="string">&quot;inmemory&quot;</span> =&gt; <span class="delimiter">{</span>
                <span class="comment">/* Start a new transaction to atomically add an entry into the partition DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="83364">txn</a> = <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
                <a href="#62078" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#83364" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83312" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83304" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">createRequest</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#83364" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                <a href="#62093" title="(namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeInMemPartitionHandler</a><span class="delimiter">(</span><a href="#83306" title="String">namespace</a>,<a href="#83311" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#83308" title="Option[Array[Byte]]">startKey</a>, <a href="#83309" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="edu.berkeley.cs.scads.storage.PartitionHandler" class="string">&quot;bdb&quot;</span> =&gt; <span class="delimiter">{</span>
                <span class="comment">/* Start a new transaction to atomically make both the namespace DB,
                 * and add an entry into the partition DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="83375">txn</a> = <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

                <span class="comment">/* Open the namespace DB */</span>
                <span class="keyword">val</span> <a title="com.sleepycat.je.Database" id="83376">newDb</a> = <a href="#62087" title="(databaseName: String, keySchema: org.apache.avro.Schema, txn: Option[com.sleepycat.je.Transaction])com.sleepycat.je.Database">makeDatabase</a><span class="delimiter">(</span><a href="#83306" title="String">namespace</a>, <a href="#62090" title="(namespace: String)org.apache.avro.Schema">keySchemaFor</a><span class="delimiter">(</span><a href="#83306" title="String">namespace</a><span class="delimiter">)</span>, <span title="(x: com.sleepycat.je.Transaction)Some[com.sleepycat.je.Transaction]">Some</span><span class="delimiter">(</span><a href="#83375" title="com.sleepycat.je.Transaction">txn</a><span class="delimiter">)</span><span class="delimiter">)</span>
                
	        <span class="comment">/* Open a DB for access control info */</span>
	        <span class="comment">//val acDb = makeDatabase(namespace+&quot;_ac&quot;, keySchemaFor(namespace), Some(txn))</span>
                
                <span class="comment">/* Log to partition DB for recreation */</span>
                <a href="#62078" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry, x$3: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">put</span><span class="delimiter">(</span><a href="#83375" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83312" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83304" title="edu.berkeley.cs.scads.comm.CreatePartitionRequest">createRequest</a>.<span title="=&gt; Array[Byte]">toBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
                
                <span class="comment">/* for now, let errors propogate up to the exception handler */</span>
                <a href="#83375" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
                
                <span class="comment">/* Make partition handler from request */</span>
                <a href="#62092" title="(database: com.sleepycat.je.Database, namespace: String, partitionIdLock: edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode, startKey: Option[Array[Byte]], endKey: Option[Array[Byte]])edu.berkeley.cs.scads.storage.PartitionHandler">makeBdbPartitionHandler</a><span class="delimiter">(</span><a href="#83376" title="com.sleepycat.je.Database">newDb</a>, <a href="#83306" title="String">namespace</a>, <a href="#83311" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">partitionIdLock</a>, <a href="#83308" title="Option[Array[Byte]]">startKey</a>, <a href="#83309" title="Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
	        <span class="comment">//val handler = makePartitionHandlerWithAC(newDb, acDb, namespace, partitionIdLock, startKey, endKey)</span>
              <span class="delimiter">}</span>
              <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Invalid partition type specified in create partition request: &quot;)" class="string">&quot;Invalid partition type specified in create partition request: &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="#83307" title="String">partitionType</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="comment">/* Add to our list of open partitions */</span>
          <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83362">test</a> = <a href="#62070" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: String, x$2: edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">put</span><span class="delimiter">(</span><a href="#83312" title="String">partitionId</a>, <a href="#83361" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#83362" title="edu.berkeley.cs.scads.storage.PartitionHandler">test</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span>, <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition ID was not unique: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#83312" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          
          <span class="comment">/* On success, add this partitionId to the ctx set */</span>
          <span class="keyword">val</span> <a title="Boolean" id="83363">succ</a> = <a href="#83313" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))Boolean">add</span><span class="delimiter">(</span><span title="(_1: String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#83312" title="String">partitionId</a>, <a href="#83361" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#83363" title="Boolean">succ</a>, <span title="java.lang.String(&quot;Handler not successfully added to partitions&quot;)" class="string">&quot;Handler not successfully added to partitions&quot;</span><span class="delimiter">)</span>
          
          <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;[%s] %d active partitions after insertion on this StorageHandler&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83313" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

          <a href="#83361" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>
        <span class="delimiter">}</span>

        <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s in namespace %s created&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#83312" title="String">partitionId</a>, <a href="#83306" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(partitionActor: edu.berkeley.cs.scads.comm.PartitionService)edu.berkeley.cs.scads.comm.CreatePartitionResponse">CreatePartitionResponse</span><span class="delimiter">(</span> <a href="#83314" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</span>.<span title="(partitionId: String, storageService: edu.berkeley.cs.scads.comm.StorageService)edu.berkeley.cs.scads.comm.PartitionService">toPartitionService</span><span class="delimiter">(</span><a href="#83312" title="String">partitionId</a>, <a href="#9853" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">toStorageService</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">DeletePartitionRequest</span><span class="delimiter">(</span><a title="String" id="83428">partitionId</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Deleting partition &quot;)" class="string">&quot;Deleting partition &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#83428" title="String">partitionId</a><span class="delimiter">)</span>

        <span class="comment">/* Get the handler and shut it down */</span>
        <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="83429">handler</a> = <span title="(x: edu.berkeley.cs.scads.storage.PartitionHandler)Option[edu.berkeley.cs.scads.storage.PartitionHandler]">Option</span><span class="delimiter">(</span><a href="#62070" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.storage.PartitionHandler">remove</span><span class="delimiter">(</span><a href="#83428" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(default: =&gt; edu.berkeley.cs.scads.storage.PartitionHandler)edu.berkeley.cs.scads.storage.PartitionHandler">getOrElse</span> <span class="delimiter">{</span><a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(partitionId: String)edu.berkeley.cs.scads.comm.InvalidPartition">InvalidPartition</span><span class="delimiter">(</span><a href="#83428" title="String">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span><span class="delimiter">}</span>
        <a href="#83429" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stopListening</span>

        <a href="#83429" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<a href="PartitionHandler.scala.html#78197" title="=&gt; edu.berkeley.cs.scads.storage.StorageManager">manager</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="83479">bdbManager</a>:<a href="BdbParitionHandler.scala.html#9752" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a> =&gt; <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="java.lang.String" id="83480">dbName</a> = <a href="#83479" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65768" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()java.lang.String">getDatabaseName</span> <span class="comment">/* dbName is namespace */</span>
            <span class="keyword">val</span> <a title="com.sleepycat.je.Environment" id="83481">dbEnv</a>  = <a href="#83479" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65768" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()com.sleepycat.je.Environment">getEnvironment</span>

            <span class="comment">//logger.info(&quot;Unregistering handler from MessageHandler for partition %s in namespace %s&quot;.format(partitionId, dbName))</span>

            <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Deleting partition [%s, %s) for namespace %s&quot;)" class="string">&quot;[%s] Deleting partition [%s, %s) for namespace %s&quot;</span>, <a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83479" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65772" title="=&gt; Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83479" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65774" title="=&gt; Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <a href="#83480" title="java.lang.String">dbName</a><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="83482">ctx</a> = <a href="#62097" title="(namespace: String)Option[StorageHandler.this.NamespaceContext]">getContextForNamespace</a><span class="delimiter">(</span><a href="#83480" title="java.lang.String">dbName</a><span class="delimiter">)</span> <span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <span class="delimiter">{</span>
              <span class="comment">/**
               * Race condition - a request to delete a namespace is going on
               * right now- this error can actually be safely ignored since this
               * partition will be deleted (in response to the namespace deletion
               * request)
               */</span>
              <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(reason: String, req: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.RequestRejected">RequestRejected</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Partition will be removed by a delete namespace request currently in progress&quot;)" class="string">&quot;Partition will be removed by a delete namespace request currently in progress&quot;</span>, <a href="#83292" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span>
            <span class="delimiter">}</span>

            <a href="#83482" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="Boolean" id="83520">succ</a> = <a href="#83482" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(elem: (String, edu.berkeley.cs.scads.storage.PartitionHandler))Boolean">remove</span><span class="delimiter">(</span><span title="(_1: String, _2: edu.berkeley.cs.scads.storage.PartitionHandler)(String, edu.berkeley.cs.scads.storage.PartitionHandler)" class="delimiter">(</span><a href="#83428" title="String">partitionId</a>, <a href="#83429" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#83520" title="Boolean">succ</a>, <span title="java.lang.String(&quot;Handler not successfully removed from partitions&quot;)" class="string">&quot;Handler not successfully removed from partitions&quot;</span><span class="delimiter">)</span>

              <span class="comment">/* Delete from partitionDB, and (possibly) delete the database in a
               * single transaction */</span>
              <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="83521">txn</a> = <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>

              <span class="comment">/* Remove from bdb map */</span>
              <a href="#62078" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#83521" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#83428" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>

              <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#83482" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">/* Remove database from environment- this removes all the data
                 * associated with the database */</span>
                <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;[%s] Deleting database %s for namespace %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83480" title="java.lang.String">dbName</a>, <a href="#83480" title="java.lang.String">dbName</a><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#83479" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65768" title="=&gt; com.sleepycat.je.Database">db</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">/* Close underlying DB */</span>
                <a href="#83481" title="com.sleepycat.je.Environment">dbEnv</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String)Unit">removeDatabase</span><span class="delimiter">(</span><a href="#83521" title="com.sleepycat.je.Transaction">txn</a>, <a href="#83480" title="java.lang.String">dbName</a><span class="delimiter">)</span>
              <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[%s] Garbage collecting inaccessible keys, since %d partitions in namespace %s remain&quot;)" class="string">&quot;[%s] Garbage collecting inaccessible keys, since %d partitions in namespace %s remain&quot;</span>, <a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <a href="#83482" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="=&gt; Int">size</span>, <a href="#83480" title="java.lang.String">dbName</a><span class="delimiter">)</span>

                <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" id="83550">orderedByteArrayView</a><span class="delimiter">(</span><a title="Array[Byte]" id="83557">thiz</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#83558" title="java.lang.Object with Ordered[Array[Byte]]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with Ordered[Array[Byte]]" id="83558">Ordered</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> <span class="delimiter">{</span>
                  <span class="keyword">def</span> <a title="(that: Array[Byte])Int" id="83560">compare</a><span class="delimiter">(</span><a title="Array[Byte]" id="83561">that</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#83482" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81673" title="=&gt; edu.berkeley.cs.scads.storage.AvroComparator">comparator</a>.<a href="KeyComparison.scala.html#65841" title="(o1: Array[Byte], o2: Array[Byte])Int">compare</a><span class="delimiter">(</span><a href="#83557" title="Array[Byte]">thiz</a>, <a href="#83561" title="Array[Byte]">that</a><span class="delimiter">)</span> 
                <span class="delimiter">}</span>

                <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.BdbStorageManager" id="83551">thisPartition</a> = <a href="#83479" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>
                <span class="keyword">var</span> <a title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]" id="83552">thisSlice</a> = <a href="../util/Slices.scala.html#83584" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])(implicit evidence$1: Array[Byte] =&gt; Ordered[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">Slice</a><a href="#83550" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" class="delimiter">(</a><a href="#83551" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thisPartition</a>.<a href="BdbParitionHandler.scala.html#65772" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#83551" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thisPartition</a>.<a href="BdbParitionHandler.scala.html#65774" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
                <a href="#83482" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)" id="83631">t</a> =&gt;
                  <a href="#83631" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">t</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<a href="PartitionHandler.scala.html#78197" title="=&gt; edu.berkeley.cs.scads.storage.StorageManager">manager</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
                    <span class="keyword">case</span> <a title="Unit" id="83632">thatPartition</a>:<a href="BdbParitionHandler.scala.html#9752" title="edu.berkeley.cs.scads.storage.BdbStorageManager">BdbStorageManager</a> =&gt; <span class="delimiter">{</span>                   
                      <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]" id="83633">thatSlice</a> = <a href="../util/Slices.scala.html#83584" title="(start: Option[Array[Byte]], end: Option[Array[Byte]])(implicit evidence$1: Array[Byte] =&gt; Ordered[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">Slice</a><a href="#83550" title="implicit edu.berkeley.cs.scads.storage.StorageHandler.orderedByteArrayView : (thiz: Array[Byte])java.lang.Object with Ordered[Array[Byte]]" class="delimiter">(</a><a href="#83632" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thatPartition</a>.<a href="BdbParitionHandler.scala.html#65772" title="=&gt; Option[Array[Byte]]">startKey</a>, <a href="#83632" title="edu.berkeley.cs.scads.storage.BdbStorageManager">thatPartition</a>.<a href="BdbParitionHandler.scala.html#65774" title="=&gt; Option[Array[Byte]]">endKey</a><span class="delimiter">)</span>
                      <a href="#83552" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a> = <a href="#83552" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a>.<a href="../util/Slices.scala.html#83594" title="(slice: edu.berkeley.cs.scads.storage.Slice[Array[Byte]])edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">remove</a><span class="delimiter">(</span><a href="#83633" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thatSlice</a><span class="delimiter">)</span> <span class="comment">/* Remove (from deletion) slice which cannot be deleted */</span>
                    <span class="delimiter">}</span>
                    <span class="keyword">case</span> <span title="Unit">_</span> =&gt;
                      <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Can\'t properly garbage collect when namespace mixes Bdb and other partitions: &quot;)" class="string">&quot;Can't properly garbage collect when namespace mixes Bdb and other partitions: &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="#83631" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">t</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span><span class="delimiter">)</span>
                  <span class="delimiter">}</span>
                <span class="delimiter">}</span>
                <a href="#83552" title="edu.berkeley.cs.scads.storage.Slice[Array[Byte]]">thisSlice</a>.<a href="../util/Slices.scala.html#83595" title="(f: (Option[Array[Byte]], Option[Array[Byte]]) =&gt; Unit)Unit">foreach</a><span class="delimiter">(</span><span class="delimiter">(</span><a title="Option[Array[Byte]]" id="83659">startKey</a>, <a title="Option[Array[Byte]]" id="83660">endKey</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
                  <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;++ [%s] Deleting range: [%s, %s)&quot;)" class="string">&quot;++ [%s] Deleting range: [%s, %s)&quot;</span>, <a href="#9853" title="edu.berkeley.cs.scads.storage.StorageHandler" class="keyword">this</a>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83659" title="Option[Array[Byte]]">startKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span>, <span title="object java.util.Arrays">JArrays</span>.<span title="(x$1: Array[Byte])java.lang.String">toString</span><span class="delimiter">(</span><a href="#83660" title="Option[Array[Byte]]">endKey</a>.<span title="(implicit ev: &lt;:&lt;[Null,Array[Byte]])Array[Byte]">orNull</span><span class="delimiter">)</span><span class="delimiter">)</span>
                  <a href="#83479" title="edu.berkeley.cs.scads.storage.BdbStorageManager">bdbManager</a>.<a href="BdbParitionHandler.scala.html#65827" title="(lowerKey: Option[Array[Byte]], upperKey: Option[Array[Byte]], txn: Option[com.sleepycat.je.Transaction])Unit">deleteRange</a><span class="delimiter">(</span><a href="#83659" title="Option[Array[Byte]]">startKey</a>, <a href="#83660" title="Option[Array[Byte]]">endKey</a>, <a href="#62067" title="(a: com.sleepycat.je.Transaction)Option[com.sleepycat.je.Transaction]">txn</a><span class="delimiter">)</span>
                <span class="delimiter">}</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>

              <a href="#83521" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span class="delimiter">{</span>
            <a href="#83429" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span>
            <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(reason: String, req: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.RequestRejected">RequestRejected</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unknown StorageManager type.  Cannot delete partition&quot;)" class="string">&quot;Unknown StorageManager type.  Cannot delete partition&quot;</span>, <a href="#83292" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <span title="Nothing" class="keyword">return</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <a href="#83429" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span>

        <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="()edu.berkeley.cs.scads.comm.DeletePartitionResponse">DeletePartitionResponse</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">GetPartitionsRequest</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(partitions: List[edu.berkeley.cs.scads.comm.PartitionService])edu.berkeley.cs.scads.comm.GetPartitionsResponse">GetPartitionsResponse</span><span class="delimiter">(</span><a href="#62070" title="(m: java.util.concurrent.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler])scala.collection.mutable.ConcurrentMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="=&gt; List[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">toList</span>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; edu.berkeley.cs.scads.comm.PartitionService)(implicit bf: scala.collection.generic.CanBuildFrom[List[(String, edu.berkeley.cs.scads.storage.PartitionHandler)],edu.berkeley.cs.scads.comm.PartitionService,List[edu.berkeley.cs.scads.comm.PartitionService]])List[edu.berkeley.cs.scads.comm.PartitionService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,edu.berkeley.cs.scads.comm.PartitionService,List[edu.berkeley.cs.scads.comm.PartitionService]]" class="delimiter">(</span> <a title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)" id="84001">a</a> =&gt; <a href="#84001" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">a</a>.<span title="=&gt; edu.berkeley.cs.scads.storage.PartitionHandler">_2</span>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</span>.<span title="(partitionId: String, storageService: edu.berkeley.cs.scads.comm.StorageService)edu.berkeley.cs.scads.comm.PartitionService">toPartitionService</span><span class="delimiter">(</span><a href="#84001" title="(String, edu.berkeley.cs.scads.storage.PartitionHandler)">a</a>.<span title="=&gt; String">_1</span>, <a href="#9853" title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.StorageService">toStorageService</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">DeleteNamespaceRequest</span><span class="delimiter">(</span><a title="String" id="84030">namespace</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>

        <span class="keyword">val</span> <a title="StorageHandler.this.NamespaceContext" id="84031">ctx</a> = <a href="#62098" title="(namespace: String)Option[StorageHandler.this.NamespaceContext]">removeNamespaceContext</a><span class="delimiter">(</span><a href="#84030" title="String">namespace</a><span class="delimiter">)</span>.<span title="(default: =&gt; StorageHandler.this.NamespaceContext)StorageHandler.this.NamespaceContext">getOrElse</span> <span class="delimiter">{</span> <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(namespace: String)edu.berkeley.cs.scads.comm.InvalidNamespace">InvalidNamespace</span><span class="delimiter">(</span><a href="#84030" title="String">namespace</a><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="Nothing" class="keyword">return</span> <span class="delimiter">}</span>

        <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;WARNING: About to delete namespace %s! All information and metadata will be lost!&quot;)" class="string">&quot;WARNING: About to delete namespace %s! All information and metadata will be lost!&quot;</span>, <a href="#84030" title="String">namespace</a><span class="delimiter">)</span>

        <a href="#84031" title="StorageHandler.this.NamespaceContext">ctx</a>.<span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="com.sleepycat.je.Transaction" id="84043">txn</a> = <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.TransactionConfig)com.sleepycat.je.Transaction">beginTransaction</span><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <a href="#84031" title="StorageHandler.this.NamespaceContext">ctx</a>.<a href="#81674" title="=&gt; scala.collection.mutable.Set[(String, edu.berkeley.cs.scads.storage.PartitionHandler)]">partitions</a>.<span title="(f: (String, edu.berkeley.cs.scads.storage.PartitionHandler) =&gt; com.sleepycat.je.OperationStatus)Unit">foreach</span> <a href="#84060" title="com.sleepycat.je.OperationStatus" class="delimiter">{</a> <span class="keyword">case</span> <span title="com.sleepycat.je.OperationStatus" class="delimiter">(</span><a title="String" id="84063">partitionId</a>, <a title="edu.berkeley.cs.scads.storage.PartitionHandler" id="84064">handler</a><span class="delimiter">)</span> =&gt; 
            <a href="#62070" title="=&gt; java.util.concurrent.ConcurrentHashMap[String,edu.berkeley.cs.scads.storage.PartitionHandler]">partitions</a>.<span title="(x$1: Any)edu.berkeley.cs.scads.storage.PartitionHandler">remove</span><span class="delimiter">(</span><a href="#84063" title="String">partitionId</a><span class="delimiter">)</span> <span class="comment">/* remove from map */</span>
            <a href="#84064" title="edu.berkeley.cs.scads.storage.PartitionHandler">handler</a>.<span title="=&gt; Unit">stop</span> <span class="comment">/* Closes DB handle */</span>
            <a href="#62065" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Deleting metadata for partition %s&quot;)" class="string">&quot;Deleting metadata for partition %s&quot;</span>, <a href="#84063" title="String">partitionId</a><span class="delimiter">)</span>
            <a href="#62078" title="=&gt; com.sleepycat.je.Database">partitionDb</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: com.sleepycat.je.DatabaseEntry)com.sleepycat.je.OperationStatus">delete</span><span class="delimiter">(</span><a href="#84043" title="com.sleepycat.je.Transaction">txn</a>, <span title="(x$1: Array[Byte])com.sleepycat.je.DatabaseEntry" class="keyword">new</span> <span title="com.sleepycat.je.DatabaseEntry">DatabaseEntry</span><span class="delimiter">(</span><a href="#84063" title="String">partitionId</a>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span> 
          <span class="delimiter">}</span>
          <a href="#63518" title="com.sleepycat.je.Environment">env</a>.<span title="(x$1: com.sleepycat.je.Transaction, x$2: java.lang.String)Unit">removeDatabase</span><span class="delimiter">(</span><a href="#84043" title="com.sleepycat.je.Transaction">txn</a>, <a href="#84030" title="String">namespace</a><span class="delimiter">)</span>
          <a href="#84043" title="com.sleepycat.je.Transaction">txn</a>.<span title="()Unit">commit</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="()edu.berkeley.cs.scads.comm.DeleteNamespaceResponse">DeleteNamespaceResponse</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">ShutdownStorageHandler</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <span title="object java.lang.System">System</span>.<span title="(x$1: Int)Unit">exit</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#83296" title="(msg: edu.berkeley.cs.scads.comm.MessageBody)Unit">reply</a><span class="delimiter">(</span><span title="(reason: String, req: edu.berkeley.cs.scads.comm.MessageBody)edu.berkeley.cs.scads.comm.RequestRejected">RequestRejected</span><span class="delimiter">(</span><span title="java.lang.String(&quot;StorageHandler can\'t process this message type&quot;)" class="string">&quot;StorageHandler can't process this message type&quot;</span>, <a href="#83292" title="edu.berkeley.cs.scads.comm.StorageServiceOperation">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>