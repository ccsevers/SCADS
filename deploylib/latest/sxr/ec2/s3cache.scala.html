<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>ec2/s3cache.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> deploylib.ec2

<span class="keyword">import</span> deploylib._
<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> org.jets3t.service.model.S3Object
<span class="keyword">import</span> org.jets3t.service.impl.rest.httpclient.RestS3Service
<span class="keyword">import</span> org.jets3t.service.security.<span class="delimiter">{</span>AWSCredentials =&gt; S3Credentials<span class="delimiter">}</span>
<span class="keyword">import</span> org.jets3t.service.acl.AccessControlList

<span class="keyword">object</span> <a title="object deploylib.ec2.S3Cache" id="9553">S3Cache</a> <span title="ScalaObject" class="keyword">extends</span> <a href="aws.scala.html#9526" title="deploylib.ec2.AWSConnection">AWSConnection</a> <span class="delimiter">{</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="48471">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="org.jets3t.service.security.AWSCredentials" id="48473">s3Credentials</a> = <span title="org.jets3t.service.security.AWSCredentials" class="keyword">new</span> <span title="org.jets3t.service.security.AWSCredentials">S3Credentials</span><span class="delimiter">(</span><a href="aws.scala.html#39116" title="=&gt; java.lang.String">accessKeyId</a>, <a href="aws.scala.html#39118" title="=&gt; java.lang.String">secretAccessKey</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="org.jets3t.service.impl.rest.httpclient.RestS3Service" id="48475">s3Service</a> = <span title="org.jets3t.service.impl.rest.httpclient.RestS3Service" class="keyword">new</span> <span title="org.jets3t.service.impl.rest.httpclient.RestS3Service">RestS3Service</span><span class="delimiter">(</span><a href="#48473" title="=&gt; org.jets3t.service.security.AWSCredentials">s3Credentials</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="String" id="48477">bucketName</a> =
    <a href="../package.scala.html#9828" title="object deploylib.package.Config">Config</a>.<span title="(key: String, defaultValue: String)String">getString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib.aws.s3_cache_bucket&quot;)" class="string">&quot;deploylib.aws.s3_cache_bucket&quot;</span>, <span title="java.lang.String(&quot;deploylibCache-&quot;)" class="string">&quot;deploylibCache-&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getenv</span><span class="delimiter">(</span><span title="java.lang.String(&quot;USER&quot;)" class="string">&quot;USER&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="org.jets3t.service.model.S3Bucket" id="48479">bucket</a> = <a href="#48475" title="=&gt; org.jets3t.service.impl.rest.httpclient.RestS3Service">s3Service</a>.<span title="(x$1: java.lang.String)org.jets3t.service.model.S3Bucket">createBucket</span><span class="delimiter">(</span><a href="#48477" title="=&gt; String">bucketName</a><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,String]" id="48481">md5Cache</a> = <span title="()scala.collection.mutable.HashMap[String,String]" class="keyword">new</span> scala.collection.mutable.<span title="scala.collection.mutable.HashMap[String,String]">HashMap</span><span class="delimiter">[</span>String, String<span class="delimiter">]</span>

  <span class="keyword">def</span> <a title="(fileMd5: String)String" id="48483">hashToUrl</a><span class="delimiter">(</span><a title="String" id="50899">fileMd5</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span title="java.lang.String(&quot;http://s3.amazonaws.com/&quot;)" class="string">&quot;http://s3.amazonaws.com/&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#48477" title="=&gt; String">bucketName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#50899" title="String">fileMd5</a>

  <span class="keyword">def</span> <a title="(file: java.io.File)String" id="48484">getCacheUrl</a><span class="delimiter">(</span><a title="java.io.File" id="48485">file</a>: <span title="java.io.File">File</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="50901">fileMd5</a> = <a href="../Util.scala.html#9501" title="object deploylib.Util">Util</a>.<a href="../Util.scala.html#30727" title="(file: java.io.File)String">md5</a><span class="delimiter">(</span><a href="#48485" title="java.io.File">file</a><span class="delimiter">)</span>
    <span title="(x$1: String)String">synchronized</span> <span class="delimiter">{</span>
      <a href="#48481" title="=&gt; scala.collection.mutable.HashMap[String,String]">md5Cache</a>.<span title="(key: String)Option[String]">get</span><span class="delimiter">(</span><a href="#50901" title="String">fileMd5</a><span class="delimiter">)</span> <span title="String" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="String">Some</span><span class="delimiter">(</span><a title="String" id="50908">url</a><span class="delimiter">)</span> =&gt; <a href="#50908" title="String">url</a>
        <span class="keyword">case</span> <span title="String">None</span> =&gt; <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Option[org.jets3t.service.model.S3Object]" id="50909">existingObject</a>: <span title="Option[org.jets3t.service.model.S3Object]">Option</span><span class="delimiter">[</span>S3Object<span class="delimiter">]</span> = <span class="keyword">try</span> <span title="(x: org.jets3t.service.model.S3Object)Some[org.jets3t.service.model.S3Object]">Some</span><span class="delimiter">(</span><a href="#48475" title="=&gt; org.jets3t.service.impl.rest.httpclient.RestS3Service">s3Service</a>.<span title="(x$1: org.jets3t.service.model.S3Bucket, x$2: java.lang.String)org.jets3t.service.model.S3Object">getObjectDetails</span><span class="delimiter">(</span><a href="#48479" title="=&gt; org.jets3t.service.model.S3Bucket">bucket</a>, <a href="#50901" title="String">fileMd5</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="None.type">_</span>: org.jets3t.service.<span title="org.jets3t.service.S3ServiceException">S3ServiceException</span> =&gt; <span title="object None">None</span>
          <span class="delimiter">}</span>

          <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#50909" title="Option[org.jets3t.service.model.S3Object]">existingObject</a>.<span title="(f: org.jets3t.service.model.S3Object =&gt; Boolean)Option[Boolean]">map</span><span class="delimiter">(</span><a href="#51263" title="org.jets3t.service.model.S3Object">_</a>.<span title="()java.lang.String">getMd5HashAsHex</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#50901" title="String">fileMd5</a><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#48471" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Uploading &quot;)" class="string">&quot;Uploading &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#48485" title="java.io.File">file</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; to S3&quot;)" class="string">&quot; to S3&quot;</span><span class="delimiter">)</span>
            <span class="keyword">val</span> <a title="org.jets3t.service.model.S3Object" id="51275">obj</a> = <span title="(x$1: java.io.File)org.jets3t.service.model.S3Object" class="keyword">new</span> <span title="org.jets3t.service.model.S3Object">S3Object</span><span class="delimiter">(</span><a href="#48485" title="java.io.File">file</a><span class="delimiter">)</span>
            <a href="#51275" title="org.jets3t.service.model.S3Object">obj</a>.<span title="(x$1: java.lang.String)Unit">setKey</span><span class="delimiter">(</span><a href="#50901" title="String">fileMd5</a><span class="delimiter">)</span>
            <a href="#51275" title="org.jets3t.service.model.S3Object">obj</a>.<span title="(x$1: org.jets3t.service.acl.AccessControlList)Unit">setAcl</span><span class="delimiter">(</span><span title="object org.jets3t.service.acl.AccessControlList">AccessControlList</span>.<span title="org.jets3t.service.acl.AccessControlList">REST_CANNED_PUBLIC_READ</span><span class="delimiter">)</span>

            <a href="#48475" title="=&gt; org.jets3t.service.impl.rest.httpclient.RestS3Service">s3Service</a>.<span title="(x$1: org.jets3t.service.model.S3Bucket, x$2: org.jets3t.service.model.S3Object)org.jets3t.service.model.S3Object">putObject</span><span class="delimiter">(</span><a href="#48479" title="=&gt; org.jets3t.service.model.S3Bucket">bucket</a>, <a href="#51275" title="org.jets3t.service.model.S3Object">obj</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <span class="keyword">val</span> <a title="String" id="50910">url</a> = <a href="#48483" title="(fileMd5: String)String">hashToUrl</a><span class="delimiter">(</span><a href="#50901" title="String">fileMd5</a><span class="delimiter">)</span>
	  <a href="#48481" title="=&gt; scala.collection.mutable.HashMap[String,String]">md5Cache</a>.<span title="(key: String, value: String)Option[String]">put</span><span class="delimiter">(</span><a href="#50901" title="String">fileMd5</a>, <a href="#50910" title="String">url</a><span class="delimiter">)</span>
          <a href="#50910" title="String">url</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>