<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>config/ConfigurationActions.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> deploylib.config

<span class="keyword">import</span> java.io.File

<span class="keyword">import</span> deploylib._
<span class="keyword">import</span> deploylib.runit._

<span class="keyword">import</span> net.lag.logging.Logger

<span class="keyword">trait</span> <a title="trait ConfigurationActions extends java.lang.Object with ScalaObject" id="9522">ConfigurationActions</a> <span title="ScalaObject" class="delimiter">{</span>
	<span class="keyword">val</span> <a title="net.lag.logging.Logger" id="38353">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

	<span class="keyword">def</span> <a title="(target: deploylib.RemoteMachine, directory: java.io.File)java.io.File" id="38355">createDirectory</a><span class="delimiter">(</span><a title="deploylib.RemoteMachine" id="38451">target</a>: <a href="../RemoteMachine.scala.html#9495" title="deploylib.RemoteMachine">RemoteMachine</a>, <a title="java.io.File" id="38452">directory</a>: <span title="java.io.File">File</span><span class="delimiter">)</span>: <span title="java.io.File">File</span> = <span class="delimiter">{</span>
		<a href="#38451" title="deploylib.RemoteMachine">target</a>.<a href="../RemoteMachine.scala.html#25743" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span class="delimiter">(</span><span title="java.lang.String(&quot;mkdir -p &quot;)" class="string">&quot;mkdir -p &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38452" title="java.io.File">directory</a><span class="delimiter">)</span>
		<span title="Nothing" class="keyword">return</span> <a href="#38452" title="java.io.File">directory</a>
	<span class="delimiter">}</span>

	<span class="keyword">def</span> <a title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File" id="38356">createFile</a><span class="delimiter">(</span><a title="deploylib.RemoteMachine" id="38456">target</a>: <a href="../RemoteMachine.scala.html#9495" title="deploylib.RemoteMachine">RemoteMachine</a>, <a title="java.io.File" id="38457">filename</a>: <span title="java.io.File">File</span>, <a title="String" id="38458">contents</a>: <span title="String">String</span>, <a title="String" id="38459">mode</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="java.io.File">File</span> = <span class="delimiter">{</span>
		<a href="#38456" title="deploylib.RemoteMachine">target</a>.<a href="../RemoteMachine.scala.html#25745" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><a href="#38457" title="java.io.File">filename</a>, <a href="#38458" title="String">contents</a><span class="delimiter">)</span>
		<a href="#38456" title="deploylib.RemoteMachine">target</a>.<a href="../RemoteMachine.scala.html#25743" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span class="delimiter">(</span><span title="java.lang.String(&quot;chmod &quot;)" class="string">&quot;chmod &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38459" title="String">mode</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38457" title="java.io.File">filename</a><span class="delimiter">)</span>
		<span title="Nothing" class="keyword">return</span> <a href="#38457" title="java.io.File">filename</a>
	<span class="delimiter">}</span>

	<span class="keyword">def</span> <a title="(target: deploylib.RemoteMachine, localFile: java.io.File, destination: java.io.File)java.io.File" id="38357">uploadFile</a><span class="delimiter">(</span><a title="deploylib.RemoteMachine" id="38463">target</a>: <a href="../RemoteMachine.scala.html#9495" title="deploylib.RemoteMachine">RemoteMachine</a>, <a title="java.io.File" id="38464">localFile</a>: <span title="java.io.File">File</span>, <a title="java.io.File" id="38465">destination</a>: <span title="java.io.File">File</span><span class="delimiter">)</span>: <span title="java.io.File">File</span> = <span class="delimiter">{</span>
		<a href="#38463" title="deploylib.RemoteMachine">target</a>.<a href="../RemoteMachine.scala.html#25747" title="(localFile: java.io.File, remoteDirectory: java.io.File)Unit">upload</a><span class="delimiter">(</span><a href="#38464" title="java.io.File">localFile</a>, <a href="#38465" title="java.io.File">destination</a><span class="delimiter">)</span>
		<span title="Nothing" class="keyword">return</span> <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38465" title="java.io.File">destination</a>, <a href="#38464" title="java.io.File">localFile</a>.<span title="()java.lang.String">getName</span><span class="delimiter">)</span>
	<span class="delimiter">}</span>

	<span class="keyword">def</span> <a title="(target: deploylib.runit.RunitManager, name: String, runCommand: String)deploylib.runit.RunitService" id="38358">createRunitService</a><span class="delimiter">(</span><a title="deploylib.runit.RunitManager" id="38472">target</a>: <a href="../runit/RunitManager.scala.html#9800" title="deploylib.runit.RunitManager">RunitManager</a>, <a title="String" id="38473">name</a>: <span title="String">String</span>, <a title="String" id="38474">runCommand</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="../runit/RunitService.scala.html#9816" title="deploylib.runit.RunitService">RunitService</a> =  <a href="#38359" title="(target: deploylib.runit.RunitManager, name: String, runCommand: String, logCommand: String)deploylib.runit.RunitService">createRunitService</a><span class="delimiter">(</span><a href="#38472" title="deploylib.runit.RunitManager">target</a>, <a href="#38473" title="String">name</a>, <a href="#38474" title="String">runCommand</a>, <span title="java.lang.String(&quot;#!/bin/sh\012exec &quot;)" class="string">&quot;#!/bin/sh\nexec &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38472" title="deploylib.runit.RunitManager">target</a>.<a href="../RemoteMachine.scala.html#25726" title="=&gt; java.io.File">svlogdCmd</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; -tt ./&quot;)" class="string">&quot; -tt ./&quot;</span><span class="delimiter">)</span>
	<span class="keyword">def</span> <a title="(target: deploylib.runit.RunitManager, name: String, runCommand: String, logCommand: String)deploylib.runit.RunitService" id="38359">createRunitService</a><span class="delimiter">(</span><a title="deploylib.runit.RunitManager" id="38524">target</a>: <a href="../runit/RunitManager.scala.html#9800" title="deploylib.runit.RunitManager">RunitManager</a>, <a title="String" id="38525">name</a>: <span title="String">String</span>, <a title="String" id="38526">runCommand</a>: <span title="String">String</span>, <a title="String" id="38527">logCommand</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="../runit/RunitService.scala.html#9816" title="deploylib.runit.RunitService">RunitService</a> = <span class="delimiter">{</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38529">baseDirectory</a> = <a href="#38355" title="(target: deploylib.RemoteMachine, directory: java.io.File)java.io.File">createDirectory</a><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>.<a href="../RemoteMachine.scala.html#25728" title="=&gt; java.io.File">serviceRoot</a>, <a href="#38525" title="String">name</a><span class="delimiter">)</span><span class="delimiter">)</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38530">logDirectory</a> = <a href="#38355" title="(target: deploylib.RemoteMachine, directory: java.io.File)java.io.File">createDirectory</a><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38529" title="java.io.File">baseDirectory</a>, <span title="java.lang.String(&quot;log&quot;)" class="string">&quot;log&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38531">downFile</a> = <a href="#38356" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38529" title="java.io.File">baseDirectory</a>, <span title="java.lang.String(&quot;down&quot;)" class="string">&quot;down&quot;</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span>, <span title="java.lang.String(&quot;644&quot;)" class="string">&quot;644&quot;</span><span class="delimiter">)</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38532">runFile</a> = <a href="#38356" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38529" title="java.io.File">baseDirectory</a>, <span title="java.lang.String(&quot;run&quot;)" class="string">&quot;run&quot;</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;#!/bin/sh\012exec 2&gt;&amp;1\012exec &quot;)" class="string">&quot;#!/bin/sh\nexec 2&gt;&amp;1\nexec &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38526" title="String">runCommand</a>, <span title="java.lang.String(&quot;755&quot;)" class="string">&quot;755&quot;</span><span class="delimiter">)</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38533">logFile</a> = <a href="#38356" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38530" title="java.io.File">logDirectory</a>, <span title="java.lang.String(&quot;run&quot;)" class="string">&quot;run&quot;</span><span class="delimiter">)</span>, <a href="#38527" title="String">logCommand</a>, <span title="java.lang.String(&quot;755&quot;)" class="string">&quot;755&quot;</span><span class="delimiter">)</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38534">finishFile</a> = <a href="#38356" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38529" title="java.io.File">baseDirectory</a>, <span title="java.lang.String(&quot;finish&quot;)" class="string">&quot;finish&quot;</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;#!/bin/sh\012echo FAILURE `/bin/date`: &quot;)" class="string">&quot;#!/bin/sh\necho FAILURE `/bin/date`: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38525" title="String">name</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; $@ &gt;&gt; failures&quot;)" class="string">&quot; $@ &gt;&gt; failures&quot;</span>, <span title="java.lang.String(&quot;755&quot;)" class="string">&quot;755&quot;</span><span class="delimiter">)</span>

		<a href="#38353" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Waiting for runsvdir to notice &quot;)" class="string">&quot;Waiting for runsvdir to notice &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38525" title="String">name</a><span class="delimiter">)</span>
		<a href="#38524" title="deploylib.runit.RunitManager">target</a>.<a href="../RemoteMachine.scala.html#25754" title="(file: java.io.File)Unit">blockTillFileCreated</a><span class="delimiter">(</span><span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38529" title="java.io.File">baseDirectory</a>, <span title="java.lang.String(&quot;supervise/stat&quot;)" class="string">&quot;supervise/stat&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

		<span title="deploylib.runit.RunitService" class="keyword">new</span> <a href="../runit/RunitService.scala.html#9816" title="deploylib.runit.RunitService">RunitService</a><span class="delimiter">(</span><a href="#38524" title="deploylib.runit.RunitManager">target</a>, <a href="#38525" title="String">name</a><span class="delimiter">)</span>
	<span class="delimiter">}</span>

	<span class="keyword">def</span> <a title="(target: deploylib.runit.RunitManager, localJar: java.io.File, className: String, maxHeapMb: Int, args: String)deploylib.runit.RunitService" id="38360">createJavaService</a><span class="delimiter">(</span><a title="deploylib.runit.RunitManager" id="38567">target</a>: <a href="../runit/RunitManager.scala.html#9800" title="deploylib.runit.RunitManager">RunitManager</a>, <a title="java.io.File" id="38568">localJar</a>: <span title="java.io.File">File</span>, <a title="String" id="38569">className</a>: <span title="String">String</span>, <a title="Int" id="38570">maxHeapMb</a>: <span title="Int">Int</span>, <a title="String" id="38571">args</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="../runit/RunitService.scala.html#9816" title="deploylib.runit.RunitService">RunitService</a> = <span class="delimiter">{</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38573">remoteJar</a> = <a href="#38357" title="(target: deploylib.RemoteMachine, localFile: java.io.File, destination: java.io.File)java.io.File">uploadFile</a><span class="delimiter">(</span><a href="#38567" title="deploylib.runit.RunitManager">target</a>, <a href="#38568" title="java.io.File">localJar</a>, <a href="#38567" title="deploylib.runit.RunitManager">target</a>.<a href="../RemoteMachine.scala.html#25715" title="=&gt; java.io.File">rootDirectory</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="38574">jvmArgs</a> = <span title="java.lang.String(&quot;-server -Xmx&quot;)" class="string">&quot;-server -Xmx&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38570" title="Int">maxHeapMb</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;m &quot;)" class="string">&quot;m &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>  <span title="java.lang.String(&quot; -XX:+HeapDumpOnOutOfMemoryError &quot;)" class="string">&quot; -XX:+HeapDumpOnOutOfMemoryError &quot;</span>
		<span class="keyword">val</span> <a title="java.lang.String" id="38575">runCmd</a> = <a href="#38567" title="deploylib.runit.RunitManager">target</a>.<a href="../RemoteMachine.scala.html#25716" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd">javaCmd</a> <span title="(other: String)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
                  <a href="#38574" title="java.lang.String">jvmArgs</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
								 <span title="java.lang.String(&quot;-cp .:&quot;)" class="string">&quot;-cp .:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38573" title="java.io.File">remoteJar</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
								 <a href="#38569" title="String">className</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#38571" title="String">args</a>
		<span class="keyword">val</span> <a title="deploylib.runit.RunitService" id="38576">service</a> = <a href="#38358" title="(target: deploylib.runit.RunitManager, name: String, runCommand: String)deploylib.runit.RunitService">createRunitService</a><span class="delimiter">(</span><a href="#38567" title="deploylib.runit.RunitManager">target</a>, <a href="#38569" title="String">className</a>, <a href="#38575" title="java.lang.String">runCmd</a><span class="delimiter">)</span>
		<span class="keyword">val</span> <a title="java.io.File" id="38577">log4jProperties</a> = <a href="#38356" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span class="delimiter">(</span><a href="#38567" title="deploylib.runit.RunitManager">target</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#38576" title="deploylib.runit.RunitService">service</a>.<a href="../runit/RunitService.scala.html#38488" title="=&gt; java.io.File">serviceDir</a>, <span title="java.lang.String(&quot;log4j.properties&quot;)" class="string">&quot;log4j.properties&quot;</span><span class="delimiter">)</span>,  <span title="(xs: java.lang.String*)(implicit evidence$2: scala.reflect.ClassManifest[java.lang.String])Array[java.lang.String]">Array</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;log4j.rootLogger=INFO, stdout&quot;)" class="string">&quot;log4j.rootLogger=INFO, stdout&quot;</span>,
																						 <span title="java.lang.String(&quot;log4j.appender.stdout=org.apache.log4j.ConsoleAppender&quot;)" class="string">&quot;log4j.appender.stdout=org.apache.log4j.ConsoleAppender&quot;</span>,
																						 <span title="java.lang.String(&quot;log4j.appender.stdout.layout=org.apache.log4j.SimpleLayout&quot;)" class="string">&quot;log4j.appender.stdout.layout=org.apache.log4j.SimpleLayout&quot;</span><span class="delimiter">)</span>.<span title="(start: String, sep: String, end: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span>, <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;644&quot;)" class="string">&quot;644&quot;</span><span class="delimiter">)</span>

    <span title="Nothing" class="keyword">return</span> <a href="#38576" title="deploylib.runit.RunitService">service</a>
	<span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>