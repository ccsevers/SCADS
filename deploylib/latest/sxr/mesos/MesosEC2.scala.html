<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>mesos/MesosEC2.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> deploylib
<span class="keyword">package</span> mesos

<span class="keyword">import</span> ec2._
<span class="keyword">import</span> config._

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> net.lag.logging.Logger
<span class="keyword">import</span> java.lang.RuntimeException

<span class="keyword">object</span> <a title="object deploylib.mesos.ServiceSchedulerDaemon" id="9781">ServiceSchedulerDaemon</a> <span title="ScalaObject" class="keyword">extends</span> optional.<span title="optional.Application">Application</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="53037">javaExecutorPath</a> = <span title="java.lang.String(&quot;/usr/local/mesos/frameworks/deploylib/java_executor&quot;)" class="string">&quot;/usr/local/mesos/frameworks/deploylib/java_executor&quot;</span>

  <span class="keyword">def</span> <a title="(mesosMaster: String, zooKeeperAddress: String)Unit" id="53039">main</a><span class="delimiter">(</span><a title="String" id="53041">mesosMaster</a>: <span title="String">String</span>, <a title="String" id="53042">zooKeeperAddress</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)Unit">loadLibrary</span><span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="deploylib.mesos.ServiceScheduler" id="53044">scheduler</a> = <span title="deploylib.mesos.ServiceScheduler" class="keyword">new</span> <a href="ExperimentDaemon.scala.html#9741" title="deploylib.mesos.ServiceScheduler">ServiceScheduler</a><span class="delimiter">(</span>
      <a href="#53041" title="String">mesosMaster</a>,
      <a href="#53037" title="=&gt; java.lang.String">javaExecutorPath</a>
    <span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="53045">serviceSchedulerNode</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#53042" title="String">zooKeeperAddress</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[deploylib.mesos.Message]" id="53046">remoteService</a> = <a href="#53044" title="deploylib.mesos.ServiceScheduler">scheduler</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteServiceProxy[deploylib.mesos.Message]">remoteHandle</span>
    <a href="#53045" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="(d: Array[Byte])Unit">data</span> = <span title="deploylib.mesos.RemoteServiceScheduler" class="keyword">new</span> <a href="ExperimentDaemon.scala.html#9738" title="deploylib.mesos.RemoteServiceScheduler">RemoteServiceScheduler</a><span class="delimiter">(</span><a href="#53046" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[deploylib.mesos.Message]">remoteService</a>.<span title="=&gt; String">host</span>, <a href="#53046" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[deploylib.mesos.Message]">remoteService</a>.<span title="=&gt; Int">port</span>, <a href="#53046" title="edu.berkeley.cs.scads.comm.RemoteServiceProxy[deploylib.mesos.Message]">remoteService</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ServiceId">id</span><span class="delimiter">)</span>.<span title="=&gt; Array[Byte]">toBytes</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Global state for setting and methods for running mesos on EC2.
 */</span>
<span class="keyword">object</span> <a title="object deploylib.mesos.MesosCluster" id="9783">MesosCluster</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="53413">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">//HACK</span>
  <span class="keyword">var</span> <a title="Seq[java.io.File]" id="53416">jarFiles</a>: <span title="Seq[java.io.File]">Seq</span><span class="delimiter">[</span>java.io.File<span class="delimiter">]</span> = _

  <span class="comment">/**
   * Start a new plain ubuntu ami, install java/mesos on it, bundle it as a new AMI.
   */</span>
  <span class="keyword">def</span> <a title="(region: deploylib.ec2.EC2Region)String" id="53418">buildNewAmi</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Region" id="53511">region</a>: <a href="ec2/ec2.scala.html#9554" title="deploylib.ec2.EC2Region">EC2Region</a><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <a href="#53511" title="deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41032" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.Buffer[region.EC2Instance]" id="53627">oldInst</a> = <a href="#53511" title="deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41013" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#55645" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#55652" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#55659" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;ami&quot;)" class="string">&quot;ami&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; region.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],region.EC2Instance,scala.collection.mutable.Buffer[region.EC2Instance]])scala.collection.mutable.Buffer[region.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,region.EC2Instance,scala.collection.mutable.Buffer[region.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="55680">t</a> =&gt; <a href="#53511" title="deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41033" title="(instanceId: String)region.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#55680" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: region.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[region.EC2Instance]">filter</span><span class="delimiter">(</span><a title="region.EC2Instance" id="56010">i</a> =&gt; <span class="delimiter">(</span><a href="#56010" title="region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#56010" title="region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="region.EC2Instance" id="53628">inst</a> =
      <span title="region.EC2Instance" class="keyword">if</span> <span class="delimiter">(</span><a href="#53627" title="scala.collection.mutable.Buffer[region.EC2Instance]">oldInst</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#53511" title="deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41037" title="(num: Int)Seq[region.EC2Instance]">runInstances</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="=&gt; region.EC2Instance">head</span>
      <span class="keyword">else</span>
        <a href="#53627" title="scala.collection.mutable.Buffer[region.EC2Instance]">oldInst</a>.<span title="=&gt; region.EC2Instance">head</span>

    <a href="#53628" title="region.EC2Instance">inst</a>.<a href="ec2/ec2.scala.html#45085" title="object inst.tags">tags</a> <a href="ec2/ec2.scala.html#47135" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;ami&quot;)" class="string">&quot;ami&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;updating apt...&quot;)" class="string">&quot;updating apt...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;add-apt-repository \&quot;deb http://archive.canonical.com/ubuntu lucid partner\&quot;&quot;)" class="string">&quot;add-apt-repository \&quot;deb http://archive.canonical.com/ubuntu lucid partner\&quot;&quot;</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;echo sun-java6-jdk shared/accepted-sun-dlj-v1-1 select true | /usr/bin/debconf-set-selections&quot;)" class="string">&quot;echo sun-java6-jdk shared/accepted-sun-dlj-v1-1 select true | /usr/bin/debconf-set-selections&quot;</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;apt-get update&quot;)" class="string">&quot;apt-get update&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;installing java...&quot;)" class="string">&quot;installing java...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;yes | apt-get install -y sun-java6-jdk&quot;)" class="string">&quot;yes | apt-get install -y sun-java6-jdk&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;installing build env...&quot;)" class="string">&quot;installing build env...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;apt-get install -y build-essential&quot;)" class="string">&quot;apt-get install -y build-essential&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;installing git...&quot;)" class="string">&quot;installing git...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;apt-get install -y git-core&quot;)" class="string">&quot;apt-get install -y git-core&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;installing python...&quot;)" class="string">&quot;installing python...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;apt-get install -y python2.6-dev&quot;)" class="string">&quot;apt-get install -y python2.6-dev&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;installing swig...&quot;)" class="string">&quot;installing swig...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;apt-get install -y swig&quot;)" class="string">&quot;apt-get install -y swig&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;installing autoconf...&quot;)" class="string">&quot;installing autoconf...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;apt-get install -y autoconf&quot;)" class="string">&quot;apt-get install -y autoconf&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;cloning mesos&quot;)" class="string">&quot;cloning mesos&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;git clone https://github.com/mesos/mesos.git&quot;)" class="string">&quot;git clone https://github.com/mesos/mesos.git&quot;</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;building and installing mesos...&quot;)" class="string">&quot;building and installing mesos...&quot;</span><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;cd mesos; ./configure --with-python-headers=/usr/include/python2.6 --with-java-home=/usr/lib/jvm/java-6-sun --with-webui --with-included-zookeeper; make; make install&quot;)" class="string">&quot;cd mesos; ./configure --with-python-headers=/usr/include/python2.6 --with-java-home=/usr/lib/jvm/java-6-sun --with-webui --with-included-zookeeper; make; make install&quot;</span>

    <span class="keyword">val</span> <a title="java.lang.String" id="53629">bucketName</a> = <span class="delimiter">(</span><a href="#53511" title="deploylib.ec2.EC2Region">region</a>.<span title="()java.lang.Class[_]">getClass</span>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">getName</span>.<span title="(n: Int)String">dropRight</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="object java.lang.System">System</span>.<span title="()Long">currentTimeMillis</span><span class="delimiter">)</span>.<span title="()java.lang.String">toLowerCase</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">replaceAll</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\\.&quot;)" class="string">&quot;\\.&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>
    <a href="#53413" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;bundling ami as %s...&quot;)" class="string">&quot;bundling ami as %s...&quot;</span>, <a href="#53629" title="java.lang.String">bucketName</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="53630">ami</a> = <a href="#53628" title="region.EC2Instance">inst</a>.<a href="ec2/ec2.scala.html#45105" title="(bucketName: String)String">bundleNewAMI</a><span class="delimiter">(</span><a href="#53629" title="java.lang.String">bucketName</a><span class="delimiter">)</span>
    <a href="#53628" title="region.EC2Instance">inst</a>.<a href="ec2/ec2.scala.html#45088" title="=&gt; Unit">halt</a>
    <a href="#53630" title="String">ami</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Functions to help maintain a mesos cluster on EC2.
 */</span>
<span class="keyword">class</span> <a title="class Cluster extends java.lang.Object with ScalaObject" id="9786">Cluster</a><a href="#9786" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="deploylib.ec2.EC2Region" id="56414">region</a>: <a href="ec2/ec2.scala.html#9554" title="deploylib.ec2.EC2Region">EC2Region</a> = <a href="ec2/ec2.scala.html#41081" title="object deploylib.ec2.USEast1">USEast1</a>, <span class="keyword">val</span> <a title="Boolean" id="56415">useFT</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="net.lag.logging.Logger" id="56162">logger</a> = <span title="()net.lag.logging.Logger">Logger</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * The location of mesos on the remote machine
   */</span>
  <span class="keyword">val</span> <a title="java.io.File" id="56164">mesosDir</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/usr/local/mesos&quot;)" class="string">&quot;/usr/local/mesos&quot;</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Location of the deploylib framework on the remote instances
   */</span>
  <span class="keyword">val</span> <a title="java.io.File" id="56166">frameworkDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#56164" title="=&gt; java.io.File">mesosDir</a>, <span title="java.lang.String(&quot;frameworks/deploylib&quot;)" class="string">&quot;frameworks/deploylib&quot;</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="java.io.File" id="56168">binDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#56164" title="=&gt; java.io.File">mesosDir</a>, <span title="java.lang.String(&quot;bin&quot;)" class="string">&quot;bin&quot;</span><span class="delimiter">)</span>

  <span class="comment">/**
   * The ami used when launching new instances
   */</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="56170">mesosAmi</a> = <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a> <span title="java.lang.String" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <a href="ec2/ec2.scala.html#41055" title="java.lang.String(&quot;ami-d373b1ba&quot;)">EC2East</a> =&gt; <span title="java.lang.String(&quot;ami-d373b1ba&quot;)" class="string">&quot;ami-d373b1ba&quot;</span>
    <span class="keyword">case</span> <a href="ec2/ec2.scala.html#41068" title="java.lang.String(&quot;ami-1f08545a&quot;)">EC2West</a> =&gt; <span title="java.lang.String(&quot;ami-1f08545a&quot;)" class="string">&quot;ami-1f08545a&quot;</span>
    <span class="keyword">case</span> <a href="ec2/ec2.scala.html#41081" title="java.lang.String(&quot;ami-d373b1ba&quot;)">USEast1</a> =&gt; <span title="java.lang.String(&quot;ami-d373b1ba&quot;)" class="string">&quot;ami-d373b1ba&quot;</span>
    <span class="keyword">case</span> <a href="ec2/ec2.scala.html#41094" title="java.lang.String(&quot;ami-1f08545a&quot;)">USWest1</a> =&gt; <span title="java.lang.String(&quot;ami-1f08545a&quot;)" class="string">&quot;ami-1f08545a&quot;</span>
    <span class="keyword">case</span> <a href="ec2/ec2.scala.html#41107" title="java.lang.String(&quot;ami-43b38137&quot;)">EUWest1</a> =&gt; <span title="java.lang.String(&quot;ami-43b38137&quot;)" class="string">&quot;ami-43b38137&quot;</span>
    <span class="keyword">case</span> <a href="ec2/ec2.scala.html#41120" title="java.lang.String(&quot;ami-04912505&quot;)">APNortheast1</a> =&gt; <span title="java.lang.String(&quot;ami-04912505&quot;)" class="string">&quot;ami-04912505&quot;</span>
    <span class="keyword">case</span> <a href="ec2/ec2.scala.html#41133" title="java.lang.String(&quot;ami-92057fc0&quot;)">APSoutheast1</a> =&gt; <span title="java.lang.String(&quot;ami-92057fc0&quot;)" class="string">&quot;ami-92057fc0&quot;</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * The default availability zone used when launching new instances.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Option[String]" id="56172">availabilityZone</a>: <span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <a href="#9786" title="(x$1: Option[String])Option[String]">synchronized</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[String]" id="56420">activeZones</a> = <span class="delimiter">(</span><a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a> <span title="(xs: scala.collection.GenTraversableOnce[Cluster.this.region.EC2Instance])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">++</span> <a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a> <span title="(xs: scala.collection.GenTraversableOnce[Cluster.this.region.EC2Instance])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">++</span> <a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a><span class="delimiter">)</span>.<span title="(f: Cluster.this.region.EC2Instance =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance],String,scala.collection.mutable.Buffer[String]])scala.collection.mutable.Buffer[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,String,scala.collection.mutable.Buffer[String]]" class="delimiter">(</span><a href="#57225" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45095" title="=&gt; String">availabilityZone</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[String]">toSet</span>
    <span title="Option[String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#56420" title="scala.collection.immutable.Set[String]">activeZones</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span title="(x: String)Some[String]">Some</span><span class="delimiter">(</span><a href="#56420" title="scala.collection.immutable.Set[String]">activeZones</a>.<span title="=&gt; String">head</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span title="Option[String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#56420" title="scala.collection.immutable.Set[String]">activeZones</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#56162" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">info</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Starting a master to determine a good zone to run in.&quot;)" class="string">&quot;Starting a master to determine a good zone to run in.&quot;</span><span class="delimiter">)</span>
      <a href="#56196" title="(count: Int, zone: Option[String])Seq[deploylib.ec2.package.EC2Instance]">startMasterInstances</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">while</span><span class="delimiter">(</span><a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#57339" title="()Unit" class="delimiter">{</a>
        <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><span title="Long(1000L)" class="int">1000</span><span class="delimiter">)</span>
        <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41029" title="()Unit">forceUpdate</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span title="(x: String)Some[String]">Some</span><span class="delimiter">(</span><a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="=&gt; Cluster.this.region.EC2Instance">head</span>.<a href="ec2/ec2.scala.html#45095" title="=&gt; String">availabilityZone</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span>
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Cluster is split across zones: &quot;)" class="string">&quot;Cluster is split across zones: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56420" title="scala.collection.immutable.Set[String]">activeZones</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * The zookeeper node where the service scheduler registers itself
   */</span>
  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="56173">serviceSchedulerNode</a> = <a href="#56187" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="57441">zooKeeperRoot</a>.<a href="#57441" title="Int" id="57443">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;serviceScheduler&quot;)" id="57442" class="string">&quot;serviceScheduler&quot;</a><span class="delimiter">)</span>

  <span class="comment">/**
   * A handle to the service scheduler for the cluster
   */</span>
  <span class="keyword">def</span> <a title="=&gt; deploylib.mesos.RemoteServiceScheduler" id="56174">serviceScheduler</a> = classOf<span title="java.lang.Class[deploylib.mesos.RemoteServiceScheduler](classOf[deploylib.mesos.RemoteServiceScheduler])" class="delimiter">[</span>RemoteServiceScheduler<span class="delimiter">]</span>.<span title="()deploylib.mesos.RemoteServiceScheduler">newInstance</span>.<span title="(data: Array[Byte])deploylib.mesos.RemoteServiceScheduler">parse</span><span class="delimiter">(</span><a href="#56173" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Kills all instances running on EC2 for this mesos cluster cluster (masters, slaves, zookeepers)
   */</span>
  <span class="keyword">def</span> <a title="()Unit" id="56175">stopAllInstances</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">(</span><a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a> <span title="(xs: scala.collection.GenTraversableOnce[Cluster.this.region.EC2Instance])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">++</span> <a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a> <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">++</a> <a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a><span class="delimiter">)</span>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#57588" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45088" title="=&gt; Unit">halt</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Start and configure the mesos master, at least numSlaves mesos slaves, and zookeeper in parallel.
   */</span>
  <span class="keyword">def</span> <a title="(numSlaves: Int)Seq[Any]" id="56176">setup</a><span class="delimiter">(</span><a title="Int" id="57592">numSlaves</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> = <span title="(elems: deploylib.Future[_ &gt;: Unit]*)Seq[deploylib.Future[_ &gt;: Unit]]">Seq</span><span class="delimiter">(</span>
    <a href="Concurrent.scala.html#10107" title="(f: =&gt; Unit)deploylib.Future[Unit]">Future</a><span class="delimiter">(</span><a href="#56178" title="(numMasters: Int)Unit">setupMesosMaster</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>,
    <a href="Concurrent.scala.html#10107" title="(f: =&gt; Unit)deploylib.Future[Unit]">Future</a><span class="delimiter">(</span><a href="#56188" title="(numServers: Int)Unit">setupZooKeeper</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>,
    <a href="Concurrent.scala.html#10107" title="(f: =&gt; Any)deploylib.Future[Any]">Future</a><span class="delimiter">(</span><span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#57592" title="Int">numSlaves</a><span class="delimiter">)</span> <a href="#56198" title="(count: Int, updateDeploylibOnStart: Boolean)Seq[deploylib.ec2.package.EC2Instance]">addSlaves</a><span class="delimiter">(</span><a href="#57592" title="Int">numSlaves</a> <span title="(x: Int)Int">-</span> <a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">)</span>.<span title="(f: deploylib.Future[_ &gt;: Unit] =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[deploylib.Future[_ &gt;: Unit]],Any,Seq[Any]])Seq[Any]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,Any,Seq[Any]]" class="delimiter">(</span><a href="Concurrent.scala.html#10120" title="()Any">_</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Update the jars and scripts for deploylib on the specified instances (default: all masters + slaves) using the current classSource
   */</span>
  <span class="keyword">def</span> <a title="(instances: Seq[deploylib.ec2.package.EC2Instance])Unit" id="56177">updateDeploylib</a><span class="delimiter">(</span><a title="Seq[deploylib.ec2.package.EC2Instance]" id="57791">instances</a>: <span title="Seq[deploylib.ec2.package.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">(</span><a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a> <span title="(xs: scala.collection.GenTraversableOnce[Cluster.this.region.EC2Instance])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">++</span> <a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a><span class="delimiter">)</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[deploylib.ec2.package.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.package.EC2Instance]">instances</a>.<a href="Concurrent.scala.html#12308" title="(f: deploylib.ec2.package.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.package.EC2Instance" id="57869">inst</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="String" id="57870">executorScript</a> = <a href="Util.scala.html#9503" title="object deploylib.Util">Util</a>.<a href="Util.scala.html#30929" title="(file: java.io.File)String">readFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib/src/main/resources/java_executor&quot;)" class="string">&quot;deploylib/src/main/resources/java_executor&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
        .<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
        .<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span> <a href="#58322" title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">{</a>
        <span class="keyword">case</span> <a title="java.lang.String" id="58323">s</a> <span class="keyword">if</span> <span class="delimiter">(</span><a href="#58323" title="java.lang.String">s</a> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;CLASSPATH=&quot;)" class="string">&quot;CLASSPATH=&quot;</span><span class="delimiter">)</span> =&gt; <span title="java.lang.String(&quot;CLASSPATH=\'-cp /usr/local/mesos/lib/java/mesos.jar:&quot;)" class="string">&quot;CLASSPATH='-cp /usr/local/mesos/lib/java/mesos.jar:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#57869" title="deploylib.ec2.package.EC2Instance">inst</a>.<a href="ec2/ec2.scala.html#45100" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span class="delimiter">(</span><a href="#9783" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#53416" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;:&quot;)" class="string">&quot;:&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;\'&quot;)" class="string">&quot;'&quot;</span>
        <span class="keyword">case</span> <a title="java.lang.String" id="58327">s</a> =&gt; <a href="#58327" title="java.lang.String">s</a>
      <span class="delimiter">}</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

      <a href="#57869" title="deploylib.ec2.package.EC2Instance">inst</a>.<a href="../RemoteMachine.scala.html#20806" title="(remoteDir: java.io.File)Unit">mkdir</a><span class="delimiter">(</span><a href="#56166" title="=&gt; java.io.File">frameworkDir</a><span class="delimiter">)</span>
      <a href="#57869" title="deploylib.ec2.package.EC2Instance">inst</a>.<a href="ec2/ec2.scala.html#45103" title="(localFile: java.io.File, remoteDirectory: java.io.File)Unit">upload</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib/src/main/resources/config&quot;)" class="string">&quot;deploylib/src/main/resources/config&quot;</span><span class="delimiter">)</span>, <a href="#56166" title="=&gt; java.io.File">frameworkDir</a><span class="delimiter">)</span>
      <a href="#57869" title="deploylib.ec2.package.EC2Instance">inst</a>.<a href="../RemoteMachine.scala.html#20799" title="(file: java.io.File, contents: String, mode: String)Unit">createFile</a><span class="delimiter">(</span><span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#56166" title="=&gt; java.io.File">frameworkDir</a>, <span title="java.lang.String(&quot;java_executor&quot;)" class="string">&quot;java_executor&quot;</span><span class="delimiter">)</span>, <a href="#57870" title="String">executorScript</a>, <span title="java.lang.String(&quot;755&quot;)" class="string">&quot;755&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Configure the mesos master, starting instances if needed.
   */</span>
  <span class="keyword">def</span> <a title="(numMasters: Int)Unit" id="56178">setupMesosMaster</a><span class="delimiter">(</span><a title="Int" id="57619">numMasters</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">//figure out the zone to prevent double master start</span>
    <span class="keyword">val</span> <a title="Option[String]" id="58506">zone</a> = <a href="#56172" title="=&gt; Option[String]">availabilityZone</a>

    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#57619" title="Int">numMasters</a><span class="delimiter">)</span>
      <a href="#56197" title="(count: Int, ami: String)Seq[deploylib.ec2.package.EC2Instance]">startMasters</a><span class="delimiter">(</span><a href="#57619" title="Int">numMasters</a> <span title="(x: Int)Int">-</span> <a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>

    <a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#58550" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">masters</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#58577" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45100" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span title="Unit" class="delimiter">(</span><a href="#9783" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#53416" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#56206" title="=&gt; Unit">updateMasterConf</a>

    <a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#58598" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#58618" title="Cluster.this.region.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#20809" title="(port: Int)Unit">blockTillPortOpen</a><span class="delimiter">(</span><span title="Int(2181)" class="int">2181</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#56193" title="()Unit">restartMasters</a>
    <a href="#56179" title="=&gt; Unit">restartServiceScheduler</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Restart the service scheduler daemon running on the mesos master.
   * NOTE: this will kill any other java procs running on the master.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56179">restartServiceScheduler</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#58642" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">masters</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#58668" title="Cluster.this.region.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#20798" title="(cmd: String, timeout: Long)deploylib.ExecuteResponse">executeCommand</a><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="58623">serviceSchedulerCmd</a> =
      <span class="string">&quot;/$HOME/jrun -Dscads.comm.externalip=true deploylib.mesos.ServiceSchedulerDaemon &quot;</span> <span title="java.lang.String(&quot;/$HOME/jrun -Dscads.comm.externalip=true deploylib.mesos.ServiceSchedulerDaemon --mesosMaster &quot;)">+</span>
        <span class="string">&quot;--mesosMaster &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56191" title="=&gt; String">clusterUrl</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
        <span title="java.lang.String(&quot;--zooKeeperAddress &quot;)" class="string">&quot;--zooKeeperAddress &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56173" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="=&gt; java.lang.String">canonicalAddress</span>

    <a href="#56189" title="=&gt; Cluster.this.region.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#25215" title="(name: java.lang.String, cmd: java.lang.String)Cluster.this.region.EC2Instance#RemoteService">getService</a><span class="delimiter">(</span><span title="java.lang.String(&quot;service-scheduler&quot;)" class="string">&quot;service-scheduler&quot;</span>, <a href="#58623" title="java.lang.String">serviceSchedulerCmd</a><span class="delimiter">)</span>.<a href="../RemoteMachine.scala.html#25239" title="=&gt; Unit">restart</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(inst: deploylib.ec2.package.EC2Instance)deploylib.ServiceManager#RemoteService" id="56180">slaveService</a><span class="delimiter">(</span><a title="deploylib.ec2.package.EC2Instance" id="58679">inst</a>: <a href="ec2/ec2.scala.html#41039" title="deploylib.ec2.package.EC2Instance">EC2Instance</a><span class="delimiter">)</span>: ServiceManager#<a href="../RemoteMachine.scala.html#25212" title="deploylib.ServiceManager#RemoteService">RemoteService</a> = <a href="#58679" title="deploylib.ec2.package.EC2Instance">inst</a>.<a href="../RemoteMachine.scala.html#25215" title="(name: String, cmd: String)inst.RemoteService">getService</a><span class="delimiter">(</span><span title="java.lang.String(&quot;mesos-slave&quot;)" class="string">&quot;mesos-slave&quot;</span>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#56168" title="=&gt; java.io.File">binDir</a>, <span title="java.lang.String(&quot;mesos-slave&quot;)" class="string">&quot;mesos-slave&quot;</span><span class="delimiter">)</span>.<span title="()java.lang.String">getCanonicalPath</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[deploylib.ServiceManager#RemoteService]" id="56181">slaveServices</a> = <a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; deploylib.ServiceManager#RemoteService)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance],deploylib.ServiceManager#RemoteService,scala.collection.mutable.Buffer[deploylib.ServiceManager#RemoteService]])scala.collection.mutable.Buffer[deploylib.ServiceManager#RemoteService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,deploylib.ServiceManager#RemoteService,scala.collection.mutable.Buffer[deploylib.ServiceManager#RemoteService]]" class="delimiter">(</span><a href="#56180" title="(inst: deploylib.ec2.package.EC2Instance)deploylib.ServiceManager#RemoteService">slaveService</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Returns a list of EC2Instances for all the slaves in the cluster
   */</span>
  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]" id="56182">slaves</a> = <span class="delimiter">{</span>
    <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41032" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41013" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#56837" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#56844" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#56851" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;slave&quot;)" class="string">&quot;slave&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; Cluster.this.region.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],Cluster.this.region.EC2Instance,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,Cluster.this.region.EC2Instance,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="56872">t</a> =&gt; <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41033" title="(instanceId: String)Cluster.this.region.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#56872" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: Cluster.this.region.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">filter</span><span class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="56907">i</a> =&gt; <span class="delimiter">(</span><a href="#56907" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#56907" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance#RemoteService]" id="56183">masterServices</a> = <a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Cluster.this.region.EC2Instance#RemoteService)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance],Cluster.this.region.EC2Instance#RemoteService,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance#RemoteService]])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance#RemoteService]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,Cluster.this.region.EC2Instance#RemoteService,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance#RemoteService]]" class="delimiter">(</span><a href="#58763" title="Cluster.this.region.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25215" title="(name: String, cmd: String)x$16.RemoteService">getService</a><span class="delimiter">(</span><span title="java.lang.String(&quot;mesos-master&quot;)" class="string">&quot;mesos-master&quot;</span>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#56168" title="=&gt; java.io.File">binDir</a>, <span title="java.lang.String(&quot;mesos-master&quot;)" class="string">&quot;mesos-master&quot;</span><span class="delimiter">)</span>.<span title="()java.lang.String">getCanonicalPath</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Returns a list of EC2Instances for all the masters in the cluster
   */</span>
  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]" id="56184">masters</a> = <span class="delimiter">{</span>
    <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41032" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41013" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#56571" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#56578" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#56585" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;master&quot;)" class="string">&quot;master&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; Cluster.this.region.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],Cluster.this.region.EC2Instance,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,Cluster.this.region.EC2Instance,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="56606">t</a> =&gt; <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41033" title="(instanceId: String)Cluster.this.region.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#56606" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: Cluster.this.region.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">filter</span><span class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="56653">i</a> =&gt; <span class="delimiter">(</span><a href="#56653" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#56653" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns a list of EC2Instances for all the zookeepers in the clsuter
   */</span>
  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]" id="56185">zooKeepers</a> = <span class="delimiter">{</span>
    <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41032" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41013" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#57112" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#57119" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#57126" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;zoo&quot;)" class="string">&quot;zoo&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; Cluster.this.region.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],Cluster.this.region.EC2Instance,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]])scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,Cluster.this.region.EC2Instance,scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="57147">t</a> =&gt; <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41033" title="(instanceId: String)Cluster.this.region.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#57147" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: Cluster.this.region.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">filter</span><span class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="57182">i</a> =&gt; <span class="delimiter">(</span><a href="#57182" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#57182" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45096" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns he canonical address for the zookeeper quorum for this cluster
   */</span>
  <span class="keyword">def</span> <a title="=&gt; String" id="56186">zooKeeperAddress</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;zk://%s/&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance],java.lang.String,scala.collection.mutable.Buffer[java.lang.String]])scala.collection.mutable.Buffer[java.lang.String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,java.lang.String,scala.collection.mutable.Buffer[java.lang.String]]" class="delimiter">(</span><a href="#57396" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45091" title="=&gt; String">publicDnsName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:2181&quot;)" class="string">&quot;:2181&quot;</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Returns a handle to the root of the the zookeeper quorum for this cluster
   */</span>
  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="56187">zooKeeperRoot</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#56186" title="=&gt; String">zooKeeperAddress</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Configure all zookepers running to operate in a quorum.
   * Starts at at least numServers if they aren't already running.
   */</span>
  <span class="keyword">def</span> <a title="(numServers: Int)Unit" id="56188">setupZooKeeper</a><span class="delimiter">(</span><a title="Int" id="57627">numServers</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Int" id="58798">missingServers</a> = <a href="#57627" title="Int">numServers</a> <span title="(x: Int)Int">-</span> <a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a>.<span title="=&gt; Int">size</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#58798" title="Int">missingServers</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[Cluster.this.region.EC2Instance]" id="58812">ret</a> = <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41038" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: Option[String], userData: Option[String])Seq[Cluster.this.region.EC2Instance]">runInstances</a><span class="delimiter">(</span>
        <a href="#56170" title="=&gt; java.lang.String">mesosAmi</a>,
        <a href="#58798" title="Int">missingServers</a>,
        <a href="#58798" title="Int">missingServers</a>,
        <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41011" title="=&gt; java.lang.String">keyName</a>,
        <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
        <a href="#56172" title="=&gt; Option[String]">availabilityZone</a>,
        <span title="object None">None</span><span class="delimiter">)</span>

      <a href="#58812" title="Seq[Cluster.this.region.EC2Instance]">ret</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#58998" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45085" title="object x$24.tags">tags</a> <a href="ec2/ec2.scala.html#47135" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;zoo&quot;)" class="string">&quot;zoo&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#58812" title="Seq[Cluster.this.region.EC2Instance]">ret</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#59009" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.Buffer[(Cluster.this.region.EC2Instance, Int)]" id="58799">servers</a> = <a href="#56185" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">zooKeepers</a>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance],(Cluster.this.region.EC2Instance, Int),scala.collection.mutable.Buffer[(Cluster.this.region.EC2Instance, Int)]])scala.collection.mutable.Buffer[(Cluster.this.region.EC2Instance, Int)]">zipWithIndex</span>

    <span class="keyword">val</span> <a title="List[String]" id="58800">serverList</a> = <a href="#58799" title="scala.collection.mutable.Buffer[(Cluster.this.region.EC2Instance, Int)]">servers</a>.<span title="(f: (Cluster.this.region.EC2Instance, Int) =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[(Cluster.this.region.EC2Instance, Int)],String,scala.collection.mutable.Buffer[String]])scala.collection.mutable.Buffer[String]">map</span> <a href="#59066" title="String" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="String" class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="59069">server</a>, <a title="Int" id="59070">id</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt; <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;server.%d=%s:3181:3182&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#59070" title="Int">id</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#59069" title="Cluster.this.region.EC2Instance">server</a>.<a href="ec2/ec2.scala.html#45092" title="=&gt; String">privateDnsName</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="=&gt; List[String]">toList</span>

    <span class="keyword">val</span> <a title="String" id="58801">cnf</a> =
      <span class="delimiter">(</span><span title="java.lang.String(&quot;dataDir=/mnt/zookeeper&quot;)" class="string">&quot;dataDir=/mnt/zookeeper&quot;</span> <a href="#59104" title="(x: String)List[String]">::</a>
        <span title="java.lang.String(&quot;clientPort=2181&quot;)" class="string">&quot;clientPort=2181&quot;</span> <a href="#59105" title="(x: String)List[String]">::</a>
        <span title="java.lang.String(&quot;tickTime=1000&quot;)" class="string">&quot;tickTime=1000&quot;</span> <a href="#59106" title="(x: String)List[String]">::</a>
        <span title="java.lang.String(&quot;initLimit=60&quot;)" class="string">&quot;initLimit=60&quot;</span> <a href="#59107" title="(x: String)List[String]">::</a>
        <span title="java.lang.String(&quot;syncLimit=30&quot;)" class="string">&quot;syncLimit=30&quot;</span> <a href="#59108" title="(x: String)List[String]">::</a>
        <span class="delimiter">(</span><span title="List[String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#58799" title="scala.collection.mutable.Buffer[(Cluster.this.region.EC2Instance, Int)]">servers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <a href="#58800" title="List[String]">serverList</a> <span class="keyword">else</span> <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="java.lang.String" id="58802">startCommand</a> = <span title="java.lang.String(&quot;/$HOME/jrun org.apache.zookeeper.server.quorum.QuorumPeerMain /mnt/zookeeper.cnf&quot;)" class="string">&quot;/$HOME/jrun org.apache.zookeeper.server.quorum.QuorumPeerMain /mnt/zookeeper.cnf&quot;</span>

    <a href="package.scala.html#9888" title="(itr: Iterable[(Cluster.this.region.EC2Instance, Int)])deploylib.ParallelSeq[(Cluster.this.region.EC2Instance, Int)]">servers</a>.<a href="Concurrent.scala.html#12308" title="(f: (Cluster.this.region.EC2Instance, Int) =&gt; Unit)Unit">pforeach</a> <a href="#59183" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="59186">server</a>, <a title="Int" id="59187">id</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt;
        <a href="#59186" title="Cluster.this.region.EC2Instance">server</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;mkdir -p /mnt/zookeeper&quot;)" class="string">&quot;mkdir -p /mnt/zookeeper&quot;</span>
        <a href="#59186" title="Cluster.this.region.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#20799" title="(file: java.io.File, contents: String, mode: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/zookeeper.cnf&quot;)" class="string">&quot;/mnt/zookeeper.cnf&quot;</span><span class="delimiter">)</span>, <a href="#58801" title="String">cnf</a><span class="delimiter">)</span>
        <a href="#59186" title="Cluster.this.region.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#20799" title="(file: java.io.File, contents: String, mode: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/zookeeper/myid&quot;)" class="string">&quot;/mnt/zookeeper/myid&quot;</span><span class="delimiter">)</span>, <span class="delimiter">(</span><a href="#59187" title="Int">id</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>

        <span class="keyword">val</span> <a title="server.RemoteService" id="59188">zooService</a> = <a href="#59186" title="Cluster.this.region.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25215" title="(name: String, cmd: String)server.RemoteService">getService</a><span class="delimiter">(</span><span title="java.lang.String(&quot;zookeeper&quot;)" class="string">&quot;zookeeper&quot;</span>, <a href="#58802" title="java.lang.String">startCommand</a><span class="delimiter">)</span>

        <a href="#59186" title="Cluster.this.region.EC2Instance">server</a>.<a href="ec2/ec2.scala.html#45100" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span class="delimiter">(</span><a href="#9783" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#53416" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span>
        <a href="#59186" title="Cluster.this.region.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#20798" title="(cmd: String, timeout: Long)deploylib.ExecuteResponse">executeCommand</a><span class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span>
        <a href="#59188" title="server.RemoteService">zooService</a>.<a href="../RemoteMachine.scala.html#25237" title="=&gt; Unit">start</a>
    <span class="delimiter">}</span>

    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="#58801" title="String">cnf</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns the EC2Instance for the first mesos master
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Cluster.this.region.EC2Instance" id="56189">firstMaster</a> = <a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="=&gt; Cluster.this.region.EC2Instance">head</span>

  <span class="comment">/**
   * Copy the mesos binaries from the master to all slaves
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56190">updateMesos</a> =
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">slaves</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="59231">s</a> =&gt;
      <a href="#56189" title="=&gt; Cluster.this.region.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;rsync -e 'ssh -o StrictHostKeyChecking=no' -av /usr/local/mesos root@%s:/usr/local/mesos&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#59231" title="Cluster.this.region.EC2Instance">s</a>.<a href="ec2/ec2.scala.html#45091" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Returns the mesos cluster url
   */</span>
  <span class="keyword">def</span> <a title="=&gt; String" id="56191">clusterUrl</a>: <span title="String">String</span> =
    <span title="String" class="keyword">if</span> <span class="delimiter">(</span><a href="#56415" title="=&gt; Boolean">useFT</a><span class="delimiter">)</span>
      <span title="java.lang.String(&quot;zoo://&quot;)" class="string">&quot;zoo://&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56187" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">zooKeeperRoot</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy">proxy</span>.<span title="=&gt; Seq[String]">servers</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56187" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="59238">zooKeeperRoot</a>.<a href="#59238" title="Int" id="59240">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;mesos&quot;)" id="59239" class="string">&quot;mesos&quot;</a><span class="delimiter">)</span>.<span title="=&gt; String">path</span>
    <span class="keyword">else</span>
      <span title="java.lang.String(&quot;master@&quot;)" class="string">&quot;master@&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56189" title="=&gt; Cluster.this.region.EC2Instance">firstMaster</a>.<a href="ec2/ec2.scala.html#45091" title="=&gt; String">publicDnsName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:5050&quot;)" class="string">&quot;:5050&quot;</span>

  <span class="comment">/**
   * Restart the mesos-slave process for all slaves
   */</span>
  <span class="keyword">def</span> <a title="()Unit" id="56192">restartSlaves</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="package.scala.html#9888" title="(itr: Iterable[deploylib.ServiceManager#RemoteService])deploylib.ParallelSeq[deploylib.ServiceManager#RemoteService]">slaveServices</a>.<a href="Concurrent.scala.html#12308" title="(f: deploylib.ServiceManager#RemoteService =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#59272" title="deploylib.ServiceManager#RemoteService">_</a>.<a href="../RemoteMachine.scala.html#25239" title="=&gt; Unit">restart</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Restart the mesos-master process for all masters
   */</span>
  <span class="keyword">def</span> <a title="()Unit" id="56193">restartMasters</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance#RemoteService])deploylib.ParallelSeq[Cluster.this.region.EC2Instance#RemoteService]">masterServices</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance#RemoteService =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#59303" title="Cluster.this.region.EC2Instance#RemoteService">_</a>.<a href="../RemoteMachine.scala.html#25239" title="=&gt; Unit">restart</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Restart masters, slaves, and the service scheduler.  Also kills any java procs running on slaves.
   */</span>
  <span class="keyword">def</span> <a title="()Unit" id="56194">restart</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">masters</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#59330" title="Cluster.this.region.EC2Instance">_</a> <a href="../RemoteMachine.scala.html#20798" title="(cmd: String, timeout: Long)deploylib.ExecuteResponse">executeCommand</a> <span title="java.lang.String(&quot;killall -9 mesos-master&quot;)" class="string">&quot;killall -9 mesos-master&quot;</span><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">masters</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#59355" title="Cluster.this.region.EC2Instance">_</a> <a href="../RemoteMachine.scala.html#20798" title="(cmd: String, timeout: Long)deploylib.ExecuteResponse">executeCommand</a> <span title="java.lang.String(&quot;killall -9 java&quot;)" class="string">&quot;killall -9 java&quot;</span><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">slaves</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#59380" title="Cluster.this.region.EC2Instance">_</a> <a href="../RemoteMachine.scala.html#20798" title="(cmd: String, timeout: Long)deploylib.ExecuteResponse">executeCommand</a> <span title="java.lang.String(&quot;killall -9 mesos-slave&quot;)" class="string">&quot;killall -9 mesos-slave&quot;</span><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">slaves</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#59405" title="Cluster.this.region.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#20798" title="(cmd: String, timeout: Long)deploylib.ExecuteResponse">executeCommand</a><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;killall -9 java&quot;)" class="string">&quot;killall -9 java&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#56193" title="()Unit">restartMasters</a>
    <a href="#56192" title="()Unit">restartSlaves</a>
    <a href="#56179" title="=&gt; Unit">restartServiceScheduler</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Update the slaves file for the mesos scripts located in /root/mesos-ec2
   */</span>
  @deprecated<span class="delimiter">(</span><span class="string">&quot;don't use the mesos scripts anymore&quot;</span>, <span class="string">&quot;v2.1.2&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56195">updateSlavesFile</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.File" id="59408">location</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/root/mesos-ec2/slaves&quot;)" class="string">&quot;/root/mesos-ec2/slaves&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="59409">contents</a> = <a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance],String,scala.collection.mutable.Buffer[String]])scala.collection.mutable.Buffer[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,String,scala.collection.mutable.Buffer[String]]" class="delimiter">(</span><a href="#59433" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45092" title="=&gt; String">privateDnsName</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">masters</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a> <span class="delimiter">{</span>
      <a title="Cluster.this.region.EC2Instance" id="59486">master</a> =&gt;
        <a href="#59486" title="Cluster.this.region.EC2Instance">master</a>.<a href="../RemoteMachine.scala.html#20806" title="(remoteDir: java.io.File)Unit">mkdir</a><span class="delimiter">(</span><a href="mesos/package.scala.html#9878" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File" class="string">&quot;/root/mesos-ec2&quot;</a><span class="delimiter">)</span>
        <a href="#59486" title="Cluster.this.region.EC2Instance">master</a>.<a href="../RemoteMachine.scala.html#20799" title="(file: java.io.File, contents: String, mode: String)Unit">createFile</a><span class="delimiter">(</span><a href="#59408" title="java.io.File">location</a>, <a href="#59409" title="String">contents</a>, <span title="java.lang.String(&quot;644&quot;)" class="string">&quot;644&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(count: Int, zone: Option[String])Seq[deploylib.ec2.package.EC2Instance]" id="56196">startMasterInstances</a><span class="delimiter">(</span><a title="Int" id="57342">count</a>: <span title="Int">Int</span>, <a title="Option[String]" id="57345">zone</a>: <span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span>: <span title="Seq[deploylib.ec2.package.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[Cluster.this.region.EC2Instance]" id="59487">instances</a> = <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41038" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: Option[String], userData: Option[String])Seq[Cluster.this.region.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#56170" title="=&gt; java.lang.String">mesosAmi</a>,
      <a href="#57342" title="Int">count</a>,
      <a href="#57342" title="Int">count</a>,
      <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41011" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#57345" title="Option[String]">zone</a>,
      <span title="object None">None</span><span class="delimiter">)</span>
    <a href="#59487" title="Seq[Cluster.this.region.EC2Instance]">instances</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#59506" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45085" title="object x$38.tags">tags</a> <a href="ec2/ec2.scala.html#47135" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;master&quot;)" class="string">&quot;master&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#59487" title="Seq[Cluster.this.region.EC2Instance]">instances</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Start and configure the specified number of masters.
   */</span>
  <span class="keyword">def</span> <a title="(count: Int, ami: String)Seq[deploylib.ec2.package.EC2Instance]" id="56197">startMasters</a><span class="delimiter">(</span><a title="Int" id="58515">count</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span>, <a title="String" id="58516">ami</a>: <span title="String">String</span> = <a href="#56170" title="=&gt; java.lang.String">mesosAmi</a><span class="delimiter">)</span>: <span title="Seq[deploylib.ec2.package.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[deploylib.ec2.package.EC2Instance]" id="59508">instances</a> = <a href="#56196" title="(count: Int, zone: Option[String])Seq[deploylib.ec2.package.EC2Instance]">startMasterInstances</a><span class="delimiter">(</span><a href="#58515" title="Int">count</a>, <a href="#56172" title="=&gt; Option[String]">availabilityZone</a><span class="delimiter">)</span>

    <a href="package.scala.html#9888" title="(itr: Iterable[deploylib.ec2.package.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.package.EC2Instance]">instances</a>.<a href="Concurrent.scala.html#12308" title="(f: deploylib.ec2.package.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.package.EC2Instance" id="59534">i</a> =&gt; <span class="delimiter">{</span>
      <a href="#59534" title="deploylib.ec2.package.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a>
      <a href="#56205" title="(instances: Seq[deploylib.ec2.package.EC2Instance])Unit">updateSlaveConf</a><span class="delimiter">(</span><a href="#59534" title="deploylib.ec2.package.EC2Instance">i</a> <a href="#59538" title="(x: deploylib.ec2.package.EC2Instance)List[deploylib.ec2.package.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <a href="#56193" title="()Unit">restartMasters</a>
    <a href="#59508" title="Seq[deploylib.ec2.package.EC2Instance]">instances</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Add slaves to the cluster
   */</span>
  <span class="keyword">def</span> <a title="(count: Int, updateDeploylibOnStart: Boolean)Seq[deploylib.ec2.package.EC2Instance]" id="56198">addSlaves</a><span class="delimiter">(</span><a title="Int" id="57638">count</a>: <span title="Int">Int</span>, <a title="Boolean" id="57641">updateDeploylibOnStart</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>: <span title="Seq[deploylib.ec2.package.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[java.lang.String]" id="59546">userData</a> =
      <span title="Option[java.lang.String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#57641" title="Boolean">updateDeploylibOnStart</a><span class="delimiter">)</span>
        <span title="object None">None</span>
      <span class="keyword">else</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
          <a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#59566" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
          <span title="(x: java.lang.String)Some[java.lang.String]">Some</span><span class="delimiter">(</span><span title="java.lang.String(&quot;url=&quot;)" class="string">&quot;url=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56191" title="=&gt; String">clusterUrl</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="None.type" id="59571">noMaster</a>: java.util.<span title="java.util.NoSuchElementException">NoSuchElementException</span> =&gt;
            <a href="#56162" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No master found. Starting without userdata&quot;)" class="string">&quot;No master found. Starting without userdata&quot;</span><span class="delimiter">)</span>
            <span title="object None">None</span>
        <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Seq[Cluster.this.region.EC2Instance]" id="59547">instances</a> = <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41038" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: Option[String], userData: Option[String])Seq[Cluster.this.region.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#56170" title="=&gt; java.lang.String">mesosAmi</a>,
      <a href="#57638" title="Int">count</a>,
      <a href="#57638" title="Int">count</a>,
      <a href="#56414" title="=&gt; deploylib.ec2.EC2Region">region</a>.<a href="ec2/ec2.scala.html#41011" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#56172" title="=&gt; Option[String]">availabilityZone</a>,
      <a href="#59546" title="Option[java.lang.String]">userData</a><span class="delimiter">)</span>
    <a href="#59547" title="Seq[Cluster.this.region.EC2Instance]">instances</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#59606" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45085" title="object x$41.tags">tags</a> <a href="ec2/ec2.scala.html#47135" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;slave&quot;)" class="string">&quot;slave&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#57641" title="Boolean">updateDeploylibOnStart</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">//Hack to avoid race condition where there are no masters yet because they haven't been tagged.</span>
      <a href="#59547" title="Seq[Cluster.this.region.EC2Instance]">instances</a>.<span title="=&gt; Cluster.this.region.EC2Instance">head</span>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a>
      <a href="#56184" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">masters</a>.<span title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#59626" title="Cluster.this.region.EC2Instance">_</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
      <a href="#56189" title="=&gt; Cluster.this.region.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#20809" title="(port: Int)Unit">blockTillPortOpen</a><span class="delimiter">(</span><span title="Int(5050)" class="int">5050</span><span class="delimiter">)</span>

      <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">instances</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="59661">i</a> =&gt; <span class="keyword">try</span> <span class="delimiter">{</span>
        <a href="#59661" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45101" title="()Unit">blockUntilRunning</a>
        <a href="#56177" title="(instances: Seq[deploylib.ec2.package.EC2Instance])Unit">updateDeploylib</a><span class="delimiter">(</span><a href="#59661" title="Cluster.this.region.EC2Instance">i</a> <a href="#59662" title="(x: Cluster.this.region.EC2Instance)List[Cluster.this.region.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
        <a href="#56205" title="(instances: Seq[deploylib.ec2.package.EC2Instance])Unit">updateSlaveConf</a><span class="delimiter">(</span><a href="#59661" title="Cluster.this.region.EC2Instance">i</a> <a href="#59666" title="(x: Cluster.this.region.EC2Instance)List[Cluster.this.region.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
        <a href="#56180" title="(inst: deploylib.ec2.package.EC2Instance)deploylib.ServiceManager#RemoteService">slaveService</a><span class="delimiter">(</span><a href="#59661" title="Cluster.this.region.EC2Instance">i</a><span class="delimiter">)</span>.<a href="../RemoteMachine.scala.html#25237" title="=&gt; Unit">start</a>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="59670">e</a> =&gt; <a href="#56162" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(thrown: Throwable, msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><a href="#59670" title="java.lang.Throwable">e</a>, <span title="java.lang.String(&quot;Failed to start slave on instance %s:%s&quot;)" class="string">&quot;Failed to start slave on instance %s:%s&quot;</span>, <a href="#59661" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45117" title="=&gt; String">instanceId</a>, <a href="#59661" title="Cluster.this.region.EC2Instance">i</a>.<a href="ec2/ec2.scala.html#45091" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#59547" title="Seq[Cluster.this.region.EC2Instance]">instances</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="List[java.lang.String]" id="56199">baseConf</a> = <span class="delimiter">(</span>
    <span title="java.lang.String(&quot;webui_port=8080&quot;)" class="string">&quot;webui_port=8080&quot;</span> <a href="#56385" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;work_dir=/mnt&quot;)" class="string">&quot;work_dir=/mnt&quot;</span> <a href="#56386" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;log_dir=/mnt&quot;)" class="string">&quot;log_dir=/mnt&quot;</span> <a href="#56387" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;switch_user=0&quot;)" class="string">&quot;switch_user=0&quot;</span> <a href="#56388" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;shares_interval=30&quot;)" class="string">&quot;shares_interval=30&quot;</span> <a href="#56389" title="(x: java.lang.String)List[java.lang.String]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; List[java.lang.String]" id="56201">confWithUrl</a> = <span class="delimiter">(</span><span title="java.lang.String(&quot;master=&quot;)" class="string">&quot;master=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#56191" title="=&gt; String">clusterUrl</a><span class="delimiter">)</span> <a href="#59678" title="(x: java.lang.String)List[java.lang.String]">::</a> <a href="#56199" title="=&gt; List[java.lang.String]">baseConf</a>

  <span class="comment">/**
   * Returns the contents of the mesos slave configuration file.
   */</span>
  <span class="keyword">def</span> <a title="(instance: deploylib.ec2.package.EC2Instance)String" id="56202">slaveConf</a><span class="delimiter">(</span><a title="deploylib.ec2.package.EC2Instance" id="59684">instance</a>: <a href="ec2/ec2.scala.html#41039" title="deploylib.ec2.package.EC2Instance">EC2Instance</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><span title="java.lang.String(&quot;mem=&quot;)" class="string">&quot;mem=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#59684" title="deploylib.ec2.package.EC2Instance">instance</a>.<a href="../RemoteMachine.scala.html#20829" title="=&gt; instance.FreeStats">free</a>.<a href="../RemoteMachine.scala.html#33965" title="=&gt; Int">total</a> <span title="(x: Int)Int">-</span> <span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#59687" title="(x: java.lang.String)List[java.lang.String]">::</a>
    <a href="#56201" title="=&gt; List[java.lang.String]">confWithUrl</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

  <span class="comment">/**
   * the location of the configuration file for both masters and slaves on the remote machine
   */</span>
  <span class="keyword">val</span> <a title="java.io.File" id="56203">confFile</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/usr/local/mesos/conf/mesos.conf&quot;)" class="string">&quot;/usr/local/mesos/conf/mesos.conf&quot;</span><span class="delimiter">)</span>


  <span class="comment">/**
   * Updates the slave configuration file on the specified instances (default all slaves)
   */</span>
  <span class="keyword">def</span> <a title="(instances: Seq[deploylib.ec2.package.EC2Instance])Unit" id="56205">updateSlaveConf</a><span class="delimiter">(</span><a title="Seq[deploylib.ec2.package.EC2Instance]" id="59537">instances</a>: <span title="Seq[deploylib.ec2.package.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <a href="#56182" title="=&gt; scala.collection.mutable.Buffer[Cluster.this.region.EC2Instance]">slaves</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[deploylib.ec2.package.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.package.EC2Instance]">instances</a>.<a href="Concurrent.scala.html#12308" title="(f: deploylib.ec2.package.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.package.EC2Instance" id="59743">i</a> =&gt; <a href="#59743" title="deploylib.ec2.package.EC2Instance">i</a>.<a href="../RemoteMachine.scala.html#20799" title="(file: java.io.File, contents: String, mode: String)Unit">createFile</a><span class="delimiter">(</span><a href="#56203" title="=&gt; java.io.File">confFile</a>, <a href="#56202" title="(instance: deploylib.ec2.package.EC2Instance)String">slaveConf</a><span class="delimiter">(</span><a href="#59743" title="deploylib.ec2.package.EC2Instance">i</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Updates the master configuration file on all masters.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56206">updateMasterConf</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="59744">masterConf</a> =
      <span title="String" class="keyword">if</span> <span class="delimiter">(</span><a href="#56415" title="=&gt; Boolean">useFT</a><span class="delimiter">)</span>
        <a href="#56201" title="=&gt; List[java.lang.String]">confWithUrl</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
      <span class="keyword">else</span>
        <a href="#56199" title="=&gt; List[java.lang.String]">baseConf</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">masters</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#59775" title="Cluster.this.region.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#20799" title="(file: java.io.File, contents: String, mode: String)Unit">createFile</a><span class="delimiter">(</span><a href="#56203" title="=&gt; java.io.File">confFile</a>, <a href="#59744" title="String">masterConf</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns S3 Cached jars for all jar files specified in MesosCluster.jarFiles.  This will upload any jar files that don't already exist
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Seq[deploylib.mesos.S3CachedJar]" id="56207">classSource</a>: <span title="Seq[deploylib.mesos.S3CachedJar]">Seq</span><span class="delimiter">[</span>S3CachedJar<span class="delimiter">]</span> =
    <span title="Seq[deploylib.mesos.S3CachedJar]" class="keyword">if</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib.classSource&quot;)" class="string">&quot;deploylib.classSource&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#56208" title="=&gt; Seq[String]">pushJars</a>.<span title="(f: String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],java.lang.String,Seq[java.lang.String]])Seq[java.lang.String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,java.lang.String,Seq[java.lang.String]]" class="delimiter">(</span><a href="mesos/package.scala.html#9878" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File">_</a>.<span title="()java.lang.String">getName</span><span class="delimiter">)</span>
        .<span title="(f: java.lang.String =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.lang.String],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="ec2/s3cache.scala.html#9570" title="object deploylib.ec2.S3Cache">S3Cache</a>.<a href="ec2/s3cache.scala.html#48145" title="(fileMd5: String)String">hashToUrl</a><span class="delimiter">)</span>
        .<span title="(f: String =&gt; deploylib.mesos.S3CachedJar)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],deploylib.mesos.S3CachedJar,Seq[deploylib.mesos.S3CachedJar]])Seq[deploylib.mesos.S3CachedJar]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,deploylib.mesos.S3CachedJar,Seq[deploylib.mesos.S3CachedJar]]" class="delimiter">(</span><span title="deploylib.mesos.S3CachedJar" class="keyword">new</span> <a href="mesos/Messages.scala.html#75243" title="deploylib.mesos.S3CachedJar">S3CachedJar</a><span class="delimiter">(</span><a href="#59913" title="String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib.classSource&quot;)" class="string">&quot;deploylib.classSource&quot;</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;\\|&quot;)" class="string">&quot;\\|&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; deploylib.mesos.S3CachedJar)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],deploylib.mesos.S3CachedJar,Seq[deploylib.mesos.S3CachedJar]])Seq[deploylib.mesos.S3CachedJar]">map</span><span title="(implicit m: DummyImplicit)scala.collection.generic.CanBuildFrom[Array[_],deploylib.mesos.S3CachedJar,scala.collection.mutable.ArraySeq[deploylib.mesos.S3CachedJar]]" class="delimiter">(</span><a href="mesos/Messages.scala.html#75243" title="(url: String)deploylib.mesos.S3CachedJar">S3CachedJar</a><span class="delimiter">(</span><a href="#60414" title="java.lang.String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">//TODO fix me.</span>
  <span class="keyword">def</span> <a title="=&gt; Seq[String]" id="56208">pushJars</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[java.io.File]" id="60438">jars</a> = <a href="#9783" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#53416" title="=&gt; Seq[java.io.File]">jarFiles</a>
    <span class="keyword">val</span> <a href="#60440" title="(Seq[java.io.File], Seq[java.io.File])" class="delimiter">(</a><a href="#60439" title="Seq[java.io.File]" id="60440">deploylib</a>, <a href="#60439" title="Seq[java.io.File]" id="60441">otherJars</a><span class="delimiter">)</span> = <a href="#60438" title="Seq[java.io.File]">jars</a>.<span title="(p: java.io.File =&gt; Boolean)(Seq[java.io.File], Seq[java.io.File])">partition</span><span title="(Seq[java.io.File], Seq[java.io.File]) @unchecked" class="delimiter">(</span><a href="#60446" title="java.io.File">_</a>.<span title="()java.lang.String">getName</span> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;deploylib&quot;)" class="string">&quot;deploylib&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[java.io.File]" id="60442">sortedJars</a> = <a href="#60440" title="Seq[java.io.File]">deploylib</a> <span title="(that: scala.collection.GenTraversableOnce[java.io.File])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.io.File],java.io.File,Seq[java.io.File]])Seq[java.io.File]">++</span> <a href="#60441" title="Seq[java.io.File]">otherJars</a>

    <a href="#56162" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Starting Jar upload&quot;)" class="string">&quot;Starting Jar upload&quot;</span><span class="delimiter">)</span>
    <a href="#60442" title="Seq[java.io.File]">sortedJars</a>.<span title="(f: java.io.File =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.io.File],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="ec2/s3cache.scala.html#9570" title="object deploylib.ec2.S3Cache">S3Cache</a>.<a href="ec2/s3cache.scala.html#48146" title="(file: java.io.File)String">getCacheUrl</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Create a public key on the master if it doesn't exist
   * Then add that to the authorized key file all of slaves
   * TODO: Dedup keys
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56209">authorizeMaster</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="60534">getKeyCommand</a> = <span title="java.lang.String(&quot;cat /$HOME/.ssh/id_rsa.pub&quot;)" class="string">&quot;cat /$HOME/.ssh/id_rsa.pub&quot;</span>
    <span class="keyword">val</span> <a title="String" id="60535">key</a> = <span class="keyword">try</span> <span class="delimiter">(</span><a href="#56189" title="=&gt; Cluster.this.region.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#20797" title="(cmd: String)String">!?</a> <a href="#60534" title="java.lang.String">getKeyCommand</a><span class="delimiter">)</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="String" id="60536">u</a>: <a href="../RemoteMachine.scala.html#9603" title="deploylib.UnknownResponse">UnknownResponse</a> =&gt; <span class="delimiter">{</span>
        <a href="#56189" title="=&gt; Cluster.this.region.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#20796" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;ssh-keygen -t rsa -f /$HOME/.ssh/id_rsa -N \&quot;\&quot;&quot;)" class="string">&quot;ssh-keygen -t rsa -f /$HOME/.ssh/id_rsa -N \&quot;\&quot;&quot;</span>
        <a href="#56189" title="=&gt; Cluster.this.region.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#20797" title="(cmd: String)String">!?</a> <a href="#60534" title="java.lang.String">getKeyCommand</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">slaves</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#60561" title="Cluster.this.region.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#20800" title="(file: java.io.File, contents: String)Unit">appendFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/$HOME/.ssh/authorized_keys&quot;)" class="string">&quot;/$HOME/.ssh/authorized_keys&quot;</span><span class="delimiter">)</span>, <a href="#60535" title="String">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  @deprecated<span class="delimiter">(</span><span class="string">&quot;use watchSlaveLogs&quot;</span>, <span class="string">&quot;v2.1.2&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56210">tailSlaveLogs</a> = <a href="#56211" title="=&gt; Unit">watchSlaveLogs</a>

  <span class="comment">/**
   * Watch stdout of the most recently started framework on all slaves and print the output to stdout of the local machine.
   * Used for debugging.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56211">watchSlaveLogs</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.File" id="60571">workDir</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/work&quot;)" class="string">&quot;/mnt/work&quot;</span><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">slaves</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="60600">s</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">try</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.File" id="60601">currentSlaveDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#60571" title="java.io.File">workDir</a>, <a href="#60600" title="Cluster.this.region.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#20815" title="(dir: java.io.File)Seq[s.RemoteFile]">ls</a><span class="delimiter">(</span><a href="#60571" title="java.io.File">workDir</a><span class="delimiter">)</span>.<span title="(f: s.RemoteFile =&gt; String)(implicit ord: scala.math.Ordering[String])Seq[s.RemoteFile]">sortBy</span><span title="object scala.math.Ordering.String" class="delimiter">(</span><a href="#60910" title="s.RemoteFile">_</a>.<a href="../RemoteMachine.scala.html#29669" title="=&gt; String">modDate</a><span class="delimiter">)</span>.<span title="=&gt; s.RemoteFile">last</span>.<a href="../RemoteMachine.scala.html#29663" title="=&gt; String">name</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="java.io.File" id="60602">currentFrameworkDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#60601" title="java.io.File">currentSlaveDir</a>, <a href="#60600" title="Cluster.this.region.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#20815" title="(dir: java.io.File)Seq[s.RemoteFile]">ls</a><span class="delimiter">(</span><a href="#60601" title="java.io.File">currentSlaveDir</a><span class="delimiter">)</span>.<span title="=&gt; s.RemoteFile">head</span>.<a href="../RemoteMachine.scala.html#29663" title="=&gt; String">name</a><span class="delimiter">)</span>
        <a href="#60600" title="Cluster.this.region.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#20807" title="(remoteFile: java.io.File)Unit">watch</a><span class="delimiter">(</span><span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#60602" title="java.io.File">currentFrameworkDir</a>, <span title="java.lang.String(&quot;0/stdout&quot;)" class="string">&quot;0/stdout&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="61869">e</a> =&gt; <a href="#56162" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No frameworks on %s&quot;)" class="string">&quot;No frameworks on %s&quot;</span>, <a href="#60600" title="Cluster.this.region.EC2Instance">s</a>.<a href="ec2/ec2.scala.html#45091" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Watch stderr of the most recently started framework on all slaves and print the output to stdout of the local machine.
   * Used for debugging.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="56212">watchExecLogs</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.File" id="61876">workDir</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/work&quot;)" class="string">&quot;/mnt/work&quot;</span><span class="delimiter">)</span>
    <a href="package.scala.html#9888" title="(itr: Iterable[Cluster.this.region.EC2Instance])deploylib.ParallelSeq[Cluster.this.region.EC2Instance]">slaves</a>.<a href="Concurrent.scala.html#12308" title="(f: Cluster.this.region.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="Cluster.this.region.EC2Instance" id="61905">s</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">try</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="java.io.File" id="61906">currentSlaveDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#61876" title="java.io.File">workDir</a>, <a href="#61905" title="Cluster.this.region.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#20815" title="(dir: java.io.File)Seq[s.RemoteFile]">ls</a><span class="delimiter">(</span><a href="#61876" title="java.io.File">workDir</a><span class="delimiter">)</span>.<span title="(f: s.RemoteFile =&gt; String)(implicit ord: scala.math.Ordering[String])Seq[s.RemoteFile]">sortBy</span><span title="object scala.math.Ordering.String" class="delimiter">(</span><a href="#61918" title="s.RemoteFile">_</a>.<a href="../RemoteMachine.scala.html#29669" title="=&gt; String">modDate</a><span class="delimiter">)</span>.<span title="=&gt; s.RemoteFile">last</span>.<a href="../RemoteMachine.scala.html#29663" title="=&gt; String">name</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="java.io.File" id="61907">currentFrameworkDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#61906" title="java.io.File">currentSlaveDir</a>, <a href="#61905" title="Cluster.this.region.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#20815" title="(dir: java.io.File)Seq[s.RemoteFile]">ls</a><span class="delimiter">(</span><a href="#61906" title="java.io.File">currentSlaveDir</a><span class="delimiter">)</span>.<span title="=&gt; s.RemoteFile">head</span>.<a href="../RemoteMachine.scala.html#29663" title="=&gt; String">name</a><span class="delimiter">)</span>
        <a href="#61905" title="Cluster.this.region.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#20807" title="(remoteFile: java.io.File)Unit">watch</a><span class="delimiter">(</span><span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#61907" title="java.io.File">currentFrameworkDir</a>, <span title="java.lang.String(&quot;0/stderr&quot;)" class="string">&quot;0/stderr&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="61989">e</a> =&gt; <a href="#56162" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No frameworks on %s&quot;)" class="string">&quot;No frameworks on %s&quot;</span>, <a href="#61905" title="Cluster.this.region.EC2Instance">s</a>.<a href="ec2/ec2.scala.html#45091" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>