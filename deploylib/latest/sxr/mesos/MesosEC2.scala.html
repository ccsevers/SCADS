<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>mesos/MesosEC2.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> deploylib
<span class="keyword">package</span> mesos

<span class="keyword">import</span> ec2._
<span class="keyword">import</span> config._

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> java.net.InetAddress
<span class="keyword">import</span> collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> com.amazonaws.services.ec2.model._

<span class="keyword">object</span> <a title="object deploylib.mesos.ServiceSchedulerDaemon" id="9629">ServiceSchedulerDaemon</a> <span title="ScalaObject" class="keyword">extends</span> optional.<span title="optional.Application">Application</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="67935">javaExecutorPath</a> = <span title="java.lang.String(&quot;/usr/local/mesos/frameworks/deploylib/java_executor&quot;)" class="string">&quot;/usr/local/mesos/frameworks/deploylib/java_executor&quot;</span>

  <span class="keyword">def</span> <a title="(mesosMaster: String, zooKeeperAddress: String)Unit" id="67937">main</a><span class="delimiter">(</span><a title="String" id="67939">mesosMaster</a>: <span title="String">String</span>, <a title="String" id="67940">zooKeeperAddress</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)Unit">loadLibrary</span><span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="deploylib.mesos.ServiceScheduler" id="67942">scheduler</a> = <span title="deploylib.mesos.ServiceScheduler" class="keyword">new</span> <a href="ExperimentDaemon.scala.html#9589" title="deploylib.mesos.ServiceScheduler">ServiceScheduler</a><span class="delimiter">(</span>
      <a href="#67939" title="String">mesosMaster</a>,
      <a href="#67935" title="=&gt; java.lang.String">javaExecutorPath</a>
    <span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="67943">serviceSchedulerNode</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#67940" title="String">zooKeeperAddress</a><span class="delimiter">)</span>
    <a href="#67943" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="(d: Array[Byte])Unit">data</span> = <a href="#67942" title="deploylib.mesos.ServiceScheduler">scheduler</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</span>.<span title="=&gt; Array[Byte]">toBytes</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object deploylib.mesos.MesosCluster" id="9631">MesosCluster</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="comment">//HACK</span>
  <span class="keyword">var</span> <a title="Seq[java.io.File]" id="68311">jarFiles</a>: <span title="Seq[java.io.File]">Seq</span><span class="delimiter">[</span>java.io.File<span class="delimiter">]</span> = _
<span class="delimiter">}</span>

<span class="comment">/**
 * Functions to help maintain a mesos cluster on EC2.
 */</span>
<span class="keyword">class</span> <a title="class Cluster extends java.lang.Object with deploylib.config.ConfigurationActions with ScalaObject" id="9634">Cluster</a><a href="#9634" title="ScalaObject" class="delimiter">(</a><a title="Boolean" id="68395">useFT</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="../config/ConfigurationActions.scala.html#9516" title="deploylib.config.ConfigurationActions">ConfigurationActions</a> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.io.File" id="68318">rootDir</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/usr/local/mesos/frameworks/deploylib&quot;)" class="string">&quot;/usr/local/mesos/frameworks/deploylib&quot;</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="java.lang.String" id="68320">mesosAmi</a> =
    <span title="java.lang.String" class="keyword">if</span> <span class="delimiter">(</span><a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41688" title="=&gt; java.lang.String">endpoint</a> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;west&quot;)" class="string">&quot;west&quot;</span><span class="delimiter">)</span> <span title="java.lang.String(&quot;ami-2b6b386e&quot;)" class="string">&quot;ami-2b6b386e&quot;</span> <span class="keyword">else</span> <span title="java.lang.String(&quot;ami-2d60a144&quot;)" class="string">&quot;ami-2d60a144&quot;</span>

  <span class="keyword">val</span> <a title="java.lang.String" id="68322">defaultZone</a> =
    <span title="java.lang.String" class="keyword">if</span> <span class="delimiter">(</span><a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41688" title="=&gt; java.lang.String">endpoint</a> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;west&quot;)" class="string">&quot;west&quot;</span><span class="delimiter">)</span> <span title="java.lang.String(&quot;us-west-1a&quot;)" class="string">&quot;us-west-1a&quot;</span> <span class="keyword">else</span> <span title="java.lang.String(&quot;us-east-1b&quot;)" class="string">&quot;us-east-1b&quot;</span>

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68324">serviceSchedulerNode</a> = <a href="#68336" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68769">zooKeeperRoot</a>.<a href="#68769" title="Int" id="68771">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;serviceScheduler&quot;)" id="68770" class="string">&quot;serviceScheduler&quot;</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; deploylib.mesos.RemoteServiceScheduler" id="68325">serviceScheduler</a> = classOf<span title="java.lang.Class[deploylib.mesos.RemoteServiceScheduler](classOf[deploylib.mesos.RemoteServiceScheduler])" class="delimiter">[</span>RemoteServiceScheduler<span class="delimiter">]</span>.<span title="()deploylib.mesos.RemoteServiceScheduler">newInstance</span>.<span title="(data: Array[Byte])deploylib.mesos.RemoteServiceScheduler">parse</span><span class="delimiter">(</span><a href="#68324" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; String" id="68326">serviceSchedulerLog</a> = <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#25752" title="(remoteFile: java.io.File)String">catFile</a><span class="delimiter">(</span><a href="package.scala.html#9822" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File" class="string">&quot;/root/serviceScheduler.log&quot;</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()Unit" id="68327">stopAllInstances</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">(</span><a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a> <span title="(xs: scala.collection.GenTraversableOnce[deploylib.ec2.EC2Instance])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">++</span> <a href="#68332" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a> <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">++</a> <a href="#68334" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a><span class="delimiter">)</span>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#69443" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41726" title="=&gt; Unit">halt</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(numSlaves: Int)List[Any]" id="68328">setup</a><span class="delimiter">(</span><a title="Int" id="69447">numSlaves</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> = <span class="delimiter">(</span><a href="../Concurrent.scala.html#10049" title="(f: =&gt; Unit)deploylib.Future[Unit]">Future</a> <span class="delimiter">{</span><a href="#68330" title="(zone: String, numMasters: Int, mesosAmi: Option[String])Unit">setupMesosMaster</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span> <a href="#69448" title="(x: deploylib.Future[_ &gt;: Unit])List[deploylib.Future[_ &gt;: Unit]]">::</a>
                                   <a href="../Concurrent.scala.html#10049" title="(f: =&gt; Unit)deploylib.Future[Unit]">Future</a> <span class="delimiter">{</span><a href="#68337" title="(numServers: Int)Unit">setupZooKeeper</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span> <a href="#69465" title="(x: deploylib.Future[_ &gt;: Unit])List[deploylib.Future[_ &gt;: Unit]]">::</a>
                                   <a href="../Concurrent.scala.html#10049" title="(f: =&gt; Any)deploylib.Future[Any]">Future</a> <span class="delimiter">{</span><span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#68332" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#69447" title="Int">numSlaves</a><span class="delimiter">)</span> <a href="#68346" title="(count: Int, zone: String, ami: String, updateDeploylibOnStart: Boolean)Seq[deploylib.ec2.EC2Instance]">addSlaves</a><span class="delimiter">(</span><a href="#69447" title="Int">numSlaves</a> <span title="(x: Int)Int">-</span> <a href="#68332" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">}</span> <a href="#69474" title="(x: deploylib.Future[Any])List[deploylib.Future[Any]]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>.<span title="(f: deploylib.Future[_ &gt;: Unit] =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[List[deploylib.Future[_ &gt;: Unit]],Any,List[Any]])List[Any]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,Any,List[Any]]" class="delimiter">(</span><a href="../Concurrent.scala.html#10062" title="()Any">_</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
	
  <span class="keyword">def</span> <a title="(instances: Seq[deploylib.ec2.EC2Instance])Unit" id="68329">updateDeploylib</a><span class="delimiter">(</span><a title="Seq[deploylib.ec2.EC2Instance]" id="69671">instances</a>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">(</span><a href="#68332" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a> <span title="(xs: scala.collection.GenTraversableOnce[deploylib.ec2.EC2Instance])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">++</span> <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a><span class="delimiter">)</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">instances</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="69750">inst</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="String" id="69751">executorScript</a> = <a href="../Util.scala.html#9501" title="object deploylib.Util">Util</a>.<a href="../Util.scala.html#30729" title="(file: java.io.File)String">readFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib/src/main/resources/java_executor&quot;)" class="string">&quot;deploylib/src/main/resources/java_executor&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
        .<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
        .<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span> <a href="#70203" title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">{</a>
        <span class="keyword">case</span> <a title="java.lang.String" id="70204">s</a> <span class="keyword">if</span> <span class="delimiter">(</span><a href="#70204" title="java.lang.String">s</a> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;CLASSPATH=&quot;)" class="string">&quot;CLASSPATH=&quot;</span><span class="delimiter">)</span> =&gt; <span title="java.lang.String(&quot;CLASSPATH=\'-cp /usr/local/mesos/lib/java/mesos.jar:&quot;)" class="string">&quot;CLASSPATH='-cp /usr/local/mesos/lib/java/mesos.jar:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#69750" title="deploylib.ec2.EC2Instance">inst</a>.<a href="../ec2/ec2.scala.html#41738" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span class="delimiter">(</span><a href="#9631" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68311" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;:&quot;)" class="string">&quot;:&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;\'&quot;)" class="string">&quot;'&quot;</span>
        <span class="keyword">case</span> <a title="java.lang.String" id="70208">s</a> =&gt; <a href="#70208" title="java.lang.String">s</a>
      <span class="delimiter">}</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

      <a href="../config/ConfigurationActions.scala.html#38357" title="(target: deploylib.RemoteMachine, directory: java.io.File)java.io.File">createDirectory</a><span class="delimiter">(</span><a href="#69750" title="deploylib.ec2.EC2Instance">inst</a>, <a href="#68318" title="=&gt; java.io.File">rootDir</a><span class="delimiter">)</span>
      <a href="../config/ConfigurationActions.scala.html#38359" title="(target: deploylib.RemoteMachine, localFile: java.io.File, destination: java.io.File)java.io.File">uploadFile</a><span class="delimiter">(</span><a href="#69750" title="deploylib.ec2.EC2Instance">inst</a>, <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib/src/main/resources/config&quot;)" class="string">&quot;deploylib/src/main/resources/config&quot;</span><span class="delimiter">)</span>, <a href="#68318" title="=&gt; java.io.File">rootDir</a><span class="delimiter">)</span>
      <a href="../config/ConfigurationActions.scala.html#38358" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span title="Unit" class="delimiter">(</span><a href="#69750" title="deploylib.ec2.EC2Instance">inst</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#68318" title="=&gt; java.io.File">rootDir</a>, <span title="java.lang.String(&quot;java_executor&quot;)" class="string">&quot;java_executor&quot;</span><span class="delimiter">)</span>, <a href="#69751" title="String">executorScript</a>, <span title="java.lang.String(&quot;755&quot;)" class="string">&quot;755&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(zone: String, numMasters: Int, mesosAmi: Option[String])Unit" id="68330">setupMesosMaster</a><span class="delimiter">(</span><a title="String" id="69455">zone</a>: <span title="String">String</span> = <a href="#68322" title="=&gt; java.lang.String">defaultZone</a>, <a title="Int" id="69456">numMasters</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span>, <a title="Option[String]" id="69457">mesosAmi</a>: <span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#69456" title="Int">numMasters</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#69457" title="Option[String]">mesosAmi</a> <span title="Seq[deploylib.ec2.EC2Instance]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Seq[deploylib.ec2.EC2Instance]">Some</span><span class="delimiter">(</span><a title="String" id="70391">ami</a><span class="delimiter">)</span> =&gt; <a href="#68345" title="(zone: String, count: Int, ami: String)Seq[deploylib.ec2.EC2Instance]">startMasters</a><span class="delimiter">(</span><a href="#69455" title="String">zone</a>, <a href="#69456" title="Int">numMasters</a> <span title="(x: Int)Int">-</span> <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span>, <a href="#70391" title="String">ami</a><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Seq[deploylib.ec2.EC2Instance]">None</span> =&gt; <a href="#68345" title="(zone: String, count: Int, ami: String)Seq[deploylib.ec2.EC2Instance]">startMasters</a><span class="delimiter">(</span><a href="#69455" title="String">zone</a>, <a href="#69456" title="Int">numMasters</a> <span title="(x: Int)Int">-</span> <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70447" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#70473" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41738" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span title="Unit" class="delimiter">(</span><a href="#9631" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68311" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#68354" title="=&gt; Unit">updateMasterConf</a>

    <a href="#68334" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70504" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="#68334" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70534" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25757" title="(port: Int)Unit">blockTillPortOpen</a><span class="delimiter">(</span><span title="Int(2181)" class="int">2181</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#68342" title="()Unit">restartMasters</a>
    <a href="#68331" title="=&gt; Unit">restartServiceScheduler</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68331">restartServiceScheduler</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

    <a href="#68334" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70568" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#70594" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25745" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="70539">serviceSchedulerScript</a> = <span class="delimiter">(</span>
      <span class="string">&quot;#!/bin/bash\n&quot;</span> +
        <span class="string">&quot;/root/jrun -Dscads.comm.externalip=true deploylib.mesos.ServiceSchedulerDaemon &quot;</span> <span title="java.lang.String(&quot;#!/bin/bash\012/root/jrun -Dscads.comm.externalip=true deploylib.mesos.ServiceSchedulerDaemon --mesosMaster &quot;)">+</span>
        <span class="string">&quot;--mesosMaster &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68340" title="=&gt; String">clusterUrl</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
        <span title="java.lang.String(&quot;--zooKeeperAddress &quot;)" class="string">&quot;--zooKeeperAddress &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68324" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="=&gt; java.lang.String">canonicalAddress</span> <span title="(x$1: Any)java.lang.String">+</span>
        <span title="java.lang.String(&quot; &gt;&gt; /root/serviceScheduler.log 2&gt;&amp;1&quot;)" class="string">&quot; &gt;&gt; /root/serviceScheduler.log 2&gt;&amp;1&quot;</span><span class="delimiter">)</span>

    <span class="comment">// Start service scheduler on only the first master</span>
    <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#25747" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> java.io.<span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/root/serviceScheduler&quot;)" class="string">&quot;/root/serviceScheduler&quot;</span><span class="delimiter">)</span>, <a href="#70539" title="java.lang.String">serviceSchedulerScript</a><span class="delimiter">)</span>
    <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;chmod 755 /root/serviceScheduler&quot;)" class="string">&quot;chmod 755 /root/serviceScheduler&quot;</span>
    <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/serviceScheduler.pid --exec /root/serviceScheduler&quot;)" class="string">&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/serviceScheduler.pid --exec /root/serviceScheduler&quot;</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]" id="68332">slaves</a> = <span class="delimiter">{</span>
    <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41698" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41686" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#69270" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#69277" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#69284" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;slave&quot;)" class="string">&quot;slave&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; deploylib.ec2.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="69305">t</a> =&gt; <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41699" title="(instanceId: String)deploylib.ec2.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#69305" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: deploylib.ec2.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">filter</span><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="69340">i</a> =&gt; <span class="delimiter">(</span><a href="#69340" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41734" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#69340" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41734" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]" id="68333">masters</a> = <span class="delimiter">{</span>
    <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41698" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41686" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68971" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68978" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68985" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;master&quot;)" class="string">&quot;master&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; deploylib.ec2.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="69006">t</a> =&gt; <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41699" title="(instanceId: String)deploylib.ec2.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#69006" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: deploylib.ec2.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">filter</span><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="69041">i</a> =&gt; <span class="delimiter">(</span><a href="#69041" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41734" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#69041" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41734" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]" id="68334">zooKeepers</a> = <span class="delimiter">{</span>
    <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41698" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41686" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68600" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68607" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68614" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;zoo&quot;)" class="string">&quot;zoo&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; deploylib.ec2.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="68635">t</a> =&gt; <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41699" title="(instanceId: String)deploylib.ec2.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#68635" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: deploylib.ec2.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">filter</span><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="68690">i</a> =&gt; <span class="delimiter">(</span><a href="#68690" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41734" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#68690" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41734" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; String" id="68335">zooKeeperAddress</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;zk://%s/&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#68334" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance],java.lang.String,scala.collection.mutable.Buffer[java.lang.String]])scala.collection.mutable.Buffer[java.lang.String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,java.lang.String,scala.collection.mutable.Buffer[java.lang.String]]" class="delimiter">(</span><a href="#68712" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41729" title="=&gt; String">publicDnsName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:2181&quot;)" class="string">&quot;:2181&quot;</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68336">zooKeeperRoot</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#68335" title="=&gt; String">zooKeeperAddress</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(numServers: Int)Unit" id="68337">setupZooKeeper</a><span class="delimiter">(</span><a title="Int" id="69470">numServers</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Int" id="70603">missingServers</a> = <a href="#69470" title="Int">numServers</a> <span title="(x: Int)Int">-</span> <a href="#68334" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="=&gt; Int">size</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#70603" title="Int">missingServers</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[deploylib.ec2.EC2Instance]" id="70617">ret</a> = <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41704" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: String, userData: Option[String])Seq[deploylib.ec2.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#68320" title="=&gt; java.lang.String">mesosAmi</a>,
      <a href="#70603" title="Int">missingServers</a>,
      <a href="#70603" title="Int">missingServers</a>,
      <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41683" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#68322" title="=&gt; java.lang.String">defaultZone</a>,
      <span title="object None">None</span><span class="delimiter">)</span>

      <a href="#70617" title="Seq[deploylib.ec2.EC2Instance]">ret</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70798" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41723" title="object x$22.tags">tags</a> <a href="../ec2/ec2.scala.html#47475" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;zoo&quot;)" class="string">&quot;zoo&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#70617" title="Seq[deploylib.ec2.EC2Instance]">ret</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70809" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]" id="70604">servers</a> = <a href="#68334" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance],(deploylib.ec2.EC2Instance, Int),scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]])scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]">zipWithIndex</span>

    <span class="keyword">val</span> <a title="List[String]" id="70605">serverList</a> = <a href="#70604" title="scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]">servers</a>.<span title="(f: (deploylib.ec2.EC2Instance, Int) =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)],String,scala.collection.mutable.Buffer[String]])scala.collection.mutable.Buffer[String]">map</span> <a href="#70870" title="String" class="delimiter">{</a><span class="keyword">case</span> <span title="String" class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="70873">server</a>, <a title="Int" id="70874">id</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt; <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;server.%d=%s:3181:3182&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#70874" title="Int">id</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#70873" title="deploylib.ec2.EC2Instance">server</a>.<a href="../ec2/ec2.scala.html#41730" title="=&gt; String">privateDnsName</a><span class="delimiter">)</span><span class="delimiter">}</span>.<span title="=&gt; List[String]">toList</span>

    <span class="keyword">val</span> <a title="String" id="70606">cnf</a> =
      <span class="delimiter">(</span><span title="java.lang.String(&quot;dataDir=/mnt/zookeeper&quot;)" class="string">&quot;dataDir=/mnt/zookeeper&quot;</span> <a href="#70922" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;clientPort=2181&quot;)" class="string">&quot;clientPort=2181&quot;</span> <a href="#70923" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;tickTime=1000&quot;)" class="string">&quot;tickTime=1000&quot;</span> <a href="#70924" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;initLimit=60&quot;)" class="string">&quot;initLimit=60&quot;</span><a href="#70925" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;syncLimit=30&quot;)" class="string">&quot;syncLimit=30&quot;</span> <a href="#70926" title="(x: String)List[String]">::</a> 
       <span class="delimiter">(</span><span title="List[String]" class="keyword">if</span><span class="delimiter">(</span><a href="#70604" title="scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]">servers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <a href="#70605" title="List[String]">serverList</a> <span class="keyword">else</span> <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="String" id="70607">startScript</a> =
      <span class="delimiter">(</span><span title="java.lang.String(&quot;#!/bin/bash&quot;)" class="string">&quot;#!/bin/bash&quot;</span> <a href="#70961" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;/root/jrun org.apache.zookeeper.server.quorum.QuorumPeerMain /mnt/zookeeper.cnf&quot;)" class="string">&quot;/root/jrun org.apache.zookeeper.server.quorum.QuorumPeerMain /mnt/zookeeper.cnf&quot;</span> <a href="#70962" title="(x: java.lang.String)List[java.lang.String]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <a href="../package.scala.html#9830" title="(itr: Iterable[(deploylib.ec2.EC2Instance, Int)])deploylib.ParallelSeq[(deploylib.ec2.EC2Instance, Int)]">servers</a>.<a href="../Concurrent.scala.html#12250" title="(f: (deploylib.ec2.EC2Instance, Int) =&gt; Unit)Unit">pforeach</a> <a href="#71008" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71011">server</a>, <a title="Int" id="71012">id</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt;
        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;mkdir -p /mnt/zookeeper&quot;)" class="string">&quot;mkdir -p /mnt/zookeeper&quot;</span>
        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25747" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/zookeeper.cnf&quot;)" class="string">&quot;/mnt/zookeeper.cnf&quot;</span><span class="delimiter">)</span>, <a href="#70606" title="String">cnf</a><span class="delimiter">)</span>
        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25747" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/zookeeper/myid&quot;)" class="string">&quot;/mnt/zookeeper/myid&quot;</span><span class="delimiter">)</span>, <span class="delimiter">(</span><a href="#71012" title="Int">id</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>
        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25747" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/startZookeeper&quot;)" class="string">&quot;/mnt/startZookeeper&quot;</span><span class="delimiter">)</span>, <a href="#70607" title="String">startScript</a><span class="delimiter">)</span>
        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;chmod 755 /mnt/startZookeeper&quot;)" class="string">&quot;chmod 755 /mnt/startZookeeper&quot;</span>

        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a>.<a href="../ec2/ec2.scala.html#41738" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span class="delimiter">(</span><a href="#9631" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68311" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span>
        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25745" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span>
        <a href="#71011" title="deploylib.ec2.EC2Instance">server</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/zookeeper.pid --exec /mnt/startZookeeper&quot;)" class="string">&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/zookeeper.pid --exec /mnt/startZookeeper&quot;</span>
    <span class="delimiter">}</span>

    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="#70606" title="String">cnf</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; deploylib.ec2.EC2Instance" id="68338">firstMaster</a> = <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; deploylib.ec2.EC2Instance">head</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68339">updateMesos</a> =
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71061">s</a> =&gt;
      <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;rsync -e 'ssh -o StrictHostKeyChecking=no' -av /usr/local/mesos root@%s:/usr/local/mesos&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#71061" title="deploylib.ec2.EC2Instance">s</a>.<a href="../ec2/ec2.scala.html#41729" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; String" id="68340">clusterUrl</a>: <span title="String">String</span> =
    <span title="String" class="keyword">if</span><span class="delimiter">(</span><a href="#68395" title="Boolean">useFT</a><span class="delimiter">)</span>
      <span title="java.lang.String(&quot;zoo://&quot;)" class="string">&quot;zoo://&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68336" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">zooKeeperRoot</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy">proxy</span>.<span title="=&gt; Seq[String]">servers</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68336" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="71068">zooKeeperRoot</a>.<a href="#71068" title="Int" id="71070">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;mesos&quot;)" id="71069" class="string">&quot;mesos&quot;</a><span class="delimiter">)</span>.<span title="=&gt; String">path</span>
    <span class="keyword">else</span>
      <span title="java.lang.String(&quot;master@&quot;)" class="string">&quot;master@&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../ec2/ec2.scala.html#41729" title="=&gt; String">publicDnsName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:5050&quot;)" class="string">&quot;:5050&quot;</span>

  <span class="keyword">def</span> <a title="()Unit" id="68341">restartSlaves</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71096">i</a> =&gt; <span class="delimiter">{</span><a href="#71096" title="deploylib.ec2.EC2Instance">i</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-slave stop&quot;)" class="string">&quot;service mesos-slave stop&quot;</span>; <a href="#71096" title="deploylib.ec2.EC2Instance">i</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-slave start&quot;)" class="string">&quot;service mesos-slave start&quot;</span><span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="68342">restartMasters</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span>
      <a title="deploylib.ec2.EC2Instance" id="71125">master</a> =&gt;
        <a href="#71125" title="deploylib.ec2.EC2Instance">master</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-master stop&quot;)" class="string">&quot;service mesos-master stop&quot;</span>
        <a href="#71125" title="deploylib.ec2.EC2Instance">master</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-master start&quot;)" class="string">&quot;service mesos-master start&quot;</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="68343">restart</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#68342" title="()Unit">restartMasters</a>
    <a href="#68341" title="()Unit">restartSlaves</a>
    <a href="#68331" title="=&gt; Unit">restartServiceScheduler</a>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#71152" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25745" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68344">updateSlavesFile</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.File" id="71157">location</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/root/mesos-ec2/slaves&quot;)" class="string">&quot;/root/mesos-ec2/slaves&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="71158">contents</a> = <a href="#68332" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance],String,scala.collection.mutable.Buffer[String]])scala.collection.mutable.Buffer[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,String,scala.collection.mutable.Buffer[String]]" class="delimiter">(</span><a href="#71182" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41730" title="=&gt; String">privateDnsName</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a> <span class="delimiter">{</span>
      <a title="deploylib.ec2.EC2Instance" id="71235">master</a> =&gt;
        <a href="#71235" title="deploylib.ec2.EC2Instance">master</a>.<a href="../RemoteMachine.scala.html#25754" title="(remoteDir: java.io.File)Unit">mkdir</a><span class="delimiter">(</span><a href="package.scala.html#9822" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File" class="string">&quot;/root/mesos-ec2&quot;</a><span class="delimiter">)</span>
        <a href="../config/ConfigurationActions.scala.html#38358" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span title="Unit" class="delimiter">(</span><a href="#71235" title="deploylib.ec2.EC2Instance">master</a>, <a href="#71157" title="java.io.File">location</a>, <a href="#71158" title="String">contents</a>, <span title="java.lang.String(&quot;644&quot;)" class="string">&quot;644&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(zone: String, count: Int, ami: String)Seq[deploylib.ec2.EC2Instance]" id="68345">startMasters</a><span class="delimiter">(</span><a title="String" id="70396">zone</a>: <span title="String">String</span> = <a href="#68322" title="=&gt; java.lang.String">defaultZone</a>, <a title="Int" id="70397">count</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span>, <a title="String" id="70398">ami</a>: <span title="String">String</span> = <a href="#68320" title="=&gt; java.lang.String">mesosAmi</a><span class="delimiter">)</span>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[deploylib.ec2.EC2Instance]" id="71236">ret</a> = <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41704" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: String, userData: Option[String])Seq[deploylib.ec2.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#70398" title="String">ami</a>,
      <a href="#70397" title="Int">count</a>,
      <a href="#70397" title="Int">count</a>,
      <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41683" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#70396" title="String">zone</a>,
      <span title="object None">None</span><span class="delimiter">)</span>

    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">ret</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71263">i</a> =&gt; <span class="delimiter">{</span>
      <a href="#71263" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41723" title="object i.tags">tags</a> <a href="../ec2/ec2.scala.html#47475" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;master&quot;)" class="string">&quot;master&quot;</span><span class="delimiter">)</span>
      <a href="#71263" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a>
      <a href="#68353" title="(instances: Seq[deploylib.ec2.EC2Instance])Unit">updateConf</a><span class="delimiter">(</span><a href="#71263" title="deploylib.ec2.EC2Instance">i</a> <a href="#71267" title="(x: deploylib.ec2.EC2Instance)List[deploylib.ec2.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <a href="#68342" title="()Unit">restartMasters</a>
    <a href="#71236" title="Seq[deploylib.ec2.EC2Instance]">ret</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(count: Int, zone: String, ami: String, updateDeploylibOnStart: Boolean)Seq[deploylib.ec2.EC2Instance]" id="68346">addSlaves</a><span class="delimiter">(</span><a title="Int" id="69485">count</a>: <span title="Int">Int</span>, <a title="String" id="69490">zone</a>: <span title="String">String</span> = <a href="#68322" title="=&gt; java.lang.String">defaultZone</a>, <a title="String" id="69491">ami</a>: <span title="String">String</span> = <a href="#68320" title="=&gt; java.lang.String">mesosAmi</a>, <a title="Boolean" id="69492">updateDeploylibOnStart</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[java.lang.String]" id="71273">userData</a> =
      <span title="Option[java.lang.String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#69492" title="Boolean">updateDeploylibOnStart</a><span class="delimiter">)</span>
        <span title="object None">None</span>
      <span class="keyword">else</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
	      <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#71303" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
          <span title="(x: java.lang.String)Some[java.lang.String]">Some</span><span class="delimiter">(</span><span title="java.lang.String(&quot;url=&quot;)" class="string">&quot;url=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68340" title="=&gt; String">clusterUrl</a><span class="delimiter">)</span> 
		<span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="None.type" id="71308">noMaster</a>: java.util.<span title="java.util.NoSuchElementException">NoSuchElementException</span> =&gt;
            <a href="../config/ConfigurationActions.scala.html#38355" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No master found. Starting without userdata&quot;)" class="string">&quot;No master found. Starting without userdata&quot;</span><span class="delimiter">)</span>
            <span title="object None">None</span>
        <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Seq[deploylib.ec2.EC2Instance]" id="71274">instances</a> = <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41704" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: String, userData: Option[String])Seq[deploylib.ec2.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#69491" title="String">ami</a>,
      <a href="#69485" title="Int">count</a>,
      <a href="#69485" title="Int">count</a>,
      <a href="../ec2/ec2.scala.html#9540" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41683" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#69490" title="String">zone</a>,
      <a href="#71273" title="Option[java.lang.String]">userData</a><span class="delimiter">)</span>
	<a href="#71274" title="Seq[deploylib.ec2.EC2Instance]">instances</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#71343" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41723" title="object x$35.tags">tags</a> <a href="../ec2/ec2.scala.html#47475" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;slave&quot;)" class="string">&quot;slave&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#69492" title="Boolean">updateDeploylibOnStart</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">//Hack to avoid race condition where there are no masters yet because they haven't been tagged.</span>
      <a href="#71274" title="Seq[deploylib.ec2.EC2Instance]">instances</a>.<span title="=&gt; deploylib.ec2.EC2Instance">head</span>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a>
      <a href="#68333" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#71373" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
      <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#25757" title="(port: Int)Unit">blockTillPortOpen</a><span class="delimiter">(</span><span title="Int(5050)" class="int">5050</span><span class="delimiter">)</span>

      <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">instances</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71399">i</a> =&gt; <span class="keyword">try</span> <span class="delimiter">{</span>
        <a href="#71399" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41739" title="()Unit">blockUntilRunning</a>
        <a href="#68329" title="(instances: Seq[deploylib.ec2.EC2Instance])Unit">updateDeploylib</a><span class="delimiter">(</span><a href="#71399" title="deploylib.ec2.EC2Instance">i</a> <a href="#71400" title="(x: deploylib.ec2.EC2Instance)List[deploylib.ec2.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
        <a href="#68353" title="(instances: Seq[deploylib.ec2.EC2Instance])Unit">updateConf</a><span class="delimiter">(</span><a href="#71399" title="deploylib.ec2.EC2Instance">i</a> <a href="#71404" title="(x: deploylib.ec2.EC2Instance)List[deploylib.ec2.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
        <a href="#71399" title="deploylib.ec2.EC2Instance">i</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-slave restart&quot;)" class="string">&quot;service mesos-slave restart&quot;</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="71408">e</a> =&gt; <a href="../config/ConfigurationActions.scala.html#38355" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(thrown: Throwable, msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><a href="#71408" title="java.lang.Throwable">e</a>, <span title="java.lang.String(&quot;Failed to start slave on instance %s:%s&quot;)" class="string">&quot;Failed to start slave on instance %s:%s&quot;</span>, <a href="#71399" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41706" title="=&gt; String">instanceId</a>, <a href="#71399" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41729" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#71274" title="Seq[deploylib.ec2.EC2Instance]">instances</a>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="List[java.lang.String]" id="68347">baseConf</a> = <span class="delimiter">(</span>
      <span title="java.lang.String(&quot;webui_port=8080&quot;)" class="string">&quot;webui_port=8080&quot;</span> <a href="#68365" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;work_dir=/mnt&quot;)" class="string">&quot;work_dir=/mnt&quot;</span> <a href="#68366" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;log_dir=/mnt&quot;)" class="string">&quot;log_dir=/mnt&quot;</span> <a href="#68367" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;switch_user=0&quot;)" class="string">&quot;switch_user=0&quot;</span> <a href="#68368" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;shares_interval=30&quot;)" class="string">&quot;shares_interval=30&quot;</span> <a href="#68369" title="(x: java.lang.String)List[java.lang.String]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; List[java.lang.String]" id="68349">confWithUrl</a> = <span class="delimiter">(</span><span title="java.lang.String(&quot;master=&quot;)" class="string">&quot;master=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68340" title="=&gt; String">clusterUrl</a><span class="delimiter">)</span> <a href="#71416" title="(x: java.lang.String)List[java.lang.String]">::</a> <a href="#68347" title="=&gt; List[java.lang.String]">baseConf</a>
  <span class="keyword">def</span> <a title="(instance: deploylib.ec2.EC2Instance)String" id="68350">slaveConf</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71422">instance</a>: <a href="../ec2/ec2.scala.html#9542" title="deploylib.ec2.EC2Instance">EC2Instance</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><span title="java.lang.String(&quot;mem=&quot;)" class="string">&quot;mem=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#71422" title="deploylib.ec2.EC2Instance">instance</a>.<a href="../RemoteMachine.scala.html#25777" title="=&gt; instance.FreeStats">free</a>.<a href="../RemoteMachine.scala.html#35437" title="=&gt; Int">total</a> <span title="(x: Int)Int">-</span> <span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#71425" title="(x: java.lang.String)List[java.lang.String]">::</a>
					  <a href="#68349" title="=&gt; List[java.lang.String]">confWithUrl</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="java.io.File" id="68351">conffile</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/usr/local/mesos/conf/mesos.conf&quot;)" class="string">&quot;/usr/local/mesos/conf/mesos.conf&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(instances: Seq[deploylib.ec2.EC2Instance])Unit" id="68353">updateConf</a><span class="delimiter">(</span><a title="Seq[deploylib.ec2.EC2Instance]" id="71266">instances</a>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <a href="#68332" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">instances</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71462">i</a> =&gt; <a href="#71462" title="deploylib.ec2.EC2Instance">i</a>.<a href="../RemoteMachine.scala.html#25747" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><a href="#68351" title="=&gt; java.io.File">conffile</a>, <a href="#68350" title="(instance: deploylib.ec2.EC2Instance)String">slaveConf</a><span class="delimiter">(</span><a href="#71462" title="deploylib.ec2.EC2Instance">i</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68354">updateMasterConf</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="71463">masterConf</a> =
      <span title="String" class="keyword">if</span><span class="delimiter">(</span><a href="#68395" title="Boolean">useFT</a><span class="delimiter">)</span>
        <a href="#68349" title="=&gt; List[java.lang.String]">confWithUrl</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
      <span class="keyword">else</span>
        <a href="#68347" title="=&gt; List[java.lang.String]">baseConf</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#71493" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25747" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><a href="#68351" title="=&gt; java.io.File">conffile</a>, <a href="#71463" title="String">masterConf</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">//TODO: Doesn't handle non s3 cached jars</span>
  <span class="keyword">def</span> <a title="=&gt; Seq[edu.berkeley.cs.scads.comm.S3CachedJar]" id="68355">classSource</a>: <span title="Seq[edu.berkeley.cs.scads.comm.S3CachedJar]">Seq</span><span class="delimiter">[</span>S3CachedJar<span class="delimiter">]</span> =
    <span title="Seq[edu.berkeley.cs.scads.comm.S3CachedJar]" class="keyword">if</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib.classSource&quot;)" class="string">&quot;deploylib.classSource&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#68356" title="=&gt; Seq[String]">pushJars</a>.<span title="(f: String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],java.lang.String,Seq[java.lang.String]])Seq[java.lang.String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,java.lang.String,Seq[java.lang.String]]" class="delimiter">(</span><a href="package.scala.html#9822" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File">_</a>.<span title="()java.lang.String">getName</span><span class="delimiter">)</span>
        .<span title="(f: java.lang.String =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.lang.String],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="../ec2/s3cache.scala.html#9553" title="object deploylib.ec2.S3Cache">S3Cache</a>.<a href="../ec2/s3cache.scala.html#48483" title="(fileMd5: String)String">hashToUrl</a><span class="delimiter">)</span>
        .<span title="(f: String =&gt; edu.berkeley.cs.scads.comm.S3CachedJar)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],edu.berkeley.cs.scads.comm.S3CachedJar,Seq[edu.berkeley.cs.scads.comm.S3CachedJar]])Seq[edu.berkeley.cs.scads.comm.S3CachedJar]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.S3CachedJar,Seq[edu.berkeley.cs.scads.comm.S3CachedJar]]" class="delimiter">(</span><span title="edu.berkeley.cs.scads.comm.S3CachedJar" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.S3CachedJar">S3CachedJar</span><span class="delimiter">(</span><a href="#71614" title="String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib.classSource&quot;)" class="string">&quot;deploylib.classSource&quot;</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;\\|&quot;)" class="string">&quot;\\|&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; edu.berkeley.cs.scads.comm.S3CachedJar)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],edu.berkeley.cs.scads.comm.S3CachedJar,Seq[edu.berkeley.cs.scads.comm.S3CachedJar]])Seq[edu.berkeley.cs.scads.comm.S3CachedJar]">map</span><span title="(implicit m: DummyImplicit)scala.collection.generic.CanBuildFrom[Array[_],edu.berkeley.cs.scads.comm.S3CachedJar,scala.collection.mutable.ArraySeq[edu.berkeley.cs.scads.comm.S3CachedJar]]" class="delimiter">(</span><span title="(url: String)edu.berkeley.cs.scads.comm.S3CachedJar">S3CachedJar</span><span class="delimiter">(</span><a href="#72086" title="java.lang.String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">//TODO fix me.</span>
  <span class="keyword">def</span> <a title="=&gt; Seq[String]" id="68356">pushJars</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[java.io.File]" id="72111">jars</a> = <a href="#9631" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68311" title="=&gt; Seq[java.io.File]">jarFiles</a>
    <span class="keyword">val</span> <a href="#72113" title="(Seq[java.io.File], Seq[java.io.File])" class="delimiter">(</a><a href="#72112" title="Seq[java.io.File]" id="72113">deploylib</a>, <a href="#72112" title="Seq[java.io.File]" id="72114">otherJars</a><span class="delimiter">)</span> = <a href="#72111" title="Seq[java.io.File]">jars</a>.<span title="(p: java.io.File =&gt; Boolean)(Seq[java.io.File], Seq[java.io.File])">partition</span><span title="(Seq[java.io.File], Seq[java.io.File]) @unchecked" class="delimiter">(</span><a href="#72119" title="java.io.File">_</a>.<span title="()java.lang.String">getName</span> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;deploylib&quot;)" class="string">&quot;deploylib&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[java.io.File]" id="72115">sortedJars</a> = <a href="#72113" title="Seq[java.io.File]">deploylib</a> <span title="(that: scala.collection.GenTraversableOnce[java.io.File])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.io.File],java.io.File,Seq[java.io.File]])Seq[java.io.File]">++</span> <a href="#72114" title="Seq[java.io.File]">otherJars</a>

    <a href="../config/ConfigurationActions.scala.html#38355" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Starting Jar upload&quot;)" class="string">&quot;Starting Jar upload&quot;</span><span class="delimiter">)</span>
    <a href="#72115" title="Seq[java.io.File]">sortedJars</a>.<span title="(f: java.io.File =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.io.File],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="../ec2/s3cache.scala.html#9553" title="object deploylib.ec2.S3Cache">S3Cache</a>.<a href="../ec2/s3cache.scala.html#48484" title="(file: java.io.File)String">getCacheUrl</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Create a public key on the master if it doesn't exist
   * Then add that to the authorized key file all of slaves
   * TODO: Dedup keys
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="68357">authorizeMaster</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="72207">getKeyCommand</a> = <span title="java.lang.String(&quot;cat /root/.ssh/id_rsa.pub&quot;)" class="string">&quot;cat /root/.ssh/id_rsa.pub&quot;</span>
    <span class="keyword">val</span> <a title="String" id="72208">key</a> = <span class="keyword">try</span> <span class="delimiter">(</span><a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25744" title="(cmd: String)String">!?</a> <a href="#72207" title="java.lang.String">getKeyCommand</a><span class="delimiter">)</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="String" id="72209">u</a>: <a href="../RemoteMachine.scala.html#9483" title="deploylib.UnknownResponse">UnknownResponse</a> =&gt; <span class="delimiter">{</span>
        <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25743" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;ssh-keygen -t rsa -f /root/.ssh/id_rsa -N \&quot;\&quot;&quot;)" class="string">&quot;ssh-keygen -t rsa -f /root/.ssh/id_rsa -N \&quot;\&quot;&quot;</span>
        <a href="#68338" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25744" title="(cmd: String)String">!?</a> <a href="#72207" title="java.lang.String">getKeyCommand</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12250" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#72234" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25748" title="(file: java.io.File, contents: String)Unit">appendFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/root/.ssh/authorized_keys&quot;)" class="string">&quot;/root/.ssh/authorized_keys&quot;</span><span class="delimiter">)</span>, <a href="#72208" title="String">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">//HACK to work around still broken webui</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="68358">tailSlaveLogs</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.File" id="72241">workDir</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/work&quot;)" class="string">&quot;/mnt/work&quot;</span><span class="delimiter">)</span>
    <a href="../package.scala.html#9830" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12244" title="(f: deploylib.ec2.EC2Instance =&gt; (deploylib.ec2.EC2Instance, java.io.File))List[(deploylib.ec2.EC2Instance, java.io.File)]">pmap</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="72275">s</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.File" id="72276">currentSlaveDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#72241" title="java.io.File">workDir</a>, <a href="#72275" title="deploylib.ec2.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#25763" title="(dir: java.io.File)Seq[s.RemoteFile]">ls</a><span class="delimiter">(</span><a href="#72241" title="java.io.File">workDir</a><span class="delimiter">)</span>.<span title="(f: s.RemoteFile =&gt; String)(implicit ord: scala.math.Ordering[String])Seq[s.RemoteFile]">sortBy</span><span title="object scala.math.Ordering.String" class="delimiter">(</span><a href="#72585" title="s.RemoteFile">_</a>.<a href="../RemoteMachine.scala.html#31315" title="=&gt; String">modDate</a><span class="delimiter">)</span>.<span title="=&gt; s.RemoteFile">last</span>.<a href="../RemoteMachine.scala.html#31309" title="=&gt; String">name</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.io.File" id="72277">currentFrameworkDir</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#72276" title="java.io.File">currentSlaveDir</a>, <a href="#72275" title="deploylib.ec2.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#25763" title="(dir: java.io.File)Seq[s.RemoteFile]">ls</a><span class="delimiter">(</span><a href="#72276" title="java.io.File">currentSlaveDir</a><span class="delimiter">)</span>.<span title="=&gt; s.RemoteFile">head</span>.<a href="../RemoteMachine.scala.html#31309" title="=&gt; String">name</a><span class="delimiter">)</span>
      <span title="(_1: deploylib.ec2.EC2Instance, _2: java.io.File)(deploylib.ec2.EC2Instance, java.io.File)" class="delimiter">(</span><a href="#72275" title="deploylib.ec2.EC2Instance">s</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#72277" title="java.io.File">currentFrameworkDir</a>, <span title="java.lang.String(&quot;0/stdout&quot;)" class="string">&quot;0/stdout&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(f: (deploylib.ec2.EC2Instance, java.io.File) =&gt; Unit)Unit">foreach</span> <a href="#73596" title="Unit" class="delimiter">{</a><span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="73599">s</a>,<a title="java.io.File" id="73600">l</a><span class="delimiter">)</span> =&gt; <a href="#73599" title="deploylib.ec2.EC2Instance">s</a>.<a href="../RemoteMachine.scala.html#25755" title="(remoteFile: java.io.File)Unit">watch</a><span class="delimiter">(</span><a href="#73600" title="java.io.File">l</a><span class="delimiter">)</span><span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>