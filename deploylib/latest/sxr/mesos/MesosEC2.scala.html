<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>mesos/MesosEC2.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> deploylib
<span class="keyword">package</span> mesos

<span class="keyword">import</span> ec2._
<span class="keyword">import</span> config._

<span class="keyword">import</span> edu.berkeley.cs.scads.comm._

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> java.net.InetAddress
<span class="keyword">import</span> collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> com.amazonaws.services.ec2.model._

<span class="keyword">object</span> <a title="object deploylib.mesos.ServiceSchedulerDaemon" id="9631">ServiceSchedulerDaemon</a> <span title="ScalaObject" class="keyword">extends</span> optional.<span title="optional.Application">Application</span> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="67929">javaExecutorPath</a> = <span title="java.lang.String(&quot;/usr/local/mesos/frameworks/deploylib/java_executor&quot;)" class="string">&quot;/usr/local/mesos/frameworks/deploylib/java_executor&quot;</span>

  <span class="keyword">def</span> <a title="(mesosMaster: String, zooKeeperAddress: String)Unit" id="67931">main</a><span class="delimiter">(</span><a title="String" id="67933">mesosMaster</a>: <span title="String">String</span>, <a title="String" id="67934">zooKeeperAddress</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)Unit">loadLibrary</span><span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="deploylib.mesos.ServiceScheduler" id="67936">scheduler</a> = <span title="deploylib.mesos.ServiceScheduler" class="keyword">new</span> <a href="ExperimentDaemon.scala.html#9591" title="deploylib.mesos.ServiceScheduler">ServiceScheduler</a><span class="delimiter">(</span>
      <a href="#67933" title="String">mesosMaster</a>,
      <a href="#67929" title="=&gt; java.lang.String">javaExecutorPath</a>
    <span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="67937">serviceSchedulerNode</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#67934" title="String">zooKeeperAddress</a><span class="delimiter">)</span>
    <a href="#67937" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="(d: Array[Byte])Unit">data</span> = <a href="#67936" title="deploylib.mesos.ServiceScheduler">scheduler</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.RemoteActor">remoteHandle</span>.<span title="=&gt; Array[Byte]">toBytes</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object deploylib.mesos.MesosCluster" id="9633">MesosCluster</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="comment">//HACK</span>
  <span class="keyword">var</span> <a title="Seq[java.io.File]" id="68305">jarFiles</a>: <span title="Seq[java.io.File]">Seq</span><span class="delimiter">[</span>java.io.File<span class="delimiter">]</span> = _
<span class="delimiter">}</span>

<span class="comment">/**
 * Functions to help maintain a mesos cluster on EC2.
 */</span>
<span class="keyword">class</span> <a title="class Cluster extends java.lang.Object with deploylib.config.ConfigurationActions with ScalaObject" id="9636">Cluster</a><a href="#9636" title="ScalaObject" class="delimiter">(</a><a title="Boolean" id="68388">useFT</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="../config/ConfigurationActions.scala.html#9522" title="deploylib.config.ConfigurationActions">ConfigurationActions</a> <span class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.io.File" id="68312">rootDir</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/usr/local/mesos/frameworks/deploylib&quot;)" class="string">&quot;/usr/local/mesos/frameworks/deploylib&quot;</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="java.lang.String" id="68314">mesosAmi</a> =
    <span title="java.lang.String" class="keyword">if</span> <span class="delimiter">(</span><a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41686" title="=&gt; java.lang.String">endpoint</a> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;west&quot;)" class="string">&quot;west&quot;</span><span class="delimiter">)</span> <span title="java.lang.String(&quot;ami-2b6b386e&quot;)" class="string">&quot;ami-2b6b386e&quot;</span> <span class="keyword">else</span> <span title="java.lang.String(&quot;ami-2d60a144&quot;)" class="string">&quot;ami-2d60a144&quot;</span>

  <span class="keyword">val</span> <a title="java.lang.String" id="68316">defaultZone</a> =
    <span title="java.lang.String" class="keyword">if</span> <span class="delimiter">(</span><a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41686" title="=&gt; java.lang.String">endpoint</a> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;west&quot;)" class="string">&quot;west&quot;</span><span class="delimiter">)</span> <span title="java.lang.String(&quot;us-west-1a&quot;)" class="string">&quot;us-west-1a&quot;</span> <span class="keyword">else</span> <span title="java.lang.String(&quot;us-east-1b&quot;)" class="string">&quot;us-east-1b&quot;</span>

  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68318">serviceSchedulerNode</a> = <a href="#68330" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68762">zooKeeperRoot</a>.<a href="#68762" title="Int" id="68764">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;serviceScheduler&quot;)" id="68763" class="string">&quot;serviceScheduler&quot;</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; deploylib.mesos.RemoteServiceScheduler" id="68319">serviceScheduler</a> = classOf<span title="java.lang.Class[deploylib.mesos.RemoteServiceScheduler](classOf[deploylib.mesos.RemoteServiceScheduler])" class="delimiter">[</span>RemoteServiceScheduler<span class="delimiter">]</span>.<span title="()deploylib.mesos.RemoteServiceScheduler">newInstance</span>.<span title="(data: Array[Byte])deploylib.mesos.RemoteServiceScheduler">parse</span><span class="delimiter">(</span><a href="#68318" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="=&gt; Array[Byte]">data</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; String" id="68320">serviceSchedulerLog</a> = <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#25750" title="(remoteFile: java.io.File)String">catFile</a><span class="delimiter">(</span><a href="package.scala.html#9820" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File" class="string">&quot;/root/serviceScheduler.log&quot;</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()Unit" id="68321">stopAllInstances</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">(</span><a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a> <span title="(xs: scala.collection.GenTraversableOnce[deploylib.ec2.EC2Instance])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">++</span> <a href="#68326" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a> <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">++</a> <a href="#68328" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a><span class="delimiter">)</span>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#69436" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41724" title="=&gt; Unit">halt</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(numSlaves: Int)List[Any]" id="68322">setup</a><span class="delimiter">(</span><a title="Int" id="69440">numSlaves</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> = <span class="delimiter">(</span><a href="../Concurrent.scala.html#10047" title="(f: =&gt; Unit)deploylib.Future[Unit]">Future</a> <span class="delimiter">{</span><a href="#68324" title="(zone: String, numMasters: Int, mesosAmi: Option[String])Unit">setupMesosMaster</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span> <a href="#69441" title="(x: deploylib.Future[_ &gt;: Unit])List[deploylib.Future[_ &gt;: Unit]]">::</a>
                                   <a href="../Concurrent.scala.html#10047" title="(f: =&gt; Unit)deploylib.Future[Unit]">Future</a> <span class="delimiter">{</span><a href="#68331" title="(numServers: Int)Unit">setupZooKeeper</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">}</span> <a href="#69458" title="(x: deploylib.Future[_ &gt;: Unit])List[deploylib.Future[_ &gt;: Unit]]">::</a>
                                   <a href="../Concurrent.scala.html#10047" title="(f: =&gt; Any)deploylib.Future[Any]">Future</a> <span class="delimiter">{</span><span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#68326" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#69440" title="Int">numSlaves</a><span class="delimiter">)</span> <a href="#68340" title="(count: Int, zone: String, ami: String, updateDeploylibOnStart: Boolean)Seq[deploylib.ec2.EC2Instance]">addSlaves</a><span class="delimiter">(</span><a href="#69440" title="Int">numSlaves</a> <span title="(x: Int)Int">-</span> <a href="#68326" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">}</span> <a href="#69467" title="(x: deploylib.Future[Any])List[deploylib.Future[Any]]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>.<span title="(f: deploylib.Future[_ &gt;: Unit] =&gt; Any)(implicit bf: scala.collection.generic.CanBuildFrom[List[deploylib.Future[_ &gt;: Unit]],Any,List[Any]])List[Any]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,Any,List[Any]]" class="delimiter">(</span><a href="../Concurrent.scala.html#10060" title="()Any">_</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
	
  <span class="keyword">def</span> <a title="(instances: Seq[deploylib.ec2.EC2Instance])Unit" id="68323">updateDeploylib</a><span class="delimiter">(</span><a title="Seq[deploylib.ec2.EC2Instance]" id="69664">instances</a>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <a href="#68326" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">instances</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="69691">inst</a> =&gt; <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="String" id="69692">executorScript</a> = <a href="../Util.scala.html#9509" title="object deploylib.Util">Util</a>.<a href="../Util.scala.html#30727" title="(file: java.io.File)String">readFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib/src/main/resources/java_executor&quot;)" class="string">&quot;deploylib/src/main/resources/java_executor&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
        .<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
        .<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span> <a href="#70144" title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">{</a>
        <span class="keyword">case</span> <a title="java.lang.String" id="70145">s</a> <span class="keyword">if</span> <span class="delimiter">(</span><a href="#70145" title="java.lang.String">s</a> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;CLASSPATH=&quot;)" class="string">&quot;CLASSPATH=&quot;</span><span class="delimiter">)</span> =&gt; <span title="java.lang.String(&quot;CLASSPATH=\'-cp /usr/local/mesos/lib/java/mesos.jar:&quot;)" class="string">&quot;CLASSPATH='-cp /usr/local/mesos/lib/java/mesos.jar:&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#69691" title="deploylib.ec2.EC2Instance">inst</a>.<a href="../ec2/ec2.scala.html#41736" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span class="delimiter">(</span><a href="#9633" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68305" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;:&quot;)" class="string">&quot;:&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;\'&quot;)" class="string">&quot;'&quot;</span>
        <span class="keyword">case</span> <a title="java.lang.String" id="70149">s</a> =&gt; <a href="#70149" title="java.lang.String">s</a>
      <span class="delimiter">}</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

      <a href="../config/ConfigurationActions.scala.html#38355" title="(target: deploylib.RemoteMachine, directory: java.io.File)java.io.File">createDirectory</a><span class="delimiter">(</span><a href="#69691" title="deploylib.ec2.EC2Instance">inst</a>, <a href="#68312" title="=&gt; java.io.File">rootDir</a><span class="delimiter">)</span>
      <a href="../config/ConfigurationActions.scala.html#38357" title="(target: deploylib.RemoteMachine, localFile: java.io.File, destination: java.io.File)java.io.File">uploadFile</a><span class="delimiter">(</span><a href="#69691" title="deploylib.ec2.EC2Instance">inst</a>, <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib/src/main/resources/config&quot;)" class="string">&quot;deploylib/src/main/resources/config&quot;</span><span class="delimiter">)</span>, <a href="#68312" title="=&gt; java.io.File">rootDir</a><span class="delimiter">)</span>
      <a href="../config/ConfigurationActions.scala.html#38356" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span title="Unit" class="delimiter">(</span><a href="#69691" title="deploylib.ec2.EC2Instance">inst</a>, <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#68312" title="=&gt; java.io.File">rootDir</a>, <span title="java.lang.String(&quot;java_executor&quot;)" class="string">&quot;java_executor&quot;</span><span class="delimiter">)</span>, <a href="#69692" title="String">executorScript</a>, <span title="java.lang.String(&quot;755&quot;)" class="string">&quot;755&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(zone: String, numMasters: Int, mesosAmi: Option[String])Unit" id="68324">setupMesosMaster</a><span class="delimiter">(</span><a title="String" id="69448">zone</a>: <span title="String">String</span> = <a href="#68316" title="=&gt; java.lang.String">defaultZone</a>, <a title="Int" id="69449">numMasters</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span>, <a title="Option[String]" id="69450">mesosAmi</a>: <span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span title="object None">None</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;</span> <a href="#69449" title="Int">numMasters</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#69450" title="Option[String]">mesosAmi</a> <span title="Seq[deploylib.ec2.EC2Instance]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Seq[deploylib.ec2.EC2Instance]">Some</span><span class="delimiter">(</span><a title="String" id="70332">ami</a><span class="delimiter">)</span> =&gt; <a href="#68339" title="(zone: String, count: Int, ami: String)Seq[deploylib.ec2.EC2Instance]">startMasters</a><span class="delimiter">(</span><a href="#69448" title="String">zone</a>, <a href="#69449" title="Int">numMasters</a> <span title="(x: Int)Int">-</span> <a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span>, <a href="#70332" title="String">ami</a><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Seq[deploylib.ec2.EC2Instance]">None</span> =&gt; <a href="#68339" title="(zone: String, count: Int, ami: String)Seq[deploylib.ec2.EC2Instance]">startMasters</a><span class="delimiter">(</span><a href="#69448" title="String">zone</a>, <a href="#69449" title="Int">numMasters</a> <span title="(x: Int)Int">-</span> <a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70388" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#70414" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41736" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span title="Unit" class="delimiter">(</span><a href="#9633" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68305" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#68348" title="=&gt; Unit">updateMasterConf</a>

    <a href="#68328" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70445" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="#68328" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70475" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25755" title="(port: Int)Unit">blockTillPortOpen</a><span class="delimiter">(</span><span title="Int(2181)" class="int">2181</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#68336" title="()Unit">restartMasters</a>
    <a href="#68325" title="=&gt; Unit">restartServiceScheduler</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68325">restartServiceScheduler</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

    <a href="#68328" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70509" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#70535" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25743" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="70480">serviceSchedulerScript</a> = <span class="delimiter">(</span>
      <span class="string">&quot;#!/bin/bash\n&quot;</span> +
        <span class="string">&quot;/root/jrun -Dscads.comm.externalip=true deploylib.mesos.ServiceSchedulerDaemon &quot;</span> <span title="java.lang.String(&quot;#!/bin/bash\012/root/jrun -Dscads.comm.externalip=true deploylib.mesos.ServiceSchedulerDaemon --mesosMaster &quot;)">+</span>
        <span class="string">&quot;--mesosMaster &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68334" title="=&gt; String">clusterUrl</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
        <span title="java.lang.String(&quot;--zooKeeperAddress &quot;)" class="string">&quot;--zooKeeperAddress &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68318" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">serviceSchedulerNode</a>.<span title="=&gt; java.lang.String">canonicalAddress</span> <span title="(x$1: Any)java.lang.String">+</span>
        <span title="java.lang.String(&quot; &gt;&gt; /root/serviceScheduler.log 2&gt;&amp;1&quot;)" class="string">&quot; &gt;&gt; /root/serviceScheduler.log 2&gt;&amp;1&quot;</span><span class="delimiter">)</span>

    <span class="comment">// Start service scheduler on only the first master</span>
    <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#25745" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> java.io.<span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/root/serviceScheduler&quot;)" class="string">&quot;/root/serviceScheduler&quot;</span><span class="delimiter">)</span>, <a href="#70480" title="java.lang.String">serviceSchedulerScript</a><span class="delimiter">)</span>
    <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;chmod 755 /root/serviceScheduler&quot;)" class="string">&quot;chmod 755 /root/serviceScheduler&quot;</span>
    <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/serviceScheduler.pid --exec /root/serviceScheduler&quot;)" class="string">&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/serviceScheduler.pid --exec /root/serviceScheduler&quot;</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]" id="68326">slaves</a> = <span class="delimiter">{</span>
    <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41696" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41684" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#69263" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#69270" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#69277" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;slave&quot;)" class="string">&quot;slave&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; deploylib.ec2.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="69298">t</a> =&gt; <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41697" title="(instanceId: String)deploylib.ec2.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#69298" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: deploylib.ec2.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">filter</span><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="69333">i</a> =&gt; <span class="delimiter">(</span><a href="#69333" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41732" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#69333" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41732" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]" id="68327">masters</a> = <span class="delimiter">{</span>
    <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41696" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41684" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68964" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68971" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68978" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;master&quot;)" class="string">&quot;master&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; deploylib.ec2.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="68999">t</a> =&gt; <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41697" title="(instanceId: String)deploylib.ec2.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#68999" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: deploylib.ec2.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">filter</span><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="69034">i</a> =&gt; <span class="delimiter">(</span><a href="#69034" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41732" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#69034" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41732" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]" id="68328">zooKeepers</a> = <span class="delimiter">{</span>
    <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41696" title="()Unit">update</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41684" title="=&gt; com.amazonaws.services.ec2.AmazonEC2Client">client</a>.<span title="()com.amazonaws.services.ec2.model.DescribeTagsResult">describeTags</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.List[com.amazonaws.services.ec2.model.TagDescription]">getTags</span><span title="(l: java.util.List[com.amazonaws.services.ec2.model.TagDescription])scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]" class="delimiter">(</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68593" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getResourceType</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;instance&quot;)" class="string">&quot;instance&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68600" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getKey</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span><span class="delimiter">)</span>
      .<span title="(p: com.amazonaws.services.ec2.model.TagDescription =&gt; Boolean)scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription]">filter</span><span class="delimiter">(</span><a href="#68607" title="com.amazonaws.services.ec2.model.TagDescription">_</a>.<span title="()java.lang.String">getValue</span> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;zoo&quot;)" class="string">&quot;zoo&quot;</span><span class="delimiter">)</span>
      .<span title="(f: com.amazonaws.services.ec2.model.TagDescription =&gt; deploylib.ec2.EC2Instance)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[com.amazonaws.services.ec2.model.TagDescription],deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]])scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,deploylib.ec2.EC2Instance,scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]]" class="delimiter">(</span><a title="com.amazonaws.services.ec2.model.TagDescription" id="68628">t</a> =&gt; <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41697" title="(instanceId: String)deploylib.ec2.EC2Instance">getInstance</a><span class="delimiter">(</span><a href="#68628" title="com.amazonaws.services.ec2.model.TagDescription">t</a>.<span title="()java.lang.String">getResourceId</span><span class="delimiter">)</span><span class="delimiter">)</span>
      .<span title="(p: deploylib.ec2.EC2Instance =&gt; Boolean)scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">filter</span><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="68683">i</a> =&gt; <span class="delimiter">(</span><a href="#68683" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41732" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;running&quot;)" class="string">&quot;running&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#68683" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41732" title="=&gt; String">instanceState</a> <span title="(x$1: Any)Boolean">equals</span> <span title="java.lang.String(&quot;pending&quot;)" class="string">&quot;pending&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; String" id="68329">zooKeeperAddress</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;zk://%s/&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#68328" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance],java.lang.String,scala.collection.mutable.Buffer[java.lang.String]])scala.collection.mutable.Buffer[java.lang.String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,java.lang.String,scala.collection.mutable.Buffer[java.lang.String]]" class="delimiter">(</span><a href="#68705" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41727" title="=&gt; String">publicDnsName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:2181&quot;)" class="string">&quot;:2181&quot;</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="68330">zooKeeperRoot</a> = <span title="(uri: String)edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">ZooKeeperNode</span><span class="delimiter">(</span><a href="#68329" title="=&gt; String">zooKeeperAddress</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(numServers: Int)Unit" id="68331">setupZooKeeper</a><span class="delimiter">(</span><a title="Int" id="69463">numServers</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Int" id="70544">missingServers</a> = <a href="#69463" title="Int">numServers</a> <span title="(x: Int)Int">-</span> <a href="#68328" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="=&gt; Int">size</span>

    <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><a href="#70544" title="Int">missingServers</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[deploylib.ec2.EC2Instance]" id="70558">ret</a> = <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41702" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: String, userData: Option[String])Seq[deploylib.ec2.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#68314" title="=&gt; java.lang.String">mesosAmi</a>,
      <a href="#70544" title="Int">missingServers</a>,
      <a href="#70544" title="Int">missingServers</a>,
      <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41681" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#68316" title="=&gt; java.lang.String">defaultZone</a>,
      <span title="object None">None</span><span class="delimiter">)</span>

      <a href="#70558" title="Seq[deploylib.ec2.EC2Instance]">ret</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70739" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41721" title="object x$22.tags">tags</a> <a href="../ec2/ec2.scala.html#47471" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;zoo&quot;)" class="string">&quot;zoo&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#70558" title="Seq[deploylib.ec2.EC2Instance]">ret</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#70750" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]" id="70545">servers</a> = <a href="#68328" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">zooKeepers</a>.<span title="(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance],(deploylib.ec2.EC2Instance, Int),scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]])scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]">zipWithIndex</span>

    <span class="keyword">val</span> <a title="List[String]" id="70546">serverList</a> = <a href="#70545" title="scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]">servers</a>.<span title="(f: (deploylib.ec2.EC2Instance, Int) =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)],String,scala.collection.mutable.Buffer[String]])scala.collection.mutable.Buffer[String]">map</span> <a href="#70811" title="String" class="delimiter">{</a><span class="keyword">case</span> <span title="String" class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="70814">server</a>, <a title="Int" id="70815">id</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt; <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;server.%d=%s:3181:3182&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#70815" title="Int">id</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#70814" title="deploylib.ec2.EC2Instance">server</a>.<a href="../ec2/ec2.scala.html#41728" title="=&gt; String">privateDnsName</a><span class="delimiter">)</span><span class="delimiter">}</span>.<span title="=&gt; List[String]">toList</span>

    <span class="keyword">val</span> <a title="String" id="70547">cnf</a> =
      <span class="delimiter">(</span><span title="java.lang.String(&quot;dataDir=/mnt/zookeeper&quot;)" class="string">&quot;dataDir=/mnt/zookeeper&quot;</span> <a href="#70863" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;clientPort=2181&quot;)" class="string">&quot;clientPort=2181&quot;</span> <a href="#70864" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;tickTime=1000&quot;)" class="string">&quot;tickTime=1000&quot;</span> <a href="#70865" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;initLimit=60&quot;)" class="string">&quot;initLimit=60&quot;</span><a href="#70866" title="(x: String)List[String]">::</a>
       <span title="java.lang.String(&quot;syncLimit=30&quot;)" class="string">&quot;syncLimit=30&quot;</span> <a href="#70867" title="(x: String)List[String]">::</a> 
       <span class="delimiter">(</span><span title="List[String]" class="keyword">if</span><span class="delimiter">(</span><a href="#70545" title="scala.collection.mutable.Buffer[(deploylib.ec2.EC2Instance, Int)]">servers</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <a href="#70546" title="List[String]">serverList</a> <span class="keyword">else</span> <span title="object Nil">Nil</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="String" id="70548">startScript</a> =
      <span class="delimiter">(</span><span title="java.lang.String(&quot;#!/bin/bash&quot;)" class="string">&quot;#!/bin/bash&quot;</span> <a href="#70902" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;/root/jrun org.apache.zookeeper.server.quorum.QuorumPeerMain /mnt/zookeeper.cnf&quot;)" class="string">&quot;/root/jrun org.apache.zookeeper.server.quorum.QuorumPeerMain /mnt/zookeeper.cnf&quot;</span> <a href="#70903" title="(x: java.lang.String)List[java.lang.String]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <a href="../package.scala.html#9828" title="(itr: Iterable[(deploylib.ec2.EC2Instance, Int)])deploylib.ParallelSeq[(deploylib.ec2.EC2Instance, Int)]">servers</a>.<a href="../Concurrent.scala.html#12248" title="(f: (deploylib.ec2.EC2Instance, Int) =&gt; Unit)Unit">pforeach</a> <a href="#70949" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="70952">server</a>, <a title="Int" id="70953">id</a>: <span title="Int">Int</span><span class="delimiter">)</span> =&gt;
        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;mkdir -p /mnt/zookeeper&quot;)" class="string">&quot;mkdir -p /mnt/zookeeper&quot;</span>
        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25745" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/zookeeper.cnf&quot;)" class="string">&quot;/mnt/zookeeper.cnf&quot;</span><span class="delimiter">)</span>, <a href="#70547" title="String">cnf</a><span class="delimiter">)</span>
        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25745" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/zookeeper/myid&quot;)" class="string">&quot;/mnt/zookeeper/myid&quot;</span><span class="delimiter">)</span>, <span class="delimiter">(</span><a href="#70953" title="Int">id</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>
        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25745" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mnt/startZookeeper&quot;)" class="string">&quot;/mnt/startZookeeper&quot;</span><span class="delimiter">)</span>, <a href="#70548" title="String">startScript</a><span class="delimiter">)</span>
        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;chmod 755 /mnt/startZookeeper&quot;)" class="string">&quot;chmod 755 /mnt/startZookeeper&quot;</span>

        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a>.<a href="../ec2/ec2.scala.html#41736" title="(jars: Seq[java.io.File])Seq[java.io.File]">pushJars</a><span class="delimiter">(</span><a href="#9633" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68305" title="=&gt; Seq[java.io.File]">jarFiles</a><span class="delimiter">)</span>
        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a>.<a href="../RemoteMachine.scala.html#25743" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span>
        <a href="#70952" title="deploylib.ec2.EC2Instance">server</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/zookeeper.pid --exec /mnt/startZookeeper&quot;)" class="string">&quot;start-stop-daemon --make-pidfile --start --background --pidfile /var/run/zookeeper.pid --exec /mnt/startZookeeper&quot;</span>
    <span class="delimiter">}</span>

    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="#70547" title="String">cnf</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; deploylib.ec2.EC2Instance" id="68332">firstMaster</a> = <a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="=&gt; deploylib.ec2.EC2Instance">head</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68333">updateMesos</a> =
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71002">s</a> =&gt;
      <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;rsync -e 'ssh -o StrictHostKeyChecking=no' -av /usr/local/mesos root@%s:/usr/local/mesos&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#71002" title="deploylib.ec2.EC2Instance">s</a>.<a href="../ec2/ec2.scala.html#41727" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; String" id="68334">clusterUrl</a>: <span title="String">String</span> =
    <span title="String" class="keyword">if</span><span class="delimiter">(</span><a href="#68388" title="Boolean">useFT</a><span class="delimiter">)</span>
      <span title="java.lang.String(&quot;zoo://&quot;)" class="string">&quot;zoo://&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68330" title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode">zooKeeperRoot</a>.<span title="=&gt; edu.berkeley.cs.scads.comm.ZooKeeperProxy">proxy</span>.<span title="=&gt; Seq[String]">servers</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68330" title="edu.berkeley.cs.scads.comm.ZooKeeperProxy#ZooKeeperNode" id="71009">zooKeeperRoot</a>.<a href="#71009" title="Int" id="71011">getOrCreate</a><span class="delimiter">(</span><a title="java.lang.String(&quot;mesos&quot;)" id="71010" class="string">&quot;mesos&quot;</a><span class="delimiter">)</span>.<span title="=&gt; String">path</span>
    <span class="keyword">else</span>
      <span title="java.lang.String(&quot;master@&quot;)" class="string">&quot;master@&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../ec2/ec2.scala.html#41727" title="=&gt; String">publicDnsName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;:5050&quot;)" class="string">&quot;:5050&quot;</span>

  <span class="keyword">def</span> <a title="()Unit" id="68335">restartSlaves</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71037">i</a> =&gt; <span class="delimiter">{</span><a href="#71037" title="deploylib.ec2.EC2Instance">i</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-slave stop&quot;)" class="string">&quot;service mesos-slave stop&quot;</span>; <a href="#71037" title="deploylib.ec2.EC2Instance">i</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-slave start&quot;)" class="string">&quot;service mesos-slave start&quot;</span><span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="68336">restartMasters</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span>
      <a title="deploylib.ec2.EC2Instance" id="71066">master</a> =&gt;
        <a href="#71066" title="deploylib.ec2.EC2Instance">master</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-master stop&quot;)" class="string">&quot;service mesos-master stop&quot;</span>
        <a href="#71066" title="deploylib.ec2.EC2Instance">master</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-master start&quot;)" class="string">&quot;service mesos-master start&quot;</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="68337">restart</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#68336" title="()Unit">restartMasters</a>
    <a href="#68335" title="()Unit">restartSlaves</a>
    <a href="#68325" title="=&gt; Unit">restartServiceScheduler</a>
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#71093" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25743" title="(cmd: String)deploylib.ExecuteResponse">executeCommand</a><span title="Unit" class="delimiter">(</span><span title="java.lang.String(&quot;killall java&quot;)" class="string">&quot;killall java&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68338">updateSlavesFile</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.File" id="71098">location</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/root/mesos-ec2/slaves&quot;)" class="string">&quot;/root/mesos-ec2/slaves&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="71099">contents</a> = <a href="#68326" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance],String,scala.collection.mutable.Buffer[String]])scala.collection.mutable.Buffer[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,String,scala.collection.mutable.Buffer[String]]" class="delimiter">(</span><a href="#71123" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41728" title="=&gt; String">privateDnsName</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a> <span class="delimiter">{</span>
      <a title="deploylib.ec2.EC2Instance" id="71176">master</a> =&gt;
        <a href="#71176" title="deploylib.ec2.EC2Instance">master</a>.<a href="../RemoteMachine.scala.html#25752" title="(remoteDir: java.io.File)Unit">mkdir</a><span class="delimiter">(</span><a href="package.scala.html#9820" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File" class="string">&quot;/root/mesos-ec2&quot;</a><span class="delimiter">)</span>
        <a href="../config/ConfigurationActions.scala.html#38356" title="(target: deploylib.RemoteMachine, filename: java.io.File, contents: String, mode: String)java.io.File">createFile</a><span title="Unit" class="delimiter">(</span><a href="#71176" title="deploylib.ec2.EC2Instance">master</a>, <a href="#71098" title="java.io.File">location</a>, <a href="#71099" title="String">contents</a>, <span title="java.lang.String(&quot;644&quot;)" class="string">&quot;644&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(zone: String, count: Int, ami: String)Seq[deploylib.ec2.EC2Instance]" id="68339">startMasters</a><span class="delimiter">(</span><a title="String" id="70337">zone</a>: <span title="String">String</span> = <a href="#68316" title="=&gt; java.lang.String">defaultZone</a>, <a title="Int" id="70338">count</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span>, <a title="String" id="70339">ami</a>: <span title="String">String</span> = <a href="#68314" title="=&gt; java.lang.String">mesosAmi</a><span class="delimiter">)</span>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[deploylib.ec2.EC2Instance]" id="71177">ret</a> = <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41702" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: String, userData: Option[String])Seq[deploylib.ec2.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#70339" title="String">ami</a>,
      <a href="#70338" title="Int">count</a>,
      <a href="#70338" title="Int">count</a>,
      <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41681" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#70337" title="String">zone</a>,
      <span title="object None">None</span><span class="delimiter">)</span>

    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">ret</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71204">i</a> =&gt; <span class="delimiter">{</span>
      <a href="#71204" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41721" title="object i.tags">tags</a> <a href="../ec2/ec2.scala.html#47471" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;master&quot;)" class="string">&quot;master&quot;</span><span class="delimiter">)</span>
      <a href="#71204" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a>
      <a href="#68347" title="(instances: Seq[deploylib.ec2.EC2Instance])Unit">updateConf</a><span class="delimiter">(</span><a href="#71204" title="deploylib.ec2.EC2Instance">i</a> <a href="#71208" title="(x: deploylib.ec2.EC2Instance)List[deploylib.ec2.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>

    <a href="#68336" title="()Unit">restartMasters</a>
    <a href="#71177" title="Seq[deploylib.ec2.EC2Instance]">ret</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(count: Int, zone: String, ami: String, updateDeploylibOnStart: Boolean)Seq[deploylib.ec2.EC2Instance]" id="68340">addSlaves</a><span class="delimiter">(</span><a title="Int" id="69478">count</a>: <span title="Int">Int</span>, <a title="String" id="69483">zone</a>: <span title="String">String</span> = <a href="#68316" title="=&gt; java.lang.String">defaultZone</a>, <a title="String" id="69484">ami</a>: <span title="String">String</span> = <a href="#68314" title="=&gt; java.lang.String">mesosAmi</a>, <a title="Boolean" id="69485">updateDeploylibOnStart</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Option[java.lang.String]" id="71214">userData</a> =
      <span title="Option[java.lang.String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#69485" title="Boolean">updateDeploylibOnStart</a><span class="delimiter">)</span>
        <span title="object None">None</span>
      <span class="keyword">else</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
	      <a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#71244" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
          <span title="(x: java.lang.String)Some[java.lang.String]">Some</span><span class="delimiter">(</span><span title="java.lang.String(&quot;url=&quot;)" class="string">&quot;url=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68334" title="=&gt; String">clusterUrl</a><span class="delimiter">)</span> 
		<span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="None.type" id="71249">noMaster</a>: java.util.<span title="java.util.NoSuchElementException">NoSuchElementException</span> =&gt;
            <a href="../config/ConfigurationActions.scala.html#38353" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">warning</span><span class="delimiter">(</span><span title="java.lang.String(&quot;No master found. Starting without userdata&quot;)" class="string">&quot;No master found. Starting without userdata&quot;</span><span class="delimiter">)</span>
            <span title="object None">None</span>
        <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="Seq[deploylib.ec2.EC2Instance]" id="71215">instances</a> = <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41702" title="(imageId: String, min: Int, max: Int, keyName: String, instanceType: String, location: String, userData: Option[String])Seq[deploylib.ec2.EC2Instance]">runInstances</a><span class="delimiter">(</span>
      <a href="#69484" title="String">ami</a>,
      <a href="#69478" title="Int">count</a>,
      <a href="#69478" title="Int">count</a>,
      <a href="../ec2/ec2.scala.html#9544" title="object deploylib.ec2.EC2Instance">EC2Instance</a>.<a href="../ec2/ec2.scala.html#41681" title="=&gt; java.lang.String">keyName</a>,
      <span title="java.lang.String(&quot;m1.large&quot;)" class="string">&quot;m1.large&quot;</span>,
      <a href="#69483" title="String">zone</a>,
      <a href="#71214" title="Option[java.lang.String]">userData</a><span class="delimiter">)</span>
	<a href="#71215" title="Seq[deploylib.ec2.EC2Instance]">instances</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#71284" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41721" title="object x$35.tags">tags</a> <a href="../ec2/ec2.scala.html#47471" title="(key: String, value: String)Unit">+=</a> <span class="delimiter">(</span><span title="java.lang.String(&quot;mesos&quot;)" class="string">&quot;mesos&quot;</span>, <span title="java.lang.String(&quot;slave&quot;)" class="string">&quot;slave&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#69485" title="Boolean">updateDeploylibOnStart</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">//Hack to avoid race condition where there are no masters yet because they haven't been tagged.</span>
      <a href="#71215" title="Seq[deploylib.ec2.EC2Instance]">instances</a>.<span title="=&gt; deploylib.ec2.EC2Instance">head</span>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a>
      <a href="#68327" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">masters</a>.<span title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#71314" title="deploylib.ec2.EC2Instance">_</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a><span class="delimiter">)</span>
      <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a>.<a href="../RemoteMachine.scala.html#25755" title="(port: Int)Unit">blockTillPortOpen</a><span class="delimiter">(</span><span title="Int(5050)" class="int">5050</span><span class="delimiter">)</span>

      <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">instances</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71340">i</a> =&gt; <span class="keyword">try</span> <span class="delimiter">{</span>
        <a href="#71340" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41737" title="()Unit">blockUntilRunning</a>
        <a href="#68323" title="(instances: Seq[deploylib.ec2.EC2Instance])Unit">updateDeploylib</a><span class="delimiter">(</span><a href="#71340" title="deploylib.ec2.EC2Instance">i</a> <a href="#71341" title="(x: deploylib.ec2.EC2Instance)List[deploylib.ec2.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
        <a href="#68347" title="(instances: Seq[deploylib.ec2.EC2Instance])Unit">updateConf</a><span class="delimiter">(</span><a href="#71340" title="deploylib.ec2.EC2Instance">i</a> <a href="#71345" title="(x: deploylib.ec2.EC2Instance)List[deploylib.ec2.EC2Instance]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>
        <a href="#71340" title="deploylib.ec2.EC2Instance">i</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;service mesos-slave restart&quot;)" class="string">&quot;service mesos-slave restart&quot;</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="71349">e</a> =&gt; <a href="../config/ConfigurationActions.scala.html#38353" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(thrown: Throwable, msg: String, items: Any*)Unit">error</span><span class="delimiter">(</span><a href="#71349" title="java.lang.Throwable">e</a>, <span title="java.lang.String(&quot;Failed to start slave on instance %s:%s&quot;)" class="string">&quot;Failed to start slave on instance %s:%s&quot;</span>, <a href="#71340" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41704" title="=&gt; String">instanceId</a>, <a href="#71340" title="deploylib.ec2.EC2Instance">i</a>.<a href="../ec2/ec2.scala.html#41727" title="=&gt; String">publicDnsName</a><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#71215" title="Seq[deploylib.ec2.EC2Instance]">instances</a>
  <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="List[java.lang.String]" id="68341">baseConf</a> = <span class="delimiter">(</span>
      <span title="java.lang.String(&quot;webui_port=8080&quot;)" class="string">&quot;webui_port=8080&quot;</span> <a href="#68358" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;work_dir=/mnt&quot;)" class="string">&quot;work_dir=/mnt&quot;</span> <a href="#68359" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;log_dir=/mnt&quot;)" class="string">&quot;log_dir=/mnt&quot;</span> <a href="#68360" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;switch_user=0&quot;)" class="string">&quot;switch_user=0&quot;</span> <a href="#68361" title="(x: java.lang.String)List[java.lang.String]">::</a>
      <span title="java.lang.String(&quot;shares_interval=30&quot;)" class="string">&quot;shares_interval=30&quot;</span> <a href="#68362" title="(x: java.lang.String)List[java.lang.String]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; List[java.lang.String]" id="68343">confWithUrl</a> = <span class="delimiter">(</span><span title="java.lang.String(&quot;master=&quot;)" class="string">&quot;master=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#68334" title="=&gt; String">clusterUrl</a><span class="delimiter">)</span> <a href="#71357" title="(x: java.lang.String)List[java.lang.String]">::</a> <a href="#68341" title="=&gt; List[java.lang.String]">baseConf</a>
  <span class="keyword">def</span> <a title="(instance: deploylib.ec2.EC2Instance)String" id="68344">slaveConf</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71363">instance</a>: <a href="../ec2/ec2.scala.html#9546" title="deploylib.ec2.EC2Instance">EC2Instance</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span class="delimiter">(</span><span title="java.lang.String(&quot;mem=&quot;)" class="string">&quot;mem=&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#71363" title="deploylib.ec2.EC2Instance">instance</a>.<a href="../RemoteMachine.scala.html#25775" title="=&gt; instance.FreeStats">free</a>.<a href="../RemoteMachine.scala.html#35435" title="=&gt; Int">total</a> <span title="(x: Int)Int">-</span> <span title="Int(1024)" class="int">1024</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#71366" title="(x: java.lang.String)List[java.lang.String]">::</a>
					  <a href="#68343" title="=&gt; List[java.lang.String]">confWithUrl</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

  <span class="keyword">val</span> <a title="java.io.File" id="68345">conffile</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/usr/local/mesos/conf/mesos.conf&quot;)" class="string">&quot;/usr/local/mesos/conf/mesos.conf&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(instances: Seq[deploylib.ec2.EC2Instance])Unit" id="68347">updateConf</a><span class="delimiter">(</span><a title="Seq[deploylib.ec2.EC2Instance]" id="71207">instances</a>: <span title="Seq[deploylib.ec2.EC2Instance]">Seq</span><span class="delimiter">[</span>EC2Instance<span class="delimiter">]</span> = <a href="#68326" title="=&gt; scala.collection.mutable.Buffer[deploylib.ec2.EC2Instance]">slaves</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">instances</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a title="deploylib.ec2.EC2Instance" id="71403">i</a> =&gt; <a href="#71403" title="deploylib.ec2.EC2Instance">i</a>.<a href="../RemoteMachine.scala.html#25745" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><a href="#68345" title="=&gt; java.io.File">conffile</a>, <a href="#68344" title="(instance: deploylib.ec2.EC2Instance)String">slaveConf</a><span class="delimiter">(</span><a href="#71403" title="deploylib.ec2.EC2Instance">i</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Unit" id="68348">updateMasterConf</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="71404">masterConf</a> =
      <span title="String" class="keyword">if</span><span class="delimiter">(</span><a href="#68388" title="Boolean">useFT</a><span class="delimiter">)</span>
        <a href="#68343" title="=&gt; List[java.lang.String]">confWithUrl</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>
      <span class="keyword">else</span>
        <a href="#68341" title="=&gt; List[java.lang.String]">baseConf</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">masters</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#71434" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25745" title="(file: java.io.File, contents: String)Unit">createFile</a><span class="delimiter">(</span><a href="#68345" title="=&gt; java.io.File">conffile</a>, <a href="#71404" title="String">masterConf</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">//TODO: Doesn't handle non s3 cached jars</span>
  <span class="keyword">def</span> <a title="=&gt; Seq[edu.berkeley.cs.scads.comm.S3CachedJar]" id="68349">classSource</a>: <span title="Seq[edu.berkeley.cs.scads.comm.S3CachedJar]">Seq</span><span class="delimiter">[</span>S3CachedJar<span class="delimiter">]</span> =
    <span title="Seq[edu.berkeley.cs.scads.comm.S3CachedJar]" class="keyword">if</span> <span class="delimiter">(</span><span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib.classSource&quot;)" class="string">&quot;deploylib.classSource&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#68350" title="=&gt; Seq[String]">pushJars</a>.<span title="(f: String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],java.lang.String,Seq[java.lang.String]])Seq[java.lang.String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,java.lang.String,Seq[java.lang.String]]" class="delimiter">(</span><a href="package.scala.html#9820" title="implicit deploylib.mesos.package.toFile : (str: String)java.io.File">_</a>.<span title="()java.lang.String">getName</span><span class="delimiter">)</span>
        .<span title="(f: java.lang.String =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.lang.String],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="../ec2/s3cache.scala.html#9557" title="object deploylib.ec2.S3Cache">S3Cache</a>.<a href="../ec2/s3cache.scala.html#48479" title="(fileMd5: String)String">hashToUrl</a><span class="delimiter">)</span>
        .<span title="(f: String =&gt; edu.berkeley.cs.scads.comm.S3CachedJar)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],edu.berkeley.cs.scads.comm.S3CachedJar,Seq[edu.berkeley.cs.scads.comm.S3CachedJar]])Seq[edu.berkeley.cs.scads.comm.S3CachedJar]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,edu.berkeley.cs.scads.comm.S3CachedJar,Seq[edu.berkeley.cs.scads.comm.S3CachedJar]]" class="delimiter">(</span><span title="edu.berkeley.cs.scads.comm.S3CachedJar" class="keyword">new</span> <span title="edu.berkeley.cs.scads.comm.S3CachedJar">S3CachedJar</span><span class="delimiter">(</span><a href="#71555" title="String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;deploylib.classSource&quot;)" class="string">&quot;deploylib.classSource&quot;</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;\\|&quot;)" class="string">&quot;\\|&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; edu.berkeley.cs.scads.comm.S3CachedJar)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],edu.berkeley.cs.scads.comm.S3CachedJar,Seq[edu.berkeley.cs.scads.comm.S3CachedJar]])Seq[edu.berkeley.cs.scads.comm.S3CachedJar]">map</span><span title="(implicit m: DummyImplicit)scala.collection.generic.CanBuildFrom[Array[_],edu.berkeley.cs.scads.comm.S3CachedJar,scala.collection.mutable.ArraySeq[edu.berkeley.cs.scads.comm.S3CachedJar]]" class="delimiter">(</span><span title="(url: String)edu.berkeley.cs.scads.comm.S3CachedJar">S3CachedJar</span><span class="delimiter">(</span><a href="#72027" title="java.lang.String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">//TODO fix me.</span>
  <span class="keyword">def</span> <a title="=&gt; Seq[String]" id="68350">pushJars</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Seq[java.io.File]" id="72052">jars</a> = <a href="#9633" title="object deploylib.mesos.MesosCluster">MesosCluster</a>.<a href="#68305" title="=&gt; Seq[java.io.File]">jarFiles</a>
    <span class="keyword">val</span> <a href="#72054" title="(Seq[java.io.File], Seq[java.io.File])" class="delimiter">(</a><a href="#72053" title="Seq[java.io.File]" id="72054">deploylib</a>, <a href="#72053" title="Seq[java.io.File]" id="72055">otherJars</a><span class="delimiter">)</span> = <a href="#72052" title="Seq[java.io.File]">jars</a>.<span title="(p: java.io.File =&gt; Boolean)(Seq[java.io.File], Seq[java.io.File])">partition</span><span title="(Seq[java.io.File], Seq[java.io.File]) @unchecked" class="delimiter">(</span><a href="#72060" title="java.io.File">_</a>.<span title="()java.lang.String">getName</span> <span title="(x$1: java.lang.CharSequence)Boolean">contains</span> <span title="java.lang.String(&quot;deploylib&quot;)" class="string">&quot;deploylib&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Seq[java.io.File]" id="72056">sortedJars</a> = <a href="#72054" title="Seq[java.io.File]">deploylib</a> <span title="(that: scala.collection.GenTraversableOnce[java.io.File])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.io.File],java.io.File,Seq[java.io.File]])Seq[java.io.File]">++</span> <a href="#72055" title="Seq[java.io.File]">otherJars</a>

    <a href="../config/ConfigurationActions.scala.html#38353" title="=&gt; net.lag.logging.Logger">logger</a>.<span title="(msg: String, items: Any*)Unit">debug</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Starting Jar upload&quot;)" class="string">&quot;Starting Jar upload&quot;</span><span class="delimiter">)</span>
    <a href="#72056" title="Seq[java.io.File]">sortedJars</a>.<span title="(f: java.io.File =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[java.io.File],String,Seq[String]])Seq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,String,Seq[String]]" class="delimiter">(</span><a href="../ec2/s3cache.scala.html#9557" title="object deploylib.ec2.S3Cache">S3Cache</a>.<a href="../ec2/s3cache.scala.html#48480" title="(file: java.io.File)String">getCacheUrl</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Create a public key on the master if it doesn't exist
   * Then add that to the authorized key file all of slaves
   * TODO: Dedup keys
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="68351">authorizeMaster</a>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="72148">getKeyCommand</a> = <span title="java.lang.String(&quot;cat /root/.ssh/id_rsa.pub&quot;)" class="string">&quot;cat /root/.ssh/id_rsa.pub&quot;</span>
    <span class="keyword">val</span> <a title="String" id="72149">key</a> = <span class="keyword">try</span> <span class="delimiter">(</span><a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25742" title="(cmd: String)String">!?</a> <a href="#72148" title="java.lang.String">getKeyCommand</a><span class="delimiter">)</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="String" id="72150">u</a>: <a href="../RemoteMachine.scala.html#9491" title="deploylib.UnknownResponse">UnknownResponse</a> =&gt; <span class="delimiter">{</span>
        <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25741" title="(cmd: String)Unit">!</a> <span title="java.lang.String(&quot;ssh-keygen -t rsa -f /root/.ssh/id_rsa -N \&quot;\&quot;&quot;)" class="string">&quot;ssh-keygen -t rsa -f /root/.ssh/id_rsa -N \&quot;\&quot;&quot;</span>
        <a href="#68332" title="=&gt; deploylib.ec2.EC2Instance">firstMaster</a> <a href="../RemoteMachine.scala.html#25742" title="(cmd: String)String">!?</a> <a href="#72148" title="java.lang.String">getKeyCommand</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="../package.scala.html#9828" title="(itr: Iterable[deploylib.ec2.EC2Instance])deploylib.ParallelSeq[deploylib.ec2.EC2Instance]">slaves</a>.<a href="../Concurrent.scala.html#12248" title="(f: deploylib.ec2.EC2Instance =&gt; Unit)Unit">pforeach</a><span class="delimiter">(</span><a href="#72175" title="deploylib.ec2.EC2Instance">_</a>.<a href="../RemoteMachine.scala.html#25746" title="(file: java.io.File, contents: String)Unit">appendFile</a><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/root/.ssh/authorized_keys&quot;)" class="string">&quot;/root/.ssh/authorized_keys&quot;</span><span class="delimiter">)</span>, <a href="#72149" title="String">key</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>